"use strict";(self.webpackChunk=self.webpackChunk||[]).push([[154],{6154:(e,n,t)=>{t.d(n,{Yb:()=>Pe,adaptersSR:()=>Rt,ok:()=>bt});var r=t(67540),a=(t(58955),t(87513)),i=t.n(a),o=t(11677),u=t.n(o),s=t(45451);function c(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);n&&(r=r.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,r)}return t}function l(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?c(Object(t),!0).forEach((function(n){m(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):c(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}function d(){d=function(){return e};var e={},n=Object.prototype,t=n.hasOwnProperty,r=Object.defineProperty||function(e,n,t){e[n]=t.value},a="function"==typeof Symbol?Symbol:{},i=a.iterator||"@@iterator",o=a.asyncIterator||"@@asyncIterator",u=a.toStringTag||"@@toStringTag";function s(e,n,t){return Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}),e[n]}try{s({},"")}catch(e){s=function(e,n,t){return e[n]=t}}function c(e,n,t,a){var i=n&&n.prototype instanceof g?n:g,o=Object.create(i.prototype),u=new R(a||[]);return r(o,"_invoke",{value:D(e,t,u)}),o}function l(e,n,t){try{return{type:"normal",arg:e.call(n,t)}}catch(e){return{type:"throw",arg:e}}}e.wrap=c;var f={};function g(){}function p(){}function h(){}var m={};s(m,i,(function(){return this}));var v=Object.getPrototypeOf,S=v&&v(v(b([])));S&&S!==n&&t.call(S,i)&&(m=S);var y=h.prototype=g.prototype=Object.create(m);function I(e){["next","throw","return"].forEach((function(n){s(e,n,(function(e){return this._invoke(n,e)}))}))}function T(e,n){function a(r,i,o,u){var s=l(e[r],e,i);if("throw"!==s.type){var c=s.arg,d=c.value;return d&&"object"==typeof d&&t.call(d,"__await")?n.resolve(d.__await).then((function(e){a("next",e,o,u)}),(function(e){a("throw",e,o,u)})):n.resolve(d).then((function(e){c.value=e,o(c)}),(function(e){return a("throw",e,o,u)}))}u(s.arg)}var i;r(this,"_invoke",{value:function(e,t){function r(){return new n((function(n,r){a(e,t,n,r)}))}return i=i?i.then(r,r):r()}})}function D(e,n,t){var r="suspendedStart";return function(a,i){if("executing"===r)throw new Error("Generator is already running");if("completed"===r){if("throw"===a)throw i;return w()}for(t.method=a,t.arg=i;;){var o=t.delegate;if(o){var u=C(o,t);if(u){if(u===f)continue;return u}}if("next"===t.method)t.sent=t._sent=t.arg;else if("throw"===t.method){if("suspendedStart"===r)throw r="completed",t.arg;t.dispatchException(t.arg)}else"return"===t.method&&t.abrupt("return",t.arg);r="executing";var s=l(e,n,t);if("normal"===s.type){if(r=t.done?"completed":"suspendedYield",s.arg===f)continue;return{value:s.arg,done:t.done}}"throw"===s.type&&(r="completed",t.method="throw",t.arg=s.arg)}}}function C(e,n){var t=n.method,r=e.iterator[t];if(void 0===r)return n.delegate=null,"throw"===t&&e.iterator.return&&(n.method="return",n.arg=void 0,C(e,n),"throw"===n.method)||"return"!==t&&(n.method="throw",n.arg=new TypeError("The iterator does not provide a '"+t+"' method")),f;var a=l(r,e.iterator,n.arg);if("throw"===a.type)return n.method="throw",n.arg=a.arg,n.delegate=null,f;var i=a.arg;return i?i.done?(n[e.resultName]=i.value,n.next=e.nextLoc,"return"!==n.method&&(n.method="next",n.arg=void 0),n.delegate=null,f):i:(n.method="throw",n.arg=new TypeError("iterator result is not an object"),n.delegate=null,f)}function O(e){var n={tryLoc:e[0]};1 in e&&(n.catchLoc=e[1]),2 in e&&(n.finallyLoc=e[2],n.afterLoc=e[3]),this.tryEntries.push(n)}function x(e){var n=e.completion||{};n.type="normal",delete n.arg,e.completion=n}function R(e){this.tryEntries=[{tryLoc:"root"}],e.forEach(O,this),this.reset(!0)}function b(e){if(e){var n=e[i];if(n)return n.call(e);if("function"==typeof e.next)return e;if(!isNaN(e.length)){var r=-1,a=function n(){for(;++r<e.length;)if(t.call(e,r))return n.value=e[r],n.done=!1,n;return n.value=void 0,n.done=!0,n};return a.next=a}}return{next:w}}function w(){return{value:void 0,done:!0}}return p.prototype=h,r(y,"constructor",{value:h,configurable:!0}),r(h,"constructor",{value:p,configurable:!0}),p.displayName=s(h,u,"GeneratorFunction"),e.isGeneratorFunction=function(e){var n="function"==typeof e&&e.constructor;return!!n&&(n===p||"GeneratorFunction"===(n.displayName||n.name))},e.mark=function(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,h):(e.__proto__=h,s(e,u,"GeneratorFunction")),e.prototype=Object.create(y),e},e.awrap=function(e){return{__await:e}},I(T.prototype),s(T.prototype,o,(function(){return this})),e.AsyncIterator=T,e.async=function(n,t,r,a,i){void 0===i&&(i=Promise);var o=new T(c(n,t,r,a),i);return e.isGeneratorFunction(t)?o:o.next().then((function(e){return e.done?e.value:o.next()}))},I(y),s(y,u,"Generator"),s(y,i,(function(){return this})),s(y,"toString",(function(){return"[object Generator]"})),e.keys=function(e){var n=Object(e),t=[];for(var r in n)t.push(r);return t.reverse(),function e(){for(;t.length;){var r=t.pop();if(r in n)return e.value=r,e.done=!1,e}return e.done=!0,e}},e.values=b,R.prototype={constructor:R,reset:function(e){if(this.prev=0,this.next=0,this.sent=this._sent=void 0,this.done=!1,this.delegate=null,this.method="next",this.arg=void 0,this.tryEntries.forEach(x),!e)for(var n in this)"t"===n.charAt(0)&&t.call(this,n)&&!isNaN(+n.slice(1))&&(this[n]=void 0)},stop:function(){this.done=!0;var e=this.tryEntries[0].completion;if("throw"===e.type)throw e.arg;return this.rval},dispatchException:function(e){if(this.done)throw e;var n=this;function r(t,r){return o.type="throw",o.arg=e,n.next=t,r&&(n.method="next",n.arg=void 0),!!r}for(var a=this.tryEntries.length-1;a>=0;--a){var i=this.tryEntries[a],o=i.completion;if("root"===i.tryLoc)return r("end");if(i.tryLoc<=this.prev){var u=t.call(i,"catchLoc"),s=t.call(i,"finallyLoc");if(u&&s){if(this.prev<i.catchLoc)return r(i.catchLoc,!0);if(this.prev<i.finallyLoc)return r(i.finallyLoc)}else if(u){if(this.prev<i.catchLoc)return r(i.catchLoc,!0)}else{if(!s)throw new Error("try statement without catch or finally");if(this.prev<i.finallyLoc)return r(i.finallyLoc)}}}},abrupt:function(e,n){for(var r=this.tryEntries.length-1;r>=0;--r){var a=this.tryEntries[r];if(a.tryLoc<=this.prev&&t.call(a,"finallyLoc")&&this.prev<a.finallyLoc){var i=a;break}}i&&("break"===e||"continue"===e)&&i.tryLoc<=n&&n<=i.finallyLoc&&(i=null);var o=i?i.completion:{};return o.type=e,o.arg=n,i?(this.method="next",this.next=i.finallyLoc,f):this.complete(o)},complete:function(e,n){if("throw"===e.type)throw e.arg;return"break"===e.type||"continue"===e.type?this.next=e.arg:"return"===e.type?(this.rval=this.arg=e.arg,this.method="return",this.next="end"):"normal"===e.type&&n&&(this.next=n),f},finish:function(e){for(var n=this.tryEntries.length-1;n>=0;--n){var t=this.tryEntries[n];if(t.finallyLoc===e)return this.complete(t.completion,t.afterLoc),x(t),f}},catch:function(e){for(var n=this.tryEntries.length-1;n>=0;--n){var t=this.tryEntries[n];if(t.tryLoc===e){var r=t.completion;if("throw"===r.type){var a=r.arg;x(t)}return a}}throw new Error("illegal catch attempt")},delegateYield:function(e,n,t){return this.delegate={iterator:b(e),resultName:n,nextLoc:t},"next"===this.method&&(this.arg=void 0),f}},e}function f(e,n,t,r,a,i,o){try{var u=e[i](o),s=u.value}catch(e){return void t(e)}u.done?n(s):Promise.resolve(s).then(r,a)}function g(e,n){if(!(e instanceof n))throw new TypeError("Cannot call a class as a function")}function p(e,n){for(var t=0;t<n.length;t++){var r=n[t];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,D(r.key),r)}}function h(e,n,t){return n&&p(e.prototype,n),t&&p(e,t),Object.defineProperty(e,"prototype",{writable:!1}),e}function m(e,n,t){return(n=D(n))in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}function v(e,n){return function(e){if(Array.isArray(e))return e}(e)||function(e,n){var t=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null!=t){var r,a,i,o,u=[],s=!0,c=!1;try{if(i=(t=t.call(e)).next,0===n){if(Object(t)!==t)return;s=!1}else for(;!(s=(r=i.call(t)).done)&&(u.push(r.value),u.length!==n);s=!0);}catch(e){c=!0,a=e}finally{try{if(!s&&null!=t.return&&(o=t.return(),Object(o)!==o))return}finally{if(c)throw a}}return u}}(e,n)||y(e,n)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function S(e){return function(e){if(Array.isArray(e))return I(e)}(e)||function(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}(e)||y(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function y(e,n){if(e){if("string"==typeof e)return I(e,n);var t=Object.prototype.toString.call(e).slice(8,-1);return"Object"===t&&e.constructor&&(t=e.constructor.name),"Map"===t||"Set"===t?Array.from(e):"Arguments"===t||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(t)?I(e,n):void 0}}function I(e,n){(null==n||n>e.length)&&(n=e.length);for(var t=0,r=new Array(n);t<n;t++)r[t]=e[t];return r}function T(e,n){var t="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!t){if(Array.isArray(e)||(t=y(e))||n&&e&&"number"==typeof e.length){t&&(e=t);var r=0,a=function(){};return{s:a,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:a}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var i,o=!0,u=!1;return{s:function(){t=t.call(e)},n:function(){var e=t.next();return o=e.done,e},e:function(e){u=!0,i=e},f:function(){try{o||null==t.return||t.return()}finally{if(u)throw i}}}}function D(e){var n=function(e,n){if("object"!=typeof e||null===e)return e;var t=e[Symbol.toPrimitive];if(void 0!==t){var r=t.call(e,n||"default");if("object"!=typeof r)return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===n?String:Number)(e)}(e,"string");return"symbol"==typeof n?n:String(n)}var C=function(e){return Array.isArray(e)?e:[e]},O=function(e){return function(n){return n.ConceptNameCodeSequence.CodeMeaning===e}};r.aT.datasetToDict;var x=r.hC.TID1500,R=r.hC.addAccessors,b=r.U7.StructuredReport,w=r.oq.Normalizer,M=x.TID1500MeasurementReport,E=x.TID1501MeasurementGroup,P=r.aT.DicomMetaDictionary,A={CodingSchemeDesignator:"DCM",CodeValue:"121071"},N={CodingSchemeDesignator:"SCT",CodeValue:"363698007"},q={CodingSchemeDesignator:"SRT",CodeValue:"G-C0E3"},k=function(e,n,t){var r=e.ConceptNameCodeSequence;if(r){var a=r.CodingSchemeDesignator,i=r.CodeValue;return a==n.CodingSchemeDesignator&&i==n.CodeValue||t&&a==t.CodingSchemeDesignator&&i==t.CodeValue}};var V=function(){function e(){g(this,e)}return h(e,null,[{key:"getSetupMeasurementData",value:function(e){var n=e.ContentSequence,t=C(n),r=t.find((function(e){return k(e,A)})),a=t.filter((function(e){return k(e,N,q)}))||[],i=t.find((function(e){return"NUM"===e.ValueType})),o=C(i.ContentSequence).find((function(e){return"SCOORD"===e.ValueType})),u=o.ContentSequence.ReferencedSOPSequence,s=u.ReferencedSOPInstanceUID,c=u.ReferencedFrameNumber,l={sopInstanceUid:s,frameIndex:c||1,complete:!0,finding:r?R(r.ConceptCodeSequence):void 0,findingSites:a.map((function(e){return R(e.ConceptCodeSequence)}))};l.finding&&(l.description=l.finding.CodeMeaning);var d=l.findingSites&&l.findingSites[0];return d&&(l.location=d[0]&&d[0].CodeMeaning||d.CodeMeaning),{defaultState:l,findingGroup:r,findingSiteGroups:a,NUMGroup:i,SCOORDGroup:o,ReferencedSOPSequence:u,ReferencedSOPInstanceUID:s,ReferencedFrameNumber:c}}},{key:"generateReport",value:function(e,n,t){var r=[],a=Object.keys(e)[0];if(!a)throw new Error("No measurements provided.");var i=n.get("generalSeriesModule",a),o=i.studyInstanceUID,u=i.seriesInstanceUID;Object.keys(e).forEach((function(t){var a=n.get("sopCommonModule",t),i=n.get("frameNumber",t),o=e[t],u=Object.keys(o),s={ReferencedSOPClassUID:a.sopClassUID,ReferencedSOPInstanceUID:a.sopInstanceUID};w.isMultiframeSOPClassUID(a.sopClassUID)&&(s.ReferencedFrameNumber=i);var c=[];u.forEach((function(e){var n=function(e,n,t){var r=n[e],a=V.CORNERSTONE_TOOL_CLASSES_BY_TOOL_TYPE[e];if(r&&r.data&&r.data.length&&a){var i=r.data.map((function(e){return function(e,n,t,r){var a=r.getTID300RepresentationArguments(e);return a.ReferencedSOPSequence=t,new r.TID300Representation(a)}(e,0,t,a)}));return new E(i)}}(e,o,s);n&&c.push(n)})),r=r.concat(c)}));var s=new M({TID1501MeasurementGroups:r},t),c=new Uint8Array(2);c[1]=1;var l={StudyInstanceUID:o,SeriesInstanceUID:u},d={FileMetaInformationVersion:{Value:[c.buffer],vr:"OB"},TransferSyntaxUID:{Value:["1.2.840.10008.1.2.1"],vr:"UI"},ImplementationClassUID:{Value:[P.uid()],vr:"UI"},ImplementationVersionName:{Value:["dcmjs"],vr:"SH"}};l._meta=d,l._vrMap={PixelData:"OW"};var f=new b([l]),g=s.contentItem(l);return f.dataset=Object.assign(f.dataset,g),f.dataset._meta=d,f}},{key:"generateToolState",value:function(n){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if("1500"!==n.ContentTemplateSequence.TemplateIdentifier)throw new Error("This package can currently only interpret DICOM SR TID 1500");var r=C(n.ContentSequence).find(O("Imaging Measurements")),a=C(r.ContentSequence).filter(O("Measurement Group")),i={},o=e.CORNERSTONE_TOOL_CLASSES_BY_UTILITY_TYPE,u=[];return Object.keys(o).forEach((function(e){u.push(o[e]),i[e]=[]})),a.forEach((function(e){var r=C(e.ContentSequence).find((function(e){return"Tracking Identifier"===e.ConceptNameCodeSequence.CodeMeaning})).TextValue,a=t.getToolClass?t.getToolClass(e,n,u):u.find((function(e){return e.isValidCornerstoneTrackingIdentifier(r)}));if(a){var o=a.getMeasurementData(e);console.log("=== ".concat(a.toolType," ===")),console.log(o),i[a.toolType].push(o)}})),i}},{key:"registerTool",value:function(n){e.CORNERSTONE_TOOL_CLASSES_BY_UTILITY_TYPE[n.utilityToolType]=n,e.CORNERSTONE_TOOL_CLASSES_BY_TOOL_TYPE[n.toolType]=n,e.MEASUREMENT_BY_TOOLTYPE[n.toolType]=n.utilityToolType}}]),e}();V.MEASUREMENT_BY_TOOLTYPE={},V.CORNERSTONE_TOOL_CLASSES_BY_UTILITY_TYPE={},V.CORNERSTONE_TOOL_CLASSES_BY_TOOL_TYPE={};var _="cornerstoneTools@^4.0.0",G=r.hC.TID300.Length,U="Length",L=function(){function e(){g(this,e)}return h(e,null,[{key:"getMeasurementData",value:function(n){var t=V.getSetupMeasurementData(n),r=t.defaultState,a=t.NUMGroup,i=t.SCOORDGroup,o=l(l({},r),{},{length:a.MeasuredValueSequence.NumericValue,toolType:e.toolType,handles:{start:{},end:{},textBox:{hasMoved:!1,movesIndependently:!1,drawnIndependently:!0,allowedOutsideImage:!0,hasBoundingBox:!0}}}),u=v(i.GraphicData,4);return o.handles.start.x=u[0],o.handles.start.y=u[1],o.handles.end.x=u[2],o.handles.end.y=u[3],o}},{key:"getTID300RepresentationArguments",value:function(e){var n=e.handles,t=e.finding,r=e.findingSites;return{point1:n.start,point2:n.end,distance:e.length,trackingIdentifierTextValue:"cornerstoneTools@^4.0.0:Length",finding:t,findingSites:r||[]}}}]),e}();L.toolType=U,L.utilityToolType=U,L.TID300Representation=G,L.isValidCornerstoneTrackingIdentifier=function(e){if(!e.includes(":"))return!1;var n=v(e.split(":"),2),t=n[0],r=n[1];return t===_&&r===U},V.registerTool(L);var F=r.hC.TID300.Polyline,B=function(){function e(){g(this,e)}return h(e,null,[{key:"getMeasurementData",value:function(n){for(var t=V.getSetupMeasurementData(n),r=t.defaultState,a=t.SCOORDGroup,i=t.NUMGroup,o=l(l({},r),{},{toolType:e.toolType,handles:{points:[],textBox:{active:!1,hasMoved:!1,movesIndependently:!1,drawnIndependently:!0,allowedOutsideImage:!0,hasBoundingBox:!0}},cachedStats:{area:i?i.MeasuredValueSequence.NumericValue:0},color:void 0,invalidated:!0}),u=a.GraphicData,s=0;s<u.length;s+=2)o.handles.points.push({x:u[s],y:u[s+1]});return o}},{key:"getTID300RepresentationArguments",value:function(e){var n=e.handles,t=e.finding,r=e.findingSites,a=e.cachedStats,i=void 0===a?{}:a,o=n.points,u=i.area,s=void 0===u?0:u,c=i.perimeter;return{points:o,area:s,perimeter:void 0===c?0:c,trackingIdentifierTextValue:"cornerstoneTools@^4.0.0:FreehandRoi",finding:t,findingSites:r||[]}}}]),e}();B.toolType="FreehandRoi",B.utilityToolType="FreehandRoi",B.TID300Representation=F,B.isValidCornerstoneTrackingIdentifier=function(e){if(!e.includes(":"))return!1;var n=v(e.split(":"),2),t=n[0],r=n[1];return t===_&&r===B.toolType},V.registerTool(B);var j=r.hC.TID300.Bidirectional,Y="Bidirectional",z=function(){function e(){g(this,e)}return h(e,null,[{key:"getMeasurementData",value:function(n){var t=n.ContentSequence,r=C(t).find((function(e){return"121071"===e.ConceptNameCodeSequence.CodeValue})),a=C(t).filter((function(e){return"G-C0E3"===e.ConceptNameCodeSequence.CodeValue})),i=C(t).find((function(e){return"Long Axis"===e.ConceptNameCodeSequence.CodeMeaning})),o=C(i.ContentSequence).find((function(e){return"SCOORD"===e.ValueType})),u=C(t).find((function(e){return"Short Axis"===e.ConceptNameCodeSequence.CodeMeaning})),s=C(u.ContentSequence).find((function(e){return"SCOORD"===e.ValueType})),c=o.ContentSequence.ReferencedSOPSequence,l=c.ReferencedSOPInstanceUID,d=c.ReferencedFrameNumber,f=String(i.MeasuredValueSequence.NumericValue),g=String(u.MeasuredValueSequence.NumericValue),p=Math.max(o.GraphicData[0],o.GraphicData[2],s.GraphicData[0],s.GraphicData[2]),h=Math.max(o.GraphicData[1],o.GraphicData[3],s.GraphicData[1],s.GraphicData[3]);return{sopInstanceUid:l,frameIndex:d||1,toolType:e.toolType,active:!1,handles:{start:{x:o.GraphicData[0],y:o.GraphicData[1],drawnIndependently:!1,allowedOutsideImage:!1,active:!1,highlight:!1,index:0},end:{x:o.GraphicData[2],y:o.GraphicData[3],drawnIndependently:!1,allowedOutsideImage:!1,active:!1,highlight:!1,index:1},perpendicularStart:{x:s.GraphicData[0],y:s.GraphicData[1],drawnIndependently:!1,allowedOutsideImage:!1,active:!1,highlight:!1,index:2},perpendicularEnd:{x:s.GraphicData[2],y:s.GraphicData[3],drawnIndependently:!1,allowedOutsideImage:!1,active:!1,highlight:!1,index:3},textBox:{highlight:!1,hasMoved:!0,active:!1,movesIndependently:!1,drawnIndependently:!0,allowedOutsideImage:!0,hasBoundingBox:!0,x:p+10,y:h+10}},invalidated:!1,isCreating:!1,longestDiameter:f,shortestDiameter:g,toolName:"Bidirectional",visible:!0,finding:r?r.ConceptCodeSequence:void 0,findingSites:a.map((function(e){return e.ConceptCodeSequence}))}}},{key:"getTID300RepresentationArguments",value:function(e){var n=e.handles,t=n.start,r=n.end,a=n.perpendicularStart,i=n.perpendicularEnd,o=e.shortestDiameter;return{longAxis:{point1:t,point2:r},shortAxis:{point1:a,point2:i},longAxisLength:e.longestDiameter,shortAxisLength:o,trackingIdentifierTextValue:"cornerstoneTools@^4.0.0:Bidirectional",finding:e.finding,findingSites:e.findingSites||[]}}}]),e}();z.toolType=Y,z.utilityToolType=Y,z.TID300Representation=j,z.isValidCornerstoneTrackingIdentifier=function(e){if(!e.includes(":"))return!1;var n=v(e.split(":"),2),t=n[0],r=n[1];return t===_&&r===Y},V.registerTool(z);var H=r.hC.TID300.Ellipse,X="EllipticalRoi",W=function(){function e(){g(this,e)}return h(e,null,[{key:"getMeasurementData",value:function(n){var t=V.getSetupMeasurementData(n),r=t.defaultState,a=t.NUMGroup,i=t.SCOORDGroup.GraphicData,o=[{x:i[0],y:i[1]},{x:i[2],y:i[3]}],u=[{x:i[4],y:i[5]},{x:i[6],y:i[7]}],s=Math.sqrt(Math.pow(u[0].x-u[1].x,2)+Math.pow(u[0].y-u[1].y,2)),c=(u[1].x-u[0].x)/s,d=(u[1].y-u[0].y)/s,f=s/2,g={x:o[0].x+c*f,y:o[0].y+d*f},p={x:o[1].x-c*f,y:o[1].y-d*f};return l(l({},r),{},{toolType:e.toolType,active:!1,cachedStats:{area:a?a.MeasuredValueSequence.NumericValue:0},handles:{end:{x:g.x,y:g.y,highlight:!1,active:!1},initialRotation:0,start:{x:p.x,y:p.y,highlight:!1,active:!1},textBox:{hasMoved:!1,movesIndependently:!1,drawnIndependently:!0,allowedOutsideImage:!0,hasBoundingBox:!0}},invalidated:!0,visible:!0})}},{key:"getTID300RepresentationArguments",value:function(e){var n=e.cachedStats,t=void 0===n?{}:n,r=e.handles,a=e.finding,i=e.findingSites,o=r.start,u=r.end,s=t.area,c=Math.abs(o.x-u.x)/2,l=Math.abs(o.y-u.y)/2,d=[],f={x:(o.x+u.x)/2,y:(o.y+u.y)/2};c>l?(d.push({x:f.x-c,y:f.y}),d.push({x:f.x+c,y:f.y}),d.push({x:f.x,y:f.y-l}),d.push({x:f.x,y:f.y+l})):(d.push({x:f.x,y:f.y-l}),d.push({x:f.x,y:f.y+l}),d.push({x:f.x-c,y:f.y}),d.push({x:f.x+c,y:f.y}));return{area:s,points:d,trackingIdentifierTextValue:"cornerstoneTools@^4.0.0:EllipticalRoi",finding:a,findingSites:i||[]}}}]),e}();W.toolType=X,W.utilityToolType=X,W.TID300Representation=H,W.isValidCornerstoneTrackingIdentifier=function(e){if(!e.includes(":"))return!1;var n=v(e.split(":"),2),t=n[0],r=n[1];return t===_&&r===X},V.registerTool(W);var J=r.hC.TID300.Circle,K="CircleRoi",Q=function(){function e(){g(this,e)}return h(e,null,[{key:"getMeasurementData",value:function(n){var t=V.getSetupMeasurementData(n),r=t.defaultState,a=t.NUMGroup,i=t.SCOORDGroup.GraphicData,o={x:i[0],y:i[1]},u={x:i[2],y:i[3]};return l(l({},r),{},{toolType:e.toolType,active:!1,cachedStats:{area:a?a.MeasuredValueSequence.NumericValue:0,radius:0,perimeter:0},handles:{end:l(l({},u),{},{highlight:!1,active:!1}),initialRotation:0,start:l(l({},o),{},{highlight:!1,active:!1}),textBox:{hasMoved:!1,movesIndependently:!1,drawnIndependently:!0,allowedOutsideImage:!0,hasBoundingBox:!0}},invalidated:!0,visible:!0})}},{key:"getTID300RepresentationArguments",value:function(e){var n=e.cachedStats,t=void 0===n?{}:n,r=e.handles,a=e.finding,i=e.findingSites,o=r.start,u=r.end,s=t.area,c=t.radius,l=2*Math.PI*c,d=[];d.push(o),d.push(u);return{area:s,perimeter:l,radius:c,points:d,trackingIdentifierTextValue:"cornerstoneTools@^4.0.0:CircleRoi",finding:a,findingSites:i||[]}}}]),e}();Q.toolType=K,Q.utilityToolType=K,Q.TID300Representation=J,Q.isValidCornerstoneTrackingIdentifier=function(e){if(!e.includes(":"))return!1;var n=v(e.split(":"),2),t=n[0],r=n[1];return t===_&&r===K},V.registerTool(Q);var $=r.hC.TID300.Point,Z="ArrowAnnotate",ee="CORNERSTONEFREETEXT",ne=function(){function e(){g(this,e)}return h(e,null,[{key:"getMeasurementData",value:function(n){var t=V.getSetupMeasurementData(n),r=t.defaultState,a=t.SCOORDGroup,i=t.findingGroup.ConceptCodeSequence.CodeMeaning,o=a.GraphicData;return l(l({},r),{},{toolType:e.toolType,active:!1,handles:{start:{x:o[0],y:o[1],highlight:!0,active:!1},end:{x:4==o.length?o[2]:o[0]+20,y:4==o.length?o[3]:o[1]+20,highlight:!0,active:!1},textBox:{hasMoved:!1,movesIndependently:!1,drawnIndependently:!0,allowedOutsideImage:!0,hasBoundingBox:!0}},invalidated:!0,text:i,visible:!0})}},{key:"getTID300RepresentationArguments",value:function(e){var n=[e.handles.start,e.handles.end],t=e.finding,r={points:n,trackingIdentifierTextValue:"cornerstoneTools@^4.0.0:ArrowAnnotate",findingSites:e.findingSites||[]};return t&&t.CodeValue===ee||(t={CodeValue:ee,CodingSchemeDesignator:"CST4",CodeMeaning:e.text}),r.finding=t,r}}]),e}();ne.toolType=Z,ne.utilityToolType=Z,ne.TID300Representation=$,ne.isValidCornerstoneTrackingIdentifier=function(e){if(!e.includes(":"))return!1;var n=v(e.split(":"),2),t=n[0],r=n[1];return t===_&&r===Z},V.registerTool(ne);var te=r.hC.TID300.CobbAngle,re="CobbAngle",ae=function(){function e(){g(this,e)}return h(e,null,[{key:"getMeasurementData",value:function(n){var t=V.getSetupMeasurementData(n),r=t.defaultState,a=t.NUMGroup,i=t.SCOORDGroup,o=l(l({},r),{},{rAngle:a.MeasuredValueSequence.NumericValue,toolType:e.toolType,handles:{start:{},end:{},start2:{highlight:!0,drawnIndependently:!0},end2:{highlight:!0,drawnIndependently:!0},textBox:{hasMoved:!1,movesIndependently:!1,drawnIndependently:!0,allowedOutsideImage:!0,hasBoundingBox:!0}}}),u=v(i.GraphicData,8);return o.handles.start.x=u[0],o.handles.start.y=u[1],o.handles.end.x=u[2],o.handles.end.y=u[3],o.handles.start2.x=u[4],o.handles.start2.y=u[5],o.handles.end2.x=u[6],o.handles.end2.y=u[7],o}},{key:"getTID300RepresentationArguments",value:function(e){var n=e.handles,t=e.finding,r=e.findingSites;return{point1:n.start,point2:n.end,point3:n.start2,point4:n.end2,rAngle:e.rAngle,trackingIdentifierTextValue:"cornerstoneTools@^4.0.0:CobbAngle",finding:t,findingSites:r||[]}}}]),e}();ae.toolType=re,ae.utilityToolType=re,ae.TID300Representation=te,ae.isValidCornerstoneTrackingIdentifier=function(e){if(!e.includes(":"))return!1;var n=v(e.split(":"),2),t=n[0],r=n[1];return t===_&&r===re},V.registerTool(ae);var ie=r.hC.TID300.Angle,oe="Angle",ue=function(){function e(){g(this,e)}return h(e,null,[{key:"getMeasurementData",value:function(n){var t=V.getSetupMeasurementData(n),r=t.defaultState,a=t.NUMGroup,i=t.SCOORDGroup,o=l(l({},r),{},{rAngle:a.MeasuredValueSequence.NumericValue,toolType:e.toolType,handles:{start:{},middle:{},end:{},textBox:{hasMoved:!1,movesIndependently:!1,drawnIndependently:!0,allowedOutsideImage:!0,hasBoundingBox:!0}}}),u=v(i.GraphicData,8);return o.handles.start.x=u[0],o.handles.start.y=u[1],o.handles.middle.x=u[2],o.handles.middle.y=u[3],o.handles.middle.x=u[4],o.handles.middle.y=u[5],o.handles.end.x=u[6],o.handles.end.y=u[7],o}},{key:"getTID300RepresentationArguments",value:function(e){var n=e.handles,t=e.finding,r=e.findingSites;return{point1:n.start,point2:n.middle,point3:n.middle,point4:n.end,rAngle:e.rAngle,trackingIdentifierTextValue:"cornerstoneTools@^4.0.0:Angle",finding:t,findingSites:r||[]}}}]),e}();ue.toolType=oe,ue.utilityToolType=oe,ue.TID300Representation=ie,ue.isValidCornerstoneTrackingIdentifier=function(e){if(!e.includes(":"))return!1;var n=v(e.split(":"),2),t=n[0],r=n[1];return t===_&&r===oe},V.registerTool(ue);var se=r.hC.TID300.Polyline,ce=function(){function e(){g(this,e)}return h(e,null,[{key:"getMeasurementData",value:function(n){var t=V.getSetupMeasurementData(n),r=t.defaultState,a=t.SCOORDGroup,i=t.NUMGroup,o=l(l({},r),{},{toolType:e.toolType,handles:{start:{},end:{},textBox:{active:!1,hasMoved:!1,movesIndependently:!1,drawnIndependently:!0,allowedOutsideImage:!0,hasBoundingBox:!0},initialRotation:0},cachedStats:{area:i?i.MeasuredValueSequence.NumericValue:0},color:void 0,invalidated:!0}),u=v(a.GraphicData,6);return o.handles.start.x=u[0],o.handles.start.y=u[1],u[2],u[3],o.handles.end.x=u[4],o.handles.end.y=u[5],o}},{key:"getTID300RepresentationArguments",value:function(e){var n=e.finding,t=e.findingSites,r=e.cachedStats,a=void 0===r?{}:r,i=e.handles,o=i.start,u=i.end;return{points:[o,{x:o.x,y:u.y},u,{x:u.x,y:o.y}],area:a.area,perimeter:a.perimeter,trackingIdentifierTextValue:"cornerstoneTools@^4.0.0:RectangleRoi",finding:n,findingSites:t||[]}}}]),e}();ce.toolType="RectangleRoi",ce.utilityToolType="RectangleRoi",ce.TID300Representation=se,ce.isValidCornerstoneTrackingIdentifier=function(e){if(!e.includes(":"))return!1;var n=v(e.split(":"),2),t=n[0],r=n[1];return t===_&&r===ce.toolType},V.registerTool(ce);var le=r.hC.orientation,de=le.rotateDirectionCosinesInPlane,fe=le.flipImageOrientationPatient,ge=le.flipMatrix2D,pe=le.rotateMatrix902D,he=r.hC.datasetToBlob,me=r.hC.BitArray,ve=r.hC.DicomMessage,Se=r.hC.DicomMetaDictionary,ye=r.oq.Normalizer,Ie=r.U7.Segmentation,Te={generateSegmentation:function(e,n){var t=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{includeSliceSpacing:!0},r=n.toolState,a=n.segments,i=e[0],o={x:i.columns,y:i.rows,z:e.length};if(o.xy=o.x*o.y,!Ce(s,a))throw new Error("No segments to export!");for(var u=i.imageId.includes("?frame"),s=function(e,n,t){var r=[];if(n){var a=e[0].data.byteArray.buffer,i=ve.readFile(a),o=Se.naturalizeDataset(i.dict);o._meta=Se.namifyDataset(i.meta),r.push(o)}else for(var u=0;u<e.length;u++){var s=e[u].data.byteArray.buffer,c=ve.readFile(s),l=Se.naturalizeDataset(c.dict);l._meta=Se.namifyDataset(c.meta),r.push(l)}var d=ye.normalizeToDataset(r);return new Ie([d],t)}(e,u,t),c=function(e,n,t){for(var r=[],a=[],i=0;i<t.length;i++)t[i]&&(r.push(i),a.push([]));for(var o=0;o<n.length;o++)for(var u=e[n[o].imageId],s=0;s<r.length;s++){var c=r[s];u&&u.brush&&u.brush.data&&u.brush.data[c]&&u.brush.data[c].pixelData&&a[s].push(o)}return{referencedFramesPerSegment:a,segmentIndicies:r}}(r,e,a),l=c.referencedFramesPerSegment,d=c.segmentIndicies,f=0,g=0;g<l.length;g++)f+=l[g].length;s.setNumberOfFrames(f);for(var p=0;p<d.length;p++){var h=d[p],m=l[p],v=m.map((function(e){return e+1})),S=a[h];s.addSegment(S,De(h,m,r,e,o),v)}return s.bitPackPixelData(),he(s.dataset)},generateToolState:function(e,n,t){var a=ve.readFile(n),o=Se.naturalizeDataset(a.dict);o._meta=Se.namifyDataset(a.meta);var u=ye.normalizeToDataset([o]),s=t.get("imagePlaneModule",e[0]);s||console.warn("Insufficient metadata, imagePlaneModule missing.");for(var c=function(e){var n=[];n[0]=e,n[1]=fe.h(e),n[2]=fe.v(e);var t=de(e,Math.PI/2);return n[3]=t,n[4]=fe.h(t),n[5]=fe.v(t),n[6]=de(e,Math.PI),n[7]=de(e,1.5*Math.PI),n}(Array.isArray(s.rowCosines)?[].concat(S(s.rowCosines),S(s.columnCosines)):[s.rowCosines.x,s.rowCosines.y,s.rowCosines.z,s.columnCosines.x,s.columnCosines.y,s.columnCosines.z]),l=u.SharedFunctionalGroupsSequence,d=l.PlaneOrientationSequence?l.PlaneOrientationSequence.ImageOrientationPatient:void 0,f=u.Columns*u.Rows,g=function(e){var n=[],t=e.SegmentSequence;if(Array.isArray(t))for(var r=0;r<t.length;r++)n.push(t[r]);else n.push(t);return{seriesInstanceUid:e.ReferencedSeriesSequence.SeriesInstanceUID,data:n}}(u),p=function(e){var n=e.SegmentationType;if("BINARY"===n)return me.unpack(e.PixelData);var t=new Uint8Array(e.PixelData),a=e.MaximumFractionalValue,i=void 0===t.find((function(e){return 0!==e&&e!==a}));if(!i)return void r.cM.warn("This is a fractional segmentation, which is not currently supported.");return r.cM.warn("This segmentation object is actually binary... processing as such."),t}(u),h=u.PerFrameFunctionalGroupsSequence,m={},v=!0,y=0;y<h.length;y++){var I=h[y],T=d||I.PlaneOrientationSequence.ImageOrientationPatient,D=Re(i()(new Uint8Array(p.buffer,y*f,f),[u.Rows,u.Columns]),T,c);if(!D){console.warn("This segmentation object is not in-plane with the source data. Bailing out of IO. It'd be better to render this with vtkjs. "),v=!1;break}var C=I.SegmentIdentificationSequence.ReferencedSegmentNumber-1;Oe(m,xe(l.DerivationImageSequence&&l.DerivationImageSequence.SourceImageSequence?l.DerivationImageSequence.SourceImageSequence[y]:I.DerivationImageSequence.SourceImageSequence,e,t),C,D)}if(!v)return;return{toolState:m,segMetadata:g}}};function De(e,n,t,r,a){for(var i=new Uint8Array(a.xy*n.length),o=0,u=0;u<n.length;u++)for(var s=t[r[n[u]].imageId].brush.data[e].pixelData,c=0;c<s.length;c++)i[o]=s[c],o++;return i}function Ce(e,n){for(var t=0,r=0;r<n.length;r++)n[r]&&t++;return t}function Oe(e,n,t,r){e[n]?e[n].brush?e[n].brush.data||(e[n].brush.data=[]):(e[n].brush={},e[n].brush.data=[]):(e[n]={},e[n].brush={},e[n].brush.data=[]),e[n].brush.data[t]={};var a=e[n].brush.data[t];a.pixelData=new Uint8Array(r.data.length);for(var i=a.pixelData,o=0;o<i.length;o++)r.data[o]?i[o]=1:i[o]=0}function xe(e,n,t){var r=e.ReferencedSOPInstanceUID,a=e.ReferencedFrameNumber;return a?function(e,n,t,r){var a=t.find((function(t){var a=r.get("sopCommonModule",t);if(a){var i=Number(t.split("frame=")[1]);return a.sopInstanceUID===e&&i===n-1}}));return a}(r,a,n,t):function(e,n,t){return n.find((function(n){var r=t.get("sopCommonModule",n);if(r)return r.sopInstanceUID===e}))}(r,n,t)}function Re(e,n,t){return Me(n,t[0])?e:Me(n,t[1])?ge.v(e):Me(n,t[2])?ge.h(e):Me(n,t[3])?pe(e):Me(n,t[4])?ge.h(pe(e)):Me(n,t[5])?ge.v(pe(e)):Me(n,t[6])?pe(pe(e)):Me(n,t[7])?pe(pe(pe(e))):void 0}var be,we=1e-5;function Me(e,n){return Math.abs(e[0]-n[0])<we&&Math.abs(e[1]-n[1])<we&&Math.abs(e[2]-n[2])<we&&Math.abs(e[3]-n[3])<we&&Math.abs(e[4]-n[4])<we&&Math.abs(e[5]-n[5])<we}!function(e){e.SEGMENTATION_LOAD_PROGRESS="CORNERSTONE_ADAPTER_SEGMENTATION_LOAD_PROGRESS"}(be||(be={}));var Ee=be,Pe=Object.freeze({__proto__:null,Events:Ee}),Ae=r.hC.orientation,Ne=Ae.rotateDirectionCosinesInPlane,qe=Ae.flipImageOrientationPatient,ke=Ae.flipMatrix2D,Ve=Ae.rotateMatrix902D,_e=Ae.nearlyEqual,Ge=r.aT.BitArray,Ue=r.aT.DicomMessage,Le=r.aT.DicomMetaDictionary,Fe=r.oq.Normalizer,Be=r.U7.Segmentation,je=r.hC.compression,Ye=je.encode,ze=je.decode,He={includeSliceSpacing:!0,rleEncode:!1};function Xe(e,n){for(var t=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},r=Object.assign({},He,t),a=Array.isArray(n)?n:[n],i=0,o=[],u=function(){for(var e=a[s],n=e.labelmaps2D,t=e.metadata,r=[],u=1;u<t.length;u++)t[u]&&(r[u]=[]);for(var c=function(e){var t=n[e];n[e]&&t.segmentsOnLabelmap.forEach((function(n){0!==n&&(r[n].push(e),i++)}))},l=0;l<n.length;l++)c(l);o[s]=r},s=0;s<a.length;s++)u();e.setNumberOfFrames(i);for(var c=0;c<a.length;c++)for(var l=o[c],d=a[c],f=d.metadata,g=1;g<l.length;g++){var p=l[g];if(p){var h=p.map((function(e){return e+1})),m=f[g],v=We(d,p);e.addSegmentFromLabelmap(m,v,g,h)}}if(r.rleEncode){var S=Ye(e.dataset.PixelData,i,e.dataset.Rows,e.dataset.Columns);e.assignToDataset({BitsAllocated:"8",BitsStored:"8",HighBit:"7",SegmentationType:"FRACTIONAL",SegmentationFractionalType:"PROBABILITY",MaximumFractionalValue:"255"}),e.dataset._meta.TransferSyntaxUID={Value:["1.2.840.10008.1.2.5"],vr:"UI"},e.dataset._vrMap.PixelData="OB",e.dataset.PixelData=S}else e.bitPackPixelData();return e}function We(e,n){for(var t=e.labelmaps2D,r=[],a=0;a<n.length;a++){var i=n[a];r.push(t[i].pixelData)}return r}function Je(){var e;return e=d().mark((function e(n,t,r,a){var i,o,u,s,c,l,f,g,p,h,m,v,y,I,T,D,C,O,x,R,b,w,M,E,P,A,N,q,k,V,_,G,U,L;return d().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(i=a.skipOverlapping,o=void 0!==i&&i,u=a.tolerance,s=void 0===u?.001:u,c=a.TypedArrayConstructor,l=void 0===c?Uint8Array:c,f=a.maxBytesPerChunk,g=void 0===f?199e6:f,p=a.eventTarget,h=a.triggerEvent,m=Ue.readFile(t),(v=Le.naturalizeDataset(m.dict))._meta=Le.namifyDataset(m.meta),y=Fe.normalizeToDataset([v]),I=r.get("imagePlaneModule",n[0]),T=r.get("generalSeriesModule",n[0]),D=T.seriesInstanceUID,I||console.warn("Insufficient metadata, imagePlaneModule missing."),C=Array.isArray(I.rowCosines)?[].concat(S(I.rowCosines),S(I.columnCosines)):[I.rowCosines.x,I.rowCosines.y,I.rowCosines.z,I.columnCosines.x,I.columnCosines.y,I.columnCosines.z],O=rn(C),x=y.Columns*y.Rows,R=un(y,D),"1.2.840.10008.1.2.5"!==y._meta.TransferSyntaxUID.Value[0]){e.next=23;break}if(M=Array.isArray(y.PixelData)?y.PixelData:[y.PixelData],b=ze(M,y.Rows,y.Columns),1!==y.BitsStored){e.next=20;break}return console.warn("No implementation for rle + bitbacking."),e.abrupt("return");case 20:w=[b],e.next=26;break;case 23:if(w=tn(y,{maxBytesPerChunk:g})){e.next=26;break}throw new Error("Fractional segmentations are not yet supported");case 26:E=nn(y,O,[I.rows,I.columns,n.length],s),P=n.reduce((function(e,n){return e[r.get("generalImageModule",n).sopInstanceUid]=n,e}),{}),A=!1,o||(A=Qe(w,y,n,O,r,s,l,P)),e.t0=E,e.next="Planar"===e.t0?33:"Perpendicular"===e.t0?35:"Oblique"===e.t0?36:37;break;case 33:return N=A?$e:en,e.abrupt("break",37);case 35:throw new Error("Segmentations orthogonal to the acquisition plane of the source data are not yet supported.");case 36:throw new Error("Segmentations oblique to the acquisition plane of the source data are not yet supported.");case 37:return(q=[])[0]=[],k=[],V=x*n.length*l.BYTES_PER_ELEMENT,(_=[])[0]=new ArrayBuffer(V),G=n.reduce((function(e,n,t){return e.indices[n]=t,e.metadata[n]=r.get("instance",n),e}),{indices:{},metadata:{}}),U=new Map,e.next=47,N(k,q,_,w,y,n,O,r,s,l,U,P,G,p,h);case 47:return L=new Map,U.forEach((function(e,n){var t=cn(e,y),r=t.xAcc,a=t.yAcc,i=t.zAcc,o=t.count;L.set(n,{x:Math.floor(r/o),y:Math.floor(a/o),z:Math.floor(i/o)})})),e.abrupt("return",{labelmapBufferArray:_,segMetadata:R,segmentsOnFrame:k,segmentsOnFrameArray:q,centroids:L});case 50:case"end":return e.stop()}}),e)})),Je=function(){var n=this,t=arguments;return new Promise((function(r,a){var i=e.apply(n,t);function o(e){f(i,r,a,o,u,"next",e)}function u(e){f(i,r,a,o,u,"throw",e)}o(void 0)}))},Je.apply(this,arguments)}function Ke(e,n,t,r,a,i){var o=void 0;if(!e)return o;var u=e.FrameOfReferenceUID,s=e.PerFrameFunctionalGroupsSequence,c=e.SourceImageSequence,l=e.ReferencedSeriesSequence;if(!s||0===s.length)return o;var d=s[n];if(!d)return o;var f=void 0;if(c&&0!==c.length)f=c[n];else if(d.DerivationImageSequence){var g=d.DerivationImageSequence;Array.isArray(g)&&(g=0!==g.length?g[0]:void 0),g&&(f=g.SourceImageSequence,Array.isArray(f)&&(f=0!==f.length?f[0]:void 0))}(f&&(o=function(e,n){var t=e.ReferencedSOPInstanceUID,r=e.ReferencedFrameNumber;return r?function(e,n,t){var r=t[e];if(!r)return;var a=Number(r.split("frame=")[1]);return a===n-1?r:void 0}(t,r,n):n[t]}(f,i)),void 0===o&&l)&&(o=function(e,n,t,r,a,i){if(void 0===e||void 0===t.PlanePositionSequence||void 0===t.PlanePositionSequence[0]||void 0===t.PlanePositionSequence[0].ImagePositionPatient)return;for(var o=0;o<r.length;++o){var u=a.get("instance",r[o]);if(void 0!==u&&void 0!==u.ImagePositionPatient&&u.FrameOfReferenceUID===n&&u.SeriesInstanceUID===e&&on(t.PlanePositionSequence[0].ImagePositionPatient,u.ImagePositionPatient,i))return r[o]}}((Array.isArray(l)?l[0]:l).SeriesInstanceUID,u,d,t,r,a));return o}function Qe(e,n,t,r,a,o,u,s){var c=n.SharedFunctionalGroupsSequence,l=n.PerFrameFunctionalGroupsSequence,d=n.SegmentSequence,f=n.Rows,g=n.Columns;if(d.length<2)return!1;for(var p=c.PlaneOrientationSequence?c.PlaneOrientationSequence.ImageOrientationPatient:void 0,h=g*f,m=l.length,S=new Map,y=function(){if(void 0===Ze(n,I))return console.warn("Could not retrieve the segment index for frame segment "+I+", skipping this frame."),"continue";var e=Ke(n,I,t,a,o,s);if(!e)return console.warn("Image not present in stack, can't import frame : "+I+"."),"continue";var r=t.findIndex((function(n){return n===e}));if(S.has(r)){var i=S.get(r);i.includes(I)||(i.push(I),S.set(r,i))}else S.set(r,[I])},I=0;I<m;++I)y();var D,C=T(S.entries());try{for(C.s();!(D=C.n()).done;)for(var O=v(D.value,2)[1],x=new u(h).fill(0),R=0;R<O.length;++R){var b=O[R],w=l[b],M=p||w.PlaneOrientationSequence.ImageOrientationPatient,E=sn(e,b*h,h),P=an(i()(E,[f,g]),M,r,o);if(P){for(var A=P.data,N=0,q=A.length;N<q;++N)if(0!==A[N]&&(x[N]++,x[N]>1))return!0}else console.warn("Individual SEG frames are out of plane with respect to the first SEG frame, this is not yet supported, skipping this frame.")}}catch(e){C.e(e)}finally{C.f()}return!1}function $e(e,n,t,r,a,o,s,c,l,d,f,g){for(var p=a.SharedFunctionalGroupsSequence,h=a.PerFrameFunctionalGroupsSequence,m=a.Rows,v=a.Columns,S=p.PlaneOrientationSequence?p.PlaneOrientationSequence.ImageOrientationPatient:void 0,y=v*m,I=y*o.length*d.BYTES_PER_ELEMENT,T=1,D=0,C=t[D].slice(0),O=u()(n[D]),x=a.SegmentSequence.length,R=1;R<=x;++R){for(var b=function(f){var p=h[f],x=Ze(a,f);if(void 0===x)throw new Error("Could not retrieve the segment index. Aborting segmentation loading.");if(x!==R)return w=f,"continue";var b=S||p.PlaneOrientationSequence.ImageOrientationPatient,M=sn(r,f*y,y),E=an(i()(M,[m,v]),b,s,l);if(!E)throw new Error("Individual SEG frames are out of plane with respect to the first SEG frame. This is not yet supported. Aborting segmentation loading.");var P=Ke(a,f,o,c,l,g);if(!P)return console.warn("Image not present in stack, can't import frame : "+f+"."),w=f,"continue";var A=c.get("instance",P);if(m!==A.Rows||v!==A.Columns)throw new Error("Individual SEG frames have different geometry dimensions (Rows and Columns) respect to the source image reference frame. This is not yet supported. Aborting segmentation loading. ");for(var N=o.findIndex((function(e){return e===P})),q=y*N*d.BYTES_PER_ELEMENT,k=new d(C,q,y),V=E.data,_=!1,G=0,U=E.data.length;G<U;++G)if(V[G]){if(0!==k[G]){++D>=T&&(t[D]=new ArrayBuffer(I),n[D]=[],T++),C=t[D].slice(0),O=u()(n[D]),f=0;break}k[G]=x,_=!0}_&&(O[N]||(O[N]=[]),O[N].push(x),e[N]||(e[N]=[]),e[N].push(x)),w=f},w=0,M=h.length;w<M;++w)b(w);t[D]=C.slice(0),n[D]=u()(O),C=t[D=0].slice(0),O=u()(n[D])}}var Ze=function(e,n){var t=e.PerFrameFunctionalGroupsSequence,r=e.SharedFunctionalGroupsSequence,a=t[n];return a&&a.SegmentIdentificationSequence?a.SegmentIdentificationSequence.ReferencedSegmentNumber:r.SegmentIdentificationSequence?r.SegmentIdentificationSequence.ReferencedSegmentNumber:void 0};function en(e,n,t,r,a,o,u,s,c,l,d,f,g,p,h){var m=a.SharedFunctionalGroupsSequence,v=a.PerFrameFunctionalGroupsSequence,S=a.Rows,y=a.Columns,I=m.PlaneOrientationSequence?m.PlaneOrientationSequence.ImageOrientationPatient:void 0,T=y*S,D=0,C=v.length,O=Math.ceil(C/10),x=h&&p;return new Promise((function(n){!function m(){for(var R=Math.min(D+O,C);D<R;++D){var b=v[D],w=I||b.PlaneOrientationSequence.ImageOrientationPatient,M=sn(r,D*T,T),E=an(i()(M,[S,y]),w,u,c);if(!E)throw new Error("Individual SEG frames are out of plane with respect to the first SEG frame. This is not yet supported. Aborting segmentation loading.");var P=Ze(a,D);if(void 0===P)throw new Error("Could not retrieve the segment index. Aborting segmentation loading.");d.has(P)||d.set(P,{});var A=Ke(a,D,o,s,c,f);if(A){var N=g.metadata[A];if(S!==N.Rows||y!==N.Columns)throw new Error("Individual SEG frames have different geometry dimensions (Rows and Columns) respect to the source image reference frame. This is not yet supported. Aborting segmentation loading. ");for(var q=g.indices[A],k=T*q*l.BYTES_PER_ELEMENT,V=new l(t[0],k,T),_=E.data,G=[],U=0,L=E.data.length;U<L;++U)if(_[U]){for(var F=U;F<L;++F)_[F]&&(V[F]=P,G.push(F));e[q]||(e[q]=[]),e[q].push(P);break}var B=d.get(P);B[q]=G,d.set(P,B)}else console.warn("Image not present in stack, can't import frame : "+D+".")}if(x){var j=Math.round(D/C*100);h(p,Ee.SEGMENTATION_LOAD_PROGRESS,{percentComplete:j})}D<C?setTimeout(m,0):n()}()}))}function nn(e,n,t,r){var a=e.SharedFunctionalGroupsSequence,i=e.PerFrameFunctionalGroupsSequence,o=a.PlaneOrientationSequence?a.PlaneOrientationSequence.ImageOrientationPatient:void 0,u=i[0],s=o||u.PlaneOrientationSequence.ImageOrientationPatient;return n.some((function(e){return on(s,e,r)}))?"Planar":function(e,n,t){var r=Math.abs(e[0]*n[0]+e[1]*n[1]+e[2]*n[2]),a=Math.abs(e[3]*n[3]+e[4]*n[4]+e[5]*n[5]);return(r<t||Math.abs(r-1)<t)&&(a<t||Math.abs(a-1)<t)}(s,n[0],r)&&t.includes(e.Rows)&&t.includes(e.Columns)?"Perpendicular":"Oblique"}function tn(e,n){var t,a=e.SegmentationType;if(void 0===(t=Array.isArray(e.PixelData)?e.PixelData[0]:e.PixelData)&&r.cM.error("This segmentation pixeldata is undefined."),"BINARY"===a)return function(e,n){for(var t=new Uint8Array(e),r=[],a=8*n,i=Math.ceil(8*t.length/a),o=0;o<i;o++){var u=o*a,s=Math.min(u+a,8*t.length),c=Math.floor(u/8),l=Math.ceil(s/8),d=t.slice(c,l),f=Ge.unpack(d);r.push(f)}return r}(t,n.maxBytesPerChunk);var i=new Uint8Array(t),o=e.MaximumFractionalValue;return void 0===i.find((function(e){return 0!==e&&e!==o}))?(r.cM.warn("This segmentation object is actually binary... processing as such."),i):void 0}function rn(e){var n=[];n[0]=e,n[1]=qe.h(e),n[2]=qe.v(e);var t=Ne(e,Math.PI/2);return n[3]=t,n[4]=qe.h(t),n[5]=qe.v(t),n[6]=Ne(e,Math.PI),n[7]=Ne(e,1.5*Math.PI),n}function an(e,n,t,r){return on(n,t[0],r)?e:on(n,t[1],r)?ke.v(e):on(n,t[2],r)?ke.h(e):on(n,t[3],r)?Ve(e):on(n,t[4],r)?Ve(ke.h(e)):on(n,t[5],r)?Ve(ke.v(e)):on(n,t[6],r)?Ve(Ve(e)):on(n,t[7],r)?Ve(Ve(Ve(e))):void 0}function on(e,n,t){if(e.length!=n.length)return!1;for(var r=0;r<e.length;++r)if(!_e(e[r],n[r],t))return!1;return!0}function un(e,n){var t=e.SegmentSequence;return{seriesInstanceUid:n,data:Array.isArray(t)?[void 0].concat(S(t)):[void 0,t]}}function sn(e,n,t){var r=function(e,n,t){var r=e.reduce((function(e,n){return e+n.length}),0);if(n<0||n+t>r)throw new Error("Offset and length out of bounds");var a=0,i=n;for(;i>=e[a].length;)i-=e[a].length,a++;var o=a,u=i+t;for(;u>e[o].length;)u-=e[o].length,o++;return{start:{chunkIndex:a,offset:i},end:{chunkIndex:o,offset:u}}}(e,n,t);if(r.start.chunkIndex===r.end.chunkIndex)return new Uint8Array(e[r.start.chunkIndex].buffer,r.start.offset,t);for(var a=new Uint8Array(t),i=0,o=r.start.chunkIndex;o<=r.end.chunkIndex;o++){var u=o===r.start.chunkIndex?r.start.offset:0,s=o===r.end.chunkIndex?r.end.offset:e[o].length;a.set(new Uint8Array(e[o].buffer,u,s-u),i),i+=s-u}return a}function cn(e,n){for(var t=0,r=0,a=0,i=0,o=0,u=Object.entries(e);o<u.length;o++){var s=v(u[o],2),c=s[0],l=s[1],d=Number(c);if(l&&0!==l.length){var f,g=T(l);try{for(g.s();!(f=g.n()).done;){var p=f.value,h=Math.floor(p/n.Rows);t+=p%n.Rows,r+=h,a+=d,i++}}catch(e){g.e(e)}finally{g.f()}}}return{xAcc:t,yAcc:r,zAcc:a,count:i}}var ln={generateSegmentation:function(e,n){var t=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},r=e[0].imageId.includes("?frame");return Xe(function(e,n,t){var r=[];if(n){var a=e[0].data.byteArray.buffer,i=Ue.readFile(a),o=Le.naturalizeDataset(i.dict);o._meta=Le.namifyDataset(i.meta),r.push(o)}else for(var u=0;u<e.length;u++){var s=e[u].data.byteArray.buffer,c=Ue.readFile(s),l=Le.naturalizeDataset(c.dict);l._meta=Le.namifyDataset(c.meta),r.push(l)}var d=Fe.normalizeToDataset(r);return new Be([d],t)}(e,r,t),n,t)},generateToolState:function(e,n,t,r){return Je.apply(this,arguments)},fillSegmentation:Xe};var dn={Length:L,FreehandRoi:B,Bidirectional:z,EllipticalRoi:W,CircleRoi:Q,ArrowAnnotate:ne,MeasurementReport:V,CobbAngle:ae,Angle:ue,RectangleRoi:ce},fn={Segmentation:{generateSegmentation:function(e,n){var t=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{includeSliceSpacing:!0},r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:4;if(4===r)return ln.generateSegmentation(e,n,t);if(3===r)return Te.generateSegmentation(e,n,t);console.warn("No generateSegmentation adapater for cornerstone version ".concat(r,", exiting."))},generateToolState:function(e,n,t){var r=arguments.length>3&&void 0!==arguments[3]&&arguments[3],a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:.001,i=arguments.length>5&&void 0!==arguments[5]?arguments[5]:4;if(4===i)return ln.generateToolState(e,n,t,r,a);if(3===i)return Te.generateToolState(e,n,t);console.warn("No generateToolState adapater for cornerstone version ".concat(i,", exiting."))},fillSegmentation:function(e,n){var t=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{includeSliceSpacing:!0},r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:4;if(4===r)return ln.fillSegmentation(e,n,t);console.warn("No generateSegmentation adapater for cornerstone version ".concat(r,", exiting."))}}},gn=function(){return gn=Object.assign||function(e){for(var n,t=1,r=arguments.length;t<r;t++)for(var a in n=arguments[t])Object.prototype.hasOwnProperty.call(n,a)&&(e[a]=n[a]);return e},gn.apply(this,arguments)};function pn(e,n,t){if(t||2===arguments.length)for(var r,a=0,i=n.length;a<i;a++)!r&&a in n||(r||(r=Array.prototype.slice.call(n,0,a)),r[a]=n[a]);return e.concat(r||Array.prototype.slice.call(n))}var hn="Cornerstone3DTools@^0.1.0",mn={CodingSchemeDesignator:"CORNERSTONEJS",codeValues:{CORNERSTONEFREETEXT:"CORNERSTONEFREETEXT"}},vn=r.hC.TID1500,Sn=r.hC.addAccessors,yn=r.U7.StructuredReport,In=r.oq.Normalizer,Tn=vn.TID1500MeasurementReport,Dn=vn.TID1501MeasurementGroup,Cn=r.aT.DicomMetaDictionary,On={CodingSchemeDesignator:"DCM",CodeValue:"121071"},xn={CodingSchemeDesignator:"SCT",CodeValue:"363698007"},Rn={CodingSchemeDesignator:"SRT",CodeValue:"G-C0E3"},bn=function(e,n,t){var r=e.ConceptNameCodeSequence;if(r){var a=r.CodingSchemeDesignator,i=r.CodeValue;return a==n.CodingSchemeDesignator&&i==n.CodeValue||t&&a==t.CodingSchemeDesignator&&i==t.CodeValue}};function wn(e,n,t,r){var a=n[e],i=Mn.CORNERSTONE_TOOL_CLASSES_BY_TOOL_TYPE[e];if(a&&a.data&&a.data.length&&i){var o=a.data.map((function(e){return function(e,n,t,r,a){var i=r.getTID300RepresentationArguments(e,a);return i.ReferencedSOPSequence=t,new r.TID300Representation(i)}(e,0,t,i,r)}));return new Dn(o)}}var Mn=function(){function e(){}return e.getCornerstoneLabelFromDefaultState=function(e){var n=e.findingSites,t=void 0===n?[]:n,r=e.finding,a=mn.codeValues.CORNERSTONEFREETEXT,i=t.find((function(e){return e.CodeValue===a}));return i?i.CodeMeaning:r&&r.CodeValue===a?r.CodeMeaning:void 0},e.generateDatasetMeta=function(){var e=new Uint8Array(2);return e[1]=1,{FileMetaInformationVersion:{Value:[e.buffer],vr:"OB"},TransferSyntaxUID:{Value:["1.2.840.10008.1.2.1"],vr:"UI"},ImplementationClassUID:{Value:[Cn.uid()],vr:"UI"},ImplementationVersionName:{Value:["dcmjs"],vr:"SH"}}},e.getSetupMeasurementData=function(n,t,r,a){var i=n.ContentSequence,o=C(i),u=o.find((function(e){return bn(e,On)})),s=o.filter((function(e){return bn(e,xn,Rn)}))||[],c=o.find((function(e){return"NUM"===e.ValueType})),l=C(c.ContentSequence).find((function(e){return"SCOORD"===e.ValueType})),d=l.ContentSequence.ReferencedSOPSequence,f=d.ReferencedSOPInstanceUID,g=d.ReferencedFrameNumber,p=t[f],h=r.get("imagePlaneModule",p),m=u?Sn(u.ConceptCodeSequence):void 0,v=s.map((function(e){return Sn(e.ConceptCodeSequence)})),S={description:void 0,sopInstanceUid:f,annotation:{annotationUID:Cn.uid(),metadata:{toolName:a,referencedImageId:p,FrameOfReferenceUID:h.frameOfReferenceUID,label:""},data:void 0},finding:m,findingSites:v};return S.finding&&(S.description=S.finding.CodeMeaning),S.annotation.metadata.label=e.getCornerstoneLabelFromDefaultState(S),{defaultState:S,NUMGroup:c,SCOORDGroup:l,ReferencedSOPSequence:d,ReferencedSOPInstanceUID:f,ReferencedFrameNumber:g}},e.generateReport=function(n,t,r,a){var i=[],o={},u=[],s=e.generateDatasetMeta();Object.keys(n).forEach((function(a){var s=t.get("sopCommonModule",a),c=t.get("instance",a),l=s.sopInstanceUID,d=s.sopClassUID,f=c.SeriesInstanceUID;if(o[l]=f,!u.find((function(e){return e.SeriesInstanceUID===f}))){var g=e.generateDerivationSourceDataset(c);u.push(g)}var p=t.get("frameNumber",a),h=n[a],m=Object.keys(h),v={ReferencedSOPClassUID:d,ReferencedSOPInstanceUID:l,ReferencedFrameNumber:void 0};(c&&c.NumberOfFrames&&c.NumberOfFrames>1||In.isMultiframeSOPClassUID(d))&&(v.ReferencedFrameNumber=p);var S=[];m.forEach((function(e){var n=wn(e,h,v,r);n&&S.push(n)})),i=i.concat(S)}));var c=new Tn({TID1501MeasurementGroups:i},a),l=new yn(u,a),d=c.contentItem(u,gn(gn({},a),{sopInstanceUIDsToSeriesInstanceUIDMap:o}));return l.dataset=Object.assign(l.dataset,d),l.dataset._meta=s,l},e.generateToolState=function(n,t,r,a,i){if("1500"!==n.ContentTemplateSequence.TemplateIdentifier)throw new Error("This package can currently only interpret DICOM SR TID 1500");var o=C(n.ContentSequence).find(O("Imaging Measurements")),u=C(o.ContentSequence).filter(O("Measurement Group")),s={},c=e.CORNERSTONE_TOOL_CLASSES_BY_UTILITY_TYPE,l=[];return Object.keys(c).forEach((function(e){l.push(c[e]),s[e]=[]})),u.forEach((function(e){var o;try{var u=C(e.ContentSequence).find((function(e){return"Tracking Identifier"===e.ConceptNameCodeSequence.CodeMeaning})).TextValue,c=(null===(o=null==i?void 0:i.getToolClass)||void 0===o?void 0:o.call(i,e,n,l))||l.find((function(e){return e.isValidCornerstoneTrackingIdentifier(u)}));if(c){var d=c.getMeasurementData(e,t,r,a);console.log("=== ".concat(c.toolType," ===")),console.log(d),s[c.toolType].push(d)}}catch(n){console.warn("Unable to generate tool state for",e,n)}})),s},e.registerTool=function(n){e.CORNERSTONE_TOOL_CLASSES_BY_UTILITY_TYPE[n.utilityToolType]=n,e.CORNERSTONE_TOOL_CLASSES_BY_TOOL_TYPE[n.toolType]=n,e.MEASUREMENT_BY_TOOLTYPE[n.toolType]=n.utilityToolType},e.CORNERSTONE_3D_TAG=hn,e.MEASUREMENT_BY_TOOLTYPE={},e.CORNERSTONE_TOOL_CLASSES_BY_UTILITY_TYPE={},e.CORNERSTONE_TOOL_CLASSES_BY_TOOL_TYPE={},e.generateDerivationSourceDataset=function(n){var t=e.generateDatasetMeta();return gn(gn({},n),{_meta:t,_vrMap:{PixelData:"OW"}})},e}(),En=r.hC.TID300.Point,Pn="ArrowAnnotate",An="".concat(hn,":").concat(Pn),Nn=mn.codeValues,qn=mn.CodingSchemeDesignator,kn=function(){function e(){g(this,e)}return h(e,null,[{key:"getMeasurementData",value:function(n,t,r,a){for(var i=Mn.getSetupMeasurementData(n,t,a,e.toolType),o=i.defaultState,u=i.SCOORDGroup,s=i.ReferencedFrameNumber,c=o.annotation.metadata.referencedImageId,l=o.annotation.metadata.label,d=u.GraphicData,f=[],g=0;g<d.length;g+=2){var p=r(c,[d[g],d[g+1]]);f.push(p)}if(1===f.length){var h=a.get("imagePixelModule",c),m=10,v=10;if(h)m=h.columns/10,v=h.rows/10;var S=r(c,[d[0]+m,d[1]+v]);f.push(S)}var y=o;return y.annotation.data={text:l,handles:{arrowFirst:!0,points:[f[0],f[1]],activeHandleIndex:0,textBox:{hasMoved:!1}},frameNumber:s},y}},{key:"getTID300RepresentationArguments",value:function(e,n){var t=e.data,r=e.metadata,a=e.finding,i=e.findingSites,o=r.referencedImageId;if(!o)throw new Error("ArrowAnnotate.getTID300RepresentationArguments: referencedImageId is not defined");var u=t.handles,s=u.points,c=n(o,u.arrowFirst?s[0]:s[1]),l={points:[{x:c[0],y:c[1]}],trackingIdentifierTextValue:An,findingSites:i||[]};return a&&a.CodeValue===Nn.CORNERSTONEFREETEXT||(a={CodeValue:Nn.CORNERSTONEFREETEXT,CodingSchemeDesignator:qn,CodeMeaning:t.text}),l.finding=a,l}}]),e}();kn.toolType=Pn,kn.utilityToolType=Pn,kn.TID300Representation=En,kn.isValidCornerstoneTrackingIdentifier=function(e){if(!e.includes(":"))return!1;var n=v(e.split(":"),2),t=n[0],r=n[1];return t===hn&&r===Pn},Mn.registerTool(kn);var Vn=r.hC.TID300.Bidirectional,_n="Bidirectional",Gn="".concat(hn,":").concat(_n),Un=function(){function e(){}return e.getMeasurementData=function(n,t,r,a){var i,o=Mn.getSetupMeasurementData(n,t,a,e.toolType),u=o.defaultState,s=o.ReferencedFrameNumber,c=u.annotation.metadata.referencedImageId,l=n.ContentSequence,d=C(l).find((function(e){return"Long Axis"===e.ConceptNameCodeSequence.CodeMeaning})),f=C(d.ContentSequence).find((function(e){return"SCOORD"===e.ValueType})),g=C(l).find((function(e){return"Short Axis"===e.ConceptNameCodeSequence.CodeMeaning})),p=C(g.ContentSequence).find((function(e){return"SCOORD"===e.ValueType})),h=[];[f,p].forEach((function(e){for(var n=e.GraphicData,t=0;t<n.length;t+=2){var a=r(c,[n[t],n[t+1]]);h.push(a)}}));var m=u;return m.annotation.data={handles:{points:[h[0],h[1],h[2],h[3]],activeHandleIndex:0,textBox:{hasMoved:!1}},cachedStats:(i={},i["imageId:".concat(c)]={length:d.MeasuredValueSequence.NumericValue,width:g.MeasuredValueSequence.NumericValue},i),frameNumber:s},m},e.getTID300RepresentationArguments=function(e,n){var t=e.data,r=e.finding,a=e.findingSites,i=e.metadata,o=t.cachedStats,u=void 0===o?{}:o,s=t.handles,c=i.referencedImageId;if(!c)throw new Error("Bidirectional.getTID300RepresentationArguments: referencedImageId is not defined");var l,d,f=u["imageId:".concat(c)]||{},g=f.length,p=f.width,h=s.points,m=[h[0],h[1]],v=[h[2],h[3]];Math.sqrt(Math.pow(m[0][0]-m[1][0],2)+Math.pow(m[0][1]-m[1][1],2)+Math.pow(m[0][2]-m[1][2],2))>Math.sqrt(Math.pow(v[0][0]-v[1][0],2)+Math.pow(v[0][1]-v[1][1],2)+Math.pow(v[0][2]-v[1][2],2))?(l=m,d=v):(l=v,d=m);var S=n(c,l[0]),y=n(c,l[1]),I=n(c,d[0]),T=n(c,d[1]);return{longAxis:{point1:{x:S[0],y:S[1]},point2:{x:y[0],y:y[1]}},shortAxis:{point1:{x:I[0],y:I[1]},point2:{x:T[0],y:T[1]}},longAxisLength:g,shortAxisLength:p,trackingIdentifierTextValue:Gn,finding:r,findingSites:a||[]}},e.toolType=_n,e.utilityToolType=_n,e.TID300Representation=Vn,e.isValidCornerstoneTrackingIdentifier=function(e){if(!e.includes(":"))return!1;var n=e.split(":"),t=n[0],r=n[1];return t===hn&&r===_n},e}();Mn.registerTool(Un);var Ln=r.hC.TID300.CobbAngle,Fn="Angle",Bn="".concat(hn,":").concat(Fn),jn=function(){function e(){}return e.getMeasurementData=function(n,t,r,a){for(var i,o=Mn.getSetupMeasurementData(n,t,a,e.toolType),u=o.defaultState,s=o.NUMGroup,c=o.SCOORDGroup,l=o.ReferencedFrameNumber,d=u.annotation.metadata.referencedImageId,f=c.GraphicData,g=[],p=0;p<f.length;p+=2){var h=r(d,[f[p],f[p+1]]);g.push(h)}var m=u;return m.annotation.data={handles:{points:[g[0],g[1],g[3]],activeHandleIndex:0,textBox:{hasMoved:!1}},cachedStats:(i={},i["imageId:".concat(d)]={angle:s?s.MeasuredValueSequence.NumericValue:null},i),frameNumber:l},m},e.getTID300RepresentationArguments=function(e,n){var t=e.data,r=e.finding,a=e.findingSites,i=e.metadata,o=t.cachedStats,u=void 0===o?{}:o,s=t.handles,c=i.referencedImageId;if(!c)throw new Error("Angle.getTID300RepresentationArguments: referencedImageId is not defined");var l=n(c,s.points[0]),d=n(c,s.points[1]),f=n(c,s.points[2]),g={x:l[0],y:l[1]},p={x:d[0],y:d[1]};return{point1:g,point2:p,point3:p,point4:{x:f[0],y:f[1]},rAngle:(u["imageId:".concat(c)]||{}).angle,trackingIdentifierTextValue:Bn,finding:r,findingSites:a||[]}},e.toolType=Fn,e.utilityToolType=Fn,e.TID300Representation=Ln,e.isValidCornerstoneTrackingIdentifier=function(e){if(!e.includes(":"))return!1;var n=e.split(":"),t=n[0],r=n[1];return t===hn&&r===Fn},e}();Mn.registerTool(jn);var Yn=r.hC.TID300.CobbAngle,zn="CobbAngle",Hn="".concat(hn,":").concat(zn),Xn=function(){function e(){}return e.getMeasurementData=function(n,t,r,a){for(var i,o=Mn.getSetupMeasurementData(n,t,a,e.toolType),u=o.defaultState,s=o.NUMGroup,c=o.SCOORDGroup,l=o.ReferencedFrameNumber,d=u.annotation.metadata.referencedImageId,f=c.GraphicData,g=[],p=0;p<f.length;p+=2){var h=r(d,[f[p],f[p+1]]);g.push(h)}var m=u;return m.annotation.data={handles:{points:[g[0],g[1],g[2],g[3]],activeHandleIndex:0,textBox:{hasMoved:!1}},cachedStats:(i={},i["imageId:".concat(d)]={angle:s?s.MeasuredValueSequence.NumericValue:null},i),frameNumber:l},m},e.getTID300RepresentationArguments=function(e,n){var t=e.data,r=e.finding,a=e.findingSites,i=e.metadata,o=t.cachedStats,u=void 0===o?{}:o,s=t.handles,c=i.referencedImageId;if(!c)throw new Error("CobbAngle.getTID300RepresentationArguments: referencedImageId is not defined");var l=n(c,s.points[0]),d=n(c,s.points[1]),f=n(c,s.points[2]),g=n(c,s.points[3]);return{point1:{x:l[0],y:l[1]},point2:{x:d[0],y:d[1]},point3:{x:f[0],y:f[1]},point4:{x:g[0],y:g[1]},rAngle:(u["imageId:".concat(c)]||{}).angle,trackingIdentifierTextValue:Hn,finding:r,findingSites:a||[]}},e.toolType=zn,e.utilityToolType=zn,e.TID300Representation=Yn,e.isValidCornerstoneTrackingIdentifier=function(e){if(!e.includes(":"))return!1;var n=e.split(":"),t=n[0],r=n[1];return t===hn&&r===zn},e}();function Wn(e){if(!e.includes(":"))return!1;var n=e.split(":"),t=n[0],r=n[1];return t===hn&&r.toLowerCase()===this.toolType.toLowerCase()}Mn.registerTool(Xn);var Jn=r.hC.TID300.Circle,Kn="CircleROI",Qn=function(){function e(){}return e.getMeasurementData=function(n,t,r,a){for(var i,o=Mn.getSetupMeasurementData(n,t,a,e.toolType),u=o.defaultState,s=o.NUMGroup,c=o.SCOORDGroup,l=o.ReferencedFrameNumber,d=u.annotation.metadata.referencedImageId,f=c.GraphicData,g=[],p=0;p<f.length;p+=2){var h=r(d,[f[p],f[p+1]]);g.push(h)}var m=u;return m.annotation.data={handles:{points:pn([],g,!0),activeHandleIndex:0,textBox:{hasMoved:!1}},cachedStats:(i={},i["imageId:".concat(d)]={area:s?s.MeasuredValueSequence.NumericValue:0,radius:0,perimeter:0},i),frameNumber:l},m},e.getTID300RepresentationArguments=function(e,n){var t=e.data,r=e.finding,a=e.findingSites,i=e.metadata,o=t.cachedStats,u=void 0===o?{}:o,s=t.handles,c=i.referencedImageId;if(!c)throw new Error("CircleROI.getTID300RepresentationArguments: referencedImageId is not defined");var l=n(c,s.points[0]),d=n(c,s.points[1]),f=[];f.push({x:l[0],y:l[1]}),f.push({x:d[0],y:d[1]});var g=u["imageId:".concat(c)]||{},p=g.area,h=g.radius;return{area:p,perimeter:2*Math.PI*h,radius:h,points:f,trackingIdentifierTextValue:this.trackingIdentifierTextValue,finding:r,findingSites:a||[]}},e.trackingIdentifierTextValue="".concat(hn,":").concat(Kn),e.toolType=Kn,e.utilityToolType=Kn,e.TID300Representation=Jn,e.isValidCornerstoneTrackingIdentifier=Wn,e}();Mn.registerTool(Qn);var $n=r.hC.TID300.Ellipse,Zn="EllipticalROI",et=1e-4,nt=function(){function e(){}return e.getMeasurementData=function(n,t,r,a){for(var i,o=Mn.getSetupMeasurementData(n,t,a,e.toolType),u=o.defaultState,c=o.NUMGroup,l=o.SCOORDGroup,d=o.ReferencedFrameNumber,f=u.annotation.metadata.referencedImageId,g=l.GraphicData,p=[],h=0;h<g.length;h+=2){var m=r(f,[g[h],g[h+1]]);p.push(m)}var v=s.R3.fromValues.apply(s.R3,p[0]),S=s.R3.fromValues.apply(s.R3,p[1]),y=s.R3.fromValues.apply(s.R3,p[2]),I=s.R3.fromValues.apply(s.R3,p[3]),T=s.R3.create();s.R3.sub(T,S,v),s.R3.normalize(T,T);var D=s.R3.create();s.R3.sub(D,I,y),s.R3.normalize(D,D);var C=a.get("imagePlaneModule",f);if(!C)throw new Error("imageId does not have imagePlaneModule metadata");var O=C.columnCosines,x=s.R3.fromValues(O[0],O[1],O[2]),R=s.R3.dot(x,T),b=s.R3.dot(x,D),w=Math.abs(R),M=Math.abs(b),E=[];Math.abs(w-1)<et?E=[p[0],p[1],p[2],p[3]]:Math.abs(M-1)<et?E=[p[2],p[3],p[0],p[1]]:console.warn("OBLIQUE ELLIPSE NOT YET SUPPORTED");var P=u;return P.annotation.data={handles:{points:pn([],E,!0),activeHandleIndex:0,textBox:{hasMoved:!1}},cachedStats:(i={},i["imageId:".concat(f)]={area:c?c.MeasuredValueSequence.NumericValue:0},i),frameNumber:d},P},e.getTID300RepresentationArguments=function(e,n){var t,r,a,i,o=e.data,u=e.finding,s=e.findingSites,c=e.metadata,l=o.cachedStats,d=void 0===l?{}:l,f=o.handles,g=o.initialRotation||0,p=c.referencedImageId;if(!p)throw new Error("EllipticalROI.getTID300RepresentationArguments: referencedImageId is not defined");90==g||270==g?(r=n(p,f.points[2]),t=n(p,f.points[3]),a=n(p,f.points[0]),i=n(p,f.points[1])):(t=n(p,f.points[0]),r=n(p,f.points[1]),a=n(p,f.points[2]),i=n(p,f.points[3]));var h=[];return Math.abs(t[1]-r[1])>Math.abs(a[0]-i[0])?(h.push({x:t[0],y:t[1]}),h.push({x:r[0],y:r[1]}),h.push({x:a[0],y:a[1]}),h.push({x:i[0],y:i[1]})):(h.push({x:a[0],y:a[1]}),h.push({x:i[0],y:i[1]}),h.push({x:t[0],y:t[1]}),h.push({x:r[0],y:r[1]})),{area:(d["imageId:".concat(p)]||{}).area,points:h,trackingIdentifierTextValue:this.trackingIdentifierTextValue,finding:u,findingSites:s||[]}},e.trackingIdentifierTextValue="".concat(hn,":").concat(Zn),e.toolType=Zn,e.utilityToolType=Zn,e.TID300Representation=$n,e.isValidCornerstoneTrackingIdentifier=Wn,e}();Mn.registerTool(nt);var tt=r.hC.TID300.Polyline,rt="RectangleROI",at="".concat(hn,":").concat(rt),it=function(){function e(){}return e.getMeasurementData=function(n,t,r,a){for(var i,o=Mn.getSetupMeasurementData(n,t,a,e.toolType),u=o.defaultState,s=o.NUMGroup,c=o.SCOORDGroup,l=o.ReferencedFrameNumber,d=u.annotation.metadata.referencedImageId,f=c.GraphicData,g=[],p=0;p<f.length;p+=2){var h=r(d,[f[p],f[p+1]]);g.push(h)}var m=u;return m.annotation.data={handles:{points:[g[0],g[1],g[3],g[2]],activeHandleIndex:0,textBox:{hasMoved:!1}},cachedStats:(i={},i["imageId:".concat(d)]={area:s?s.MeasuredValueSequence.NumericValue:null},i),frameNumber:l},m},e.getTID300RepresentationArguments=function(e,n){var t=e.data,r=e.finding,a=e.findingSites,i=e.metadata,o=t.cachedStats,u=void 0===o?{}:o,s=t.handles,c=i.referencedImageId;if(!c)throw new Error("CobbAngle.getTID300RepresentationArguments: referencedImageId is not defined");var l=s.points.map((function(e){return n(c,e)})),d=u.area,f=u.perimeter;return{points:[l[0],l[1],l[3],l[2],l[0]],area:d,perimeter:f,trackingIdentifierTextValue:at,finding:r,findingSites:a||[]}},e.toolType=rt,e.utilityToolType=rt,e.TID300Representation=tt,e.isValidCornerstoneTrackingIdentifier=function(e){if(!e.includes(":"))return!1;var n=e.split(":"),t=n[0],r=n[1];return t===hn&&r===rt},e}();Mn.registerTool(it);var ot=r.hC.TID300.Length,ut="Length",st="".concat(hn,":").concat(ut),ct=function(){function e(){g(this,e)}return h(e,null,[{key:"getMeasurementData",value:function(n,t,r,a){for(var i=Mn.getSetupMeasurementData(n,t,a,e.toolType),o=i.defaultState,u=i.NUMGroup,s=i.SCOORDGroup,c=i.ReferencedFrameNumber,l=o.annotation.metadata.referencedImageId,d=s.GraphicData,f=[],g=0;g<d.length;g+=2){var p=r(l,[d[g],d[g+1]]);f.push(p)}var h=o;return h.annotation.data={handles:{points:[f[0],f[1]],activeHandleIndex:0,textBox:{hasMoved:!1}},cachedStats:m({},"imageId:".concat(l),{length:u?u.MeasuredValueSequence.NumericValue:0}),frameNumber:c},h}},{key:"getTID300RepresentationArguments",value:function(e,n){var t=e.data,r=e.finding,a=e.findingSites,i=e.metadata,o=t.cachedStats,u=void 0===o?{}:o,s=t.handles,c=i.referencedImageId;if(!c)throw new Error("Length.getTID300RepresentationArguments: referencedImageId is not defined");var l=n(c,s.points[0]),d=n(c,s.points[1]);return{point1:{x:l[0],y:l[1]},point2:{x:d[0],y:d[1]},distance:(u["imageId:".concat(c)]||{}).length,trackingIdentifierTextValue:st,finding:r,findingSites:a||[]}}}]),e}();ct.toolType=ut,ct.utilityToolType=ut,ct.TID300Representation=ot,ct.isValidCornerstoneTrackingIdentifier=function(e){if(!e.includes(":"))return!1;var n=v(e.split(":"),2),t=n[0],r=n[1];return t===hn&&r===ut},Mn.registerTool(ct);var lt=r.hC.TID300.Polyline,dt="PlanarFreehandROI",ft="".concat(hn,":").concat(dt),gt=function(){function e(){}return e.getMeasurementData=function(n,t,r,a){for(var i=Mn.getSetupMeasurementData(n,t,a,e.toolType),o=i.defaultState,u=i.SCOORDGroup,c=i.ReferencedFrameNumber,l=o.annotation.metadata.referencedImageId,d=u.GraphicData,f=[],g=0;g<d.length;g+=2){var p=r(l,[d[g],d[g+1]]);f.push(p)}var h=!0;s.R3.distance(f[f.length-1],f[0])<1e-5&&(f.pop(),h=!1);var m=[];h&&m.push(f[0],f[f.length-1]);var v=o;return v.annotation.data={polyline:f,isOpenContour:h,handles:{points:m,activeHandleIndex:null,textBox:{hasMoved:!1}},frameNumber:c},v},e.getTID300RepresentationArguments=function(e,n){var t=e.data,r=e.finding,a=e.findingSites,i=e.metadata,o=t.isOpenContour,u=t.polyline,s=i.referencedImageId;if(!s)throw new Error("PlanarFreehandROI.getTID300RepresentationArguments: referencedImageId is not defined");var c=u.map((function(e){return n(s,e)}));if(!o){var l=c[0];c.push([l[0],l[1]])}return{points:c,area:0,perimeter:0,trackingIdentifierTextValue:ft,finding:r,findingSites:a||[]}},e.toolType=dt,e.utilityToolType=dt,e.TID300Representation=lt,e.isValidCornerstoneTrackingIdentifier=function(e){if(!e.includes(":"))return!1;var n=e.split(":"),t=n[0],r=n[1];return t===hn&&r===dt},e}();Mn.registerTool(gt);var pt=r.hC.TID300.Point,ht="Probe",mt="".concat(hn,":").concat(ht),vt=function(){function e(){g(this,e)}return h(e,null,[{key:"getMeasurementData",value:function(n,t,r,a){for(var i=Mn.getSetupMeasurementData(n,t,a,e.toolType),o=i.defaultState,u=i.SCOORDGroup,s=i.ReferencedFrameNumber,c=o.annotation.metadata.referencedImageId,l=u.GraphicData,d=[],f=0;f<l.length;f+=2){var g=r(c,[l[f],l[f+1]]);d.push(g)}var p=o;return p.annotation.data={handles:{points:d,activeHandleIndex:null,textBox:{hasMoved:!1}},frameNumber:s},p}},{key:"getTID300RepresentationArguments",value:function(e,n){var t=e.data,r=e.metadata,a=e.finding,i=e.findingSites,o=r.referencedImageId;if(!o)throw new Error("Probe.getTID300RepresentationArguments: referencedImageId is not defined");return{points:t.handles.points.map((function(e){var t=n(o,e);return{x:t[0],y:t[1]}})),trackingIdentifierTextValue:mt,findingSites:i||[],finding:a}}}]),e}();vt.toolType=ht,vt.utilityToolType=ht,vt.TID300Representation=pt,vt.isValidCornerstoneTrackingIdentifier=function(e){if(!e.includes(":"))return!1;var n=v(e.split(":"),2),t=n[0],r=n[1];return t===hn&&r===ht},Mn.registerTool(vt);var St=r.oq.Normalizer,yt=r.U7.Segmentation;var It=fn.Segmentation.generateToolState;var Tt={Bidirectional:Un,CobbAngle:Xn,Angle:jn,Length:ct,CircleROI:Qn,EllipticalROI:nt,RectangleROI:it,ArrowAnnotate:kn,Probe:vt,PlanarFreehandROI:gt,MeasurementReport:Mn,CodeScheme:mn,CORNERSTONE_3D_TAG:hn},Dt={Segmentation:Object.freeze({__proto__:null,generateLabelMaps2DFrom3D:function(e){for(var n=e.scalarData,t=e.dimensions,r=[],a=new Set,i=0;i<t[2];i++){for(var o=n.slice(i*t[0]*t[1],(i+1)*t[0]*t[1]),u=[],s=0;s<o.length;s++){var c=o[s];u.includes(c)||0===c||u.push(c)}var l={segmentsOnLabelmap:u,pixelData:o,rows:t[1],columns:t[0]};0!==u.length&&(u.forEach((function(e){a.add(e)})),r[t[2]-1-i]=l)}return e.segmentsOnLabelmap=Array.from(a),e.labelmaps2D=r,e},generateSegmentation:function(e,n,t,r){return void 0===r&&(r={}),Xe(function(e,n,t){var r=e.map((function(e){var t=n.get("instance",e.imageId);return gn(gn(gn({},e),t),{SOPClassUID:t.SopClassUID||t.SOPClassUID,SOPInstanceUID:t.SopInstanceUID||t.SOPInstanceUID,PixelData:e.getPixelData(),_vrMap:{PixelData:"OW"},_meta:{}})})),a=St.normalizeToDataset(r);return new yt([a],t)}(e,t,r),n,r)},generateToolState:function(e,n,t,r,a){return void 0===r&&(r=!1),void 0===a&&(a=.001),It(e,n,t,r,a)}})},Ct=r.aT.Colors,Ot=r.aT.BitArray;function xt(e){var n=function(e){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:3;switch(n){case 1:return Math.abs(e);case 2:return Math.sqrt(e[0]*e[0]+e[1]*e[1]);case 3:return Math.sqrt(e[0]*e[0]+e[1]*e[1]+e[2]*e[2]);default:for(var t=0,r=0;r<n;r++)t+=e[r]*e[r];return Math.sqrt(t)}}(e);return 0!==n&&(e[0]/=n,e[1]/=n,e[2]/=n),n}var Rt={Cornerstone:dn,Cornerstone3D:Tt},bt={Cornerstone:fn,Cornerstone3D:Dt,VTKjs:{Segmentation:function(){function e(){g(this,e)}return h(e,null,[{key:"generateSegments",value:function(e){"Array"!==e.SegmentSequence.constructor.name&&(e.SegmentSequence=[e.SegmentSequence]),e.SegmentSequence.forEach((function(e){var n,t,r=(n=e.RecommendedDisplayCIELabValue,(t=Ct.dicomlab2RGB(n).map((function(e){return Math.round(255*e)}))).push(255),t);segments[e.SegmentNumber]={color:r,functionalGroups:[],offset:null,size:null,pixelData:null}})),e.PerFrameFunctionalGroupsSequence.forEach((function(e){var n=e.SegmentIdentificationSequence.ReferencedSegmentNumber;segments[n].functionalGroups.push(e)}));var n=Math.ceil(e.Rows*e.Columns/8),t=0;return Object.keys(segments).forEach((function(r){var a=segments[r];a.numberOfFrames=a.functionalGroups.length,a.size=a.numberOfFrames*n,a.offset=t,t=a.offset+a.size;var i=e.PixelData.slice(a.offset,t);a.pixelData=Ot.unpack(i);var o=function(e,n){var t={},r=e.SharedFunctionalGroupsSequence.PixelMeasuresSequence,a=e.SharedFunctionalGroupsSequence.PlaneOrientationSequence,i=n[0],o=n[n.length-1],u=i.PlanePositionSequence.ImagePositionPatient.map(Number),s=o.PlanePositionSequence.ImagePositionPatient.map(Number);t.origin=u,t.spacing=[r.PixelSpacing[1],r.PixelSpacing[0],r.SpacingBetweenSlices].map(Number),t.dimensions=[e.Columns,e.Rows,n.length].map(Number);var c,l,d,f,g,p,h=a.ImageOrientationPatient.map(Number),m=h.slice(0,3),v=h.slice(3,6);return t.planeNormal=[],c=m,l=v,d=t.planeNormal,f=c[1]*l[2]-c[2]*l[1],g=c[2]*l[0]-c[0]*l[2],p=c[0]*l[1]-c[1]*l[0],d[0]=f,d[1]=g,d[2]=p,t.sliceStep=[],function(e,n,t){t[0]=e[0]-n[0],t[1]=e[1]-n[1],t[2]=e[2]-n[2]}(s,u,t.sliceStep),xt(t.sliceStep),t.direction=m.concat(v).concat(t.sliceStep),t}(e,a.functionalGroups);a.geometry=o})),segments}}]),e}()}}}}]);
//# sourceMappingURL=154.bundle.c626fdd3972b8ddb508b.js.map