"use strict";(globalThis.webpackChunk=globalThis.webpackChunk||[]).push([[710,579],{39042:(e,t,n)=>{n.r(t),n.d(t,{default:()=>oe});const a=JSON.parse('{"u2":"@ohif/extension-cornerstone-dicom-seg"}').u2,o=`${a}.sopClassHandlerModule.dicom-seg`;var i=n(43001),r=n(71771),s=n(56388),c=n(80135),l=n(6154),d=n(67540);const g=["1.2.840.10008.5.1.4.1.1.66.4"];let S={};function m(e,t,n){const a=e[0],{StudyInstanceUID:i,SeriesInstanceUID:m,SOPInstanceUID:u,SeriesDescription:p,SeriesNumber:E,SeriesDate:v,SOPClassUID:h,wadoRoot:I,wadoUri:y,wadoUriRoot:T}=a,D={Modality:"SEG",loading:!1,isReconstructable:!0,displaySetInstanceUID:r.utils.guid(),SeriesDescription:p,SeriesNumber:E,SeriesDate:v,SOPInstanceUID:u,SeriesInstanceUID:m,StudyInstanceUID:i,SOPClassHandlerId:o,SOPClassUID:h,referencedImages:null,referencedSeriesInstanceUID:null,referencedDisplaySetInstanceUID:null,isDerivedDisplaySet:!0,isLoaded:!1,isHydrated:!1,segments:{},sopClassUids:g,instance:a,instances:[a],wadoRoot:I,wadoUriRoot:T,wadoUri:y,isOverlayDisplaySet:!0},f=a.ReferencedSeriesSequence;if(!f)return void console.error("ReferencedSeriesSequence is missing for the SEG");const b=f[0]||f;return D.referencedImages=a.ReferencedSeriesSequence.ReferencedInstanceSequence,D.referencedSeriesInstanceUID=b.SeriesInstanceUID,D.getReferenceDisplaySet=()=>{const{displaySetService:e}=t.services,n=e.getDisplaySetsForSeries(D.referencedSeriesInstanceUID);if(!n||0===n.length)throw new Error("Referenced DisplaySet is missing for the SEG");const a=n[0];D.referencedDisplaySetInstanceUID=a.displaySetInstanceUID,D.referencedVolumeURI=a.displaySetInstanceUID;const o=`cornerstoneStreamingImageVolume:${D.referencedVolumeURI}`;return D.referencedVolumeId=o,a},D.load=async({headers:e})=>await function(e,t,n,a){const{SOPInstanceUID:o}=e,{segmentationService:i}=t.services;if((e.loading||e.isLoaded)&&S[o]&&function(e,t){return t.getSegmentation(e.displaySetInstanceUID)}(e,i))return S[o];return e.loading=!0,S[o]=new Promise((async(o,r)=>{e.segments&&0!==Object.keys(e.segments).length||await async function({extensionManager:e,servicesManager:t,segDisplaySet:n,headers:a}){const o=e.getModuleEntry("@ohif/extension-cornerstone.utilityModule.common"),{segmentationService:i,uiNotificationService:r,displaySetService:g}=t.services,{dicomLoaderService:S}=o.exports,m=await S.findDicomDataPromise(n,null,a),u=g.getDisplaySetByUID(n.referencedDisplaySetInstanceUID);let p;if(u.isReconstructable){const e=s.cache.getVolume(n.referencedVolumeId);p=e.imageIds||e._imageIds}else p=u.instances.map((e=>e.imageId));const E=.001,v=!0;s.eventTarget.addEventListener(l.Y.Events.SEGMENTATION_LOAD_PROGRESS,(e=>{const{percentComplete:t}=e.detail;i._broadcastEvent(i.EVENTS.SEGMENT_LOADING_COMPLETE,{percentComplete:t})}));const h=await l.adaptersSEG.Cornerstone3D.Segmentation.generateToolState(p,m,s.metaData,{skipOverlapping:v,tolerance:E,eventTarget:s.eventTarget,triggerEvent:s.triggerEvent});let I=!0;h.segMetadata.data.forEach(((e,t)=>{var n;t>0&&(e.rgba=e.RecommendedDisplayCIELabValue,e.rgba?e.rgba=(n=e.rgba,d.default.data.Colors.dicomlab2RGB(n).map((e=>Math.round(255*e)))):(I=!1,e.rgba=c.CONSTANTS.COLOR_LUT[t%c.CONSTANTS.COLOR_LUT.length]))})),Object.assign(n,h)}({extensionManager:n,servicesManager:t,segDisplaySet:e,headers:a});const g=!0;i.createSegmentationForSEGDisplaySet(e,null,g).then((()=>{e.loading=!1,o()})).catch((t=>{e.loading=!1,r(t)}))})),S[o]}(D,t,n,e),[D]}const u=function({servicesManager:e,extensionManager:t}){return[{name:"dicom-seg",sopClassUids:g,getDisplaySetsFromSeries:n=>m(n,e,t)}]},p={id:"@ohif/seg",name:"Segmentations",protocolMatchingRules:[],toolGroupIds:["default"],numberOfPriorsReferenced:0,defaultViewport:{viewportOptions:{viewportType:"stack",toolGroupId:"default",allowUnmatchedView:!0},displaySets:[{id:"segDisplaySetId",matchedDisplaySetsIndex:-1}]},displaySetSelectors:{segDisplaySetId:{seriesMatchingRules:[{attribute:"Modality",constraint:{equals:"SEG"}}]}},stages:[{name:"Segmentations",viewportStructure:{layoutType:"grid",properties:{rows:1,columns:1}},viewports:[{viewportOptions:{allowUnmatchedView:!0},displaySets:[{id:"segDisplaySetId"}]}]}]};const E=function(){return[{name:p.id,protocol:p}]};var v=n(62657),h=n(78738),I=n(3827),y=n.n(I),T=n(95303);const D=function(e,t,n){const a="enter-segment-label",o=({action:t,value:o})=>{switch(t.id){case"save":n(o.label,t.id);break;case"cancel":n("",t.id)}e.dismiss({id:a})};e&&e.create({id:a,centralize:!0,isDraggable:!1,showOverlay:!0,content:T.Vq,contentProps:{title:"Segment",value:{label:t},noCloseButton:!0,onClose:()=>e.dismiss({id:a}),actions:[{id:"cancel",text:"Cancel",type:T.LZ.dt.secondary},{id:"save",text:"Confirm",type:T.LZ.dt.primary}],onSubmit:o,body:({value:e,setValue:t})=>i.createElement(T.II,{label:"Enter the segment label",labelClassName:"text-white text-[14px] leading-[1.2]",autoFocus:!0,className:"border-primary-main bg-black",type:"text",value:e.label,onChange:e=>{e.persist(),t((t=>({...t,label:e.target.value})))},onKeyPress:t=>{"Enter"===t.key&&o({value:e,action:{id:"save"}})}})}})};var f=n(22831);const b=function(e,t,n){const a="pick-color",o=({action:t,value:o})=>{switch(t.id){case"save":n(o.rgbaColor,t.id);break;case"cancel":n("",t.id)}e.dismiss({id:a})};e&&e.create({id:a,centralize:!0,isDraggable:!1,showOverlay:!0,content:T.Vq,contentProps:{title:"Segment Color",value:{rgbaColor:t},noCloseButton:!0,onClose:()=>e.dismiss({id:a}),actions:[{id:"cancel",text:"Cancel",type:"primary"},{id:"save",text:"Save",type:"secondary"}],onSubmit:o,body:({value:e,setValue:t})=>i.createElement(f.AI,{color:e.rgbaColor,onChange:e=>{t({rgbaColor:e.rgb})},presetColors:[],width:300})}})};var R=n(69190);const C=e=>(e.label.includes("Vessel")?"Vessel":"Segment")+" "+(e.segments.filter((e=>e)).length+1);function w(e,t){return e.map((e=>{const n=t.getDisplaySetByUID(e.displaySetInstanceUID);let a;a="SEG"===n.Modality?t.getDisplaySetByUID(n.referencedDisplaySetInstanceUID):n;const{ViewPosition:o,ImageLaterality:i}=a.instance;return{...e,...i&&o&&{label:e.label.replace(/^.* - Vessel/,`${i} ${o} - Vessel`)}}}))}const O=(e,t)=>({...e,...t.payload}),U="notifications-success",A="notifications-warning",M="notifications-error";function L({servicesManager:e,commandsManager:t,extensionManager:n,configuration:a}){const{segmentationService:o,viewportGridService:r,uiDialogService:s,displaySetService:c,userAuthenticationService:l,CropDisplayAreaService:d}=e.services,{t:g}=(0,R.$G)("PanelSegmentation"),[S,m]=(0,i.useState)(null),[u,p]=(0,i.useState)(o.getConfiguration()),[E,v]=(0,i.useState)((()=>w(o.getSegmentations(),c))),[I,y]=(0,i.useReducer)(O,{});(0,i.useEffect)((()=>{const e=o.EVENTS.SEGMENTATION_ADDED,t=o.EVENTS.SEGMENTATION_UPDATED,n=o.EVENTS.SEGMENTATION_REMOVED,a=[];return[e,t,n].forEach((e=>{const{unsubscribe:t}=o.subscribe(e,(()=>{const e=w(o.getSegmentations(),c);v(e),p(o.getConfiguration())}));a.push(t)})),()=>{a.forEach((e=>{e()}))}}),[]),(0,i.useEffect)((()=>{let a,i=[];const{unsubscribe:r}=o.subscribe(o.EVENTS.SEGMENTATION_DATA_MODIFIED,(({segmentation:o})=>{clearTimeout(a),y({payload:{[o.id]:A}}),i.find((e=>e.id===o.id))||i.push(o),a=setTimeout((()=>{const a=n.getActiveDataSource(),o=i.map((n=>(0,h.createReportAsync)({servicesManager:e,getReport:()=>t.runCommand("storeSegmentation",{segmentationId:n.id,dataSource:a[0],skipLabelDialog:!0}),reportType:"Segmentation",showLoadingModal:!1,throwErrors:!0})));Promise.allSettled(o).then((e=>{const t=e.reduce(((e,t,n)=>(t.value&&(i[n].displaySetInstanceUID=t.value[0],c.getDisplaySetByUID(t.value[0])?.getReferenceDisplaySet()),{...e,[i[n].id]:"fulfilled"===t.status?U:M})),{});y({payload:t});const n=Object.keys(t).filter((e=>t[e]===U));i=i.filter((e=>!n.includes(e.id)))}))}),5e3)}));return()=>{r()}}),[]);const f=e=>{L(e);const t=E.find((t=>t.id===e))?.isActive;t||o.setActiveSegmentationForToolGroup(e)},L=e=>{const t=c.getDisplaySetByUID(e);if(!t)return;const n=t.referencedDisplaySetInstanceUID,{viewports:a,activeViewportId:o}=r.getState();let i=!1;a.forEach((e=>{e.displaySetInstanceUIDs.includes(n)&&(i=!0)})),i||r.setDisplaySetsForViewport({viewportId:o,displaySetInstanceUIDs:[n]})},V=e=>o.getToolGroupIdsWithSegmentation(e),_=(0,i.useCallback)(((e,t,n)=>{o.setConfiguration({segmentationId:e,[t]:n})}),[o]);return i.createElement(i.Fragment,null,i.createElement("div",{className:"ohif-scrollbar flex min-h-0 flex-auto select-none flex-col justify-between overflow-auto"},i.createElement(T.cX,{title:g("Segmentations"),segmentations:E,savedStatusStates:I,disableEditing:a.disableEditing,activeSegmentationId:S||"",onSegmentationAdd:async()=>{t.runCommand("createEmptySegmentationForViewport")},onSegmentationClick:e=>{L(e),o.setActiveSegmentationForToolGroup(e)},onSegmentationDelete:e=>{f(e),o.remove(e)},onSegmentationDownload:e=>{f(e),t.runCommand("downloadSegmentation",{segmentationId:e})},onSegmentationDownloadRTSS:e=>{f(e),t.runCommand("downloadRTSS",{segmentationId:e})},storeSegmentation:async a=>{f(a);const i=n.getActiveDataSource();let s;try{s=await(0,h.createReportAsync)({servicesManager:e,getReport:()=>t.runCommand("storeSegmentation",{segmentationId:a,dataSource:i[0]}),reportType:"Segmentation",throwErrors:!0}),y({payload:{[a]:U}})}catch(e){console.warn(e.message),y({payload:{[a]:M}})}s&&(o.remove(a),r.setDisplaySetsForViewport({viewportId:r.getActiveViewportId(),displaySetInstanceUIDs:s}))},onSegmentationEdit:e=>{f(e);const t=o.getSegmentation(e),{label:n}=t;D(s,n,((t,n)=>{""!==t&&o.addOrUpdateSegmentation({id:e,label:t},!1,!0)}))},onSegmentClick:(e,t)=>{L(e),o.setActiveSegment(e,t);V(e).forEach((n=>{o.setActiveSegmentationForToolGroup(e,n),o.jumpToSegmentCenter(e,t,n)}))},onSegmentEdit:(e,t)=>{f(e);const n=o.getSegmentation(e).segments[t],{label:a}=n;D(s,a,((n,a)=>{""!==n&&o.setSegmentLabel(e,t,n)}))},onSegmentAdd:e=>{f(e);const t=C(E.find((t=>t.id===e)));o.addSegment(e,{properties:{label:t}})},onSegmentColorClick:(e,t)=>{f(e);const n=o.getSegmentation(e).segments[t],{color:a,opacity:i}=n,r={r:a[0],g:a[1],b:a[2],a:i/255};b(s,r,((n,a)=>{"cancel"!==a&&o.setSegmentRGBAColor(e,t,[n.r,n.g,n.b,255*n.a])}))},onSegmentDelete:(e,t)=>{f(e),o.removeSegment(e,t)},onToggleSegmentVisibility:(e,t)=>{f(e);const n=!o.getSegmentation(e).segments[t].isVisible;V(e).forEach((a=>{o.setSegmentVisibility(e,t,n,a)}))},onToggleSegmentLock:(e,t)=>{f(e),o.toggleSegmentLocked(e,t)},onToggleSegmentationVisibility:e=>{f(e),o.toggleSegmentationVisibility(e)},showDeleteSegment:!0,segmentationConfig:{initialConfig:u},setRenderOutline:e=>_(S,"renderOutline",e),setOutlineOpacityActive:e=>_(S,"outlineOpacity",e),setRenderFill:e=>_(S,"renderFill",e),setRenderInactiveSegmentations:e=>_(S,"renderInactiveSegmentations",e),setOutlineWidthActive:e=>_(S,"outlineWidthActive",e),setFillAlpha:e=>_(S,"fillAlpha",e),setFillAlphaInactive:e=>_(S,"fillAlphaInactive",e),CropDisplayAreaService:d})))}L.propTypes={commandsManager:y().shape({runCommand:y().func.isRequired}),servicesManager:y().shape({services:y().shape({segmentationService:y().shape({getSegmentation:y().func.isRequired,getSegmentations:y().func.isRequired,toggleSegmentationVisibility:y().func.isRequired,subscribe:y().func.isRequired,EVENTS:y().object.isRequired}).isRequired}).isRequired}).isRequired};const{segmentation:V}=c.utilities,_={CIRCULAR_BRUSH:"CircularBrush",SPHERE_BRUSH:"SphereBrush",CIRCULAR_ERASER:"CircularEraser",SPHERE_ERASER:"SphereEraser",CIRCLE_SHAPE:"CircleScissor",RECTANGLE_SHAPE:"RectangleScissor",SPHERE_SHAPE:"SphereScissor",THRESHOLD_CIRCULAR_BRUSH:"ThresholdCircularBrush",THRESHOLD_SPHERE_BRUSH:"ThresholdSphereBrush"},N={SET_TOOL_CONFIG:"SET_TOOL_CONFIG",SET_ACTIVE_TOOL:"SET_ACTIVE_TOOL"},B={Brush:{brushSize:2,mode:"CircularBrush"},Eraser:{brushSize:2,mode:"CircularEraser"},Shapes:{brushSize:15,mode:"CircleScissor"},ThresholdBrush:{brushSize:15,thresholdRange:[-500,500]},activeTool:null};function P(e,t){switch(t.type){case N.SET_TOOL_CONFIG:const{tool:n,config:a}=t.payload;return{...e,[n]:{...e[n],...a}};case N.SET_ACTIVE_TOOL:return{...e,activeTool:t.payload};default:return e}}function F(e){let t=[];switch(e){case"Brush":t=["CircularBrush","SphereBrush"];break;case"Eraser":t=["CircularEraser","SphereEraser"];break;case"ThresholdBrush":t=["ThresholdCircularBrush","ThresholdSphereBrush"]}return t}function G(e){const{viewportGridService:t,cornerstoneViewportService:n}=e.services,{activeViewportId:a}=t.getState(),o=n.getCornerstoneViewport(a),i=o?.getImageData();if(!i)return;const{spacing:r}=i;return Math.max(r[0],r[1])}const H=function({servicesManager:e,extensionManager:t}){const{toolbarService:n,segmentationService:a,toolGroupService:o}=e.services,[r]=(0,T.O_)(),{viewports:c,activeViewportId:l}=r,[d,g]=(0,i.useState)(!1),[S,m]=(0,i.useReducer)(P,B),[u,p]=(0,i.useState)({min:2,max:3,step:.01}),E=(0,i.useCallback)((()=>{if(!c?.size||void 0===l)return;const e=c.get(l);e&&m({type:N.SET_ACTIVE_TOOL,payload:o.getActiveToolForViewport(e.viewportId)})}),[l,c,o,m]),v=(0,i.useCallback)((e=>{n.recordInteraction({interactionType:"tool",commands:[{commandName:"setToolActive",commandOptions:{toolName:e}}]}),m({type:N.SET_ACTIVE_TOOL,payload:e})}),[n,m]),h=()=>{const t=new URLSearchParams(window.location.search),n=+t.get("defaultBrushSize")||2;let a=+t.get("minBrushSize")||2,o=+t.get("maxBrushSize")||3;const i=G(e),r=i/2;a<r&&(a=r),o<r&&(o=i),p({min:+a.toFixed(2),max:+o.toFixed(2),step:+((o-a)/100).toFixed(2)}),["Brush","Eraser"].forEach((e=>{y(n,e)}))};(0,i.useEffect)((()=>{if(G(e))return void h();const n=e=>{const t=()=>{h(),e.detail.element.removeEventListener(s.EVENTS.VOLUME_VIEWPORT_NEW_VOLUME,t),s.eventTarget.removeEventListener(s.EVENTS.STACK_VIEWPORT_NEW_STACK,t)};e.detail.element.addEventListener(s.EVENTS.VOLUME_VIEWPORT_NEW_VOLUME,t),s.eventTarget.addEventListener(s.EVENTS.STACK_VIEWPORT_NEW_STACK,t),s.eventTarget.removeEventListener(s.EVENTS.ELEMENT_ENABLED,n)},a=function(e,t){const n=t.getModuleEntry("@ohif/extension-cornerstone.utilityModule.common"),{getEnabledElement:a}=n.exports,{viewportGridService:o}=e.services,{activeViewportId:i}=o.getState(),{element:r}=a(i)||{};return r}(e,t);a?n({detail:{element:a}}):s.eventTarget.addEventListener(s.EVENTS.ELEMENT_ENABLED,n)}),[]),(0,i.useEffect)((()=>{const e=[a.EVENTS.SEGMENTATION_ADDED,a.EVENTS.SEGMENTATION_UPDATED,a.EVENTS.SEGMENTATION_REMOVED],t=[];return e.forEach((e=>{const{unsubscribe:n}=a.subscribe(e,(()=>{const e=a.getSegmentations(),t=e?.find((e=>e.isActive));g(t?.segmentCount>0)}));t.push(n)})),E(),()=>{t.forEach((e=>e()))}}),[l,c,a,E]),(0,i.useEffect)((()=>{const{unsubscribe:e}=n.subscribe(n.EVENTS.TOOL_BAR_STATE_MODIFIED,(()=>{E()}));return()=>{e()}}),[n,E]),(0,i.useEffect)((()=>{Object.values(_).includes(S.activeTool)&&(d||v("WindowLevel"))}),[d,S.activeTool,v]);const I=(0,i.useCallback)(((e,t)=>{o.getToolGroupIds()?.forEach((n=>{V.setBrushSizeForToolGroup(n,t,e)}))}),[o]),y=(0,i.useCallback)(((e,t)=>{const n=Number(e);F(t).forEach((e=>{I(e,n)})),m({type:N.SET_TOOL_CONFIG,payload:{tool:t,config:{brushSize:n}}})}),[o,m]),D=(0,i.useCallback)((e=>{if(e[0]===S.ThresholdBrush.thresholdRange[0]&&e[1]===S.ThresholdBrush.thresholdRange[1])return;F("ThresholdBrush").forEach((t=>{o.getToolGroupIds()?.forEach((n=>{o.getToolGroup(n).setToolConfiguration(t,{strategySpecificConfiguration:{THRESHOLD_INSIDE_CIRCLE:{threshold:e}}})}))})),m({type:N.SET_TOOL_CONFIG,payload:{tool:"ThresholdBrush",config:{thresholdRange:e}}})}),[o,m,S.ThresholdBrush.thresholdRange]);return i.createElement(T.bY,{title:"Segmentation Tools",items:[{name:"Brush",icon:"icon-tool-brush",disabled:!d,active:S.activeTool===_.CIRCULAR_BRUSH||S.activeTool===_.SPHERE_BRUSH,onClick:()=>v(_.CIRCULAR_BRUSH),options:[{name:"Radius (mm)",id:"brush-radius",type:"range",min:u.min,max:u.max,value:S.Brush.brushSize,step:u.step,onChange:e=>y(e,"Brush")},{name:"Mode",type:"radio",id:"brush-mode",value:S.Brush.mode,values:[{value:_.CIRCULAR_BRUSH,label:"Circle"},{value:_.SPHERE_BRUSH,label:"Sphere"}],onChange:e=>v(e)}]},{name:"Eraser",icon:"icon-tool-eraser",disabled:!d,active:S.activeTool===_.CIRCULAR_ERASER||S.activeTool===_.SPHERE_ERASER,onClick:()=>v(_.CIRCULAR_ERASER),options:[{name:"Radius (mm)",type:"range",id:"eraser-radius",min:u.min,max:u.max,value:S.Eraser.brushSize,step:u.step,onChange:e=>y(e,"Eraser")},{name:"Mode",type:"radio",id:"eraser-mode",value:S.Eraser.mode,values:[{value:_.CIRCULAR_ERASER,label:"Circle"},{value:_.SPHERE_ERASER,label:"Sphere"}],onChange:e=>v(e)}]},{name:"Shapes",icon:"icon-tool-shape",disabled:!d,active:S.activeTool===_.CIRCLE_SHAPE||S.activeTool===_.RECTANGLE_SHAPE||S.activeTool===_.SPHERE_SHAPE,onClick:()=>v(_.CIRCLE_SHAPE),options:[{name:"Mode",type:"radio",value:S.Shapes.mode,id:"shape-mode",values:[{value:_.CIRCLE_SHAPE,label:"Circle"},{value:_.RECTANGLE_SHAPE,label:"Rectangle"},{value:_.SPHERE_SHAPE,label:"Sphere"}],onChange:e=>v(e)}]},{name:"Threshold Tool",icon:"icon-tool-threshold",disabled:!d,active:S.activeTool===_.THRESHOLD_CIRCULAR_BRUSH||S.activeTool===_.THRESHOLD_SPHERE_BRUSH,onClick:()=>v(_.THRESHOLD_CIRCULAR_BRUSH),options:[{name:"Radius (mm)",id:"threshold-radius",type:"range",min:.5,max:99.5,value:S.ThresholdBrush.brushSize,step:.5,onChange:e=>y(e,"ThresholdBrush")},{name:"Mode",type:"radio",id:"threshold-mode",value:S.activeTool,values:[{value:_.THRESHOLD_CIRCULAR_BRUSH,label:"Circle"},{value:_.THRESHOLD_SPHERE_BRUSH,label:"Sphere"}],onChange:e=>v(e)},{type:"custom",id:"segmentation-threshold-range",children:()=>i.createElement("div",null,i.createElement("div",{className:"bg-secondary-light h-[1px]"}),i.createElement("div",{className:"mt-1 text-[13px] text-white"},"Threshold"),i.createElement(T.R0,{values:S.ThresholdBrush.thresholdRange,onChange:D,minValue:-1e3,maxValue:1e3,step:1,showLabel:!0,allowNumberEdit:!0,showAdjustmentArrows:!1}))}]}]})},x=({commandsManager:e,servicesManager:t,extensionManager:n,configuration:a})=>{const{customizationService:o}=t.services;return[{name:"panelSegmentation",iconName:"tab-segmentation",iconLabel:"Segmentation",label:"Segmentation",component:a=>{const[r]=(0,v.M)(),s=o.get("segmentation.disableEditing");return i.createElement(L,{commandsManager:e,servicesManager:t,extensionManager:n,configuration:{...a,disableEditing:r.disableEditing||s?.value}})}},{name:"panelSegmentationWithTools",iconName:"tab-segmentation",iconLabel:"Segmentation",label:"Segmentation",component:a=>{const[o]=(0,v.M)();return i.createElement(i.Fragment,null,i.createElement(H,{commandsManager:e,servicesManager:t,extensionManager:n,configuration:{...a}}),i.createElement(L,{commandsManager:e,servicesManager:t,extensionManager:n,configuration:{...a}}))}}]};var k=n(96538),q=n(54131),z=n(96372);async function W({viewportId:e,loadFn:t,servicesManager:n,referencedDisplaySetInstanceUID:a}){const{cornerstoneViewportService:o,segmentationService:i,viewportGridService:r,displaySetService:c}=n.services,l=j({viewportId:e,viewportGridService:r}),d=l.viewportOptions.viewportId,g=K({servicesManager:n,viewportId:e,referencedDisplaySetInstanceUID:a=a||l?.displaySetInstanceUIDs[0]}),S=async()=>{const e=await t();i.hydrateSegmentation(e)},m=Array.from(s.cache._volumeCache.keys()).some((e=>e.includes(a))),u=c.getDisplaySetByUID(a);return g.forEach((async e=>{e.viewportOptions={...e.viewportOptions,viewportType:u.isReconstructable?"volume":"stack",needsRerendering:!0};const t=e.viewportId,n=o.getCornerstoneViewport(t),i=n.getCamera();if(m&&t===d)return void await S();const r=u.isReconstructable?s.Enums.Events.VOLUME_VIEWPORT_NEW_VOLUME:s.Enums.Events.STACK_VIEWPORT_NEW_STACK,c=u.isReconstructable?n.element:s.eventTarget,l=async e=>{const n=e.detail.volumeActors?.find((e=>e.uid.includes(a)));o.getCornerstoneViewport(t).setCamera(i),c.removeEventListener(r,l),u.isReconstructable&&!n||t===d&&await S()};c.addEventListener(r,l)})),r.setDisplaySetsForViewports(g),!0}const j=({viewportId:e,viewportGridService:t})=>{const{viewports:n,activeViewportId:a}=t.getState(),o=e||a;return n.get(o)};function K({viewportId:e,servicesManager:t,referencedDisplaySetInstanceUID:n}){const{hangingProtocolService:a,displaySetService:o,segmentationService:i,viewportGridService:r}=t.services,{viewports:s}=r.getState(),c=j({viewportId:e,viewportGridService:r}).viewportOptions.viewportId,l=s.get(c).displaySetInstanceUIDs,d=n||l[0],g=o.getDisplaySetByUID(d).instances[0].FrameOfReferenceUID,S=a.getViewportsRequireUpdate(c,d);return s.forEach(((e,t)=>{if(c===t||S.find((e=>e.viewportId===t)))return;i.shouldRenderSegmentation(e.displaySetInstanceUIDs,g)&&S.push({viewportId:t,displaySetInstanceUIDs:e.displaySetInstanceUIDs,viewportOptions:{viewportType:e.viewportType,needsRerendering:!0}})})),S}const $=e=>{const t=[],n=[],a=new Set;Array.from(e.entries()).forEach(((e,o)=>{n.push(s.cache.getImage(e[0]));const i=s.cache.getImage(e[1]),{rows:r,columns:c}=i,l=i.getPixelData(),d=[];for(let e=0;e<l.length;e++){const t=l[e];d.includes(t)||0===t||d.push(t)}d.length||d.push(1),t[o]={segmentsOnLabelmap:d,pixelData:l,rows:r,columns:c},d.forEach((e=>{a.add(e)}))}));const o={segmentsOnLabelmap:Array.from(a),labelmaps2D:t};return{referencedImages:n,labelmapObj:o}},{datasetToBlob:Z}=d.default.data,{Cornerstone3D:{Segmentation:{generateLabelMaps2DFrom3D:J,generateSegmentation:Y}}}=l.adaptersSEG,{Cornerstone3D:{RTSS:{generateRTSSFromSegmentations:X}}}=l.adaptersRT,{downloadDICOMData:Q}=l.helpers,ee=({servicesManager:e,extensionManager:t})=>{const{uiNotificationService:n,segmentationService:a,uiDialogService:o,displaySetService:i,viewportGridService:l}=e.services,g={getUpdatedViewportsForSegmentation:K,createEmptySegmentationForViewport:async({viewportId:t})=>{const n=j({viewportId:t,viewportGridService:l}),o=n.displaySetInstanceUIDs[0];W({viewportId:t,servicesManager:e,loadFn:async()=>{const e=a.getSegmentations(),t=await a.createSegmentationForDisplaySet(o,{label:`Segmentation ${e.length+1}`}),i=n.viewportOptions.toolGroupId;return await a.addSegmentationRepresentationToToolGroup(i,t),a.addSegment(t,{toolGroupId:i,segmentIndex:1,properties:{label:C(a.getSegmentation(t))}}),t}})},loadSegmentationsForViewport:async({segmentations:t,viewportId:n})=>{W({viewportId:n,servicesManager:e,loadFn:async()=>{const e=j({viewportId:n,viewportGridService:l}),o=e.displaySetInstanceUIDs[0],i=t[0],r=i.id,s=i.label,c=i.segments;if(delete i.segments,await a.createSegmentationForDisplaySet(o,{segmentationId:r,label:s}),i.scalarData){a.getLabelmapVolume(r).scalarData.set(i.scalarData)}a.addOrUpdateSegmentation(i);const d=e.viewportOptions.toolGroupId;return await a.addSegmentationRepresentationToToolGroup(d,r),c.forEach((e=>{null!==e&&a.addSegment(r,{segmentIndex:e.segmentIndex,toolGroupId:d,properties:{color:e.color,label:e.label,opacity:e.opacity,isLocked:e.isLocked,visibility:e.isVisible,active:i.activeSegmentIndex===e.segmentIndex}})})),i.centroidsIJK&&a.setCentroids(i.id,i.centroidsIJK),r}})},loadSegmentationDisplaySetsForViewport:async({viewportId:t,displaySets:n})=>{const o=n[0];W({viewportId:t,servicesManager:e,referencedDisplaySetInstanceUID:o.referencedDisplaySetInstanceUID,loadFn:async()=>{const e=o,t="SEG"===e.Modality?"createSegmentationForSEGDisplaySet":"createSegmentationForRTDisplaySet",n=a[t].bind(a);return await n(e,null,!1)}})},generateSegmentation:({segmentationId:e,options:t={}})=>{const n=c.segmentation.state.getSegmentation(e),o=n.representationData.LABELMAP;let i,r;if(n.representationData.LABELMAP.referencedVolumeId){const{referencedVolumeId:t}=o,n=s.cache.getVolume(e);i=s.cache.getVolume(t).getCornerstoneImages(),r=J(n)}else{const{imageIdReferenceMap:e}=o;({referencedImages:i,labelmapObj:r}=$(e))}r.metadata=[];const l=a.getSegmentation(e);r.segmentsOnLabelmap.forEach((e=>{const t=l?.segments[e],{label:n,color:a}=t,o=d.default.data.Colors.rgb2DICOMLAB(a.slice(0,3).map((e=>e/255))).map((e=>Math.round(e))),i={SegmentNumber:e.toString(),SegmentLabel:n,SegmentAlgorithmType:"MANUAL",SegmentAlgorithmName:"OHIF Brush",RecommendedDisplayCIELabValue:o,SegmentedPropertyCategoryCodeSequence:{CodeValue:"T-D0050",CodingSchemeDesignator:"SRT",CodeMeaning:"Tissue"},SegmentedPropertyTypeCodeSequence:{CodeValue:"T-D0050",CodingSchemeDesignator:"SRT",CodeMeaning:"Tissue"}};r.metadata[e]=i}));return Y(i,r,s.metaData,t)},downloadSegmentation:({segmentationId:e})=>{const t=a.getSegmentation(e),n=g.generateSegmentation({segmentationId:e});Q(n.dataset,`${t.label}`)},storeSegmentation:async({segmentationId:e,dataSource:n,skipLabelDialog:r=!1})=>{const s=a.getSegmentation(e);if(!s)throw new Error("No segmentation found");const{label:c,displaySetInstanceUID:l}=s,d=i.getDisplaySetByUID(l),S=d&&"SEG"===d.Modality;let m={};if(!r&&!S&&(m=await(0,h.createReportDialogPrompt)(o,{extensionManager:t}),1!==m.action&&!m.value))return;const u=m.value||c||"Research Derived Series";s.label=u;const p=g.generateSegmentation({segmentationId:e,options:{SeriesDescription:u,...S&&{SeriesInstanceUID:d.SeriesInstanceUID,SOPInstanceUID:d.instances[0].SOPInstanceUID,SeriesNumber:d.SeriesNumber,Manufacturer:d.instances[0].Manufacturer,SeriesDate:d.SeriesDate}}});if(!p||!p.dataset)throw new Error("Error during segmentation generation");const{dataset:E}=p;return await n.store.dicom(E),E.wadoRoot=n.getConfig().wadoRoot,E},downloadRTSS:({segmentationId:e})=>{const t=a.getSegmentation(e),n={vtkImageMarchingSquares:k.ZP,vtkDataArray:q.ZP,vtkImageData:z.ZP},o=X(t,r.classes.MetadataProvider,r.DicomMetadataStore,s.cache,c.Enums,n);try{const e=Z(o),t=URL.createObjectURL(e);window.location.assign(t)}catch(e){console.warn(e)}}},S={getUpdatedViewportsForSegmentation:{commandFn:g.getUpdatedViewportsForSegmentation},loadSegmentationDisplaySetsForViewport:{commandFn:g.loadSegmentationDisplaySetsForViewport},loadSegmentationsForViewport:{commandFn:g.loadSegmentationsForViewport},createEmptySegmentationForViewport:{commandFn:g.createEmptySegmentationForViewport},generateSegmentation:{commandFn:g.generateSegmentation},downloadSegmentation:{commandFn:g.downloadSegmentation},storeSegmentation:{commandFn:g.storeSegmentation},downloadRTSS:{commandFn:g.downloadRTSS}};return{actions:g,definitions:S}};function te(){return te=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var a in n)Object.prototype.hasOwnProperty.call(n,a)&&(e[a]=n[a])}return e},te.apply(this,arguments)}const ne=i.lazy((()=>n.e(451).then(n.bind(n,4451)))),ae=e=>i.createElement(i.Suspense,{fallback:i.createElement("div",null,"Loading...")},i.createElement(ne,e)),oe={id:a,preRegistration:function({configuration:e={}}){(0,c.addTool)(c.BrushTool)},getPanelModule:x,getCommandsModule:ee,getViewportModule:({servicesManager:e,extensionManager:t})=>[{name:"dicom-seg",component:n=>i.createElement(ae,te({servicesManager:e,extensionManager:t,commandsManager},n))}],getSopClassHandlerModule:u,getHangingProtocolModule:E}}}]);
//# sourceMappingURL=710.bundle.9b2d129f029d82fc5ebb.js.map