"use strict";(globalThis.webpackChunk=globalThis.webpackChunk||[]).push([[135],{80135:(e,t,n)=>{n.r(t),n.d(t,{AdvancedMagnifyTool:()=>_d,AngleTool:()=>ug,AnnotationDisplayTool:()=>wa,AnnotationTool:()=>Ca,ArrowAnnotateTool:()=>cg,BaseTool:()=>yo,BidirectionalTool:()=>Fd,BrushTool:()=>Lr,CONSTANTS:()=>Z,CircleROITool:()=>mc,CircleScissorsTool:()=>Ag,CobbAngleTool:()=>Eg,CrosshairsTool:()=>cd,DragProbeTool:()=>tc,EllipticalROITool:()=>cc,Enums:()=>i,KeyImageTool:()=>Sg,LengthTool:()=>qd,LivewireContourTool:()=>sg,MIPJumpToClickTool:()=>gl,MagnifyTool:()=>ud,OrientationMarkerTool:()=>eu,OverlayGridTool:()=>yd,PaintFillTool:()=>qg,PanTool:()=>Fr,PlanarFreehandROITool:()=>Qh,PlanarRotateTool:()=>Jr,ProbeTool:()=>Jd,RectangleROIStartEndThresholdTool:()=>Fg,RectangleROIThresholdTool:()=>Wg,RectangleROITool:()=>ac,RectangleScissorsTool:()=>Ng,ReferenceCursors:()=>Ld,ReferenceLines:()=>Dd,ReferenceLinesTool:()=>Dd,ScaleOverlayTool:()=>Ud,SegmentationDisplayTool:()=>xa,SegmentationIntersectionTool:()=>Pd,SphereScissorsTool:()=>Ug,SplineROITool:()=>yc,StackScrollMouseWheelTool:()=>el,StackScrollTool:()=>Yr,Synchronizer:()=>kv,SynchronizerManager:()=>z,ToolGroupManager:()=>j,TrackballRotateTool:()=>Kr,Types:()=>J,UltrasoundDirectionalTool:()=>_g,VideoRedactionTool:()=>Pp,VolumeRotateMouseWheelTool:()=>al,WindowLevelTool:()=>zr,ZoomTool:()=>nl,addTool:()=>et,annotation:()=>T,cancelActiveManipulations:()=>Nv,cursors:()=>C,destroy:()=>mp,drawing:()=>f,init:()=>up,removeTool:()=>tt,segmentation:()=>p,state:()=>Je,synchronizers:()=>X,utilities:()=>q});var i={};n.r(i),n.d(i,{AnnotationStyleStates:()=>ae,Events:()=>re,KeyboardBindings:()=>ee,MouseBindings:()=>Q,SegmentationRepresentations:()=>de,StrategyCallbacks:()=>ge,Swipe:()=>ce,ToolModes:()=>ie});var o={};n.r(o),n.d(o,{checkAndDefineIsLockedProperty:()=>Ce,getAnnotationsLocked:()=>Ee,getAnnotationsLockedCount:()=>Ie,isAnnotationLocked:()=>we,setAnnotationLocked:()=>pe,unlockAllAnnotations:()=>fe});var a={};n.r(a),n.d(a,{deselectAnnotation:()=>Oe,getAnnotationsSelected:()=>xe,getAnnotationsSelectedByToolName:()=>Re,getAnnotationsSelectedCount:()=>Ne,isAnnotationSelected:()=>Pe,setAnnotationSelected:()=>ye});var s={};n.r(s),n.d(s,{checkAndDefineIsVisibleProperty:()=>Be,isAnnotationVisible:()=>He,setAnnotationVisibility:()=>Ve,showAllAnnotations:()=>We});var r={};n.r(r),n.d(r,{copyPoints:()=>Yt,copyPointsList:()=>jt,getDeltaDistance:()=>Kt,getDeltaDistanceBetweenIPoints:()=>zt,getDeltaPoints:()=>$t,getDeltaRotation:()=>qt,getMeanPoints:()=>Zt,getMeanTouchPoints:()=>Xt});var l={};n.r(l),n.d(l,{triggerSegmentationDataModified:()=>Jn,triggerSegmentationModified:()=>Xn,triggerSegmentationRemoved:()=>jn,triggerSegmentationRepresentationModified:()=>Zn,triggerSegmentationRepresentationRemoved:()=>Yn});var d={};n.r(d),n.d(d,{addColorLUT:()=>_i,addSegmentation:()=>ii,addSegmentationRepresentation:()=>ui,getAllSegmentationRepresentations:()=>ai,getColorLUT:()=>Ii,getDefaultSegmentationStateManager:()=>ei,getGlobalConfig:()=>mi,getNextColorLUTIndex:()=>Ci,getSegmentSpecificRepresentationConfig:()=>hi,getSegmentation:()=>ti,getSegmentationRepresentationByUID:()=>pi,getSegmentationRepresentationSpecificConfig:()=>ci,getSegmentationRepresentations:()=>oi,getSegmentations:()=>ni,getToolGroupIdsWithSegmentation:()=>si,getToolGroupSpecificConfig:()=>ri,removeColorLUT:()=>wi,removeSegmentation:()=>fi,removeSegmentationRepresentation:()=>Ei,setGlobalConfig:()=>vi,setSegmentSpecificRepresentationConfig:()=>gi,setSegmentationRepresentationSpecificConfig:()=>di,setToolGroupSpecificConfig:()=>li});var c={};n.r(c),n.d(c,{getActiveSegmentationRepresentation:()=>go,setActiveSegmentationRepresentation:()=>uo});var h={};n.r(h),n.d(h,{getLockedSegments:()=>po,isSegmentIndexLocked:()=>mo,setSegmentIndexLocked:()=>vo});var g={};n.r(g),n.d(g,{addColorLUT:()=>fo,getColorForSegmentIndex:()=>wo,setColorForSegmentIndex:()=>Io,setColorLUT:()=>Eo});var u={};n.r(u),n.d(u,{getSegmentationVisibility:()=>_o,setSegmentVisibility:()=>bo,setSegmentationVisibility:()=>Co,setSegmentsVisibility:()=>To});var m={};n.r(m),n.d(m,{color:()=>g,getGlobalConfig:()=>Ji,getGlobalRepresentationConfig:()=>eo,getSegmentSpecificConfig:()=>so,getSegmentationRepresentationSpecificConfig:()=>oo,getToolGroupSpecificConfig:()=>no,setGlobalConfig:()=>Qi,setGlobalRepresentationConfig:()=>to,setSegmentSpecificConfig:()=>ro,setSegmentationRepresentationSpecificConfig:()=>ao,setToolGroupSpecificConfig:()=>io,visibility:()=>u});var v={};n.r(v),n.d(v,{getActiveSegmentIndex:()=>So,setActiveSegmentIndex:()=>Do});var p={};n.r(p),n.d(p,{activeSegmentation:()=>c,addSegmentationRepresentations:()=>ho,addSegmentations:()=>Xi,config:()=>m,removeSegmentationsFromToolGroup:()=>ji,segmentIndex:()=>v,segmentLocking:()=>h,state:()=>d,triggerSegmentationEvents:()=>l});var f={};n.r(f),n.d(f,{draw:()=>ko,drawArrow:()=>ea,drawCircle:()=>Ho,drawEllipse:()=>Fo,drawEllipseByCoordinates:()=>Bo,drawHandle:()=>Go,drawHandles:()=>$o,drawLine:()=>Ko,drawLinkedTextBox:()=>Jo,drawPolyline:()=>qo,drawRect:()=>Qo,drawRedactionRect:()=>ta,drawTextBox:()=>Yo,setAttributesIfNecessary:()=>Vo,setNewAttributesIfValid:()=>Wo});var E={};n.r(E),n.d(E,{getFont:()=>fa,getState:()=>pa,style:()=>ma});var w={};n.r(w),n.d(w,{extend2DBoundingBoxInViewAxis:()=>vs,getBoundingBoxAroundShape:()=>ps});var I={};n.r(I),n.d(I,{getCanvasEllipseCorners:()=>_s,pointInEllipse:()=>Is,precalculatePointInEllipse:()=>Cs});var C={};n.r(C),n.d(C,{CursorNames:()=>Sr,CursorSVG:()=>vr,ImageMouseCursor:()=>rr,MouseCursor:()=>or,SVGMouseCursor:()=>Cr,elementCursor:()=>_,registerCursor:()=>fr,setCursorForElement:()=>Dr});var _={};n.r(_),n.d(_,{hideElementCursor:()=>Rr,initElementCursor:()=>yr,resetElementCursor:()=>xr,setElementCursor:()=>Or});var T={};n.r(T),n.d(T,{AnnotationGroup:()=>Hr,FrameOfReferenceSpecificAnnotationManager:()=>Ye,config:()=>E,locking:()=>o,selection:()=>a,state:()=>Y,visibility:()=>s});var b={};n.r(b),n.d(b,{default:()=>dl,filterAnnotationsForDisplay:()=>ua,filterAnnotationsWithinSlice:()=>ca,getPointInLineOfSightWithCriteria:()=>rl,getWorldWidthAndHeightFromCorners:()=>sl});var D={};n.r(D),n.d(D,{filterViewportsWithFrameOfReferenceUID:()=>ml,filterViewportsWithParallelNormals:()=>Il,filterViewportsWithToolEnabled:()=>El,getViewportIdsWithToolToRender:()=>Cl});var S={};n.r(S),n.d(S,{distanceToPoint:()=>yl,distanceToPointSquared:()=>Ml});var M={};n.r(M),n.d(M,{BasicStatsCalculator:()=>Rl,Calculator:()=>Ol});var y={};n.r(y),n.d(y,{distanceToPoint:()=>Ll,distanceToPointSquared:()=>Nl,mirror:()=>Al});var O={};n.r(O),n.d(O,{addCanvasPointsToArray:()=>ql,calculateAreaOfPoints:()=>jl,getClosestIntersectionWithPolyline:()=>Vl,getFirstIntersectionWithPolyline:()=>Ul,getSubPixelSpacingAndXYDirections:()=>$l,pointCanProjectOnLine:()=>zl,pointsAreWithinCloseContourProximity:()=>Kl});var x={};n.r(x),n.d(x,{distanceToPoint:()=>Yl});var R={};n.r(R),n.d(R,{findClosestPoint:()=>Zo,liangBarksyClip:()=>Sl});var P={};n.r(P),n.d(P,{BasicStatsCalculator:()=>M,aabb:()=>S,ellipse:()=>I,lineSegment:()=>N,point:()=>y,polyline:()=>O,rectangle:()=>x,vec2:()=>R});var N={};n.r(N),n.d(N,{distanceToPoint:()=>Jl,distanceToPointSquared:()=>Xl,distanceToPointSquaredInfo:()=>Zl,intersectLine:()=>ed});var L={};n.r(L),n.d(L,{getTextBoxCoordsCanvas:()=>Vd});var A={};n.r(A),n.d(A,{createLabelmapVolumeForViewport:()=>su,createMergedLabelmapForIndex:()=>iu,floodFill:()=>ys,getBrushSizeForToolGroup:()=>lu,getBrushThresholdForToolGroup:()=>cu,getDefaultRepresentationConfig:()=>au,isValidRepresentationConfig:()=>ou,rectangleROIThresholdVolumeByRange:()=>nu,setBrushSizeForToolGroup:()=>ru,setBrushThresholdForToolGroup:()=>du,thresholdSegmentationByRange:()=>hu,thresholdVolumeByRange:()=>Wr,triggerSegmentationRender:()=>Pa});var k={};n.r(k),n.d(k,{getOrientationStringLPS:()=>gu,invertOrientationStringLPS:()=>uu});var U={};n.r(U),n.d(U,{Events:()=>vu,addToolState:()=>fu,getToolState:()=>Eu,playClip:()=>bu,stopClip:()=>Du});var V={};n.r(V),n.d(V,{default:()=>xu,interpolateAnnotation:()=>Ou});var W={};n.r(W),n.d(W,{getBoundsIJKFromRectangleAnnotations:()=>tu});var H={};n.r(H),n.d(H,{isViewportPreScaled:()=>jd,jumpToSlice:()=>gs,jumpToWorld:()=>cl});var B={};n.r(B),n.d(B,{generateImageFromTimeData:()=>em,getDataInTime:()=>Qu});var F={};n.r(F),n.d(F,{getPoint:()=>tm,getPolyDataPointIndexes:()=>nm,getPolyDataPoints:()=>im});var G={};n.r(G),n.d(G,{ColorbarRangeTextPosition:()=>om});var $={};n.r($),n.d($,{Colorbar:()=>vm,Enums:()=>G,ViewportColorbar:()=>Em});var K={};n.r(K),n.d(K,{colorbar:()=>$});var q={};n.r(q),n.d(q,{annotationFrameRange:()=>ha,boundingBox:()=>w,calibrateImageSpacing:()=>Za,cine:()=>U,clip:()=>ja,debounce:()=>Ka,drawing:()=>L,dynamicVolume:()=>B,getAnnotationNearPoint:()=>Ba,getAnnotationNearPointOnEnabledElement:()=>Fa,getCalibratedAreaUnits:()=>as,getCalibratedLengthUnits:()=>is,getCalibratedScale:()=>ss,isObject:()=>$a,jumpToSlice:()=>gs,math:()=>P,orientation:()=>k,planar:()=>b,planarFreehandROITool:()=>V,pointInShapeCallback:()=>us,pointInSurroundingSphereCallback:()=>Es,pointToString:()=>ba,polyDataUtils:()=>F,rectangleROITool:()=>W,roundNumber:()=>ws,scroll:()=>hs,segmentation:()=>A,stackContextPrefetch:()=>Ju,stackPrefetch:()=>Ku,throttle:()=>qa,touch:()=>r,triggerAnnotationRender:()=>ra,triggerAnnotationRenderForViewportIds:()=>cs,triggerEvent:()=>ne.triggerEvent,viewport:()=>H,viewportFilters:()=>D,voi:()=>K});var z={};n.r(z),n.d(z,{createSynchronizer:()=>Uv,destroy:()=>Vv,destroySynchronizer:()=>Bv,getAllSynchronizers:()=>Hv,getSynchronizer:()=>Wv,getSynchronizersForViewport:()=>Sv});var j={};n.r(j),n.d(j,{createToolGroup:()=>Yv,destroy:()=>Xv,destroyToolGroup:()=>Zv,getAllToolGroups:()=>Qv,getToolGroup:()=>Jv,getToolGroupForViewport:()=>Mv,getToolGroupsWithToolName:()=>tp});var Y={};n.r(Y),n.d(Y,{addAnnotation:()=>rp,getAnnotation:()=>cp,getAnnotationManager:()=>ip,getAnnotations:()=>sp,getNumberOfAnnotations:()=>lp,removeAllAnnotations:()=>hp,removeAnnotation:()=>dp,resetAnnotationManager:()=>ap,setAnnotationManager:()=>op});var Z={};n.r(Z),n.d(Z,{COLOR_LUT:()=>co});var X={};n.r(X),n.d(X,{createCameraPositionSynchronizer:()=>wp,createImageSliceSynchronizer:()=>Op,createStackImageSynchronizer:()=>xp,createVOISynchronizer:()=>Cp,createZoomPanSynchronizer:()=>bp});var J={};n.r(J);var Q,ee,te,ne=n(56388);!function(e){e[e.Primary=1]="Primary",e[e.Secondary=2]="Secondary",e[e.Primary_And_Secondary=3]="Primary_And_Secondary",e[e.Auxiliary=4]="Auxiliary",e[e.Primary_And_Auxiliary=5]="Primary_And_Auxiliary",e[e.Secondary_And_Auxiliary=6]="Secondary_And_Auxiliary",e[e.Primary_And_Secondary_And_Auxiliary=7]="Primary_And_Secondary_And_Auxiliary",e[e.Fourth_Button=8]="Fourth_Button",e[e.Fifth_Button=16]="Fifth_Button"}(Q||(Q={})),function(e){e[e.Shift=16]="Shift",e[e.Ctrl=17]="Ctrl",e[e.Alt=18]="Alt",e[e.Meta=91]="Meta",e[e.ShiftCtrl=1617]="ShiftCtrl",e[e.ShiftAlt=1618]="ShiftAlt",e[e.ShiftMeta=1691]="ShiftMeta",e[e.CtrlAlt=1718]="CtrlAlt",e[e.CtrlMeta=1791]="CtrlMeta",e[e.AltMeta=1891]="AltMeta"}(ee||(ee={})),function(e){e.Active="Active",e.Passive="Passive",e.Enabled="Enabled",e.Disabled="Disabled"}(te||(te={}));const ie=te;var oe;!function(e){e.Default="",e.Highlighted="Highlighted",e.Selected="Selected",e.Locked="Locked"}(oe||(oe={}));const ae=oe;var se;!function(e){e.TOOL_ACTIVATED="CORNERSTONE_TOOLS_TOOL_ACTIVATED",e.TOOL_MODE_CHANGED="CORNERSTONE_TOOLS_TOOL_MODE_CHANGED",e.ANNOTATION_ADDED="CORNERSTONE_TOOLS_ANNOTATION_ADDED",e.ANNOTATION_COMPLETED="CORNERSTONE_TOOLS_ANNOTATION_COMPLETED",e.ANNOTATION_MODIFIED="CORNERSTONE_TOOLS_ANNOTATION_MODIFIED",e.ANNOTATION_REMOVED="CORNERSTONE_TOOLS_ANNOTATION_REMOVED",e.ANNOTATION_SELECTION_CHANGE="CORNERSTONE_TOOLS_ANNOTATION_SELECTION_CHANGE",e.ANNOTATION_LOCK_CHANGE="CORNERSTONE_TOOLS_ANNOTATION_LOCK_CHANGE",e.ANNOTATION_VISIBILITY_CHANGE="CORNERSTONE_TOOLS_ANNOTATION_VISIBILITY_CHANGE",e.ANNOTATION_RENDERED="CORNERSTONE_TOOLS_ANNOTATION_RENDERED",e.SEGMENTATION_MODIFIED="CORNERSTONE_TOOLS_SEGMENTATION_MODIFIED",e.SEGMENTATION_RENDERED="CORNERSTONE_TOOLS_SEGMENTATION_RENDERED",e.SEGMENTATION_REPRESENTATION_MODIFIED="CORNERSTONE_TOOLS_SEGMENTATION_REPRESENTATION_MODIFIED",e.SEGMENTATION_REMOVED="CORNERSTONE_TOOLS_SEGMENTATION_REMOVED",e.SEGMENTATION_REPRESENTATION_REMOVED="CORNERSTONE_TOOLS_SEGMENTATION_REPRESENTATION_REMOVED",e.SEGMENTATION_DATA_MODIFIED="CORNERSTONE_TOOLS_SEGMENTATION_DATA_MODIFIED",e.KEY_DOWN="CORNERSTONE_TOOLS_KEY_DOWN",e.KEY_UP="CORNERSTONE_TOOLS_KEY_UP",e.MOUSE_DOWN="CORNERSTONE_TOOLS_MOUSE_DOWN",e.MOUSE_UP="CORNERSTONE_TOOLS_MOUSE_UP",e.MOUSE_DOWN_ACTIVATE="CORNERSTONE_TOOLS_MOUSE_DOWN_ACTIVATE",e.MOUSE_DRAG="CORNERSTONE_TOOLS_MOUSE_DRAG",e.MOUSE_MOVE="CORNERSTONE_TOOLS_MOUSE_MOVE",e.MOUSE_CLICK="CORNERSTONE_TOOLS_MOUSE_CLICK",e.MOUSE_DOUBLE_CLICK="CORNERSTONE_TOOLS_MOUSE_DOUBLE_CLICK",e.MOUSE_WHEEL="CORNERSTONE_TOOLS_MOUSE_WHEEL",e.TOUCH_START="CORNERSTONE_TOOLS_TOUCH_START",e.TOUCH_START_ACTIVATE="CORNERSTONE_TOOLS_TOUCH_START_ACTIVATE",e.TOUCH_PRESS="CORNERSTONE_TOOLS_TOUCH_PRESS",e.TOUCH_DRAG="CORNERSTONE_TOOLS_TOUCH_DRAG",e.TOUCH_END="CORNERSTONE_TOOLS_TOUCH_END",e.TOUCH_TAP="CORNERSTONE_TOOLS_TAP",e.TOUCH_SWIPE="CORNERSTONE_TOOLS_SWIPE"}(se||(se={}));const re=se;var le;!function(e){e.Labelmap="LABELMAP",e.Contour="CONTOUR",e.Surface="SURFACE"}(le||(le={}));const de=le;var ce,he;!function(e){e.UP="UP",e.DOWN="DOWN",e.LEFT="LEFT",e.RIGHT="RIGHT"}(ce||(ce={})),function(e){e.OnInteractionStart="onInteractionStart",e.OnInteractionEnd="onInteractionEnd",e.Preview="preview",e.RejectPreview="rejectPreview",e.AcceptPreview="acceptPreview",e.Fill="fill",e.StrategyFunction="strategyFunction",e.CreateIsInThreshold="createIsInThreshold",e.Initialize="initialize",e.INTERNAL_setValue="setValue"}(he||(he={}));const ge=he;var ue=n(11677),me=n.n(ue);const ve=new Set;function pe(e,t=!0){const n=_e();e&&(t?function(e,t,n){t.has(e)||(t.add(e),n.added.push(e))}(e,ve,n):Te(e,ve,n)),be(n,ve)}function fe(){const e=_e();!function(e,t){e.forEach((n=>{Te(n,e,t)}))}(ve,e),be(e,ve)}function Ee(){return Array.from(ve)}function we(e){return ve.has(e)}function Ie(){return ve.size}function Ce(e){if(e){const t=!!e.isLocked;(function(e){const t=Object.getOwnPropertyDescriptor(e,"isLocked");if(t)return t.configurable&&(t.set!==De||t.get!==Se);return Object.isExtensible(e)})(e)&&Object.defineProperty(e,"isLocked",{configurable:!1,enumerable:!0,set:De,get:Se}),pe(e,t)}}function _e(){return Object.freeze({added:[],removed:[],locked:[]})}function Te(e,t,n){t.delete(e)&&n.removed.push(e)}function be(e,t){(e.added.length>0||e.removed.length>0)&&(t.forEach((t=>{e.locked.push(t)})),(0,ne.triggerEvent)(ne.eventTarget,re.ANNOTATION_LOCK_CHANGE,e))}function De(e){pe(this,e)}function Se(){return we(this)}const Me=new Set;function ye(e,t=!0,n=!1){t?function(e,t=!1){const n=Le();t||Ae(Me,n);e&&!Me.has(e)&&(Me.add(e),n.added.push(e));ke(n,Me)}(e,n):Oe(e)}function Oe(e){const t=Le();e?Me.delete(e)&&t.removed.push(e):Ae(Me,t),ke(t,Me)}function xe(){return Array.from(Me)}function Re(e){return xe().filter((t=>cp(t).metadata.toolName===e))}function Pe(e){return Me.has(e)}function Ne(){return Me.size}function Le(){return Object.freeze({added:[],removed:[],selection:[]})}function Ae(e,t){e.forEach((n=>{e.delete(n)&&t.removed.push(n)}))}function ke(e,t){(e.added.length>0||e.removed.length>0)&&(t.forEach((t=>{e.selection.push(t)})),(0,ne.triggerEvent)(ne.eventTarget,re.ANNOTATION_SELECTION_CHANGE,e))}const Ue=new Set;function Ve(e,t=!0){const n=Fe();e&&(t?Ge(e,Ue,n):function(e,t,n){t.has(e)||(t.add(e),Pe(e)&&Oe(e),n.lastHidden.push(e))}(e,Ue,n)),$e(n)}function We(){const e=Fe();Ue.forEach((t=>{Ge(t,Ue,e)})),$e(e)}function He(e){if(cp(e))return!Ue.has(e)}function Be(e){if(e){const t=e.isVisible??!0;(function(e){const t=Object.getOwnPropertyDescriptor(e,"isVisible");if(t)return t.configurable&&(t.set!==Ke||t.get!==qe);return Object.isExtensible(e)})(e)&&Object.defineProperty(e,"isVisible",{configurable:!1,enumerable:!0,set:Ke,get:qe}),Ve(e.annotationUID,t)}}function Fe(){return Object.freeze({lastVisible:[],lastHidden:[],hidden:[]})}function Ge(e,t,n){t.delete(e)&&n.lastVisible.push(e)}function $e(e){(e.lastHidden.length>0||e.lastVisible.length>0)&&(Ue.forEach((t=>{e.hidden.push(t)})),(0,ne.triggerEvent)(ne.eventTarget,re.ANNOTATION_VISIBILITY_CHANGE,e))}function Ke(e){Ve(this.annotationUID,e)}function qe(){return He(this.annotationUID)}class ze{constructor(e){this.getGroupKey=e=>{if("string"==typeof e)return e;const t=e,n=(0,ne.getEnabledElement)(t);if(!n)throw new Error("Element not enabled, you must have an enabled element if you are not providing a FrameOfReferenceUID");return n.FrameOfReferenceUID},this._imageVolumeModifiedHandler=e=>{const t=e.detail,{FrameOfReferenceUID:n}=t,i=this.annotations[n];i&&Object.keys(i).forEach((e=>{i[e].forEach((e=>{void 0!==e.invalidated&&(e.invalidated=!0)}))}))},this.getFramesOfReference=()=>Object.keys(this.annotations),this.getAnnotations=(e,t)=>{const n=this.annotations;return n[e]?t?n[e][t]:n[e]:[]},this.getAnnotation=e=>{const t=this.annotations;for(const n in t){const i=t[n];for(const t in i){const n=i[t];for(const t of n)if(e===t.annotationUID)return t}}},this.getNumberOfAnnotations=(e,t)=>{const n=this.getAnnotations(e,t);if(!n.length)return 0;if(t)return n.length;let i=0;for(const e in n)i+=n[e].length;return i},this.addAnnotation=(e,t)=>{const{metadata:n}=e,{FrameOfReferenceUID:i,toolName:o}=n;t=t||i;const a=this.annotations;let s=a[t];s||(a[t]={},s=a[t]);let r=s[o];r||(s[o]=[],r=s[o]),r.push(e),Ce(e),Be(e)},this.removeAnnotation=e=>{const{annotations:t}=this;for(const n in t){const i=t[n];for(const t in i){const n=i[t],o=n.findIndex((t=>t.annotationUID===e));-1!==o&&(n.splice(o,1),0===n.length&&delete i[t])}0===Object.keys(i).length&&delete t[n]}},this.removeAnnotations=(e,t)=>{const n=this.annotations;n[e]&&(t?delete n[e][t]:delete n[e])},this.saveAnnotations=(e,t)=>{const n=this.annotations;if(e&&t){const i=n[e];if(!i)return;const o=i[t];return me()(o)}if(e){const t=n[e];return me()(t)}return me()(n)},this.restoreAnnotations=(e,t,n)=>{const i=this.annotations;if(t&&n){let o=i[t];o||(i[t]={},o=i[t]),o[n]=e}else t?i[t]=e:this.annotations=me()(e)},this.getNumberOfAllAnnotations=()=>{let e=0;const t=this.annotations;for(const n in t){const i=t[n];for(const t in i){e+=i[t].length}}return e},this.removeAllAnnotations=()=>{this.annotations={}},e||(e=ne.utilities.uuidv4()),this.annotations={},this.uid=e,ne.eventTarget.addEventListener(ne.Enums.Events.IMAGE_VOLUME_MODIFIED,this._imageVolumeModifiedHandler)}}const je=new ze("DEFAULT"),Ye=ze;let Ze={};const Xe={isInteractingWithTool:!1,isMultiPartToolActive:!1,tools:{},toolGroups:[],synchronizers:[],svgNodeCache:Ze,enabledElements:[],handleRadius:6};let Je={isInteractingWithTool:!1,isMultiPartToolActive:!1,tools:{},toolGroups:[],synchronizers:[],svgNodeCache:Ze,enabledElements:[],handleRadius:6};function Qe(){Ze={},Je=me()(Xe)}function et(e){const t=e.toolName,n=void 0!==Je.tools[t];if(!t)throw new Error(`No Tool Found for the ToolClass ${e.name}`);if(n)throw new Error(`${t} has already been added globally`);Je.tools[t]={toolClass:e}}function tt(e){const t=e.toolName;if(!t)throw new Error(`No tool found for: ${e.name}`);if(void 0===!Je.tools[t])throw new Error(`${t} cannot be removed because it has not been added`);delete Je.tools[t]}function nt(e,t){const n=t||e.currentTarget,{viewport:i}=(0,ne.getEnabledElement)(n),o=function(e){return[e.clientX,e.clientY]}(e),a=function(e){return[e.pageX,e.pageY]}(e),s=function(e,t){const n=e.getBoundingClientRect();return[t[0]-n.left-window.pageXOffset,t[1]-n.top-window.pageYOffset]}(n,a);return{page:a,client:o,canvas:s,world:i.canvasToWorld(s)}}const it=function(e){const t=e.currentTarget,{viewportId:n,renderingEngineId:i}=(0,ne.getEnabledElement)(t),o=nt(e,t),a={event:e,eventName:re.MOUSE_DOUBLE_CLICK,viewportId:n,renderingEngineId:i,camera:{},element:t,startPoints:o,lastPoints:o,currentPoints:o,deltaPoints:{page:[0,0],client:[0,0],canvas:[0,0],world:[0,0,0]}};!(0,ne.triggerEvent)(t,re.MOUSE_DOUBLE_CLICK,a)&&(e.stopImmediatePropagation(),e.preventDefault())},ot=re.MOUSE_MOVE;const at=function(e){const t=e.currentTarget,n=(0,ne.getEnabledElement)(t),{renderingEngineId:i,viewportId:o}=n,a={renderingEngineId:i,viewportId:o,camera:{},element:t,currentPoints:nt(e),eventName:ot,event:e};!(0,ne.triggerEvent)(t,ot,a)&&(e.stopImmediatePropagation(),e.preventDefault())},{MOUSE_DOWN:st,MOUSE_DOWN_ACTIVATE:rt,MOUSE_CLICK:lt,MOUSE_UP:dt,MOUSE_DRAG:ct}=re,ht=3,gt={mouseButton:void 0,element:null,renderingEngineId:void 0,viewportId:void 0,isClickEvent:!0,clickDelay:200,preventClickTimeout:null,startPoints:{page:[0,0],client:[0,0],canvas:[0,0],world:[0,0,0]},lastPoints:{page:[0,0],client:[0,0],canvas:[0,0],world:[0,0,0]}};let ut={mouseButton:void 0,renderingEngineId:void 0,viewportId:void 0,isClickEvent:!0,clickDelay:200,element:null,preventClickTimeout:null,startPoints:{page:[0,0],client:[0,0],canvas:[0,0],world:[0,0,0]},lastPoints:{page:[0,0],client:[0,0],canvas:[0,0],world:[0,0,0]}};const mt={doubleClickTimeout:null,mouseDownEvent:null,mouseUpEvent:null,ignoreDoubleClick:!1};function vt(e){const t=nt(e,ut.element),n=bt(ut.element,ut.lastPoints),i=Dt(t,n);if(mt.doubleClickTimeout){if(!Et(i.canvas))return;It()}const o={event:e,eventName:ct,mouseButton:ut.mouseButton,renderingEngineId:ut.renderingEngineId,viewportId:ut.viewportId,camera:{},element:ut.element,startPoints:Tt(ut.startPoints),lastPoints:Tt(n),currentPoints:t,deltaPoints:i};!(0,ne.triggerEvent)(ut.element,ct,o)&&(e.stopImmediatePropagation(),e.preventDefault()),ut.lastPoints=Tt(t)}function pt(e){if(clearTimeout(ut.preventClickTimeout),mt.doubleClickTimeout)mt.mouseUpEvent?_t():(mt.mouseUpEvent=e,ut.element.addEventListener("mousemove",ft));else{const t=ut.isClickEvent?lt:dt,n=nt(e,ut.element),i=Dt(n,ut.lastPoints),o={event:e,eventName:t,mouseButton:ut.mouseButton,element:ut.element,renderingEngineId:ut.renderingEngineId,viewportId:ut.viewportId,camera:{},startPoints:Tt(ut.startPoints),lastPoints:Tt(ut.lastPoints),currentPoints:n,deltaPoints:i};(0,ne.triggerEvent)(o.element,t,o),_t()}document.removeEventListener("mousemove",vt)}function ft(e){Et(Dt(nt(e,ut.element),bt(ut.element,ut.lastPoints)).canvas)&&(It(),at(e))}function Et(e){return Math.abs(e[0])+Math.abs(e[1])>ht}function wt(){ut.isClickEvent=!1}function It(){mt.ignoreDoubleClick=!0;const e=mt.mouseDownEvent,t=mt.mouseUpEvent;Ct(),function(e){const t=Dt(ut.startPoints,ut.startPoints),n={event:e,eventName:st,element:ut.element,mouseButton:ut.mouseButton,renderingEngineId:ut.renderingEngineId,viewportId:ut.viewportId,camera:{},startPoints:ut.startPoints,lastPoints:ut.startPoints,currentPoints:ut.startPoints,deltaPoints:t};ut.lastPoints=Tt(n.lastPoints),(0,ne.triggerEvent)(n.element,st,n)&&(0,ne.triggerEvent)(n.element,rt,n)}(e),t&&pt(t)}function Ct(){mt.doubleClickTimeout&&(clearTimeout(mt.doubleClickTimeout),mt.doubleClickTimeout=null),mt.mouseDownEvent=null,mt.mouseUpEvent=null}function _t(){document.removeEventListener("mouseup",pt),ut.element?.removeEventListener("mousemove",ft),ut.element?.addEventListener("mousemove",at),Ct(),ut=JSON.parse(JSON.stringify(gt))}function Tt(e){return JSON.parse(JSON.stringify(e))}function bt(e,t){const{viewport:n}=(0,ne.getEnabledElement)(e),i=n.canvasToWorld(t.canvas);return{page:t.page,client:t.client,canvas:t.canvas,world:i}}function Dt(e,t){return{page:St(e.page,t.page),client:St(e.client,t.client),canvas:St(e.canvas,t.canvas),world:(n=e.world,i=t.world,[n[0]-i[0],n[1]-i[1],n[2]-i[2]])};var n,i}function St(e,t){return[e[0]-t[0],e[1]-t[1]]}function Mt(e){mt.ignoreDoubleClick?(mt.ignoreDoubleClick=!1,e.stopImmediatePropagation(),e.preventDefault()):_t()}const yt=function(e){if(mt.doubleClickTimeout){if(e.buttons===mt.mouseDownEvent.buttons)return;return mt.mouseDownEvent=e,void It()}mt.doubleClickTimeout=setTimeout(It,1===e.buttons?400:150),mt.mouseDownEvent=e,mt.ignoreDoubleClick=!1,ut.element=e.currentTarget,ut.mouseButton=e.buttons;const t=(0,ne.getEnabledElement)(ut.element),{renderingEngineId:n,viewportId:i}=t;ut.renderingEngineId=n,ut.viewportId=i,ut.preventClickTimeout=setTimeout(wt,ut.clickDelay),ut.element.removeEventListener("mousemove",at);const o=nt(e,ut.element);ut.startPoints=Tt(o),ut.lastPoints=Tt(o),document.addEventListener("mouseup",pt),document.addEventListener("mousemove",vt)};function Ot(e){e.removeEventListener("dblclick",it),e.removeEventListener("mousedown",yt),e.removeEventListener("mousemove",at),e.removeEventListener("dblclick",Mt,{capture:!0})}const xt={enable:function(e){Ot(e),e.addEventListener("dblclick",it),e.addEventListener("mousedown",yt),e.addEventListener("mousemove",at),e.addEventListener("dblclick",Mt,{capture:!0})},disable:Ot},Rt={mouse:0,touch:1};let Pt,Nt;function Lt(e,t){const n=Date.now();if(e!==Pt){if(n-Nt<=2e3)return t.preventDefault(),t.stopPropagation(),t.stopImmediatePropagation(),!1;Pt=e}Nt=n}const At=Lt.bind(null,Rt.mouse),kt=Lt.bind(null,Rt.touch);function Ut(e,t,n){const i=n?At:kt;t.forEach((function(t){e.addEventListener(t,i,{passive:!1})}))}function Vt(e,t,n){const i=n?At:kt;t.forEach((function(t){e.removeEventListener(t,i)}))}const Wt=["mousedown","mouseup","mousemove"],Ht=["touchstart","touchend"];function Bt(e){Vt(e,Wt,Rt.mouse),Vt(e,Ht,Rt.touch)}const Ft={enable:function(e){Bt(e),Ut(e,Wt,Rt.mouse),Ut(e,Ht,Rt.touch)},disable:Bt};function Gt(e,t){const n=t||e.currentTarget,i="touchend"===e.type?e.changedTouches:e.touches;return Object.keys(i).map((e=>{const t=function(e){return[e.clientX,e.clientY]}(i[e]),o=function(e){return[e.pageX,e.pageY]}(i[e]),a=function(e,t){const n=e.getBoundingClientRect();return[t[0]-n.left-window.pageXOffset,t[1]-n.top-window.pageYOffset]}(n,o),{viewport:s}=(0,ne.getEnabledElement)(n);return{page:o,client:t,canvas:a,world:s.canvasToWorld(a),touch:{identifier:e,radiusX:i[e].radiusX,radiusY:i[e].radiusY,force:i[e].force,rotationAngle:i[e].rotationAngle}}}))}function $t(e,t){const n=Zt(e),i=Zt(t);return{page:Jt(n.page,i.page),client:Jt(n.client,i.client),canvas:Jt(n.canvas,i.canvas),world:(o=n.world,a=i.world,[o[0]-a[0],o[1]-a[1],o[2]-a[2]])};var o,a}function Kt(e,t){const n=Zt(e),i=Zt(t);return{page:en(n.page,i.page),client:en(n.client,i.client),canvas:en(n.canvas,i.canvas),world:tn(n.world,i.world)}}function qt(e,t){}function zt(e,t){const n=Qt(e),i=Qt(t);return{page:n.page-i.page,client:n.client-i.client,canvas:n.canvas-i.canvas,world:n.world-i.world}}function jt(e){return JSON.parse(JSON.stringify(e))}function Yt(e){return JSON.parse(JSON.stringify(e))}function Zt(e){return e.reduce(((t,n)=>({page:[t.page[0]+n.page[0]/e.length,t.page[1]+n.page[1]/e.length],client:[t.client[0]+n.client[0]/e.length,t.client[1]+n.client[1]/e.length],canvas:[t.canvas[0]+n.canvas[0]/e.length,t.canvas[1]+n.canvas[1]/e.length],world:[t.world[0]+n.world[0]/e.length,t.world[1]+n.world[1]/e.length,t.world[2]+n.world[2]/e.length]})),{page:[0,0],client:[0,0],canvas:[0,0],world:[0,0,0]})}function Xt(e){return e.reduce(((t,n)=>({page:[t.page[0]+n.page[0]/e.length,t.page[1]+n.page[1]/e.length],client:[t.client[0]+n.client[0]/e.length,t.client[1]+n.client[1]/e.length],canvas:[t.canvas[0]+n.canvas[0]/e.length,t.canvas[1]+n.canvas[1]/e.length],world:[t.world[0]+n.world[0]/e.length,t.world[1]+n.world[1]/e.length,t.world[2]+n.world[2]/e.length],touch:{identifier:null,radiusX:t.touch.radiusX+n.touch.radiusX/e.length,radiusY:t.touch.radiusY+n.touch.radiusY/e.length,force:t.touch.force+n.touch.force/e.length,rotationAngle:t.touch.rotationAngle+n.touch.rotationAngle/e.length}})),{page:[0,0],client:[0,0],canvas:[0,0],world:[0,0,0],touch:{identifier:null,radiusX:0,radiusY:0,force:0,rotationAngle:0}})}function Jt(e,t){return[e[0]-t[0],e[1]-t[1]]}function Qt(e){const t=[];for(let n=0;n<e.length;n++)for(let i=0;i<e.length;i++)n<i&&t.push({page:en(e[n].page,e[i].page),client:en(e[n].client,e[i].client),canvas:en(e[n].canvas,e[i].canvas),world:tn(e[n].world,e[i].world)});return t.reduce(((e,n)=>({page:e.page+n.page/t.length,client:e.client+n.client/t.length,canvas:e.canvas+n.canvas/t.length,world:e.world+n.world/t.length})),{page:0,client:0,canvas:0,world:0})}function en(e,t){return Math.sqrt(Math.pow(e[0]-t[0],2)+Math.pow(e[1]-t[1],2))}function tn(e,t){return Math.sqrt(Math.pow(e[0]-t[0],2)+Math.pow(e[1]-t[1],2)+Math.pow(e[2]-t[2],2))}ne.Settings.getRuntimeSettings();const{TOUCH_START:nn,TOUCH_START_ACTIVATE:on,TOUCH_PRESS:an,TOUCH_DRAG:sn,TOUCH_END:rn,TOUCH_TAP:ln,TOUCH_SWIPE:dn}=re,cn={page:[0,0],client:[0,0],canvas:[0,0],world:[0,0,0]},hn={page:0,client:0,canvas:0,world:0},gn={renderingEngineId:void 0,viewportId:void 0,element:null,startPointsList:[{...cn,touch:null}],lastPointsList:[{...cn,touch:null}],isTouchStart:!1,startTime:null,pressTimeout:null,pressDelay:700,pressMaxDistance:5,accumulatedDistance:hn,swipeDistanceThreshold:48,swiped:!1,swipeToleranceMs:300},un={renderingEngineId:void 0,viewportId:void 0,element:null,startPointsList:[{...cn,touch:null}],taps:0,tapTimeout:null,tapMaxDistance:24,tapToleranceMs:300};let mn=JSON.parse(JSON.stringify(gn)),vn=JSON.parse(JSON.stringify(un));function pn(e,t,n){return(0,ne.triggerEvent)(e,t,n)}function fn(e){const t=Gt(e,mn.element),n=wn(mn.element,mn.lastPointsList),i=t.length===n.length?$t(t,n):cn,o=t.length===n.length?zt(t,n):hn,a=t.length===n.length?Kt(t,mn.lastPointsList):hn;mn.accumulatedDistance={page:mn.accumulatedDistance.page+a.page,client:mn.accumulatedDistance.client+a.client,canvas:mn.accumulatedDistance.canvas+a.canvas,world:mn.accumulatedDistance.world+a.world};const s={event:e,eventName:sn,renderingEngineId:mn.renderingEngineId,viewportId:mn.viewportId,camera:{},element:mn.element,startPoints:Xt(mn.startPointsList),lastPoints:Xt(n),currentPoints:Xt(t),startPointsList:jt(mn.startPointsList),lastPointsList:jt(n),currentPointsList:t,deltaPoints:i,deltaDistance:o};pn(mn.element,sn,s),function(e,t){const n=(new Date).getTime(),i=mn.startTime.getTime();if(mn.swiped||n-i>mn.swipeToleranceMs)return;const[o,a]=t.canvas,s={event:e,eventName:dn,renderingEngineId:mn.renderingEngineId,viewportId:mn.viewportId,camera:{},element:mn.element,swipe:null};Math.abs(o)>mn.swipeDistanceThreshold&&(s.swipe=o>0?ce.RIGHT:ce.LEFT,pn(s.element,dn,s),mn.swiped=!0);Math.abs(a)>mn.swipeDistanceThreshold&&(s.swipe=a>0?ce.DOWN:ce.UP,pn(s.element,dn,s),mn.swiped=!0)}(e,i),mn.lastPointsList=jt(t)}function En(e){clearTimeout(mn.pressTimeout);const t=Gt(e,mn.element),n=wn(mn.element,mn.lastPointsList),i=t.length===n.length?$t(t,n):$t(t,t),o=t.length===n.length?zt(t,n):zt(t,t),a={event:e,eventName:rn,element:mn.element,renderingEngineId:mn.renderingEngineId,viewportId:mn.viewportId,camera:{},startPointsList:jt(mn.startPointsList),lastPointsList:jt(n),currentPointsList:t,startPoints:Xt(mn.startPointsList),lastPoints:Xt(n),currentPoints:Xt(t),deltaPoints:i,deltaDistance:o};pn(a.element,rn,a),function(e){const t=(new Date).getTime(),n=mn.startTime.getTime();if(t-n>vn.tapToleranceMs)return;0===vn.taps&&(vn.element=mn.element,vn.renderingEngineId=mn.renderingEngineId,vn.viewportId=mn.viewportId,vn.startPointsList=mn.startPointsList);if(vn.taps>0&&(vn.element!=mn.element||vn.renderingEngineId!=mn.renderingEngineId||vn.viewportId!=mn.viewportId))return;const i=Gt(e,vn.element),o=Kt(i,vn.startPointsList).canvas;if(o>vn.tapMaxDistance)return;clearTimeout(vn.tapTimeout),vn.taps+=1,vn.tapTimeout=setTimeout((()=>{const t={event:e,eventName:ln,element:vn.element,renderingEngineId:vn.renderingEngineId,viewportId:vn.viewportId,camera:{},currentPointsList:i,currentPoints:Xt(i),taps:vn.taps};pn(t.element,ln,t),vn=JSON.parse(JSON.stringify(un))}),vn.tapToleranceMs)}(e),mn=JSON.parse(JSON.stringify(gn)),document.removeEventListener("touchmove",fn),document.removeEventListener("touchend",En)}function wn(e,t){const{viewport:n}=(0,ne.getEnabledElement)(e);return t.map((e=>{const t=n.canvasToWorld(e.canvas);return{page:e.page,client:e.client,canvas:e.canvas,world:t,touch:e.touch}}))}const In=function(e){mn.element=e.currentTarget;const t=(0,ne.getEnabledElement)(mn.element),{renderingEngineId:n,viewportId:i}=t;mn.renderingEngineId=n,mn.viewportId=i,mn.isTouchStart||(clearTimeout(mn.pressTimeout),mn.pressTimeout=setTimeout((()=>function(e){if(mn.accumulatedDistance.canvas>mn.pressMaxDistance)return;const t={event:e,eventName:an,renderingEngineId:mn.renderingEngineId,viewportId:mn.viewportId,camera:{},element:mn.element,startPointsList:jt(mn.startPointsList),lastPointsList:jt(mn.lastPointsList),startPoints:Yt(Xt(mn.startPointsList)),lastPoints:Yt(Xt(mn.lastPointsList))};pn(t.element,an,t)}(e)),mn.pressDelay),function(e){mn.isTouchStart=!0,mn.startTime=new Date;const t=Gt(e,mn.element),n=Xt(t),i=cn,o=hn,a={event:e,eventName:nn,element:mn.element,renderingEngineId:mn.renderingEngineId,viewportId:mn.viewportId,camera:{},startPointsList:t,lastPointsList:t,currentPointsList:t,startPoints:n,lastPoints:n,currentPoints:n,deltaPoints:i,deltaDistance:o};mn.startPointsList=jt(a.startPointsList),mn.lastPointsList=jt(a.lastPointsList);pn(a.element,nn,a)&&pn(a.element,on,a)}(e),document.addEventListener("touchmove",fn),document.addEventListener("touchend",En))};function Cn(e){Ft.disable(e),e.removeEventListener("touchstart",In)}const _n={enable:function(e){Cn(e),Ft.enable(e),e.addEventListener("touchstart",In,{passive:!1})},disable:Cn},Tn=10,bn=40,Dn=800;const Sn=function(e){const t=e.currentTarget,n=(0,ne.getEnabledElement)(t),{renderingEngineId:i,viewportId:o}=n;if(e.deltaY>-1&&e.deltaY<1)return;e.preventDefault();const{spinX:a,spinY:s,pixelX:r,pixelY:l}=function(e){let t=0,n=0,i=0,o=0;return"detail"in e&&(n=e.detail),"wheelDelta"in e&&(n=-e.wheelDelta/120),"wheelDeltaY"in e&&(n=-e.wheelDeltaY/120),"wheelDeltaX"in e&&(t=-e.wheelDeltaX/120),i=t*Tn,o=n*Tn,"deltaY"in e&&(o=e.deltaY),"deltaX"in e&&(i=e.deltaX),(i||o)&&e.deltaMode&&(1===e.deltaMode?(i*=bn,o*=bn):(i*=Dn,o*=Dn)),i&&!t&&(t=i<1?-1:1),o&&!n&&(n=o<1?-1:1),{spinX:t,spinY:n,pixelX:i,pixelY:o}}(e),d=s<0?-1:1,c={event:e,eventName:re.MOUSE_WHEEL,renderingEngineId:i,viewportId:o,element:t,camera:{},detail:e,wheel:{spinX:a,spinY:s,pixelX:r,pixelY:l,direction:d},points:nt(e)};(0,ne.triggerEvent)(t,re.MOUSE_WHEEL,c)};function Mn(e){e.removeEventListener("wheel",Sn)}const yn={enable:function(e){Mn(e),e.addEventListener("wheel",Sn,{passive:!1})},disable:Mn},On={renderingEngineId:void 0,viewportId:void 0,key:void 0,keyCode:void 0,element:null};let xn={renderingEngineId:void 0,viewportId:void 0,key:void 0,keyCode:void 0,element:null};function Rn(e){xn.element=e.currentTarget;const t=(0,ne.getEnabledElement)(xn.element),{renderingEngineId:n,viewportId:i}=t;xn.renderingEngineId=n,xn.viewportId=i,xn.key=e.key,xn.keyCode=e.keyCode,e.preventDefault();const o={renderingEngineId:xn.renderingEngineId,viewportId:xn.viewportId,element:xn.element,key:xn.key,keyCode:xn.keyCode};(0,ne.triggerEvent)(o.element,re.KEY_DOWN,o),document.addEventListener("keyup",Nn),document.addEventListener("visibilitychange",Pn),xn.element.removeEventListener("keydown",Rn)}function Pn(){document.removeEventListener("visibilitychange",Pn),"hidden"===document.visibilityState&&Ln()}function Nn(e){const t={renderingEngineId:xn.renderingEngineId,viewportId:xn.viewportId,element:xn.element,key:xn.key,keyCode:xn.keyCode};document.removeEventListener("keyup",Nn),document.removeEventListener("visibilitychange",Pn),xn.element.addEventListener("keydown",Rn),xn=me()(On),(0,ne.triggerEvent)(t.element,re.KEY_UP,t)}function Ln(){xn.keyCode=void 0}const An=Rn;function kn(e){e.removeEventListener("keydown",An)}const Un={enable:function(e){kn(e),e.addEventListener("keydown",An)},disable:kn,getModifierKey:function(){return xn.keyCode}};var Vn=n(44031),Wn=n(95548);const Hn={renderOutline:!0,outlineWidthActive:2,outlineWidthInactive:2,outlineOpacity:1,outlineOpacityInactive:.85,renderFill:!0,fillAlpha:1,fillAlphaInactive:0};const Bn=function(){return Hn},Fn={renderOutline:!0,outlineWidthActive:3,outlineWidthInactive:2,renderFill:!0,renderFillInactive:!0,fillAlpha:.7,fillAlphaInactive:.65,outlineOpacity:1,outlineOpacityInactive:.85};const Gn=function(){return Fn},$n=Gn(),Kn=Bn(),qn={colorLUT:[],segmentations:[],globalConfig:{renderInactiveSegmentations:!0,representations:{[de.Labelmap]:$n,[de.Contour]:Kn}},toolGroups:{}};const zn=new class{constructor(e){e||(e=ne.utilities.uuidv4()),this.state=me()(qn),this.uid=e}getState(){return this.state}getToolGroups(){return Object.keys(this.state.toolGroups)}getColorLUT(e){return this.state.colorLUT[e]}getNextColorLUTIndex(){return this.state.colorLUT.length}resetState(){this.state=me()(qn)}getSegmentation(e){return this.state.segmentations.find((t=>t.segmentationId===e))}addSegmentation(e){if(this.getSegmentation(e.segmentationId))throw new Error(`Segmentation with id ${e.segmentationId} already exists`);this.state.segmentations.push(e)}getSegmentationRepresentations(e){const t=this.state.toolGroups[e];if(t)return t.segmentationRepresentations}getAllSegmentationRepresentations(){const e={};return Object.entries(this.state.toolGroups).forEach((([t,n])=>{e[t]=n.segmentationRepresentations})),e}addSegmentationRepresentation(e,t){this.state.toolGroups[e]||(this.state.toolGroups[e]={segmentationRepresentations:[],config:{}}),this.state.toolGroups[e].segmentationRepresentations.push(t),this._handleActiveSegmentation(e,t)}getGlobalConfig(){return this.state.globalConfig}setGlobalConfig(e){this.state.globalConfig=e}getSegmentationRepresentationByUID(e,t){return this.getSegmentationRepresentations(e).find((e=>e.segmentationRepresentationUID===t))}removeSegmentation(e){this.state.segmentations=this.state.segmentations.filter((t=>t.segmentationId!==e))}removeSegmentationRepresentation(e,t){const n=this.getSegmentationRepresentations(e);if(!n||!n.length)throw new Error(`No viewport specific segmentation state found for viewport ${e}`);const i=n.findIndex((e=>e.segmentationRepresentationUID===t));-1===i&&console.warn(`No viewport specific segmentation state data found for viewport ${e} and segmentation data UID ${t}`);const o=n[i];n.splice(i,1),this._handleActiveSegmentation(e,o)}setActiveSegmentationRepresentation(e,t){const n=this.getSegmentationRepresentations(e);if(!n||!n.length)throw new Error(`No segmentation data found for toolGroupId: ${e}`);const i=n.find((e=>e.segmentationRepresentationUID===t));if(!i)throw new Error(`No segmentation data found for segmentation data UID ${t}`);i.active=!0,this._handleActiveSegmentation(e,i)}getToolGroupSpecificConfig(e){const t=this.state.toolGroups[e];if(t)return t.config}getSegmentationRepresentationSpecificConfig(e,t){const n=this.getSegmentationRepresentationByUID(e,t);if(n)return n.segmentationRepresentationSpecificConfig}setSegmentationRepresentationSpecificConfig(e,t,n){const i=this.getSegmentationRepresentationByUID(e,t);i&&(i.segmentationRepresentationSpecificConfig=n)}getSegmentSpecificConfig(e,t,n){const i=this.getSegmentationRepresentationByUID(e,t);if(i)return i.segmentSpecificConfig[n]}setSegmentSpecificConfig(e,t,n){const i=this.getSegmentationRepresentationByUID(e,t);i&&(i.segmentSpecificConfig=n)}setSegmentationRepresentationConfig(e,t){let n=this.state.toolGroups[e];n||(this.state.toolGroups[e]={segmentationRepresentations:[],config:{renderInactiveSegmentations:!0,representations:{}}},n=this.state.toolGroups[e]),n.config={...n.config,...t}}addColorLUT(e,t){this.state.colorLUT[t]&&console.warn("Color LUT table already exists, overwriting"),this.state.colorLUT[t]=structuredClone(e)}removeColorLUT(e){delete this.state.colorLUT[e]}_handleActiveSegmentation(e,t){const n=this.getSegmentationRepresentations(e);if(0===n.length)return;if(1===n.length)return void(n[0].active=!0);0!==n.filter((e=>e.active)).length?t.active&&n.forEach((e=>{e.segmentationRepresentationUID!==t.segmentationRepresentationUID&&(e.active=!1)})):n[0].active=!0}}("DEFAULT");function jn(e){const t={segmentationId:e};(0,ne.triggerEvent)(ne.eventTarget,re.SEGMENTATION_REMOVED,t)}function Yn(e,t){const n={toolGroupId:e,segmentationRepresentationUID:t};(0,ne.triggerEvent)(ne.eventTarget,re.SEGMENTATION_REPRESENTATION_REMOVED,n)}function Zn(e,t){const n={toolGroupId:e,segmentationRepresentationUID:t};if(t)return void(0,ne.triggerEvent)(ne.eventTarget,re.SEGMENTATION_REPRESENTATION_MODIFIED,n);(oi(e)||[]).forEach((t=>{const{segmentationRepresentationUID:n}=t,i={toolGroupId:e,segmentationRepresentationUID:n};(0,ne.triggerEvent)(ne.eventTarget,re.SEGMENTATION_REPRESENTATION_MODIFIED,i)}))}function Xn(e){let t;t=e?[e]:ni().map((({segmentationId:e})=>e)),t.forEach((e=>{const t={segmentationId:e};(0,ne.triggerEvent)(ne.eventTarget,re.SEGMENTATION_MODIFIED,t)}))}function Jn(e,t){const n={segmentationId:e,modifiedSlicesToUse:t};(0,ne.triggerEvent)(ne.eventTarget,re.SEGMENTATION_DATA_MODIFIED,n)}const Qn=function(e){const{segmentationId:t,representation:n}=e;return{segmentationId:t,cachedStats:{},segmentLabels:{},label:null,segmentsLocked:new Set,type:n.type,activeSegmentIndex:1,representationData:{[n.type]:{...n.data}}}};function ei(){return zn}function ti(e){return ei().getSegmentation(e)}function ni(){return ei().getState().segmentations}function ii(e,t){const n=ei(),i=Qn(e);n.addSegmentation(i),t||Xn(i.segmentationId)}function oi(e){return ei().getSegmentationRepresentations(e)}function ai(){return ei().getAllSegmentationRepresentations()}function si(e){if(!e)throw new Error("getToolGroupIdsWithSegmentation: segmentationId is empty");const t=ei(),n=t.getState(),i=Object.keys(n.toolGroups),o=[];return i.forEach((n=>{t.getSegmentationRepresentations(n).forEach((t=>{t.segmentationId===e&&o.push(n)}))})),o}function ri(e){return ei().getToolGroupSpecificConfig(e)}function li(e,t,n){ei().setSegmentationRepresentationConfig(e,t),n||Zn(e)}function di(e,t,n,i=!1){ei().setSegmentationRepresentationSpecificConfig(e,t,n),i||Zn(e,t)}function ci(e,t){return ei().getSegmentationRepresentationSpecificConfig(e,t)}function hi(e,t,n){return ei().getSegmentSpecificConfig(e,t,n)}function gi(e,t,n,i=!1){ei().setSegmentSpecificConfig(e,t,n),i||Zn(e,t)}function ui(e,t,n){ei().addSegmentationRepresentation(e,t),n||Zn(e,t.segmentationRepresentationUID)}function mi(){return ei().getGlobalConfig()}function vi(e,t){ei().setGlobalConfig(e),t||Xn()}function pi(e,t){return ei().getSegmentationRepresentationByUID(e,t)}function fi(e){ei().removeSegmentation(e),jn(e)}function Ei(e,t){ei().removeSegmentationRepresentation(e,t),Yn(e,t)}function wi(e){ei().removeColorLUT(e)}function Ii(e){return ei().getColorLUT(e)}function Ci(){return ei().getNextColorLUTIndex()}function _i(e,t){ei().addColorLUT(e,t)}function Ti(e){return void 0!==e?.volumeId}const bi=async function(e,t,n){const i=(0,ne.getEnabledElement)(e),{renderingEngine:o,viewport:a}=i,{id:s}=a;if(Ti(t)){const e=[{volumeId:t.volumeId,actorUID:n,visibility:true,blendMode:ne.Enums.BlendModes.MAXIMUM_INTENSITY_BLEND}];await(0,ne.addVolumesToViewports)(o,e,[s],false,true)}else{const e=[{imageId:t.imageIdReferenceMap.get(a.getCurrentImageId()),actorUID:n}];await(0,ne.addImageSlicesToViewports)(o,e,[s],false,true)}};const Di=function(e,t,n=!1){const i=(0,ne.getEnabledElement)(e),{viewport:o}=i;o instanceof ne.StackViewport||o.removeVolumeActors([t])},Si=255,Mi=new Map;function yi(){const e=Wn.ZP.newInstance(),t=Vn.ZP.newInstance();return t.addPoint(0,0),{ofun:t,cfun:e}}function Oi(e,t,n,i){const o={...e,...t,...i||{}};return{fillAlpha:n?o.fillAlpha:o.fillAlphaInactive,outlineWidth:n?o.outlineWidthActive:o.outlineWidthInactive,renderFill:n?o.renderFill:o.renderFillInactive,renderOutline:o.renderOutline,outlineOpacity:n?o.outlineOpacity:o.outlineOpacityInactive}}function xi(e,t,n,{fillAlpha:i,renderFill:o,renderOutline:a,segmentColor:s,outlineWidth:r,segmentsHidden:l}){const d=`${e}-${t}-${n}`,c=Mi.get(d);if(!c)return Mi.set(d,{fillAlpha:i,renderFill:o,renderOutline:a,outlineWidth:r,segmentColor:s.slice(),segmentsHidden:new Set(l)}),{forceOpacityUpdate:!0,forceColorUpdate:!0};const{fillAlpha:h,renderFill:g,renderOutline:u,outlineWidth:m,segmentColor:v,segmentsHidden:p}=c,f=v[0]!==s[0]||v[1]!==s[1]||v[2]!==s[2],E=v[3]!==s[3]||h!==i||g!==o||u!==a||m!==r||p.has(n)!==l.has(n);return Mi.set(d,{fillAlpha:i,renderFill:o,renderOutline:a,outlineWidth:r,segmentColor:s.slice(),segmentsHidden:new Set(l)}),{forceOpacityUpdate:E,forceColorUpdate:f}}async function Ri(e,t,n){await bi(e.element,t,n)}const Pi={getRepresentationRenderingConfig:yi,render:async function(e,t,n){const{colorLUTIndex:i,active:o,segmentationId:a,segmentationRepresentationUID:s,segmentsHidden:r,config:l}=t,d=ti(a).representationData[de.Labelmap];let c=e.getActor(s);if(Ti(d)){const{volumeId:t}=d;if(!ne.cache.getVolume(t))throw new Error(`No Labelmap found for volumeId: ${t}`);if(!function(e,t){if(!t)return!0;const n=e.getDefaultActor();if(!n)return!1;const{uid:i}=n,o=ne.cache.getVolume(i);if(o){const e=ne.cache.getVolume(t);if(e&&o.metadata.FrameOfReferenceUID===e.metadata.FrameOfReferenceUID)return!0}return!1}(e,d?.referencedVolumeId))return;c||await Ri(e,d,s),c=e.getActor(s)}else{const t=e.getCurrentImageId(),{imageIdReferenceMap:n}=d;if(!n.has(t))return;c||await Ri(e,d,s),c=e.getActor(s)}if(!c)return;const{cfun:h,ofun:g}=l,u=n.renderInactiveSegmentations;!function(e,t,n,i,o,a,s,r,l,d){const{segmentSpecificConfig:c,segmentationRepresentationSpecificConfig:h}=s,g=h[de.Labelmap],u=Ii(o),m=Math.min(256,u.length),{uid:v}=t,{outlineWidth:p,renderOutline:f,outlineOpacity:E}=Oi(a,g,r);for(let t=0;t<m;t++){const o=t,s=u[o],l=c[o]?.[de.Labelmap],{fillAlpha:h,outlineWidth:m,renderFill:p,renderOutline:f}=Oi(a,g,r,l),{forceOpacityUpdate:E,forceColorUpdate:w}=xi(e,v,o,{fillAlpha:h,renderFill:p,renderOutline:f,segmentColor:s,outlineWidth:m,segmentsHidden:d});if(w&&n.addRGBPoint(o,s[0]/Si,s[1]/Si,s[2]/Si),E)if(p){const e=d.has(o)?0:s[3]/255*h;i.removePoint(o),i.addPointLong(o,e,.5,1)}else i.addPointLong(o,.01,.5,1)}const w=t.actor;w.getProperty().setRGBTransferFunction(0,n),i.setClamping(!1),w.getProperty().setScalarOpacity(0,i),w.getProperty().setInterpolationTypeToNearest(),ne.utilities.actorIsA(t,"vtkVolume")&&(w.getProperty().setUseLabelOutline(f),w.getProperty().setLabelOutlineOpacity(E),w.getProperty().setLabelOutlineThickness(p));const I=r||l;w.setVisibility(I)}(e.id,c,h,g,i,n.representations[de.Labelmap],t,o,u,r)},removeSegmentationRepresentation:function(e,t,n=!1){if(function(e,t){const n=Jv(e);if(void 0===n)throw new Error(`ToolGroup with ToolGroupId ${e} does not exist`);const{viewportsInfo:i}=n;for(const e of i){const{viewportId:n,renderingEngineId:i}=e,o=(0,ne.getEnabledElementByIds)(n,i);Di(o.viewport.element,t)}}(e,t),Ei(e,t),n){Jv(e).getViewportsInfo().forEach((({viewportId:e,renderingEngineId:t})=>{(0,ne.getEnabledElementByIds)(e,t).viewport.render()}))}}};var Ni=n(54131),Li=n(8389),Ai=n(16623),ki=n(93702),Ui=n(17197),Vi=n(23834),Wi=n(48663);function Hi(e,t,n){let i=e.segmentSpecificConfig?.[t];return i||(i=e.segmentSpecificConfig?.[n]),i?i.CONTOUR:null}const Bi=new Map;function Fi(e){return Bi.get(e)}function Gi(e,t){Bi.set(e,t)}function $i(e,t,n,i,o){const{segmentationRepresentationUID:a,segmentsHidden:s}=n,r=Li.ZP.newInstance(),l=new Map,d=new Map;t.forEach((e=>{const t=ne.cache.getGeometry(e);if(!t)return void console.warn(`No geometry found for geometryId ${e}. Skipping render.`);const i=t.data.getSegmentIndex();!function(e){if(!e)throw new Error(`No contours found for geometryId ${e.id}`);const t=e.id;if(e.type!==ne.Enums.GeometryType.CONTOUR)throw new Error(`Geometry type ${e.type} not supported for rendering.`);e.data||console.warn(`No contours found for geometryId ${t}. Skipping render.`)}(t);const o=Hi(n,e,i),a=t.data,c=function(e){const t=[],n=Vi.ZP.newInstance(),i=Ui.ZP.newInstance();let o=0;e.getContours().forEach((e=>{const n=e.getPoints(),a=e.getFlatPointsArray(),s=e.getType(),r=n.map(((e,t)=>t+o));s===ne.Enums.ContourType.CLOSED_PLANAR&&r.push(r[0]);const l=Float32Array.from(a);t.push(...l),i.insertNextCell([...r]),o+=n.length})),n.setData(t,3);const a=Wi.ZP.newInstance();return a.setPoints(n),a.setLines(i),a}(a),h=a.getColor(),g=c.getPoints().getNumberOfPoints(),u=Ni.ZP.newInstance({size:4*g,numberOfComponents:4,dataType:"Uint8Array"});for(let e=0;e<g;++e)u.setTuple(e,[...h,255]);c.getPointData().setScalars(u),o&&d.set(i,o),l.set(i,[...h,s.has(i)?0:255]),0===i?r.setInputData(c):r.addInputData(c)}));const c=r.getOutputData(),h=i.representations.CONTOUR.outlineWidthActive,g=ki.ZP.newInstance();g.setInputData(c);const u=Ai.ZP.newInstance();u.setMapper(g),u.getProperty().setLineWidth(h),Gi(a,Object.assign({},Fi(a),{segmentsHidden:new Set(s),segmentSpecificMap:d,outlineWidthActive:h})),u.setForceOpaque(!0),e.addActor({uid:o,actor:u}),e.resetCamera(),e.render()}function Ki(e,t,n,i,o){const{segmentationRepresentationUID:a,segmentsHidden:s}=n,r=i.representations.CONTOUR,l=Fi(a),d=e.getActor(o);if(!d)return void console.warn(`No contour actor found for actorUID ${o}. Skipping render.`);const{actor:c}=d,h=r.outlineWidthActive;l?.outlineWidthActive!==h&&(c.getProperty().setLineWidth(h),Gi(a,Object.assign({},l,{outlineWidthActive:h})));const g=c.getMapper(),u=g.getLookupTable(),m=[],v=[];for(const e of s)l.segmentsHidden.has(e)||m.push(e);for(const e of l.segmentsHidden)s.has(e)||v.push(e);const p=Array.from(l.segmentsHidden).filter((e=>!v.includes(e))).concat(m),{contourSets:f,segmentSpecificConfigs:E}=t.reduce(((e,t)=>{const i=ne.cache.getGeometry(t),{data:o}=i,a=o.getSegmentIndex(),s=Hi(n,t,a);return e.contourSets.push(o),e.segmentSpecificConfigs[a]=s??{},e}),{contourSets:[],segmentSpecificConfigs:{}}),w=[...p,...v],I=Object.values(E).some((e=>Object.keys(e).length>0));let C=!1;if(w.length||I){const e=g.getInputData(),t=e.getPointData().getScalars().getData();let n=0;f.forEach((e=>{const i=e.getSegmentIndex(),o=e.getTotalNumberOfPoints();if(w.includes(i)||E[i]?.fillAlpha){const a=e.getColor();let s=p.includes(i)?0:255;const r=E[i];void 0!==r.fillAlpha&&(s=255*r.fillAlpha);for(let e=0;e<o;++e)t[n+4*e]=a[0],t[n+4*e+1]=a[1],t[n+4*e+2]=a[2],t[n+4*e+3]=s;C=!0}n+=4*o})),C&&e.modified(),Gi(a,Object.assign({},l,{segmentsHidden:new Set(s)})),g.setLookupTable(u)}e.render()}const qi=function(e,t,n=!1){const i=(0,ne.getEnabledElement)(e),{viewport:o}=i,a=o.getActors().map((({uid:e})=>e.includes(t)?e:void 0)).filter(Boolean);o.removeActors(a)};const zi={render:async function(e,t,n){const{segmentationId:i}=t,o=ti(i).representationData[de.Contour],{geometryIds:a}=o;e instanceof ne.StackViewport||(a?.length||console.warn(`No contours found for segmentationId ${i}. Skipping render.`),function(e,t,n,i){const{segmentationRepresentationUID:o}=n,a=`CONTOUR_${o}`;(e.getActor(a)?Ki:$i)(e,t,n,i,a)}(e,a,t,n))},removeSegmentationRepresentation:function(e,t,n=!1){if(function(e,t){const n=Jv(e);if(void 0===n)throw new Error(`ToolGroup with ToolGroupId ${e} does not exist`);const{viewportsInfo:i}=n;for(const e of i){const{viewportId:n,renderingEngineId:i}=e,o=(0,ne.getEnabledElementByIds)(n,i);qi(o.viewport.element,t)}}(e,t),Ei(e,t),function(e){Bi.delete(e)}(t),n){Jv(e).getViewportsInfo().forEach((({viewportId:e,renderingEngineId:t})=>{(0,ne.getEnabledElementByIds)(e,t).viewport.render()}))}}};const ji=function(e,t,n){const i=oi(e);if(!i||0===i.length)return;const o=i.map((e=>e.segmentationRepresentationUID));let a=t;if(a){const e=t.filter((e=>!o.includes(e)));if(e.length>0)throw new Error(`The following segmentationRepresentationUIDs are not part of the toolGroup: ${JSON.stringify(e)}`)}else a=o;a.forEach((t=>{!function(e,t,n){const i=pi(e,t),{type:o}=i;if(o===de.Labelmap)Pi.removeSegmentationRepresentation(e,t,n);else{if(o!==de.Contour)throw new Error(`The representation ${o} is not supported yet`);zi.removeSegmentationRepresentation(e,t,n)}}(e,t,n)}))};const Yi=function(e){if(!e.representation.data)throw new Error("The segmentationInput.representationData.data is undefined, please provide a valid representationData.data");const t=e.representation.data;if("volumeId"in t){if(!ne.cache.getVolume(t.volumeId))throw new Error(`volumeId of ${t.volumeId} not found in cache, you should load and cache volume before adding segmentation`)}};const Zi=function(e){if(!e||!e.length)throw new Error("The segmentationInputArray is undefined or empty array");e.forEach((e=>{if(void 0===e.segmentationId)throw new Error("The segmentationInput.segmentationId is undefined, please provide a valid segmentationId");if(void 0===e.representation)throw new Error("The segmentationInput.representation is undefined, please provide a valid representation");e.representation.type===de.Labelmap&&Yi(e)}))};const Xi=function(e){Zi(e),e.map((e=>{ii(me()(e))}))};function Ji(){return mi()}function Qi(e){vi(e)}function eo(e){return Ji().representations[e]}function to(e,t){const n=Ji();Qi({...n,representations:{...n.representations,[e]:{...n.representations[e],...t}}})}function no(e){return ri(e)}function io(e,t){li(e,t)}function oo(e,t){return ci(e,t)}function ao(e,t,n){di(e,t,n)}function so(e,t,n){return hi(e,t,n)}function ro(e,t,n){gi(e,t,n)}function lo(e){const{type:t}=e;return t===de.Labelmap?yi():{}}const co=[[0,0,0,0],[221,84,84,255],[77,228,121,255],[166,70,235,255],[189,180,116,255],[109,182,196,255],[204,101,157,255],[123,211,94,255],[93,87,218,255],[225,128,80,255],[73,232,172,255],[181,119,186,255],[176,193,112,255],[105,153,200,255],[208,97,120,255],[90,215,101,255],[135,83,222,255],[229,178,76,255],[122,183,181,255],[190,115,171,255],[149,197,108,255],[100,118,205,255],[212,108,93,255],[86,219,141,255],[183,79,226,255],[233,233,72,255],[118,167,187,255],[194,111,146,255],[116,201,104,255],[115,96,209,255],[216,147,89,255],[82,223,188,255],[230,75,224,255],[163,184,121,255],[114,143,191,255],[198,107,114,255],[99,206,122,255],[153,92,213,255],[220,192,85,255],[78,215,227,255],[234,71,173,255],[141,188,117,255],[110,113,195,255],[202,128,103,255],[95,210,157,255],[195,88,217,255],[206,224,81,255],[74,166,231,255],[185,120,139,255],[113,192,113,255],[133,106,199,255],[207,162,98,255],[91,214,198,255],[221,84,198,255],[159,228,77,255],[70,111,235,255],[189,119,116,255],[109,196,138,255],[165,101,204,255],[211,201,94,255],[87,191,218,255],[225,80,153,255],[106,232,73,255],[124,119,186,255],[193,142,112,255],[105,200,168,255],[203,97,208,255],[184,215,90,255],[83,147,222,255],[229,76,101,255],[122,183,130,255],[146,115,190,255],[197,171,108,255],[100,205,205,255],[212,93,177,255],[141,219,86,255],[79,97,226,255],[233,99,72,255],[118,187,150,255],[173,111,194,255],[197,201,104,255],[96,171,209,255],[216,89,137,255],[94,223,82,255],[107,75,230,255],[184,153,121,255],[114,191,175,255],[198,107,191,255],[166,206,99,255],[92,132,213,255],[220,85,91,255],[78,227,115,255],[159,71,234,255],[188,176,117,255],[110,185,195,255],[202,103,161,255],[129,210,95,255],[88,88,217,255],[224,123,81,255],[74,231,166,255],[177,120,185,255],[179,192,113,255],[106,156,199,255],[207,98,125,255],[91,214,96,255],[130,84,221,255],[228,171,77,255],[70,235,221,255],[189,116,174,255],[153,196,109,255],[101,123,204,255],[211,104,94,255],[87,218,136,255],[177,80,225,255],[232,225,73,255],[119,169,186,255],[193,112,149,255],[121,200,105,255],[111,97,208,255],[215,142,90,255],[83,222,181,255],[229,76,229,255],[165,183,122,255],[115,146,190,255],[197,108,119,255],[100,205,118,255],[148,93,212,255],[219,186,86,255],[79,220,226,255],[233,72,179,255],[144,187,118,255],[111,118,194,255],[201,124,104,255],[96,209,153,255],[189,89,216,255],[211,223,82,255],[75,172,230,255],[184,121,142,255],[117,191,114,255],[130,107,198,255],[206,157,99,255],[92,213,193,255],[220,85,203,255],[165,227,78,255],[71,118,234,255],[188,117,117,255],[110,195,135,255],[161,103,202,255],[210,195,95,255],[88,195,217,255],[224,81,158,255],[113,231,74,255],[123,120,185,255],[192,139,113,255],[106,199,164,255],[198,98,207,255],[188,214,91,255],[84,153,221,255],[228,77,108,255],[70,235,84,255],[143,116,189,255],[196,167,109,255],[101,204,199,255],[211,94,182,255],[147,218,87,255],[80,104,225,255],[232,93,73,255],[119,186,147,255],[170,112,193,255],[200,200,105,255],[97,175,208,255],[215,90,142,255],[100,222,83,255],[101,76,229,255],[183,150,122,255],[115,190,171,255],[197,108,194,255],[170,205,100,255],[93,138,212,255],[219,86,97,255],[79,226,110,255],[153,72,233,255],[187,173,118,255],[111,187,194,255],[201,104,165,255],[134,209,96,255],[89,95,216,255],[223,117,82,255],[75,230,159,255],[174,121,184,255],[182,191,114,255],[107,160,198,255],[206,99,130,255],[92,213,92,255],[124,85,220,255],[227,165,78,255],[71,234,214,255],[188,117,176,255],[156,195,110,255],[103,128,202,255],[210,100,95,255],[88,217,131,255],[170,81,224,255],[231,218,74,255],[120,172,185,255],[192,113,153,255],[125,199,106,255],[107,98,207,255],[214,137,91,255],[84,221,175,255],[222,77,228,255],[194,235,70,255],[116,149,189,255],[196,109,123,255],[101,204,114,255],[143,94,211,255],[218,180,87,255],[80,225,225,255],[232,73,186,255],[147,186,119,255],[112,122,193,255],[200,121,105,255],[97,208,148,255],[184,90,215,255],[216,222,83,255],[76,178,229,255],[183,122,145,255],[121,190,115,255],[126,108,197,255],[205,153,100,255],[93,212,187,255],[219,86,208,255],[171,226,79,255],[72,126,233,255],[187,118,121,255],[111,194,132,255],[157,104,201,255],[209,190,96,255],[89,200,216,255],[223,82,164,255],[120,230,75,255],[121,121,184,255],[191,136,114,255],[107,198,160,255],[192,99,206,255],[193,213,92,255],[85,158,220,255],[227,78,115,255],[71,234,78,255],[141,117,188,255],[195,163,110,255],[103,202,194,255],[210,95,186,255],[153,217,88,255],[81,111,224,255]];const ho=async function(e,t,n){if(!Jv(e))throw new Error(`No tool group found for toolGroupId: ${e}`);const i=t.map((t=>async function(e,t,n){const{segmentationId:i,options:o={}}=t,a=ne.utilities.uuidv4(),s=new Set,r=o.colorLUTOrIndex;let l;if("number"==typeof r)l=r;else{const e=Ci();_i(Array.isArray(r)?r:co,e),l=e}const d={segmentationId:i,segmentationRepresentationUID:a,type:t.type,segmentsHidden:s,colorLUTIndex:l,active:!0,segmentationRepresentationSpecificConfig:{},segmentSpecificConfig:{},config:lo(t)};if(n){const t=no(e),i=ne.utilities.deepMerge(t,n);io(e,{renderInactiveSegmentations:i.renderInactiveSegmentations||!0,representations:{...i.representations}})}return ui(e,d),a}(e,t,n)));return await Promise.all(i)};function go(e){const t=ei().getSegmentationRepresentations(e);if(!t)return;return t.find((e=>e.active))}function uo(e,t){ei().setActiveSegmentationRepresentation(e,t),Zn(e,t)}function mo(e,t){const n=ti(e);if(!n)throw new Error(`No segmentation state found for ${e}`);const{segmentsLocked:i}=n;return i.has(t)}function vo(e,t,n=!0){const i=ti(e);if(!i)throw new Error(`No segmentation state found for ${e}`);const{segmentsLocked:o}=i;n?o.add(t):o.delete(t),Xn(e)}function po(e){const t=ti(e);if(!t)throw new Error(`No segmentation state found for ${e}`);const{segmentsLocked:n}=t;return Array.from(n)}function fo(e,t){if(!e)throw new Error("addColorLUT: colorLUT is required");ne.utilities.isEqual(e[0],[0,0,0,0])||(console.warn("addColorLUT: [0, 0, 0, 0] color is not provided for the background color (segmentIndex =0), automatically adding it"),e.unshift([0,0,0,0])),_i(e,t)}function Eo(e,t,n){const i=pi(e,t);if(!i)throw new Error(`setColorLUT: could not find segmentation representation with UID ${t}`);if(!Ii(n))throw new Error(`setColorLUT: could not find colorLUT with index ${n}`);i.colorLUTIndex=n,Zn(e,t)}function wo(e,t,n){const i=pi(e,t);if(!i)throw new Error(`segmentation representation with UID ${t} does not exist for tool group ${e}`);const{colorLUTIndex:o}=i,a=Ii(o);let s=a[n];if(!s){if("number"!=typeof n)throw new Error(`Can't create colour for LUT index ${n}`);s=a[n]=[0,0,0,0]}return s}function Io(e,t,n,i){const o=wo(e,t,n);for(let e=0;e<i.length;e++)o[e]=i[e];Zn(e,t)}function Co(e,t,n){const i=oi(e);if(!i)return;const o=i.find((e=>e.segmentationRepresentationUID===t));if(!o)return;const{segmentsHidden:a,segmentationId:s}=o,r=function(e){const t=ti(e),n=(e,t)=>{for(let n=0;n<e.length;n++)t[e[n]]=!0};if(t.type===de.Labelmap){const i={};if(t.representationData.LABELMAP.volumeId){const t=ne.cache.getVolume(e);n(t.getScalarData(),i)}else{const{imageIdReferenceMap:e}=t.representationData.LABELMAP;e.forEach((e=>{const t=ne.cache.getImage(e);n(t.getPixelData(),i)}))}return Object.keys(i).map((e=>parseInt(e,10))).filter((e=>0!==e))}if(t.type===de.Contour){const n=t.representationData.CONTOUR?.geometryIds;if(!n)throw new Error(`No geometryIds found for segmentationId ${e}`);return n.map((e=>ne.cache.getGeometry(e).data.getSegmentIndex()))}}(s);n?a.clear():r.forEach((e=>{a.add(e)})),Zn(e,o.segmentationRepresentationUID)}function _o(e,t){const n=oi(e).find((e=>e.segmentationRepresentationUID===t));if(!n)return;const{segmentsHidden:i}=n;return 0===i.size}function To(e,t,n,i){const o=pi(e,t);o&&(n.forEach((e=>{i?o.segmentsHidden.delete(e):o.segmentsHidden.add(e)})),Zn(e,t))}function bo(e,t,n,i){const o=pi(e,t);o&&(i?o.segmentsHidden.delete(n):o.segmentsHidden.add(n),Zn(e,t))}function Do(e,t){const n=ti(e);n?.activeSegmentIndex!==t&&(n.activeSegmentIndex=t,Xn(e))}function So(e){const t=ti(e);if(t)return t.activeSegmentIndex}class Mo{constructor(e,t){const n=ne.utilities.deepMerge(t,e),{configuration:i={},supportedInteractionTypes:o,toolGroupId:a}=n;i.strategies||(i.strategies={},i.defaultStrategy=void 0,i.activeStrategy=void 0,i.strategyOptions={}),this.toolGroupId=a,this.supportedInteractionTypes=o||[],this.configuration=Object.assign({},i),this.mode=ie.Disabled}getToolName(){return this.constructor.toolName}applyActiveStrategy(e,t){const{strategies:n,activeStrategy:i}=this.configuration;return n[i]?.call(this,e,t)}applyActiveStrategyCallback(e,t,n){const{strategies:i,activeStrategy:o}=this.configuration;return i[o][n]?.call(this,e,t)}setConfiguration(e){this.configuration=ne.utilities.deepMerge(this.configuration,e)}setActiveStrategy(e){this.setConfiguration({activeStrategy:e})}getTargetVolumeId(e){if(this.configuration.volumeId)return this.configuration.volumeId;const t=e.getActors();return t?t.find((e=>"vtkVolume"===e.actor.getClassName()))?.uid:void 0}getTargetIdImage(e,t){if(e.startsWith("imageId:")){const n=e.split("imageId:")[1],i=ne.utilities.imageIdToURI(n);let o=ne.utilities.getViewportsWithImageURI(i,t.id);if(!o||!o.length)return;if(o=o.filter((e=>e.getCurrentImageId()===n)),!o||!o.length)return;return o[0].getImageData()}if(e.startsWith("volumeId:")){const n=e.split("volumeId:")[1],i=ne.utilities.getViewportsWithVolumeId(n,t.id);if(!i||!i.length)return;return i[0].getImageData()}if(e.startsWith("videoId:")){const n=ne.utilities.imageIdToURI(e),i=ne.utilities.getViewportsWithImageURI(n,t.id);if(!i||!i.length)return;return i[0].getImageData()}throw new Error('getTargetIdImage: targetId must start with "imageId:" or "volumeId:"')}getTargetId(e){if(e instanceof ne.StackViewport)return`imageId:${e.getCurrentImageId()}`;if(e instanceof ne.BaseVolumeViewport)return`volumeId:${this.getTargetVolumeId(e)}`;if(e instanceof ne.VideoViewport)return`videoId:${e.getCurrentImageId()}`;throw new Error("getTargetId: viewport must be a StackViewport or VolumeViewport")}}Mo.toolName="BaseTool";const yo=Mo;var Oo=n(45451);const xo="viewport-element";function Ro(e,t){if(Je.svgNodeCache[e])return Je.svgNodeCache[e][t]?Je.svgNodeCache[e][t].domRef:void 0}function Po(e,t,n,i){if(!Je.svgNodeCache[t])return null;Je.svgNodeCache[t][i]={touched:!0,domRef:n},e.appendChild(n)}function No(e,t){Je.svgNodeCache[e]&&Je.svgNodeCache[e][t]&&(Je.svgNodeCache[e][t].touched=!0)}function Lo(e,t){Je.svgNodeCache[t]&&Object.keys(Je.svgNodeCache[t]).forEach((n=>{const i=Je.svgNodeCache[t][n];!i.touched&&i.domRef&&(e.removeChild(i.domRef),delete Je.svgNodeCache[t][n])}))}const Ao=function(e){const t=(0,ne.getEnabledElement)(e),{viewportId:n,renderingEngineId:i}=t,o=`${n}:${i}`,a=function(e){const t=`.${xo}`,n=e.querySelector(t);return n.querySelector(":scope > .svg-layer")}(e);return Object.keys(Je.svgNodeCache[o]).forEach((e=>{Je.svgNodeCache[o][e].touched=!1})),{svgLayerElement:a,svgNodeCacheForCanvas:Je.svgNodeCache,getSvgNode:Ro.bind(this,o),appendNode:Po.bind(this,a,o),setNodeTouched:No.bind(this,o),clearUntouched:Lo.bind(this,a,o)}};const ko=function(e,t){const n=Ao(e);t(n),n.clearUntouched()};const Uo=function(e,t,n){return`${e}::${t}::${n}`};const Vo=function(e,t){Object.keys(e).forEach((n=>{const i=t.getAttribute(n),o=e[n];void 0===o||""===o?t.removeAttribute(n):i!==o&&t.setAttribute(n,o)}))};const Wo=function(e,t){Object.keys(e).forEach((n=>{const i=e[n];void 0!==i&&""!==i&&t.setAttribute(n,i)}))};const Ho=function(e,t,n,i,o,a={},s=""){const{color:r,fill:l,width:d,lineWidth:c,lineDash:h,fillOpacity:g,strokeOpacity:u}=Object.assign({color:"dodgerblue",fill:"transparent",width:"2",lineDash:void 0,lineWidth:void 0,strokeOpacity:1,fillOpacity:1},a),m=c||d,v=Uo(t,"circle",n),p=e.getSvgNode(v),f={cx:`${i[0]}`,cy:`${i[1]}`,r:`${o}`,stroke:r,fill:l,"stroke-width":m,"stroke-dasharray":h,"fill-opacity":g,"stroke-opacity":u};if(p)Vo(f,p),e.setNodeTouched(v);else{const t=document.createElementNS("http://www.w3.org/2000/svg","circle");""!==s&&t.setAttribute("data-id",s),Wo(f,t),e.appendNode(t,v)}};const Bo=function(e,t,n,i,o={},a=""){const{color:s,width:r,lineWidth:l,lineDash:d}=Object.assign({color:"dodgerblue",width:"2",lineWidth:void 0,lineDash:void 0},o),c=l||r,h=Uo(t,"ellipse",n),g=e.getSvgNode(h),[u,m,v,p]=i,f=Math.hypot(v[0]-p[0],v[1]-p[1]),E=Math.hypot(m[0]-u[0],m[1]-u[1]),w=180*Math.atan2(v[1]-p[1],v[0]-p[0])/Math.PI,I=[(v[0]+p[0])/2,(m[1]+u[1])/2],C={cx:`${I[0]}`,cy:`${I[1]}`,rx:`${f/2}`,ry:`${E/2}`,stroke:s,fill:"transparent",transform:`rotate(${w} ${I[0]} ${I[1]})`,"stroke-width":c,"stroke-dasharray":d};if(g)Vo(C,g),e.setNodeTouched(h);else{const t=document.createElementNS("http://www.w3.org/2000/svg","ellipse");""!==a&&t.setAttribute("data-id",a),Wo(C,t),e.appendNode(t,h)}};const Fo=function(e,t,n,i,o,a={},s=""){const r=[(i[0]+o[0])/2,i[1]],l=[(i[0]+o[0])/2,o[1]],d=[i[0],(i[1]+o[1])/2],c=[o[0],(i[1]+o[1])/2];Bo(e,t,n,[l,r,d,c],{},"")};const Go=function(e,t,n,i,o={},a){const{color:s,handleRadius:r,width:l,lineWidth:d,fill:c,type:h,opacity:g}=Object.assign({color:"dodgerblue",handleRadius:"6",width:"2",lineWidth:void 0,fill:"transparent",type:"circle",opacity:1},o),u=d||l,m=Uo(t,"handle",`hg-${n}-index-${a}`);let v;if("circle"===h)v={cx:`${i[0]}`,cy:`${i[1]}`,r,stroke:s,fill:c,"stroke-width":u,opacity:g};else{if("rect"!==h)throw new Error(`Unsupported handle type: ${h}`);{const e=1.5*parseFloat(r);v={x:`${i[0]-.5*e}`,y:`${i[1]-.5*e}`,width:`${e}`,height:`${e}`,stroke:s,fill:c,"stroke-width":u,rx:""+.1*e,opacity:g}}}const p=e.getSvgNode(m);if(p)Vo(v,p),e.setNodeTouched(m);else{const t=document.createElementNS("http://www.w3.org/2000/svg",h);Wo(v,t),e.appendNode(t,m)}};const $o=function(e,t,n,i,o={}){i.forEach(((i,a)=>{Go(e,t,n,i,o,a)}))};function Ko(e,t,n,i,o,a={},s=""){if(isNaN(i[0])||isNaN(i[1])||isNaN(o[0])||isNaN(o[1]))return;const{color:r,width:l,lineWidth:d,lineDash:c,shadow:h}=Object.assign({color:"dodgerblue",width:"2",lineWidth:void 0,lineDash:void 0,shadow:void 0},a),g=d||l,u=Uo(t,"line",n),m=e.getSvgNode(u),v=h?`filter:url(#shadow-${e.svgLayerElement.id});`:"",p={x1:`${i[0]}`,y1:`${i[1]}`,x2:`${o[0]}`,y2:`${o[1]}`,stroke:r,style:v,"stroke-width":g,"stroke-dasharray":c};if(m)Vo(p,m),e.setNodeTouched(u);else{const t=document.createElementNS("http://www.w3.org/2000/svg","line");""!==s&&t.setAttribute("data-id",s),Wo(p,t),e.appendNode(t,u)}}function qo(e,t,n,i,o){if(i.length<2)return;const{fillColor:a,fillOpacity:s,color:r,width:l,lineWidth:d,lineDash:c}=Object.assign({color:"dodgerblue",width:"2",fillColor:"none",fillOpacity:0,lineWidth:void 0,lineDash:void 0,connectLastToFirst:!1},o),h=d||l,g=Uo(t,"polyline",n),u=e.getSvgNode(g);let m="";for(const e of i)m+=`${e[0]}, ${e[1]} `;if(o.connectLastToFirst){const e=i[0];m+=`${e[0]}, ${e[1]}`}const v={points:m,stroke:r,fill:a,"fill-opacity":s,"stroke-width":h,"stroke-dasharray":c};if(u)Vo(v,u),e.setNodeTouched(g);else{const t=document.createElementNS("http://www.w3.org/2000/svg","polyline");Wo(v,t),e.appendNode(t,g)}}function zo(e){const t=document.createElementNS("http://www.w3.org/2000/svg","tspan");return t.setAttribute("x","0"),t.setAttribute("dy","1.2em"),t.textContent=e,t}function jo(e,t){let n=e.querySelector("rect.background");if(!t)return n&&e.removeChild(n),e.getBBox();n||(n=document.createElementNS("http://www.w3.org/2000/svg","rect"),n.setAttribute("class","background"),e.insertBefore(n,e.firstChild));const i=e.getBBox(),o={x:`${i.x}`,y:`${i.y}`,width:`${i.width}`,height:`${i.height}`,fill:t};return Vo(o,n),i}const Yo=function(e,t,n,i,o,a={}){return function(e,t,n,i=[""],o,a){const{padding:s,color:r,fontFamily:l,fontSize:d,background:c}=a;let h;const[g,u]=[o[0]+s,o[1]+s],m="http://www.w3.org/2000/svg",v=Uo(t,"text",n),p=e.getSvgNode(v);if(p){const t=p.querySelector("text"),n=Array.from(t.children);for(let e=0;e<n.length;e++){const t=n[e],o=i[e]||"";t.textContent=o}if(i.length>n.length){for(let e=0;e<i.length-n.length;e++){const o=zo(i[e+n.length]);t.appendChild(o)}p.appendChild(t),e.appendNode(p,v)}const o={transform:`translate(${g} ${u})`};Vo({fill:r,"font-size":d,"font-family":l},t),Vo(o,p),h=jo(p,c),e.setNodeTouched(v)}else{const t=document.createElementNS(m,"g");t.setAttribute("transform",`translate(${g} ${u})`);const n=function(e,t){const{color:n,fontFamily:i,fontSize:o}=t,a="http://www.w3.org/2000/svg",s=document.createElementNS(a,"text"),r="user-select: none; pointer-events: none; -webkit-tap-highlight-color:  rgba(255, 255, 255, 0);",l=`filter:url(#shadow-${e.svgLayerElement.id});`,d=`${r}${l}`;return s.setAttribute("x","0"),s.setAttribute("y","0"),s.setAttribute("fill",n),s.setAttribute("font-family",i),s.setAttribute("font-size",o),s.setAttribute("style",d),s}(e,a);for(let e=0;e<i.length;e++){const t=zo(i[e]);n.appendChild(t)}t.appendChild(n),e.appendNode(t,v),h=jo(t,c)}return Object.assign({},h,{x:g,y:u,height:h.height+s,width:h.width+s})}(e,t,n,i,o,Object.assign({fontFamily:"Helvetica, Arial, sans-serif",fontSize:"14px",color:"rgb(255, 255, 0)",background:"",padding:25,centerX:!1,centerY:!0},a))};function Zo(e,t){let n=[0,0],i=Number.MAX_SAFE_INTEGER;return e.forEach((function(e){const o=function(e,t){const[n,i]=e,[o,a]=t;return Math.sqrt(Math.pow(n-o,2)+Math.pow(i-a,2))}(t,e);o<i&&(i=o,n=[...e])})),n}const Xo=function(e,t,n,i,o,a,s={}){const r=i.length>0?Zo(i,o):o,l=function(e){const{x:t,y:n,height:i,width:o}=e,a=o/2,s=i/2;return[[t+a,n],[t,n+s],[t+a,n+i],[t+o,n+s]]}(a);Ko(e,t,`link-${n}`,r,Zo(l,r),Object.assign({color:"rgb(255, 255, 0)",lineWidth:"1",lineDash:"2,3"},s))};const Jo=function(e,t,n,i,o,a,s,r={}){const l=Object.assign({handleRadius:"6",centering:{x:!1,y:!0}},r),d=Yo(e,t,n,i,o,l);return Xo(e,t,n,a,o,d,l),d};function Qo(e,t,n,i,o,a={},s=""){const{color:r,width:l,lineWidth:d,lineDash:c}=Object.assign({color:"dodgerblue",width:"2",lineWidth:void 0,lineDash:void 0},a),h=d||l,g=Uo(t,"rect",n),u=e.getSvgNode(g),m=[Math.min(i[0],o[0]),Math.min(i[1],o[1])],v=Math.abs(i[0]-o[0]),p=Math.abs(i[1]-o[1]),f={x:`${m[0]}`,y:`${m[1]}`,width:`${v}`,height:`${p}`,stroke:r,fill:"transparent","stroke-width":h,"stroke-dasharray":c};if(u)Vo(f,u),e.setNodeTouched(g);else{const t=document.createElementNS("http://www.w3.org/2000/svg","rect");""!==s&&t.setAttribute("data-id",s),Wo(f,t),e.appendNode(t,g)}}function ea(e,t,n,i,o,a={}){if(isNaN(i[0])||isNaN(i[1])||isNaN(o[0])||isNaN(o[1]))return;const{color:s,width:r,lineWidth:l,lineDash:d}=Object.assign({color:"dodgerblue",width:"2",lineWidth:void 0,lineDash:void 0},a);Ko(e,t,n,i,o,{color:s,width:r,lineWidth:l,lineDash:d});const c=Math.atan2(o[1]-i[1],o[0]-i[0]),h={start:[o[0]-10*Math.cos(c-Math.PI/7),o[1]-10*Math.sin(c-Math.PI/7)],end:o},g={start:[o[0]-10*Math.cos(c+Math.PI/7),o[1]-10*Math.sin(c+Math.PI/7)],end:o};Ko(e,t,"2",h.start,h.end,{color:s,width:r,lineWidth:l}),Ko(e,t,"3",g.start,g.end,{color:s,width:r,lineWidth:l})}function ta(e,t,n,i,o,a={}){const{color:s,width:r,lineWidth:l,lineDash:d}=Object.assign({color:"dodgerblue",width:"2",lineWidth:void 0,lineDash:void 0},a),c=l||r,h=Uo(t,"rect",n),g=e.getSvgNode(h),u=[Math.min(i[0],o[0]),Math.min(i[1],o[1])],m=Math.abs(i[0]-o[0]),v=Math.abs(i[1]-o[1]),p={x:`${u[0]}`,y:`${u[1]}`,width:`${m}`,height:`${v}`,stroke:s,fill:"black","stroke-width":c,"stroke-dasharray":d};if(g)Vo(p,g),e.setNodeTouched(h);else{const t=document.createElementNS("http://www.w3.org/2000/svg","rect");Wo(p,t),e.appendNode(t,h)}}function na(e,t){const n=(0,ne.getEnabledElement)(e),{renderingEngineId:i,viewportId:o}=n,a=Mv(o,i);if(!a)return[];const s=[],r=Object.keys(a.toolOptions);for(let e=0;e<r.length;e++){const n=r[e],i=a.toolOptions[n];if(i&&t.includes(i.mode)){const e=a.getToolInstance(n);s.push(e)}}return s}const{Active:ia,Passive:oa,Enabled:aa}=ie;const sa=new class{constructor(){this._needsRender=new Set,this._animationFrameSet=!1,this._animationFrameHandle=null,this._renderFlaggedViewports=()=>{this._throwIfDestroyed();const e=Array.from(this._viewportElements.values());for(let t=0;t<e.length;t++){const n=e[t];if(this._needsRender.has(n)&&(this._triggerRender(n),this._needsRender.delete(n),0===this._needsRender.size))return this._animationFrameSet=!1,void(this._animationFrameHandle=null)}},this._viewportElements=new Map}addViewportElement(e,t){this._viewportElements.set(e,t)}removeViewportElement(e,t){this._viewportElements.delete(e),this._needsRender.delete(t),this._reset()}renderViewport(e){this._setViewportsToBeRenderedNextFrame([e])}_throwIfDestroyed(){if(this.hasBeenDestroyed)throw new Error("this.destroy() has been manually called to free up memory, can not longer use this instance. Instead make a new one.")}_setAllViewportsToBeRenderedNextFrame(){[...this._viewportElements.values()].forEach((e=>{this._needsRender.add(e)})),this._renderFlaggedViewports()}_setViewportsToBeRenderedNextFrame(e){const t=[...this._viewportElements.values()];e.forEach((e=>{-1!==t.indexOf(e)&&this._needsRender.add(e)})),this._render()}_render(){this._needsRender.size>0&&!1===this._animationFrameSet&&(this._animationFrameHandle=window.requestAnimationFrame(this._renderFlaggedViewports),this._animationFrameSet=!0)}_triggerRender(e){const t=(0,ne.getEnabledElement)(e);if(!t)return void console.warn("Element has been disabled");if(!(0,ne.getRenderingEngine)(t.renderingEngineId))return void console.warn("rendering Engine has been destroyed");const n=na(e,[ia,oa,aa]),{renderingEngineId:i,viewportId:o}=t,a={element:e,renderingEngineId:i,viewportId:o};ko(e,(i=>{let o=!1;n.forEach((e=>{if(e.renderAnnotation){const n=e.renderAnnotation(t,i);o=o||n}})),o&&(0,ne.triggerEvent)(e,re.ANNOTATION_RENDERED,{...a})}))}_reset(){window.cancelAnimationFrame(this._animationFrameHandle),this._needsRender.clear(),this._animationFrameSet=!1,this._animationFrameHandle=null,this._setAllViewportsToBeRenderedNextFrame()}};const ra=function(e){sa.renderViewport(e)},{EPSILON:la}=ne.CONSTANTS,da=1-la;function ca(e,t,n){const{viewPlaneNormal:i}=t,o=e.filter((e=>{let t=e.metadata.viewPlaneNormal;if(!t){const{referencedImageId:n}=e.metadata,{imageOrientationPatient:i}=ne.metaData.get("imagePlaneModule",n),o=Oo.R3.fromValues(i[0],i[1],i[2]),a=Oo.R3.fromValues(i[3],i[4],i[5]);t=Oo.R3.create(),Oo.R3.cross(t,o,a),e.metadata.viewPlaneNormal=t}const n=Math.abs(Oo.R3.dot(i,t))>da;return t&&n}));if(!o.length)return[];const a=n/2,{focalPoint:s}=t,r=[];for(const e of o){const t=e.data.handles.points[0];if(!e.isVisible)continue;const n=Oo.R3.create();Oo.R3.sub(n,s,t);const o=Oo.R3.dot(n,i);Math.abs(o)<a&&r.push(e)}return r}class ha{static imageIdToFrames(e){const t=e.match(this.frameRangeExtractor);if(!t||!t[2])return null;const n=t[2].split("-").map((e=>Number(e)));return 1===n.length?n[0]:n}static framesToString(e){return Array.isArray(e)?`${e[0]}-${e[1]}`:String(e)}static framesToImageId(e,t){const n=e.match(this.frameRangeExtractor);if(!n||!n[2])return null;const i=this.framesToString(t);return e.replace(this.frameRangeExtractor,`${n[1]}${i}`)}static setFrameRange(e,t,n){const{referencedImageId:i}=e.metadata;e.metadata.referencedImageId=this.framesToImageId(i,t);const o={...n,annotation:e};(0,ne.triggerEvent)(ne.eventTarget,re.ANNOTATION_MODIFIED,o)}static getFrameRange(e){return this.imageIdToFrames(e.metadata.referencedImageId)}}ha.frameRangeExtractor=/(\/frames\/|[&?]frameNumber=)([^/&?]*)/i;const ga=/(videoId:|imageId:|volumeId:)([a-zA-Z]*:)/;function ua(e,t){if(e instanceof ne.StackViewport){const n=e.getCurrentImageId(),i=n.indexOf(":"),o=n.substring(i+1);return t.filter((e=>{if(!e.isVisible)return!1;const t=e.metadata.referencedImageId;if(void 0===t)return!1;const n=t.indexOf(":");return t.substring(n+1)===o}))}if(e instanceof ne.VideoViewport){const n=e.getFrameOfReferenceUID();return t.filter((t=>{if(!t.isVisible)return!1;if(t.metadata.FrameOfReferenceUID!==n)return!1;const i=t.metadata.referencedImageId.replace(ga,"");if(!e.hasImageURI(i))return!1;const o=ha.getFrameRange(t),a=e.getFrameNumber();return Array.isArray(o)?a>=o[0]&&a<=o[1]:Math.abs(a-o)<=5}))}if(e instanceof ne.VolumeViewport){const n=e.getCamera(),{spacingInNormalDirection:i}=ne.utilities.getTargetVolumeAndSpacingInNormalDir(e,n);return ca(t,n,i)}throw new Error(`Viewport Type ${e.type} not supported`)}const ma=new class{constructor(){this._initializeConfig({color:"rgb(255, 255, 0)",colorHighlighted:"rgb(0, 255, 0)",colorSelected:"rgb(0, 220, 0)",colorLocked:"rgb(255, 255, 0)",lineWidth:"1",lineDash:"",shadow:!0,textBoxVisibility:!0,textBoxFontFamily:"Helvetica Neue, Helvetica, Arial, sans-serif",textBoxFontSize:"14px",textBoxColor:"rgb(255, 255, 0)",textBoxColorHighlighted:"rgb(0, 255, 0)",textBoxColorSelected:"rgb(0, 255, 0)",textBoxColorLocked:"rgb(255, 255, 0)",textBoxBackground:"",textBoxLinkLineWidth:"1",textBoxLinkLineDash:"2,3",textBoxShadow:!0})}getAnnotationToolStyles(e){return this.config.annotations&&this.config.annotations[e]}getViewportToolStyles(e){return this.config.viewports&&this.config.viewports[e]}getToolGroupToolStyles(e){return this.config.toolGroups&&this.config.toolGroups[e]}getDefaultToolStyles(){return this.config.default}setAnnotationStyles(e,t){let n=this.config.annotations;n||(this.config={...this.config,annotations:{}},n=this.config.annotations),n[e]=t}setViewportToolStyles(e,t){let n=this.config.viewports;n||(this.config={...this.config,viewports:{}},n=this.config.viewports),n[e]=t}setToolGroupToolStyles(e,t){let n=this.config.toolGroups;n||(this.config={...this.config,toolGroups:{}},n=this.config.toolGroups),n[e]=t}setDefaultToolStyles(e){this.config.default=e}getStyleProperty(e,t){const{annotationUID:n,viewportId:i,toolGroupId:o,toolName:a}=t;return this._getToolStyle(e,n,i,o,a)}_getToolStyle(e,t,n,i,o){if(t){const n=this.getAnnotationToolStyles(t);if(n&&void 0!==n[e])return n[e]}if(n){const t=this.getViewportToolStyles(n);if(t){if(t[o]&&void 0!==t[o][e])return t[o][e];if(t.global&&void 0!==t.global[e])return t.global[e]}}if(i){const t=this.getToolGroupToolStyles(i);if(t){if(t[o]&&void 0!==t[o][e])return t[o][e];if(t.global&&void 0!==t.global[e])return t.global[e]}}const a=this.getDefaultToolStyles();return a[o]&&void 0!==a[o][e]?a[o][e]:a.global&&void 0!==a.global[e]?a.global[e]:void 0}_initializeConfig(e){const t={};for(const n in e)t[n]=e[n];this.config={default:{global:t}}}};function va(e,t,n,i){const o=function(e,t,n){const i=[`${e}`];return t&&i.push(`${i[0]}${t}`),n&&i.push(`${i[i.length-1]}${n}`),i}(e,n,i);for(let e=o.length-1;e>=0;--e){const n=ma.getStyleProperty(o[e],t);if(void 0!==n)return n}}const pa=function(e){if(e){if(e.data&&e.highlighted)return ae.Highlighted;if(Pe(e.annotationUID))return ae.Selected;if(we(e))return ae.Locked}return ae.Default};const fa=function(e,t,n){return`${va("textBoxFontSize",e,t,n)}px ${va("textBoxFontFamily",e,t,n)}`};class Ea extends yo{constructor(){super(...arguments),this.onImageSpacingCalibrated=e=>{const{element:t,imageId:n}=e.detail,i=ne.utilities.imageIdToURI(n),o=ip();o.getFramesOfReference().forEach((e=>{const n=o.getAnnotations(e)[this.getToolName()];n&&n.length&&(n.forEach((e=>{if(!e.metadata?.referencedImageId)return;ne.utilities.imageIdToURI(e.metadata.referencedImageId)===i&&(e.invalidated=!0,e.data.cachedStats={})})),ra(t))}))}}filterInteractableAnnotationsForElement(e,t){if(!t||!t.length)return;const n=(0,ne.getEnabledElement)(e),{viewport:i}=n;return ua(i,t)}getReferencedImageId(e,t,n,i){const o=this.getTargetId(e);let a;if(e instanceof ne.StackViewport)a=o.split("imageId:")[1];else if(e instanceof ne.VideoViewport)a=o.split("videoId:")[1];else{const e=o.split("volumeId:")[1],i=ne.cache.getVolume(e);a=ne.utilities.getClosestImageId(i,t,n)}return a}getStyle(e,t,n){return va(e,t,pa(n),this.mode)}}Ea.toolName="AnnotationDisplayTool";const wa=Ea;class Ia extends wa{constructor(e,t){super(e,t),this.mouseMoveCallback=(e,t)=>{if(!t)return!1;const{element:n,currentPoints:i}=e.detail,o=i.canvas;let a=!1;for(const e of t){if(we(e)||!He(e.annotationUID))continue;const{data:t}=e,i=t.handles?t.handles.activeHandleIndex:void 0,s=this._imagePointNearToolOrHandle(n,e,o,6),r=s&&!e.highlighted,l=!s&&e.highlighted;r||l?(e.highlighted=!e.highlighted,a=!0):t.handles&&t.handles.activeHandleIndex!==i&&(a=!0)}return a},e.configuration?.getTextLines&&(this.configuration.getTextLines=e.configuration.getTextLines),e.configuration?.statsCalculator&&(this.configuration.statsCalculator=e.configuration.statsCalculator)}getHandleNearImagePoint(e,t,n,i){const o=(0,ne.getEnabledElement)(e),{viewport:a}=o,{data:s}=t,{points:r,textBox:l}=s.handles;if(l){const{worldBoundingBox:e}=l;if(e){const t={topLeft:a.worldToCanvas(e.topLeft),topRight:a.worldToCanvas(e.topRight),bottomLeft:a.worldToCanvas(e.bottomLeft),bottomRight:a.worldToCanvas(e.bottomRight)};if(n[0]>=t.topLeft[0]&&n[0]<=t.bottomRight[0]&&n[1]>=t.topLeft[1]&&n[1]<=t.bottomRight[1])return s.handles.activeHandleIndex=null,l}}for(let e=0;e<r.length;e++){const t=r[e],o=a.worldToCanvas(t);if(!0===Oo.K4.distance(n,o)<i)return s.handles.activeHandleIndex=e,t}s.handles.activeHandleIndex=null}getLinkedTextBoxStyle(e,t){return{visibility:this.getStyle("textBoxVisibility",e,t),fontFamily:this.getStyle("textBoxFontFamily",e,t),fontSize:this.getStyle("textBoxFontSize",e,t),color:this.getStyle("textBoxColor",e,t),shadow:this.getStyle("textBoxShadow",e,t),background:this.getStyle("textBoxBackground",e,t),lineWidth:this.getStyle("textBoxLinkLineWidth",e,t),lineDash:this.getStyle("textBoxLinkLineDash",e,t)}}isSuvScaled(e,t,n){if(e instanceof ne.BaseVolumeViewport){const e=t.split("volumeId:")[1],n=ne.cache.getVolume(e);return void 0!==n.scaling?.PT}const i=n&&ne.metaData.get("scalingModule",n);return"number"==typeof i?.suvbw}_imagePointNearToolOrHandle(e,t,n,i){if(this.getHandleNearImagePoint(e,t,n,i))return!0;return!!this.isPointNearTool(e,t,n,i,"mouse")||void 0}}Ia.toolName="AnnotationTool";const Ca=Ia;const _a=function(e,t,n=!1){const i=(0,ne.getEnabledElement)(e),{viewport:o}=i,a=o.getActors().map((({uid:e})=>e.startsWith(t)?e:void 0)).filter(Boolean);o.removeActors(a)};var Ta=n(89636);function ba(e,t=5){return parseFloat(e[0]).toFixed(t)+","+parseFloat(e[1]).toFixed(t)+","+parseFloat(e[2]).toFixed(t)+","}const Da=new Map;function Sa(e){const{actorEntry:t,vtkPlanes:n,viewport:i}=e.detail;if(!t?.clippingFilter)return;const o=t.actor.getMapper(),{viewPlaneNormal:a}=i.getCamera(),s=i.getCurrentImageIdIndex(),r=`${i.id}-${ba(a)}-${s}`;let l=Da.get(t.uid);l||(l=new Map,Da.set(t.uid,l));let d=l.get(r);if(!d){const e=t.clippingFilter;e.setClippingPlanes(n);try{e.update(),d=e.getOutputData(),l.set(r,d)}catch(e){console.error("Error clipping surface",e)}}o.setInputData(d)}const Ma=function(e,t,n){const i=(0,ne.getEnabledElement)(e),{viewport:o}=i,a=t.getPoints(),s=t.getPolys(),r=t.getColor(),l=Wi.ZP.newInstance();l.getPoints().setData(a,3);const d=Ui.ZP.newInstance({values:Float32Array.from(s)});l.setPolys(d);const c=ki.ZP.newInstance({});let h;if(o instanceof ne.VolumeViewport3D)c.setInputData(l);else{h=Ta.ZP.newInstance({clippingPlanes:[],activePlaneId:2,passPointData:!1}),h.setInputData(l),h.setGenerateOutline(!0),h.setGenerateFaces(!1),h.update();const e=h.getOutputData();c.setInputData(e)}const g=Ai.ZP.newInstance();g.setMapper(c),g.getProperty().setColor(r[0]/255,r[1]/255,r[2]/255),o.addActor({actor:g,uid:n,clippingFilter:h}),e.addEventListener(ne.Enums.Events.CLIPPING_PLANES_UPDATED,Sa)};const ya={render:async function(e,t,n){const{colorLUTIndex:i,active:o,segmentationId:a,segmentationRepresentationUID:s,segmentsHidden:r}=t,l=ti(a).representationData[de.Surface],{geometryId:d}=l;d||console.warn(`No Surfaces found for segmentationId ${a}. Skipping render.`);const c=ne.cache.getGeometry(d);if(!c)throw new Error(`No Surfaces found for geometryId ${d}`);if(c.type!==ne.Enums.GeometryType.SURFACE)throw new Error(`Geometry type ${c.type} not supported for rendering.`);if(!c.data)return void console.warn(`No Surfaces found for geometryId ${d}. Skipping render.`);const h=c.data;!function(e,t,n){const i=n,o=e.getActor(i);if(o)throw new Error("Not implemented yet. (Update surface)");Ma(e.element,t,i)}(e,h,`${s}_${h.id}}`),e.resetCamera(),e.render()},removeSegmentationRepresentation:function(e,t,n=!1){if(function(e,t){const n=Jv(e);if(void 0===n)throw new Error(`ToolGroup with ToolGroupId ${e} does not exist`);const{viewportsInfo:i}=n;for(const e of i){const{viewportId:n,renderingEngineId:i}=e,o=(0,ne.getEnabledElementByIds)(n,i);_a(o.viewport.element,t)}}(e,t),Ei(e,t),n){Jv(e).getViewportsInfo().forEach((({viewportId:e,renderingEngineId:t})=>{(0,ne.getEnabledElementByIds)(e,t).viewport.render()}))}}};class Oa extends yo{constructor(e={},t={configuration:{}}){super(e,t),this.renderSegmentation=e=>{const t=Jv(e);if(!t)return;const n=oi(e);if(!n||0===n.length)return;const i=t.viewportsInfo.map((({renderingEngineId:e,viewportId:t})=>{const n=(0,ne.getEnabledElementByIds)(t,e);if(n)return n.viewport})),o=n.map((t=>{const n=this._getMergedRepresentationsConfig(e),o=[],a={[de.Labelmap]:Pi,[de.Contour]:zi,[de.Surface]:ya}[t.type];for(const e of i){const i=a.render(e,t,n);o.push(i)}return o}));Promise.allSettled(o).then((()=>{i.forEach((e=>{e.render()}))}))}}onSetToolEnabled(){const e=this.toolGroupId,t=oi(e);t&&0!==t.length&&t.forEach((t=>{Co(e,t.segmentationRepresentationUID,!0)}))}onSetToolDisabled(){const e=this.toolGroupId,t=oi(e);t&&0!==t.length&&t.forEach((t=>{Co(e,t.segmentationRepresentationUID,!1)}))}_getMergedRepresentationsConfig(e){const t=no(e),n=Ji();return ne.utilities.deepMerge(n,t)}}Oa.toolName="SegmentationDisplay";const xa=Oa;const Ra=new class{constructor(){this._needsRender=new Set,this._animationFrameSet=!1,this._animationFrameHandle=null,this._renderFlaggedToolGroups=()=>{this._throwIfDestroyed();const e=Array.from(this._needsRender.values());for(const t of e)if(this._triggerRender(t),this._needsRender.delete(t),0===this._needsRender.size)return this._animationFrameSet=!1,void(this._animationFrameHandle=null)}}removeToolGroup(e){this._needsRender.delete(e),0===this._needsRender.size&&this._reset()}renderToolGroupSegmentations(e){this._setToolGroupSegmentationToBeRenderedNextFrame([e])}_throwIfDestroyed(){if(this.hasBeenDestroyed)throw new Error("this.destroy() has been manually called to free up memory, can not longer use this instance. Instead make a new one.")}_setToolGroupSegmentationToBeRenderedNextFrame(e){e.forEach((e=>{this._needsRender.add(e)})),this._render()}_render(){this._needsRender.size>0&&!1===this._animationFrameSet&&(this._animationFrameHandle=window.requestAnimationFrame(this._renderFlaggedToolGroups),this._animationFrameSet=!0)}_triggerRender(e){const t=Jv(e);if(!t)return void console.warn(`No tool group found with toolGroupId: ${e}`);const{viewportsInfo:n}=t,i=[];n.forEach((({viewportId:e,renderingEngineId:t})=>{const n=(0,ne.getRenderingEngine)(t);n?i.push(n.getViewport(e)):console.warn("rendering Engine has been destroyed")}));const o=t.getToolInstance(xa.toolName);function a(e){const{element:t,viewportId:n,renderingEngineId:i}=e.detail;t.removeEventListener(ne.Enums.Events.IMAGE_RENDERED,a);const o=Mv(n,i);if(!o)return void console.warn("toolGroup has been destroyed");const s={toolGroupId:o.id,viewportId:n};(0,ne.triggerEvent)(ne.eventTarget,re.SEGMENTATION_RENDERED,{...s})}o?(i.forEach((({element:e})=>{e.addEventListener(ne.Enums.Events.IMAGE_RENDERED,a)})),o.renderSegmentation(e)):console.warn("No segmentation tool found inside",e)}_reset(){window.cancelAnimationFrame(this._animationFrameHandle),this._needsRender.clear(),this._animationFrameSet=!1,this._animationFrameHandle=null}};function Pa(e){Ra.renderToolGroupSegmentations(e)}const Na=Pa,La=function(e){const{toolGroupId:t}=e.detail;Na(t)},Aa=function(e){const{segmentationId:t,modifiedSlicesToUse:n}=e.detail,{representationData:i,type:o}=ti(t),a=si(t);if(o!==de.Labelmap)throw new Error(`onSegmentationDataModified: representationType ${o} not supported yet`);if(Ti(i[o])){const e=ne.cache.getVolume(i[o].volumeId);if(!e)return void console.warn("segmentation not found in cache");const{imageData:t,vtkOpenGLTexture:a}=e;let s;if(n&&Array.isArray(n))s=n;else{const e=t.getDimensions()[2];s=[...Array(e).keys()]}s.forEach((e=>{a.setUpdatedFrame(e)})),t.modified()}else a.forEach((e=>{const n=oi(e),a=Jv(e).getViewportsInfo();n.forEach((e=>{e.segmentationId===t&&a.forEach((({viewportId:t,renderingEngineId:n})=>{const a=(0,ne.getEnabledElementByIds)(t,n).viewport,s=a.getActor(e.segmentationRepresentationUID);if(!s)return;const r=a.getCurrentImageId(),l=s.actor.getMapper().getInputData(),{imageIdReferenceMap:d}=i[o],c=d.get(r),h=ne.cache.getImage(c);l.modified(),ne.utilities.updateVTKImageDataWithCornerstoneImage(l,h)}))}))}));a.forEach((e=>{Na(e)}))},ka=function(e){const{toolGroupId:t,segmentationRepresentationUID:n}=e.detail;Na(t)},Ua=function(e){const{segmentationId:t}=e.detail;si(t).forEach((e=>{oi(e).forEach((n=>{n.segmentationId===t&&Zn(e,n.segmentationRepresentationUID)}))}))};var Va=n(96372);function Wa(e){const t=e.detail,{viewportId:n,renderingEngineId:i}=t,{viewport:o}=(0,ne.getEnabledElementByIds)(n,i),a=Mv(n,i);if(!a)return;let s=oi(a.id)||[];if(s=s.filter((e=>e.type===de.Labelmap)),!s?.length)return;const r={};s.forEach((e=>{const t=ti(e.segmentationId);if(!t)return;const n=t.representationData[de.Labelmap];if(Ti(n))return;const{imageIdReferenceMap:i}=n;r[e.segmentationRepresentationUID]={imageIdReferenceMap:i}}));const l=Object.keys(r),d=o.getCurrentImageId();o.getActors().forEach((t=>{if(!l.includes(t.uid))return;const n=t.actor,{imageIdReferenceMap:i}=r[t.uid],s=i.get(d),c=n.getMapper().getInputData();if(!s){const e=Ni.ZP.newInstance({name:"Pixels",numberOfComponents:1,values:new Uint8Array(c.getNumberOfPoints())}),t=Va.ZP.newInstance();return t.getPointData().setScalars(e),void n.getMapper().setInputData(t)}const h=ne.cache.getImage(s),{origin:g,dimensions:u,spacing:m,direction:v}=o.getImageDataMetadata(h);if(c.setOrigin(g),c.modified(),c.getDimensions()[0]!==u[0]||c.getDimensions()[1]!==u[1])return o.removeActors([t.uid]),o.addImages([{imageId:s,actorUID:t.uid,callback:({imageActor:e})=>{const t=Ni.ZP.newInstance({name:"Pixels",numberOfComponents:1,values:[...h.getPixelData()]}),n=Va.ZP.newInstance();n.setDimensions(u[0],u[1],1),n.setSpacing(m),n.setDirection(v),n.setOrigin(g),n.getPointData().setScalars(t),e.getMapper().setInputData(n)}}],!0,!1),void Na(a.id);ne.utilities.updateVTKImageDataWithCornerstoneImage(c,h),o.render(),e.type===ne.Enums.Events.IMAGE_RENDERED&&o.element.removeEventListener(ne.Enums.Events.IMAGE_RENDERED,Wa)}))}const Ha={enable:function(e){const{viewport:t}=(0,ne.getEnabledElement)(e);t instanceof ne.StackViewport&&(e.addEventListener(ne.Enums.Events.STACK_NEW_IMAGE,Wa),e.addEventListener(ne.Enums.Events.IMAGE_RENDERED,Wa))},disable:function(e){const{viewport:t}=(0,ne.getEnabledElement)(e);t instanceof ne.StackViewport&&(e.removeEventListener(ne.Enums.Events.STACK_NEW_IMAGE,Wa),e.removeEventListener(ne.Enums.Events.IMAGE_RENDERED,Wa))}};function Ba(e,t,n=5){const i=(0,ne.getEnabledElement)(e);if(!i)throw new Error("getAnnotationNearPoint: enabledElement not found");return Fa(i,t,n)}function Fa(e,t,n){const{renderingEngineId:i,viewportId:o}=e,a=Mv(o,i);if(!a)return null;const{_toolInstances:s}=a;for(const i in s){const o=Ga(s[i],e,t,n);if(o)return o}return null}function Ga(e,t,n,i){const{viewport:o}=t,a=sp(e.constructor.toolName,o?.element),s=o?.getCurrentImageId?.();if(a?.length){const{element:o}=t.viewport;for(const t of a){const a=t.metadata?.referencedImageId;if(!(s&&a&&s!==a||!e.isPointNearTool)&&(e.isPointNearTool(o,t,n,i,"")||e.getHandleNearImagePoint(o,t,n,i)))return t}}return null}const $a=function(e){const t=typeof e;return null!==e&&("object"===t||"function"===t)};const Ka=function(e,t,n){let i,o,a,s,r,l,d=0,c=!1,h=!1,g=!0;const u=!t&&0!==t&&"function"==typeof window.requestAnimationFrame;if("function"!=typeof e)throw new TypeError("Expected a function");function m(t){const n=i,a=o;return i=o=void 0,d=t,s=e.apply(a,n),s}function v(e,t){return u?window.requestAnimationFrame(e):setTimeout(e,t)}function p(e){const n=e-l;return void 0===l||n>=t||n<0||h&&e-d>=a}function f(){const e=Date.now();if(p(e))return E(e);r=v(f,function(e){const n=e-d,i=t-(e-l);return h?Math.min(i,a-n):i}(e))}function E(e){return r=void 0,g&&i?m(e):(i=o=void 0,s)}function w(...e){const n=Date.now(),a=p(n);if(i=e,o=this,l=n,a){if(void 0===r)return function(e){return d=e,r=v(f,t),c?m(e):s}(l);if(h)return r=v(f,t),m(l)}return void 0===r&&(r=v(f,t)),s}return t=Number(t)||0,$a(n)&&(c=Boolean(n.leading),h="maxWait"in n,a=h?Math.max(Number(n.maxWait)||0,t):a,g="trailing"in n?Boolean(n.trailing):g),w.cancel=function(){void 0!==r&&function(e){if(u)return window.cancelAnimationFrame(e);clearTimeout(e)}(r),d=0,i=l=o=r=void 0},w.flush=function(){return void 0===r?s:E(Date.now())},w.pending=function(){return void 0!==r},w};const qa=function(e,t,n){let i=!0,o=!0;if("function"!=typeof e)throw new TypeError("Expected a function");return $a(n)&&(i="leading"in n?Boolean(n.leading):i,o="trailing"in n?Boolean(n.trailing):o),Ka(e,t,{leading:i,trailing:o,maxWait:t})};function za(e,t,n){return Math.min(Math.max(t,e),n)}const ja=za,{calibratedPixelSpacingMetadataProvider:Ya}=ne.utilities;function Za(e,t,n){"number"==typeof n&&(n={type:ne.Enums.CalibrationTypes.USER,scale:n}),Ya.add(e,n);t.getStackViewports().forEach((t=>{t.getImageIds().includes(e)&&t.calibrateSpacing(e)}))}const{CalibrationTypes:Xa}=ne.Enums,Ja="px",Qa=[1],es=["3,3"],ts=["4,3"],ns={3:"cm",4:"seconds"},is=(e,t)=>{const{calibration:n,hasPixelSpacing:i}=t,o=i?"mm":Ja;return n&&(n.type||n.sequenceOfUltrasoundRegions)?n.type===Xa.UNCALIBRATED?Ja:n.sequenceOfUltrasoundRegions?"US Region":`${o} ${n.type}`:o},os="",as=(e,t)=>{const{calibration:n,hasPixelSpacing:i}=t,o=(i?"mm":Ja)+os;return n&&n.type?n.sequenceOfUltrasoundRegions?"US Region":`${o} ${n.type}`:o},ss=(e,t=[])=>{if(!e.calibration?.sequenceOfUltrasoundRegions)return e.calibration?.scale?e.calibration.scale:1},rs=(e,t)=>{const[n,i]=t,{calibration:o,hasPixelSpacing:a}=e;let s=a?"mm":Ja;const r=s+os;let l=1,d="";if(!o||!o.type&&!o.sequenceOfUltrasoundRegions)return{units:s,areaUnits:r,scale:l};if(o.type===Xa.UNCALIBRATED)return{units:Ja,areaUnits:Ja+os,scale:l};if(o.sequenceOfUltrasoundRegions){let e=o.sequenceOfUltrasoundRegions.filter((e=>n[0]>=e.regionLocationMinX0&&n[0]<=e.regionLocationMaxX1&&n[1]>=e.regionLocationMinY0&&n[1]<=e.regionLocationMaxY1&&i[0]>=e.regionLocationMinX0&&i[0]<=e.regionLocationMaxX1&&i[1]>=e.regionLocationMinY0&&i[1]<=e.regionLocationMaxY1));if(!e?.length)return{units:s,areaUnits:r,scale:l};if(e=e.filter((e=>Qa.includes(e.regionDataType)&&es.includes(`${e.physicalUnitXDirection},${e.physicalUnitYDirection}`))),!e.length)return{units:Ja,areaUnits:Ja+os,scale:l};const t=e[0],a=Math.abs(t.physicalDeltaX),c=Math.abs(t.physicalDeltaY);if(!ne.utilities.isEqual(a,c,.001))return{units:Ja,areaUnits:Ja+os,scale:l};l=1/(a*c*100),d="US Region",s="mm"}else o.scale&&(l=o.scale);return{units:s+(d?` ${d}`:""),areaUnits:r+(d?` ${d}`:""),scale:l}},ls=(e,t)=>{const[n]=t,{calibration:i}=e;let o=["raw"],a=[null],s="";if(!i||!i.type&&!i.sequenceOfUltrasoundRegions)return{units:o,values:a};if(i.sequenceOfUltrasoundRegions){const e=i.sequenceOfUltrasoundRegions.filter((e=>Qa.includes(e.regionDataType)&&ts.includes(`${e.physicalUnitXDirection},${e.physicalUnitYDirection}`)));if(!e?.length)return{units:o,values:a};const t=e.find((e=>n[0]>=e.regionLocationMinX0&&n[0]<=e.regionLocationMaxX1&&n[1]>=e.regionLocationMinY0&&n[1]<=e.regionLocationMaxY1));if(!t)return{units:o,values:a};const{referencePixelX0:r=0,referencePixelY0:l=0}=t,{physicalDeltaX:d,physicalDeltaY:c}=t,h=(n[1]-t.regionLocationMinY0-l)*c;s="US Region",a=[(n[0]-t.regionLocationMinX0-r)*d,h],o=[ns[t.physicalUnitXDirection],ns[t.physicalUnitYDirection]]}return{units:o,values:a,calibrationType:s}},ds=e=>e.calibration?.aspect||1;const cs=function(e,t){t.length&&t.forEach((t=>{const{element:n}=e.getViewport(t);ra(n)}))};function hs(e,t){if(!(0,ne.getEnabledElement)(e.element))throw new Error("Scroll::Viewport is not enabled (it might be disabled)");if(e instanceof ne.StackViewport&&0===e.getImageIds().length)throw new Error("Scroll::Stack Viewport has no images");const{type:n}=e,{volumeId:i,delta:o,scrollSlabs:a}=t;if(e instanceof ne.StackViewport)e.scroll(o,t.debounceLoading,t.loop);else if(e instanceof ne.VolumeViewport)!function(e,t,n,i=!1){const o=i,{numScrollSteps:a,currentStepIndex:s,sliceRangeInfo:r}=ne.utilities.getVolumeViewportScrollInfo(e,t,o);if(!r)return;const{sliceRange:l,spacingInNormalDirection:d,camera:c}=r,{focalPoint:h,viewPlaneNormal:g,position:u}=c,{newFocalPoint:m,newPosition:v}=ne.utilities.snapFocalPointToSlice(h,u,l,g,d,n);e.setCamera({focalPoint:m,position:v}),e.render();const p=s+n;if((p>a||p<0)&&e.getCurrentImageId()){const i={volumeId:t,viewport:e,delta:n,desiredStepIndex:p,currentStepIndex:s,numScrollSteps:a,currentImageId:e.getCurrentImageId()};ne.utilities.triggerEvent(ne.eventTarget,ne.EVENTS.VOLUME_SCROLL_OUT_OF_BOUNDS,i)}}(e,i,o,a);else{if(!(e instanceof ne.VideoViewport))throw new Error(`Not implemented for Viewport Type: ${n}`);e.scroll(o)}}const gs=async function(e,t={}){const{imageIndex:n,debounceLoading:i,volumeId:o}=t,a=(0,ne.getEnabledElement)(e);if(!a)throw new Error("Element has been disabled");const{viewport:s}=a,{imageIndex:r,numberOfSlices:l}=function(e,t){if(e instanceof ne.StackViewport)return{numberOfSlices:e.getImageIds().length,imageIndex:t?e.getTargetImageIdIndex():e.getCurrentImageIdIndex()};if(e instanceof ne.VolumeViewport)return ne.utilities.getImageSliceDataForVolumeViewport(e);throw new Error("Unsupported viewport type")}(s,i),d=function(e,t){const n=e-1;return ja(t,0,n)}(l,n);hs(s,{delta:d-r,debounceLoading:i,volumeId:o})};function us(e,t,n,i){let o,a,s,r,l,d,c;c=e.getScalarData?e.getScalarData():e.getPointData().getScalars().getData();const h=e.getDimensions();i?[[o,a],[s,r],[l,d]]=i:(o=0,a=h[0],s=0,r=h[1],l=0,d=h[2]);const g=Oo.R3.fromValues(o,s,l),u=e.getDirection(),m=u.slice(0,3),v=u.slice(3,6),p=u.slice(6,9),f=e.getSpacing(),[E,w,I]=f,C=e.indexToWorld(g),_=Oo.R3.fromValues(m[0]*E,m[1]*E,m[2]*E),T=Oo.R3.fromValues(v[0]*w,v[1]*w,v[2]*w),b=Oo.R3.fromValues(p[0]*I,p[1]*I,p[2]*I),D=c.length/h[2]/h[1]/h[0],S=h[0]*D,M=h[1]*S,y=[],O=Oo.R3.clone(C);for(let e=l;e<=d;e++){const i=Oo.R3.clone(O);for(let i=s;i<=r;i++){const s=Oo.R3.clone(O);for(let s=o;s<=a;s++){const o=[s,i,e];if(t(O,O)){const t=e*M+i*S+s*D;let a;a=D>2?[c[t],c[t+1],c[t+2]]:c[t],y.push({value:a,index:t,pointIJK:o,pointLPS:O}),n&&n({value:a,index:t,pointIJK:o,pointLPS:O})}Oo.R3.add(O,O,_)}Oo.R3.copy(O,s),Oo.R3.add(O,O,T)}Oo.R3.copy(O,i),Oo.R3.add(O,O,b)}return y}function ms(e,t){const{center:n,radius:i}=e,o=e.radius2||i*i;return(t[0]-n[0])*(t[0]-n[0])+(t[1]-n[1])*(t[1]-n[1])+(t[2]-n[2])*(t[2]-n[2])<=o}const vs=function(e,t){const n=e.findIndex((([e,t])=>e===t));if(-1===n)throw new Error("3D bounding boxes not supported in an oblique plane");return e[n][0]-=t,e[n][1]+=t,e};const ps=function(e,t){let n=1/0,i=0,o=1/0,a=0,s=1/0,r=0;if(e.forEach((e=>{n=Math.min(e[0],n),i=Math.max(e[0],i),o=Math.min(e[1],o),a=Math.max(e[1],a),s=Math.min(e[2],s),r=Math.max(e[2],r)})),n=Math.floor(n),i=Math.floor(i),o=Math.floor(o),a=Math.floor(a),s=Math.floor(s),r=Math.floor(r),t){const[e,l,d]=t;n=Math.max(0,n),i=Math.min(e-1,i),o=Math.max(0,o),a=Math.min(l-1,a),s=Math.max(0,s),r=Math.min(d-1,r)}return[[n,i],[o,a],[s,r]]},{transformWorldToIndex:fs}=ne.utilities;function Es(e,t,n,i){const{boundsIJK:o,centerWorld:a,radiusWorld:s}=function(e,t,n){const[i,o]=e,a=Oo.R3.fromValues((i[0]+o[0])/2,(i[1]+o[1])/2,(i[2]+o[2])/2),s=Oo.R3.distance(i,o)/2;let r;if(!n){const e=fs(t,a),n=t.getSpacing(),i=Math.min(...n),o=Math.ceil(s/i);return r=[[e[0]-o,e[0]+o],[e[1]-o,e[1]+o],[e[2]-o,e[2]+o]],{boundsIJK:r,centerWorld:a,radiusWorld:s}}return r=function(e,t,n,i,o){const[a,s]=n,r=e.getDimensions(),l=t.getCamera(),d=Oo.R3.fromValues(l.viewUp[0],l.viewUp[1],l.viewUp[2]),c=Oo.R3.fromValues(l.viewPlaneNormal[0],l.viewPlaneNormal[1],l.viewPlaneNormal[2]),h=Oo.R3.create();Oo.R3.cross(h,d,c);const g=Oo.R3.create(),u=Oo.R3.create();Oo.R3.scaleAndAdd(g,s,c,o),Oo.R3.scaleAndAdd(u,a,c,-o),Oo.R3.scaleAndAdd(g,g,h,-o),Oo.R3.scaleAndAdd(u,u,h,o);const m=[fs(e,g),fs(e,u)],v=ps(m,r);return v}(t,n,e,0,s),{boundsIJK:r,centerWorld:a,radiusWorld:s}}(t,e,i),r={center:a,radius:s};us(e,(e=>ms(r,e)),n,o)}const ws=function e(t,n=2){if(Array.isArray(t))return t.map((t=>e(t,n))).join(", ");if(null==t||""===t)return"NaN";if((t=Number(t))<1e-4)return`${t}`;const i=t>=100?n-2:t>=10?n-1:t>=1?n:t>=.1?n+1:t>=.01?n+2:t>=.001?n+3:n+4;return t.toFixed(i)};function Is(e,t,n={}){return n.precalculated||Cs(e,n),n.precalculated(t)}const Cs=(e,t={})=>{const{xRadius:n,yRadius:i,zRadius:o}=e;void 0!==t.invXRadiusSq&&void 0!==t.invYRadiusSq&&void 0!==t.invZRadiusSq||(t.invXRadiusSq=0!==n?1/n**2:0,t.invYRadiusSq=0!==i?1/i**2:0,t.invZRadiusSq=0!==o?1/o**2:0);const{invXRadiusSq:a,invYRadiusSq:s,invZRadiusSq:r}=t,{center:l}=e,[d,c,h]=l;return t.precalculated=e=>{const t=e[0]-d;let n=t*t*a;if(n>1)return!1;const i=e[1]-c;if(n+=i*i*s,n>1)return!1;const o=e[2]-h;return n+=o*o*r,n<=1},t};function _s(e){const[t,n,i,o]=e;return[[i[0],n[1]],[o[0],t[1]]]}const Ts={[ge.Initialize]:e=>{const{strategySpecificConfiguration:t}=e;if(!t)return;const{centerSegmentIndex:n}=t;n&&(e.segmentIndex=n.segmentIndex)},[ge.OnInteractionStart]:e=>{const{segmentIndex:t,previewSegmentIndex:n,segmentationVoxelManager:i,centerIJK:o,strategySpecificConfiguration:a,imageVoxelManager:s,segmentationImageData:r,preview:l}=e;if(!a?.useCenterSegmentIndex)return;delete a.centerSegmentIndex;let d=!1,c=!1;if(us(r,s.isInObject,(({value:e})=>{d||=e===t,c||=e===n}),i.boundsIJK),!d&&!c)return;let h=i.getAtIJKPoint(o);if(h===n){if(!l)return;h=l.segmentIndex}else c&&(h=null);e.segmentIndex=h,a.centerSegmentIndex={segmentIndex:h}}},bs={[ge.Initialize]:e=>{const{centerIJK:t,strategySpecificConfiguration:n,segmentationVoxelManager:i,imageVoxelManager:o,segmentIndex:a}=e,{THRESHOLD:s}=n;if(!s?.isDynamic||!t||!a)return;const{boundsIJK:r}=i,{threshold:l,dynamicRadius:d=0}=s,c=l?0:d,h=r.map(((e,n)=>{const[i,o]=e;return[Math.max(i,t[n]-c),Math.min(o,t[n]+c)]})),g=l||[1/0,-1/0];o.forEach((({value:e})=>{g[0]=Math.min(e,g[0]),g[1]=Math.max(e,g[1])}),{boundsIJK:h}),e.strategySpecificConfiguration.THRESHOLD.threshold=g},[ge.OnInteractionStart]:e=>{const{strategySpecificConfiguration:t,preview:n}=e;(t?.THRESHOLD?.isDynamic||n)&&(t.THRESHOLD.threshold=null)}},Ds={[ge.Initialize]:e=>{e.segmentIndex=0}};function Ss(e,t){return e===t}function Ms(e,t,n){return(new Array(n+1).join(t)+e).slice(-n)}const ys=function(e,t,n={}){const i=n.onFlood,o=n.onBoundary,a=n.equals||Ss,s=n.diagonals||!1,r=m(t),l=function(){const e=function(e){const t=[],n=function(e){return e.split("").map((function(e){return parseInt(e,10)-1}))};for(let i=0;i<Math.pow(3,e);i+=1){const o=Ms(i.toString(3),"0",e);t.push(n(o))}return t}(t.length);return e.filter((function(e){const t=function(e){let t=0;for(let n=0;n<e.length;n+=1)0!==e[n]&&(t+=1);return t}(e);return 0!==t&&(1===t||s)}))}(),d=[],c=[],h={},g={};for(d.push({currentArgs:t});d.length>0;)u(d.pop());return{flooded:c,boundaries:function(){const e=[];for(const t in g)void 0!==g[t]&&e.unshift(g[t]);return e}()};function u(e){const t=e.currentArgs,n=e.previousArgs;!0!==h[t]&&(!function(e){h[e]=!0}(t),function(e){const t=v(m,[e]);return v(a,[t,r])}(t)?(function(e){c.push(e),i&&i(...e)}(t),function(e){for(let t=0;t<l.length;t+=1){const n=l[t],i=e.slice(0);for(let t=0;t<e.length;t+=1)i[t]+=n[t];d.push({currentArgs:i,previousArgs:e})}}(t)):function(e){g[e]=e,o&&o(...e)}(n))}function m(t){return e(...t)}function v(e,t){try{return e(...t)}catch(e){return}}},Os={[ge.OnInteractionEnd]:e=>{const{previewVoxelManager:t,segmentationVoxelManager:n,strategySpecificConfiguration:i,previewSegmentIndex:o,segmentIndex:a}=e;if(!i.THRESHOLD||null===a)return;const s=t.getPoints();if(!s?.length)return;if(void 0===o)return;const r=t.getBoundsIJK().map(((e,t)=>[Math.min(e[0],...s.map((e=>e[t]))),Math.max(e[1],...s.map((e=>e[t])))]));if(r.find((e=>e[0]<0||e[1]>65535)))return;const l=new Set,d=(e,t,i)=>{if(e<r[0][0]||e>r[0][1]||t<r[1][0]||t>r[1][1]||i<r[2][0]||i>r[2][1])return-1;const s=n.toIndex([e,t,i]);if(l.has(s))return-2;const d=n.getAtIndex(s),c=d===o||d===a?1:0;return c||n.addPoint(s),c};let c=0;const h=(e,i,a)=>{const s=n.toIndex([e,i,a]);l.has(s)||(t.setAtIJK(e,i,a,o),l.add(s),c++)};s.forEach(((e,t)=>{1===d(...e)&&ys(d,e,{onFlood:h,diagonals:!0})}));let g=0,u=0;t.forEach((({index:e,pointIJK:i,value:s})=>{const r=n.getAtIndex(e);if(l.has(e)){u++;const e=s===a?a:o;t.setAtIJKPoint(i,e)}else if(r===o){g++;const e=s??0;t.setAtIJKPoint(i,e)}}),{}),c-u!=0&&console.warn("There were flooded=",c,"cleared=",g,"preview count=",u,"not handled",c-u);const m=new Set(n.points||[]);l.clear();for(const e of m.keys()){if(l.has(e))continue;let n=!0;const i=new Set,a=(e,o,a)=>{const s=t.toIndex([e,o,a]);l.add(s),(r[0][0]===r[0][1]||e!==r[0][0]&&e!==r[0][1])&&(r[1][0]===r[1][1]||o!==r[1][0]&&o!==r[1][1])&&(r[2][0]===r[2][1]||a!==r[2][0]&&a!==r[2][1])||(n=!1),n&&i.add(s)},s=t.toIJK(e);if(0===d(...s)&&(ys(d,s,{onFlood:a,diagonals:!1}),n))for(const e of i)t.setAtIndex(e,o)}Jn(e.segmentationId,t.getArrayOfSlices())}},xs={[ge.Preview]:function(e){const{previewColors:t,strategySpecificConfiguration:n,enabledElement:i}=e;if(!t||!n)return;e.preview&&delete e.preview,delete n.centerSegmentIndex,this.onInteractionStart?.(i,e);const o=this.fill(i,e);return o&&(o.isPreviewFromHover=!0,e.preview=o,this.onInteractionEnd?.(i,e)),o},[ge.Initialize]:e=>{const{toolGroupId:t,segmentIndex:n,segmentationRepresentationUID:i,previewSegmentIndex:o,previewColors:a,preview:s}=e;if(void 0===a)return;if(s&&(s.previewVoxelManager.sourceVoxelManager=e.segmentationVoxelManager,e.previewVoxelManager=s.previewVoxelManager),null===n||!o)return;const r=a?.[n],l=wo(t,i,n);if(!r&&!l)return;Io(t,i,o,r||l.map((e=>.9*e)))},[ge.AcceptPreview]:e=>{const{segmentationVoxelManager:t,previewVoxelManager:n,previewSegmentIndex:i,preview:o}=e;if(void 0===i)return;const a=o?.segmentIndex??e.segmentIndex,s=n;if(!s||0===s.modifiedSlices.size)return;s.forEach((({index:e})=>{t.getAtIndex(e)===i&&t.setAtIndex(e,a)}),{}),Jn(e.segmentationId,s.getArrayOfSlices()),s.clear()},[ge.RejectPreview]:e=>{const{previewVoxelManager:t,segmentationVoxelManager:n}=e;if(0===t.modifiedSlices.size)return;t.forEach((({index:e,value:t})=>{n.setAtIndex(e,t)})),Jn(e.segmentationId,t.getArrayOfSlices()),t.clear()}},Rs={[ge.Fill]:e=>{const{segmentsLocked:t,segmentationImageData:n,segmentationVoxelManager:i,previewVoxelManager:o,imageVoxelManager:a,brushStrategy:s,centerIJK:r}=e,l=s.createIsInThreshold?.(e),{setValue:d}=s,c=l?n=>{const{value:i,index:o}=n;!t.includes(i)&&l(o)&&d(e,n)}:t=>d(e,t);us(n,a.isInObject,c,i.boundsIJK),o.addPoint(r)}},Ps={determineSegmentIndex:Ts,dynamicThreshold:bs,erase:Ds,islandRemoval:Os,preview:xs,regionFill:Rs,setValue:{[ge.INTERNAL_setValue]:(e,{value:t,index:n})=>{const{segmentsLocked:i,segmentIndex:o,previewVoxelManager:a,previewSegmentIndex:s,segmentationVoxelManager:r}=e,l=r.getAtIndex(n);if(null===o){const e=a.getAtIndex(n);return void(void 0!==e&&a.setAtIndex(n,e))}if(l===o||i.includes(t))return;if(l===s){if(void 0!==a.getAtIndex(n))return;r.setAtIndex(n,o)}const d=s??o;a.setAtIndex(n,d)}},threshold:{[ge.CreateIsInThreshold]:e=>{const{imageVoxelManager:t,strategySpecificConfiguration:n,segmentIndex:i}=e;if(n&&i)return e=>{const{THRESHOLD:i,THRESHOLD_INSIDE_CIRCLE:o}=n,a=t.getAtIndex(e),{threshold:s}=i||o||{};return!s?.length||s[0]<=a&&a<=s[1]}}}},{VoxelManager:Ns}=ne.utilities;function Ls({operationData:e,viewport:t}){let n,i,o,a;if(Ti(e)){const{volumeId:t,referencedVolumeId:s}=e,r=ne.cache.getVolume(t),l=ne.cache.getVolume(s);if(!r||!l)return;({imageData:n}=r),i=r.getScalarData(),o=l.getScalarData(),a=l.dimensions}else{const{imageIdReferenceMap:s,segmentationRepresentationUID:r}=e;if(!s)return;const l=t.getCurrentImageId();if(!l)return;n=t.getActor(r).actor.getMapper().getInputData();const d=s.get(l);i=ne.cache.getImage(d).getPixelData();const c=ne.cache.getImage(l);o=c.getPixelData(),a=[c.columns,c.rows,1]}return{segmentationImageData:n,segmentationScalarData:i,segmentationVoxelManager:Ns.createVolumeVoxelManager(a,i),imageScalarData:o,imageVoxelManager:Ns.createVolumeVoxelManager(a,o)}}var As;const{VoxelManager:ks}=ne.utilities;class Us{constructor(e,...t){this._initialize=[],this._fill=[],this._onInteractionStart=[],this.fill=(e,t)=>{const n=this.initialize(e,t),{strategySpecificConfiguration:i={},centerIJK:o}=n;if(ne.utilities.isEqual(o,i.centerIJK))return t.preview;i.centerIJK=o,this._fill.forEach((e=>e(n)));const{segmentationVoxelManager:a,previewVoxelManager:s,previewSegmentIndex:r}=n;return Jn(n.segmentationId,a.getArrayOfSlices()),r&&s.modifiedSlices.size?n.preview||n:null},this.onInteractionStart=(e,t)=>{const{preview:n}=t;if(n?.isPreviewFromHover)return void(n.isPreviewFromHover=!1);const i=this.initialize(e,t);this._onInteractionStart.forEach((e=>e.call(this,i)))},this.configurationName=e,this.compositions=t,t.forEach((e=>{const t="function"==typeof e?e():e;if(t)for(const e in t){if(!Us.childFunctions[e])throw new Error(`Didn't find ${e} as a brush strategy`);Us.childFunctions[e](this,t[e])}})),this.strategyFunction=(e,t)=>this.fill(e,t);for(const e of Object.keys(Us.childFunctions))this.strategyFunction[e]=this[e]}initialize(e,t){const{viewport:n}=e,i=Ls({operationData:t,viewport:n});if(!i)return console.warn("No data found for BrushStrategy"),t.preview;if(Ti(t)){const{referencedVolumeId:e,volumeId:n}=t,i=ne.cache.getVolume(e),o=ne.cache.getVolume(n);if(!ne.utilities.isEqual(o.dimensions,i.dimensions)||!ne.utilities.isEqual(o.direction,i.direction))throw new Error("Only source data the same dimensions/size/orientation as the segmentation currently supported.")}const{imageVoxelManager:o,segmentationVoxelManager:a,segmentationImageData:s}=i,r=t.preview?.previewVoxelManager||ks.createHistoryVoxelManager(a),l={previewSegmentIndex:!!t.previewColors?255:void 0,...t,enabledElement:e,imageVoxelManager:o,segmentationVoxelManager:a,segmentationImageData:s,previewVoxelManager:r,viewport:n,centerWorld:null,brushStrategy:this};return this._initialize.forEach((e=>e(l))),l}}function Vs(e,t){const n=`_${e}`;return(i,o)=>{i[n]||=[],i[n].push(o),i[e]||=t?(e,o)=>{const a=i[t](e,o);i[n].forEach((e=>e.call(i,a)))}:e=>{i[n].forEach((t=>t.call(i,e)))}}}function Ws(e,t=!0){return(n,i)=>{if(n[e])throw new Error(`The singleton method ${e} already exists`);n[e]=t?i:(e,t)=>(t.enabledElement=e,i.call(n,t))}}(As=Us).COMPOSITIONS=Ps,As.childFunctions={[ge.OnInteractionStart]:Vs(ge.OnInteractionStart,ge.Initialize),[ge.OnInteractionEnd]:Vs(ge.OnInteractionEnd,ge.Initialize),[ge.Fill]:Vs(ge.Fill),[ge.Initialize]:Vs(ge.Initialize),[ge.CreateIsInThreshold]:Ws(ge.CreateIsInThreshold),[ge.AcceptPreview]:Vs(ge.AcceptPreview,ge.Initialize),[ge.RejectPreview]:Vs(ge.RejectPreview,ge.Initialize),[ge.INTERNAL_setValue]:Ws(ge.INTERNAL_setValue),[ge.Preview]:Ws(ge.Preview,!1),compositions:null};const{transformWorldToIndex:Hs}=ne.utilities,Bs=1e-4,Fs=(e,t)=>Math.abs(e)<Bs||Math.abs(e-t)<Bs,Gs={[ge.Initialize]:e=>{const{points:t,imageVoxelManager:n,viewport:i,segmentationImageData:o,segmentationVoxelManager:a}=e;if(!t)return;const s=Oo.R3.fromValues(0,0,0);t.forEach((e=>{Oo.R3.add(s,s,e)})),Oo.R3.scale(s,s,1/t.length),e.centerWorld=s,e.centerIJK=Hs(o,s);const r=t.map((e=>i.worldToCanvas(e))),[l,d]=_s(r),c=i.canvasToWorld(l),h=i.canvasToWorld(d),g=[Hs(o,c),Hs(o,h)];a.boundsIJK=ps(g,a.dimensions),n.isInObject=$s({topLeftWorld:c,bottomRightWorld:h,center:s})}};function $s(e){const{topLeftWorld:t,bottomRightWorld:n,center:i}=e,o=Math.abs(t[0]-n[0])/2,a=Math.abs(t[1]-n[1])/2,s=Math.abs(t[2]-n[2])/2,r=Math.max(o,a,s);if(Fs(o,r)&&Fs(a,r)&&Fs(s,r)){const e={center:i,radius:r,radius2:r*r};return t=>ms(e,t)}const l=Cs({center:i,xRadius:o,yRadius:a,zRadius:s}),{precalculated:d}=l;return d}const Ks=new Us("Circle",Ps.regionFill,Ps.setValue,Gs,Ps.determineSegmentIndex,Ps.preview),qs=new Us("CircleThreshold",Ps.regionFill,Ps.setValue,Gs,Ps.determineSegmentIndex,Ps.dynamicThreshold,Ps.threshold,Ps.preview,Ps.islandRemoval),zs=Ks.strategyFunction,js=qs.strategyFunction;const{transformWorldToIndex:Ys}=ne.utilities,Zs={[ge.Initialize]:e=>{const{points:t,imageVoxelManager:n,viewport:i,segmentationImageData:o,segmentationVoxelManager:a}=e;if(!t)return;const s=Oo.R3.fromValues(0,0,0);t.forEach((e=>{Oo.R3.add(s,s,e)})),Oo.R3.scale(s,s,1/t.length),e.centerWorld=s,e.centerIJK=Ys(o,s);const r=t.map((e=>i.worldToCanvas(e))),[l,d]=_s(r),c=i.canvasToWorld(l),h=i.canvasToWorld(d),g=c.map(((e,t)=>Math.abs(h[t]-e))),u=Math.max(...g)/2;c.forEach(((e,t)=>{e===h[t]&&(c[t]=e-u,h[t]=e+u)}));const m=[Ys(o,c),Ys(o,h)];a.boundsIJK=ps(m,a.dimensions),n.isInObject=$s({topLeftWorld:c,bottomRightWorld:h,center:s})}},Xs=new Us("Sphere",Ps.regionFill,Ps.setValue,Zs,Ps.determineSegmentIndex,Ps.preview),Js=Xs.strategyFunction,Qs=new Us("SphereThreshold",...Xs.compositions,Ps.dynamicThreshold,Ps.threshold,Ps.islandRemoval).strategyFunction;const er=new Us("EraseSphere",Ps.erase,...Xs.compositions).strategyFunction,tr=new Us("EraseCircle",Ps.erase,...Ks.compositions).strategyFunction,nr=Symbol("DefinedCursors"),ir=new Set(["alias","all-scroll","auto","cell","col-resize","context-menu","copy","crosshair","default","e-resize","ew-resize","grab","grabbing","help","move","ne-resize","nesw-resize","no-drop","none","not-allowed","n-resize","ns-resize","nw-resize","nwse-resize","pointer","progress","row-resize","se-resize","s-resize","sw-resize","text","vertical-text","wait","w-resize","zoom-in","zoom-out"]);class or{constructor(e,t){this.name=e+"",this.fallback=t}getName(){return this.name+""}addFallbackStyleProperty(e){const{fallback:t}=this;return t instanceof or?`${e}, ${t.getStyleProperty()}`:e+""}getStyleProperty(){return this.addFallbackStyleProperty(this.name)+""}static getDefinedCursor(e){const t=ar(or,nr);let n=t.get(e);return n instanceof or?n:ir.has(e)?(n=new or(e),t.set(e,n),n):void 0}static setDefinedCursor(e,t){if(t instanceof or){return ar(or,nr).set(e,t),!0}return!1}}function ar(e,t){let n=e[t];return n instanceof Map||(n=new Map,Object.defineProperty(e,t,{value:n})),n}const sr=ir.values();class rr extends or{constructor(e,t,n,i,o){super(i||rr.getUniqueInstanceName("image-cursor"),o),this.url=e,this.x=Number(t)||0,this.y=Number(n)||0}getStyleProperty(){const{url:e,x:t,y:n}=this;let i=`url('${e}')`;return t>=0&&n>=0&&(t>0||n>0)&&(i+=` ${t} ${n}`),this.addFallbackStyleProperty(i)}static getUniqueInstanceName(e){return`${e}-${ne.utilities.getRuntimeId(rr)}`}}const lr={iconContent:"",iconSize:16,viewBox:{x:16,y:16},mousePoint:{x:8,y:8},mousePointerGroupString:'\n    <path stroke="{{color}}" d="M8 16L8 0"></path>\n    <path stroke="{{color}}" d="M16 8L0 8"></path>\n  '},dr={x:127,y:60},cr='\n<rect fill="{{color}}" x="80.19" y="25.03" width="47.14" height="15.85"/>\n',hr='\n<rect fill="{{color}}" x="80.19" y="25.03" width="47.14" height="15.85"/>\n<rect fill="{{color}}" x="95.84" y="9.38" width="15.85" height="47.14"/>\n',gr='<path fill="{{color}}" d="M82.89,10a12.09,12.09,0,0,0-16.8-2.5l-27.5,20.4-8.5-6.3a2.93,2.93,0,0,1-1.1-3,14.66,14.66,0,0,0,.1-6.6,14.08,14.08,0,1,0-6.5,15.2,2.87,2.87,0,0,1,3.2.2l8.2,6.1-8.2,6.1a2.87,2.87,0,0,1-3.2.2,14.16,14.16,0,1,0,6.7,14.4,14,14,0,0,0-.3-5.8,2.93,2.93,0,0,1,1.1-3l8.5-6.3,27.5,20.4A11.91,11.91,0,0,0,82.89,57l-31.7-23.5ZM15.29,21a5.9,5.9,0,1,1,5.9-5.9A5.91,5.91,0,0,1,15.29,21Zm0,36.8a5.9,5.9,0,1,1,5.9-5.9A5.91,5.91,0,0,1,15.29,57.77Zm28.3-21.5a2.8,2.8,0,1,1,2.8-2.8A2.8,2.8,0,0,1,43.59,36.27Z" transform="translate(-1.17 -0.96)"/>',ur='<path fill="{{color}}" d="M8.86,2.25V66.08H72.69V2.25H8.86ZM65.28,58.67h-49v-49h49v49Z" transform="translate(-8.86 -2.25)"/>',mr='<path fill="{{color}}" d="M40.77,2.25A31.92,31.92,0,1,0,72.69,34.16,31.92,31.92,0,0,0,40.77,2.25Zm0,57.63A25.71,25.71,0,1,1,66.48,34.16,25.71,25.71,0,0,1,40.77,59.87Z" transform="translate(-8.86 -2.25)"/>',vr={Angle:pr(lr,{iconContent:'<path fill="{{color}}" d="M1203 544q0 13-10 23l-393 393 393 393q10 10 10 23t-10 23l-50\n    50q-10 10-23 10t-23-10l-466-466q-10-10-10-23t10-23l466-466q10-10 23-10t23\n    10l50 50q10 10 10 23z" />',viewBox:{x:1792,y:1792}}),ArrowAnnotate:pr(lr,{iconContent:'<g id="arrowAnnotate-group" fill="none" stroke-width="1" stroke="{{color}}" stroke-linecap="round" stroke-linejoin="round">\n    <path id="arrowAnnotate-arrow" d="M23,7 l-15,15 M7,17 l0,6 6,0" stroke-width="2" />\n  </g>',viewBox:{x:24,y:24}}),Bidirectional:pr(lr,{iconContent:'<g fill="{{color}}" stroke-width="3" stroke="{{color}}">\n    <path d="M27.63 3.21L3.12 28.81"></path>\n    <path d="M27.63 15.75L15.27 4.43"></path>\n    <path d="M16.5 4.28C16.5 4.96 15.95 5.51 15.27 5.51C14.59 5.51 14.03 4.96 14.03 4.28C14.03 3.59 14.59 3.04 15.27 3.04C15.95 3.04 16.5 3.59 16.5 4.28Z" ></path>\n    <path d="M28.87 3.19C28.87 3.87 28.31 4.43 27.63 4.43C26.95 4.43 26.4 3.87 26.4 3.19C26.4 2.51 26.95 1.95 27.63 1.95C28.31 1.95 28.87 2.51 28.87 3.19Z"></path>\n    <path d="M28.87 15.75C28.87 16.43 28.31 16.99 27.63 16.99C26.95 16.99 26.4 16.43 26.4 15.75C26.4 15.07 26.95 14.51 27.63 14.51C28.31 14.51 28.87 15.07 28.87 15.75Z"></path>\n    <path d="M4.73 28.44C4.73 29.12 4.17 29.68 3.49 29.68C2.81 29.68 2.25 29.12 2.25 28.44C2.25 27.76 2.81 27.2 3.49 27.2C4.17 27.2 4.73 27.76 4.73 28.44Z"></path>\n  </g>',viewBox:{x:48,y:48}}),CobbAngle:pr(lr,{iconContent:'<g stroke="{{color}}" stroke-width="3">\n    <path d="M28.59 2.34L3.82 12.32"></path>\n    <path d="M28.59 29.66L3.82 19.68"></path>\n    <path stroke-dasharray="2" fill-opacity="0" d="M12.37\n      23.06C12.67 22.36 12.85 21.93 12.92 21.76C14.6 17.8 14.68 13.35 13.15\n      9.33C13.11 9.24 13.02 9 12.88 8.63">\n    </path>\n  </g>',viewBox:{x:32,y:32}}),CircleROI:pr(lr,{iconContent:'<circle stroke="{{color}}" fill="none" stroke-width="3" cx="16" cy="16" r="14" />',viewBox:{x:32,y:32}}),EllipticalROI:pr(lr,{iconContent:'<path stroke="{{color}}" fill="none" stroke-width="3" d="M30.74 15.76C30.74 20.99 24.14 25.23 16\n    25.23C7.86 25.23 1.26 20.99 1.26 15.76C1.26 10.54 7.86 6.3 16 6.3C24.14\n    6.3 30.74 10.54 30.74 15.76Z" />',viewBox:{x:32,y:32}}),FreehandROI:pr(lr,{iconContent:'<g fill="{{color}}" stroke="{{color}}" stroke-width="2">\n    <ellipse ry="1" rx="1" id="svg_3" cy="4.240343" cx="14.306499"/>\n    <line id="svg_4" y2="3.58462" x2="12.242186" y1="3.997482" x1="13.432202"/>\n    <line id="svg_5" y2="3.268901" x2="10.857882" y1="3.608906" x1="12.387902"/>\n    <line id="svg_6" y2="3.147471" x2="9.740724" y1="3.293187" x1="10.955026"/>\n    <line id="svg_7" y2="3.147471" x2="8.089274" y1="3.196043" x1="9.983585"/>\n    <line id="svg_8" y2="3.268901" x2="6.874972" y1="3.123185" x1="8.307848"/>\n    <line id="svg_9" y2="3.657478" x2="5.587812" y1="3.220329" x1="7.020688"/>\n    <line id="svg_10" y2="4.046054" x2="4.737801" y1="3.560334" x1="5.854959"/>\n    <line id="svg_11" y2="4.337487" x2="4.300652" y1="3.997482" x1="4.834945"/>\n    <line id="svg_12" y2="4.726063" x2="3.88779" y1="4.191771" x1="4.470655"/>\n    <line id="svg_15" y2="5.3575" x2="3.377783" y1="4.604633" x1="3.960648"/>\n    <line id="svg_16" y2="6.183226" x2="2.916348" y1="5.138926" x1="3.547785"/>\n    <line id="svg_17" y2="6.960379" x2="2.770632" y1="5.867507" x1="3.037779"/>\n    <line id="svg_18" y2="7.713246" x2="2.673488" y1="6.741804" x1="2.819204"/>\n    <line id="svg_19" y2="8.684687" x2="2.697774" y1="7.616102" x1="2.673488"/>\n    <line id="svg_20" y2="9.753273" x2="2.892062" y1="8.611829" x1="2.697774"/>\n    <line id="svg_21" y2="10.724714" x2="3.134923" y1="9.534698" x1="2.84349"/>\n    <line id="svg_23" y2="11.647583" x2="3.596357" y1="10.578998" x1="3.086351"/>\n    <line id="svg_25" y2="12.521881" x2="4.276366" y1="11.501867" x1="3.499213"/>\n    <line id="svg_26" y2="13.930471" x2="5.830673" y1="12.376165" x1="4.13065"/>\n    <line id="svg_28" y2="14.707624" x2="7.263549" y1="13.881899" x1="5.733528"/>\n    <line id="svg_29" y2="15.339061" x2="8.963571" y1="14.61048" x1="7.06926"/>\n    <line id="svg_30" y2="15.581921" x2="10.882168" y1="15.314775" x1="8.817855"/>\n    <line id="svg_31" y2="15.460491" x2="12.023612" y1="15.581921" x1="10.785024"/>\n    <line id="svg_33" y2="15.120487" x2="13.092197" y1="15.484777" x1="11.877895"/>\n    <line id="svg_34" y2="14.586194" x2="13.86935" y1="15.217631" x1="12.897909"/>\n    <line id="svg_35" y2="13.833327" x2="14.597931" y1="14.756196" x1="13.699348"/>\n    <line id="svg_37" y2="12.716169" x2="15.180796" y1="13.881899" x1="14.549359"/>\n    <line id="svg_39" y2="11.429009" x2="15.520801" y1="12.813313" x1="15.15651"/>\n    <ellipse ry="1" rx="1" id="svg_40" cy="10.967574" cx="15.520801"/>\n  </g>',viewBox:{x:18,y:18}}),FreehandROISculptor:pr(lr,{iconContent:'<g id="icon-freehand-sculpt" fill="none" stroke-width="1.5" stroke="{{color}}" stroke-linecap="round" stroke-linejoin="round">\n    <line id="svg_1" y2="2.559367" x2="10.184807" y1="4.467781" x1="8.81711"/>\n    <line id="svg_4" y2="1.493836" x2="11.727442" y1="2.766112" x1="10.089386"/>\n    <line id="svg_7" y2="1.080346" x2="13.047428" y1="1.748291" x1="11.345759"/>\n    <line id="svg_8" y2="1.000829" x2="14.351511" y1="1.112153" x1="12.77707"/>\n    <line id="svg_9" y2="1.350705" x2="15.242104" y1="0.905408" x1="13.969828"/>\n    <line id="svg_10" y2="2.098167" x2="15.862339" y1="1.14396" x1="14.955842"/>\n    <line id="svg_11" y2="3.195505" x2="16.41896" y1="1.939133" x1="15.766918"/>\n    <line id="svg_12" y2="4.292843" x2="16.530284" y1="2.925147" x1="16.387153"/>\n    <line id="svg_16" y2="5.644637" x2="16.196311" y1="3.831643" x1="16.593898"/>\n    <line id="svg_18" y2="7.266789" x2="15.623787" y1="5.19934" x1="16.275829"/>\n    <line id="svg_19" y2="10.813258" x2="14.526449" y1="6.726071" x1="15.766918"/>\n    <line id="svg_20" y2="5.056209" x2="8.085552" y1="4.181519" x1="8.976145"/>\n    <line id="svg_23" y2="5.326568" x2="7.481221" y1="4.78585" x1="8.403621"/>\n    <line id="svg_24" y2="5.565119" x2="6.749662" y1="5.294761" x1="7.624352"/>\n    <line id="svg_25" y2="5.994512" x2="5.429675" y1="5.533312" x1="6.956407"/>\n    <line id="svg_27" y2="6.551133" x2="4.284627" y1="5.962706" x1="5.572807"/>\n    <line id="svg_28" y2="7.584858" x2="3.044158" y1="6.392099" x1="4.427758"/>\n    <line id="svg_29" y2="8.84123" x2="2.185372" y1="7.489437" x1="3.219096"/>\n    <line id="svg_31" y2="10.606513" x2="1.644654" y1="8.602678" x1="2.280792"/>\n    <line id="svg_32" y2="13.214679" x2="1.48562" y1="10.352058" x1="1.724171"/>\n    <line id="svg_33" y2="14.375631" x2="1.676461" y1="12.992031" x1="1.453813"/>\n    <line id="svg_34" y2="15.298031" x2="2.264889" y1="14.152983" x1="1.517427"/>\n    <line id="svg_35" y2="16.172721" x2="3.521261" y1="14.948155" x1="1.915013"/>\n    <line id="svg_36" y2="16.824762" x2="5.207027" y1="15.997783" x1="3.28271"/>\n    <line id="svg_38" y2="17.063314" x2="7.035924" y1="16.745245" x1="4.968475"/>\n    <line id="svg_39" y2="16.888376" x2="9.278311" y1="17.047411" x1="6.733758"/>\n    <line id="svg_40" y2="16.284045" x2="10.661911" y1="16.983797" x1="8.992048"/>\n    <line id="svg_41" y2="15.313934" x2="11.647925" y1="16.395369" x1="10.455166"/>\n    <line id="svg_44" y2="13.898527" x2="12.82478" y1="15.425259" x1="11.504794"/>\n    <line id="svg_45" y2="12.037824" x2="14.144766" y1="14.312017" x1="12.522614"/>\n    <line id="svg_47" y2="10.59061" x2="14.605966" y1="12.228665" x1="13.953925"/>\n    <ellipse ry="1" rx="1" id="svg_48" cy="3.982726" cx="13.460918"/>\n  </g>',viewBox:{x:18,y:18}}),Length:pr(lr,{iconContent:'<g id="length-group" fill="none" stroke-width="1" stroke="{{color}}" stroke-linecap="round" stroke-linejoin="round">\n    <path id="length-dashes" d="m22.5,6 -16.5,16.5" stroke-width="3" stroke-dasharray="0.6666,5" />\n  </g>',viewBox:{x:24,y:24}}),Probe:pr(lr,{iconContent:'<path fill="{{color}}" d="M1152 896q0 106-75 181t-181 75-181-75-75-181 75-181 181-75 181 75\n    75 181zm-256-544q-148 0-273 73t-198 198-73 273 73 273 198 198 273 73 273-73\n    198-198 73-273-73-273-198-198-273-73zm768 544q0 209-103 385.5t-279.5\n    279.5-385.5 103-385.5-103-279.5-279.5-103-385.5 103-385.5 279.5-279.5\n    385.5-103 385.5 103 279.5 279.5 103 385.5z" />',viewBox:{x:1792,y:1792}}),RectangleROI:pr(lr,{iconContent:'<path fill="{{color}}" d="M1312 256h-832q-66 0-113 47t-47 113v832q0 66 47\n    113t113 47h832q66 0 113-47t47-113v-832q0-66-47-113t-113-47zm288 160v832q0\n    119-84.5 203.5t-203.5 84.5h-832q-119 0-203.5-84.5t-84.5-203.5v-832q0-119\n    84.5-203.5t203.5-84.5h832q119 0 203.5 84.5t84.5 203.5z" />',viewBox:{x:1792,y:1792}}),TextMarker:pr(lr,{iconContent:'<path fill="{{color}}" d="M789 559l-170 450q33 0 136.5 2t160.5 2q19 0\n    57-2-87-253-184-452zm-725 1105l2-79q23-7 56-12.5t57-10.5 49.5-14.5 44.5-29\n    31-50.5l237-616 280-724h128q8 14 11 21l205 480q33 78 106 257.5t114 274.5q15\n    34 58 144.5t72 168.5q20 45 35 57 19 15 88 29.5t84 20.5q6 38 6 57 0 5-.5\n    13.5t-.5 12.5q-63 0-190-8t-191-8q-76 0-215 7t-178 8q0-43 4-78l131-28q1 0\n    12.5-2.5t15.5-3.5 14.5-4.5 15-6.5 11-8 9-11\n    2.5-14q0-16-31-96.5t-72-177.5-42-100l-450-2q-26 58-76.5 195.5t-50.5 162.5q0\n    22 14 37.5t43.5 24.5 48.5 13.5 57 8.5 41 4q1 19 1 58 0 9-2 27-58\n    0-174.5-10t-174.5-10q-8 0-26.5 4t-21.5 4q-80 14-188 14z" />',viewBox:{x:1792,y:1792}}),Crosshairs:pr(lr,{iconContent:'<path fill="{{color}}" d="M1325 1024h-109q-26 0-45-19t-19-45v-128q0-26\n    19-45t45-19h109q-32-108-112.5-188.5t-188.5-112.5v109q0 26-19 45t-45\n    19h-128q-26 0-45-19t-19-45v-109q-108 32-188.5 112.5t-112.5 188.5h109q26\n    0 45 19t19 45v128q0 26-19 45t-45 19h-109q32 108 112.5 188.5t188.5\n    112.5v-109q0-26 19-45t45-19h128q26 0 45 19t19 45v109q108-32\n    188.5-112.5t112.5-188.5zm339-192v128q0 26-19 45t-45 19h-143q-37 161-154.5\n    278.5t-278.5 154.5v143q0 26-19 45t-45 19h-128q-26\n    0-45-19t-19-45v-143q-161-37-278.5-154.5t-154.5-278.5h-143q-26\n    0-45-19t-19-45v-128q0-26 19-45t45-19h143q37-161\n    154.5-278.5t278.5-154.5v-143q0-26 19-45t45-19h128q26 0 45 19t19 45v143q161\n    37 278.5 154.5t154.5 278.5h143q26 0 45 19t19 45z" />',viewBox:{x:1792,y:1792}}),Eraser:pr(lr,{iconContent:'<path transform="translate(0,1792) scale(1,-1)" fill="{{color}}" d="M960 1408l336-384h-768l-336 384h768zm1013-1077q15\n    34 9.5 71.5t-30.5 65.5l-896 1024q-38 44-96 44h-768q-38\n    0-69.5-20.5t-47.5-54.5q-15-34-9.5-71.5t30.5-65.5l896-1024q38-44 96-44h768q38\n    0 69.5 20.5t47.5 54.5z" />',viewBox:{x:2048,y:1792}}),Magnify:pr(lr,{iconContent:'<path fill="{{color}}" d="M508.5 481.6l-129-129c-2.3-2.3-5.3-3.5-8.5-3.5h-10.3C395\n    312 416 262.5 416 208 416 93.1 322.9 0 208 0S0 93.1 0 208s93.1 208 208 208c54.5\n    0 104-21 141.1-55.2V371c0 3.2 1.3 6.2 3.5 8.5l129 129c4.7 4.7 12.3 4.7 17\n    0l9.9-9.9c4.7-4.7 4.7-12.3 0-17zM208 384c-97.3 0-176-78.7-176-176S110.7 32 208\n    32s176 78.7 176 176-78.7 176-176 176z" />',viewBox:{x:512,y:512}}),Pan:pr(lr,{iconContent:'<path fill="{{color}}" d="M1411 541l-355 355 355 355 144-144q29-31 70-14 39 17\n    39 59v448q0 26-19 45t-45 19h-448q-42 0-59-40-17-39 14-69l144-144-355-355-355\n    355 144 144q31 30 14 69-17 40-59 40h-448q-26 0-45-19t-19-45v-448q0-42 40-59\n    39-17 69 14l144 144 355-355-355-355-144 144q-19 19-45 19-12\n    0-24-5-40-17-40-59v-448q0-26 19-45t45-19h448q42 0 59 40 17 39-14 69l-144\n    144 355 355 355-355-144-144q-31-30-14-69 17-40 59-40h448q26 0 45 19t19\n    45v448q0 42-39 59-13 5-25 5-26 0-45-19z" />',viewBox:{x:1792,y:1792}}),Rotate:pr(lr,{iconContent:'<path fill="{{color}}" d="M1664 256v448q0 26-19 45t-45 19h-448q-42 0-59-40-17-39\n    14-69l138-138q-148-137-349-137-104 0-198.5 40.5t-163.5 109.5-109.5\n    163.5-40.5 198.5 40.5 198.5 109.5 163.5 163.5 109.5 198.5 40.5q119 0\n    225-52t179-147q7-10 23-12 15 0 25 9l137 138q9 8 9.5 20.5t-7.5 22.5q-109\n    132-264 204.5t-327 72.5q-156 0-298-61t-245-164-164-245-61-298 61-298\n    164-245 245-164 298-61q147 0 284.5 55.5t244.5 156.5l130-129q29-31 70-14\n    39 17 39 59z" />',viewBox:{x:1792,y:1792}}),StackScroll:pr(lr,{iconContent:'<path fill="{{color}}" d="M24 21v2c0 0.547-0.453 1-1 1h-22c-0.547\n    0-1-0.453-1-1v-2c0-0.547 0.453-1 1-1h22c0.547 0 1 0.453 1 1zM24 13v2c0\n    0.547-0.453 1-1 1h-22c-0.547 0-1-0.453-1-1v-2c0-0.547 0.453-1 1-1h22c0.547\n    0 1 0.453 1 1zM24 5v2c0 0.547-0.453 1-1 1h-22c-0.547\n    0-1-0.453-1-1v-2c0-0.547 0.453-1 1-1h22c0.547 0 1 0.453 1 1z" />',viewBox:{x:24,y:28}}),WindowLevelRegion:pr(lr,{iconContent:'<path fill="{{color}}" d="M1664 416v960q0 119-84.5 203.5t-203.5 84.5h-960q-119\n    0-203.5-84.5t-84.5-203.5v-960q0-119 84.5-203.5t203.5-84.5h960q119 0 203.5\n    84.5t84.5 203.5z" />',viewBox:{x:1792,y:1792}}),WindowLevel:pr(lr,{iconContent:'\n    <path fill="{{color}}" d="M14.5,3.5 a1 1 0 0 1 -11,11 Z" stroke="none" opacity="0.8" />\n    <circle cx="9" cy="9" r="8" fill="none" stroke-width="2" stroke="{{color}}" />',viewBox:{x:18,y:18}}),Zoom:pr(lr,{iconContent:'\n  <path fill="{{color}}" d="M508.5 481.6l-129-129c-2.3-2.3-5.3-3.5-8.5-3.5h-10.3C395\n    312 416 262.5 416 208 416 93.1 322.9 0 208 0S0 93.1 0 208s93.1 208 208 208c54.5\n    0 104-21 141.1-55.2V371c0 3.2 1.3 6.2 3.5 8.5l129 129c4.7 4.7 12.3 4.7 17\n    0l9.9-9.9c4.7-4.7 4.7-12.3 0-17zM208 384c-97.3 0-176-78.7-176-176S110.7 32 208\n    32s176 78.7 176 176-78.7 176-176 176z" />\n  <path fill="{{color}}" transform="scale(0.22,0.22) translate(1400,0)" d="M1216\n    320q0 26-19 45t-45 19h-128v1024h128q26 0 45 19t19 45-19 45l-256 256q-19\n    19-45 19t-45-19l-256-256q-19-19-19-45t19-45 45-19h128v-1024h-128q-26\n    0-45-19t-19-45 19-45l256-256q19-19 45-19t45 19l256 256q19 19 19 45z" />',viewBox:{x:640,y:512}}),SegmentationFreeHandEraseInside:pr(lr,{iconContent:`${gr} ${cr}`,viewBox:dr}),SegmentationFreeHandFillInside:pr(lr,{iconContent:`${gr} ${hr}`,viewBox:dr}),SegmentationFreeHandEraseOutside:pr(lr,{iconContent:`${gr} ${cr}`,viewBox:dr}),SegmentationFreeHandFillOutside:pr(lr,{iconContent:`${gr} ${hr}`,viewBox:dr}),SegmentationRectangleEraseInside:pr(lr,{iconContent:`${ur} ${cr}`,viewBox:dr}),RectangleScissor:pr(lr,{iconContent:`${ur} ${hr}`,viewBox:dr}),"RectangleScissor.FILL_INSIDE":pr(lr,{iconContent:`${ur} ${hr}`,viewBox:dr}),"RectangleScissor.FILL_OUTSIDE":pr(lr,{iconContent:`${ur} ${hr}`,viewBox:dr}),"RectangleScissor.ERASE_OUTSIDE":pr(lr,{iconContent:`${ur} ${cr}`,viewBox:dr}),"RectangleScissor.ERASE_INSIDE":pr(lr,{iconContent:`${ur} ${cr}`,viewBox:dr}),CircleScissor:pr(lr,{iconContent:`${mr} ${hr}`,viewBox:dr}),"CircleScissor.FILL_INSIDE":pr(lr,{iconContent:`${mr} ${hr}`,viewBox:dr}),"CircleScissor.ERASE_OUTSIDE":pr(lr,{iconContent:`${mr} ${cr}`,viewBox:dr}),"CircleScissor.FILL_OUTSIDE":pr(lr,{iconContent:`${mr} ${hr}`,viewBox:dr})};function pr(e,t){return Object.assign(Object.create(e),t)}function fr(e,t,n){vr[e]=pr(lr,{iconContent:t,viewBox:n})}const Er=Object.keys(vr),wr=ae.Highlighted,Ir=ie.Active;class Cr extends rr{constructor(e,t,n,i,o){super(e,t,n,i,o)}static getDefinedCursor(e,t=!1,n){n||(n=va("color",{},wr,Ir));const i=function(e,t,n){const i=t?"pointer":"cursor";return`${i}:${e}/${n}`}(e,t,n);let o=super.getDefinedCursor(i);if(!o){const a=function(e){return vr[e]}(e);a&&(o=function(e,t,n,i,o){const{x:a,y:s}=e.mousePoint;return new Cr(function(e,t,n){return URL.createObjectURL(function(e,t,n){const i=(t?br:Tr)(e,n);return new Blob([i],{type:"image/svg+xml"})}(e,t,n))}(e,n,{color:i}),a,s,t,o)}(a,i,t,n,super.getDefinedCursor("default")),super.setDefinedCursor(i,o))}return o}}function _r(e,t){const n=Object(t),i=Object.prototype.hasOwnProperty.bind(n);return(e+"").replace(/\{\{(\w+)\}\}/g,((e,t)=>i(t)?n[t]+"":""))}function Tr(e,t){const{iconContent:n,iconSize:i,viewBox:o}=e;return _r(`\n    <svg data-icon="cursor" role="img" xmlns="http://www.w3.org/2000/svg"\n      width="${i}" height="${i}" viewBox="0 0\n      ${o.x} ${o.y}">\n      ${n}\n    </svg>`,t)}function br(e,t){const{iconContent:n,iconSize:i,viewBox:o,mousePointerGroupString:a}=e,s=16+i;return _r(`\n    <svg data-icon="cursor" role="img" xmlns="http://www.w3.org/2000/svg"\n      width="${s}" height="${s}" viewBox="0 0 ${s} ${s}">\n      <g>${a}</g>\n      <g transform="translate(16, 16) scale(${i/Math.max(o.x,o.y,1)})">${n}</g>\n    </svg>`,t)}const Dr=function(e,t){let n=Cr.getDefinedCursor(t,!0);n||(n=or.getDefinedCursor(t)),n||(console.log(`Cursor ${t} is not defined either as SVG or as a standard cursor.`),n=or.getDefinedCursor(t)),Or(e,n)},Sr=[...Er,...sr],Mr=Symbol("ElementCursorsMap");function yr(e,t){Pr(e)[0]=t,Or(e,t)}function Or(e,t){const n=Pr(e);n[1]=n[0],n[0]=t,e.style.cursor=(t instanceof or?t:or.getDefinedCursor("auto")).getStyleProperty()}function xr(e){Or(e,Pr(e)[1])}function Rr(e){Or(e,or.getDefinedCursor("none"))}function Pr(e){let t=Pr[Mr];t instanceof WeakMap||(t=new WeakMap,Object.defineProperty(Pr,Mr,{value:t}));let n=t.get(e);return n||(n=[null,null],t.set(e,n)),n}class Nr extends yo{constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"],configuration:{strategies:{FILL_INSIDE_CIRCLE:zs,ERASE_INSIDE_CIRCLE:tr,FILL_INSIDE_SPHERE:Js,ERASE_INSIDE_SPHERE:er,THRESHOLD_INSIDE_CIRCLE:js,THRESHOLD_INSIDE_SPHERE:Qs},strategySpecificConfiguration:{THRESHOLD:{threshold:[-150,-70]}},defaultStrategy:"FILL_INSIDE_CIRCLE",activeStrategy:"FILL_INSIDE_CIRCLE",brushSize:25,preview:{enabled:!1,previewColors:{},previewTimeMs:250,previewMoveDistance:8,dragMoveDistance:4,dragTimeMs:500},centerRadius:2,actions:{[ge.AcceptPreview]:{method:ge.AcceptPreview,bindings:[{key:"Enter"}]},[ge.RejectPreview]:{method:ge.RejectPreview,bindings:[{key:"Escape"}]}}}}){super(e,t),this._previewData={preview:null,element:null,timerStart:0,timer:null,startPoint:[NaN,NaN],isDrag:!1},this.onSetToolPassive=e=>{this.disableCursor()},this.onSetToolEnabled=()=>{this.disableCursor()},this.onSetToolDisabled=e=>{this.disableCursor()},this.preMouseDownCallback=e=>{const t=e.detail,{element:n}=t,i=(0,ne.getEnabledElement)(n),{renderingEngine:o}=i;return this._editData=this.createEditData(n),this._activateDraw(n),Rr(n),e.preventDefault(),this._previewData.isDrag=!1,this._previewData.timerStart=Date.now(),cs(o,this._hoverData.viewportIdsToRender),this.applyActiveStrategyCallback(i,this.getOperationData(n),ge.OnInteractionStart),!0},this.mouseMoveCallback=e=>{if(this.mode===ie.Active){if(this.updateCursor(e),!this.configuration.preview.enabled)return;const{previewTimeMs:t,previewMoveDistance:n,dragMoveDistance:i}=this.configuration.preview,{currentPoints:o,element:a}=e.detail,{canvas:s}=o,{preview:r,startPoint:l,timer:d,timerStart:c,isDrag:h}=this._previewData,g=Oo.K4.distance(s,l),u=Date.now()-c;if((g>n||u>t&&g>i)&&(d&&(window.clearTimeout(d),this._previewData.timer=null),r&&!h&&this.rejectPreview(a)),!this._previewData.timer){const e=window.setTimeout(this.previewCallback,250);Object.assign(this._previewData,{timerStart:Date.now(),timer:e,startPoint:s,element:a})}}},this.previewCallback=()=>{this._previewData.preview||(this._previewData.timer=null,this._previewData.preview=this.applyActiveStrategyCallback((0,ne.getEnabledElement)(this._previewData.element),this.getOperationData(this._previewData.element),ge.Preview))},this._dragCallback=e=>{const t=e.detail,{element:n,currentPoints:i}=t,o=(0,ne.getEnabledElement)(n),{renderingEngine:a}=o;this.updateCursor(e);const{viewportIdsToRender:s}=this._hoverData;cs(a,s);const r=Oo.K4.distance(i.canvas,this._previewData.startPoint),{dragTimeMs:l,dragMoveDistance:d}=this.configuration.preview;!this._previewData.isDrag&&this._previewData.preview&&Date.now()-this._previewData.timerStart<l&&r<d||(this._previewData.preview=this.applyActiveStrategy(o,this.getOperationData()),this._previewData.element=n,this._previewData.timerStart=Date.now()+l,this._previewData.isDrag=!0,this._previewData.startPoint=i.canvas)},this._endCallback=e=>{const t=e.detail,{element:n}=t,i=(0,ne.getEnabledElement)(n),o=this.getOperationData(n);this._previewData.preview||this._previewData.isDrag||this.applyActiveStrategy(i,o),this._deactivateDraw(n),xr(n),this.updateCursor(e),this._editData=null,this.applyActiveStrategyCallback(i,o,ge.OnInteractionEnd),this._previewData.isDrag||this.acceptPreview(n)},this._activateDraw=e=>{e.addEventListener(re.MOUSE_UP,this._endCallback),e.addEventListener(re.MOUSE_DRAG,this._dragCallback),e.addEventListener(re.MOUSE_CLICK,this._endCallback)},this._deactivateDraw=e=>{e.removeEventListener(re.MOUSE_UP,this._endCallback),e.removeEventListener(re.MOUSE_DRAG,this._dragCallback),e.removeEventListener(re.MOUSE_CLICK,this._endCallback)}}disableCursor(){this._hoverData=void 0,this.rejectPreview()}createEditData(e){const t=(0,ne.getEnabledElement)(e),{viewport:n,renderingEngine:i}=t,o=go(this.toolGroupId);if(!o)throw new Error("No active segmentation detected, create one before using the brush tool");const{segmentationId:a,type:s,segmentationRepresentationUID:r}=o;if(s===de.Contour)throw new Error("Not implemented yet");const l=po(a),{representationData:d}=ti(a),c=d[de.Labelmap];n.id;if(Ti(c)){const{volumeId:e}=d[s];return{volumeId:e,referencedVolumeId:n.getActors()[0].uid,segmentsLocked:l,segmentationRepresentationUID:r}}{const{imageIdReferenceMap:e}=c,t=n.getCurrentImageId();if(!e.get(t))return;return this.configuration.activeStrategy.includes("SPHERE")?void console.warn("Sphere manipulation is not supported for this stack of images yet"):{imageIdReferenceMap:e,segmentsLocked:l,segmentationRepresentationUID:r}}}createHoverData(e,t){const n=(0,ne.getEnabledElement)(e),{viewport:i}=n,o=i.getCamera(),{viewPlaneNormal:a,viewUp:s}=o,r=this.toolGroupId,l=go(r);if(!l)return void console.warn("No active segmentation detected, create one before using the brush tool");const{segmentationRepresentationUID:d,segmentationId:c}=l,h=So(c),g=wo(r,d,h),u=[i.id];return{brushCursor:{metadata:{viewPlaneNormal:[...a],viewUp:[...s],FrameOfReferenceUID:i.getFrameOfReferenceUID(),referencedImageId:"",toolName:this.getToolName(),segmentColor:g},data:{}},centerCanvas:t,segmentIndex:h,segmentationId:c,segmentationRepresentationUID:d,segmentColor:g,viewportIdsToRender:u}}updateCursor(e){const t=e.detail,{element:n}=t,{currentPoints:i}=t,o=i.canvas;this._hoverData=this.createHoverData(n,o),this._calculateCursor(n,o),cs((0,ne.getEnabledElement)(n).renderingEngine,this._hoverData.viewportIdsToRender)}getOperationData(e){const t=this._editData||this.createEditData(e),{segmentIndex:n,segmentationId:i,segmentationRepresentationUID:o,brushCursor:a}=this._hoverData||this.createHoverData(e),{data:s,metadata:r={}}=a||{},{viewPlaneNormal:l,viewUp:d}=r;return{...t,points:s?.handles?.points,segmentIndex:n,previewColors:this.configuration.preview.enabled?this.configuration.preview.previewColors:null,viewPlaneNormal:l,toolGroupId:this.toolGroupId,segmentationId:i,segmentationRepresentationUID:o,viewUp:d,strategySpecificConfiguration:this.configuration.strategySpecificConfiguration,preview:this._previewData?.preview}}_calculateCursor(e,t){const n=(0,ne.getEnabledElement)(e),{viewport:i}=n,{canvasToWorld:o}=i,a=i.getCamera(),{brushSize:s}=this.configuration,r=Oo.R3.fromValues(a.viewUp[0],a.viewUp[1],a.viewUp[2]),l=Oo.R3.fromValues(a.viewPlaneNormal[0],a.viewPlaneNormal[1],a.viewPlaneNormal[2]),d=Oo.R3.create();Oo.R3.cross(d,r,l);const c=o([t[0],t[1]]),h=Oo.R3.create(),g=Oo.R3.create(),u=Oo.R3.create(),m=Oo.R3.create();for(let e=0;e<=2;e++)h[e]=c[e]-r[e]*s,g[e]=c[e]+r[e]*s,u[e]=c[e]-d[e]*s,m[e]=c[e]+d[e]*s;const{brushCursor:v}=this._hoverData,{data:p}=v;void 0===p.handles&&(p.handles={}),p.handles.points=[h,g,u,m],p.invalidated=!1}rejectPreview(e=this._previewData.element){if(!e||!this._previewData.preview)return;const t=(0,ne.getEnabledElement)(e);this.applyActiveStrategyCallback(t,this.getOperationData(e),ge.RejectPreview),this._previewData.preview=null,this._previewData.isDrag=!1}acceptPreview(e=this._previewData.element){if(!e)return;const t=(0,ne.getEnabledElement)(e);this.applyActiveStrategyCallback(t,this.getOperationData(e),ge.AcceptPreview),this._previewData.isDrag=!1,this._previewData.preview=null}invalidateBrushCursor(){if(void 0!==this._hoverData){const{data:e}=this._hoverData.brushCursor;e.invalidated=!0}}renderAnnotation(e,t){if(!this._hoverData)return;const{viewport:n}=e;if(!this._hoverData.viewportIdsToRender.includes(n.id))return;const i=this._hoverData.brushCursor;if(!0===i.data.invalidated){const{centerCanvas:e}=this._hoverData,{element:t}=n;this._calculateCursor(t,e)}const o=i.metadata,a=o.brushCursorUID,s=i.data,{points:r}=s.handles,l=r.map((e=>n.worldToCanvas(e))),d=l[0],c=l[1],h=[Math.floor((d[0]+c[0])/2),Math.floor((d[1]+c[1])/2)],g=Math.abs(d[1]-Math.floor((d[1]+c[1])/2)),u=`rgb(${o.segmentColor.slice(0,3)})`;if(!n.getRenderingEngine())return void console.warn("Rendering Engine has been destroyed");Ho(t,a,"0",h,g,{color:u});const{centerRadius:m}=this.configuration;if(m>=0){Ho(t,a,"1",h,2,{color:u})}}}Nr.toolName="Brush";const Lr=Nr;function Ar(e,t){const n=Jv(e);if(void 0===n)return;const i=n._toolInstances;if(!Object.keys(i).length)return;if(t&&i[t])return[i[t]];return Object.values(i).filter((e=>e instanceof Lr))}const kr=(e,t)=>JSON.stringify(e)===JSON.stringify(t);function Ur(e,t,n,i){const o=[];for(let e=0;e<2;e++)for(let t=0;t<2;t++)for(let a=0;a<2;a++){const s=[...i];s[0]=s[0]+(2*e-1)*n[0]/2,s[1]=s[1]+(2*t-1)*n[1]/2,s[2]=s[2]+(2*a-1)*n[2]/2,o.push(s)}const a=o.map((t=>ne.utilities.transformWorldToIndex(e,t)));return ps(a,t)}function Vr(e,t){const{spacing:n}=e,i=e.getScalarData(),o=[];let a=0;for(let e=0;e<t.length;e++){const{imageData:s,spacing:r,dimensions:l}=t[e].volume,d=t[e].volume.getScalarData().length;d===i.length&&kr(r,n)&&(a=e);const c=s.getPointData().getScalars().getData(),h=t[e].lower,g=t[e].upper;o.push({imageData:s,referenceValues:c,lower:h,upper:g,spacing:r,dimensions:l,volumeSize:d})}return{volumeInfoList:o,baseVolumeIdx:a}}const Wr=function(e,t,n){const{imageData:i}=e,o=e.getScalarData(),{overwrite:a,boundsIJK:s}=n,r=n?.overlapType||0;if(a)for(let e=0;e<o.length;e++)o[e]=0;const{baseVolumeIdx:l,volumeInfoList:d}=Vr(e,t);let c,h,g;const u=(e,t,n)=>{const{imageData:i,dimensions:o,lower:a,upper:s}=e,l=Ur(i,o,t,n);h=0,c=0,g={lower:a,upper:s};let d=!1;return us(i,(()=>!0),(({value:e})=>{h+=1,e>=g.lower&&e<=g.upper&&(c+=1)}),l),0===r?d=c>0:1==r&&(d=c===h),d},m=(e,t)=>{const{imageData:n,referenceValues:i,lower:o,upper:a}=e,s=i[n.computeOffsetIndex(t)];return!(s<=o||s>=a)};return us(i,(()=>!0),(({index:e,pointIJK:t,pointLPS:n})=>{let i=d.length>0;for(let e=0;e<d.length&&(i=d[e].volumeSize===o.length?m(d[e],t):u(d[e],d[l].spacing,n),i);e++);i&&(o[e]=1)}),s),Jn(e.volumeId),e};class Hr{constructor(){this.annotationUIDs=new Set,this._isVisible=!0,this.visibleFilter=this.unboundVisibleFilter.bind(this)}unboundVisibleFilter(e){return!this._isVisible||!this.annotationUIDs.has(e)}has(e){return this.annotationUIDs.has(e)}setVisible(e=!0,t,n){this._isVisible!==e&&(this._isVisible=e,this.annotationUIDs.forEach((i=>{const o=cp(i);if(!o)return void this.annotationUIDs.delete(i);if(o.isVisible===e)return;if(!e&&!1===n?.(i))return;o.isVisible=e;const a={...t,annotation:o};(0,ne.triggerEvent)(ne.eventTarget,re.ANNOTATION_MODIFIED,a)})))}get isVisible(){return this._isVisible}findNearby(e,t){const n=[...this.annotationUIDs];if(0===n.length)return null;if(!e)return n[1===t?0:n.length-1];const i=n.indexOf(e);return-1===i||i+t<0||i+t>=n.length?null:n[i+t]}add(...e){e.forEach((e=>this.annotationUIDs.add(e)))}remove(...e){e.forEach((e=>this.annotationUIDs.delete(e)))}clear(){this.annotationUIDs.clear()}}class Br extends yo{constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"]}){super(e,t)}touchDragCallback(e){this._dragCallback(e)}mouseDragCallback(e){this._dragCallback(e)}_dragCallback(e){const{element:t,deltaPoints:n}=e.detail,i=(0,ne.getEnabledElement)(t),o=n.world,a=i.viewport.getCamera(),{focalPoint:s,position:r}=a,l=[r[0]-o[0],r[1]-o[1],r[2]-o[2]],d=[s[0]-o[0],s[1]-o[1],s[2]-o[2]];i.viewport.setCamera({focalPoint:d,position:l}),i.viewport.render()}}Br.toolName="Pan";const Fr=Br;var Gr=n(32899);class $r extends yo{constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"],configuration:{rotateIncrementDegrees:2}}){super(e,t),this.rotateCamera=(e,t,n,i)=>{const o=e.getVtkActiveCamera(),a=o.getViewUp(),s=o.getFocalPoint(),r=o.getPosition(),l=[0,0,0],d=[0,0,0],c=[0,0,0],h=Oo._E.identity(new Float32Array(16));Oo._E.translate(h,h,t),Oo._E.rotate(h,h,i,n),Oo._E.translate(h,h,[-t[0],-t[1],-t[2]]),Oo.R3.transformMat4(l,r,h),Oo.R3.transformMat4(d,s,h),Oo._E.identity(h),Oo._E.rotate(h,h,i,n),Oo.R3.transformMat4(c,a,h),e.setCamera({position:l,viewUp:c,focalPoint:d})},this.touchDragCallback=this._dragCallback.bind(this),this.mouseDragCallback=this._dragCallback.bind(this)}_dragCallback(e){const{element:t,currentPoints:n,lastPoints:i}=e.detail,o=n.canvas,a=i.canvas,{rotateIncrementDegrees:s}=this.configuration,r=(0,ne.getEnabledElement)(t),{viewport:l}=r,d=l.getCamera(),c=t.clientWidth,h=t.clientHeight,g=[o[0]/c,o[1]/h],u=[a[0]/c,a[1]/h],m=[.5*c,.5*h],v=l.canvasToWorld(m),p=(1+Math.abs(.5))**2,f=[u[0],0,0],E=[g[0],0,0],w=f[0]**2,I=E[0]**2,C=w>p?0:Math.sqrt(p-w),_=I>p?0:Math.sqrt(p-I),T=[f[0],0,C];Gr.ZP.normalize(T);const b=[E[0],0,_];Gr.ZP.normalize(b);const D=Gr.ZP.dot(T,b);if(Math.abs(D)>1e-4){const e=-2*Math.acos(Gr.ZP.clampValue(D,-1,1))*Math.sign(g[0]-u[0])*s,t=d.viewUp,n=d.viewPlaneNormal,i=[0,0,0],o=[0,0,0];Gr.ZP.cross(t,n,i),Gr.ZP.normalize(i),Gr.ZP.cross(n,i,o),Gr.ZP.normalize(o),Gr.ZP.normalize(t),this.rotateCamera(l,v,o,e);const a=(u[1]-g[1])*s;this.rotateCamera(l,v,i,a),l.render()}}}$r.toolName="TrackballRotate";const Kr=$r;class qr extends yo{constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"]}){super(e,t),this._getImageDynamicRangeFromMiddleSlice=(e,t)=>{const n=Math.floor(t[2]/2),i=t[0]*t[1];let o,a;e instanceof Float32Array?(o=4,a=Float32Array):e instanceof Uint8Array?(o=1,a=Uint8Array):e instanceof Uint16Array?(o=2,a=Uint16Array):e instanceof Int16Array&&(o=2,a=Int16Array);const s=new a(e.buffer,n*i*o,i),{max:r,min:l}=this._getMinMax(s,i);return r-l}}touchDragCallback(e){this.mouseDragCallback(e)}mouseDragCallback(e){const{element:t,deltaPoints:n}=e.detail,i=(0,ne.getEnabledElement)(t),{renderingEngine:o,viewport:a}=i;let s,r,l,d,c,h,g=!1;const u=a.getProperties();if(a instanceof ne.VolumeViewport){s=this.getTargetId(a).split("volumeId:")[1],h=ne.utilities.getViewportsWithVolumeId(s,o.id),({lower:r,upper:l}=u.voiRange);const e=ne.cache.getVolume(s);if(!e)throw new Error("Volume not found "+s);d=e.metadata.Modality,g=e.scaling&&Object.keys(e.scaling).length>0}else{if(!u.voiRange)throw new Error("Viewport is not a valid type");{d=a.modality,({lower:r,upper:l}=u.voiRange);const{preScale:e={scaled:!1}}=a.getImageData?.()||{};g=e.scaled&&void 0!==e.scalingParameters?.suvbw}}c="PT"===d?this.getPTScaledNewRange({deltaPointsCanvas:n.canvas,lower:r,upper:l,clientHeight:t.clientHeight,isPreScaled:g,viewport:a,volumeId:s}):this.getNewRange({viewport:a,deltaPointsCanvas:n.canvas,volumeId:s,lower:r,upper:l}),a.setProperties({voiRange:c}),a.render(),a instanceof ne.VolumeViewport&&h.forEach((e=>{a!==e&&e.render()}))}getPTScaledNewRange({deltaPointsCanvas:e,lower:t,upper:n,clientHeight:i,viewport:o,volumeId:a,isPreScaled:s}){let r=4;r=s?5/i:this._getMultiplierFromDynamicRange(o,a)||4;return n-=e[1]*r,{lower:t,upper:n=s?Math.max(n,.1):n}}getNewRange({viewport:e,deltaPointsCanvas:t,volumeId:n,lower:i,upper:o}){const a=this._getMultiplierFromDynamicRange(e,n)||4,s=t[0]*a,r=t[1]*a;let{windowWidth:l,windowCenter:d}=ne.utilities.windowLevel.toWindowLevel(i,o);return l+=s,d+=r,l=Math.max(l,1),ne.utilities.windowLevel.toLowHighRange(l,d)}_getMultiplierFromDynamicRange(e,t){let n;if(t){const e=ne.cache.getVolume(t),{dimensions:i}=e,o=e.getScalarData(),a=this._getImageDynamicRangeFromMiddleSlice(o,i),s=e?.metadata?.BitsStored,r=s?2**s:1/0;n=Math.min(a,r)}else n=this._getImageDynamicRangeFromViewport(e);const i=n/1024;let o=4;return i>1&&(o=Math.round(i)),o}_getImageDynamicRangeFromViewport(e){const{imageData:t}=e.getImageData(),n=t.getDimensions();if(t.getRange)return t.getRange();let i,o;if(i=t.getScalarData?t.getScalarData():t.getPointData().getScalars(),1!==n[2])return this._getImageDynamicRangeFromMiddleSlice(i,n);if(i.getRange)o=i.getRange();else{const{min:e,max:t}=this._getMinMax(i,i.length);o=[e,t]}return o[1]-o[0]}_getMinMax(e,t){let n=1/0,i=-1/0;for(let o=0;o<t;o++){const t=e[o];t<n&&(n=t),t>i&&(i=t)}return{max:i,min:n}}}qr.toolName="WindowLevel";const zr=qr;class jr extends yo{constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"],configuration:{invert:!1,debounceIfNotLoaded:!0,loop:!1}}){super(e,t),this.deltaY=1}mouseDragCallback(e){this._dragCallback(e)}touchDragCallback(e){this._dragCallback(e)}_dragCallback(e){const{deltaPoints:t,viewportId:n,renderingEngineId:i}=e.detail,{viewport:o}=(0,ne.getEnabledElementByIds)(n,i),a=this.getTargetId(o),{debounceIfNotLoaded:s,invert:r,loop:l}=this.configuration,d=t.canvas[1];let c;o instanceof ne.VolumeViewport&&(c=a.split("volumeId:")[1]);const h=this._getPixelPerImage(o),g=d+this.deltaY;if(h)if(Math.abs(g)>=h){const e=Math.round(g/h);hs(o,{delta:r?-e:e,volumeId:c,debounceLoading:s,loop:l}),this.deltaY=g%h}else this.deltaY=g}_getPixelPerImage(e){const{element:t}=e,n=e.getNumberOfSlices();return Math.max(2,t.offsetHeight/Math.max(n,8))}}jr.toolName="StackScroll";const Yr=jr;function Zr(e,t){return 3===e[0].length?function(e,t){const[n,i]=e,[o,a]=t,s=Oo.R3.sub(Oo.R3.create(),i,n),r=Oo.R3.sub(Oo.R3.create(),o,a),l=Oo.R3.dot(s,r)/(Oo.R3.length(s)*Oo.R3.length(r));return 180*Math.acos(l)/Math.PI}(e,t):function(e,t){const[n,i]=e,[o,a]=t,s=Oo.K4.sub(Oo.K4.create(),i,n),r=Oo.K4.sub(Oo.K4.create(),o,a),l=Oo.K4.dot(s,r)/(Oo.K4.length(s)*Oo.K4.length(r));return Math.acos(l)*(180/Math.PI)}(e,t)}class Xr extends yo{constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"]}){super(e,t),this.touchDragCallback=this._dragCallback.bind(this),this.mouseDragCallback=this._dragCallback.bind(this)}_dragCallback(e){const{element:t,currentPoints:n,startPoints:i}=e.detail,o=n.world,a=i.world,s=(0,ne.getEnabledElement)(t),{viewport:r}=s,l=r.getCamera(),d=[.5*t.clientWidth,.5*t.clientHeight],c=r.canvasToWorld(d);let h=Zr([a,c],[c,o]);const{viewPlaneNormal:g,viewUp:u}=l,m=Oo.R3.sub(Oo.R3.create(),c,a),v=Oo.R3.sub(Oo.R3.create(),c,o),p=Oo.R3.cross(Oo.R3.create(),m,v);if(Oo.R3.dot(g,p)>0&&(h=-h),!Number.isNaN(h)){if(r instanceof ne.BaseVolumeViewport){const e=h*Math.PI/180,t=Oo._E.identity(new Float32Array(16));Oo._E.rotate(t,t,e,g);const n=Oo.R3.transformMat4(Oo.R3.create(),u,t);r.setCamera({viewUp:n})}else{const{rotation:e}=r.getProperties();r.setProperties({rotation:e+h})}r.render()}}}Xr.toolName="PlanarRotate";const Jr=Xr;class Qr extends yo{constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"],configuration:{invert:!1,debounceIfNotLoaded:!0,loop:!1,scrollSlabs:!1}}){super(e,t)}mouseWheelCallback(e){const{wheel:t,element:n}=e.detail,{direction:i}=t,{invert:o}=this.configuration,{viewport:a}=(0,ne.getEnabledElement)(n),s=i*(o?-1:1),r=this.getTargetId(a).split("volumeId:")[1];hs(a,{delta:s,debounceLoading:this.configuration.debounceIfNotLoaded,loop:this.configuration.loop,volumeId:r,scrollSlabs:this.configuration.scrollSlabs})}}Qr.toolName="StackScrollMouseWheel";const el=Qr;class tl extends yo{constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"],configuration:{zoomToCenter:!1,minZoomScale:.1,maxZoomScale:30,pinchToZoom:!0,pan:!0,invert:!1}}){super(e,t),this.preMouseDownCallback=e=>{const t=e.detail,{element:n,currentPoints:i}=t,o=i.world,a=(0,ne.getEnabledElement)(n).viewport.getCamera(),{focalPoint:s}=a;this.initialMousePosWorld=o;let r=Oo.R3.fromValues(s[0]-o[0],s[1]-o[1],s[2]-o[2]);return r=Oo.R3.normalize(Oo.R3.create(),r),this.dirVec=r,!1},this.preTouchStartCallback=e=>{if(!this.configuration.pinchToZoom)return this.preMouseDownCallback(e)},this._dragParallelProjection=(e,t,n,i=!1)=>{const{element:o,deltaPoints:a}=e.detail,s=i?e.detail.deltaDistance.canvas:a.canvas[1],r=[o.clientWidth,o.clientHeight],{parallelScale:l,focalPoint:d,position:c}=n,h=s*(5/r[1])*(this.configuration.invert?-1:1),g=(1-h)*l;let u=d,m=c;if(!this.configuration.zoomToCenter){const e=Oo.R3.distance(d,this.initialMousePosWorld);m=Oo.R3.scaleAndAdd(Oo.R3.create(),c,this.dirVec,-e*h),u=Oo.R3.scaleAndAdd(Oo.R3.create(),d,this.dirVec,-e*h)}const v=t.getImageData();let p=[1,1,1];v&&(p=v.spacing);const{minZoomScale:f,maxZoomScale:E}=this.configuration,w=o.clientHeight*p[1]*.5,I=w/g;let C=g,_=!1;v&&(I<f?(C=w/f,_=!0):I>=E&&(C=w/E,_=!0)),t.setCamera({parallelScale:C,focalPoint:_?d:u,position:_?c:m})},this._dragPerspectiveProjection=(e,t,n,i=!1)=>{const{element:o,deltaPoints:a}=e.detail,s=i?e.detail.deltaDistance.canvas:a.canvas[1],r=[o.clientWidth,o.clientHeight],{position:l,focalPoint:d,viewPlaneNormal:c}=n,h=Gr.ZP.distance2BetweenPoints(l,d),g=Math.sqrt(h)/r[1],u=[-c[0],-c[1],-c[2]],m=this.configuration.invert?s/g:s*g;let v=m*u[0];l[0]+=v,d[0]+=v,v=m*u[1],l[1]+=v,d[1]+=v,v=m*u[2],l[2]+=v,d[2]+=v,t.setCamera({position:l,focalPoint:d})},this.initialMousePosWorld=[0,0,0],this.dirVec=[0,0,0],this.configuration.pinchToZoom?this.touchDragCallback=this._pinchCallback.bind(this):this.touchDragCallback=this._dragCallback.bind(this),this.mouseDragCallback=this._dragCallback.bind(this)}_pinchCallback(e){if(e.detail.currentPointsList.length>1){const{element:t,currentPoints:n}=e.detail,i=(0,ne.getEnabledElement)(t),{viewport:o}=i,a=o.getCamera(),s=n.world,{focalPoint:r}=a;this.initialMousePosWorld=s;let l=Oo.R3.fromValues(r[0]-s[0],r[1]-s[1],r[2]-s[2]);l=Oo.R3.normalize(Oo.R3.create(),l),this.dirVec=l,a.parallelProjection?this._dragParallelProjection(e,o,a,!0):this._dragPerspectiveProjection(e,o,a,!0),o.render()}this.configuration.pan&&this._panCallback(e)}_dragCallback(e){const{element:t}=e.detail,n=(0,ne.getEnabledElement)(t),{viewport:i}=n,o=i.getCamera();o.parallelProjection?this._dragParallelProjection(e,i,o):this._dragPerspectiveProjection(e,i,o),i.render()}_panCallback(e){const{element:t,deltaPoints:n}=e.detail,i=(0,ne.getEnabledElement)(t),o=n.world,a=i.viewport.getCamera(),{focalPoint:s,position:r}=a,l=[r[0]-o[0],r[1]-o[1],r[2]-o[2]],d=[s[0]-o[0],s[1]-o[1],s[2]-o[2]];i.viewport.setCamera({focalPoint:d,position:l}),i.viewport.render()}}tl.toolName="Zoom";const nl=tl,il=[0,0,1];class ol extends yo{constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"],configuration:{direction:il,rotateIncrementDegrees:30}}){super(e,t)}mouseWheelCallback(e){const{element:t,wheel:n}=e.detail,i=(0,ne.getEnabledElement)(t),{viewport:o}=i,{direction:a,rotateIncrementDegrees:s}=this.configuration,r=o.getCamera(),{viewUp:l,position:d,focalPoint:c}=r,{direction:h}=n,[g,u,m]=c,[v,p,f]=a,E=h*(s*Math.PI)/180,w=[0,0,0],I=[0,0,0],C=[0,0,0],_=Oo._E.identity(new Float32Array(16));Oo._E.translate(_,_,[g,u,m]),Oo._E.rotate(_,_,E,[v,p,f]),Oo._E.translate(_,_,[-g,-u,-m]),Oo.R3.transformMat4(w,d,_),Oo.R3.transformMat4(I,c,_),Oo._E.identity(_),Oo._E.rotate(_,_,E,[v,p,f]),Oo.R3.transformMat4(C,l,_),o.setCamera({position:w,viewUp:C,focalPoint:I}),o.render()}}ol.toolName="VolumeRotateMouseWheel";const al=ol;function sl(e,t,n,i){const o=Oo.R3.create();Oo.R3.cross(o,t,e);const a=Oo.R3.fromValues(...n),s=Oo.R3.fromValues(...i),r=Oo.R3.create();Oo.R3.subtract(r,a,s);const l=Oo.R3.length(r);if(l<1e-4)return{worldWidth:0,worldHeight:0};const d=Oo.R3.dot(r,o)/(l*Oo.R3.length(o));return{worldWidth:Math.sqrt(1-d*d)*l,worldHeight:d*l}}function rl(e,t,n,i,o=.25){const a=e.getCamera(),{position:s}=a,{spacingInNormalDirection:r}=ne.utilities.getTargetVolumeAndSpacingInNormalDir(e,a,n),l=r*o,d=e.getBounds(),c=d[0],h=d[1],g=[0,0,0];let u,m=[0,0,0];Gr.ZP.subtract(t,s,g);for(let t=c;t<=h;t+=l){m=[t,0,0];const n=(t-s[0])/g[0];if(m[1]=n*g[1]+s[1],m[2]=n*g[2]+s[2],ll(m,d)){const t=i(e.getIntensityFromWorld(m),m);t&&(u=t)}}return u}const ll=function(e,t){const[n,i,o,a,s,r]=t;return e[0]>n&&e[0]<i&&e[1]>o&&e[1]<a&&e[2]>s&&e[2]<r},dl={filterAnnotationsWithinSlice:ca,getWorldWidthAndHeightFromCorners:sl,filterAnnotationsForDisplay:ua,getPointInLineOfSightWithCriteria:rl};function cl(e,t){if(!(e instanceof ne.VolumeViewport))return;const{focalPoint:n}=e.getCamera(),i=[0,0,0];return Oo.R3.sub(i,t,n),function(e,t){const n=e.getCamera(),i=n.viewPlaneNormal,o=Oo.R3.dot(t,i),a=Oo.R3.fromValues(i[0],i[1],i[2]);if(Oo.R3.scale(a,a,o),Math.abs(a[0])>.001||Math.abs(a[1])>.001||Math.abs(a[2])>.001){const t=[0,0,0],i=[0,0,0];Oo.R3.add(t,n.focalPoint,a),Oo.R3.add(i,n.position,a),e.setCamera({focalPoint:t,position:i}),e.render()}}(e,i),!0}class hl extends yo{constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"],configuration:{targetViewportIds:[]}}){super(e,t)}mouseClickCallback(e){const{element:t,currentPoints:n}=e.detail,i=(0,ne.getEnabledElement)(t),{viewport:o,renderingEngine:a}=i,s=this.getTargetId(o);if(!s.startsWith("volumeId"))throw new Error("MIPJumpToClickTool: targetId is not a volumeId, you should only use MIPJumpToClickTool with a volumeId as the targetId");const r=s.split("volumeId:")[1];let l=-1/0;const d=rl(o,n.world,r,((e,t)=>{if(e>l)return l=e,t}));if(!d||!d.length)return;const{targetViewportIds:c,toolGroupId:h}=this.configuration;a.getViewports().filter((e=>{if(c?.indexOf(e.id)>=0)return!0;const t=Mv(e.id,a.id);return!(!h||h!==t?.id)})).forEach((e=>{e instanceof ne.VolumeViewport?cl(e,d):console.warn("Cannot jump to specified world coordinates for a viewport that is not a VolumeViewport")}))}}hl.toolName="MIPJumpToClickTool";const gl=hl;var ul=n(45802);function ml(e,t){const n=e.length,i=[];for(let o=0;o<n;o++){const n=e[o];n.getFrameOfReferenceUID()===t&&i.push(n)}return i}const{Active:vl,Passive:pl,Enabled:fl}=ie;function El(e,t){const n=e.length,i=[];for(let o=0;o<n;o++){const n=e[o],a=Mv(n.id,n.renderingEngineId);if(!a)continue;wl(a,t)&&i.push(n)}return i}function wl(e,t){const{toolOptions:n}=e,i=n[t];if(!i)return!1;const o=i.mode;return o===vl||o===pl||o===fl}const Il=function(e,t,n=.999){return e.filter((e=>{const i=e.getCamera();return Math.abs(Oo.R3.dot(i.viewPlaneNormal,t.viewPlaneNormal))>n}))};function Cl(e,t,n=!0){const i=(0,ne.getEnabledElement)(e),{renderingEngine:o,FrameOfReferenceUID:a}=i;let s=o.getViewports();s=ml(s,a),s=El(s,t);const r=o.getViewport(i.viewportId);n&&(s=Il(s,r.getCamera()));return s.map((e=>e.id))}const _l=1e-6,Tl=1,bl=0;function Dl(e,t,n){const[i,o]=n;if(Math.abs(t)<_l)return e<0;const a=e/t;if(t>0){if(a>o)return 0;a>i&&(n[0]=a)}else{if(a<i)return 0;a<o&&(n[1]=a)}return 1}function Sl(e,t,n,i,o){const[a,s]=e,[r,l]=t,d=r-a,c=l-s;if(void 0===i||void 0===o?(i=e,o=t):(i[0]=e[0],i[1]=e[1],o[0]=t[0],o[1]=t[1]),Math.abs(d)<_l&&Math.abs(c)<_l&&a>=n[0]&&a<=n[2]&&s>=n[1]&&s<=n[3])return Tl;const h=[0,1];if(Dl(n[0]-a,d,h)&&Dl(a-n[2],-d,h)&&Dl(n[1]-s,c,h)&&Dl(s-n[3],-c,h)){const[e,t]=h;return t<1&&(o[0]=a+t*d,o[1]=s+t*c),e>0&&(i[0]+=e*d,i[1]+=e*c),Tl}return bl}function Ml(e,t){const n=e.maxX-e.minX,i=e.maxY-e.minY,o=[n,i],a=[e.minX+n/2,e.minY+i/2],s=[Math.abs(t[0]-a[0]),Math.abs(t[1]-a[1])],r=s[0]-.5*o[0],l=s[1]-.5*o[1];if(r>0&&l>0)return r*r+l*l;const d=Math.max(r,0)+Math.max(l,0);return d*d}function yl(e,t){return Math.sqrt(Ml(e,t))}const Ol=class{};var xl;class Rl extends Ol{}function Pl(e){return 1===e.length?e[0]:e}function Nl(e,t){if(e.length!==t.length)throw Error("Both points should have the same dimensionality");const[n,i,o=0]=e,[a,s,r=0]=t;return Math.pow(n-a,2)+Math.pow(i-s,2)+Math.pow(o-r,2)}function Ll(e,t){return Math.sqrt(Nl(e,t))}function Al(e,t){const[n,i]=e,[o,a]=t;return[2*o-n,2*a-i]}function kl(e,t,n,i=!0){const o=[],a=function(e,t,n,i=!0){let o,a;const s=[];i?(a=e.length-1,o=0):(a=0,o=1);for(let i=o;i<e.length;i++)Wl(t,n,e[a],e[i])&&s.push([a,i]),a=i;return s}(e,t,n,i);for(let i=0;i<a.length;i++){const s=Fl(t,n,e[a[i][0]],e[a[i][1]]);o.push(s)}return o}function Ul(e,t,n,i=!0){let o,a;i?(a=e.length-1,o=0):(a=0,o=1);for(let i=o;i<e.length;i++){if(Wl(t,n,e[a],e[i]))return[a,i];a=i}}function Vl(e,t,n,i=!0){let o,a;i?(a=e.length-1,o=0):(a=0,o=1);const s=[];for(let i=o;i<e.length;i++){const o=e[a],r=e[i];Wl(t,n,o,r)&&s.push([a,i]),a=i}if(0===s.length)return;const r=[];s.forEach((n=>{const i=[e[n[0]],e[n[1]]],o=[(i[0][0]+i[1][0])/2,(i[0][1]+i[1][1])/2];r.push(Oo.K4.distance(o,t))}));const l=Math.min(...r);return{segment:s[r.indexOf(l)],distance:l}}function Wl(e,t,n,i){let o=!1;const a=[Hl(e,t,n),Hl(e,t,i),Hl(n,i,e),Hl(n,i,t)];return a[0]!==a[1]&&a[2]!==a[3]||((0===a[0]&&Bl(e,n,t)||0===a[1]&&Bl(e,i,t)||0===a[2]&&Bl(n,e,i)||0===a[3]&&Bl(n,t,i))&&(o=!0),o)}function Hl(e,t,n){const i=(t[1]-e[1])*(n[0]-t[0])-(t[0]-e[0])*(n[1]-t[1]);return 0===i?0:i>0?1:2}function Bl(e,t,n){return t[0]<=Math.max(e[0],n[0])&&t[0]>=Math.min(e[0],n[0])&&t[1]<=Math.max(e[1],n[1])&&t[1]>=Math.min(e[1],n[1])}function Fl(e,t,n,i){const o=(i[1]-n[1])*(t[0]-e[0])-(i[0]-n[0])*(t[1]-e[1]);if(0==o)return;let a=e[1]-n[1],s=e[0]-n[0];const r=(i[0]-n[0])*a-(i[1]-n[1])*s,l=(t[0]-e[0])*a-(t[1]-e[1])*s;a=r/o,s=l/o;return[e[0]+a*(t[0]-e[0]),e[1]+a*(t[1]-e[1])]}(xl=Rl).max=[-1/0],xl.sum=[0],xl.sumSquares=[0],xl.squaredDiffSum=[0],xl.count=0,xl.statsCallback=({value:e})=>{Array.isArray(e)&&e.length>1&&1===xl.max.length&&(xl.max.push(xl.max[0],xl.max[0]),xl.sum.push(xl.sum[0],xl.sum[0]),xl.sumSquares.push(xl.sumSquares[0],xl.sumSquares[0]),xl.squaredDiffSum.push(xl.squaredDiffSum[0],xl.squaredDiffSum[0]));const t=Array.isArray(e)?e:[e];xl.count+=1,xl.max.forEach(((e,n)=>xl.max[n]=Math.max(e,t[n]))),xl.sum.map(((e,n)=>xl.sum[n]+=t[n])),xl.sumSquares.map(((e,n)=>xl.sumSquares[n]+=t[n]**2)),xl.squaredDiffSum.map(((e,n)=>xl.squaredDiffSum[n]+=Math.pow(t[n]-xl.sum[n]/xl.count,2)))},xl.getStatistics=()=>{const e=xl.sum.map((e=>e/xl.count)),t=xl.squaredDiffSum.map((e=>Math.sqrt(e/xl.count))),n=xl.sumSquares.map(((t,n)=>Math.sqrt(xl.sumSquares[n]/xl.count-e[n]**2))),i=xl.max;return xl.max=[-1/0],xl.sum=[0],xl.sumSquares=[0],xl.squaredDiffSum=[0],xl.count=0,[{name:"max",value:Pl(i),unit:null},{name:"mean",value:Pl(e),unit:null},{name:"stdDev",value:Pl(t),unit:null},{name:"stdDevWithSumSquare",value:Pl(n),unit:null}]};const Gl=.001,$l=(e,t)=>{let n,i,o;if(e instanceof ne.StackViewport){const t=e.getImageData();i=t.direction.slice(0,3),o=t.direction.slice(3,6),n=t.spacing}else{const t=e.getImageData(),{direction:a,spacing:s}=t,{viewPlaneNormal:r,viewUp:l}=e.getCamera(),d=a.slice(0,3),c=a.slice(3,6),h=a.slice(6,9),g=Oo.R3.create();Oo.R3.cross(g,l,r);const u=Math.abs(Oo.R3.dot(g,d)),m=Math.abs(Oo.R3.dot(g,c)),v=Math.abs(Oo.R3.dot(g,h));let p;if(Math.abs(1-u)<Gl)p=s[0],i=d;else if(Math.abs(1-m)<Gl)p=s[1],i=c;else{if(!(Math.abs(1-v)<Gl))throw new Error("No support yet for oblique plane planar contours");p=s[2],i=h}const f=Math.abs(Oo.R3.dot(l,d)),E=Math.abs(Oo.R3.dot(l,c)),w=Math.abs(Oo.R3.dot(l,h));let I;if(Math.abs(1-f)<Gl)I=s[0],o=d;else if(Math.abs(1-E)<Gl)I=s[1],o=c;else{if(!(Math.abs(1-w)<Gl))throw new Error("No support yet for oblique plane planar contours");I=s[2],o=h}n=[p,I]}return{spacing:[n[0]/t,n[1]/t],xDir:i,yDir:o}},Kl=(e,t,n)=>Oo.K4.dist(e,t)<n,ql=(e,t,n,i)=>{const{xDir:o,yDir:a,spacing:s}=i,r=(0,ne.getEnabledElement)(e),{viewport:l}=r,d=l.canvasToWorld(t[t.length-1]),c=l.canvasToWorld(n),h=Oo.R3.create();Oo.R3.subtract(h,c,d);const g=Math.abs(Oo.R3.dot(h,o)),u=Math.abs(Oo.R3.dot(h,a)),m=Math.max(Math.floor(g/s[0]),Math.floor(u/s[0]));if(m>1){const e=t[t.length-1],i=Oo.K4.dist(e,n),o=Oo.K4.create();Oo.K4.subtract(o,n,e),Oo.K4.set(o,o[0]/i,o[1]/i);const a=i/m;for(let n=1;n<=m;n++)t.push([e[0]+a*o[0]*n,e[1]+a*o[1]*n])}else t.push(n);return m},zl=(e,t,n,i)=>{const o=[e[0]-t[0],e[1]-t[1]],a=[n[0]-t[0],n[1]-t[1]],s=o[0]*a[0]+o[1]*a[1];if(s<0)return!1;const r=Math.sqrt(a[0]*a[0]+a[1]*a[1]);if(0===r)return!1;const l=s/r,d=[a[0]/r,a[1]/r],c=[d[0]*l,d[1]*l],h=[t[0]+c[0],t[1]+c[1]];return!(Oo.K4.distance(e,h)>i)&&!(Oo.K4.distance(t,h)>Oo.K4.distance(t,n))};function jl(e){const t=e.length;let n=0,i=t-1;for(let o=0;o<t;o++)n+=(e[i][0]+e[o][0])*(e[i][1]-e[o][1]),i=o;return Math.abs(n/2)}function Yl(e,t){if(4!==e.length||2!==t.length)throw Error("rectangle:[left, top, width, height] or point: [x,y] not defined correctly");const[n,i,o,a]=e;let s=655535;const r=function(e,t,n,i){return{top:[[e,t],[e+n,t]],right:[[e+n,t],[e+n,t+i]],bottom:[[e+n,t+i],[e,t+i]],left:[[e,t+i],[e,t]]}}(n,i,o,a);return Object.keys(r).forEach((e=>{const[n,i]=r[e],o=Jl(n,i,t);o<s&&(s=o)})),s}function Zl(e,t,n){let i;const o=Nl(e,t);if(e[0]===t[0]&&e[1]===t[1]&&(i=e),!i){const a=((n[0]-e[0])*(t[0]-e[0])+(n[1]-e[1])*(t[1]-e[1]))/o;i=a<0?e:a>1?t:[e[0]+a*(t[0]-e[0]),e[1]+a*(t[1]-e[1])]}return{point:[...i],distanceSquared:Nl(n,i)}}function Xl(e,t,n){return Zl(e,t,n).distanceSquared}function Jl(e,t,n){if(2!==e.length||2!==t.length||2!==n.length)throw Error("lineStart, lineEnd, and point should have 2 elements of [x, y]");return Math.sqrt(Xl(e,t,n))}function Ql(e){return"number"==typeof e?e?e<0?-1:1:e==e?0:NaN:NaN}function ed(e,t,n,i){const[o,a]=e,[s,r]=t,[l,d]=n,[c,h]=i,g=r-a,u=o-s,m=s*a-o*r,v=g*l+u*d+m,p=g*c+u*h+m;if(0!==v&&0!==p&&Ql(v)===Ql(p))return;const f=h-d,E=l-c,w=c*d-l*h,I=f*o+E*a+w,C=f*s+E*r+w;if(0!==I&&0!==C&&Ql(I)===Ql(C))return;const _=g*E-f*u;let T;T=u*w-E*m;const b=T/_;T=f*m-g*w;return[b,T/_]}const{RENDERING_DEFAULTS:td}=ne.CONSTANTS;function nd(){return"rgb(0, 200, 0)"}function id(){return!0}function od(){return!0}function ad(){return!0}const sd=1,rd=2,ld=3;class dd extends Ca{constructor(e={},t={supportedInteractionTypes:["Mouse"],configuration:{shadow:!0,viewportIndicators:!0,autoPan:{enabled:!1,panSize:10},referenceLinesCenterGapRadius:20,filterActorUIDsToSetSlabThickness:[],slabThicknessBlendMode:ne.Enums.BlendModes.MAXIMUM_INTENSITY_BLEND,mobile:{enabled:!1,opacity:.8,handleRadius:9}}}){super(e,t),this.toolCenter=[0,0,0],this.initializeViewport=({renderingEngineId:e,viewportId:t})=>{const n=(0,ne.getEnabledElementByIds)(t,e),{FrameOfReferenceUID:i,viewport:o}=n,{element:a}=o,{position:s,focalPoint:r,viewPlaneNormal:l}=o.getCamera();let d=this._getAnnotations(n);d=this.filterInteractableAnnotationsForElement(a,d),d.length&&dp(d[0].annotationUID);return rp({highlighted:!1,metadata:{cameraPosition:[...s],cameraFocalPoint:[...r],FrameOfReferenceUID:i,toolName:this.getToolName()},data:{handles:{rotationPoints:[],slabThicknessPoints:[],toolCenter:this.toolCenter},activeOperation:null,activeViewportIds:[],viewportId:t}},a),{normal:l,point:o.canvasToWorld([o.canvas.clientWidth/2,o.canvas.clientHeight/2])}},this._getViewportsInfo=()=>Jv(this.toolGroupId).viewportsInfo,this.computeToolCenter=e=>{if(!e.length||1===e.length)throw new Error("For crosshairs to operate, at least two viewports must be given.");const[t,n,i]=e,{normal:o,point:a}=this.initializeViewport(t),{normal:s,point:r}=this.initializeViewport(n);let l=[0,0,0],d=Oo.R3.create();i?({normal:l,point:d}=this.initializeViewport(i)):(Oo.R3.add(d,a,r),Oo.R3.scale(d,d,.5),Oo.R3.cross(l,o,s));const c=ne.utilities.planar.planeEquation(o,a),h=ne.utilities.planar.planeEquation(s,r),g=ne.utilities.planar.planeEquation(l,d);this.toolCenter=ne.utilities.planar.threePlaneIntersection(c,h,g);const{renderingEngine:u}=(0,ne.getEnabledElementByIds)(e[0].viewportId,e[0].renderingEngineId);cs(u,e.map((({viewportId:e})=>e)))},this.addNewAnnotation=e=>{const t=e.detail,{element:n}=t,{currentPoints:i}=t,o=i.world,a=(0,ne.getEnabledElement)(n),{viewport:s}=a;this._jump(a,o);const r=this._getAnnotations(a),l=this.filterInteractableAnnotationsForElement(s.element,r),{data:d}=l[0],{rotationPoints:c}=d.handles,h=[];for(let e=0;e<c.length-1;++e){const t=c[e][1],n=this._getReferenceLineControllable(t.id),i=this._getReferenceLineDraggableRotatable(t.id);n&&i&&(h.push(t.id),e++)}return d.activeViewportIds=[...h],d.handles.activeOperation=sd,e.preventDefault(),Rr(n),this._activateModify(n),l[0]},this.cancel=()=>{console.log("Not implemented yet")},this.handleSelectedCallback=(e,t)=>{const n=e.detail,{element:i}=n;t.highlighted=!0,this._activateModify(i),Rr(i),e.preventDefault()},this.isPointNearTool=(e,t,n,i)=>!!this._pointNearTool(e,t,n,6),this.toolSelectedCallback=(e,t,n)=>{const i=e.detail,{element:o}=i;t.highlighted=!0,this._activateModify(o),Rr(o),e.preventDefault()},this.onCameraModified=e=>{const t=e.detail,{element:n}=t,i=(0,ne.getEnabledElement)(n),{renderingEngine:o}=i,a=i.viewport,s=this._getAnnotations(i),r=this.filterInteractableAnnotationsForElement(n,s)[0];if(!r)return;const l=a.getCamera(),d=r.metadata.cameraPosition,c=[0,0,0];Gr.ZP.subtract(l.position,d,c);const h=r.metadata.cameraFocalPoint,g=[0,0,0];Gr.ZP.subtract(l.focalPoint,h,g),r.metadata.cameraPosition=[...l.position],r.metadata.cameraFocalPoint=[...l.focalPoint];const u=this._getReferenceLineControllable(a.id),m=this._getReferenceLineDraggableRotatable(a.id);if(!ne.utilities.isEqual(l.position,d,.001)&&u&&m){let e=!1;ne.utilities.isEqual(c,g,.001)||(e=!0);const t=Math.abs(Gr.ZP.dot(c,l.viewPlaneNormal))<.01;e||t||(this.toolCenter[0]+=c[0],this.toolCenter[1]+=c[1],this.toolCenter[2]+=c[2])}if(this.configuration.autoPan?.enabled){Mv(a.id,o.id).getViewportIds().filter((e=>e!==a.id)).forEach((e=>{this._autoPanViewportIfNecessary(e,o)}))}const v=Cl(n,this.getToolName(),!1);cs(o,v)},this.mouseMoveCallback=(e,t)=>{const{element:n,currentPoints:i}=e.detail,o=i.canvas;let a=!1;for(let e=0;e<t.length;e++){const i=t[e];if(we(i))continue;const{data:s,highlighted:r}=i;if(!s.handles)continue;const l=s.handles.activeOperation,d=s.activeViewportIds&&s.activeViewportIds.length>0?[...s.activeViewportIds]:[];s.activeViewportIds=[],s.handles.activeOperation=null;let c=!1;c=!!this.getHandleNearImagePoint(n,i,o,6)||this._pointNearTool(n,i,o,6);c&&!r||!c&&r?(i.highlighted=!r,a=!0):s.handles.activeOperation===l&&this._areViewportIdArraysEqual(s.activeViewportIds,d)||(a=!0)}return a},this.filterInteractableAnnotationsForElement=(e,t)=>{if(!t||!t.length)return[];const n=(0,ne.getEnabledElement)(e),{viewportId:i}=n;return t.filter((e=>e.data.viewportId===i))},this.renderAnnotation=(e,t)=>{let n=!1;const{viewport:i,renderingEngine:o}=e,{element:a}=i,s=this._getAnnotations(e),r=i.getCamera(),l=this.filterInteractableAnnotationsForElement(a,s)[0];if(!s?.length||!l?.data)return n;const d=l.annotationUID,{clientWidth:c,clientHeight:h}=i.canvas,g=Math.sqrt(c*c+h*h),u=Math.min(c,h),m=l.data,v=i.worldToCanvas(this.toolCenter),p=this._filterAnnotationsByUniqueViewportOrientations(e,s),f=[],E=[0,0,c,h];p.forEach((e=>{const{data:t}=e;t.handles.toolCenter=this.toolCenter;const n=o.getViewport(t.viewportId),a=n.getCamera(),s=this._getReferenceLineControllable(n.id),l=this._getReferenceLineDraggableRotatable(n.id),d=this._getReferenceLineSlabThicknessControlsOn(n.id),{clientWidth:c,clientHeight:h}=n.canvas,m=Math.sqrt(c*c+h*h),w=[.5*c,.5*h],I=n.canvasToWorld(w),C=[0,0,0];Gr.ZP.cross(r.viewPlaneNormal,a.viewPlaneNormal,C),Gr.ZP.normalize(C),Gr.ZP.multiplyScalar(C,m);const _=[0,0,0];Gr.ZP.add(I,C,_);const T=[0,0,0];Gr.ZP.subtract(I,C,T);const b=i.worldToCanvas(_),D=i.worldToCanvas(I),S=Oo.K4.create();Oo.K4.subtract(S,b,D),Oo.K4.normalize(S,S);const M=Oo.K4.create();Oo.K4.scale(M,S,100*g);const y=Oo.K4.create();Oo.K4.scale(y,S,.4*u);const O=Oo.K4.create();Oo.K4.scale(O,S,.2*u);const x=Oo.K4.create(),R=this.configuration.referenceLinesCenterGapRadius;Oo.K4.scale(x,S,2===p.length?R:0);const P=Oo.K4.create(),N=Oo.K4.create(),L=Oo.K4.create(),A=Oo.K4.create();let k=Oo.K4.clone(v);l&&s||(k=Oo.K4.clone(D)),Oo.K4.add(P,k,x),Oo.K4.add(N,k,M),Oo.K4.subtract(L,k,x),Oo.K4.subtract(A,k,M),Sl(P,N,E),Sl(L,A,E);const U=Oo.K4.create();Oo.K4.subtract(U,v,y);const V=Oo.K4.create();Oo.K4.add(V,v,y);let W=Oo.K4.clone(v);!l&&d&&(W=Oo.K4.clone(D));let H=[...this.toolCenter];!l&&d&&(H=[...I]);const B=[0,0,0];Gr.ZP.subtract(_,T,B),Gr.ZP.normalize(B);const{viewPlaneNormal:F}=r,{matrix:G}=ul.Z.buildFromDegree().rotate(90,F),$=[0,0,0];Oo.R3.transformMat4($,B,G);const K=n.getSlabThickness(),q=[...$];Gr.ZP.multiplyScalar(q,K);const z=[0,0,0];Gr.ZP.add(H,q,z);const j=i.worldToCanvas(z),Y=Oo.K4.create();Oo.K4.subtract(Y,W,j);const Z=Oo.K4.create();Oo.K4.subtract(Z,W,M),Oo.K4.add(Z,Z,Y);const X=Oo.K4.create();Oo.K4.add(X,W,M),Oo.K4.add(X,X,Y),Sl(Z,X,E);const J=Oo.K4.create();Oo.K4.add(J,W,M),Oo.K4.subtract(J,J,Y);const Q=Oo.K4.create();Oo.K4.subtract(Q,W,M),Oo.K4.subtract(Q,Q,Y),Sl(J,Q,E);const ee=Oo.K4.create(),te=Oo.K4.create(),ne=Oo.K4.create(),ie=Oo.K4.create();Oo.K4.subtract(ee,W,O),Oo.K4.add(ee,ee,Y),Oo.K4.add(te,W,O),Oo.K4.add(te,te,Y),Oo.K4.subtract(ne,W,O),Oo.K4.subtract(ne,ne,Y),Oo.K4.add(ie,W,O),Oo.K4.subtract(ie,ie,Y),f.push([n,P,N,L,A,Z,X,J,Q,U,V,ee,te,ne,ie])}));const w=[],I=[],C=this._getReferenceLineColor(i.id),_=void 0!==C?C:"rgb(200, 200, 200)";if(f.forEach(((e,n)=>{const o=e[0],a=this._getReferenceLineColor(o.id),s=this._getReferenceLineControllable(o.id),r=this._getReferenceLineDraggableRotatable(o.id)||this.configuration.mobile?.enabled,l=this._getReferenceLineSlabThicknessControlsOn(o.id)||this.configuration.mobile?.enabled,c=m.activeViewportIds.find((e=>e===o.id));let h=void 0!==a?a:"rgb(200, 200, 200)",g=1;const u=null!==m.handles.activeOperation&&m.handles.activeOperation===sd&&c;u&&(g=2.5);let v=`${n}`;if(s&&r?(v=`${n}One`,Ko(t,d,v,e[1],e[2],{color:h,lineWidth:g}),v=`${n}Two`,Ko(t,d,v,e[3],e[4],{color:h,lineWidth:g})):Ko(t,d,v,e[2],e[4],{color:h,lineWidth:g}),s){h=void 0!==a?a:"rgb(200, 200, 200)";const s=m.handles.activeOperation===rd,g=[e[9],e[10]],p=[i.canvasToWorld(e[9]),o,e[1],e[2]],f=[i.canvasToWorld(e[10]),o,e[3],e[4]];w.push(p,f);const E=m.handles.activeOperation===ld,C=[e[11],e[12],e[13],e[14]],_=[i.canvasToWorld(e[11]),o,e[5],e[6]],T=[i.canvasToWorld(e[12]),o,e[5],e[6]],b=[i.canvasToWorld(e[13]),o,e[7],e[8]],D=[i.canvasToWorld(e[14]),o,e[7],e[8]];if(I.push(_,T,b,D),(u||this.configuration.mobile?.enabled)&&!s&&!E&&r&&l){let e=`${n}One`;$o(t,d,e,g,{color:h,handleRadius:this.configuration.mobile?.enabled?this.configuration.mobile?.handleRadius:3,opacity:this.configuration.mobile?.enabled?this.configuration.mobile?.opacity:1,type:"circle"}),e=`${n}Two`,$o(t,d,e,C,{color:h,handleRadius:this.configuration.mobile?.enabled?this.configuration.mobile?.handleRadius:3,opacity:this.configuration.mobile?.enabled?this.configuration.mobile?.opacity:1,type:"rect"})}else if(u&&!s&&!E&&r){$o(t,d,`${n}`,g,{color:h,handleRadius:this.configuration.mobile?.enabled?this.configuration.mobile?.handleRadius:3,opacity:this.configuration.mobile?.enabled?this.configuration.mobile?.opacity:1,type:"circle"})}else if(c&&!s&&!E&&l){$o(t,d,`${n}`,C,{color:h,handleRadius:this.configuration.mobile?.enabled?this.configuration.mobile?.handleRadius:3,opacity:this.configuration.mobile?.enabled?this.configuration.mobile?.opacity:1,type:"rect"})}else if(s&&r){$o(t,d,`${n}`,g,{color:h,handleRadius:2,fill:h,type:"circle"})}else E&&c&&l&&$o(t,d,v,C,{color:h,handleRadius:2,fill:h,type:"rect"});o.getSlabThickness()>.5&&l&&(v=`${n}STOne`,Ko(t,d,v,e[5],e[6],{color:h,width:1,lineDash:[2,3]}),v=`${n}STTwo`,Ko(t,d,v,e[7],e[8],{color:h,width:e,lineDash:[2,3]}))}})),n=!0,m.handles.rotationPoints=w,m.handles.slabThicknessPoints=I,this.configuration.viewportIndicators){Ho(t,d,"0",[.95*c,.05*h],.01*g,{color:_,fill:_})}return n},this._getAnnotations=e=>{const{viewport:t}=e,n=sp(this.getToolName(),t.element)||[],i=this._getViewportsInfo().map((({viewportId:e})=>e));return n.filter((e=>{const{data:t}=e;return i.includes(t.viewportId)}))},this._onNewVolume=e=>{const t=this._getViewportsInfo();this.computeToolCenter(t)},this._areViewportIdArraysEqual=(e,t)=>e.length===t.length&&(e.forEach((e=>{let n=!1;for(let i=0;i<t.length;++i)if(e===t[i]){n=!0;break}if(!1===n)return!1})),!0),this._getAnnotationsForViewportsWithDifferentCameras=(e,t)=>{const{viewportId:n,renderingEngine:i,viewport:o}=e,a=t.filter((e=>e.data.viewportId!==n));if(!a||!a.length)return[];const s=o.getCamera(),{viewPlaneNormal:r,position:l}=s,d=a.filter((e=>{const{viewportId:t}=e.data,n=i.getViewport(t).getCamera();return!(ne.utilities.isEqual(n.viewPlaneNormal,r,.01)&&ne.utilities.isEqual(n.position,l,1))}));return d},this._filterViewportWithSameOrientation=(e,t,n)=>{const{renderingEngine:i}=e,{data:o}=t,a=i.getViewport(o.viewportId),s=n.filter((e=>{const{data:t}=e,n=i.getViewport(t.viewportId);return!0===this._getReferenceLineControllable(n.id)}));if(!s||!s.length)return[];const r=a.getCamera(),l=r.viewPlaneNormal;Gr.ZP.normalize(l);return s.filter((e=>{const{viewportId:t}=e.data,n=i.getViewport(t).getCamera(),o=n.viewPlaneNormal;return Gr.ZP.normalize(o),ne.utilities.isEqual(l,o,.01)&&ne.utilities.isEqual(r.viewUp,n.viewUp,.01)}))},this._filterAnnotationsByUniqueViewportOrientations=(e,t)=>{const{renderingEngine:n,viewport:i}=e,o=i.getCamera().viewPlaneNormal;Gr.ZP.normalize(o);const a=t.filter((e=>{const{data:t}=e,o=n.getViewport(t.viewportId),a=this._getReferenceLineControllable(o.id);return i!==o&&!0===a})),s=[];for(let e=0;e<a.length;++e){const t=a[e],{viewportId:i}=t.data,r=n.getViewport(i).getCamera(),l=r.viewPlaneNormal;if(Gr.ZP.normalize(l),ne.utilities.isEqual(o,l,.01)||ne.utilities.isOpposite(o,l,.01))continue;let d=!1;for(let e=0;e<s.length;++e){const t=s[e],{viewportId:i}=t.data,o=n.getViewport(i).getCamera();ne.utilities.isEqual(o.viewPlaneNormal,r.viewPlaneNormal,.01)&&ne.utilities.isEqual(o.position,r.position,1)&&(d=!0)}d||s.push(t)}const r=t.filter((e=>{const{data:t}=e,o=n.getViewport(t.viewportId),a=this._getReferenceLineControllable(o.id);return i!==o&&!0!==a}));for(let e=0;e<r.length;++e){const t=r[e],{viewportId:i}=t.data,a=n.getViewport(i).getCamera(),l=a.viewPlaneNormal;if(Gr.ZP.normalize(l),ne.utilities.isEqual(o,l,.01)||ne.utilities.isOpposite(o,l,.01))continue;let d=!1;for(let e=0;e<s.length;++e){const t=s[e],{viewportId:i}=t.data,o=n.getViewport(i).getCamera();ne.utilities.isEqual(o.viewPlaneNormal,a.viewPlaneNormal,.01)&&ne.utilities.isEqual(o.position,a.position,1)&&(d=!0)}d||s.push(t)}const l=this._getAnnotationsForViewportsWithDifferentCameras(e,t);for(let e=0;e<l.length;++e){const t=l[e];if(s.some((e=>e===t)))continue;const{viewportId:i}=t.data,a=n.getViewport(i).getCamera(),r=a.viewPlaneNormal;if(Gr.ZP.normalize(r),ne.utilities.isEqual(o,r,.01)||ne.utilities.isOpposite(o,r,.01))continue;let d=!1;for(let e=0;e<s.length;++e){const t=s[e],{viewportId:i}=t.data,o=n.getViewport(i).getCamera();ne.utilities.isEqual(o.viewPlaneNormal,a.viewPlaneNormal,.01)&&ne.utilities.isEqual(o.position,a.position,1)&&(d=!0)}d||s.push(t)}return s},this._checkIfViewportsRenderingSameScene=(e,t)=>{const n=e.getActors(),i=t.getActors();let o=!0;return n.forEach((e=>{n.length===i.length&&void 0!==i.find((({uid:t})=>t===e.uid))||(o=!1)})),o},this._jump=(e,t)=>{Je.isInteractingWithTool=!0;const{viewport:n,renderingEngine:i}=e,o=this._getAnnotations(e),a=[0,0,0];Gr.ZP.subtract(t,this.toolCenter,a);const s=this._getAnnotationsForViewportsWithDifferentCameras(e,o).filter((e=>{const{data:t}=e,o=i.getViewport(t.viewportId),a=this._checkIfViewportsRenderingSameScene(n,o);return this._getReferenceLineControllable(o.id)&&this._getReferenceLineDraggableRotatable(o.id)&&a}));return 0===s.length?(Je.isInteractingWithTool=!1,!1):(this._applyDeltaShiftToSelectedViewportCameras(i,s,a),Je.isInteractingWithTool=!1,!0)},this._activateModify=e=>{Je.isInteractingWithTool=!this.configuration.mobile?.enabled,e.addEventListener(re.MOUSE_UP,this._endCallback),e.addEventListener(re.MOUSE_DRAG,this._dragCallback),e.addEventListener(re.MOUSE_CLICK,this._endCallback),e.addEventListener(re.TOUCH_END,this._endCallback),e.addEventListener(re.TOUCH_DRAG,this._dragCallback),e.addEventListener(re.TOUCH_TAP,this._endCallback)},this._deactivateModify=e=>{Je.isInteractingWithTool=!1,e.removeEventListener(re.MOUSE_UP,this._endCallback),e.removeEventListener(re.MOUSE_DRAG,this._dragCallback),e.removeEventListener(re.MOUSE_CLICK,this._endCallback),e.removeEventListener(re.TOUCH_END,this._endCallback),e.removeEventListener(re.TOUCH_DRAG,this._dragCallback),e.removeEventListener(re.TOUCH_TAP,this._endCallback)},this._endCallback=e=>{const t=e.detail,{element:n}=t;this.editData.annotation.data.handles.activeOperation=null,this.editData.annotation.data.activeViewportIds=[],this._deactivateModify(n),xr(n),this.editData=null;const i=(0,ne.getEnabledElement)(n),{renderingEngine:o}=i,a=Cl(n,this.getToolName(),!1);cs(o,a)},this._dragCallback=e=>{const t=e.detail,n=t.deltaPoints.world;if(Math.abs(n[0])<.001&&Math.abs(n[1])<.001&&Math.abs(n[2])<.001)return;const{element:i}=t,o=(0,ne.getEnabledElement)(i),{renderingEngine:a,viewport:s}=o,r=this._getAnnotations(o),l=this.filterInteractableAnnotationsForElement(i,r)[0];if(!l)return;const{handles:d}=l.data,{currentPoints:c}=e.detail,h=c.canvas;if(d.activeOperation===sd){const e=this._getAnnotationsForViewportsWithDifferentCameras(o,r).filter((e=>{const{data:t}=e,n=a.getViewport(t.viewportId),i=this._getReferenceLineControllable(n.id),o=this._getReferenceLineDraggableRotatable(n.id);return!0===i&&!0===o&&l.data.activeViewportIds.find((e=>e===n.id))}));this._applyDeltaShiftToSelectedViewportCameras(a,e,n)}else if(d.activeOperation===rd){const e=this._getAnnotationsForViewportsWithDifferentCameras(o,r).filter((e=>{const{data:t}=e,n=a.getViewport(t.viewportId),i=this._getReferenceLineControllable(n.id),o=this._getReferenceLineDraggableRotatable(n.id);return!0===i&&!0===o})),n=Oo.K4.create(),i=Oo.K4.create(),l=[this.toolCenter[0],this.toolCenter[1],this.toolCenter[2]],d=s.worldToCanvas(l),c=t.currentPoints.canvas,h=Oo.K4.create();Oo.K4.sub(h,c,t.deltaPoints.canvas),Oo.K4.sub(n,h,d),Oo.K4.sub(i,c,d);let g=Oo.K4.angle(n,i);this._isClockWise(d,h,c)&&(g*=-1),g=Math.round(100*g)/100;const u=s.getCamera().viewPlaneNormal,{matrix:m}=ul.Z.buildFromRadian().translate(l[0],l[1],l[2]).rotate(g,u).translate(-l[0],-l[1],-l[2]),v=[];e.forEach((e=>{const{data:t}=e;t.handles.toolCenter=l;const n=a.getViewport(t.viewportId),i=n.getCamera(),{viewUp:o,position:s,focalPoint:r}=i;o[0]+=s[0],o[1]+=s[1],o[2]+=s[2],Oo.R3.transformMat4(r,r,m),Oo.R3.transformMat4(s,s,m),Oo.R3.transformMat4(o,o,m),o[0]-=s[0],o[1]-=s[1],o[2]-=s[2],n.setCamera({position:s,viewUp:o,focalPoint:r}),v.push(n.id)})),a.renderViewports(v)}else if(d.activeOperation===ld){const e=this._getAnnotationsForViewportsWithDifferentCameras(o,r).filter((e=>{const{data:t}=e,n=a.getViewport(t.viewportId),i=this._getReferenceLineControllable(n.id),o=this._getReferenceLineSlabThicknessControlsOn(n.id);return!0===i&&!0===o&&l.data.activeViewportIds.find((e=>e===n.id))}));if(0===e.length)return;const i=this._filterViewportWithSameOrientation(o,e[0],r),d=[];d.push(s.id),i.forEach((e=>{const{data:i}=e,o=a.getViewport(i.viewportId),r=o.getCamera().viewPlaneNormal,c=Gr.ZP.dot(n,r),g=[...r];if(Gr.ZP.multiplyScalar(g,c),Math.abs(g[0])>.001||Math.abs(g[1])>.001||Math.abs(g[2])>.001){const e=Math.sqrt(g[0]*g[0]+g[1]*g[1]+g[2]*g[2]),n=t.lastPoints.world,i=[0,0,0],c=[this.toolCenter[0],this.toolCenter[1],this.toolCenter[2]];if(!this._getReferenceLineDraggableRotatable(o.id)){const{rotationPoints:e}=this.editData.annotation.data.handles,t=e.filter((e=>e[1].uid===o.id));if(2===t.length){const e=s.canvasToWorld(t[0][3]),n=s.canvasToWorld(t[1][3]);Gr.ZP.add(e,n,c),Gr.ZP.multiplyScalar(c,.5)}}Gr.ZP.subtract(n,c,i);const u=Gr.ZP.dot(i,r),m=[...r];Gr.ZP.multiplyScalar(m,u);const v=[m[0],m[1],m[2]];Oo.R3.normalize(v,v);const p=[g[0],g[1],g[2]];Oo.R3.normalize(p,p);let f=o.getSlabThickness();ne.utilities.isOpposite(v,p,.001)?f-=e:f+=e,f=Math.abs(f),f=Math.max(td.MINIMUM_SLAB_THICKNESS,f);this._pointNearReferenceLine(l,h,6,o)&&(f=td.MINIMUM_SLAB_THICKNESS);Mv(o.id,a.id).getToolInstance(this.getToolName()).setSlabThickness(o,f),d.push(o.id)}})),a.renderViewports(d)}},this._pointNearReferenceLine=(e,t,n,i)=>{const{data:o}=e,{rotationPoints:a}=o.handles;for(let e=0;e<a.length-1;++e){const o=a[e][1];if(o.id!==i.id)continue;if(!this._getReferenceLineControllable(o.id))continue;const s={start:{x:a[e][2][0],y:a[e][2][1]},end:{x:a[e][3][0],y:a[e][3][1]}},r=Jl([s.start.x,s.start.y],[s.end.x,s.end.y],[t[0],t[1]]),l={start:{x:a[e+1][2][0],y:a[e+1][2][1]},end:{x:a[e+1][3][0],y:a[e+1][3][1]}},d=Jl([l.start.x,l.start.y],[l.end.x,l.end.y],[t[0],t[1]]);if(r<=n||d<=n)return!0;e++}return!1},this._getReferenceLineColor=e.configuration?.getReferenceLineColor||nd,this._getReferenceLineControllable=e.configuration?.getReferenceLineControllable||id,this._getReferenceLineDraggableRotatable=e.configuration?.getReferenceLineDraggableRotatable||od,this._getReferenceLineSlabThicknessControlsOn=e.configuration?.getReferenceLineSlabThicknessControlsOn||ad}onSetToolActive(){const e=this._getViewportsInfo();this._unsubscribeToViewportNewVolumeSet(e),this._subscribeToViewportNewVolumeSet(e),this.computeToolCenter(e)}onSetToolPassive(){const e=this._getViewportsInfo();this.computeToolCenter(e)}onSetToolEnabled(){const e=this._getViewportsInfo();this.computeToolCenter(e)}onSetToolDisabled(){const e=this._getViewportsInfo();this._unsubscribeToViewportNewVolumeSet(e),e.forEach((({renderingEngineId:e,viewportId:t})=>{const n=(0,ne.getEnabledElementByIds)(t,e);if(!n)return;const i=this._getAnnotations(n);i?.length&&i.forEach((e=>{dp(e.annotationUID)}))}))}getHandleNearImagePoint(e,t,n,i){const o=(0,ne.getEnabledElement)(e),{viewport:a}=o;let s=this._getRotationHandleNearImagePoint(a,t,n,i);return null!==s?s:(s=this._getSlabThicknessHandleNearImagePoint(a,t,n,i),null!==s?s:void 0)}_unsubscribeToViewportNewVolumeSet(e){e.forEach((({viewportId:e,renderingEngineId:t})=>{const{viewport:n}=(0,ne.getEnabledElementByIds)(e,t),{element:i}=n;i.removeEventListener(ne.Enums.Events.VOLUME_VIEWPORT_NEW_VOLUME,this._onNewVolume)}))}_subscribeToViewportNewVolumeSet(e){e.forEach((({viewportId:e,renderingEngineId:t})=>{const{viewport:n}=(0,ne.getEnabledElementByIds)(e,t),{element:i}=n;i.addEventListener(ne.Enums.Events.VOLUME_VIEWPORT_NEW_VOLUME,this._onNewVolume)}))}_autoPanViewportIfNecessary(e,t){const n=t.getViewport(e),{clientWidth:i,clientHeight:o}=n.canvas,a=n.worldToCanvas(this.toolCenter),s=this.configuration.autoPan.panSize,r=[a[0],a[1]];if(a[0]<0?r[0]=s:a[0]>i&&(r[0]=i-s),a[1]<0?r[1]=s:a[1]>o&&(r[1]=o-s),r[0]===a[0]&&r[1]===a[1])return;const l=n.canvasToWorld(r),d=[l[0]-this.toolCenter[0],l[1]-this.toolCenter[1],l[2]-this.toolCenter[2]],c=n.getCamera(),{focalPoint:h,position:g}=c,u=[g[0]-d[0],g[1]-d[1],g[2]-d[2]],m=[h[0]-d[0],h[1]-d[1],h[2]-d[2]];n.setCamera({focalPoint:m,position:u}),n.render()}setSlabThickness(e,t){let n;const{filterActorUIDsToSetSlabThickness:i}=this.configuration;i&&i.length>0&&(n=i);let o=this.configuration.slabThicknessBlendMode;t===td.MINIMUM_SLAB_THICKNESS&&(o=ne.Enums.BlendModes.COMPOSITE);e.setBlendMode(o,n,!1),e.setSlabThickness(t,n)}_isClockWise(e,t,n){return(t[0]-e[0])*(n[1]-e[1])-(t[1]-e[1])*(n[0]-e[0])>0}_applyDeltaShiftToSelectedViewportCameras(e,t,n){t.forEach((t=>{this._applyDeltaShiftToViewportCamera(e,t,n)}))}_applyDeltaShiftToViewportCamera(e,t,n){const{data:i}=t,o=e.getViewport(i.viewportId),a=o.getCamera(),s=a.viewPlaneNormal,r=Gr.ZP.dot(n,s),l=[...s];if(Gr.ZP.multiplyScalar(l,r),Math.abs(l[0])>.001||Math.abs(l[1])>.001||Math.abs(l[2])>.001){const e=[0,0,0],t=[0,0,0];Gr.ZP.add(a.focalPoint,l,e),Gr.ZP.add(a.position,l,t),o.setCamera({focalPoint:e,position:t}),o.render()}}_getRotationHandleNearImagePoint(e,t,n,i){const{data:o}=t,{rotationPoints:a}=o.handles;for(let s=0;s<a.length;s++){const r=a[s][0],l=a[s][1];if(!this._getReferenceLineControllable(l.id))continue;if(!this._getReferenceLineDraggableRotatable(l.id))continue;const d=e.worldToCanvas(r);if(Oo.K4.distance(n,d)<i)return o.handles.activeOperation=rd,this.editData={annotation:t},r}return null}_getSlabThicknessHandleNearImagePoint(e,t,n,i){const{data:o}=t,{slabThicknessPoints:a}=o.handles;for(let s=0;s<a.length;s++){const r=a[s][0],l=a[s][1];if(!this._getReferenceLineControllable(l.id))continue;if(!this._getReferenceLineSlabThicknessControlsOn(l.id))continue;const d=e.worldToCanvas(r);if(Oo.K4.distance(n,d)<i)return o.handles.activeOperation=ld,o.activeViewportIds=[l.id],this.editData={annotation:t},r}return null}_pointNearTool(e,t,n,i){const o=(0,ne.getEnabledElement)(e),{viewport:a}=o,{clientWidth:s,clientHeight:r}=a.canvas,l=Math.sqrt(s*s+r*r),{data:d}=t,{rotationPoints:c}=d.handles,{slabThicknessPoints:h}=d.handles,g=[];for(let e=0;e<c.length-1;++e){const t=c[e][1],o=this._getReferenceLineControllable(t.id),a=this._getReferenceLineDraggableRotatable(t.id);if(!o||!a)continue;const s={start:{x:c[e][2][0],y:c[e][2][1]},end:{x:c[e][3][0],y:c[e][3][1]}},r=Jl([s.start.x,s.start.y],[s.end.x,s.end.y],[n[0],n[1]]),l={start:{x:c[e+1][2][0],y:c[e+1][2][1]},end:{x:c[e+1][3][0],y:c[e+1][3][1]}},h=Jl([l.start.x,l.start.y],[l.end.x,l.end.y],[n[0],n[1]]);(r<=i||h<=i)&&(g.push(t.id),d.handles.activeOperation=sd),e++}for(let e=0;e<h.length-1;++e){const t=h[e][1];if(g.find((e=>e===t.id)))continue;const o=this._getReferenceLineControllable(t.id),a=this._getReferenceLineSlabThicknessControlsOn(t.id);if(!o||!a)continue;const s=h[e][2],r=h[e][3],c=Oo.K4.create();Oo.K4.add(c,s,r),Oo.K4.scale(c,c,.5);const u=Oo.K4.create();Oo.K4.subtract(u,s,c),Oo.K4.normalize(u,u);const m=Oo.K4.create();Oo.K4.scale(m,u,.05*l);const v=Oo.K4.create(),p=Oo.K4.create();Oo.K4.add(v,c,m),Oo.K4.subtract(p,c,m);const f={start:{x:v[0],y:v[1]},end:{x:s[0],y:s[1]}},E=Jl([f.start.x,f.start.y],[f.end.x,f.end.y],[n[0],n[1]]),w={start:{x:p[0],y:p[1]},end:{x:r[0],y:r[1]}},I=Jl([w.start.x,w.start.y],[w.end.x,w.end.y],[n[0],n[1]]);(E<=i||I<=i)&&(g.push(t.id),d.handles.activeOperation=null),e++}return d.activeViewportIds=[...g],this.editData={annotation:t},d.handles.activeOperation===sd}}dd.toolName="Crosshairs";const cd=dd,hd="magnify-viewport";class gd extends yo{constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"],configuration:{magnifySize:10,magnifyWidth:250,magnifyHeight:250}}){super(e,t),this.preMouseDownCallback=e=>{const t=e.detail,{element:n,currentPoints:i}=t,o=(0,ne.getEnabledElement)(n),{viewport:a,renderingEngine:s}=o;if(!(a instanceof ne.StackViewport))throw new Error("MagnifyTool only works on StackViewports");const r=this._getReferencedImageId(a);if(!r)throw new Error("MagnifyTool: No referenced image id found, reconstructed planes not supported yet");const l=Cl(n,this.getToolName());return this.editData={referencedImageId:r,viewportIdsToRender:l,enabledElement:o,renderingEngine:s,currentPoints:i},this._createMagnificationViewport(),this._activateDraw(n),Rr(n),e.preventDefault(),cs(s,l),!0},this.preTouchStartCallback=e=>{this.preMouseDownCallback(e)},this._createMagnificationViewport=()=>{const{enabledElement:e,referencedImageId:t,viewportIdsToRender:n,renderingEngine:i,currentPoints:o}=this.editData,{viewport:a}=e,{element:s}=a,r=a.getProperties(),{canvas:l,world:d}=o;let c;if(c=s.querySelector(".magnifyTool"),null===c){const e=document.createElement("div");e.classList.add("magnifyTool"),e.style.display="block",e.style.width=`${this.configuration.magnifyWidth}px`,e.style.height=`${this.configuration.magnifyHeight}px`,e.style.position="absolute",c=e;s.querySelector(".viewport-element").appendChild(e);const t={viewportId:hd,type:ne.Enums.ViewportType.STACK,element:c};i.enableElement(t)}c.style.top=l[1]-this.configuration.magnifyHeight/2+"px",c.style.left=l[0]-this.configuration.magnifyWidth/2+"px";const h=i.getViewport(hd);h.setStack([t]).then((()=>{h.setProperties(r);const{parallelScale:e}=a.getCamera(),{focalPoint:t,position:n,viewPlaneNormal:i}=h.getCamera(),o=Math.sqrt(Math.pow(t[0]-n[0],2)+Math.pow(t[1]-n[1],2)+Math.pow(t[2]-n[2],2)),s=[d[0],d[1],d[2]],l=[s[0]+o*i[0],s[1]+o*i[1],s[2]+o*i[2]];h.setCamera({parallelScale:e*(1/this.configuration.magnifySize),focalPoint:s,position:l}),h.render()})),c.style.display="block",cs(i,n)},this._dragCallback=e=>{const t=e.detail,{deltaPoints:n,element:i,currentPoints:o}=t,a=n.world,s=o.canvas,r=(0,ne.getEnabledElement)(i),{renderingEngine:l}=r,d=l.getViewport(hd),c=i.querySelector(".magnifyTool");if(!c)return;c.style.top=s[1]-this.configuration.magnifyHeight/2+"px",c.style.left=s[0]-this.configuration.magnifyWidth/2+"px";const{focalPoint:h,position:g}=d.getCamera(),u=[g[0]+a[0],g[1]+a[1],g[2]+a[2]],m=[h[0]+a[0],h[1]+a[1],h[2]+a[2]];d.setCamera({focalPoint:m,position:u}),d.render()},this._dragEndCallback=e=>{const{element:t}=e.detail,n=(0,ne.getEnabledElement)(t),{renderingEngine:i}=n;i.disableElement(hd);const o=t.querySelector(".viewport-element"),a=o.querySelector(".magnifyTool");o.removeChild(a),this._deactivateDraw(t),xr(t)},this._activateDraw=e=>{Je.isInteractingWithTool=!0,e.addEventListener(re.MOUSE_UP,this._dragEndCallback),e.addEventListener(re.MOUSE_DRAG,this._dragCallback),e.addEventListener(re.MOUSE_CLICK,this._dragEndCallback),e.addEventListener(re.TOUCH_END,this._dragEndCallback),e.addEventListener(re.TOUCH_DRAG,this._dragCallback)},this._deactivateDraw=e=>{Je.isInteractingWithTool=!1,e.removeEventListener(re.MOUSE_UP,this._dragEndCallback),e.removeEventListener(re.MOUSE_DRAG,this._dragCallback),e.removeEventListener(re.MOUSE_CLICK,this._dragEndCallback),e.removeEventListener(re.TOUCH_END,this._dragEndCallback),e.removeEventListener(re.TOUCH_DRAG,this._dragCallback)}}_getReferencedImageId(e){const t=this.getTargetId(e);let n;return e instanceof ne.StackViewport&&(n=t.split("imageId:")[1]),n}}gd.toolName="Magnify";const ud=gd;function md(e){const[t,n]=e;return Ll(t,n)}function vd(e){const[t,n]=e,i=Ll(t,n);return[[t[0]-i,t[1]-i],[t[0]+i,t[1]+i]]}const pd=e=>e.uid!==e.referenceId;class fd{constructor({magnifyViewportId:e,sourceEnabledElement:t,radius:n=125,position:i=[0,0],zoomFactor:o,autoPan:a}){this._enabledElement=null,this._sourceToolGroup=null,this._magnifyToolGroup=null,this._isViewportReady=!1,this._radius=0,this._resized=!1,this._canAutoPan=!1,this._viewportId=e??ne.utilities.uuidv4(),this._sourceEnabledElement=t,this._autoPan=a,this.radius=n,this.position=i,this.zoomFactor=o,this.visible=!0,this._browserMouseDownCallback=this._browserMouseDownCallback.bind(this),this._browserMouseUpCallback=this._browserMouseUpCallback.bind(this),this._handleToolModeChanged=this._handleToolModeChanged.bind(this),this._mouseDragCallback=this._mouseDragCallback.bind(this),this._resizeViewportAsync=Ka(this._resizeViewport.bind(this),1),this._initialize()}get sourceEnabledElement(){return this._sourceEnabledElement}get viewportId(){return this._viewportId}get radius(){return this._radius}set radius(e){Math.abs(this._radius-e)>1e-5&&(this._radius=e,this._resized=!0)}update(){const{radius:e,position:t,visible:n}=this,{viewport:i}=this._enabledElement,{element:o}=i,a=2*e,[s,r]=t;this._resized&&(this._resizeViewportAsync(),this._resized=!1),Object.assign(o.style,{display:n?"block":"hidden",width:`${a}px`,height:`${a}px`,left:-e+"px",top:-e+"px",transform:`translate(${s}px, ${r}px)`}),this._isViewportReady&&(this._syncViewports(),i.render())}dispose(){const{viewport:e}=this._enabledElement,{element:t}=e,n=e.getRenderingEngine();this._removeEventListeners(t),n.disableElement(e.id),t.parentNode&&t.parentNode.removeChild(t)}_handleToolModeChanged(e){const{_magnifyToolGroup:t}=this,{toolGroupId:n,toolName:i,mode:o,toolBindingsOptions:a}=e.detail;if(this._sourceToolGroup?.id===n)switch(o){case ie.Active:t.setToolActive(i,a);break;case ie.Passive:t.setToolPassive(i);break;case ie.Enabled:t.setToolEnabled(i);break;case ie.Disabled:t.setToolDisabled(i);break;default:throw new Error(`Unknow tool mode (${o})`)}}_inheritBorderRadius(e){const t=e.querySelector(".viewport-element"),n=e.querySelector(".cornerstone-canvas");t.style.borderRadius="inherit",n.style.borderRadius="inherit"}_createViewportNode(){const e=document.createElement("div"),{radius:t}=this,n=2*t;return e.classList.add("advancedMagnifyTool"),Object.assign(e.style,{display:"block",width:`${n}px`,height:`${n}px`,position:"absolute",overflow:"hidden",borderRadius:"50%",boxSizing:"border-box",left:-t+"px",top:-t+"px",transform:"translate(-1000px, -1000px)"}),e}_convertZoomFactorToParalellScale(e,t,n){const{parallelScale:i}=e.getCamera();return i*(1/n)*(t.canvas.offsetWidth/e.canvas.offsetWidth)}_isStackViewport(e){return"setStack"in e}_isVolumeViewport(e){return"addVolumes"in e}_cloneToolGroups(e,t){const n=e.getActors(),i=`${t.id}-toolGroup`,o=Mv(e.id,e.renderingEngineId),a=o.clone(i,(e=>{const t=o.getToolInstance(e);return t instanceof Ca&&!(t instanceof _d)||e===xa.toolName}));return a.addViewport(t.id,t.renderingEngineId),n.filter(pd).forEach((e=>{ho(i,[{segmentationId:e.referenceId,type:de.Labelmap}])})),{sourceToolGroup:o,magnifyToolGroup:a}}_cloneStack(e,t){const n=e.getImageIds();t.setStack(n).then((()=>{this._isViewportReady=!0,this.update()}))}_cloneVolumes(e,t){const n=e.getActors().filter((e=>!pd(e))).map((e=>({volumeId:e.uid})));return t.setVolumes(n).then((()=>{this._isViewportReady=!0,this.update()})),t}_cloneViewport(e,t){const{viewportId:n}=this,i=e.getRenderingEngine(),{options:o}=e,a={element:t,viewportId:n,type:e.type,defaultOptions:{...o}};i.enableElement(a);const s=i.getViewport(n);this._isStackViewport(e)?this._cloneStack(e,s):this._isVolumeViewport(e)&&this._cloneVolumes(e,s),this._inheritBorderRadius(t);const r=this._cloneToolGroups(e,s);this._sourceToolGroup=r.sourceToolGroup,this._magnifyToolGroup=r.magnifyToolGroup}_cancelMouseEventCallback(e){e.stopPropagation(),e.preventDefault()}_browserMouseUpCallback(e){const{element:t}=this._enabledElement.viewport;document.removeEventListener("mouseup",this._browserMouseUpCallback),t.addEventListener("mouseup",this._cancelMouseEventCallback),t.addEventListener("mousemove",this._cancelMouseEventCallback)}_browserMouseDownCallback(e){const{element:t}=this._enabledElement.viewport;this._canAutoPan=!!e.target?.closest(".advancedMagnifyTool"),document.addEventListener("mouseup",this._browserMouseUpCallback),t.removeEventListener("mouseup",this._cancelMouseEventCallback),t.removeEventListener("mousemove",this._cancelMouseEventCallback)}_mouseDragCallback(e){if(!Je.isInteractingWithTool)return;const{_autoPan:t}=this;if(!t.enabled||!this._canAutoPan)return;const{currentPoints:n}=e.detail,{viewport:i}=this._enabledElement,{canvasToWorld:o}=i,{canvas:a}=n,{radius:s}=this,r=[s,s],l=Ll(r,a),d=s-t.padding;if(l<=d)return;const c=l-d,h=Oo.K4.sub(Oo.K4.create(),a,r);Oo.K4.normalize(h,h),Oo.K4.scale(h,h,c);const g=Oo.K4.add(Oo.K4.create(),this.position,h),u=o(this.position),m=o(g),v=Oo.R3.sub(Oo.R3.create(),m,u),p={points:{currentPosition:{canvas:this.position,world:u},newPosition:{canvas:g,world:m}},delta:{canvas:h,world:v}};t.callback(p)}_addBrowserEventListeners(e){document.addEventListener("mousedown",this._browserMouseDownCallback,!0),e.addEventListener("mousedown",this._cancelMouseEventCallback),e.addEventListener("mouseup",this._cancelMouseEventCallback),e.addEventListener("mousemove",this._cancelMouseEventCallback),e.addEventListener("dblclick",this._cancelMouseEventCallback)}_removeBrowserEventListeners(e){document.removeEventListener("mousedown",this._browserMouseDownCallback,!0),document.removeEventListener("mouseup",this._browserMouseUpCallback),e.removeEventListener("mousedown",this._cancelMouseEventCallback),e.removeEventListener("mouseup",this._cancelMouseEventCallback),e.removeEventListener("mousemove",this._cancelMouseEventCallback),e.removeEventListener("dblclick",this._cancelMouseEventCallback)}_addEventListeners(e){ne.eventTarget.addEventListener(re.TOOL_MODE_CHANGED,this._handleToolModeChanged),e.addEventListener(re.MOUSE_MOVE,this._mouseDragCallback),e.addEventListener(re.MOUSE_DRAG,this._mouseDragCallback),this._addBrowserEventListeners(e)}_removeEventListeners(e){ne.eventTarget.removeEventListener(re.TOOL_MODE_CHANGED,this._handleToolModeChanged),e.addEventListener(re.MOUSE_MOVE,this._mouseDragCallback),e.addEventListener(re.MOUSE_DRAG,this._mouseDragCallback),this._removeBrowserEventListeners(e)}_initialize(){const{_sourceEnabledElement:e}=this,{viewport:t}=e,{canvas:n}=t,i=this._createViewportNode();n.parentNode.appendChild(i),this._addEventListeners(i),this._cloneViewport(t,i),this._enabledElement=(0,ne.getEnabledElement)(i)}_syncViewportsCameras(e,t){const n=e.canvasToWorld(this.position),i=this._convertZoomFactorToParalellScale(e,t,this.zoomFactor),{focalPoint:o,position:a,viewPlaneNormal:s}=t.getCamera(),r=Math.sqrt(Math.pow(o[0]-a[0],2)+Math.pow(o[1]-a[1],2)+Math.pow(o[2]-a[2],2)),l=[n[0],n[1],n[2]],d=[l[0]+r*s[0],l[1]+r*s[1],l[2]+r*s[2]];t.setCamera({parallelScale:i,focalPoint:l,position:d})}_syncStackViewports(e,t){t.setImageIdIndex(e.getCurrentImageIdIndex())}_syncViewports(){const{viewport:e}=this._sourceEnabledElement,{viewport:t}=this._enabledElement,n=e.getProperties();t.setProperties(n),this._syncViewportsCameras(e,t),this._isStackViewport(e)&&this._syncStackViewports(e,t)}_resizeViewport(){const{viewport:e}=this._enabledElement;e.getRenderingEngine().resize()}}const Ed=1-ne.CONSTANTS.EPSILON,{Events:wd}=ne.Enums;class Id{constructor(){this.createViewport=(e,t)=>{const{magnifyViewportId:n,sourceEnabledElement:i,position:o,radius:a,zoomFactor:s,autoPan:r}=t,{viewport:l}=i,{element:d}=l,c=new fd({magnifyViewportId:n,sourceEnabledElement:i,radius:a,position:o,zoomFactor:s,autoPan:r});return this._addSourceElementEventListener(d),this._magnifyViewportsMap.set(c.viewportId,{annotation:e,magnifyViewport:c}),c},this._annotationRemovedCallback=e=>{const{annotation:t}=e.detail;"AdvancedMagnify"===t.metadata.toolName&&this._destroyViewport(t.data.magnifyViewportId)},this._newStackImageCallback=e=>{const{viewportId:t,imageId:n}=e.detail;this._getMagnifyViewportsMapEntriesBySourceViewportId(t).forEach((({annotation:e})=>{e.metadata.referencedImageId=n,e.invalidated=!0}))},this._newVolumeImageCallback=e=>{const{renderingEngineId:t,viewportId:n}=e.detail,i=(0,ne.getRenderingEngine)(t).getViewport(n),{viewPlaneNormal:o}=i.getCamera();this._getMagnifyViewportsMapEntriesBySourceViewportId(n).forEach((({annotation:e})=>{const{viewPlaneNormal:t}=e.metadata;if(!(Math.abs(Oo.R3.dot(t,o))>Ed))return;const{handles:n}=e.data,a=i.canvasToWorld([0,0]),s=Oo.R3.sub(Oo.R3.create(),a,n.points[0]),r=Oo.R3.dot(s,o),l=Oo.R3.scale(Oo.R3.create(),o,r);for(let e=0,t=n.points.length;e<t;e++){const t=n.points[e];t[0]+=l[0],t[1]+=l[1],t[2]+=l[2]}e.invalidated=!0}))},this._magnifyViewportsMap=new Map,this._initialize()}static getInstance(){return Id._singleton=Id._singleton??new Id,Id._singleton}getViewport(e){return this._magnifyViewportsMap.get(e)?.magnifyViewport}dispose(){this._removeEventListeners(),this._destroyViewports()}_destroyViewport(e){const t=this._magnifyViewportsMap.get(e);if(t){const{magnifyViewport:n}=t,{viewport:i}=n.sourceEnabledElement,{element:o}=i;this._removeSourceElementEventListener(o),n.dispose(),this._magnifyViewportsMap.delete(e)}}_destroyViewports(){Array.from(this._magnifyViewportsMap.keys()).forEach((e=>this._destroyViewport(e)))}_getMagnifyViewportsMapEntriesBySourceViewportId(e){return Array.from(this._magnifyViewportsMap.values()).filter((({magnifyViewport:t})=>{const{viewport:n}=t.sourceEnabledElement;return n.id===e}))}_addEventListeners(){ne.eventTarget.addEventListener(re.ANNOTATION_REMOVED,this._annotationRemovedCallback)}_removeEventListeners(){ne.eventTarget.removeEventListener(re.ANNOTATION_REMOVED,this._annotationRemovedCallback)}_addSourceElementEventListener(e){e.addEventListener(wd.STACK_NEW_IMAGE,this._newStackImageCallback),e.addEventListener(wd.VOLUME_NEW_IMAGE,this._newVolumeImageCallback)}_removeSourceElementEventListener(e){e.removeEventListener(wd.STACK_NEW_IMAGE,this._newStackImageCallback),e.removeEventListener(wd.VOLUME_NEW_IMAGE,this._newVolumeImageCallback)}_initialize(){this._addEventListeners()}}var Cd;!function(e){e.ShowZoomFactorsList="showZoomFactorsList"}(Cd||(Cd={}));class _d extends Ca{constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"],configuration:{shadow:!0,magnifyingGlass:{radius:125,zoomFactor:2.5,zoomFactorList:[2.5,3,3.5,4,4.5,5],autoPan:{enabled:!0,padding:10}},actions:{showZoomFactorsList:{method:"showZoomFactorsList",bindings:[{mouseButton:Q.Secondary,modifierKey:ee.Shift}]}}}}){super(e,t),this.addNewAnnotation=e=>{const t=e.detail,{currentPoints:n,element:i}=t,o=(0,ne.getEnabledElement)(i),{viewport:a,renderingEngine:s}=o,r=n.world,l=n.canvas,{magnifyingGlass:d}=this.configuration,{radius:c,zoomFactor:h,autoPan:g}=d,u=this._getWorldHandlesPoints(a,l,c),m=a.getCamera(),{viewPlaneNormal:v,viewUp:p}=m,f=this.getReferencedImageId(a,r,v,p),E=ne.utilities.uuidv4(),w=ne.utilities.uuidv4(),I=a.getFrameOfReferenceUID(),C={annotationUID:E,highlighted:!0,invalidated:!0,metadata:{toolName:this.getToolName(),viewPlaneNormal:[...v],viewUp:[...p],FrameOfReferenceUID:I,referencedImageId:f},data:{sourceViewportId:a.id,magnifyViewportId:w,zoomFactor:h,handles:{points:u,activeHandleIndex:null}}};this.magnifyViewportManager.createViewport(C,{magnifyViewportId:w,sourceEnabledElement:o,position:l,radius:c,zoomFactor:h,autoPan:{enabled:g.enabled,padding:g.padding,callback:e=>{const t=C.data.handles.points,{world:n}=e.delta;for(let e=0,i=t.length;e<i;e++)t[e][0]+=n[0],t[e][1]+=n[1],t[e][2]+=n[2]}}}),rp(C,i);const _=Cl(i,this.getToolName());return e.preventDefault(),cs(s,_),C},this.isPointNearTool=(e,t,n,i)=>{const o=(0,ne.getEnabledElement)(e),{viewport:a}=o,{data:s}=t,{points:r}=s.handles,l=r.map((e=>a.worldToCanvas(e))),d=l[0],c=l[2],h=l[3],g=.5*Math.abs(c[1]-d[1]),u=md([[h[0]+g,d[1]+g],n]);return Math.abs(u-g)<1.5*i},this.toolSelectedCallback=(e,t)=>{const n=e.detail,{element:i}=n;t.highlighted=!0;const o=Cl(i,this.getToolName());this.editData={annotation:t,viewportIdsToRender:o},Rr(i),this._activateModify(i);const a=(0,ne.getEnabledElement)(i),{renderingEngine:s}=a;cs(s,o),e.preventDefault()},this.handleSelectedCallback=(e,t,n)=>{const i=e.detail,{element:o}=i,{data:a}=t;t.highlighted=!0;const{points:s}=a.handles,r=s.findIndex((e=>e===n)),l=Cl(o,this.getToolName());this.editData={annotation:t,viewportIdsToRender:l,handleIndex:r},this._activateModify(o),Rr(o);const d=(0,ne.getEnabledElement)(o),{renderingEngine:c}=d;cs(c,l),e.preventDefault()},this._endCallback=e=>{const t=e.detail,{element:n}=t,{annotation:i,viewportIdsToRender:o,newAnnotation:a}=this.editData,{data:s}=i;s.handles.activeHandleIndex=null,this._deactivateModify(n),xr(n);const r=(0,ne.getEnabledElement)(n),{renderingEngine:l}=r;if(this.editData=null,this.isDrawing=!1,cs(l,o),a){const e=re.ANNOTATION_COMPLETED,t={annotation:i};(0,ne.triggerEvent)(ne.eventTarget,e,t)}},this._dragDrawCallback=e=>{this.isDrawing=!0;const t=e.detail,{element:n,deltaPoints:i}=t,o=i?.world??[0,0,0],a=(0,ne.getEnabledElement)(n),{renderingEngine:s}=a,{annotation:r,viewportIdsToRender:l}=this.editData,{points:d}=r.data.handles;d.forEach((e=>{e[0]+=o[0],e[1]+=o[1],e[2]+=o[2]})),r.invalidated=!0,this.editData.hasMoved=!0,cs(s,l)},this._dragModifyCallback=e=>{this.isDrawing=!0;const t=e.detail,{element:n}=t,{annotation:i,viewportIdsToRender:o,handleIndex:a}=this.editData,{data:s}=i;if(void 0===a){const{deltaPoints:e}=t,n=e.world;s.handles.points.forEach((e=>{e[0]+=n[0],e[1]+=n[1],e[2]+=n[2]})),i.invalidated=!0}else this._dragHandle(e),i.invalidated=!0;const r=(0,ne.getEnabledElement)(n),{renderingEngine:l}=r;cs(l,o)},this._dragHandle=e=>{const t=e.detail,{element:n}=t,i=(0,ne.getEnabledElement)(n),{viewport:o}=i,{worldToCanvas:a}=o,{annotation:s}=this.editData,{data:r}=s,{points:l}=r.handles,d=l.map((e=>a(e))),c=d[0],h=d[2],g=d[3],u=.5*Math.abs(h[1]-c[1]),m=[g[0]+u,c[1]+u],{currentPoints:v}=t,p=md([m,v.canvas]),f=this._getWorldHandlesPoints(o,m,p);l[0]=f[0],l[1]=f[1],l[2]=f[2],l[3]=f[3]},this.cancel=e=>{if(!this.isDrawing)return;this.isDrawing=!1,this._deactivateModify(e),xr(e);const{annotation:t,viewportIdsToRender:n,newAnnotation:i}=this.editData,{data:o}=t;t.highlighted=!1,o.handles.activeHandleIndex=null;const a=(0,ne.getEnabledElement)(e),{renderingEngine:s}=a;if(cs(s,n),i){const e=re.ANNOTATION_COMPLETED,n={annotation:t};(0,ne.triggerEvent)(ne.eventTarget,e,n)}return this.editData=null,t.annotationUID},this._activateModify=e=>{Je.isInteractingWithTool=!0,e.addEventListener(re.MOUSE_UP,this._endCallback),e.addEventListener(re.MOUSE_DRAG,this._dragModifyCallback),e.addEventListener(re.MOUSE_CLICK,this._endCallback),e.addEventListener(re.TOUCH_END,this._endCallback),e.addEventListener(re.TOUCH_DRAG,this._dragModifyCallback),e.addEventListener(re.TOUCH_TAP,this._endCallback)},this._deactivateModify=e=>{Je.isInteractingWithTool=!1,e.removeEventListener(re.MOUSE_UP,this._endCallback),e.removeEventListener(re.MOUSE_DRAG,this._dragModifyCallback),e.removeEventListener(re.MOUSE_CLICK,this._endCallback),e.removeEventListener(re.TOUCH_END,this._endCallback),e.removeEventListener(re.TOUCH_DRAG,this._dragModifyCallback),e.removeEventListener(re.TOUCH_TAP,this._endCallback)},this.renderAnnotation=(e,t)=>{let n=!1;const{viewport:i}=e,{element:o}=i;let a=sp(this.getToolName(),o);if(!a?.length)return n;if(a=this.filterInteractableAnnotationsForElement(o,a),a=a?.filter((e=>e.data.sourceViewportId===i.id)),!a?.length)return n;const s={toolGroupId:this.toolGroupId,toolName:this.getToolName(),viewportId:e.viewport.id};for(let e=0;e<a.length;e++){const o=a[e],{annotationUID:r,data:l}=o,{magnifyViewportId:d,zoomFactor:c,handles:h}=l,{points:g,activeHandleIndex:u}=h;s.annotationUID=r;const m=this.getStyle("lineWidth",s,o),v=this.getStyle("lineDash",s,o),p=this.getStyle("color",s,o),f=g.map((e=>i.worldToCanvas(e))),E=f[0],w=f[2],I=f[3],C=.5*Math.abs(w[1]-E[1]),_=[I[0]+C,E[1]+C];if(!i.getRenderingEngine())return console.warn("Rendering Engine has been destroyed"),n;let T;if(!He(r))continue;if(we(o)||this.editData||null===u||(T=[f[u]]),T){$o(t,r,"0",T,{color:p})}Ho(t,r,"0",_,C,{color:p,lineDash:v,lineWidth:m},`${r}-advancedMagnify`);const b=this.magnifyViewportManager.getViewport(d);b.position=_,b.radius=C,b.zoomFactor=c,b.update(),n=!0}return n},this._getWorldHandlesPoints=(e,t,n)=>[[t[0],t[1]-n],[t[0]+n,t[1]],[t[0],t[1]+n],[t[0]-n,t[1]]].map((t=>e.canvasToWorld(t))),this.magnifyViewportManager=Id.getInstance()}showZoomFactorsList(e,t){const{element:n,currentPoints:i}=e.detail,o=(0,ne.getEnabledElement)(n),{viewport:a}=o,{canvas:s}=i,r=n.querySelector(":scope .viewport-element"),l=t.data.zoomFactor,d=this._getZoomFactorsListDropdown(l,(e=>{void 0!==e&&(t.data.zoomFactor=Number.parseFloat(e),t.invalidated=!0),d.parentElement.removeChild(d),a.render()}));Object.assign(d.style,{left:`${s[0]}px`,top:`${s[1]}px`}),r.appendChild(d),d.focus()}_getZoomFactorsListDropdown(e,t){const{zoomFactorList:n}=this.configuration.magnifyingGlass,i=document.createElement("select");return i.size=5,Object.assign(i.style,{width:"50px",position:"absolute"}),["mousedown","mouseup","mousemove","click"].forEach((e=>{i.addEventListener(e,(e=>e.stopPropagation()))})),i.addEventListener("change",(e=>{e.stopPropagation(),t(i.value)})),i.addEventListener("keydown",(e=>{((e.keyCode??27===e.which)||"escape"===e.key?.toLowerCase())&&(e.stopPropagation(),t())})),n.forEach((t=>{const n=document.createElement("option");n.label=t,n.title=`Zoom factor ${t.toFixed(1)}`,n.value=t,n.defaultSelected=t===e,i.add(n)})),i}}_d.Actions=Cd,_d.toolName="AdvancedMagnify";const{EPSILON:Td}=ne.CONSTANTS;class bd extends wa{constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"],configuration:{sourceViewportId:"",showFullDimension:!1}}){super(e,t),this.editData={},this._init=()=>{const e=(0,ne.getRenderingEngines)()[0];if(!e)return;let t=e.getViewports();t=El(t,this.getToolName());const n=e.getViewport(this.configuration.sourceViewportId);if(!n||!n.getImageData())return;const{element:i}=n,{viewUp:o,viewPlaneNormal:a}=n.getCamera(),s=ne.utilities.getViewportImageCornersInWorld(n);let r=this.editData.annotation;const l=n.getFrameOfReferenceUID();if(r)this.editData.annotation.data.handles.points=s;else{const e={highlighted:!0,invalidated:!0,metadata:{toolName:this.getToolName(),viewPlaneNormal:[...a],viewUp:[...o],FrameOfReferenceUID:l,referencedImageId:null},data:{handles:{points:s}}};rp(e,i),r=e}this.editData={sourceViewport:n,renderingEngine:e,annotation:r},cs(e,t.filter((e=>e.id!==n.id)).map((e=>e.id)))},this.onSetToolEnabled=()=>{this._init()},this.onCameraModified=e=>{this._init()},this.renderAnnotation=(e,t)=>{const{viewport:n}=e,{annotation:i,sourceViewport:o}=this.editData;let a=!1;if(!o)return a;if(o.id===n.id)return a;if(!i||!i?.data?.handles?.points)return a;const s={toolGroupId:this.toolGroupId,toolName:this.getToolName(),viewportId:e.viewport.id},r=i.data.handles.points[0],l=i.data.handles.points[1],d=i.data.handles.points[2],c=i.data.handles.points[3],{focalPoint:h,viewPlaneNormal:g,viewUp:u}=n.getCamera(),{viewPlaneNormal:m}=o.getCamera();if(this.isParallel(g,m))return a;const v=ne.utilities.planar.planeEquation(g,h),p=[r,d,l,c],f=[r,l,d,c];let E=p,w=Oo.R3.subtract(Oo.R3.create(),p[0],p[1]);w=Oo.R3.normalize(Oo.R3.create(),w);let I=Oo.R3.subtract(Oo.R3.create(),p[2],p[0]);I=Oo.R3.normalize(Oo.R3.create(),I);const C=Oo.R3.cross(Oo.R3.create(),w,I);if(this.isParallel(C,g))return a;this.isPerpendicular(w,g)&&(E=f);const _=ne.utilities.planar.linePlaneIntersection(E[0],E[1],v),T=ne.utilities.planar.linePlaneIntersection(E[2],E[3],v),{annotationUID:b}=i;s.annotationUID=b;const D=this.getStyle("lineWidth",s,i),S=this.getStyle("lineDash",s,i),M=this.getStyle("color",s,i),y=this.getStyle("shadow",s,i);let O=[_,T].map((e=>n.worldToCanvas(e)));this.configuration.showFullDimension&&(O=this.handleFullDimension(n,_,g,u,T,O));const x=`${b}-line`;return Ko(t,b,"1",O[0],O[1],{color:M,width:D,lineDash:S,shadow:y},x),a=!0,a},this.isPerpendicular=(e,t)=>{const n=Oo.R3.dot(e,t);return Math.abs(n)<Td}}handleFullDimension(e,t,n,i,o,a){const s=e.getRenderingEngine(),r=this.getTargetId(e),l=this.getTargetIdImage(r,s),d=this.getReferencedImageId(e,t,n,i);if(d&&l)try{const{imageData:n,dimensions:i}=l,[s,r,c,h]=[n.indexToWorld([0,0,0]),n.indexToWorld([i[0]-1,0,0]),n.indexToWorld([i[0]-1,i[1]-1,0]),n.indexToWorld([0,i[1]-1,0])].map((e=>ne.utilities.worldToImageCoords(d,e))),[g,u]=[t,o].map((e=>ne.utilities.worldToImageCoords(d,e)));a=[[s,r],[r,c],[h,c],[s,h]].map((([e,t])=>this.intersectInfiniteLines(e,t,g,u))).filter((e=>e&&this.isInBound(e,i))).map((t=>{const n=ne.utilities.imageToWorldCoords(d,t);return e.worldToCanvas(n)}))}catch(e){console.log(e)}return a}intersectInfiniteLines(e,t,n,i){const[o,a]=e,[s,r]=t,[l,d]=n,[c,h]=i,g=r-a,u=o-s,m=s*a-o*r,v=h-d,p=l-c,f=c*d-l*h;if(Math.abs(g*p-v*u)<Td)return;return[(u*f-p*m)/(g*p-v*u),(v*m-g*f)/(g*p-v*u)]}isParallel(e,t){return Math.abs(Oo.R3.dot(e,t))>1-Td}isInBound(e,t){return e[0]>=0&&e[0]<=t[0]&&e[1]>=0&&e[1]<=t[1]}}bd.toolName="ReferenceLines";const Dd=bd,{EPSILON:Sd}=ne.CONSTANTS;class Md extends wa{constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"],configuration:{sourceImageIds:[]}}){super(e,t),this.onSetToolEnabled=()=>{this._init()},this.onSetToolActive=()=>{this._init()},this._init=()=>{const e=this.configuration.sourceImageIds;if(!e?.length)return void console.warn("OverlayGridTool: No sourceImageIds provided in configuration");const t=ne.metaData.get("imagePlaneModule",e[0]);if(!t)return void console.warn("OverlayGridTool: No imagePlaneModule found for sourceImageIds");const{frameOfReferenceUID:n}=t,i=Jv(this.toolGroupId).viewportsInfo;if(!i?.length)return void console.warn("OverlayGridTool: No viewports found");const o=sp(this.getToolName(),n);if(!o?.length){const t=e.map((e=>this.calculateImageIdPointSets(e)));rp({highlighted:!0,invalidated:!0,metadata:{toolName:this.getToolName(),FrameOfReferenceUID:n,referencedImageId:null},data:{viewportData:new Map,pointSets:t}},n)}cs((0,ne.getRenderingEngine)(i[0].renderingEngineId),i.map((({viewportId:e})=>e)))},this.calculateImageIdPointSets=e=>{const{imagePositionPatient:t,rows:n,columns:i,rowCosines:o,columnCosines:a,rowPixelSpacing:s,columnPixelSpacing:r}=ne.metaData.get("imagePlaneModule",e),l=[...t],d=[...t],c=[...t],h=[...t];Oo.R3.scaleAndAdd(d,t,a,i*r),Oo.R3.scaleAndAdd(c,t,o,n*s),Oo.R3.scaleAndAdd(h,c,a,i*r);return{pointSet1:[l,c,d,h],pointSet2:[l,d,c,h]}},this.renderAnnotation=(e,t)=>{const n=this.configuration.sourceImageIds;let i=!1;if(!n?.length)return i;const{viewport:o,FrameOfReferenceUID:a}=e;if(o.getImageIds().length<2)return i;const s=sp(this.getToolName(),a);if(!s?.length)return i;const r=s[0],{annotationUID:l}=r,{focalPoint:d,viewPlaneNormal:c}=o.getCamera(),h={toolGroupId:this.toolGroupId,toolName:this.getToolName(),viewportId:e.viewport.id},g=this.getImageIdNormal(n[0]);if(this.isParallel(c,g))return i;const u=ne.utilities.planar.planeEquation(c,d),m=r.data.pointSets,v=r.data.viewportData;for(let e=0;e<n.length;e++){const{pointSet1:n,pointSet2:i}=m[e],a=v.get(o.id)||this.initializeViewportData(v,o.id);if(!a.pointSetsToUse[e]){let t=n,o=Oo.R3.subtract(Oo.R3.create(),n[0],n[1]);o=Oo.R3.normalize(Oo.R3.create(),o),this.isPerpendicular(o,c)&&(t=i),a.pointSetsToUse[e]=t,a.lineStartsWorld[e]=ne.utilities.planar.linePlaneIntersection(t[0],t[1],u),a.lineEndsWorld[e]=ne.utilities.planar.linePlaneIntersection(t[2],t[3],u)}const s=a.lineStartsWorld[e],d=a.lineEndsWorld[e];h.annotationUID=l;const g=this.getStyle("lineWidth",h,r),p=this.getStyle("lineDash",h,r),f=this.getStyle("color",h,r),E=this.getStyle("shadow",h,r),w=[s,d].map((e=>o.worldToCanvas(e))),I=`${l}-line`;Ko(t,l,`${e}`,w[0],w[1],{color:f,width:g,lineDash:p,shadow:E},I)}return i=!0,i},this.initializeViewportData=(e,t)=>(e.set(t,{pointSetsToUse:[],lineStartsWorld:[],lineEndsWorld:[]}),e.get(t)),this.isPerpendicular=(e,t)=>{const n=Oo.R3.dot(e,t);return Math.abs(n)<Sd}}isParallel(e,t){return Math.abs(Oo.R3.dot(e,t))>1-Sd}getImageIdNormal(e){const{imageOrientationPatient:t}=ne.metaData.get("imagePlaneModule",e),n=Oo.R3.fromValues(t[0],t[1],t[2]),i=Oo.R3.fromValues(t[3],t[4],t[5]);return Oo.R3.cross(Oo.R3.create(),n,i)}}Md.toolName="OverlayGrid";const yd=Md;class Od extends wa{constructor(e={},t={configuration:{opacity:.5}}){super(e,t),this._init=()=>{const e=Jv(this.toolGroupId).viewportsInfo;if(!e?.length)return void console.warn(this.getToolName()+"Tool: No viewports found");const t=(0,ne.getRenderingEngine)(e[0].renderingEngineId)?.getViewport(e[0].viewportId);if(!t)return;const n=t.getFrameOfReferenceUID(),i=sp(this.getToolName(),n);if(!i?.length){const t=new Map;!function(e,t){t.forEach((({viewportId:t,renderingEngineId:n})=>{const i=(0,ne.getRenderingEngine)(n)?.getViewport(t);xd(e,i)}))}(t,e);rp({highlighted:!0,invalidated:!0,metadata:{toolName:this.getToolName(),FrameOfReferenceUID:n,referencedImageId:null},data:{actorsWorldPointsMap:t}},n)}cs((0,ne.getRenderingEngine)(e[0].renderingEngineId),e.map((({viewportId:e})=>e)))},this.onSetToolEnabled=()=>{this._init()},this.onCameraModified=e=>{this._init()},this.renderAnnotation=(e,t)=>{const{viewport:n,FrameOfReferenceUID:i}=e;let o=!1;const a=sp(this.getToolName(),i);if(!a?.length)return o;const s=a[0],{annotationUID:r}=s,l=s.data.actorsWorldPointsMap;xd(l,n);const d=n.getActors(),c=Rd(n);return d.forEach((e=>{if(!e?.clippingFilter)return;const i=l.get(e.uid);if(!i)return;if(!i.get(c))return;let o=1;const{worldPointsSet:a,color:s}=i.get(c);for(let i=0;i<a.length;i++){const l=a[i].map((e=>n.worldToCanvas(e))),d={color:s,fillColor:s,fillOpacity:this.configuration.opacity,connectLastToFirst:!0},c=e.uid+"#"+o;qo(t,r,c,l,d),o++}})),o=!0,o}}}function xd(e,t){const n=t.getActors(),i=Rd(t);n.forEach((t=>{if(!t?.clippingFilter)return;let n=e.get(t.uid);if(n||(n=new Map,e.set(t.uid,n)),!n.get(i)){const e=im(t.clippingFilter.getOutputData());if(!e)return;const o=function(e){function t(e){let t=Math.floor(255*e).toString(16);return 1===t.length&&(t="0"+t),t}return"#"+t(e[0])+t(e[1])+t(e[2])}(t.actor.getProperty().getColor());n.set(i,{worldPointsSet:e,color:o})}}))}function Rd(e){const{viewPlaneNormal:t}=e.getCamera(),n=e.getCurrentImageIdIndex();return`${e.id}-${ba(t)}-${n}`}Od.toolName="SegmentationIntersection";const Pd=Od;class Nd extends wa{constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"],configuration:{shadow:!0,preventHandleOutsideImage:!1,displayThreshold:5,positionSync:!0,disableCursor:!1}}){super(e,t),this.isDrawing=!1,this.isHandleOutsideImage=!1,this._elementWithCursor=null,this._currentCursorWorldPosition=null,this._currentCanvasPosition=null,this._disableCursorEnabled=!1,this.mouseMoveCallback=e=>{const{detail:t}=e,{element:n,currentPoints:i}=t;this._currentCursorWorldPosition=i.world,this._currentCanvasPosition=i.canvas,this._elementWithCursor=n;const o=this.getActiveAnnotation(n);return null===o?(this.createInitialAnnotation(i.world,n),!1):(this.updateAnnotationPosition(n,o),!1)},this.createInitialAnnotation=(e,t)=>{const n=(0,ne.getEnabledElement)(t);if(!n)throw new Error("No enabled element found");const{viewport:i,renderingEngine:o}=n;this.isDrawing=!0;const a=i.getCamera(),{viewPlaneNormal:s,viewUp:r}=a;if(!s||!r)throw new Error("Camera not found");const l=this.getReferencedImageId(i,e,s,r),d=i.getFrameOfReferenceUID(),c={highlighted:!0,invalidated:!0,metadata:{toolName:this.getToolName(),viewPlaneNormal:[...s],viewUp:[...r],FrameOfReferenceUID:d,referencedImageId:l},data:{label:"",handles:{points:[[...e]],activeHandleIndex:null,textBox:{hasMoved:!1,worldPosition:[0,0,0],worldBoundingBox:{topLeft:[0,0,0],topRight:[0,0,0],bottomLeft:[0,0,0],bottomRight:[0,0,0]}}}}};if(sp(this.getToolName(),t).length>0)return null;if(null===rp(c,t))return;const h=Cl(t,this.getToolName(),!1);cs(o,h)},this.onCameraModified=e=>{const t=e.detail,{element:n,previousCamera:i,camera:o}=t,a=(0,ne.getEnabledElement)(n).viewport;if(n!==this._elementWithCursor)return;const s=i.focalPoint,r=o.viewPlaneNormal,l=o.focalPoint,d=[0,0,0];if(Gr.ZP.subtract(l,s,d),0===d.reduce(((e,t)=>e+t),0))return;const c=Gr.ZP.dot(d,r);if(Math.abs(c)<.01)return;if(!this._currentCanvasPosition)return;const h=a.canvasToWorld(this._currentCanvasPosition);this._currentCursorWorldPosition=h,this.updateAnnotationPosition(n,this.getActiveAnnotation(n))},this.renderAnnotation=(e,t)=>{let n=!1;const{viewport:i,FrameOfReferenceUID:o}=e,a=this._elementWithCursor===i.element;this.configuration.positionSync&&!a&&this.updateViewportImage(i);const{element:s}=i;let r=sp(this.getToolName(),s);if(!r?.length)return n;if(r=this.filterInteractableAnnotationsForElement(s,r),!r?.length)return n;const l={toolGroupId:this.toolGroupId,toolName:this.getToolName(),viewportId:e.viewport.id};for(let e=0;e<r.length;e++){const o=r[e],{annotationUID:s,data:d}=o,{handles:c}=d,{points:h}=c;if(!s)return n;l.annotationUID=s;const g=parseFloat(this.getStyle("lineWidth",l,o)),u=g,m=this.getStyle("lineDash",l,o),v=this.getStyle("color",l,o);if(h[0].some((e=>isNaN(e))))return n;const p=h.map((e=>i.worldToCanvas(e)));if(!i.getRenderingEngine())return console.warn("Rendering Engine has been destroyed"),n;if(!He(s))continue;const f={upper:"upper",right:"right",lower:"lower",left:"left"},[E,w]=p[0],I=a?20:7,C=a?5:7;Ko(t,s,f.upper,[E,w-(I/2+C)],[E,w-I/2],{color:v,lineDash:m,lineWidth:u}),Ko(t,s,f.lower,[E,w+(I/2+C)],[E,w+I/2],{color:v,lineDash:m,lineWidth:u}),Ko(t,s,f.right,[E+(I/2+C),w],[E+I/2,w],{color:v,lineDash:m,lineWidth:u}),Ko(t,s,f.left,[E-(I/2+C),w],[E-I/2,w],{color:v,lineDash:m,lineWidth:u}),n=!0}return n},this._disableCursorEnabled=this.configuration.disableCursor}onSetToolActive(){if(this._disableCursorEnabled=this.configuration.disableCursor,!this._disableCursorEnabled)return;const e=Jv(this.toolGroupId).viewportsInfo;if(!e)return;e.map((e=>(0,ne.getEnabledElementByIds)(e.viewportId,e.renderingEngineId))).forEach((e=>{e&&Rr(e.viewport.element)}))}onSetToolDisabled(){if(!this._disableCursorEnabled)return;const e=Jv(this.toolGroupId).viewportsInfo;if(!e)return;e.map((e=>(0,ne.getEnabledElementByIds)(e.viewportId,e.renderingEngineId))).forEach((e=>{e&&xr(e.viewport.element)}))}getActiveAnnotation(e){const t=sp(this.getToolName(),e);if(!t.length)return null;return t[0]}updateAnnotationPosition(e,t){const n=this._currentCursorWorldPosition;if(!n)return;if(!t.data?.handles?.points)return;t.data.handles.points=[[...n]],t.invalidated=!0;const i=Cl(e,this.getToolName(),!1),o=(0,ne.getEnabledElement)(e);if(!o)return;const{renderingEngine:a}=o;cs(a,i)}filterInteractableAnnotationsForElement(e,t){if(!(t instanceof Array)||0===t.length)return[];const n=t[0],i=(0,ne.getEnabledElement)(e)?.viewport;if(!i)return[];const o=i.getCamera(),{viewPlaneNormal:a,focalPoint:s}=o;if(!a||!s)return[];const r=n.data?.handles?.points;if(!(r instanceof Array)||1!==r.length)return[];const l=r[0],d=ne.utilities.planar.planeEquation(a,s);return ne.utilities.planar.planeDistanceToPoint(d,l)<this.configuration.displayThreshold?[n]:[]}updateViewportImage(e){const t=this._currentCursorWorldPosition;if(t&&!t.some((e=>isNaN(e))))if(e instanceof ne.StackViewport){const n=ne.utilities.getClosestStackImageIndexForPoint(t,e);if(null===n)return;n!==e.getCurrentImageIdIndex()&&e.setImageIdIndex(n)}else if(e instanceof ne.VolumeViewport){const{focalPoint:n,viewPlaneNormal:i}=e.getCamera();if(!n||!i)return;const o=ne.utilities.planar.planeEquation(i,n),a=ne.utilities.planar.planeDistanceToPoint(o,t,!0);if(Math.abs(a)<.5)return;const s=Oo.R3.normalize(Oo.R3.create(),Oo.R3.fromValues(...i)),r=Oo.R3.scale(Oo.R3.create(),s,a),l=Oo.R3.add(Oo.R3.create(),Oo.R3.fromValues(...n),r);if(!0){e.setCamera({focalPoint:l});const t=e.getRenderingEngine();t&&t.renderViewport(e.id)}}}}Nd.toolName="ReferenceCursors";const Ld=Nd,Ad=[];class kd extends wa{constructor(e={},t={configuration:{viewportId:"",scaleLocation:"bottom"}}){super(e,t),this.editData={},this._init=()=>{const e=(0,ne.getRenderingEngines)()[0];if(!e)return;const t=Jv(this.toolGroupId).viewportsInfo;if(!t)return;const n=t.map((e=>(0,ne.getEnabledElementByIds)(e.viewportId,e.renderingEngineId)));let{viewport:i}=n[0];const{FrameOfReferenceUID:o}=n[0];if(this.configuration.viewportId&&n.forEach((e=>{e.viewport.id==this.configuration.viewportId&&(i=e.viewport)})),!i)return;const{viewUp:a,viewPlaneNormal:s}=i.getCamera(),r=ne.utilities.getViewportImageCornersInWorld(i);let l=this.editData.annotation;const d=sp(this.getToolName(),i.element);if(d.length&&(l=d.filter((e=>e.data.viewportId==i.id))[0]),Ad.includes(i.id))this.editData.annotation.data.viewportId==i.id&&(this.editData.annotation.data.handles.points=r,this.editData.annotation.data.viewportId=i.id);else{const e={metadata:{toolName:this.getToolName(),viewPlaneNormal:[...s],viewUp:[...a],FrameOfReferenceUID:o,referencedImageId:null},data:{handles:{points:r},viewportId:i.id}};Ad.push(i.id),rp(e,i.element),l=e}this.editData={viewport:i,renderingEngine:e,annotation:l}},this.onSetToolEnabled=()=>{this._init()},this.onCameraModified=e=>{this.configuration.viewportId=e.detail.viewportId,this._init()},this.computeScaleSize=(e,t,n)=>{const i=[16e3,8e3,4e3,2e3,1e3,500,250,100,50,25,10,5,2];let o;return o="top"==n||"bottom"==n?i.filter((t=>t<.6*e&&t>.2*e)):i.filter((e=>e<.6*t&&e>.2*t)),o[0]},this.computeEndScaleTicks=(e,t)=>{const n={bottom:[[0,-10],[0,-10]],top:[[0,10],[0,10]],left:[[0,0],[10,0]],right:[[0,0],[-10,0]]};return{endTick1:[[e[1][0]+n[t][0][0],e[1][1]+n[t][0][0]],[e[1][0]+n[t][1][0],e[1][1]+n[t][1][1]]],endTick2:[[e[0][0]+n[t][0][0],e[0][1]+n[t][0][0]],[e[0][0]+n[t][1][0],e[0][1]+n[t][1][1]]]}},this.computeInnerScaleTicks=(e,t,n,i,o)=>{let a;"bottom"==t||"top"==t?a=o[0][0]-i[0][0]:"left"!=t&&"right"!=t||(a=o[0][1]-i[0][1]);const s=[],r=[],l=[];let d=e;e>=50&&(d=e/10);const c=a/d;for(let e=0;e<d-1;e++){const o={bottom:[[c*(e+1),0],[c*(e+1),5]],top:[[c*(e+1),0],[c*(e+1),-5]],left:[[0,c*(e+1)],[-5,c*(e+1)]],right:[[0,c*(e+1)],[5,c*(e+1)]]};s.push(`${n}-tick${e}`),r.push(`tick${e}`),(e+1)%5==0?l.push([[i[0][0]+o[t][0][0],i[0][1]+o[t][0][1]],[i[1][0]+o[t][0][0],i[1][1]+o[t][0][1]]]):l.push([[i[0][0]+o[t][0][0],i[0][1]+o[t][0][1]],[i[1][0]+o[t][1][0],i[1][1]+o[t][1][1]]])}return{tickIds:s,tickUIDs:r,tickCoordinates:l}},this.computeWorldScaleCoordinates=(e,t,n)=>{let i,o=Oo.R3.subtract(Oo.R3.create(),n[0],n[1]);o=Oo.R3.normalize(Oo.R3.create(),o);let a=Oo.R3.subtract(Oo.R3.create(),n[2],n[0]);a=Oo.R3.normalize(Oo.R3.create(),a);const s={bottom:[n[1],n[2]],top:[n[0],n[3]],right:[n[2],n[3]],left:[n[0],n[1]]},r=Oo.R3.add(Oo.R3.create(),s[t][0],s[t][0]).map((e=>e/2)),l=e/2/Math.sqrt(Math.pow(o[0],2)+Math.pow(o[1],2)+Math.pow(o[2],2));return"top"==t||"bottom"==t?i=[Oo.R3.subtract(Oo.R3.create(),r,a.map((e=>e*l))),Oo.R3.add(Oo.R3.create(),r,a.map((e=>e*l)))]:"left"!=t&&"right"!=t||(i=[Oo.R3.add(Oo.R3.create(),r,o.map((e=>e*l))),Oo.R3.subtract(Oo.R3.create(),r,o.map((e=>e*l)))]),i},this.computeCanvasScaleCoordinates=(e,t,n,i,o)=>{let a;if("top"==o||"bottom"==o){const i=t[0][0]-t[1][0];a=[[e.width/2-i/2,n.height],[e.width/2+i/2,n.height]]}else if("left"==o||"right"==o){const n=t[0][1]-t[1][1];a=[[i.width,e.height/2-n/2],[i.width,e.height/2+n/2]]}return a},this.computeScaleBounds=(e,t,n,i)=>{const o=t*Math.min(1e3,e.width),a=n*Math.min(1e3,e.height),s={bottom:[-a,-o],top:[a,o],left:[a,o],right:[-a,-o]},r={bottom:[e.height,e.width],top:[0,e.width],left:[e.height,0],right:[e.height,e.width]};return{height:r[i][0]+s[i][0],width:r[i][1]+s[i][1]}}}renderAnnotation(e,t){if(!this.editData.viewport)return;const n=this.configuration.scaleLocation,{viewport:i}=e,o=sp(this.getToolName(),i.element).filter((e=>e.data.viewportId==i.id))[0],a=e.viewport.canvas;if(!i)return false;const s={toolGroupId:this.toolGroupId,toolName:this.getToolName(),viewportId:e.viewport.id},r={width:a.width,height:a.height},l=o.data.handles.points[0],d=o.data.handles.points[1],c=o.data.handles.points[2],h=o.data.handles.points[3],g=[l,c,d,h],u=Oo.R3.distance(c,h),m=Oo.R3.distance(l,c),v=this.computeScaleBounds(r,.05,.05,n),p=this.computeScaleBounds(r,.05,.05,n),f=this.computeScaleSize(u,m,n),E=this.computeWorldScaleCoordinates(f,n,g).map((e=>i.worldToCanvas(e))),w=this.computeCanvasScaleCoordinates(r,E,p,v,n),I=this.computeEndScaleTicks(w,n),{annotationUID:C}=o;s.annotationUID=C;const _=this.getStyle("lineWidth",s,o),T=this.getStyle("lineDash",s,o),b=this.getStyle("color",s,o),D=this.getStyle("shadow",s,o),S=`${C}-scaleline`;Ko(t,C,"1",w[0],w[1],{color:b,width:_,lineDash:T,shadow:D},S);const M=`${C}-left`;Ko(t,C,"2",I.endTick1[0],I.endTick1[1],{color:b,width:_,lineDash:T,shadow:D},M);const y=`${C}-right`;Ko(t,C,"3",I.endTick2[0],I.endTick2[1],{color:b,width:_,lineDash:T,shadow:D},y);const O={bottom:[-10,-42],top:[-12,-35],left:[-40,-20],right:[-50,-20]},x=[w[0][0]+O[n][0],w[0][1]+O[n][1]],R=this._getTextLines(f),{tickIds:P,tickUIDs:N,tickCoordinates:L}=this.computeInnerScaleTicks(f,n,C,I.endTick1,I.endTick2);for(let e=0;e<N.length;e++)Ko(t,C,N[e],L[e][0],L[e][1],{color:b,width:_,lineDash:T,shadow:D},P[e]);return Yo(t,C,"text0",R,[x[0],x[1]],{fontFamily:"Helvetica Neue, Helvetica, Arial, sans-serif",fontSize:"14px",lineDash:"2,3",lineWidth:"1",shadow:!0,color:b}),false}_getTextLines(e){let t,n;e>=50?(t=e/10,n=" cm"):(t=e,n=" mm");return[t.toString().concat(n)]}}kd.toolName="ScaleOverlay";const Ud=kd;function Vd(e){const t=function(e){const t=[e[0],e[1]].sort(s),n=[e[0],e[1]].sort(r),i=t[t.length-1],o=n[0],a=n[n.length-1];return{top:o,bottom:a,right:i};function s(e,t){return e[0]<t[0]?-1:1}function r(e,t){return e[1]<t[1]?-1:1}}(e),n=(t.top[1]+t.bottom[1])/2;return[t.right[0],n]}const{transformWorldToIndex:Wd}=ne.utilities;class Hd extends Ca{constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"],configuration:{preventHandleOutsideImage:!1,getTextLines:Bd}}){super(e,t),this.isPointNearTool=(e,t,n,i)=>{const o=(0,ne.getEnabledElement)(e),{viewport:a}=o,{data:s}=t,{points:r}=s.handles;let l=a.worldToCanvas(r[0]),d=a.worldToCanvas(r[1]),c={start:{x:l[0],y:l[1]},end:{x:d[0],y:d[1]}},h=Jl([c.start.x,c.start.y],[c.end.x,c.end.y],[n[0],n[1]]);return h<=i||(l=a.worldToCanvas(r[2]),d=a.worldToCanvas(r[3]),c={start:{x:l[0],y:l[1]},end:{x:d[0],y:d[1]}},h=Jl([c.start.x,c.start.y],[c.end.x,c.end.y],[n[0],n[1]]),h<=i)},this.toolSelectedCallback=(e,t)=>{const n=e.detail,{element:i}=n;t.highlighted=!0;const o=Cl(i,this.getToolName());this.editData={annotation:t,viewportIdsToRender:o,movingTextBox:!1},this._activateModify(i);const a=(0,ne.getEnabledElement)(i),{renderingEngine:s}=a;cs(s,o),Rr(i),e.preventDefault()},this.handleSelectedCallback=(e,t,n)=>{const i=e.detail,{element:o}=i,a=t.data;t.highlighted=!0;let s,r=!1;n.worldPosition?r=!0:s=a.handles.points.findIndex((e=>e===n));const l=Cl(o,this.getToolName());Rr(o),this.editData={annotation:t,viewportIdsToRender:l,handleIndex:s,movingTextBox:r},this._activateModify(o);const d=(0,ne.getEnabledElement)(o),{renderingEngine:c}=d;cs(c,l),e.preventDefault()},this._endCallback=e=>{const t=e.detail,{element:n}=t,{annotation:i,viewportIdsToRender:o,newAnnotation:a,hasMoved:s}=this.editData,{data:r}=i;if(a&&!s)return;r.handles.activeHandleIndex=null,this._deactivateModify(n),this._deactivateDraw(n),xr(n);const l=(0,ne.getEnabledElement)(n),{renderingEngine:d}=l;if(void 0!==this.editData.handleIndex){const{points:e}=r.handles,t=Oo.R3.distance(e[0],e[1]);if(Oo.R3.distance(e[2],e[3])>t){const t=[[...e[2]],[...e[3]]],n=[...e[0]],i=[...e[1]],o=Oo.K4.create();Oo.K4.set(o,t[1][0]-t[0][0],t[1][1]-t[1][0]);const a=Oo.K4.create();Oo.K4.set(a,-o[1],o[0]);const s=Oo.K4.create();let l;Oo.K4.set(s,i[0]-n[0],i[1]-n[0]),l=Oo.K4.dot(s,a)>0?[n,i]:[i,n],r.handles.points=[t[0],t[1],l[0],l[1]]}}if(this.isHandleOutsideImage&&this.configuration.preventHandleOutsideImage&&dp(i.annotationUID),cs(d,o),a){const e=re.ANNOTATION_COMPLETED,t={annotation:i};(0,ne.triggerEvent)(ne.eventTarget,e,t)}this.editData=null,this.isDrawing=!1},this._dragDrawCallback=e=>{this.isDrawing=!0;const t=e.detail,{currentPoints:n,element:i}=t,o=(0,ne.getEnabledElement)(i),{renderingEngine:a,viewport:s}=o,{worldToCanvas:r}=s,{annotation:l,viewportIdsToRender:d,handleIndex:c}=this.editData,{data:h}=l,g=n.world;h.handles.points[c]=[...g];const u=h.handles.points.map(r),m={start:{x:u[0][0],y:u[0][1]},end:{x:u[1][0],y:u[1][1]}},v=(u[2][0],u[2][1],u[3][0],u[3][1],Oo.K4.distance(u[0],u[1])/3),p=m.start.x-m.end.x,f=m.start.y-m.end.y,E=Math.sqrt(p*p+f*f),w=p/E,I=f/E,C=(m.start.x+m.end.x)/2,_=(m.start.y+m.end.y)/2,T=C+v*I,b=_-v*w,D=C-v*I,S=_+v*w;h.handles.points[2]=s.canvasToWorld([T,b]),h.handles.points[3]=s.canvasToWorld([D,S]),l.invalidated=!0,cs(a,d),this.editData.hasMoved=!0},this._dragModifyCallback=e=>{this.isDrawing=!0;const t=e.detail,{element:n}=t,i=(0,ne.getEnabledElement)(n),{renderingEngine:o}=i,{annotation:a,viewportIdsToRender:s,handleIndex:r,movingTextBox:l}=this.editData,{data:d}=a;if(l){const{deltaPoints:e}=t,n=e.world,{textBox:i}=d.handles,{worldPosition:o}=i;o[0]+=n[0],o[1]+=n[1],o[2]+=n[2],i.hasMoved=!0}else if(void 0===r){const{deltaPoints:e}=t,n=e.world;d.handles.points.forEach((e=>{e[0]+=n[0],e[1]+=n[1],e[2]+=n[2]})),a.invalidated=!0}else this._dragModifyHandle(e),a.invalidated=!0;cs(o,s)},this._dragModifyHandle=e=>{const t=e.detail,{currentPoints:n,element:i}=t,o=(0,ne.getEnabledElement)(i),{viewport:a}=o,{annotation:s,handleIndex:r}=this.editData,{data:l}=s,d=n.world,c=[a.worldToCanvas(l.handles.points[0]),a.worldToCanvas(l.handles.points[1]),a.worldToCanvas(l.handles.points[2]),a.worldToCanvas(l.handles.points[3])],h={start:{x:c[0][0],y:c[0][1]},end:{x:c[1][0],y:c[1][1]}},g={start:{x:c[2][0],y:c[2][1]},end:{x:c[3][0],y:c[3][1]}},u=[...d],m=a.worldToCanvas(u);if(0===r||1===r){const e=c[0===r?1:0],t=Oo.K4.set(Oo.K4.create(),m[0]-e[0],m[1]-e[1]),n=Oo.K4.set(Oo.K4.create(),c[r][0]-e[0],c[r][1]-e[1]);Oo.K4.normalize(t,t),Oo.K4.normalize(n,n);const i={start:{x:e[0],y:e[1]},end:{x:m[0],y:m[1]}};if(this._movingLongAxisWouldPutItThroughShortAxis(i,g))return;const o=e,s=this._getSignedAngle(n,t);let d=c[2][0],h=c[2][1],v=c[3][0],p=c[3][1];d-=o[0],h-=o[1],v-=o[0],p-=o[1];const f=d*Math.cos(s)-h*Math.sin(s),E=d*Math.sin(s)+h*Math.cos(s),w=v*Math.cos(s)-p*Math.sin(s),I=v*Math.sin(s)+p*Math.cos(s);d=f+o[0],h=E+o[1],v=w+o[0],p=I+o[1];const C=a.canvasToWorld([d,h]),_=a.canvasToWorld([v,p]);l.handles.points[r]=u,l.handles.points[2]=C,l.handles.points[3]=_}else{const e=2===r?3:2,t={longLineSegment:{start:h.start,end:h.end},shortLineSegment:{start:g.start,end:g.end}},n=Oo.K4.subtract(Oo.K4.create(),[t.longLineSegment.end.x,t.longLineSegment.end.y],[t.longLineSegment.start.x,t.longLineSegment.start.y]),i=Oo.K4.normalize(Oo.K4.create(),n),o=Oo.K4.subtract(Oo.K4.create(),[m[0],m[1]],[c[r][0],c[r][1]]),s=Oo.K4.length(o),d=this._getSignedAngle(i,o),v=Math.cos(d)*s,p=Oo.K4.scaleAndAdd(Oo.K4.create(),[c[e][0],c[e][1]],i,v);if(this._movingLongAxisWouldPutItThroughShortAxis({start:{x:m[0],y:m[1]},end:{x:p[0],y:p[1]}},{start:{x:t.longLineSegment.start.x,y:t.longLineSegment.start.y},end:{x:t.longLineSegment.end.x,y:t.longLineSegment.end.y}}))return;if(!ed([m[0],m[1]],[p[0],p[1]],[h.start.x,h.start.y],[h.end.x,h.end.y]))return;l.handles.points[e]=a.canvasToWorld(p),l.handles.points[r]=u}},this.cancel=e=>{if(this.isDrawing){this.isDrawing=!1,this._deactivateDraw(e),this._deactivateModify(e),xr(e);const{annotation:t,viewportIdsToRender:n,newAnnotation:i}=this.editData,{data:o}=t;t.highlighted=!1,o.handles.activeHandleIndex=null;const a=(0,ne.getEnabledElement)(e),{renderingEngine:s}=a;if(cs(s,n),i){const e=re.ANNOTATION_COMPLETED,n={annotation:t};(0,ne.triggerEvent)(ne.eventTarget,e,n)}return this.editData=null,t.annotationUID}},this._activateDraw=e=>{Je.isInteractingWithTool=!0,e.addEventListener(re.MOUSE_UP,this._endCallback),e.addEventListener(re.MOUSE_DRAG,this._dragDrawCallback),e.addEventListener(re.MOUSE_MOVE,this._dragDrawCallback),e.addEventListener(re.MOUSE_CLICK,this._endCallback),e.addEventListener(re.TOUCH_TAP,this._endCallback),e.addEventListener(re.TOUCH_END,this._endCallback),e.addEventListener(re.TOUCH_DRAG,this._dragDrawCallback)},this._deactivateDraw=e=>{Je.isInteractingWithTool=!1,e.removeEventListener(re.MOUSE_UP,this._endCallback),e.removeEventListener(re.MOUSE_DRAG,this._dragDrawCallback),e.removeEventListener(re.MOUSE_MOVE,this._dragDrawCallback),e.removeEventListener(re.MOUSE_CLICK,this._endCallback),e.removeEventListener(re.TOUCH_TAP,this._endCallback),e.removeEventListener(re.TOUCH_END,this._endCallback),e.removeEventListener(re.TOUCH_DRAG,this._dragDrawCallback)},this._activateModify=e=>{Je.isInteractingWithTool=!0,e.addEventListener(re.MOUSE_UP,this._endCallback),e.addEventListener(re.MOUSE_DRAG,this._dragModifyCallback),e.addEventListener(re.MOUSE_CLICK,this._endCallback),e.addEventListener(re.TOUCH_END,this._endCallback),e.addEventListener(re.TOUCH_DRAG,this._dragModifyCallback),e.addEventListener(re.TOUCH_TAP,this._endCallback)},this._deactivateModify=e=>{Je.isInteractingWithTool=!1,e.removeEventListener(re.MOUSE_UP,this._endCallback),e.removeEventListener(re.MOUSE_DRAG,this._dragModifyCallback),e.removeEventListener(re.MOUSE_CLICK,this._endCallback),e.removeEventListener(re.TOUCH_END,this._endCallback),e.removeEventListener(re.TOUCH_DRAG,this._dragModifyCallback),e.removeEventListener(re.TOUCH_TAP,this._endCallback)},this.renderAnnotation=(e,t)=>{let n=!0;const{viewport:i}=e,{element:o}=i;let a=sp(this.getToolName(),o);if(!a?.length)return n;if(a=this.filterInteractableAnnotationsForElement(o,a),!a?.length)return n;const s=this.getTargetId(i),r=i.getRenderingEngine(),l={toolGroupId:this.toolGroupId,toolName:this.getToolName(),viewportId:e.viewport.id};for(let o=0;o<a.length;o++){const d=a[o],{annotationUID:c,data:h}=d,{points:g,activeHandleIndex:u}=h.handles,m=g.map((e=>i.worldToCanvas(e)));l.annotationUID=c;const v=this.getStyle("lineWidth",l,d),p=this.getStyle("lineDash",l,d),f=this.getStyle("color",l,d),E=this.getStyle("shadow",l,d);if(h.cachedStats[s]&&null!=h.cachedStats[s].unit?d.invalidated&&this._throttledCalculateCachedStats(d,r,e):(h.cachedStats[s]={length:null,width:null,unit:null},this._calculateCachedStats(d,r,e)),!i.getRenderingEngine())return console.warn("Rendering Engine has been destroyed"),n;let w;if(!He(c))continue;if(we(d)||this.editData||null===u||(w=[m[u]]),w){$o(t,c,"0",w,{color:f})}const I=`${c}-line-1`,C=`${c}-line-2`;Ko(t,c,"0",m[0],m[1],{color:f,lineDash:p,lineWidth:v,shadow:E},I);Ko(t,c,"1",m[2],m[3],{color:f,lineDash:p,lineWidth:v,shadow:E},C),n=!0;const _=this.getLinkedTextBoxStyle(l,d);if(!_.visibility){h.handles.textBox={hasMoved:!1,worldPosition:[0,0,0],worldBoundingBox:{topLeft:[0,0,0],topRight:[0,0,0],bottomLeft:[0,0,0],bottomRight:[0,0,0]}};continue}const T=this.configuration.getTextLines(h,s);if(!T||0===T.length)continue;let b;h.handles.textBox.hasMoved||(b=Vd(m),h.handles.textBox.worldPosition=i.canvasToWorld(b));const D=i.worldToCanvas(h.handles.textBox.worldPosition),S=Jo(t,c,"1",T,D,m,{},_),{x:M,y,width:O,height:x}=S;h.handles.textBox.worldBoundingBox={topLeft:i.canvasToWorld([M,y]),topRight:i.canvasToWorld([M+O,y]),bottomLeft:i.canvasToWorld([M,y+x]),bottomRight:i.canvasToWorld([M+O,y+x])}}return n},this._movingLongAxisWouldPutItThroughShortAxis=(e,t)=>{const n=Oo.K4.create();Oo.K4.set(n,t.end.x-t.start.x,t.end.y-t.start.y),Oo.K4.normalize(n,n);const i={start:{x:t.start.x-10*n[0],y:t.start.y-10*n[1]},end:{x:t.end.x+10*n[0],y:t.end.y+10*n[1]}};return!ed([i.start.x,i.start.y],[i.end.x,i.end.y],[e.start.x,e.start.y],[e.end.x,e.end.y])},this._calculateCachedStats=(e,t,n)=>{const{data:i}=e,{viewportId:o,renderingEngineId:a}=n,s=i.handles.points[0],r=i.handles.points[1],l=i.handles.points[2],d=i.handles.points[3],{cachedStats:c}=i,h=Object.keys(c);for(let e=0;e<h.length;e++){const n=h[e],i=this.getTargetIdImage(n,t);if(!i)continue;const{imageData:o,dimensions:a}=i,g=ss(i),u=this._calculateLength(s,r)/g,m=this._calculateLength(l,d)/g,v=u>m?u:m,p=u>m?m:u,f=Wd(o,s),E=Wd(o,r),w=Wd(o,l),I=Wd(o,d);this._isInsideVolume(f,E,w,I,a)?this.isHandleOutsideImage=!1:this.isHandleOutsideImage=!0,c[n]={length:v,width:p,unit:is(null,i)}}e.invalidated=!1;const g=re.ANNOTATION_MODIFIED,u={annotation:e,viewportId:o,renderingEngineId:a};return(0,ne.triggerEvent)(ne.eventTarget,g,u),c},this._isInsideVolume=(e,t,n,i,o)=>ne.utilities.indexWithinDimensions(e,o)&&ne.utilities.indexWithinDimensions(t,o)&&ne.utilities.indexWithinDimensions(n,o)&&ne.utilities.indexWithinDimensions(i,o),this._getSignedAngle=(e,t)=>Math.atan2(e[0]*t[1]-e[1]*t[0],e[0]*t[0]+e[1]*t[1]),this._throttledCalculateCachedStats=qa(this._calculateCachedStats,100,{trailing:!0})}addNewAnnotation(e){const t=e.detail,{currentPoints:n,element:i}=t,o=n.world,a=(0,ne.getEnabledElement)(i),{viewport:s,renderingEngine:r}=a;this.isDrawing=!0;const l=s.getCamera(),{viewPlaneNormal:d,viewUp:c}=l,h=this.getReferencedImageId(s,o,d,c),g=s.getFrameOfReferenceUID(),u={highlighted:!0,invalidated:!0,metadata:{toolName:this.getToolName(),viewPlaneNormal:[...d],viewUp:[...c],FrameOfReferenceUID:g,referencedImageId:h},data:{handles:{points:[[...o],[...o],[...o],[...o]],textBox:{hasMoved:!1,worldPosition:[0,0,0],worldBoundingBox:{topLeft:[0,0,0],topRight:[0,0,0],bottomLeft:[0,0,0],bottomRight:[0,0,0]}},activeHandleIndex:null},label:"",cachedStats:{}}};rp(u,i);const m=Cl(i,this.getToolName());return this.editData={annotation:u,viewportIdsToRender:m,handleIndex:1,movingTextBox:!1,newAnnotation:!0,hasMoved:!1},this._activateDraw(i),Rr(i),e.preventDefault(),cs(r,m),u}_calculateLength(e,t){const n=e[0]-t[0],i=e[1]-t[1],o=e[2]-t[2];return Math.sqrt(n*n+i*i+o*o)}}function Bd(e,t){const{cachedStats:n}=e,{length:i,width:o,unit:a}=n[t];if(void 0===i)return;return[`L: ${ws(i)} ${a}`,`W: ${ws(o)} ${a}`]}Hd.toolName="Bidirectional";const Fd=Hd,{transformWorldToIndex:Gd}=ne.utilities;class $d extends Ca{constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"],configuration:{preventHandleOutsideImage:!1,getTextLines:Kd}}){super(e,t),this.addNewAnnotation=e=>{const t=e.detail,{currentPoints:n,element:i}=t,o=n.world,a=(0,ne.getEnabledElement)(i),{viewport:s,renderingEngine:r}=a;Rr(i),this.isDrawing=!0;const l=s.getCamera(),{viewPlaneNormal:d,viewUp:c}=l,h=this.getReferencedImageId(s,o,d,c),g=s.getFrameOfReferenceUID(),u={highlighted:!0,invalidated:!0,metadata:{toolName:this.getToolName(),viewPlaneNormal:[...d],viewUp:[...c],FrameOfReferenceUID:g,referencedImageId:h},data:{handles:{points:[[...o],[...o]],activeHandleIndex:null,textBox:{hasMoved:!1,worldPosition:[0,0,0],worldBoundingBox:{topLeft:[0,0,0],topRight:[0,0,0],bottomLeft:[0,0,0],bottomRight:[0,0,0]}}},label:"",cachedStats:{}}};rp(u,i);const m=Cl(i,this.getToolName());return this.editData={annotation:u,viewportIdsToRender:m,handleIndex:1,movingTextBox:!1,newAnnotation:!0,hasMoved:!1},this._activateDraw(i),e.preventDefault(),cs(r,m),u},this.isPointNearTool=(e,t,n,i)=>{const o=(0,ne.getEnabledElement)(e),{viewport:a}=o,{data:s}=t,[r,l]=s.handles.points,d=a.worldToCanvas(r),c=a.worldToCanvas(l),h={start:{x:d[0],y:d[1]},end:{x:c[0],y:c[1]}};return Jl([h.start.x,h.start.y],[h.end.x,h.end.y],[n[0],n[1]])<=i},this.toolSelectedCallback=(e,t)=>{const n=e.detail,{element:i}=n;t.highlighted=!0;const o=Cl(i,this.getToolName());this.editData={annotation:t,viewportIdsToRender:o,movingTextBox:!1},this._activateModify(i),Rr(i);const a=(0,ne.getEnabledElement)(i),{renderingEngine:s}=a;cs(s,o),e.preventDefault()},this._endCallback=e=>{const t=e.detail,{element:n}=t,{annotation:i,viewportIdsToRender:o,newAnnotation:a,hasMoved:s}=this.editData,{data:r}=i;if(a&&!s)return;r.handles.activeHandleIndex=null,this._deactivateModify(n),this._deactivateDraw(n),xr(n);const l=(0,ne.getEnabledElement)(n),{renderingEngine:d}=l;if(this.isHandleOutsideImage&&this.configuration.preventHandleOutsideImage&&dp(i.annotationUID),cs(d,o),a){const e=re.ANNOTATION_COMPLETED,t={annotation:i};(0,ne.triggerEvent)(ne.eventTarget,e,t)}this.editData=null,this.isDrawing=!1},this._dragCallback=e=>{this.isDrawing=!0;const t=e.detail,{element:n}=t,{annotation:i,viewportIdsToRender:o,handleIndex:a,movingTextBox:s}=this.editData,{data:r}=i;if(s){const{deltaPoints:e}=t,n=e.world,{textBox:i}=r.handles,{worldPosition:o}=i;o[0]+=n[0],o[1]+=n[1],o[2]+=n[2],i.hasMoved=!0}else if(void 0===a){const{deltaPoints:e}=t,n=e.world;r.handles.points.forEach((e=>{e[0]+=n[0],e[1]+=n[1],e[2]+=n[2]})),i.invalidated=!0}else{const{currentPoints:e}=t,n=e.world;r.handles.points[a]=[...n],i.invalidated=!0}this.editData.hasMoved=!0;const l=(0,ne.getEnabledElement)(n),{renderingEngine:d}=l;cs(d,o)},this.cancel=e=>{if(this.isDrawing){this.isDrawing=!1,this._deactivateDraw(e),this._deactivateModify(e),xr(e);const{annotation:t,viewportIdsToRender:n,newAnnotation:i}=this.editData,{data:o}=t;t.highlighted=!1,o.handles.activeHandleIndex=null;const a=(0,ne.getEnabledElement)(e),{renderingEngine:s}=a;if(cs(s,n),i){const e=re.ANNOTATION_COMPLETED,n={annotation:t};(0,ne.triggerEvent)(ne.eventTarget,e,n)}return this.editData=null,t.annotationUID}},this._activateModify=e=>{Je.isInteractingWithTool=!0,e.addEventListener(re.MOUSE_UP,this._endCallback),e.addEventListener(re.MOUSE_DRAG,this._dragCallback),e.addEventListener(re.MOUSE_CLICK,this._endCallback),e.addEventListener(re.TOUCH_END,this._endCallback),e.addEventListener(re.TOUCH_DRAG,this._dragCallback),e.addEventListener(re.TOUCH_TAP,this._endCallback)},this._deactivateModify=e=>{Je.isInteractingWithTool=!1,e.removeEventListener(re.MOUSE_UP,this._endCallback),e.removeEventListener(re.MOUSE_DRAG,this._dragCallback),e.removeEventListener(re.MOUSE_CLICK,this._endCallback),e.removeEventListener(re.TOUCH_END,this._endCallback),e.removeEventListener(re.TOUCH_DRAG,this._dragCallback),e.removeEventListener(re.TOUCH_TAP,this._endCallback)},this._activateDraw=e=>{Je.isInteractingWithTool=!0,e.addEventListener(re.MOUSE_UP,this._endCallback),e.addEventListener(re.MOUSE_DRAG,this._dragCallback),e.addEventListener(re.MOUSE_MOVE,this._dragCallback),e.addEventListener(re.MOUSE_CLICK,this._endCallback),e.addEventListener(re.TOUCH_END,this._endCallback),e.addEventListener(re.TOUCH_DRAG,this._dragCallback),e.addEventListener(re.TOUCH_TAP,this._endCallback)},this._deactivateDraw=e=>{Je.isInteractingWithTool=!1,e.removeEventListener(re.MOUSE_UP,this._endCallback),e.removeEventListener(re.MOUSE_DRAG,this._dragCallback),e.removeEventListener(re.MOUSE_MOVE,this._dragCallback),e.removeEventListener(re.MOUSE_CLICK,this._endCallback),e.removeEventListener(re.TOUCH_END,this._endCallback),e.removeEventListener(re.TOUCH_DRAG,this._dragCallback),e.removeEventListener(re.TOUCH_TAP,this._endCallback)},this.renderAnnotation=(e,t)=>{let n=!1;const{viewport:i}=e,{element:o}=i;let a=sp(this.getToolName(),o);if(!a?.length)return n;if(a=this.filterInteractableAnnotationsForElement(o,a),!a?.length)return n;const s=this.getTargetId(i),r=i.getRenderingEngine(),l={toolGroupId:this.toolGroupId,toolName:this.getToolName(),viewportId:e.viewport.id};for(let o=0;o<a.length;o++){const d=a[o],{annotationUID:c,data:h}=d,{points:g,activeHandleIndex:u}=h.handles;l.annotationUID=c;const m=this.getStyle("lineWidth",l,d),v=this.getStyle("lineDash",l,d),p=this.getStyle("color",l,d),f=this.getStyle("shadow",l,d),E=g.map((e=>i.worldToCanvas(e)));let w;if(h.cachedStats[s]&&null!=h.cachedStats[s].unit?d.invalidated&&this._throttledCalculateCachedStats(d,r,e):(h.cachedStats[s]={length:null,unit:null},this._calculateCachedStats(d,r,e)),!He(c))continue;if(we(d)||this.editData||null===u||(w=[E[u]]),w){$o(t,c,"0",E,{color:p,lineDash:v,lineWidth:m})}const I=`${c}-line`;if(Ko(t,c,"1",E[0],E[1],{color:p,width:m,lineDash:v,shadow:f},I),n=!0,!i.getRenderingEngine())return console.warn("Rendering Engine has been destroyed"),n;const C=this.getLinkedTextBoxStyle(l,d);if(!C.visibility){h.handles.textBox={hasMoved:!1,worldPosition:[0,0,0],worldBoundingBox:{topLeft:[0,0,0],topRight:[0,0,0],bottomLeft:[0,0,0],bottomRight:[0,0,0]}};continue}const _=this.configuration.getTextLines(h,s);if(!h.handles.textBox.hasMoved){const e=Vd(E);h.handles.textBox.worldPosition=i.canvasToWorld(e)}const T=i.worldToCanvas(h.handles.textBox.worldPosition),b=Jo(t,c,"1",_,T,E,{},C),{x:D,y:S,width:M,height:y}=b;h.handles.textBox.worldBoundingBox={topLeft:i.canvasToWorld([D,S]),topRight:i.canvasToWorld([D+M,S]),bottomLeft:i.canvasToWorld([D,S+y]),bottomRight:i.canvasToWorld([D+M,S+y])}}return n},this._throttledCalculateCachedStats=qa(this._calculateCachedStats,100,{trailing:!0})}handleSelectedCallback(e,t,n){const i=e.detail,{element:o}=i,{data:a}=t;t.highlighted=!0;let s,r=!1;n.worldPosition?r=!0:s=a.handles.points.findIndex((e=>e===n));const l=Cl(o,this.getToolName());this.editData={annotation:t,viewportIdsToRender:l,handleIndex:s,movingTextBox:r},this._activateModify(o),Rr(o);const d=(0,ne.getEnabledElement)(o),{renderingEngine:c}=d;cs(c,l),e.preventDefault()}_calculateLength(e,t){const n=e[0]-t[0],i=e[1]-t[1],o=e[2]-t[2];return Math.sqrt(n*n+i*i+o*o)}_calculateCachedStats(e,t,n){const i=e.data,{viewportId:o,renderingEngineId:a}=n,s=i.handles.points[0],r=i.handles.points[1],{cachedStats:l}=i,d=Object.keys(l);for(let e=0;e<d.length;e++){const n=d[e],i=this.getTargetIdImage(n,t);if(!i)continue;const{imageData:o,dimensions:a}=i,c=Gd(o,s),h=Gd(o,r),g=[c,h],{scale:u,units:m}=rs(i,g),v=this._calculateLength(s,r)/u;this._isInsideVolume(c,h,a)?this.isHandleOutsideImage=!1:this.isHandleOutsideImage=!0,l[n]={length:v,unit:m}}e.invalidated=!1;const c=re.ANNOTATION_MODIFIED,h={annotation:e,viewportId:o,renderingEngineId:a};return(0,ne.triggerEvent)(ne.eventTarget,c,h),l}_isInsideVolume(e,t,n){return ne.utilities.indexWithinDimensions(e,n)&&ne.utilities.indexWithinDimensions(t,n)}}function Kd(e,t){const n=e.cachedStats[t],{length:i,unit:o}=n;if(null==i||isNaN(i))return;return[`${ws(i)} ${o}`]}$d.toolName="Length";const qd=$d;function zd(e,t,n){return"CT"===e?"HU":"PT"===e?function(e,t){if(!t.isPreScaled)return"raw";if(t.isSuvScaled)return"SUV";const n=ne.metaData.get("generalSeriesModule",e);if("PT"===n?.modality){const t=ne.metaData.get("petSeriesModule",e);return t?.units||"unitless"}}(t,n):""}function jd(e,t){if(e instanceof ne.BaseVolumeViewport){const e=t.split("volumeId:"),n=e.length>1?e[1]:e[0],i=ne.cache.getVolume(n);return!!i?.scaling&&Object.keys(i.scaling).length>0}if(e instanceof ne.StackViewport){const{preScale:t}=e.getImageData()||{};return!!t?.scaled}return!1}const{transformWorldToIndex:Yd}=ne.utilities;class Zd extends Ca{constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"],configuration:{shadow:!0,preventHandleOutsideImage:!1,getTextLines:Xd}}){super(e,t),this.addNewAnnotation=e=>{const t=e.detail,{currentPoints:n,element:i}=t,o=n.world,a=(0,ne.getEnabledElement)(i),{viewport:s,renderingEngine:r}=a;this.isDrawing=!0;const l=s.getCamera(),{viewPlaneNormal:d,viewUp:c}=l,h=this.getReferencedImageId(s,o,d,c),g=s.getFrameOfReferenceUID(),u={invalidated:!0,highlighted:!0,metadata:{toolName:this.getToolName(),viewPlaneNormal:[...d],viewUp:[...c],FrameOfReferenceUID:g,referencedImageId:h},data:{label:"",handles:{points:[[...o]]},cachedStats:{}}};rp(u,i);const m=Cl(i,this.getToolName());return this.editData={annotation:u,newAnnotation:!0,viewportIdsToRender:m},this._activateModify(i),Rr(i),e.preventDefault(),cs(r,m),u},this._endCallback=e=>{const t=e.detail,{element:n}=t,{annotation:i,viewportIdsToRender:o,newAnnotation:a}=this.editData,s=(0,ne.getEnabledElement)(n),{renderingEngine:r}=s,{viewportId:l}=s;if(this.eventDispatchDetail={viewportId:l,renderingEngineId:r.id},this._deactivateModify(n),xr(n),this.editData=null,this.isDrawing=!1,this.isHandleOutsideImage&&this.configuration.preventHandleOutsideImage&&dp(i.annotationUID),cs(r,o),a){const e=re.ANNOTATION_COMPLETED,t={annotation:i};(0,ne.triggerEvent)(ne.eventTarget,e,t)}},this._dragCallback=e=>{this.isDrawing=!0;const t=e.detail,{currentPoints:n,element:i}=t,o=n.world,{annotation:a,viewportIdsToRender:s}=this.editData,{data:r}=a;r.handles.points[0]=[...o],a.invalidated=!0;const l=(0,ne.getEnabledElement)(i),{renderingEngine:d}=l;cs(d,s)},this.cancel=e=>{if(this.isDrawing){this.isDrawing=!1,this._deactivateModify(e),xr(e);const{annotation:t,viewportIdsToRender:n,newAnnotation:i}=this.editData,{data:o}=t;t.highlighted=!1,o.handles.activeHandleIndex=null;const a=(0,ne.getEnabledElement)(e),{renderingEngine:s}=a;if(cs(s,n),i){const e=re.ANNOTATION_COMPLETED,n={annotation:t};(0,ne.triggerEvent)(ne.eventTarget,e,n)}return this.editData=null,t.annotationUID}},this._activateModify=e=>{Je.isInteractingWithTool=!0,e.addEventListener(re.MOUSE_UP,this._endCallback),e.addEventListener(re.MOUSE_DRAG,this._dragCallback),e.addEventListener(re.MOUSE_CLICK,this._endCallback),e.addEventListener(re.TOUCH_END,this._endCallback),e.addEventListener(re.TOUCH_DRAG,this._dragCallback),e.addEventListener(re.TOUCH_TAP,this._endCallback)},this._deactivateModify=e=>{Je.isInteractingWithTool=!1,e.removeEventListener(re.MOUSE_UP,this._endCallback),e.removeEventListener(re.MOUSE_DRAG,this._dragCallback),e.removeEventListener(re.MOUSE_CLICK,this._endCallback),e.removeEventListener(re.TOUCH_END,this._endCallback),e.removeEventListener(re.TOUCH_DRAG,this._dragCallback),e.removeEventListener(re.TOUCH_TAP,this._endCallback)},this.renderAnnotation=(e,t)=>{let n=!1;const{viewport:i}=e,{element:o}=i;let a=sp(this.getToolName(),o);if(!a?.length)return n;if(a=this.filterInteractableAnnotationsForElement(o,a),!a?.length)return n;const s=this.getTargetId(i),r=i.getRenderingEngine(),l={toolGroupId:this.toolGroupId,toolName:this.getToolName(),viewportId:e.viewport.id};for(let o=0;o<a.length;o++){const d=a[o],c=d.annotationUID,h=d.data,g=h.handles.points[0],u=i.worldToCanvas(g);l.annotationUID=c;const m=this.getStyle("color",l,d);if(h.cachedStats[s]&&null!=h.cachedStats[s].value){if(d.invalidated&&(this._calculateCachedStats(d,r,e),i instanceof ne.VolumeViewport)){const{referencedImageId:e}=d.metadata;for(const t in h.cachedStats)if(t.startsWith("imageId")){r.getStackViewports().find((t=>{const n=ne.utilities.imageIdToURI(e),i=t.hasImageURI(n),o=ne.utilities.imageIdToURI(t.getCurrentImageId());return i&&o!==n}))&&delete h.cachedStats[t]}}}else h.cachedStats[s]={Modality:null,index:null,value:null},this._calculateCachedStats(d,r,e);if(!i.getRenderingEngine())return console.warn("Rendering Engine has been destroyed"),n;$o(t,c,"0",[u],{color:m}),n=!0;const v=this.getLinkedTextBoxStyle(l,d);if(!v.visibility)continue;const p=this.configuration.getTextLines(h,s);if(p){const e=[u[0]+6,u[1]-6];Yo(t,c,"0",p,[e[0],e[1]],v)}}return n}}isPointNearTool(){return!1}toolSelectedCallback(){}getHandleNearImagePoint(e,t,n,i){const o=(0,ne.getEnabledElement)(e),{viewport:a}=o,{data:s}=t,r=s.handles.points[0],l=a.worldToCanvas(r);if(!0===Oo.K4.distance(n,l)<i)return r}handleSelectedCallback(e,t){const n=e.detail,{element:i}=n;t.highlighted=!0;const o=Cl(i,this.getToolName());this.editData={annotation:t,viewportIdsToRender:o},this._activateModify(i),Rr(i);const a=(0,ne.getEnabledElement)(i),{renderingEngine:s}=a;cs(s,o),e.preventDefault()}_calculateCachedStats(e,t,n){const i=e.data,{viewportId:o,renderingEngineId:a,viewport:s}=n,r=i.handles.points[0],{cachedStats:l}=i,d=Object.keys(l);for(let n=0;n<d.length;n++){const i=d[n],c={isPreScaled:jd(s,i),isSuvScaled:this.isSuvScaled(s,i,e.metadata.referencedImageId)},h=this.getTargetIdImage(i,t);if(!h)continue;const{dimensions:g,imageData:u,metadata:m}=h,v="getScalarData"in h?h.getScalarData():h.scalarData,p=m.Modality,f=Yd(u,r);f[0]=Math.round(f[0]),f[1]=Math.round(f[1]),f[2]=Math.round(f[2]);const E=v.length/g[2]/g[1]/g[0];if(ne.utilities.indexWithinDimensions(f,g)){this.isHandleOutsideImage=!1;const t=g[0]*E,n=g[0]*g[1]*E,o=f[2]*n+f[1]*t+f[0]*E;let s,r=E>2?[v[o],v[o+1],v[o+2]]:v[o];if(i.startsWith("imageId:")){const e=i.split("imageId:")[1],t=ne.utilities.imageIdToURI(e),n=ne.utilities.getViewportsWithImageURI(t,a)[0];f[2]=n.getCurrentImageIdIndex()}if("US"===p){const e=ls(h,[f]),t=e.values.every((e=>null!==e));r=t?e.values:r,s=t?e.units:"raw"}else s=zd(p,e.metadata.referencedImageId,c);l[i]={index:f,value:r,Modality:p,modalityUnit:s}}else this.isHandleOutsideImage=!0,l[i]={index:f,Modality:p};e.invalidated=!1;const w=re.ANNOTATION_MODIFIED,I={annotation:e,viewportId:o,renderingEngineId:a};(0,ne.triggerEvent)(ne.eventTarget,w,I)}return l}}function Xd(e,t){const n=e.cachedStats[t],{index:i,value:o,modalityUnit:a}=n;if(void 0===o)return;const s=[];if(s.push(`(${i[0]}, ${i[1]}, ${i[2]})`),o instanceof Array&&a instanceof Array)for(let e=0;e<o.length;e++)s.push(`${ws(o[e])} ${a[e]}`);else s.push(`${ws(o)} ${a}`);return s}Zd.toolName="Probe";const Jd=Zd;class Qd extends Jd{constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"],configuration:{shadow:!0,preventHandleOutsideImage:!1,getTextLines:ec}}){super(e,t),this.postMouseDownCallback=e=>{const t=e.detail,{currentPoints:n,element:i}=t,o=n.world,a=(0,ne.getEnabledElement)(i),{viewport:s,renderingEngine:r}=a;this.isDrawing=!0;const l=s.getCamera(),{viewPlaneNormal:d,viewUp:c}=l,h=this.getReferencedImageId(s,o,d,c),g={invalidated:!0,highlighted:!0,isVisible:!0,metadata:{toolName:this.getToolName(),viewPlaneNormal:[...d],viewUp:[...c],FrameOfReferenceUID:s.getFrameOfReferenceUID(),referencedImageId:h},data:{label:"",handles:{points:[[...o]]},cachedStats:{}}},u=Cl(i,this.getToolName());return this.editData={annotation:g,newAnnotation:!0,viewportIdsToRender:u},this._activateModify(i),Rr(i),e.preventDefault(),cs(r,u),g},this.postTouchStartCallback=e=>this.postMouseDownCallback(e),this.renderAnnotation=(e,t)=>{let n=!1;const{viewport:i}=e;if(!this.editData)return n;const o=this.filterInteractableAnnotationsForElement(i.element,[this.editData.annotation]);if(!o?.length)return n;const a=this.getTargetId(i),s=i.getRenderingEngine(),r={toolGroupId:this.toolGroupId,toolName:this.getToolName(),viewportId:e.viewport.id},l=this.editData.annotation,d=l.annotationUID,c=l.data,h=c.handles.points[0],g=i.worldToCanvas(h);r.annotationUID=d;const u=this.getStyle("color",r,l);jd(i,a),this.isSuvScaled(i,a,l.metadata.referencedImageId);if(c.cachedStats[a]&&null!=c.cachedStats[a].value?l.invalidated&&this._calculateCachedStats(l,s,e):(c.cachedStats[a]={Modality:null,index:null,value:null},this._calculateCachedStats(l,s,e)),!i.getRenderingEngine())return console.warn("Rendering Engine has been destroyed"),n;$o(t,d,"0",[g],{color:u}),n=!0;const m=this.configuration.getTextLines(c,a);if(m){const e=[g[0]+6,g[1]-6];Yo(t,d,"0",m,[e[0],e[1]],this.getLinkedTextBoxStyle(r,l))}return n}}}function ec(e,t){const n=e.cachedStats[t],{index:i,value:o,modalityUnit:a}=n;if(void 0===o)return;const s=[];return s.push(`(${i[0]}, ${i[1]}, ${i[2]})`),s.push(`${o.toFixed(2)} ${a}`),s}Qd.toolName="DragProbe";const tc=Qd,{transformWorldToIndex:nc}=ne.utilities;class ic extends Ca{constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"],configuration:{shadow:!0,preventHandleOutsideImage:!1,getTextLines:oc,statsCalculator:Rl}}){super(e,t),this.addNewAnnotation=e=>{const t=e.detail,{currentPoints:n,element:i}=t,o=n.world,a=(0,ne.getEnabledElement)(i),{viewport:s,renderingEngine:r}=a;this.isDrawing=!0;const l=s.getCamera(),{viewPlaneNormal:d,viewUp:c}=l,h=this.getReferencedImageId(s,o,d,c),g=s.getFrameOfReferenceUID(),u={invalidated:!0,highlighted:!0,metadata:{toolName:this.getToolName(),viewPlaneNormal:[...d],viewUp:[...c],FrameOfReferenceUID:g,referencedImageId:h},data:{label:"",handles:{points:[[...o],[...o],[...o],[...o]],textBox:{hasMoved:!1,worldPosition:[0,0,0],worldBoundingBox:{topLeft:[0,0,0],topRight:[0,0,0],bottomLeft:[0,0,0],bottomRight:[0,0,0]}},activeHandleIndex:null},cachedStats:{}}};rp(u,i);const m=Cl(i,this.getToolName());return this.editData={annotation:u,viewportIdsToRender:m,handleIndex:3,movingTextBox:!1,newAnnotation:!0,hasMoved:!1},this._activateDraw(i),Rr(i),e.preventDefault(),cs(r,m),u},this.isPointNearTool=(e,t,n,i)=>{const o=(0,ne.getEnabledElement)(e),{viewport:a}=o,{data:s}=t,{points:r}=s.handles,l=a.worldToCanvas(r[0]),d=a.worldToCanvas(r[3]),c=this._getRectangleImageCoordinates([l,d]),h=[n[0],n[1]],{left:g,top:u,width:m,height:v}=c;return Yl([g,u,m,v],h)<=i},this.toolSelectedCallback=(e,t)=>{const n=e.detail,{element:i}=n;t.highlighted=!0;const o=Cl(i,this.getToolName());this.editData={annotation:t,viewportIdsToRender:o,movingTextBox:!1},this._activateModify(i),Rr(i);const a=(0,ne.getEnabledElement)(i),{renderingEngine:s}=a;cs(s,o),e.preventDefault()},this.handleSelectedCallback=(e,t,n)=>{const i=e.detail,{element:o}=i,{data:a}=t;t.highlighted=!0;let s,r=!1;n.worldPosition?r=!0:s=a.handles.points.findIndex((e=>e===n));const l=Cl(o,this.getToolName());this.editData={annotation:t,viewportIdsToRender:l,handleIndex:s,movingTextBox:r},this._activateModify(o),Rr(o);const d=(0,ne.getEnabledElement)(o),{renderingEngine:c}=d;cs(c,l),e.preventDefault()},this._endCallback=e=>{const t=e.detail,{element:n}=t,{annotation:i,viewportIdsToRender:o,newAnnotation:a,hasMoved:s}=this.editData,{data:r}=i;if(a&&!s)return;r.handles.activeHandleIndex=null,this._deactivateModify(n),this._deactivateDraw(n),xr(n);const l=(0,ne.getEnabledElement)(n),{renderingEngine:d}=l;if(this.editData=null,this.isDrawing=!1,this.isHandleOutsideImage&&this.configuration.preventHandleOutsideImage&&dp(i.annotationUID),cs(d,o),a){const e=re.ANNOTATION_COMPLETED,t={annotation:i};(0,ne.triggerEvent)(ne.eventTarget,e,t)}},this._dragCallback=e=>{this.isDrawing=!0;const t=e.detail,{element:n}=t,{annotation:i,viewportIdsToRender:o,handleIndex:a,movingTextBox:s}=this.editData,{data:r}=i;if(s){const{deltaPoints:e}=t,n=e.world,{textBox:i}=r.handles,{worldPosition:o}=i;o[0]+=n[0],o[1]+=n[1],o[2]+=n[2],i.hasMoved=!0}else if(void 0===a){const{deltaPoints:e}=t,n=e.world,{points:o}=r.handles;o.forEach((e=>{e[0]+=n[0],e[1]+=n[1],e[2]+=n[2]})),i.invalidated=!0}else{const{currentPoints:e}=t,o=(0,ne.getEnabledElement)(n),{worldToCanvas:s,canvasToWorld:l}=o.viewport,d=e.world,{points:c}=r.handles;let h,g,u,m,v,p,f,E;switch(c[a]=[...d],a){case 0:case 3:h=s(c[0]),m=s(c[3]),g=[m[0],h[1]],u=[h[0],m[1]],p=l(g),f=l(u),c[1]=p,c[2]=f;break;case 1:case 2:g=s(c[1]),u=s(c[2]),h=[u[0],g[1]],m=[g[0],u[1]],v=l(h),E=l(m),c[0]=v,c[3]=E}i.invalidated=!0}this.editData.hasMoved=!0;const l=(0,ne.getEnabledElement)(n),{renderingEngine:d}=l;cs(d,o)},this.cancel=e=>{if(this.isDrawing){this.isDrawing=!1,this._deactivateDraw(e),this._deactivateModify(e),xr(e);const{annotation:t,viewportIdsToRender:n,newAnnotation:i}=this.editData,{data:o}=t;t.highlighted=!1,o.handles.activeHandleIndex=null;const a=(0,ne.getEnabledElement)(e),{renderingEngine:s}=a;if(cs(s,n),i){const e=re.ANNOTATION_COMPLETED,n={annotation:t};(0,ne.triggerEvent)(ne.eventTarget,e,n)}return this.editData=null,t.annotationUID}},this._activateDraw=e=>{Je.isInteractingWithTool=!0,e.addEventListener(re.MOUSE_UP,this._endCallback),e.addEventListener(re.MOUSE_DRAG,this._dragCallback),e.addEventListener(re.MOUSE_MOVE,this._dragCallback),e.addEventListener(re.MOUSE_CLICK,this._endCallback),e.addEventListener(re.TOUCH_END,this._endCallback),e.addEventListener(re.TOUCH_DRAG,this._dragCallback),e.addEventListener(re.TOUCH_TAP,this._endCallback)},this._deactivateDraw=e=>{Je.isInteractingWithTool=!1,e.removeEventListener(re.MOUSE_UP,this._endCallback),e.removeEventListener(re.MOUSE_DRAG,this._dragCallback),e.removeEventListener(re.MOUSE_MOVE,this._dragCallback),e.removeEventListener(re.MOUSE_CLICK,this._endCallback),e.removeEventListener(re.TOUCH_END,this._endCallback),e.removeEventListener(re.TOUCH_DRAG,this._dragCallback),e.removeEventListener(re.TOUCH_TAP,this._endCallback)},this._activateModify=e=>{Je.isInteractingWithTool=!0,e.addEventListener(re.MOUSE_UP,this._endCallback),e.addEventListener(re.MOUSE_DRAG,this._dragCallback),e.addEventListener(re.MOUSE_CLICK,this._endCallback),e.addEventListener(re.TOUCH_END,this._endCallback),e.addEventListener(re.TOUCH_DRAG,this._dragCallback),e.addEventListener(re.TOUCH_TAP,this._endCallback)},this._deactivateModify=e=>{Je.isInteractingWithTool=!1,e.removeEventListener(re.MOUSE_UP,this._endCallback),e.removeEventListener(re.MOUSE_DRAG,this._dragCallback),e.removeEventListener(re.MOUSE_CLICK,this._endCallback),e.removeEventListener(re.TOUCH_END,this._endCallback),e.removeEventListener(re.TOUCH_DRAG,this._dragCallback),e.removeEventListener(re.TOUCH_TAP,this._endCallback)},this.renderAnnotation=(e,t)=>{let n=!1;const{viewport:i}=e,{element:o}=i;let a=sp(this.getToolName(),o);if(!a?.length)return n;if(a=this.filterInteractableAnnotationsForElement(o,a),!a?.length)return n;const s=this.getTargetId(i),r=i.getRenderingEngine(),l={toolGroupId:this.toolGroupId,toolName:this.getToolName(),viewportId:e.viewport.id};for(let o=0;o<a.length;o++){const d=a[o],{annotationUID:c,data:h}=d,{points:g,activeHandleIndex:u}=h.handles,m=g.map((e=>i.worldToCanvas(e)));l.annotationUID=c;const v=this.getStyle("lineWidth",l,d),p=this.getStyle("lineDash",l,d),f=this.getStyle("color",l,d),{viewPlaneNormal:E,viewUp:w}=i.getCamera();if(h.cachedStats[s]&&null!=h.cachedStats[s].areaUnit){if(d.invalidated&&(this._throttledCalculateCachedStats(d,E,w,r,e),i instanceof ne.VolumeViewport)){const{referencedImageId:e}=d.metadata;for(const t in h.cachedStats)if(t.startsWith("imageId")){r.getStackViewports().find((t=>{const n=ne.utilities.imageIdToURI(e),i=t.hasImageURI(n),o=ne.utilities.imageIdToURI(t.getCurrentImageId());return i&&o!==n}))&&delete h.cachedStats[t]}}}else h.cachedStats[s]={Modality:null,area:null,max:null,mean:null,stdDev:null,areaUnit:null},this._calculateCachedStats(d,E,w,r,e);if(!i.getRenderingEngine())return console.warn("Rendering Engine has been destroyed"),n;let I;if(!He(c))continue;if(we(d)||this.editData||null===u||(I=[m[u]]),I){$o(t,c,"0",I,{color:f})}const C=`${c}-rect`;Qo(t,c,"0",m[0],m[3],{color:f,lineDash:p,lineWidth:v},C),n=!0;const _=this.getLinkedTextBoxStyle(l,d);if(!_.visibility){h.handles.textBox={hasMoved:!1,worldPosition:[0,0,0],worldBoundingBox:{topLeft:[0,0,0],topRight:[0,0,0],bottomLeft:[0,0,0],bottomRight:[0,0,0]}};continue}const T=this.configuration.getTextLines(h,s);if(!T||0===T.length)continue;if(!h.handles.textBox.hasMoved){const e=Vd(m);h.handles.textBox.worldPosition=i.canvasToWorld(e)}const b=i.worldToCanvas(h.handles.textBox.worldPosition),D=Jo(t,c,"1",T,b,m,{},_),{x:S,y:M,width:y,height:O}=D;h.handles.textBox.worldBoundingBox={topLeft:i.canvasToWorld([S,M]),topRight:i.canvasToWorld([S+y,M]),bottomLeft:i.canvasToWorld([S,M+O]),bottomRight:i.canvasToWorld([S+y,M+O])}}return n},this._getRectangleImageCoordinates=e=>{const[t,n]=e;return{left:Math.min(t[0],n[0]),top:Math.min(t[1],n[1]),width:Math.abs(t[0]-n[0]),height:Math.abs(t[1]-n[1])}},this._calculateCachedStats=(e,t,n,i,o)=>{const{data:a}=e,{viewportId:s,renderingEngineId:r,viewport:l}=o,d=a.handles.points[0],c=a.handles.points[3],{cachedStats:h}=a,g=Object.keys(h);for(let o=0;o<g.length;o++){const a=g[o],s=this.getTargetIdImage(a,i);if(!s)continue;const{dimensions:r,imageData:u,metadata:m}=s,v=("getScalarData"in s?s.getScalarData():s.scalarData,nc(u,d));v[0]=Math.floor(v[0]),v[1]=Math.floor(v[1]),v[2]=Math.floor(v[2]);const p=nc(u,c);if(p[0]=Math.floor(p[0]),p[1]=Math.floor(p[1]),p[2]=Math.floor(p[2]),this._isInsideVolume(v,p,r)){this.isHandleOutsideImage=!1;const i=[[Math.min(v[0],p[0]),Math.max(v[0],p[0])],[Math.min(v[1],p[1]),Math.max(v[1],p[1])],[Math.min(v[2],p[2]),Math.max(v[2],p[2])]],{worldWidth:o,worldHeight:r}=sl(t,n,d,c),g=ss(s),f=Math.abs(o*r)/(g*g),E={isPreScaled:jd(l,a),isSuvScaled:this.isSuvScaled(l,a,e.metadata.referencedImageId)},w=zd(m.Modality,e.metadata.referencedImageId,E),I=us(u,(()=>!0),this.configuration.statsCalculator.statsCallback,i),C=this.configuration.statsCalculator.getStatistics();h[a]={Modality:m.Modality,area:f,mean:C[1]?.value,stdDev:C[2]?.value,max:C[0]?.value,statsArray:C,pointsInShape:I,areaUnit:as(null,s),modalityUnit:w}}else this.isHandleOutsideImage=!0,h[a]={Modality:m.Modality}}e.invalidated=!1;const u=re.ANNOTATION_MODIFIED,m={annotation:e,viewportId:s,renderingEngineId:r};return(0,ne.triggerEvent)(ne.eventTarget,u,m),h},this._isInsideVolume=(e,t,n)=>ne.utilities.indexWithinDimensions(e,n)&&ne.utilities.indexWithinDimensions(t,n),this._throttledCalculateCachedStats=qa(this._calculateCachedStats,100,{trailing:!0})}}function oc(e,t){const n=e.cachedStats[t],{area:i,mean:o,max:a,stdDev:s,areaUnit:r,modalityUnit:l}=n;if(void 0===o)return;const d=[];return d.push(`Area: ${ws(i)} ${r}`),d.push(`Mean: ${ws(o)} ${l}`),d.push(`Max: ${ws(a)} ${l}`),d.push(`Std Dev: ${ws(s)} ${l}`),d}ic.toolName="RectangleROI";const ac=ic;function sc(e,t,n,i){const o=Oo.R3.create();Oo.R3.cross(o,t,e);const a=Oo.R3.fromValues(...n),s=Oo.R3.fromValues(...i),r=Oo.R3.create();Oo.R3.subtract(r,a,s);const l=Oo.R3.length(r);if(l<1e-4)return{worldWidth:0,worldHeight:0};const d=Oo.R3.dot(r,o)/(l*Oo.R3.length(o));return{worldWidth:Math.sqrt(1-d*d)*l,worldHeight:d*l}}const{transformWorldToIndex:rc}=ne.utilities;class lc extends Ca{constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"],configuration:{shadow:!0,preventHandleOutsideImage:!1,centerPointRadius:0,getTextLines:dc,statsCalculator:Rl}}){super(e,t),this.isHandleOutsideImage=!1,this.addNewAnnotation=e=>{const t=e.detail,{currentPoints:n,element:i}=t,o=n.world,a=(n.canvas,(0,ne.getEnabledElement)(i)),{viewport:s,renderingEngine:r}=a;this.isDrawing=!0;const l=s.getCamera(),{viewPlaneNormal:d,viewUp:c}=l,h=this.getReferencedImageId(s,o,d,c),g=s.getFrameOfReferenceUID(),u={highlighted:!0,invalidated:!0,metadata:{toolName:this.getToolName(),viewPlaneNormal:[...d],viewUp:[...c],FrameOfReferenceUID:g,referencedImageId:h},data:{label:"",handles:{textBox:{hasMoved:!1,worldPosition:[0,0,0],worldBoundingBox:{topLeft:[0,0,0],topRight:[0,0,0],bottomLeft:[0,0,0],bottomRight:[0,0,0]}},points:[[...o],[...o],[...o],[...o]],activeHandleIndex:null},cachedStats:{},initialRotation:s.getRotation()}};rp(u,i);const m=Cl(i,this.getToolName());return this.editData={annotation:u,viewportIdsToRender:m,centerWorld:o,newAnnotation:!0,hasMoved:!1},this._activateDraw(i),Rr(i),e.preventDefault(),cs(r,m),u},this.isPointNearTool=(e,t,n,i)=>{const o=(0,ne.getEnabledElement)(e),{viewport:a}=o,{data:s}=t,{points:r}=s.handles,l=_s(r.map((e=>a.worldToCanvas(e)))),[d,c]=l,h={left:Math.min(d[0],c[0])+i/2,top:Math.min(d[1],c[1])+i/2,width:Math.abs(d[0]-c[0])-i,height:Math.abs(d[1]-c[1])-i},g={left:Math.min(d[0],c[0])-i/2,top:Math.min(d[1],c[1])-i/2,width:Math.abs(d[0]-c[0])+i,height:Math.abs(d[1]-c[1])+i},u=this._pointInEllipseCanvas(h,n);return!(!this._pointInEllipseCanvas(g,n)||u)},this.toolSelectedCallback=(e,t)=>{const n=e.detail,{element:i}=n;t.highlighted=!0;const o=Cl(i,this.getToolName());this.editData={annotation:t,viewportIdsToRender:o,movingTextBox:!1},Rr(i),this._activateModify(i);const a=(0,ne.getEnabledElement)(i),{renderingEngine:s}=a;cs(s,o),e.preventDefault()},this.handleSelectedCallback=(e,t,n)=>{const i=e.detail,{element:o}=i,{data:a}=t;t.highlighted=!0;let s,r,l,d,c,h,g=!1;if(n.worldPosition)g=!0;else{const{points:e}=a.handles,{viewport:t}=(0,ne.getEnabledElement)(o),{worldToCanvas:i,canvasToWorld:g}=t;s=e.findIndex((e=>e===n));const u=e.map(i);h=u[s],d=Math.abs(u[2][0]-u[3][0]),c=Math.abs(u[0][1]-u[1][1]),r=[(u[2][0]+u[3][0])/2,(u[0][1]+u[1][1])/2],l=g(r)}const u=Cl(o,this.getToolName());this.editData={annotation:t,viewportIdsToRender:u,handleIndex:s,canvasWidth:d,canvasHeight:c,centerWorld:l,originalHandleCanvas:h,movingTextBox:g},this._activateModify(o),Rr(o);const m=(0,ne.getEnabledElement)(o),{renderingEngine:v}=m;cs(v,u),e.preventDefault()},this._endCallback=e=>{const t=e.detail,{element:n}=t,{annotation:i,viewportIdsToRender:o,newAnnotation:a,hasMoved:s}=this.editData,{data:r}=i;if(a&&!s)return;i.highlighted=!1,r.handles.activeHandleIndex=null,this._deactivateModify(n),this._deactivateDraw(n),xr(n);const l=(0,ne.getEnabledElement)(n),{renderingEngine:d}=l;if(this.editData=null,this.isDrawing=!1,this.isHandleOutsideImage&&this.configuration.preventHandleOutsideImage&&dp(i.annotationUID),cs(d,o),a){const e=re.ANNOTATION_COMPLETED,t={annotation:i};(0,ne.triggerEvent)(ne.eventTarget,e,t)}},this._dragDrawCallback=e=>{this.isDrawing=!0;const t=e.detail,{element:n}=t,{currentPoints:i}=t,o=i.canvas,a=(0,ne.getEnabledElement)(n),{renderingEngine:s,viewport:r}=a,{canvasToWorld:l}=r,{annotation:d,viewportIdsToRender:c,centerWorld:h}=this.editData,g=r.worldToCanvas(h),{data:u}=d,m=Math.abs(o[0]-g[0]),v=Math.abs(o[1]-g[1]),p=[g[0],g[1]-v],f=[g[0],g[1]+v],E=[g[0]-m,g[1]],w=[g[0]+m,g[1]];u.handles.points=[l(p),l(f),l(E),l(w)],d.invalidated=!0,this.editData.hasMoved=!0,cs(s,c)},this._dragModifyCallback=e=>{this.isDrawing=!0;const t=e.detail,{element:n}=t,{annotation:i,viewportIdsToRender:o,handleIndex:a,movingTextBox:s}=this.editData,{data:r}=i;if(s){const{deltaPoints:e}=t,n=e.world,{textBox:i}=r.handles,{worldPosition:o}=i;o[0]+=n[0],o[1]+=n[1],o[2]+=n[2],i.hasMoved=!0}else if(void 0===a){const{deltaPoints:e}=t,n=e.world;r.handles.points.forEach((e=>{e[0]+=n[0],e[1]+=n[1],e[2]+=n[2]})),i.invalidated=!0}else this._dragHandle(e),i.invalidated=!0;const l=(0,ne.getEnabledElement)(n),{renderingEngine:d}=l;cs(d,o)},this._dragHandle=e=>{const t=e.detail,{element:n}=t,{viewport:i}=(0,ne.getEnabledElement)(n),{canvasToWorld:o,worldToCanvas:a}=i,{annotation:s,canvasWidth:r,canvasHeight:l,handleIndex:d,centerWorld:c,originalHandleCanvas:h}=this.editData,g=i.worldToCanvas(c),{data:u}=s,{points:m}=u.handles,{currentPoints:v}=t,p=v.canvas;if(0===d||1===d){const e=Math.abs(p[1]-g[1]),t=[g[0],g[1]-e],n=[g[0],g[1]+e];m[0]=o(t),m[1]=o(n);const i=r/2+(p[0]-h[0]),a=[g[0]-i,g[1]],s=[g[0]+i,g[1]];m[2]=o(a),m[3]=o(s)}else{const e=Math.abs(p[0]-g[0]),t=[g[0]-e,g[1]],n=[g[0]+e,g[1]];m[2]=o(t),m[3]=o(n);const i=l/2+(p[1]-h[1]),a=[g[0],g[1]-i],s=[g[0],g[1]+i];m[0]=o(a),m[1]=o(s)}},this.cancel=e=>{if(this.isDrawing){this.isDrawing=!1,this._deactivateDraw(e),this._deactivateModify(e),xr(e);const{annotation:t,viewportIdsToRender:n,newAnnotation:i}=this.editData,{data:o}=t;t.highlighted=!1,o.handles.activeHandleIndex=null;const a=(0,ne.getEnabledElement)(e),{renderingEngine:s}=a;if(cs(s,n),i){const e=re.ANNOTATION_COMPLETED,n={annotation:t};(0,ne.triggerEvent)(ne.eventTarget,e,n)}return this.editData=null,t.annotationUID}},this._activateModify=e=>{Je.isInteractingWithTool=!0,e.addEventListener(re.MOUSE_UP,this._endCallback),e.addEventListener(re.MOUSE_DRAG,this._dragModifyCallback),e.addEventListener(re.MOUSE_CLICK,this._endCallback),e.addEventListener(re.TOUCH_END,this._endCallback),e.addEventListener(re.TOUCH_DRAG,this._dragModifyCallback),e.addEventListener(re.TOUCH_TAP,this._endCallback)},this._deactivateModify=e=>{Je.isInteractingWithTool=!1,e.removeEventListener(re.MOUSE_UP,this._endCallback),e.removeEventListener(re.MOUSE_DRAG,this._dragModifyCallback),e.removeEventListener(re.MOUSE_CLICK,this._endCallback),e.removeEventListener(re.TOUCH_END,this._endCallback),e.removeEventListener(re.TOUCH_DRAG,this._dragModifyCallback),e.removeEventListener(re.TOUCH_TAP,this._endCallback)},this._activateDraw=e=>{Je.isInteractingWithTool=!0,e.addEventListener(re.MOUSE_UP,this._endCallback),e.addEventListener(re.MOUSE_DRAG,this._dragDrawCallback),e.addEventListener(re.MOUSE_MOVE,this._dragDrawCallback),e.addEventListener(re.MOUSE_CLICK,this._endCallback),e.addEventListener(re.TOUCH_END,this._endCallback),e.addEventListener(re.TOUCH_DRAG,this._dragDrawCallback),e.addEventListener(re.TOUCH_TAP,this._endCallback)},this._deactivateDraw=e=>{Je.isInteractingWithTool=!1,e.removeEventListener(re.MOUSE_UP,this._endCallback),e.removeEventListener(re.MOUSE_DRAG,this._dragDrawCallback),e.removeEventListener(re.MOUSE_MOVE,this._dragDrawCallback),e.removeEventListener(re.MOUSE_CLICK,this._endCallback),e.removeEventListener(re.TOUCH_END,this._endCallback),e.removeEventListener(re.TOUCH_DRAG,this._dragDrawCallback),e.removeEventListener(re.TOUCH_TAP,this._endCallback)},this.renderAnnotation=(e,t)=>{let n=!1;const{viewport:i}=e,{element:o}=i;let a=sp(this.getToolName(),o);if(!a?.length)return n;if(a=this.filterInteractableAnnotationsForElement(o,a),!a?.length)return n;const s=this.getTargetId(i),r=i.getRenderingEngine(),l={toolGroupId:this.toolGroupId,toolName:this.getToolName(),viewportId:e.viewport.id};for(let o=0;o<a.length;o++){const d=a[o],{annotationUID:c,data:h}=d,{handles:g}=h,{points:u,activeHandleIndex:m}=g;l.annotationUID=c;const v=this.getStyle("lineWidth",l,d),p=this.getStyle("lineDash",l,d),f=this.getStyle("color",l,d),E=u.map((e=>i.worldToCanvas(e))),w=(Math.abs(i.getRotation()-(h.initialRotation||0)),_s(E)),{centerPointRadius:I}=this.configuration;if(h.cachedStats[s]&&null!=h.cachedStats[s].areaUnit){if(d.invalidated&&(this._throttledCalculateCachedStats(d,i,r,e),i instanceof ne.VolumeViewport)){const{referencedImageId:e}=d.metadata;for(const t in h.cachedStats)if(t.startsWith("imageId")){r.getStackViewports().find((t=>{const n=ne.utilities.imageIdToURI(e),i=t.hasImageURI(n),o=ne.utilities.imageIdToURI(t.getCurrentImageId());return i&&o!==n}))&&delete h.cachedStats[t]}}}else h.cachedStats[s]={Modality:null,area:null,max:null,mean:null,stdDev:null,areaUnit:null},this._calculateCachedStats(d,i,r,e);if(!i.getRenderingEngine())return console.warn("Rendering Engine has been destroyed"),n;let C;if(!He(c))continue;if(we(d)||this.editData||null===m||(C=[E[m]]),C){$o(t,c,"0",C,{color:f})}const _="0";if(Bo(t,c,_,E,{color:f,lineDash:p,lineWidth:v},`${c}-ellipse`),I>0){if(Math.min(Math.abs(w[0][0]-w[1][0])/2,Math.abs(w[0][1]-w[1][1])/2)>3*I){const e=this._getCanvasEllipseCenter(E);Ho(t,c,`${_}-center`,e,I,{color:f,lineDash:p,lineWidth:v})}}n=!0;const T=this.getLinkedTextBoxStyle(l,d);if(!T.visibility){h.handles.textBox={hasMoved:!1,worldPosition:[0,0,0],worldBoundingBox:{topLeft:[0,0,0],topRight:[0,0,0],bottomLeft:[0,0,0],bottomRight:[0,0,0]}};continue}const b=this.configuration.getTextLines(h,s);if(!b||0===b.length)continue;let D;h.handles.textBox.hasMoved||(D=Vd(w),h.handles.textBox.worldPosition=i.canvasToWorld(D));const S=i.worldToCanvas(h.handles.textBox.worldPosition),M=Jo(t,c,"1",b,S,E,{},T),{x:y,y:O,width:x,height:R}=M;h.handles.textBox.worldBoundingBox={topLeft:i.canvasToWorld([y,O]),topRight:i.canvasToWorld([y+x,O]),bottomLeft:i.canvasToWorld([y,O+R]),bottomRight:i.canvasToWorld([y+x,O+R])}}return n},this._calculateCachedStats=(e,t,n,i)=>{const o=e.data,{viewportId:a,renderingEngineId:s}=i,{points:r}=o.handles,l=r.map((e=>t.worldToCanvas(e))),{viewPlaneNormal:d,viewUp:c}=t.getCamera(),[h,g]=_s(l),u=t.canvasToWorld(h),m=t.canvasToWorld(g),{cachedStats:v}=o,p=Object.keys(v),f=u,E=m;for(let i=0;i<p.length;i++){const o=p[i],a=this.getTargetIdImage(o,n);if(!a)continue;const{dimensions:s,imageData:r,metadata:l,hasPixelSpacing:h}=a,g=rc(r,f);g[0]=Math.floor(g[0]),g[1]=Math.floor(g[1]),g[2]=Math.floor(g[2]);const w=rc(r,E);if(w[0]=Math.floor(w[0]),w[1]=Math.floor(w[1]),w[2]=Math.floor(w[2]),this._isInsideVolume(g,w,s)){const n=[[Math.min(g[0],w[0]),Math.max(g[0],w[0])],[Math.min(g[1],w[1]),Math.max(g[1],w[1])],[Math.min(g[2],w[2]),Math.max(g[2],w[2])]],i={center:[(u[0]+m[0])/2,(u[1]+m[1])/2,(u[2]+m[2])/2],xRadius:Math.abs(u[0]-m[0])/2,yRadius:Math.abs(u[1]-m[1])/2,zRadius:Math.abs(u[2]-m[2])/2},{worldWidth:s,worldHeight:h}=sc(d,c,f,E),p=0===s&&0===h,I=ss(a),C=Math.abs(Math.PI*(s/2)*(h/2))/I/I,_={isPreScaled:jd(t,o),isSuvScaled:this.isSuvScaled(t,o,e.metadata.referencedImageId)},T=zd(l.Modality,e.metadata.referencedImageId,_),b=us(r,(e=>Is(i,e,{fast:!0})),this.configuration.statsCalculator.statsCallback,n),D=this.configuration.statsCalculator.getStatistics();v[o]={Modality:l.Modality,area:C,mean:D[1]?.value,max:D[0]?.value,stdDev:D[2]?.value,statsArray:D,pointsInShape:b,isEmptyArea:p,areaUnit:as(null,a),modalityUnit:T}}else this.isHandleOutsideImage=!0,v[o]={Modality:l.Modality}}e.invalidated=!1;const w=re.ANNOTATION_MODIFIED,I={annotation:e,viewportId:a,renderingEngineId:s};return(0,ne.triggerEvent)(ne.eventTarget,w,I),v},this._isInsideVolume=(e,t,n)=>ne.utilities.indexWithinDimensions(e,n)&&ne.utilities.indexWithinDimensions(t,n),this._throttledCalculateCachedStats=qa(this._calculateCachedStats,100,{trailing:!0})}_pointInEllipseCanvas(e,t){const n=e.width/2,i=e.height/2;if(n<=0||i<=0)return!1;const o=[e.left+n,e.top+i],a=[t[0]-o[0],t[1]-o[1]];return a[0]*a[0]/(n*n)+a[1]*a[1]/(i*i)<=1}_getCanvasEllipseCenter(e){const[t,n,i,o]=e,a=[i[0],n[1]],s=[o[0],t[1]];return[(a[0]+s[0])/2,(a[1]+s[1])/2]}}function dc(e,t){const n=e.cachedStats[t],{area:i,mean:o,stdDev:a,max:s,isEmptyArea:r,areaUnit:l,modalityUnit:d}=n,c=[];if(i){const e=r?"Area: Oblique not supported":`Area: ${ws(i)} ${l}`;c.push(e)}return o&&c.push(`Mean: ${ws(o)} ${d}`),s&&c.push(`Max: ${ws(s)} ${d}`),a&&c.push(`Std Dev: ${ws(a)} ${d}`),c}lc.toolName="EllipticalROI";const cc=lc,{transformWorldToIndex:hc}=ne.utilities;class gc extends Ca{constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"],configuration:{shadow:!0,preventHandleOutsideImage:!1,centerPointRadius:0,getTextLines:uc,statsCalculator:Rl}}){super(e,t),this.isHandleOutsideImage=!1,this.addNewAnnotation=e=>{const t=e.detail,{currentPoints:n,element:i}=t,o=n.world,a=(n.canvas,(0,ne.getEnabledElement)(i)),{viewport:s,renderingEngine:r}=a;this.isDrawing=!0;const l=s.getCamera(),{viewPlaneNormal:d,viewUp:c}=l,h=this.getReferencedImageId(s,o,d,c),g=s.getFrameOfReferenceUID(),u={highlighted:!0,invalidated:!0,metadata:{toolName:this.getToolName(),viewPlaneNormal:[...d],viewUp:[...c],FrameOfReferenceUID:g,referencedImageId:h},data:{label:"",handles:{textBox:{hasMoved:!1,worldPosition:[0,0,0],worldBoundingBox:{topLeft:[0,0,0],topRight:[0,0,0],bottomLeft:[0,0,0],bottomRight:[0,0,0]}},points:[[...o],[...o]],activeHandleIndex:null},cachedStats:{}}};rp(u,i);const m=Cl(i,this.getToolName());return this.editData={annotation:u,viewportIdsToRender:m,newAnnotation:!0,hasMoved:!1},this._activateDraw(i),Rr(i),e.preventDefault(),cs(r,m),u},this.isPointNearTool=(e,t,n,i)=>{const o=(0,ne.getEnabledElement)(e),{viewport:a}=o,{data:s}=t,{points:r}=s.handles,l=r.map((e=>a.worldToCanvas(e))),d=md(l),c=md([l[0],n]);return Math.abs(c-d)<i/2},this.toolSelectedCallback=(e,t)=>{const n=e.detail,{element:i}=n;t.highlighted=!0;const o=Cl(i,this.getToolName());this.editData={annotation:t,viewportIdsToRender:o,movingTextBox:!1},Rr(i),this._activateModify(i);const a=(0,ne.getEnabledElement)(i),{renderingEngine:s}=a;cs(s,o),e.preventDefault()},this.handleSelectedCallback=(e,t,n)=>{const i=e.detail,{element:o}=i,{data:a}=t;t.highlighted=!0;let s,r=!1;if(n.worldPosition)r=!0;else{const{points:e}=a.handles;s=e.findIndex((e=>e===n))}const l=Cl(o,this.getToolName());this.editData={annotation:t,viewportIdsToRender:l,handleIndex:s,movingTextBox:r},this._activateModify(o),Rr(o);const d=(0,ne.getEnabledElement)(o),{renderingEngine:c}=d;cs(c,l),e.preventDefault()},this._endCallback=e=>{const t=e.detail,{element:n}=t,{annotation:i,viewportIdsToRender:o,newAnnotation:a,hasMoved:s}=this.editData,{data:r}=i;if(a&&!s)return;i.highlighted=!1,r.handles.activeHandleIndex=null,this._deactivateModify(n),this._deactivateDraw(n),xr(n);const l=(0,ne.getEnabledElement)(n),{renderingEngine:d}=l;if(this.editData=null,this.isDrawing=!1,this.isHandleOutsideImage&&this.configuration.preventHandleOutsideImage&&dp(i.annotationUID),cs(d,o),a){const e=re.ANNOTATION_COMPLETED,t={annotation:i};(0,ne.triggerEvent)(ne.eventTarget,e,t)}},this._dragDrawCallback=e=>{this.isDrawing=!0;const t=e.detail,{element:n}=t,{currentPoints:i}=t,o=i.canvas,a=(0,ne.getEnabledElement)(n),{renderingEngine:s,viewport:r}=a,{canvasToWorld:l}=r,{annotation:d,viewportIdsToRender:c}=this.editData,{data:h}=d;h.handles.points=[h.handles.points[0],l(o)],d.invalidated=!0,this.editData.hasMoved=!0,cs(s,c)},this._dragModifyCallback=e=>{this.isDrawing=!0;const t=e.detail,{element:n}=t,{annotation:i,viewportIdsToRender:o,handleIndex:a,movingTextBox:s}=this.editData,{data:r}=i;if(s){const{deltaPoints:e}=t,n=e.world,{textBox:i}=r.handles,{worldPosition:o}=i;o[0]+=n[0],o[1]+=n[1],o[2]+=n[2],i.hasMoved=!0}else if(void 0===a){const{deltaPoints:e}=t,n=e.world;r.handles.points.forEach((e=>{e[0]+=n[0],e[1]+=n[1],e[2]+=n[2]})),i.invalidated=!0}else this._dragHandle(e),i.invalidated=!0;const l=(0,ne.getEnabledElement)(n),{renderingEngine:d}=l;cs(d,o)},this._dragHandle=e=>{const t=e.detail,{element:n}=t,i=(0,ne.getEnabledElement)(n),{canvasToWorld:o,worldToCanvas:a}=i.viewport,{annotation:s,handleIndex:r}=this.editData,{data:l}=s,{points:d}=l.handles,c=d.map((e=>a(e))),{currentPoints:h}=t,g=h.canvas;if(0===r){const e=g[0]-c[0][0],t=g[1]-c[0][1],n=g,i=[c[1][0]+e,c[1][1]+t];d[0]=o(n),d[1]=o(i)}else d[1]=o(g)},this.cancel=e=>{if(this.isDrawing){this.isDrawing=!1,this._deactivateDraw(e),this._deactivateModify(e),xr(e);const{annotation:t,viewportIdsToRender:n,newAnnotation:i}=this.editData,{data:o}=t;t.highlighted=!1,o.handles.activeHandleIndex=null;const a=(0,ne.getEnabledElement)(e),{renderingEngine:s}=a;if(cs(s,n),i){const e=re.ANNOTATION_COMPLETED,n={annotation:t};(0,ne.triggerEvent)(ne.eventTarget,e,n)}return this.editData=null,t.annotationUID}},this._activateModify=e=>{Je.isInteractingWithTool=!0,e.addEventListener(re.MOUSE_UP,this._endCallback),e.addEventListener(re.MOUSE_DRAG,this._dragModifyCallback),e.addEventListener(re.MOUSE_CLICK,this._endCallback),e.addEventListener(re.TOUCH_END,this._endCallback),e.addEventListener(re.TOUCH_DRAG,this._dragModifyCallback),e.addEventListener(re.TOUCH_TAP,this._endCallback)},this._deactivateModify=e=>{Je.isInteractingWithTool=!1,e.removeEventListener(re.MOUSE_UP,this._endCallback),e.removeEventListener(re.MOUSE_DRAG,this._dragModifyCallback),e.removeEventListener(re.MOUSE_CLICK,this._endCallback),e.removeEventListener(re.TOUCH_END,this._endCallback),e.removeEventListener(re.TOUCH_DRAG,this._dragModifyCallback),e.removeEventListener(re.TOUCH_TAP,this._endCallback)},this._activateDraw=e=>{Je.isInteractingWithTool=!0,e.addEventListener(re.MOUSE_UP,this._endCallback),e.addEventListener(re.MOUSE_DRAG,this._dragDrawCallback),e.addEventListener(re.MOUSE_MOVE,this._dragDrawCallback),e.addEventListener(re.MOUSE_CLICK,this._endCallback),e.addEventListener(re.TOUCH_END,this._endCallback),e.addEventListener(re.TOUCH_DRAG,this._dragDrawCallback),e.addEventListener(re.TOUCH_TAP,this._endCallback)},this._deactivateDraw=e=>{Je.isInteractingWithTool=!1,e.removeEventListener(re.MOUSE_UP,this._endCallback),e.removeEventListener(re.MOUSE_DRAG,this._dragDrawCallback),e.removeEventListener(re.MOUSE_MOVE,this._dragDrawCallback),e.removeEventListener(re.MOUSE_CLICK,this._endCallback),e.removeEventListener(re.TOUCH_END,this._endCallback),e.removeEventListener(re.TOUCH_DRAG,this._dragDrawCallback),e.removeEventListener(re.TOUCH_TAP,this._endCallback)},this.renderAnnotation=(e,t)=>{let n=!1;const{viewport:i}=e,{element:o}=i;let a=sp(this.getToolName(),o);if(!a?.length)return n;if(a=this.filterInteractableAnnotationsForElement(o,a),!a?.length)return n;const s=this.getTargetId(i),r=i.getRenderingEngine(),l={toolGroupId:this.toolGroupId,toolName:this.getToolName(),viewportId:e.viewport.id};for(let o=0;o<a.length;o++){const d=a[o],{annotationUID:c,data:h}=d,{handles:g}=h,{points:u,activeHandleIndex:m}=g;l.annotationUID=c;const v=this.getStyle("lineWidth",l,d),p=this.getStyle("lineDash",l,d),f=this.getStyle("color",l,d),E=u.map((e=>i.worldToCanvas(e))),w=E[0],I=md(E),C=vd(E),{centerPointRadius:_}=this.configuration;if(h.cachedStats[s]&&null!=h.cachedStats[s].areaUnit){if(d.invalidated&&(this._throttledCalculateCachedStats(d,i,r,e),i instanceof ne.VolumeViewport)){const{referencedImageId:e}=d.metadata;for(const t in h.cachedStats)if(t.startsWith("imageId")){r.getStackViewports().find((t=>{const n=ne.utilities.imageIdToURI(e),i=t.hasImageURI(n),o=ne.utilities.imageIdToURI(t.getCurrentImageId());return i&&o!==n}))&&delete h.cachedStats[t]}}}else h.cachedStats[s]={Modality:null,area:null,max:null,mean:null,stdDev:null,areaUnit:null,radius:null,radiusUnit:null,perimeter:null},this._calculateCachedStats(d,i,r,e);if(!i.getRenderingEngine())return console.warn("Rendering Engine has been destroyed"),n;let T;if(!He(c))continue;if(we(d)||this.editData||null===m||(T=[E[m]]),T){$o(t,c,"0",T,{color:f})}const b="0";Ho(t,c,b,w,I,{color:f,lineDash:p,lineWidth:v},`${c}-circle`),_>0&&I>3*_&&Ho(t,c,`${b}-center`,w,_,{color:f,lineDash:p,lineWidth:v}),n=!0;const D=this.getLinkedTextBoxStyle(l,d);if(!D.visibility){h.handles.textBox={hasMoved:!1,worldPosition:[0,0,0],worldBoundingBox:{topLeft:[0,0,0],topRight:[0,0,0],bottomLeft:[0,0,0],bottomRight:[0,0,0]}};continue}const S=this.configuration.getTextLines(h,s);if(!S||0===S.length)continue;let M;h.handles.textBox.hasMoved||(M=Vd(C),h.handles.textBox.worldPosition=i.canvasToWorld(M));const y=i.worldToCanvas(h.handles.textBox.worldPosition),O=Jo(t,c,"1",S,y,E,{},D),{x,y:R,width:P,height:N}=O;h.handles.textBox.worldBoundingBox={topLeft:i.canvasToWorld([x,R]),topRight:i.canvasToWorld([x+P,R]),bottomLeft:i.canvasToWorld([x,R+N]),bottomRight:i.canvasToWorld([x+P,R+N])}}return n},this._calculateCachedStats=(e,t,n,i)=>{const o=e.data,{viewportId:a,renderingEngineId:s}=i,{points:r}=o.handles,l=r.map((e=>t.worldToCanvas(e))),{viewPlaneNormal:d,viewUp:c}=t.getCamera(),[h,g]=vd(l),u=t.canvasToWorld(h),m=t.canvasToWorld(g),{cachedStats:v}=o,p=Object.keys(v),f=u,E=m;for(let i=0;i<p.length;i++){const o=p[i],a=this.getTargetIdImage(o,n);if(!a)continue;const{dimensions:s,imageData:r,metadata:l,hasPixelSpacing:h}=a,g=hc(r,f);g[0]=Math.floor(g[0]),g[1]=Math.floor(g[1]),g[2]=Math.floor(g[2]);const w=hc(r,E);if(w[0]=Math.floor(w[0]),w[1]=Math.floor(w[1]),w[2]=Math.floor(w[2]),this._isInsideVolume(g,w,s)){const n=[[Math.min(g[0],w[0]),Math.max(g[0],w[0])],[Math.min(g[1],w[1]),Math.max(g[1],w[1])],[Math.min(g[2],w[2]),Math.max(g[2],w[2])]],i={center:[(u[0]+m[0])/2,(u[1]+m[1])/2,(u[2]+m[2])/2],xRadius:Math.abs(u[0]-m[0])/2,yRadius:Math.abs(u[1]-m[1])/2,zRadius:Math.abs(u[2]-m[2])/2},{worldWidth:s,worldHeight:h}=sc(d,c,f,E),p=0===s&&0===h,I=ss(a),C=ds(a),_=Math.abs(Math.PI*(s/I/2)*(h/C/I/2)),T={isPreScaled:jd(t,o),isSuvScaled:this.isSuvScaled(t,o,e.metadata.referencedImageId)},b=zd(l.Modality,e.metadata.referencedImageId,T),D=us(r,(e=>Is(i,e,{fast:!0})),this.configuration.statsCalculator.statsCallback,n),S=this.configuration.statsCalculator.getStatistics();v[o]={Modality:l.Modality,area:_,mean:S[1]?.value,max:S[0]?.value,stdDev:S[2]?.value,statsArray:S,pointsInShape:D,isEmptyArea:p,areaUnit:as(null,a),radius:s/2/I,radiusUnit:is(null,a),perimeter:2*Math.PI*(s/2)/I,modalityUnit:b}}else this.isHandleOutsideImage=!0,v[o]={Modality:l.Modality}}e.invalidated=!1;const w=re.ANNOTATION_MODIFIED,I={annotation:e,viewportId:a,renderingEngineId:s};return(0,ne.triggerEvent)(ne.eventTarget,w,I),v},this._isInsideVolume=(e,t,n)=>ne.utilities.indexWithinDimensions(e,n)&&ne.utilities.indexWithinDimensions(t,n),this._throttledCalculateCachedStats=qa(this._calculateCachedStats,100,{trailing:!0})}}function uc(e,t){const n=e.cachedStats[t],{radius:i,radiusUnit:o,area:a,mean:s,stdDev:r,max:l,isEmptyArea:d,Modality:c,areaUnit:h,modalityUnit:g}=n,u=[];if(i){const e=d?"Radius: Oblique not supported":`Radius: ${ws(i)} ${o}`;u.push(e)}if(a){const e=d?"Area: Oblique not supported":`Area: ${ws(a)} ${h}`;u.push(e)}return s&&u.push(`Mean: ${ws(s)} ${g}`),l&&u.push(`Max: ${ws(l)} ${g}`),r&&u.push(`Std Dev: ${ws(r)} ${g}`),u}gc.toolName="CircleROI";const mc=gc;class vc{constructor(e){this._controlPoints=[],this._invalidated=!1,this._length=0,this._controlPoints=[],this._resolution=e?.resolution??20,this._closed=e?.closed??!1,this._invalidated=!0}get controlPoints(){return this._controlPoints}get numControlPoints(){return this._controlPoints.length}get resolution(){return this._resolution}set resolution(e){this._resolution!==e&&(this._resolution=e,this.invalidated=!0)}get closed(){return this._closed}set closed(e){this._closed!==e&&(this._closed=e,this.invalidated=!0)}get aabb(){return this._update(),this._aabb}get length(){return this._update(),this._length}get invalidated(){return this._invalidated}set invalidated(e){this._invalidated=e}hasTangentPoints(){return!1}addControlPoint(e){this._controlPoints.push([e[0],e[1]]),this.invalidated=!0}addControlPoints(e){e.forEach((e=>this.addControlPoint(e)))}addControlPointAtU(e){const t=this._getLineSegmentAt(e),{start:n,end:i}=t.points,o=Math.floor(e),a=this._curveSegments[o],s=e-Math.floor(o),r=[n[0]+s*(i[0]-n[0]),n[1]+s*(i[1]-n[1])],l=this._controlPoints.indexOf(a.controlPoints.p1)+1;return this._controlPoints.splice(l,0,r),this.invalidated=!0,{index:l,point:r}}deleteControlPointByIndex(e){const t=this._closed?3:1;return e>=0&&e<this._controlPoints.length&&this._controlPoints.length>t&&(this._controlPoints.splice(e,1),this.invalidated=!0,!0)}clearControlPoints(){this._controlPoints=[],this.invalidated=!0}setControlPoints(e){this.clearControlPoints(),this.addControlPoints(e)}updateControlPoint(e,t){if(e<0||e>=this._controlPoints.length)throw new Error("Index out of bounds");this._controlPoints[e]=[...t],this.invalidated=!0}getControlPoints(){return this._controlPoints.map((e=>[e[0],e[1]]))}getClosestControlPoint(e){const t=this._controlPoints;let n=1/0,i=-1;for(let o=0,a=t.length;o<a;o++){const a=t[o],s=e[0]-a[0],r=e[1]-a[1],l=s*s+r*r;l<n&&(n=l,i=o)}return{index:i,point:-1===i?void 0:[...t[i]],distance:Math.sqrt(n)}}getClosestControlPointWithinDistance(e,t){const n=this.getClosestControlPoint(e);return n.distance<=t?n:void 0}getClosestPoint(e){this._update();const t=this._getCurveSegmmentsDistanceSquaredInfo(e);if(!t.length)return;let n;t.sort(((e,t)=>e.distanceSquared-t.distanceSquared));let i,o,a=-1,s=1/0;for(let r=0;r<t.length;r++){const l=t[r];if(l.distanceSquared>s)continue;const{curveSegmentIndex:d,curveSegment:c}=l,{lineSegments:h}=c;for(let t=0;t<h.length;t++){const r=h[t],{point:c,distanceSquared:g}=Zl(r.points.start,r.points.end,e);g<s&&(o=r,a=d,i=l.curveSegment,n=c,s=g)}}return{point:n,uValue:a+(o.previousLineSegmentsLength+Ll(o.points.start,n))/i.length,distance:Math.sqrt(s)}}getClosestPointOnControlPointLines(e){const t=[...this._controlPoints];if(this._closed&&t.push(this._controlPoints[0]),!t.length)return;let n,i=1/0,o=t[0];for(let a=1,s=t.length;a<s;a++){const s=t[a],{point:r,distanceSquared:l}=Zl(o,s,e);l<i&&(n=r,i=l),o=s}return{point:n,distance:Math.sqrt(i)}}getPolylinePoints(){return this._update(),this._convertCurveSegmentsToPolyline(this._curveSegments)}getPreviewPolylinePoints(e,t){if(this._closed)return[];this._update();const n=this.getClosestControlPointWithinDistance(e,t),i=0===n?.index,o=this.getPreviewCurveSegments(e,i);return o?.length?this._convertCurveSegmentsToPolyline(o):[]}isPointNearCurve(e,t){this._update();const n=this._getCurveSegmmentsWithinDistance(e,t),i=t*t;for(let t=0;t<n.length;t++){const{lineSegments:o}=n[t];for(let t=0;t<o.length;t++){const n=o[t];if(Xl(n.points.start,n.points.end,e)<=i)return!0}}return!1}containsPoint(e){this._update();if(this._controlPoints.length<3)return!1;const t=[...this._curveSegments],n=this._getClosingCurveSegmentWithStraightLineSegment();n&&t.push(n);let i=0;for(let n=0;n<t.length;n++){const o=t[n],{aabb:a}=o;if(!(e[0]<=a.maxX&&e[1]>=a.minY&&e[1]<a.maxY))continue;const{lineSegments:s}=o;for(let t=0;t<s.length;t++){const n=s[t],{aabb:o}=n;if(e[0]<=o.maxX&&e[1]>=o.minY&&e[1]<o.maxY){const{start:t,end:o}=n.points,a=t[0]===o[0],s=(e[1]-t[1])*(o[0]-t[0])/(o[1]-t[1])+t[0];i+=a||e[0]<=s?1:0}}}return i%2==1}_update(){if(!this._invalidated)return;const e=this.getSplineCurves();let t=0,n=1/0,i=1/0,o=-1/0,a=-1/0;for(let s=0,r=e.length;s<r;s++){const{aabb:r,length:l}=e[s];n=n<=r.minX?n:r.minX,i=i<=r.minY?i:r.minY,o=o>=r.maxX?o:r.maxX,a=a>=r.maxY?a:r.maxY,t+=l}this._curveSegments=e,this._aabb={minX:n,minY:i,maxX:o,maxY:a},this._length=t,this._invalidated=!1}_convertCurveSegmentsToPolyline(e){this._update();const t=[];return e.forEach((({lineSegments:e},n)=>{e.forEach(((e,i)=>{0===n&&0===i&&t.push([...e.points.start]),t.push([...e.points.end])}))})),t}_getCurveSegmmentsDistanceSquaredInfo(e){this._update();const t=[],{_curveSegments:n}=this;for(let i=0;i<n.length;i++){const o=n[i],a=Ml(o.aabb,e);t.push({curveSegmentIndex:i,curveSegment:o,distanceSquared:a})}return t}_getCurveSegmmentsWithinDistance(e,t){this._update();const n=t*t;if(Ml(this.aabb,e)>n)return[];const i=this._getCurveSegmmentsDistanceSquaredInfo(e),o=[];for(let e=0,t=i.length;e<t;e++){const{curveSegment:t,distanceSquared:a}=i[e];a<=n&&o.push(t)}return o}_getLineSegmentAt(e){this._update();const t=Math.floor(e),n=e-t,i=this._curveSegments[t],{lineSegments:o}=i,a=i.length*n;for(let e=0;e<o.length;e++){const t=o[e],n=t.previousLineSegmentsLength+t.length;if(a>=t.previousLineSegmentsLength&&a<=n)return t}}_getClosingCurveSegmentWithStraightLineSegment(){if(this.closed)return;const e=this._controlPoints,t=e[0],n=e[e.length-1],i={points:{start:[...t],end:[...n]},aabb:{minX:Math.min(t[0],n[0]),minY:Math.min(t[1],n[1]),maxX:Math.max(t[0],n[0]),maxY:Math.max(t[1],n[1])}};return{aabb:{minX:i.aabb.minX,minY:i.aabb.minY,maxX:i.aabb.maxX,maxY:i.aabb.maxY},lineSegments:[i]}}}class pc extends vc{getPreviewCurveSegments(e,t){const n=this._getNumCurveSegments()+1,i=Math.max(0,n-2),o=t?n:n-1,a=this.getTransformMatrix(),s=[...this.controlPoints],r=[];t||s.push(e);for(let e=i;e<=o;e++){const n=this._getCurveSegment(e,a,s,t);r.push(n)}return r}getSplineCurves(){const e=this._getNumCurveSegments(),t=new Array(e);if(e<=0)return[];const n=this.getTransformMatrix();let i=0;for(let o=0;o<e;o++){const e=this._getCurveSegment(o,n);e.previousCurveSegmentsLength=i,t[o]=e,i+=e.length}return t}_getNumCurveSegments(e=this.controlPoints,t=this.closed){return t?e.length:Math.max(0,e.length-1)}_getPoint(e,t,n=this.controlPoints,i=this.closed){const o=this._getNumCurveSegments(n,i),a=Math.floor(e);let s=a%o;const r=e-a;if(s<0||s>=o){if(!this.closed)return;s=(o+s)%o}const{p0:l,p1:d,p2:c,p3:h}=this._getCurveSegmentPoints(s,n,i),g=r*r,u=g*r,m=Oo.vh.fromValues(1,r,g,u),v=Oo.vh.transformMat4(Oo.vh.create(),m,t);return[Oo.vh.dot(v,Oo.vh.fromValues(l[0],d[0],c[0],h[0])),Oo.vh.dot(v,Oo.vh.fromValues(l[1],d[1],c[1],h[1]))]}_getCurveSegmentPoints(e,t=this.controlPoints,n=this.closed){const i=this._getNumCurveSegments(t,n),o=e-1,a=n?(e+1)%i:e+1,s=a+1,r=t[e],l=t[a];let d,c;return d=o>=0?t[o]:n?t[t.length-1]:Al(l,r),c=s<t.length?t[s]:n?t[0]:Al(r,l),{p0:d,p1:r,p2:l,p3:c}}_getLineSegments(e,t,n=this.controlPoints,i=this.closed){const o=this._getNumCurveSegments(n,i),a=this.resolution+1,s=1/a;let r=e+1;i||e!==o-1||(r-=1e-8);const l=[];let d,c,h=0;for(let o=0,g=e;o<=a;o++,g+=s){g=g>r?r:g;const e=this._getPoint(g,t,n,i);if(!o){d=e;continue}c=e;const a=c[0]-d[0],s=c[1]-d[1],u=Math.sqrt(a**2+s**2),m={minX:d[0]<=c[0]?d[0]:c[0],maxX:d[0]>=c[0]?d[0]:c[0],minY:d[1]<=c[1]?d[1]:c[1],maxY:d[1]>=c[1]?d[1]:c[1]};l.push({points:{start:d,end:c},aabb:m,length:u,previousLineSegmentsLength:h}),d=c,h+=u}return l}_getCurveSegment(e,t=this.getTransformMatrix(),n=this.controlPoints,i=this.closed){const{p0:o,p1:a,p2:s,p3:r}=this._getCurveSegmentPoints(e,n,i),l=this._getLineSegments(e,t,n,i);let d=0,c=1/0,h=1/0,g=-1/0,u=-1/0;return l.forEach((({aabb:e,length:t})=>{c=Math.min(c,e.minX),h=Math.min(h,e.minY),g=Math.max(g,e.maxX),u=Math.max(u,e.maxY),d+=t})),{controlPoints:{p0:o,p1:a,p2:s,p3:r},aabb:{minX:c,minY:h,maxX:g,maxY:u},length:d,previousCurveSegmentsLength:0,lineSegments:l}}}class fc extends pc{constructor(e){super(e),this._scale=e?.scale??.5,this._fixedScale=e?.fixedScale??!1}get scale(){return this._scale}set scale(e){this._fixedScale||this._scale===e||(this._scale=e,this.invalidated=!0)}get fixedScale(){return this._fixedScale}getTransformMatrix(){const{scale:e}=this,t=2*e;return[0,1,0,0,-e,0,e,0,t,e-3,3-t,-e,-e,2-e,e-2,e]}}class Ec extends fc{constructor(){super({scale:0,fixedScale:!0})}}class wc extends fc{constructor(){super({scale:.5,fixedScale:!0})}}const Ic=Oo._E.multiplyScalar(Oo._E.create(),Oo._E.fromValues(1,4,1,0,-3,0,3,0,3,-6,3,0,-1,3,-3,1),1/6);class Cc extends pc{getTransformMatrix(){return Ic}}var _c;const Tc={resolution:20,controlPointAdditionDistance:6,controlPointDeletionDistance:6,showControlPointsConnectors:!1,controlPointAdditionEnabled:!0,controlPointDeletionEnabled:!0};var bc,Dc;!function(e){e.Cardinal="CARDINAL",e.Linear="LINEAR",e.CatmullRom="CATMULLROM",e.BSpline="BSPLINE"}(bc||(bc={})),function(e){e.AddControlPoint="addControlPoint",e.DeleteControlPoint="deleteControlPoint"}(Dc||(Dc={}));class Sc extends Ca{constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"],configuration:{preventHandleOutsideImage:!1,calculateStats:!0,getTextLines:Mc,spline:{configuration:{[bc.Cardinal]:{Class:fc,scale:.5},[bc.CatmullRom]:{Class:wc},[bc.Linear]:{Class:Ec},[bc.BSpline]:{Class:Cc,controlPointAdditionEnabled:!1,controlPointDeletionEnabled:!1,showControlPointsConnectors:!0}},type:bc.CatmullRom,drawPreviewEnabled:!0,lastControlPointDeletionKeys:["Backspace","Delete"]},actions:{[Dc.AddControlPoint]:{method:"addControlPointCallback",bindings:[{mouseButton:Q.Primary,modifierKey:ee.Shift}]},[Dc.DeleteControlPoint]:{method:"deleteControlPointCallback",bindings:[{mouseButton:Q.Primary,modifierKey:ee.Ctrl}]}}}}){super(e,t),this.isHandleOutsideImage=!1,this.addNewAnnotation=e=>{const t=e.detail,{currentPoints:n,element:i}=t,{world:o,canvas:a}=n,s=(0,ne.getEnabledElement)(i),{viewport:r,renderingEngine:l}=s;this.isDrawing=!0;const d=r.getCamera(),{viewPlaneNormal:c,viewUp:h}=d,{type:g}=this.configuration.spline,u=this._getSplineConfig(g),m=new u.Class,v=this.getReferencedImageId(r,o,c,h),p=r.getFrameOfReferenceUID(),f={highlighted:!0,invalidated:!0,metadata:{toolName:this.getToolName(),viewPlaneNormal:[...c],viewUp:[...h],FrameOfReferenceUID:p,referencedImageId:v},data:{handles:{textBox:{hasMoved:!1,worldPosition:[0,0,0],worldBoundingBox:{topLeft:[0,0,0],topRight:[0,0,0],bottomLeft:[0,0,0],bottomRight:[0,0,0]}},points:[[...o]],activeHandleIndex:null},spline:{type:u.type,instance:m,resolution:u.resolution,closed:!1,polyline:[]},cachedStats:{}}};rp(f,i);const E=Cl(i,this.getToolName());return this.editData={annotation:f,viewportIdsToRender:E,movingTextBox:!1,newAnnotation:!0,hasMoved:!1,lastCanvasPoint:a},this._activateDraw(i),e.preventDefault(),cs(l,E),f},this.isPointNearTool=(e,t,n,i)=>{const{instance:o}=t.data.spline;return o.isPointNearCurve(n,i)},this.toolSelectedCallback=(e,t)=>{const n=e.detail,{element:i}=n;t.highlighted=!0;const o=Cl(i,this.getToolName());this.editData={annotation:t,viewportIdsToRender:o,movingTextBox:!1};const a=(0,ne.getEnabledElement)(i),{renderingEngine:s}=a;this._activateModify(i),cs(s,o),e.preventDefault()},this.handleSelectedCallback=(e,t,n)=>{const i=e.detail,{element:o}=i,{data:a}=t;t.highlighted=!0;let s,r=!1;if(n.worldPosition)r=!0;else{const{points:e}=a.handles;s=e.findIndex((e=>e===n))}const l=Cl(o,this.getToolName());this.editData={annotation:t,viewportIdsToRender:l,handleIndex:s,movingTextBox:r},this._activateModify(o);const d=(0,ne.getEnabledElement)(o),{renderingEngine:c}=d;cs(c,l),e.preventDefault()},this._endCallback=e=>{const t=e.detail,{element:n}=t,{annotation:i,viewportIdsToRender:o,newAnnotation:a}=this.editData,{data:s}=i;s.handles.activeHandleIndex=null,this._deactivateModify(n),this._deactivateDraw(n),xr(n);const r=(0,ne.getEnabledElement)(n),{renderingEngine:l}=r;if(this.isHandleOutsideImage&&this.configuration.preventHandleOutsideImage&&dp(i.annotationUID),cs(l,o),a){const e=re.ANNOTATION_COMPLETED,t={annotation:i};(0,ne.triggerEvent)(ne.eventTarget,e,t)}this.editData=null,this.isDrawing=!1},this._keyDownCallback=e=>{const t=e.detail,{element:n}=t,i=t.key??"",{lastControlPointDeletionKeys:o}=this.configuration.spline;if(!o.includes(i))return;const{annotation:a}=this.editData,{data:s}=a;if(3!==s.handles.points.length){{const e=s.handles.points.length-1;this._deleteControlPointByIndex(n,a,e)}e.preventDefault()}else this.cancel(n)},this._mouseMoveCallback=e=>{const{drawPreviewEnabled:t}=this.configuration.spline;if(!t)return;const{element:n}=e.detail,{renderingEngine:i}=(0,ne.getEnabledElement)(n),o=Cl(n,this.getToolName());this.editData.lastCanvasPoint=e.detail.currentPoints.canvas,cs(i,o),e.preventDefault()},this._mouseDownCallback=e=>{const t=e.type===re.MOUSE_DOUBLE_CLICK,{annotation:n,viewportIdsToRender:i}=this.editData,{data:o}=n;if(o.spline.closed)return;const a=e.detail,{element:s}=a,{currentPoints:r}=a,{canvas:l,world:d}=r,c=(0,ne.getEnabledElement)(s),{renderingEngine:h}=c;let g=o.handles.points.length>=2&&t,u=!0;if(o.handles.points.length>=3){const{instance:e}=o.spline,t=e.getClosestControlPointWithinDistance(l,10);0===t?.index&&(u=!1,g=!0)}u&&o.handles.points.push(d),o.spline.closed=o.spline.closed||g,n.invalidated=!0,cs(h,i),o.spline.closed&&this._endCallback(e),e.preventDefault()},this._dragCallback=e=>{this.isDrawing=!0;const t=e.detail,{element:n}=t,{annotation:i,viewportIdsToRender:o,handleIndex:a,movingTextBox:s}=this.editData,{data:r}=i;if(s){const{deltaPoints:e}=t,n=e.world,{textBox:i}=r.handles,{worldPosition:o}=i;o[0]+=n[0],o[1]+=n[1],o[2]+=n[2],i.hasMoved=!0}else if(void 0===a){const{deltaPoints:e}=t,n=e.world;r.handles.points.forEach((e=>{e[0]+=n[0],e[1]+=n[1],e[2]+=n[2]})),i.invalidated=!0}else{const{currentPoints:e}=t,n=e.world;r.handles.points[a]=[...n],i.invalidated=!0}this.editData.hasMoved=!0;const l=(0,ne.getEnabledElement)(n),{renderingEngine:d}=l;cs(d,o)},this.cancel=e=>{if(!this.isDrawing)return;this.isDrawing=!1,this._deactivateDraw(e),this._deactivateModify(e),xr(e);const{annotation:t,viewportIdsToRender:n,newAnnotation:i}=this.editData;i&&dp(t.annotationUID);const o=(0,ne.getEnabledElement)(e),{renderingEngine:a}=o;return cs(a,n),this.editData=null,t.annotationUID},this.triggerAnnotationModified=(e,t)=>{const{viewportId:n,renderingEngineId:i}=t,o=re.ANNOTATION_MODIFIED,a={annotation:e,viewportId:n,renderingEngineId:i};(0,ne.triggerEvent)(ne.eventTarget,o,a)},this._activateModify=e=>{Je.isInteractingWithTool=!0,e.addEventListener(re.MOUSE_UP,this._endCallback),e.addEventListener(re.MOUSE_DRAG,this._dragCallback),e.addEventListener(re.MOUSE_CLICK,this._endCallback),e.addEventListener(re.TOUCH_END,this._endCallback),e.addEventListener(re.TOUCH_DRAG,this._dragCallback),e.addEventListener(re.TOUCH_TAP,this._endCallback)},this._deactivateModify=e=>{Je.isInteractingWithTool=!1,e.removeEventListener(re.MOUSE_UP,this._endCallback),e.removeEventListener(re.MOUSE_DRAG,this._dragCallback),e.removeEventListener(re.MOUSE_CLICK,this._endCallback),e.removeEventListener(re.TOUCH_END,this._endCallback),e.removeEventListener(re.TOUCH_DRAG,this._dragCallback),e.removeEventListener(re.TOUCH_TAP,this._endCallback)},this._activateDraw=e=>{Je.isInteractingWithTool=!0,e.addEventListener(re.KEY_DOWN,this._keyDownCallback),e.addEventListener(re.MOUSE_MOVE,this._mouseMoveCallback),e.addEventListener(re.MOUSE_DOWN,this._mouseDownCallback),e.addEventListener(re.MOUSE_DOUBLE_CLICK,this._mouseDownCallback),e.addEventListener(re.TOUCH_TAP,this._mouseDownCallback)},this._deactivateDraw=e=>{Je.isInteractingWithTool=!1,e.removeEventListener(re.KEY_DOWN,this._keyDownCallback),e.removeEventListener(re.MOUSE_MOVE,this._mouseMoveCallback),e.removeEventListener(re.MOUSE_DOWN,this._mouseDownCallback),e.removeEventListener(re.MOUSE_DOUBLE_CLICK,this._mouseDownCallback),e.removeEventListener(re.TOUCH_TAP,this._mouseDownCallback)},this.renderAnnotation=(e,t)=>{let n=!1;const{viewport:i}=e,{worldToCanvas:o}=i,{element:a}=i;if(!i.getRenderingEngine())return console.warn("Rendering Engine has been destroyed"),n;let s=sp(this.getToolName(),a);if(!s?.length)return n;if(s=this.filterInteractableAnnotationsForElement(a,s),!s?.length)return n;const r=this.getTargetId(i),l=this.editData?.newAnnotation,d={toolGroupId:this.toolGroupId,toolName:this.getToolName(),viewportId:e.viewport.id};for(let c=0;c<s.length;c++){const h=s[c],{annotationUID:g,data:u,highlighted:m}=h,{handles:v}=u,{points:p,activeHandleIndex:f}=v;d.annotationUID=g;const E=this.getStyle("lineWidth",d,h),w=this.getStyle("lineDash",d,h),I=this.getStyle("color",d,h),C=p.map((e=>o(e))),{drawPreviewEnabled:_}=this.configuration.spline,T=h.data.spline.type,b=this._getSplineConfig(T),D=this._updateSplineInstance(a,h),S=D.getPolylinePoints(),M=[];for(let e=0,t=S.length;e<t;e++)M.push(i.canvasToWorld(S[e]));let y;if(u.spline.polyline=M,u.cachedStats[r]&&null!=u.cachedStats[r].areaUnit?h.invalidated&&this._throttledCalculateCachedStats(h,a):(u.cachedStats[r]={Modality:null,area:null,areaUnit:null},this._calculateCachedStats(h,a)),He(g)){if(we(h)||this.editData||null===f||(y=[C[f]]),y||l||m){$o(t,g,"0",C,{color:I,lineDash:w,lineWidth:E,handleRadius:"3"})}if(_&&D.numControlPoints>1&&this.editData?.lastCanvasPoint&&!D.closed){const{lastCanvasPoint:e}=this.editData;qo(t,g,"previewSplineChange",D.getPreviewPolylinePoints(e,10),{color:"#9EA0CA",lineDash:w,lineWidth:E})}if(b.showControlPointsConnectors){const e=[...C];D.closed&&e.push(C[0]),qo(t,g,"controlPointsConnectors",e,{color:"rgba(255, 255, 255, 0.5)",lineDash:w,lineWidth:E})}qo(t,g,"lineSegments",S,{color:I,lineDash:w,lineWidth:E}),this._renderStats(h,i,e,t),n=!0,h.invalidated=!1}}return n},this._renderStats=(e,t,n,i)=>{const o=e.data,a=this.getTargetId(t);if(!o.spline.closed)return;const s={toolGroupId:this.toolGroupId,toolName:this.getToolName(),viewportId:n.viewport.id},r=this.getLinkedTextBoxStyle(s,e);if(!r.visibility)return;const l=this.configuration.getTextLines(o,a);if(!l||0===l.length)return;const d=o.handles.points.map((e=>t.worldToCanvas(e)));if(!o.handles.textBox.hasMoved){const e=Vd(d);o.handles.textBox.worldPosition=t.canvasToWorld(e)}const c=t.worldToCanvas(o.handles.textBox.worldPosition),h=Jo(i,e.annotationUID??"","textBox",l,c,d,{},r),{x:g,y:u,width:m,height:v}=h;o.handles.textBox.worldBoundingBox={topLeft:t.canvasToWorld([g,u]),topRight:t.canvasToWorld([g+m,u]),bottomLeft:t.canvasToWorld([g,u+v]),bottomRight:t.canvasToWorld([g+m,u+v])}},this.addControlPointCallback=(e,t)=>{const{data:n}=t,i=n.spline.type,o=this._getSplineConfig(i),a=o.controlPointAdditionDistance;if(!1===o.controlPointAdditionEnabled)return;const s=e.detail,{element:r}=s,l=(0,ne.getEnabledElement)(r),{renderingEngine:d,viewport:c}=l,{canvasToWorld:h}=c,{instance:g}=n.spline,u=e.detail.currentPoints.canvas,m=g.getClosestPoint(u);if(m.distance>a)return;const{index:v,point:p}=g.addControlPointAtU(m.uValue);n.handles.points.splice(v,0,h(p)),t.invalidated=!0;const f=Cl(r,this.getToolName());cs(d,f)},this.deleteControlPointCallback=(e,t)=>{const n=t.data.spline.type,i=this._getSplineConfig(n),o=i.controlPointDeletionDistance;if(!1===i.controlPointDeletionEnabled)return;const a=e.detail,{element:s,currentPoints:r}=a,{canvas:l}=r,{instance:d}=t.data.spline,c=d.getClosestControlPointWithinDistance(l,o);c&&this._deleteControlPointByIndex(s,t,c.index)},this._calculateCachedStats=(e,t)=>{if(!this.configuration.calculateStats)return;const n=e.data;if(!n.spline.closed)return;const i=(0,ne.getEnabledElement)(t),{viewport:o,renderingEngine:a}=i,{cachedStats:s}=n,{polyline:r}=n.spline,l=Object.keys(s);for(let e=0;e<l.length;e++){const t=l[e],n=this.getTargetIdImage(t,a);if(!n)continue;const{metadata:i}=n,d=r.map((e=>o.worldToCanvas(e))),c=d[0],h=o.canvasToWorld(c),g=o.canvasToWorld([c[0]+1,c[1]]),u=o.canvasToWorld([c[0],c[1]+1]),m=Oo.R3.distance(h,g),v=Oo.R3.distance(h,u),p=ss(n);let f=jl(d)/p/p;f*=m*v,s[t]={Modality:i.Modality,area:f,areaUnit:as(null,n)}}return this.triggerAnnotationModified(e,i),s},this._throttledCalculateCachedStats=qa(this._calculateCachedStats,100,{trailing:!0})}_deleteControlPointByIndex(e,t,n){const i=(0,ne.getEnabledElement)(e),{points:o}=t.data.handles;3===o.length?dp(t.annotationUID):o.splice(n,1);const{renderingEngine:a}=i,s=Cl(e,this.getToolName());t.invalidated=!0,cs(a,s)}_getSplineConfig(e){const{configuration:t}=this,n=t.spline.configuration;return Object.assign({type:e},Tc,n[e])}_updateSplineScale(e,t){const n=t.data.spline.type,i=this._getSplineConfig(n);e instanceof fc&&!e.fixedScale&&void 0!==i.scale&&e.scale!==i.scale&&(e.scale=i.scale,t.invalidated=!0)}_updateSplineInstance(e,t){const n=(0,ne.getEnabledElement)(e),{viewport:i}=n,{worldToCanvas:o}=i,{data:a}=t,{type:s,instance:r}=t.data.spline,l=this._getSplineConfig(s),d=a.handles.points.map(o);return r.setControlPoints(d),r.closed=!!a.spline?.closed,r.resolution!==l.resolution&&(r.resolution=parseInt(l.resolution),t.invalidated=!0),r instanceof fc&&!r.fixedScale&&void 0!==l.scale&&r.scale!==l.scale&&(r.scale=l.scale,t.invalidated=!0),r}}function Mc(e,t){const n=e.cachedStats[t],{area:i,isEmptyArea:o,areaUnit:a}=n,s=[];if(i){const e=o?"Area: Oblique not supported":`Area: ${ws(i)} ${a}`;s.push(e)}return s}(_c=Sc).SplineTypes=bc,_c.Actions=Dc,Sc.toolName="SplineROI";const yc=Sc;var Oc=n(22791),xc=n(47294);function Rc(e,t,n,i){const o=n-t+1,a=Math.floor(i/100*o)??1,s=Math.floor(o/a)??1;if(isNaN(o)||!o||!s)return e;if(o/s<2)return e;const r=Math.max(0,t),l=Math.min(e.length-1,n),d=e.slice(0,r),c=e.slice(l+1,e.length),h=function(e,t){if(!t||0===t.length||t.length===e.length)return e;const n=t[t.length-1]-t[0]+1,i=(0,Oc.nH)(t.map((t=>e[t][0]))),o=(0,Oc.nH)(t.map((t=>e[t][1])));if(a=e,3===a[0]?.length){const a=(0,Oc.nH)(t.map((t=>e[t][2])));return(0,xc.$R)((0,Oc.q$)(i,n),(0,Oc.q$)(o,n),(0,Oc.q$)(a,n))}return(0,xc.$R)((0,Oc.q$)(i,n),(0,Oc.q$)(o,n));var a}(e,function(e,t){const n=[],[i,o]=t,a=o-i+1,s=Math.floor(a/e);let r=0,l=Math.round((a-1)/(s-1)*r)+i;for(;l<=o;)n.push(l),r++,l=Math.round((a-1)/(s-1)*r)+i;return n}(s,[r,l]));return[...d,...h,...c]}function Pc(e){return!0===e?.interpolation?.interpolateOnAdd||!0===e?.interpolation?.interpolateOnEdit}function Nc(e,t,n){return(e+t+n)%t}function Lc(e,t,n,i){const[,o,a]=e,[,s,r]=t,l=a.length,d=r.length;let c=e[0],h=t[0];if(!(a[c]&&r[h]&&a[o]&&r[s]))return[void 0,void 0];for(;c!==o&&h!==s;){if(n(r[h],a[c]))return[c,h];c=Nc(c,l,i),h=Nc(h,d,i)}return[void 0,void 0]}function Ac(e,t){const[n,i]=function(e,t){for(let o=0;o<e.length;o++)for(let a=0;a<t.length;a++)if(n=e[o],i=t[a],0===Ll(n,i))return[o,a];var n,i}(e,t)||[],o=(e,t)=>!1===function(e,t){return Ll(e,t)<.001}(e,t),[a,s]=Lc([Nc(n,e.length,1),n,e],[Nc(i,t.length,1),i,t],o,1),[r]=Lc([Nc(a,e.length,-1),a,e],[Nc(s,t.length,-1),s,t],o,-1);return[a,r]}function kc(e,t,n){const{interpolation:i}=e,o=t;if(i){const{knotsRatioPercentageOnAdd:e,knotsRatioPercentageOnEdit:o,interpolateOnAdd:a=!1,interpolateOnEdit:s=!1}=i,r=n?o:e;if(n?s:a){const[e,i]=n?Ac(t,n):[0,t.length-1];return t[e]&&t[i]?Rc(t,e,i,r):t}}return o}function Uc(e,t){const n=e[0],i=e[e.length-1],o=Oo.K4.create();Oo.K4.set(o,i[0]-n[0],i[1]-n[1]),Oo.K4.normalize(o,o);const a=Oo.K4.create(),s=Oo.K4.create();Oo.K4.set(a,-o[1],o[0]),Oo.K4.set(s,o[1],-o[0]);const r=[(n[0]+i[0])/2,(n[1]+i[1])/2],l={dist:0,index:null};for(let t=0;t<e.length;t++){const n=e[t],i=Oo.K4.dist(n,r);i>l.dist&&(l.dist=i,l.index=t)}return[e[l.index],r].map(t.canvasToWorld)}const{addCanvasPointsToArray:Vc,pointsAreWithinCloseContourProximity:Wc,getFirstIntersectionWithPolyline:Hc,getSubPixelSpacingAndXYDirections:Bc}=O;function Fc(e,t,n){this.isDrawing=!0;const i=e.detail,{currentPoints:o,element:a}=i,s=o.canvas,r=(0,ne.getEnabledElement)(a),{viewport:l}=r,{spacing:d,xDir:c,yDir:h}=Bc(l,this.configuration.subPixelResolution);this.drawData={canvasPoints:[s],polylineIndex:0},this.commonData={annotation:t,viewportIdsToRender:n,spacing:d,xDir:c,yDir:h,movingTextBox:!1},Je.isInteractingWithTool=!0,a.addEventListener(re.MOUSE_UP,this.mouseUpDrawCallback),a.addEventListener(re.MOUSE_DRAG,this.mouseDragDrawCallback),a.addEventListener(re.MOUSE_CLICK,this.mouseUpDrawCallback),a.addEventListener(re.TOUCH_END,this.mouseUpDrawCallback),a.addEventListener(re.TOUCH_DRAG,this.mouseDragDrawCallback),a.addEventListener(re.TOUCH_TAP,this.mouseUpDrawCallback),Rr(a)}function Gc(e){Je.isInteractingWithTool=!1,e.removeEventListener(re.MOUSE_UP,this.mouseUpDrawCallback),e.removeEventListener(re.MOUSE_DRAG,this.mouseDragDrawCallback),e.removeEventListener(re.MOUSE_CLICK,this.mouseUpDrawCallback),e.removeEventListener(re.TOUCH_END,this.mouseUpDrawCallback),e.removeEventListener(re.TOUCH_DRAG,this.mouseDragDrawCallback),e.removeEventListener(re.TOUCH_TAP,this.mouseUpDrawCallback),xr(e)}function $c(e){const t=e.detail,{currentPoints:n,element:i}=t,o=n.world,a=n.canvas,s=(0,ne.getEnabledElement)(i),{renderingEngine:r,viewport:l}=s,{annotation:d,viewportIdsToRender:c,xDir:h,yDir:g,spacing:u,movingTextBox:m}=this.commonData,{polylineIndex:v,canvasPoints:p}=this.drawData,f=p[p.length-1],E=l.canvasToWorld(f),w=Oo.R3.create();Oo.R3.subtract(w,o,E);const I=Math.abs(Oo.R3.dot(w,h)),C=Math.abs(Oo.R3.dot(w,g));if(!(I<=u[0]&&C<=u[1])){if(m){this.isDrawing=!1;const{deltaPoints:e}=t,n=e.world,{textBox:i}=d.data.handles,{worldPosition:o}=i;o[0]+=n[0],o[1]+=n[1],o[2]+=n[2],i.hasMoved=!0}else{const t=this.findCrossingIndexDuringCreate(e);if(void 0!==t)this.applyCreateOnCross(e,t);else{const e=Vc(i,p,a,this.commonData);this.drawData.polylineIndex=v+e}}cs(r,c)}}function Kc(e){const{allowOpenContours:t}=this.configuration,{canvasPoints:n}=this.drawData,i=n[0],o=n[n.length-1],a=e.detail,{element:s}=a;t&&!Wc(i,o,this.configuration.closeContourProximity)?this.completeDrawOpenContour(s):this.completeDrawClosedContour(s)}function qc(e){this.removeCrossedLinesOnCompleteDraw();const{canvasPoints:t}=this.drawData;if(this.haltDrawing(e,t))return!1;const{annotation:n,viewportIdsToRender:i}=this.commonData,o=(0,ne.getEnabledElement)(e),{viewport:a,renderingEngine:s}=o;Vc(e,t,t[0],this.commonData),t.pop();const r=(Pc(this.configuration)?kc(this.configuration,t):t).map((e=>a.canvasToWorld(e)));n.data.polyline=r,n.data.isOpenContour=!1;const{textBox:l}=n.data.handles;return l.hasMoved||this.triggerAnnotationCompleted(n),this.isDrawing=!1,this.drawData=void 0,this.commonData=void 0,cs(s,i),this.deactivateDraw(e),!0}function zc(){const{canvasPoints:e}=this.drawData,t=e.length,n=[e[0],e[t-1]],i=e.slice(0,-1).slice(1),o=Hc(i,n[0],n[1],!1);if(o){const t=o[1];this.drawData.canvasPoints=e.splice(0,t)}}function jc(e){const{canvasPoints:t}=this.drawData;if(this.haltDrawing(e,t))return!1;const{annotation:n,viewportIdsToRender:i}=this.commonData,o=(0,ne.getEnabledElement)(e),{viewport:a,renderingEngine:s}=o,r=(Pc(this.configuration)?kc(this.configuration,t):t).map((e=>a.canvasToWorld(e)));n.data.polyline=r,n.data.isOpenContour=!0;const{textBox:l}=n.data.handles;return n.data.handles.points=[r[0],r[r.length-1]],n.data.isOpenUShapeContour&&(n.data.openUShapeContourVectorToPeak=Uc(t,a)),l.hasMoved||this.triggerAnnotationCompleted(n),this.isDrawing=!1,this.drawData=void 0,this.commonData=void 0,cs(s,i),this.deactivateDraw(e),!0}function Yc(e){const t=e.detail,{currentPoints:n,lastPoints:i}=t,o=n.canvas,a=i.canvas,{canvasPoints:s}=this.drawData,r=s.slice(0,-1),l=Hc(r,o,a,!1);if(void 0===l)return;return l[0]}function Zc(e,t){const n=e.detail,{element:i}=n,{canvasPoints:o}=this.drawData,{annotation:a,viewportIdsToRender:s}=this.commonData;Vc(i,o,o[t],this.commonData),o.pop();for(let e=0;e<t;e++)o.shift();this.completeDrawClosedContour(i)&&this.activateClosedContourEdit(e,a,s)}function Xc(e){const{allowOpenContours:t}=this.configuration,{canvasPoints:n}=this.drawData,i=n[0],o=n[n.length-1];t&&!Wc(i,o,this.configuration.closeContourProximity)?this.completeDrawOpenContour(e):this.completeDrawClosedContour(e)}function Jc(e,t){const{subPixelResolution:n}=this.configuration;if(function(e,t){const n=Math.max(3*t,3);return e.length<n}(t,n)){const{annotation:t,viewportIdsToRender:n}=this.commonData,i=(0,ne.getEnabledElement)(e),{renderingEngine:o}=i;return dp(t.annotationUID),this.isDrawing=!1,this.drawData=void 0,this.commonData=void 0,cs(o,n),this.deactivateDraw(e),!0}return!1}const Qc=function(e){e.activateDraw=Fc.bind(e),e.deactivateDraw=Gc.bind(e),e.applyCreateOnCross=Zc.bind(e),e.findCrossingIndexDuringCreate=Yc.bind(e),e.completeDrawOpenContour=jc.bind(e),e.removeCrossedLinesOnCompleteDraw=zc.bind(e),e.mouseDragDrawCallback=$c.bind(e),e.mouseUpDrawCallback=Kc.bind(e),e.completeDrawClosedContour=qc.bind(e),e.cancelDrawing=Xc.bind(e),e.haltDrawing=Jc.bind(e)},{addCanvasPointsToArray:eh,getFirstIntersectionWithPolyline:th}=O;function nh(e,t){const n=e.detail,{element:i,currentPoints:o,lastPoints:a}=n,s=o.canvas,r=a.canvas,{editCanvasPoints:l,prevCanvasPoints:d}=this.editData,c=th(d,s,r,t);if(c)this.editData.startCrossingIndex=c[0],this.removePointsUpUntilFirstCrossing(t);else if(d.length>=2)if(l.length>this.configuration.checkCanvasEditFallbackProximity){const e=l[0],t=[];for(let n=0;n<d.length;n++){const i=d[n],o=Oo.K4.distance(i,e);t.push({distance:o,index:n})}t.sort(((e,t)=>e.distance-t.distance));const n=[t[0],t[1]],i=Math.min(n[0].index,n[1].index);this.editData.startCrossingIndex=i}else{const e=Oo.K4.create();Oo.K4.subtract(e,l[1],l[0]),Oo.K4.normalize(e,e);const n=6,o=[l[0][0]-e[0]*n,l[0][1]-e[1]*n],a=th(d,o,l[0],t);if(a){const e=[o];eh(i,e,l[0],this.commonData),l.unshift(...e),this.removePointsUpUntilFirstCrossing(t),this.editData.editIndex=l.length-1,this.editData.startCrossingIndex=a[0]}}}function ih(e){const{editCanvasPoints:t,prevCanvasPoints:n}=this.editData;let i=0;for(let o=0;o<t.length-1;o++){const a=[t[o],t[o+1]];if(i++,!!th(n,a[0],a[1],e))break}t.splice(0,i),this.editData.editIndex=t.length-1}function oh(e,t){const n=e.detail,{currentPoints:i,lastPoints:o}=n,a=i.canvas,s=o.canvas,{prevCanvasPoints:r}=this.editData;return!!th(r,a,s,t)}function ah(e){const{prevCanvasPoints:t,editCanvasPoints:n}=this.editData;for(let i=n.length-1;i>0;i--){const o=[n[i],n[i-1]],a=!!th(t,o[0],o[1],e);if(n.pop(),a)break}}function sh(){const{editCanvasPoints:e,prevCanvasPoints:t,startCrossingIndex:n}=this.editData;if(void 0===n)return;const i=e[e.length-1],o=[];for(let e=0;e<t.length;e++){const n=t[e],a=Oo.K4.distance(n,i);o.push({distance:a,index:e})}o.sort(((e,t)=>e.distance-t.distance));const a=e.slice(0,-1);for(let n=0;n<o.length;n++){const{index:i}=o[n],s=t[i],r=e[e.length-1];if(!th(a,s,r,!1))return i}return-1}function rh(e){const t=e.detail,{currentPoints:n,lastPoints:i}=t,o=n.canvas,a=i.canvas,{editCanvasPoints:s}=this.editData,r=s.slice(0,-2),l=th(r,o,a,!1);if(!l)return;const d=l[0],c=s.length-d;for(let e=0;e<c;e++)s.pop()}const lh=function(e){e.checkForFirstCrossing=nh.bind(e),e.removePointsUpUntilFirstCrossing=ih.bind(e),e.checkForSecondCrossing=oh.bind(e),e.findSnapIndex=sh.bind(e),e.removePointsAfterSecondCrossing=ah.bind(e),e.checkAndRemoveCrossesOnEditLine=rh.bind(e)},{getSubPixelSpacingAndXYDirections:dh,addCanvasPointsToArray:ch,calculateAreaOfPoints:hh}=O;function gh(e,t,n){this.isEditingClosed=!0;const i=e.detail,{currentPoints:o,element:a}=i,s=o.canvas,r=(0,ne.getEnabledElement)(a),{viewport:l}=r,d=t.data.polyline.map(l.worldToCanvas),{spacing:c,xDir:h,yDir:g}=dh(l,this.configuration.subPixelResolution);this.editData={prevCanvasPoints:d,editCanvasPoints:[s],startCrossingIndex:void 0,editIndex:0},this.commonData={annotation:t,viewportIdsToRender:n,spacing:c,xDir:h,yDir:g,movingTextBox:!1},Je.isInteractingWithTool=!0,a.addEventListener(re.MOUSE_UP,this.mouseUpClosedContourEditCallback),a.addEventListener(re.MOUSE_DRAG,this.mouseDragClosedContourEditCallback),a.addEventListener(re.MOUSE_CLICK,this.mouseUpClosedContourEditCallback),a.addEventListener(re.TOUCH_END,this.mouseUpClosedContourEditCallback),a.addEventListener(re.TOUCH_DRAG,this.mouseDragClosedContourEditCallback),a.addEventListener(re.TOUCH_TAP,this.mouseUpClosedContourEditCallback),Rr(a)}function uh(e){Je.isInteractingWithTool=!1,e.removeEventListener(re.MOUSE_UP,this.mouseUpClosedContourEditCallback),e.removeEventListener(re.MOUSE_DRAG,this.mouseDragClosedContourEditCallback),e.removeEventListener(re.MOUSE_CLICK,this.mouseUpClosedContourEditCallback),e.removeEventListener(re.TOUCH_END,this.mouseUpClosedContourEditCallback),e.removeEventListener(re.TOUCH_DRAG,this.mouseDragClosedContourEditCallback),e.removeEventListener(re.TOUCH_TAP,this.mouseUpClosedContourEditCallback),xr(e)}function mh(e){const t=e.detail,{currentPoints:n,element:i}=t,o=n.world,a=n.canvas,s=(0,ne.getEnabledElement)(i),{renderingEngine:r,viewport:l}=s,{viewportIdsToRender:d,xDir:c,yDir:h,spacing:g}=this.commonData,{editIndex:u,editCanvasPoints:m,startCrossingIndex:v}=this.editData,p=m[m.length-1],f=l.canvasToWorld(p),E=Oo.R3.create();Oo.R3.subtract(E,o,f);const w=Math.abs(Oo.R3.dot(E,c)),I=Math.abs(Oo.R3.dot(E,h));if(w<=g[0]&&I<=g[1])return;void 0!==v&&this.checkAndRemoveCrossesOnEditLine(e);const C=u+ch(i,m,a,this.commonData);this.editData.editIndex=C,void 0===v&&m.length>1&&this.checkForFirstCrossing(e,!0),this.editData.snapIndex=this.findSnapIndex(),-1!==this.editData.snapIndex?(this.editData.fusedCanvasPoints=this.fuseEditPointsWithClosedContour(e),void 0!==v&&this.checkForSecondCrossing(e,!0)&&(this.removePointsAfterSecondCrossing(!0),this.finishEditAndStartNewEdit(e)),cs(r,d)):this.finishEditAndStartNewEdit(e)}function vh(e){const t=e.detail,{element:n}=t,i=(0,ne.getEnabledElement)(n),{viewport:o,renderingEngine:a}=i,{annotation:s,viewportIdsToRender:r}=this.commonData,{fusedCanvasPoints:l,editCanvasPoints:d}=this.editData,c=l.map((e=>o.canvasToWorld(e)));s.data.polyline=c,s.data.isOpenContour=!1,this.triggerAnnotationModified(s,i);const h=d.pop();this.editData={prevCanvasPoints:l,editCanvasPoints:[h],startCrossingIndex:void 0,editIndex:0,snapIndex:void 0},cs(a,r)}function ph(e){const{prevCanvasPoints:t,editCanvasPoints:n,startCrossingIndex:i,snapIndex:o}=this.editData;if(void 0===i||void 0===o)return;const a=e.detail,{element:s}=a,r=[...n];let l,d;ch(s,r,t[o],this.commonData),r.length>n.length&&r.pop(),i>o?(l=o,d=i):(l=i,d=o);const c=Oo.K4.distance(t[l],r[0]),h=Oo.K4.distance(t[l],r[r.length-1]),g=Oo.K4.distance(t[d],r[0]),u=Oo.K4.distance(t[d],r[r.length-1]),m=[];for(let e=0;e<l;e++){const n=t[e];m.push([n[0],n[1]])}let v=c+u,p=h+g;if(v<p)for(let e=0;e<r.length;e++){const t=r[e];m.push([t[0],t[1]])}else for(let e=r.length-1;e>=0;e--){const t=r[e];m.push([t[0],t[1]])}for(let e=d;e<t.length;e++){const n=t[e];m.push([n[0],n[1]])}const f=[];for(let e=l;e<d;e++){const n=t[e];f.push([n[0],n[1]])}if(v=g+h,p=u+c,v<p)for(let e=0;e<r.length;e++){const t=r[e];f.push([t[0],t[1]])}else for(let e=r.length-1;e>=0;e--){const t=r[e];f.push([t[0],t[1]])}return hh(m)>hh(f)?m:f}function fh(e){const t=e.detail,{element:n}=t;this.completeClosedContourEdit(n)}function Eh(e){const t=(0,ne.getEnabledElement)(e),{viewport:n,renderingEngine:i}=t,{annotation:o,viewportIdsToRender:a}=this.commonData,{fusedCanvasPoints:s,prevCanvasPoints:r}=this.editData;if(s){const e=(Pc(this.configuration)?kc(this.configuration,s,r):s).map((e=>n.canvasToWorld(e)));o.data.polyline=e,o.data.isOpenContour=!1,o.invalidated=!0,this.triggerAnnotationModified(o,t)}this.isEditingClosed=!1,this.editData=void 0,this.commonData=void 0,cs(i,a),this.deactivateClosedContourEdit(e)}function wh(e){this.completeClosedContourEdit(e)}const Ih=function(e){e.activateClosedContourEdit=gh.bind(e),e.deactivateClosedContourEdit=uh.bind(e),e.mouseDragClosedContourEditCallback=mh.bind(e),e.mouseUpClosedContourEditCallback=fh.bind(e),e.finishEditAndStartNewEdit=vh.bind(e),e.fuseEditPointsWithClosedContour=ph.bind(e),e.cancelClosedContourEdit=wh.bind(e),e.completeClosedContourEdit=Eh.bind(e)},{addCanvasPointsToArray:Ch,getSubPixelSpacingAndXYDirections:_h}=O;function Th(e,t,n){this.isEditingOpen=!0;const i=e.detail,{currentPoints:o,element:a}=i,s=o.canvas,r=(0,ne.getEnabledElement)(a),{viewport:l}=r,d=t.data.polyline.map(l.worldToCanvas),{spacing:c,xDir:h,yDir:g}=_h(l,this.configuration.subPixelResolution);this.editData={prevCanvasPoints:d,editCanvasPoints:[s],startCrossingIndex:void 0,editIndex:0},this.commonData={annotation:t,viewportIdsToRender:n,spacing:c,xDir:h,yDir:g,movingTextBox:!1},Je.isInteractingWithTool=!0,a.addEventListener(re.MOUSE_UP,this.mouseUpOpenContourEditCallback),a.addEventListener(re.MOUSE_DRAG,this.mouseDragOpenContourEditCallback),a.addEventListener(re.MOUSE_CLICK,this.mouseUpOpenContourEditCallback),a.addEventListener(re.TOUCH_END,this.mouseUpOpenContourEditCallback),a.addEventListener(re.TOUCH_DRAG,this.mouseDragOpenContourEditCallback),a.addEventListener(re.TOUCH_TAP,this.mouseUpOpenContourEditCallback),Rr(a)}function bh(e){Je.isInteractingWithTool=!1,e.removeEventListener(re.MOUSE_UP,this.mouseUpOpenContourEditCallback),e.removeEventListener(re.MOUSE_DRAG,this.mouseDragOpenContourEditCallback),e.removeEventListener(re.MOUSE_CLICK,this.mouseUpOpenContourEditCallback),e.removeEventListener(re.TOUCH_END,this.mouseUpOpenContourEditCallback),e.removeEventListener(re.TOUCH_DRAG,this.mouseDragOpenContourEditCallback),e.removeEventListener(re.TOUCH_TAP,this.mouseUpOpenContourEditCallback),xr(e)}function Dh(e){const t=e.detail,{currentPoints:n,element:i}=t,o=n.world,a=n.canvas,s=(0,ne.getEnabledElement)(i),{renderingEngine:r,viewport:l}=s,{viewportIdsToRender:d,xDir:c,yDir:h,spacing:g}=this.commonData,{editIndex:u,editCanvasPoints:m,startCrossingIndex:v}=this.editData,p=m[m.length-1],f=l.canvasToWorld(p),E=Oo.R3.create();Oo.R3.subtract(E,o,f);const w=Math.abs(Oo.R3.dot(E,c)),I=Math.abs(Oo.R3.dot(E,h));if(w<=g[0]&&I<=g[1])return;void 0!==v&&this.checkAndRemoveCrossesOnEditLine(e);const C=u+Ch(i,m,a,this.commonData);this.editData.editIndex=C,void 0===v&&m.length>1&&this.checkForFirstCrossing(e,!1),this.editData.snapIndex=this.findSnapIndex(),this.editData.fusedCanvasPoints=this.fuseEditPointsWithOpenContour(e),void 0!==v&&this.checkForSecondCrossing(e,!1)?(this.removePointsAfterSecondCrossing(!1),this.finishEditOpenOnSecondCrossing(e)):this.checkIfShouldOverwriteAnEnd(e)&&this.openContourEditOverwriteEnd(e),cs(r,d)}function Sh(e){const t=e.detail,{element:n}=t,i=(0,ne.getEnabledElement)(n),{viewport:o}=i,{annotation:a,viewportIdsToRender:s}=this.commonData,r=this.fuseEditPointsForOpenContourEndEdit().map((e=>o.canvasToWorld(e)));a.data.polyline=r,a.data.isOpenContour=!0,a.data.handles.points=[r[0],r[r.length-1]],a.data.handles.activeHandleIndex=1,this.triggerAnnotationModified(a,i),this.isEditingOpen=!1,this.editData=void 0,this.commonData=void 0,this.deactivateOpenContourEdit(n),this.activateOpenContourEndEdit(e,a,s,null)}function Mh(e){const t=e.detail,{currentPoints:n,lastPoints:i}=t,o=n.canvas,a=i.canvas,{snapIndex:s,prevCanvasPoints:r,startCrossingIndex:l}=this.editData;if(void 0===l||void 0===s)return!1;if(-1===s)return!0;if(0!==s&&s!==r.length-1)return!1;const d=o,c=a,h=r[s],g=Oo.K4.create(),u=Oo.K4.create();Oo.K4.set(g,d[0]-c[0],d[1]-c[1]),Oo.K4.set(u,d[0]-h[0],d[1]-h[1]);const m=Oo.K4.dot(g,u),v=Math.sqrt(g[0]*g[0]+g[1]*g[1]),p=Math.sqrt(u[0]*u[0]+u[1]*u[1]);return Math.acos(m/(v*p))<Math.PI/2}function yh(){const{snapIndex:e,prevCanvasPoints:t,editCanvasPoints:n,startCrossingIndex:i}=this.editData,o=[];if(0===e)for(let e=t.length-1;e>=i;e--){const n=t[e];o.push([n[0],n[1]])}else for(let e=0;e<i;e++){const n=t[e];o.push([n[0],n[1]])}if(Oo.K4.distance(t[i],n[0])<Oo.K4.distance(t[i],n[n.length-1]))for(let e=0;e<n.length;e++){const t=n[e];o.push([t[0],t[1]])}else for(let e=n.length-1;e>=0;e--){const t=n[e];o.push([t[0],t[1]])}return o}function Oh(e){const{prevCanvasPoints:t,editCanvasPoints:n,startCrossingIndex:i,snapIndex:o}=this.editData;if(void 0===i||void 0===o)return;const a=e.detail,{element:s}=a,r=[...n];let l,d;Ch(s,r,t[o],this.commonData),r.length>n.length&&r.pop(),i>o?(l=o,d=i):(l=i,d=o);const c=Oo.K4.distance(t[l],r[0]),h=Oo.K4.distance(t[l],r[r.length-1]),g=Oo.K4.distance(t[d],r[0]),u=Oo.K4.distance(t[d],r[r.length-1]),m=[];for(let e=0;e<l;e++){const n=t[e];m.push([n[0],n[1]])}if(c+u<h+g)for(let e=0;e<r.length;e++){const t=r[e];m.push([t[0],t[1]])}else for(let e=r.length-1;e>=0;e--){const t=r[e];m.push([t[0],t[1]])}for(let e=d;e<t.length;e++){const n=t[e];m.push([n[0],n[1]])}return m}function xh(e){const t=e.detail,{element:n}=t,i=(0,ne.getEnabledElement)(n),{viewport:o,renderingEngine:a}=i,{annotation:s,viewportIdsToRender:r}=this.commonData,{fusedCanvasPoints:l,editCanvasPoints:d}=this.editData,c=l.map((e=>o.canvasToWorld(e)));s.data.polyline=c,s.data.isOpenContour=!0,s.data.handles.points=[c[0],c[c.length-1]],this.triggerAnnotationModified(s,i);const h=d.pop();this.editData={prevCanvasPoints:l,editCanvasPoints:[h],startCrossingIndex:void 0,editIndex:0},cs(a,r)}function Rh(e){const t=e.detail,{element:n}=t;this.completeOpenContourEdit(n)}function Ph(e){const t=(0,ne.getEnabledElement)(e),{viewport:n,renderingEngine:i}=t,{annotation:o,viewportIdsToRender:a}=this.commonData,{fusedCanvasPoints:s,prevCanvasPoints:r}=this.editData;if(s){const e=(Pc(this.configuration)?kc(this.configuration,s,r):s).map((e=>n.canvasToWorld(e)));o.data.polyline=e,o.data.isOpenContour=!0,o.data.handles.points=[e[0],e[e.length-1]],o.data.isOpenUShapeContour&&(o.data.openUShapeContourVectorToPeak=Uc(s,n)),o.invalidated=!0,this.triggerAnnotationModified(o,t)}this.isEditingOpen=!1,this.editData=void 0,this.commonData=void 0,cs(i,a),this.deactivateOpenContourEdit(e)}function Nh(e){this.completeOpenContourEdit(e)}const Lh=function(e){e.activateOpenContourEdit=Th.bind(e),e.deactivateOpenContourEdit=bh.bind(e),e.mouseDragOpenContourEditCallback=Dh.bind(e),e.mouseUpOpenContourEditCallback=Rh.bind(e),e.fuseEditPointsWithOpenContour=Oh.bind(e),e.finishEditOpenOnSecondCrossing=xh.bind(e),e.checkIfShouldOverwriteAnEnd=Mh.bind(e),e.fuseEditPointsForOpenContourEndEdit=yh.bind(e),e.openContourEditOverwriteEnd=Sh.bind(e),e.cancelOpenContourEdit=Nh.bind(e),e.completeOpenContourEdit=Ph.bind(e)},{getSubPixelSpacingAndXYDirections:Ah}=O;function kh(e,t,n,i){this.isDrawing=!0;const o=e.detail,{element:a}=o,s=(0,ne.getEnabledElement)(a),{viewport:r}=s,{spacing:l,xDir:d,yDir:c}=Ah(r,this.configuration.subPixelResolution),h=t.data.polyline.map(r.worldToCanvas);0===t.data.handles.activeHandleIndex&&h.reverse();let g=!1;i.worldPosition&&(g=!0),this.drawData={canvasPoints:h,polylineIndex:h.length-1},this.commonData={annotation:t,viewportIdsToRender:n,spacing:l,xDir:d,yDir:c,movingTextBox:g},Je.isInteractingWithTool=!0,a.addEventListener(re.MOUSE_UP,this.mouseUpDrawCallback),a.addEventListener(re.MOUSE_DRAG,this.mouseDragDrawCallback),a.addEventListener(re.MOUSE_CLICK,this.mouseUpDrawCallback),a.addEventListener(re.TOUCH_END,this.mouseUpDrawCallback),a.addEventListener(re.TOUCH_DRAG,this.mouseDragDrawCallback),a.addEventListener(re.TOUCH_TAP,this.mouseUpDrawCallback),Rr(a)}const Uh=function(e){e.activateOpenContourEndEdit=kh.bind(e)},{pointsAreWithinCloseContourProximity:Vh}=O;function Wh(e,t){const n={toolGroupId:this.toolGroupId,toolName:this.getToolName(),viewportId:e.viewport.id,annotationUID:t.annotationUID},i=this.getStyle("lineWidth",n,t),o=this.getStyle("lineDash",n,t),a=this.getStyle("color",n,t);return{color:void 0===a?void 0:a,width:void 0===i?void 0:i,lineDash:void 0===o?void 0:o,connectLastToFirst:!t.data.isOpenContour}}function Hh(e,t,n){e?.viewport?.getImageData()&&(n.data.isOpenContour?n.data.isOpenUShapeContour?(!function(e,t){t.data.openUShapeContourVectorToPeak||(t.data.openUShapeContourVectorToPeak=function(e,t){const{viewport:n}=e;return Uc(t.data.polyline.map(n.worldToCanvas),n)}(e,t))}(e,n),this.renderOpenUShapedContour(e,t,n)):this.renderOpenContour(e,t,n):this.renderClosedContour(e,t,n))}function Bh(e,t,n){const{viewport:i}=e,o=this._getRenderingOptions(e,n),a=n.data.polyline.map((e=>i.worldToCanvas(e)));qo(t,n.annotationUID,"1",a,o)}function Fh(e,t,n){const{viewport:i}=e,o=this._getRenderingOptions(e,n),a=n.data.polyline.map((e=>i.worldToCanvas(e)));qo(t,n.annotationUID,"1",a,o);const s=n.data.handles.activeHandleIndex;if(!0===this.configuration.alwaysRenderOpenContourHandles?.enabled){const e=this.configuration.alwaysRenderOpenContourHandles.radius,i="0",r=[a[0],a[a.length-1]];0===s?r.shift():1===s&&r.pop(),$o(t,n.annotationUID,i,r,{color:o.color,handleRadius:e})}if(null!==s){const e="1",i=a[0===s?0:a.length-1];$o(t,n.annotationUID,e,[i],{color:o.color})}}function Gh(e,t,n){const{viewport:i}=e,{polyline:o,openUShapeContourVectorToPeak:a}=n.data;if(this.renderOpenContour(e,t,n),!a)return;const s=i.worldToCanvas(o[0]),r=i.worldToCanvas(o[o.length-1]),l=[i.worldToCanvas(a[0]),i.worldToCanvas(a[1])],d=this._getRenderingOptions(e,n);qo(t,n.annotationUID,"first-to-last",[s,r],{color:d.color,width:d.width,connectLastToFirst:!1,lineDash:"2,2"}),qo(t,n.annotationUID,"midpoint-to-open-contour",[l[0],l[1]],{color:d.color,width:d.width,connectLastToFirst:!1,lineDash:"2,2"})}function $h(e,t,n){const i=this._getRenderingOptions(e,n),{allowOpenContours:o}=this.configuration,{canvasPoints:a}=this.drawData;if(i.connectLastToFirst=!1,qo(t,n.annotationUID,"1",a,i),o){const e=a[0],o=a[a.length-1];if(Vh(e,o,this.configuration.closeContourProximity))qo(t,n.annotationUID,"2",[o,e],i);else{const o="0";$o(t,n.annotationUID,o,[e],{color:i.color,handleRadius:2})}}}function Kh(e,t,n){const{fusedCanvasPoints:i}=this.editData;if(void 0===i)return void this.renderClosedContour(e,t,n);const o=this._getRenderingOptions(e,n);qo(t,n.annotationUID,"preview-1",i,o)}function qh(e,t,n){const{fusedCanvasPoints:i}=this.editData;if(void 0===i)return void this.renderOpenContour(e,t,n);const o=this._getRenderingOptions(e,n);qo(t,n.annotationUID,"preview-1",i,o)}const zh=function(e){e.renderContour=Hh.bind(e),e.renderClosedContour=Bh.bind(e),e.renderOpenContour=Fh.bind(e),e.renderOpenUShapedContour=Gh.bind(e),e.renderContourBeingDrawn=$h.bind(e),e.renderClosedContourBeingEdited=Kh.bind(e),e.renderOpenContourBeingEdited=qh.bind(e),e._getRenderingOptions=Wh.bind(e)},{pointCanProjectOnLine:jh}=O,{EPSILON:Yh}=ne.CONSTANTS,Zh=1-Yh;class Xh extends Ca{constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"],configuration:{shadow:!0,preventHandleOutsideImage:!1,alwaysRenderOpenContourHandles:{enabled:!1,radius:2},allowOpenContours:!0,closeContourProximity:10,checkCanvasEditFallbackProximity:6,subPixelResolution:4,interpolation:{interpolateOnAdd:!1,interpolateOnEdit:!1,knotsRatioPercentageOnAdd:40,knotsRatioPercentageOnEdit:40},calculateStats:!1,getTextLines:Jh,statsCalculator:Rl}}){super(e,t),this.isDrawing=!1,this.isEditingClosed=!1,this.isEditingOpen=!1,this.addNewAnnotation=e=>{const t=e.detail,{currentPoints:n,element:i}=t,o=n.world,a=(0,ne.getEnabledElement)(i),{viewport:s,renderingEngine:r}=a,l=s.getCamera(),{viewPlaneNormal:d,viewUp:c}=l,h=this.getReferencedImageId(s,o,d,c),g=Cl(i,this.getToolName()),u=s.getFrameOfReferenceUID(),m={highlighted:!0,invalidated:!0,metadata:{viewPlaneNormal:[...d],viewUp:[...c],FrameOfReferenceUID:u,referencedImageId:h,toolName:this.getToolName()},data:{handles:{points:[],activeHandleIndex:null,textBox:{hasMoved:!1,worldPosition:[0,0,0],worldBoundingBox:{topLeft:[0,0,0],topRight:[0,0,0],bottomLeft:[0,0,0],bottomRight:[0,0,0]}}},polyline:[[...o]],label:"",cachedStats:{}}};return rp(m,i),this.activateDraw(e,m,g),e.preventDefault(),cs(r,g),m},this.handleSelectedCallback=(e,t,n)=>{const i=e.detail,{element:o}=i,a=Cl(o,this.getToolName());this.activateOpenContourEndEdit(e,t,a,n)},this.toolSelectedCallback=(e,t)=>{const n=e.detail,{element:i}=n,o=Cl(i,this.getToolName());t.data.isOpenContour?this.activateOpenContourEdit(e,t,o):this.activateClosedContourEdit(e,t,o)},this.isPointNearTool=(e,t,n,i)=>{const o=(0,ne.getEnabledElement)(e),{viewport:a}=o,s=t.data.polyline;let r=a.worldToCanvas(s[0]);for(let e=1;e<s.length;e++){const t=r,o=a.worldToCanvas(s[e]);if(!0===jh(n,t,o,i))return!0;r=o}if(t.data.isOpenContour)return!1;const l=a.worldToCanvas(s[0]),d=a.worldToCanvas(s[s.length-1]);return!0===jh(n,l,d,i)},this.cancel=e=>{const t=this.isDrawing,n=this.isEditingOpen,i=this.isEditingClosed;t?this.cancelDrawing(e):n?this.cancelOpenContourEdit(e):i&&this.cancelClosedContourEdit(e)},this.triggerAnnotationModified=(e,t)=>{const{viewportId:n,renderingEngineId:i}=t,o=re.ANNOTATION_MODIFIED,a={annotation:e,viewportId:n,renderingEngineId:i};(0,ne.triggerEvent)(ne.eventTarget,o,a)},this.triggerAnnotationCompleted=e=>{const t=re.ANNOTATION_COMPLETED,n={annotation:e};(0,ne.triggerEvent)(ne.eventTarget,t,n)},this.renderAnnotation=(e,t)=>{let n=!1;const{viewport:i,renderingEngine:o}=e,{element:a}=i,s=this.getTargetId(i);let r=sp(this.getToolName(),a);if(!r?.length)return n;if(r=this.filterInteractableAnnotationsForElement(a,r),!r?.length)return n;const l=this.isDrawing,d=this.isEditingOpen,c=this.isEditingClosed;if(l||d||c){const i=this.commonData.annotation.annotationUID;r.forEach((n=>{if(n.annotationUID===i)if(l)this.renderContourBeingDrawn(e,t,n);else if(c)this.renderClosedContourBeingEdited(e,t,n);else{if(!d)throw new Error(`Unknown ${this.getToolName()} annotation rendering state`);this.renderOpenContourBeingEdited(e,t,n)}else this.renderContour(e,t,n)})),n=!0}else r.forEach((n=>{this.renderContour(e,t,n)}));return this.configuration.calculateStats?(r.forEach((n=>{const a=this.commonData?.annotation.annotationUID;if(n.annotationUID!==a||this.commonData?.movingTextBox){if(!this.commonData?.movingTextBox){const{data:t}=n;t.cachedStats[s]&&null!=t.cachedStats[s].areaUnit?n.invalidated&&this._throttledCalculateCachedStats(n,i,o,e):(t.cachedStats[s]={Modality:null,area:null,max:null,mean:null,stdDev:null,areaUnit:null},this._calculateCachedStats(n,i,o,e))}this._renderStats(n,i,e,t)}})),n):void 0},this._calculateCachedStats=(e,t,n,i)=>{const o=e.data,{cachedStats:a,polyline:s}=o,r=Object.keys(a);for(let i=0;i<r.length;i++){const o=r[i],l=this.getTargetIdImage(o,n);if(!l)continue;const{imageData:d,metadata:c}=l,h=s.map((e=>t.worldToCanvas(e))),g=h[0],u=t.canvasToWorld(g),m=t.canvasToWorld([g[0]+1,g[1]]),v=t.canvasToWorld([g[0],g[1]+1]),p=Oo.R3.distance(u,m),f=Oo.R3.distance(u,v),E=ss(l);let w=jl(h)/E/E;w*=p*f;const I=ne.utilities.transformWorldToIndex(d,s[0]);I[0]=Math.floor(I[0]),I[1]=Math.floor(I[1]),I[2]=Math.floor(I[2]);let C=I[0],_=I[0],T=I[1],b=I[1],D=I[2],S=I[2];for(let e=1;e<s.length;e++){const t=ne.utilities.transformWorldToIndex(d,s[e]);t[0]=Math.floor(t[0]),t[1]=Math.floor(t[1]),t[2]=Math.floor(t[2]),C=Math.min(C,t[0]),_=Math.max(_,t[0]),T=Math.min(T,t[1]),b=Math.max(b,t[1]),D=Math.min(D,t[2]),S=Math.max(S,t[2])}const M=.01*(_-C),y=.01*(b-T),O=.01*(S-D);C=Math.floor(C-M),_=Math.ceil(_+M),T=Math.floor(T-y),b=Math.ceil(b+y),D=Math.floor(D-O),S=Math.ceil(S+O);const x=[[C,_],[T,b],[D,S]],R=d.indexToWorld([_,b,S]),P=t.worldToCanvas(R);let N=0,L=[],A=0;const k=us(d,((e,n)=>{let i=!0;const o=t.worldToCanvas(e);return o[1]!=N&&(A=0,N=o[1],L=kl(h,o,[P[0],o[1]]),L.sort((function(e,t){return e[0]===t[0]?0:e[0]<t[0]?-1:1}))),L.length&&o[0]>L[0][0]&&(L.shift(),A++),A%2==0&&(i=!1),i}),this.configuration.statsCalculator.statsCallback,x),U={isPreScaled:jd(t,o),isSuvScaled:this.isSuvScaled(t,o,e.metadata.referencedImageId)},V=zd(c.Modality,e.metadata.referencedImageId,U),W=this.configuration.statsCalculator.getStatistics();a[o]={Modality:c.Modality,area:w,mean:W[1]?.value,max:W[0]?.value,stdDev:W[3]?.value,statsArray:W,pointsInShape:k,areaUnit:as(null,l),modalityUnit:V}}return this.triggerAnnotationModified(e,i),e.invalidated=!1,a},this._renderStats=(e,t,n,i)=>{const o=e.data,a=this.getTargetId(t),s={toolGroupId:this.toolGroupId,toolName:this.getToolName(),viewportId:n.viewport.id},r=this.getLinkedTextBoxStyle(s,e);if(!r.visibility)return;const l=this.configuration.getTextLines(o,a);if(!l||0===l.length)return;const d=o.polyline.map((e=>t.worldToCanvas(e)));if(!o.handles.textBox.hasMoved){const e=Vd(d);o.handles.textBox.worldPosition=t.canvasToWorld(e)}const c=t.worldToCanvas(o.handles.textBox.worldPosition),h=Jo(i,e.annotationUID??"","1",l,c,d,{},r),{x:g,y:u,width:m,height:v}=h;o.handles.textBox.worldBoundingBox={topLeft:t.canvasToWorld([g,u]),topRight:t.canvasToWorld([g+m,u]),bottomLeft:t.canvasToWorld([g,u+v]),bottomRight:t.canvasToWorld([g+m,u+v])}},Qc(this),lh(this),Ih(this),Lh(this),Uh(this),zh(this),this._throttledCalculateCachedStats=qa(this._calculateCachedStats,100,{trailing:!0})}filterInteractableAnnotationsForElement(e,t){if(!t||!t.length)return;const n=(0,ne.getEnabledElement)(e),{viewport:i}=n;let o;if(i instanceof ne.VolumeViewport){const e=i.getCamera(),{spacingInNormalDirection:n}=ne.utilities.getTargetVolumeAndSpacingInNormalDir(i,e);o=this.filterAnnotationsWithinSlice(t,e,n)}else o=ua(i,t);return o}filterAnnotationsWithinSlice(e,t,n){const{viewPlaneNormal:i}=t,o=e.filter((e=>{const t=e.metadata.viewPlaneNormal,n=Math.abs(Oo.R3.dot(i,t))>Zh;return t&&n}));if(!o.length)return[];const a=n/2,{focalPoint:s}=t,r=[];for(const e of o){const t=e.data.polyline[0];if(!e.isVisible)continue;const n=Oo.R3.create();Oo.R3.sub(n,s,t);const o=Oo.R3.dot(n,i);Math.abs(o)<a&&r.push(e)}return r}}function Jh(e,t){const n=e.cachedStats[t],{area:i,mean:o,stdDev:a,max:s,isEmptyArea:r,areaUnit:l,modalityUnit:d}=n,c=[];if(i){const e=r?"Area: Oblique not supported":`Area: ${ws(i)} ${l}`;c.push(e)}return o&&c.push(`Mean: ${ws(o)} ${d}`),s&&c.push(`Max: ${ws(s)} ${d}`),a&&c.push(`Std Dev: ${ws(a)} ${d}`),c}Xh.toolName="PlanarFreehandROI";const Qh=Xh;class eg{constructor({numBits:e,getPriority:t,areEqual:n}){this._bucketCount=1<<e,this._mask=this._bucketCount-1,this._size=0,this._currentBucketIndex=0,this._buckets=this._buildArray(this._bucketCount),this._getPriority=void 0!==t?t:e=>e,this._areEqual="function"==typeof n?n:(e,t)=>e===t}push(e){const t=this._getBucketIndex(e),n={value:e,next:this._buckets[t]};this._buckets[t]=n,this._size++}pop(){if(0===this._size)throw new Error("Cannot pop because the queue is empty.");for(;null===this._buckets[this._currentBucketIndex];)this._currentBucketIndex=(this._currentBucketIndex+1)%this._bucketCount;const e=this._buckets[this._currentBucketIndex];return this._buckets[this._currentBucketIndex]=e.next,this._size--,e.value}remove(e){if(!e)return!1;const t=this._getBucketIndex(e),n=this._buckets[t];let i,o=n;for(;null!==o&&!this._areEqual(e,o.value);)i=o,o=o.next;return null!==o&&(o===n?this._buckets[t]=o.next:i.next=o.next,this._size--,!0)}isEmpty(){return 0===this._size}_getBucketIndex(e){return this._getPriority(e)&this._mask}_buildArray(e){const t=new Array(e);return t.fill(null),t}}const tg=4294967295,ng=2/(3*Math.PI);class ig{constructor(e,t,n){this._getPointIndex=(e,t)=>{const{width:n}=this;return e*n+t},this._getPointCoordinate=e=>[e%this.width,Math.floor(e/this.width)],this._getPointCost=e=>Math.round(this.searchGranularity*this.costs[e]);const i=e.length;this.searchGranularityBits=8,this.searchGranularity=1<<this.searchGranularityBits,this.width=t,this.height=n,this.grayscalePixelData=e,this.laplace=null,this.gradXNew=null,this.gradYNew=null,this.laplace=this._computeLaplace(),this.gradMagnitude=this._computeGradient(),this.gradXNew=this._computeGradientX(),this.gradYNew=this._computeGradientY(),this.visited=new Array(i),this.parents=new Uint32Array(i),this.costs=new Float32Array(i)}startSearch(e){const t=this._getPointIndex(e[1],e[0]);this.startPoint=null,this.visited.fill(!1),this.parents.fill(tg),this.costs.fill(1/0),this.priorityQueueNew=new eg({numBits:this.searchGranularityBits,getPriority:this._getPointCost}),this.startPoint=e,this.costs[t]=0,this.priorityQueueNew.push(t)}findPathToPoint(e){if(!this.startPoint)throw new Error("There is no search in progress");const{startPoint:t,_getPointIndex:n,_getPointCoordinate:i}=this,o=n(t[1],t[0]),a=n(e[1],e[0]),{visited:s,parents:r,costs:l,priorityQueueNew:d}=this;if(a===o)return[];for(;!d.isEmpty()&&r[a]===tg;){const e=d.pop();if(s[e])continue;const t=i(e),o=this._getNeighborPoints(t);s[e]=!0;for(let i=0,a=o.length;i<a;i++){const a=o[i],s=n(a[1],a[0]),c=this._getWeightedDistance(t,a),h=l[e]+c;h<l[s]&&(l[s]!==1/0&&d.remove(s),l[s]=h,r[s]=e,d.push(s))}}const c=[];let h=a;for(;h!==tg;)c.push(i(h)),h=r[h];return c.reverse()}_getDeltaX(e,t){const{grayscalePixelData:n,width:i}=this;let o=this._getPointIndex(t,e);return e+1===i&&o--,n[o+1]-n[o]}_getDeltaY(e,t){const{grayscalePixelData:n,width:i,height:o}=this;let a=this._getPointIndex(t,e);return t+1===o&&(a-=o),n[a]-n[a+i]}_getGradientMagnitude(e,t){const n=this._getDeltaX(e,t),i=this._getDeltaY(e,t);return Math.sqrt(n*n+i*i)}_getLaplace(e,t){const{grayscalePixelData:n,_getPointIndex:i}=this;let o=n[i(t-2,e)];return o+=n[i(t-1,e-1)]+2*n[i(t-1,e)]+n[i(t-1,e+1)],o+=n[i(t,e-2)]+2*n[i(t,e-1)]-16*n[i(t,e)]+2*n[i(t,e+1)]+n[i(t,e+2)],o+=n[i(t+1,e-1)]+2*n[i(t+1,e)]+n[i(t+1,e+1)],o+=n[i(t+2,e)],o}_computeGradient(){const{width:e,height:t}=this,n=new Float32Array(e*t);let i=0,o=0,a=0,s=0;for(s=0;s<t-1;s++){for(a=0;a<e-1;a++)n[i]=this._getGradientMagnitude(a,s),o=Math.max(n[i],o),i++;n[i]=n[i-1],i++}for(let t=n.length;i<t;i++)n[i]=n[i-e];for(let e=0,t=n.length;e<t;e++)n[e]=1-n[e]/o;return n}_computeLaplace(){const{width:e,height:t,_getPointIndex:n}=this,i=new Float32Array(e*t);i.fill(1,0,n(2,0));for(let o=2;o<t-2;o++){i[n(o,0)]=1,i[n(o,1)]=1;for(let t=2;t<e-2;t++)i[n(o,t)]=this._getLaplace(t,o)>.33?0:1;i[n(o,e-2)]=1,i[n(o,e-1)]=1}return i.fill(1,n(t-2,0)),i}_computeGradientX(){const{width:e,height:t}=this,n=new Float32Array(e*t);let i=0;for(let o=0;o<t;o++){for(let t=0;t<e-1;t++)n[i++]=this._getDeltaX(t,o);n[i]=n[i-1],i++}return n}_computeGradientY(){const{width:e,height:t}=this,n=new Float32Array(e*t);let i=0;for(let o=0;o<t-1;o++)for(let t=0;t<e;t++)n[i++]=this._getDeltaY(t,o);for(let t=n.length;i<t;i++)n[i]=n[i-e];return n}_getGradientUnitVector(e,t){const{gradXNew:n,gradYNew:i,_getPointIndex:o}=this,a=n[o(t,e)],s=i[o(t,e)];let r=Math.sqrt(a*a+s*s);return r=Math.max(r,1e-100),[a/r,s/r]}_getGradientDirection(e,t,n,i){const o=this._getGradientUnitVector(e,t),a=this._getGradientUnitVector(n,i);let s=o[1]*(n-e)-o[0]*(i-t),r=a[1]*(n-e)-a[0]*(i-t);return s<0&&(s=-s,r=-r),e!==n&&t!==i&&(s*=Math.SQRT1_2,r*=Math.SQRT1_2),ng*(Math.acos(s)+Math.acos(r))}_getWeightedDistance(e,t){const{_getPointIndex:n}=this,[i,o]=e,[a,s]=t,r=n(s,a);let l=this.gradMagnitude[r];i!==a&&o!==s||(l*=Math.SQRT1_2);return.43*l+.43*this.laplace[r]+.11*this._getGradientDirection(i,o,a,s)}_getNeighborPoints(e){const{width:t,height:n}=this,i=[],o=Math.max(e[0]-1,0),a=Math.max(e[1]-1,0),s=Math.min(e[0]+1,t-1),r=Math.min(e[1]+1,n-1);for(let t=a;t<=r;t++)for(let n=o;n<=s;n++)n===e[0]&&t===e[1]||i.push([n,t]);return i}static createInstanceFromRawPixelData(e,t,n,i){const o=e.length,a=new Float32Array(o),{lower:s,upper:r}=i,l=r-s;for(let t=0,n=e.length;t<n;t++)a[t]=Math.max(0,Math.min(1,(e[t]-s)/l));return new ig(a,t,n)}static createInstanceFromRGBAPixelData(e,t,n){const i=e.length/4,o=new Float32Array(i);for(let t=0,n=0;t<i;t++,n+=4){const i=e[n],a=e[n],s=e[n];o[t]=.00130718954248366*(i+a+s)}return new ig(o,t,n)}}class og{constructor(e,t){this.pointArray=e?e.slice():[],this._controlPointIndexes=t?t.slice():[]}getPoint(e){return this.pointArray[e]}getLastPoint(){return this.pointArray[this.pointArray.length-1]}isControlPoint(e){const t=this.pointArray.indexOf(e);if(-1!==t)return-1!==this._controlPointIndexes.indexOf(t);throw new Error("Error: isControlPoint called with not in list point.")}addPoint(e){this.pointArray.push(e)}addControlPoint(e){const t=this.pointArray.indexOf(e);if(-1===t)throw new Error("Cannot mark a non registered point as control point.");this._controlPointIndexes.push(t)}getControlPoints(){return this._controlPointIndexes.map((e=>this.pointArray[e]))}getNumControlPoints(){return this._controlPointIndexes.length}removeLastControlPoint(){this._controlPointIndexes.length&&this._controlPointIndexes.pop()}addPoints(e){this.pointArray=this.pointArray.concat(e)}prependPath(e){const t=e.pointArray.length,n=[];this.pointArray=e.pointArray.concat(this.pointArray);for(let e=0;e<this._controlPointIndexes.length;++e)n[e]=this._controlPointIndexes[e]+t;this._controlPointIndexes=e._controlPointIndexes.concat(n)}}class ag extends Ca{constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"],configuration:{preventHandleOutsideImage:!1}}){super(e,t),this.isHandleOutsideImage=!1,this.addNewAnnotation=e=>{const t=e.detail,{currentPoints:n,element:i}=t,{world:o,canvas:a}=n,s=(0,ne.getEnabledElement)(i),{viewport:r,renderingEngine:l}=s;this.isDrawing=!0;const d=r.getCamera(),{viewPlaneNormal:c,viewUp:h}=d,g=this.getReferencedImageId(r,o,c,h),u=r.getFrameOfReferenceUID(),m=r.getDefaultActor();if(!m||!ne.utilities.isImageActor(m))throw new Error("Default actor must be an image actor");const v=r.getImageData(),{imageData:p}=v;let f,E,w,I,C;if(r instanceof ne.StackViewport)w=v.scalarData,I=v.dimensions[0],C=v.dimensions[1],f=e=>{const t=ne.utilities.transformWorldToIndex(p,e);return[t[0],t[1]]},E=e=>ne.utilities.transformIndexToWorld(p,[e[0],e[1],0]);else{if(!(r instanceof ne.VolumeViewport))throw new Error("Viewport not supported");{const e=ne.utilities.getCurrentVolumeViewportSlice(r),{sliceToIndexMatrix:t,indexToSliceMatrix:n}=e;f=e=>{const t=ne.utilities.transformWorldToIndex(p,e),i=Oo.R3.transformMat4([0,0,0],t,n);return[i[0],i[1]]},E=e=>{const n=Oo.R3.transformMat4([0,0,0],[e[0],e[1],0],t);return ne.utilities.transformIndexToWorld(p,n)},w=e.scalarData,I=e.width,C=e.height}}const{voiRange:_}=r.getProperties(),T=f(o);this.scissors=ig.createInstanceFromRawPixelData(w,I,C,_),this.scissors.startSearch(T);const b=new og,D=new og;b.addPoint(T),b.addControlPoint(T);const S={highlighted:!0,invalidated:!0,metadata:{toolName:this.getToolName(),viewPlaneNormal:[...c],viewUp:[...h],FrameOfReferenceUID:u,referencedImageId:g},data:{polyline:[],handles:{points:[[...o]],activeHandleIndex:null}}};rp(S,i);const M=Cl(i,this.getToolName());return this.editData={annotation:S,viewportIdsToRender:M,newAnnotation:!0,hasMoved:!1,lastCanvasPoint:a,confirmedPath:b,currentPath:D,closed:!1,worldToSlice:f,sliceToWorld:E},this._activateDraw(i),e.preventDefault(),cs(l,M),S},this.isPointNearTool=(e,t,n,i)=>{const o=(0,ne.getEnabledElement)(e),{viewport:a}=o,s=i*i,r=t.data.polyline.map((e=>a.worldToCanvas(e)));let l=r[r.length-1];for(let e=0;e<r.length;e++){const t=r[e];if(Xl(l,t,n)<=s)return!0;l=t}return!1},this.toolSelectedCallback=(e,t)=>{const n=e.detail,{element:i}=n;t.highlighted=!0;const o=Cl(i,this.getToolName());this.editData={annotation:t,viewportIdsToRender:o};const a=(0,ne.getEnabledElement)(i),{renderingEngine:s}=a;this._activateModify(i),cs(s,o),e.preventDefault()},this.handleSelectedCallback=(e,t,n)=>{const i=e.detail,{element:o}=i,{data:a}=t;t.highlighted=!0;const{points:s}=a.handles,r=s.findIndex((e=>e===n)),l=Cl(o,this.getToolName());this.editData={annotation:t,viewportIdsToRender:l,handleIndex:r},this._activateModify(o);const d=(0,ne.getEnabledElement)(o),{renderingEngine:c}=d;cs(c,l),e.preventDefault()},this._endCallback=e=>{const t=e.detail,{element:n}=t,{annotation:i,viewportIdsToRender:o,newAnnotation:a}=this.editData,{data:s}=i;s.handles.activeHandleIndex=null,this._deactivateModify(n),this._deactivateDraw(n),xr(n);const r=(0,ne.getEnabledElement)(n),{renderingEngine:l}=r;if(this.isHandleOutsideImage&&this.configuration.preventHandleOutsideImage&&dp(i.annotationUID),cs(l,o),a){const e=re.ANNOTATION_COMPLETED,t={annotation:i};(0,ne.triggerEvent)(ne.eventTarget,e,t)}this.editData=null,this.scissors=null,this.isDrawing=!1},this._mouseDownCallback=e=>{const t=e.type===re.MOUSE_DOUBLE_CLICK,{annotation:n,viewportIdsToRender:i,worldToSlice:o,sliceToWorld:a}=this.editData;if(this.editData.closed)return;const s=e.detail,{element:r}=s,{currentPoints:l}=s,{canvas:d,world:c}=l,h=(0,ne.getEnabledElement)(r),{viewport:g,renderingEngine:u}=h,m=this.editData.currentPath.getControlPoints();let v=m.length>=2&&t;if(m.length>=2){const e={index:-1,distSquared:1/0};for(let t=0,n=m.length;t<n;t++){const n=a(m[t]),i=Nl(d,g.worldToCanvas(n));i<=100&&i<e.distSquared&&(e.distSquared=i,e.index=t)}0===e.index&&(v=!0)}this.editData.closed=this.editData.closed||v,this.editData.confirmedPath=this.editData.currentPath,this.editData.confirmedPath.addControlPoint(this.editData.currentPath.getLastPoint()),this.scissors.startSearch(o(c)),n.invalidated=!0,cs(u,i),this.editData.closed&&(this._updateAnnotation(r,this.editData.confirmedPath),this._endCallback(e)),e.preventDefault()},this._mouseMoveCallback=e=>{const{element:t,currentPoints:n}=e.detail,{world:i,canvas:o}=n,{renderingEngine:a}=(0,ne.getEnabledElement)(t),s=Cl(t,this.getToolName());this.editData.lastCanvasPoint=o;const{width:r,height:l}=this.scissors,{worldToSlice:d}=this.editData,c=d(i);if(c[0]<0||c[1]<0||c[0]>=r||c[1]>=l)return;const h=this.scissors.findPathToPoint(c),g=new og;for(let e=0,t=h.length;e<t;e++)g.addPoint(h[e]);g.prependPath(this.editData.confirmedPath),this.editData.currentPath=g,cs(a,s),e.preventDefault()},this._dragCallback=e=>{this.isDrawing=!0;const t=e.detail,{element:n}=t,{annotation:i,viewportIdsToRender:o,handleIndex:a}=this.editData,{data:s}=i;if(void 0===a){const{deltaPoints:e}=t,n=e.world;s.polyline.forEach((e=>{e[0]+=n[0],e[1]+=n[1],e[2]+=n[2]})),i.invalidated=!0}else{const{currentPoints:e}=t,n=e.world;s.handles.points[a]=[...n],i.invalidated=!0}this.editData.hasMoved=!0;const r=(0,ne.getEnabledElement)(n),{renderingEngine:l}=r;cs(l,o)},this.cancel=e=>{if(!this.isDrawing)return;this.isDrawing=!1,this._deactivateDraw(e),this._deactivateModify(e),xr(e);const{annotation:t,viewportIdsToRender:n,newAnnotation:i}=this.editData;i&&dp(t.annotationUID);const o=(0,ne.getEnabledElement)(e),{renderingEngine:a}=o;return cs(a,n),this.editData=null,this.scissors=null,t.annotationUID},this.triggerAnnotationModified=(e,t)=>{const{viewportId:n,renderingEngineId:i}=t,o=re.ANNOTATION_MODIFIED,a={annotation:e,viewportId:n,renderingEngineId:i};(0,ne.triggerEvent)(ne.eventTarget,o,a)},this._activateModify=e=>{Je.isInteractingWithTool=!0,e.addEventListener(re.MOUSE_UP,this._endCallback),e.addEventListener(re.MOUSE_DRAG,this._dragCallback),e.addEventListener(re.MOUSE_CLICK,this._endCallback),e.addEventListener(re.TOUCH_END,this._endCallback),e.addEventListener(re.TOUCH_DRAG,this._dragCallback),e.addEventListener(re.TOUCH_TAP,this._endCallback)},this._deactivateModify=e=>{Je.isInteractingWithTool=!1,e.removeEventListener(re.MOUSE_UP,this._endCallback),e.removeEventListener(re.MOUSE_DRAG,this._dragCallback),e.removeEventListener(re.MOUSE_CLICK,this._endCallback),e.removeEventListener(re.TOUCH_END,this._endCallback),e.removeEventListener(re.TOUCH_DRAG,this._dragCallback),e.removeEventListener(re.TOUCH_TAP,this._endCallback)},this._activateDraw=e=>{Je.isInteractingWithTool=!0,e.addEventListener(re.MOUSE_MOVE,this._mouseMoveCallback),e.addEventListener(re.MOUSE_DOWN,this._mouseDownCallback),e.addEventListener(re.MOUSE_DOUBLE_CLICK,this._mouseDownCallback),e.addEventListener(re.TOUCH_TAP,this._mouseDownCallback)},this._deactivateDraw=e=>{Je.isInteractingWithTool=!1,e.removeEventListener(re.MOUSE_MOVE,this._mouseMoveCallback),e.removeEventListener(re.MOUSE_DOWN,this._mouseDownCallback),e.removeEventListener(re.MOUSE_DOUBLE_CLICK,this._mouseDownCallback),e.removeEventListener(re.TOUCH_TAP,this._mouseDownCallback)},this.renderAnnotation=(e,t)=>{let n=!1;const{viewport:i}=e,{worldToCanvas:o}=i,{element:a}=i;if(!i.getRenderingEngine())return console.warn("Rendering Engine has been destroyed"),n;let s=sp(this.getToolName(),a);if(!s?.length)return n;if(s=this.filterInteractableAnnotationsForElement(a,s),!s?.length)return n;const r=this.editData?.newAnnotation,l={toolGroupId:this.toolGroupId,toolName:this.getToolName(),viewportId:e.viewport.id};this._updateAnnotation(a,this.editData?.currentPath);for(let e=0;e<s.length;e++){const a=s[e],{annotationUID:d,data:c}=a,{handles:h}=c,{points:g}=h;l.annotationUID=d;const u=this.getStyle("lineWidth",l,a),m=this.getStyle("lineDash",l,a),v=this.getStyle("color",l,a),p=g.map((e=>o(e)));if(!He(d))continue;if(r&&a.annotationUID===this.editData?.annotation?.annotationUID){$o(t,d,"0",[p[0]],{color:v,lineDash:m,lineWidth:u})}qo(t,d,"polyline",c.polyline.map((e=>i.worldToCanvas(e))),{color:v,lineDash:m,lineWidth:u}),n=!0,a.invalidated=!1}return n}}_updateAnnotation(e,t){if(!this.editData||!t)return;const{pointArray:n}=t,i=[],{sliceToWorld:o}=this.editData;for(let e=0,t=n.length;e<t;e++){const t=o(n[e]);i.push(t)}i.length>1&&i.push([...i[0]]),this.editData.annotation.data.polyline=i}}ag.toolName="LivewireContour";const sg=ag;class rg extends Ca{constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"],configuration:{shadow:!0,getTextCallback:lg,changeTextCallback:dg,preventHandleOutsideImage:!1,arrowFirst:!0}}){super(e,t),this.addNewAnnotation=e=>{const t=e.detail,{currentPoints:n,element:i}=t,o=n.world,a=(0,ne.getEnabledElement)(i),{viewport:s,renderingEngine:r}=a;Rr(i),this.isDrawing=!0;const l=s.getCamera(),{viewPlaneNormal:d,viewUp:c}=l,h=this.getReferencedImageId(s,o,d,c),{arrowFirst:g}=this.configuration,u=s.getFrameOfReferenceUID(),m={highlighted:!0,invalidated:!0,metadata:{toolName:this.getToolName(),viewPlaneNormal:[...d],viewUp:[...c],FrameOfReferenceUID:u,referencedImageId:h},data:{text:"",handles:{points:[[...o],[...o]],activeHandleIndex:null,arrowFirst:g,textBox:{hasMoved:!1,worldPosition:[0,0,0],worldBoundingBox:{topLeft:[0,0,0],topRight:[0,0,0],bottomLeft:[0,0,0],bottomRight:[0,0,0]}}},label:""}};rp(m,i);const v=Cl(i,this.getToolName());return this.editData={annotation:m,viewportIdsToRender:v,handleIndex:1,movingTextBox:!1,newAnnotation:!0,hasMoved:!1},this._activateDraw(i),e.preventDefault(),cs(r,v),m},this.isPointNearTool=(e,t,n,i)=>{const o=(0,ne.getEnabledElement)(e),{viewport:a}=o,{data:s}=t,[r,l]=s.handles.points,d=a.worldToCanvas(r),c=a.worldToCanvas(l),h={start:{x:d[0],y:d[1]},end:{x:c[0],y:c[1]}};return Jl([h.start.x,h.start.y],[h.end.x,h.end.y],[n[0],n[1]])<=i},this.toolSelectedCallback=(e,t)=>{const n=e.detail,{element:i}=n;t.highlighted=!0;const o=Cl(i,this.getToolName());this.editData={annotation:t,viewportIdsToRender:o,movingTextBox:!1},this._activateModify(i),Rr(i);const a=(0,ne.getEnabledElement)(i),{renderingEngine:s}=a;cs(s,o),e.preventDefault()},this._endCallback=e=>{const t=e.detail,{element:n}=t,{annotation:i,viewportIdsToRender:o,newAnnotation:a,hasMoved:s}=this.editData,{data:r}=i;if(a&&!s)return;r.handles.activeHandleIndex=null,this._deactivateModify(n),this._deactivateDraw(n),xr(n);const l=(0,ne.getEnabledElement)(n),{viewportId:d,renderingEngineId:c,renderingEngine:h}=l;if(this.isHandleOutsideImage&&this.configuration.preventHandleOutsideImage&&dp(i.annotationUID),a)this.configuration.getTextCallback((e=>{if(!e)return dp(i.annotationUID),cs(h,o),this.editData=null,void(this.isDrawing=!1);i.data.text=e;const t=re.ANNOTATION_COMPLETED,n={annotation:i};(0,ne.triggerEvent)(ne.eventTarget,t,n),cs(h,o)}));else{const e=re.ANNOTATION_MODIFIED,t={annotation:i,viewportId:d,renderingEngineId:c};(0,ne.triggerEvent)(ne.eventTarget,e,t)}this.editData=null,this.isDrawing=!1},this._dragCallback=e=>{this.isDrawing=!0;const t=e.detail,{element:n}=t,{annotation:i,viewportIdsToRender:o,handleIndex:a,movingTextBox:s}=this.editData,{data:r}=i;if(s){const{deltaPoints:e}=t,n=e.world,{textBox:i}=r.handles,{worldPosition:o}=i;o[0]+=n[0],o[1]+=n[1],o[2]+=n[2],i.hasMoved=!0}else if(void 0===a){const{deltaPoints:e}=t,n=e.world;r.handles.points.forEach((e=>{e[0]+=n[0],e[1]+=n[1],e[2]+=n[2]})),i.invalidated=!0}else{const{currentPoints:e}=t,n=e.world;r.handles.points[a]=[...n],i.invalidated=!0}this.editData.hasMoved=!0;const l=(0,ne.getEnabledElement)(n),{renderingEngine:d}=l;cs(d,o)},this.touchTapCallback=e=>{2==e.detail.taps&&this.doubleClickCallback(e)},this.doubleClickCallback=e=>{const t=e.detail,{element:n}=t;let i=sp(this.getToolName(),n);if(i=this.filterInteractableAnnotationsForElement(n,i),!i?.length)return;const o=i.find((e=>this.isPointNearTool(n,e,t.currentPoints.canvas,6)));if(!o)return;const a=o;this.configuration.changeTextCallback(o,e.detail,this._doneChangingTextCallback.bind(this,n,a)),this.editData=null,this.isDrawing=!1,e.stopImmediatePropagation(),e.preventDefault()},this.cancel=e=>{if(this.isDrawing){this.isDrawing=!1,this._deactivateDraw(e),this._deactivateModify(e),xr(e);const{annotation:t,viewportIdsToRender:n,newAnnotation:i}=this.editData,{data:o}=t;t.highlighted=!1,o.handles.activeHandleIndex=null;const a=(0,ne.getEnabledElement)(e),{renderingEngine:s}=a;if(cs(s,n),i){const e=re.ANNOTATION_COMPLETED,n={annotation:t};(0,ne.triggerEvent)(ne.eventTarget,e,n)}return this.editData=null,t.annotationUID}},this._activateModify=e=>{Je.isInteractingWithTool=!0,e.addEventListener(re.MOUSE_UP,this._endCallback),e.addEventListener(re.MOUSE_DRAG,this._dragCallback),e.addEventListener(re.MOUSE_CLICK,this._endCallback),e.addEventListener(re.TOUCH_TAP,this._endCallback),e.addEventListener(re.TOUCH_END,this._endCallback),e.addEventListener(re.TOUCH_DRAG,this._dragCallback)},this._deactivateModify=e=>{Je.isInteractingWithTool=!1,e.removeEventListener(re.MOUSE_UP,this._endCallback),e.removeEventListener(re.MOUSE_DRAG,this._dragCallback),e.removeEventListener(re.MOUSE_CLICK,this._endCallback),e.removeEventListener(re.TOUCH_TAP,this._endCallback),e.removeEventListener(re.TOUCH_DRAG,this._dragCallback),e.removeEventListener(re.TOUCH_END,this._endCallback)},this._activateDraw=e=>{Je.isInteractingWithTool=!0,e.addEventListener(re.MOUSE_UP,this._endCallback),e.addEventListener(re.MOUSE_DRAG,this._dragCallback),e.addEventListener(re.MOUSE_MOVE,this._dragCallback),e.addEventListener(re.MOUSE_CLICK,this._endCallback),e.addEventListener(re.TOUCH_TAP,this._endCallback),e.addEventListener(re.TOUCH_END,this._endCallback),e.addEventListener(re.TOUCH_DRAG,this._dragCallback)},this._deactivateDraw=e=>{Je.isInteractingWithTool=!1,e.removeEventListener(re.MOUSE_UP,this._endCallback),e.removeEventListener(re.MOUSE_DRAG,this._dragCallback),e.removeEventListener(re.MOUSE_MOVE,this._dragCallback),e.removeEventListener(re.MOUSE_CLICK,this._endCallback),e.removeEventListener(re.TOUCH_TAP,this._endCallback),e.removeEventListener(re.TOUCH_END,this._endCallback),e.removeEventListener(re.TOUCH_DRAG,this._dragCallback)},this.renderAnnotation=(e,t)=>{let n=!1;const{viewport:i}=e,{element:o}=i;let a=sp(this.getToolName(),o);if(!a?.length)return n;if(a=this.filterInteractableAnnotationsForElement(o,a),!a?.length)return n;const s={toolGroupId:this.toolGroupId,toolName:this.getToolName(),viewportId:e.viewport.id};for(let e=0;e<a.length;e++){const o=a[e],{annotationUID:r,data:l}=o,{handles:d,text:c}=l,{points:h,activeHandleIndex:g}=d;s.annotationUID=r;const u=this.getStyle("lineWidth",s,o),m=this.getStyle("lineDash",s,o),v=this.getStyle("color",s,o),p=h.map((e=>i.worldToCanvas(e)));let f;if(we(o)||this.editData||null===g||(f=[p[g]]),f){$o(t,r,"0",p,{color:v,lineWidth:u})}const E="1";if(this.configuration.arrowFirst?ea(t,r,E,p[1],p[0],{color:v,width:u,lineDash:m}):ea(t,r,E,p[0],p[1],{color:v,width:u,lineDash:m}),n=!0,!i.getRenderingEngine())return console.warn("Rendering Engine has been destroyed"),n;if(!c)continue;const w=this.getLinkedTextBoxStyle(s,o);if(!w.visibility){l.handles.textBox={hasMoved:!1,worldPosition:[0,0,0],worldBoundingBox:{topLeft:[0,0,0],topRight:[0,0,0],bottomLeft:[0,0,0],bottomRight:[0,0,0]}};continue}if(!l.handles.textBox.hasMoved){const e=p[1];l.handles.textBox.worldPosition=i.canvasToWorld(e)}const I=i.worldToCanvas(l.handles.textBox.worldPosition),C=Jo(t,r,"1",[c],I,p,{},w),{x:_,y:T,width:b,height:D}=C;l.handles.textBox.worldBoundingBox={topLeft:i.canvasToWorld([_,T]),topRight:i.canvasToWorld([_+b,T]),bottomLeft:i.canvasToWorld([_,T+D]),bottomRight:i.canvasToWorld([_+b,T+D])}}return n}}handleSelectedCallback(e,t,n){const i=e.detail,{element:o}=i,{data:a}=t;t.highlighted=!0;let s,r=!1;n.worldPosition?r=!0:s=a.handles.points.findIndex((e=>e===n));const l=Cl(o,this.getToolName());this.editData={annotation:t,viewportIdsToRender:l,handleIndex:s,movingTextBox:r},this._activateModify(o),Rr(o);const d=(0,ne.getEnabledElement)(o),{renderingEngine:c}=d;cs(c,l),e.preventDefault()}_doneChangingTextCallback(e,t,n){t.data.text=n;const{renderingEngine:i,viewportId:o,renderingEngineId:a}=(0,ne.getEnabledElement)(e),s=Cl(e,this.getToolName());cs(i,s);const r=re.ANNOTATION_MODIFIED;(0,ne.triggerEvent)(ne.eventTarget,r,{annotation:t,viewportId:o,renderingEngineId:a})}_isInsideVolume(e,t,n){return ne.utilities.indexWithinDimensions(e,n)&&ne.utilities.indexWithinDimensions(t,n)}}function lg(e){return e(prompt("Enter your annotation:"))}function dg(e,t,n){return n(prompt("Enter your annotation:"))}rg.toolName="ArrowAnnotate";const cg=rg;class hg extends Ca{constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"],configuration:{shadow:!0,preventHandleOutsideImage:!1,getTextLines:gg}}){super(e,t),this.addNewAnnotation=e=>{if(this.angleStartedNotYetCompleted)return;this.angleStartedNotYetCompleted=!0;const t=e.detail,{currentPoints:n,element:i}=t,o=n.world,a=(0,ne.getEnabledElement)(i),{viewport:s,renderingEngine:r}=a;Rr(i),this.isDrawing=!0;const l=s.getCamera(),{viewPlaneNormal:d,viewUp:c}=l,h=this.getReferencedImageId(s,o,d,c),g=s.getFrameOfReferenceUID(),u={highlighted:!0,invalidated:!0,metadata:{toolName:this.getToolName(),viewPlaneNormal:[...d],viewUp:[...c],FrameOfReferenceUID:g,referencedImageId:h},data:{handles:{points:[[...o],[...o]],activeHandleIndex:null,textBox:{hasMoved:!1,worldPosition:[0,0,0],worldBoundingBox:{topLeft:[0,0,0],topRight:[0,0,0],bottomLeft:[0,0,0],bottomRight:[0,0,0]}}},label:"",cachedStats:{}}};rp(u,i);const m=Cl(i,this.getToolName());return this.editData={annotation:u,viewportIdsToRender:m,handleIndex:1,movingTextBox:!1,newAnnotation:!0,hasMoved:!1},this._activateDraw(i),e.preventDefault(),cs(r,m),u},this.isPointNearTool=(e,t,n,i)=>{const o=(0,ne.getEnabledElement)(e),{viewport:a}=o,{data:s}=t,[r,l,d]=s.handles.points,c=a.worldToCanvas(r),h=a.worldToCanvas(l),g={start:{x:c[0],y:c[1]},end:{x:h[0],y:h[1]}};if(Jl([g.start.x,g.start.y],[g.end.x,g.end.y],[n[0],n[1]])<=i)return!0;if(!d)return!1;const u=a.worldToCanvas(d),m={start:{x:h[0],y:h[1]},end:{x:u[0],y:u[1]}};return Jl([m.start.x,m.start.y],[m.end.x,m.end.y],[n[0],n[1]])<=i},this.toolSelectedCallback=(e,t)=>{const n=e.detail,{element:i}=n;t.highlighted=!0;const o=Cl(i,this.getToolName());this.editData={annotation:t,viewportIdsToRender:o,movingTextBox:!1},this._activateModify(i),Rr(i);const a=(0,ne.getEnabledElement)(i),{renderingEngine:s}=a;cs(s,o),e.preventDefault()},this._endCallback=e=>{const t=e.detail,{element:n}=t,{annotation:i,viewportIdsToRender:o,newAnnotation:a,hasMoved:s}=this.editData,{data:r}=i;if(a&&!s)return;if(this.angleStartedNotYetCompleted&&2===r.handles.points.length)return void(this.editData.handleIndex=2);this.angleStartedNotYetCompleted=!1,r.handles.activeHandleIndex=null,this._deactivateModify(n),this._deactivateDraw(n),xr(n);const l=(0,ne.getEnabledElement)(n),{renderingEngine:d}=l;if(this.isHandleOutsideImage&&this.configuration.preventHandleOutsideImage&&dp(i.annotationUID),cs(d,o),a){const e=re.ANNOTATION_COMPLETED,t={annotation:i};(0,ne.triggerEvent)(ne.eventTarget,e,t)}this.editData=null,this.isDrawing=!1},this._dragCallback=e=>{this.isDrawing=!0;const t=e.detail,{element:n}=t,{annotation:i,viewportIdsToRender:o,handleIndex:a,movingTextBox:s}=this.editData,{data:r}=i;if(s){const{deltaPoints:e}=t,n=e.world,{textBox:i}=r.handles,{worldPosition:o}=i;o[0]+=n[0],o[1]+=n[1],o[2]+=n[2],i.hasMoved=!0}else if(void 0===a){const{deltaPoints:e}=t,n=e.world;r.handles.points.forEach((e=>{e[0]+=n[0],e[1]+=n[1],e[2]+=n[2]})),i.invalidated=!0}else{const{currentPoints:e}=t,n=e.world;r.handles.points[a]=[...n],i.invalidated=!0}this.editData.hasMoved=!0;const l=(0,ne.getEnabledElement)(n),{renderingEngine:d}=l;cs(d,o)},this.cancel=e=>{if(this.isDrawing){this.isDrawing=!1,this._deactivateDraw(e),this._deactivateModify(e),xr(e);const{annotation:t,viewportIdsToRender:n,newAnnotation:i}=this.editData,{data:o}=t;t.highlighted=!1,o.handles.activeHandleIndex=null;const a=(0,ne.getEnabledElement)(e),{renderingEngine:s}=a;if(cs(s,n),i){const e=re.ANNOTATION_COMPLETED,n={annotation:t};(0,ne.triggerEvent)(ne.eventTarget,e,n)}return this.editData=null,this.angleStartedNotYetCompleted=!1,t.annotationUID}},this._activateModify=e=>{Je.isInteractingWithTool=!0,e.addEventListener(re.MOUSE_UP,this._endCallback),e.addEventListener(re.MOUSE_DRAG,this._dragCallback),e.addEventListener(re.MOUSE_CLICK,this._endCallback),e.addEventListener(re.TOUCH_TAP,this._endCallback),e.addEventListener(re.TOUCH_END,this._endCallback),e.addEventListener(re.TOUCH_DRAG,this._dragCallback)},this._deactivateModify=e=>{Je.isInteractingWithTool=!1,e.removeEventListener(re.MOUSE_UP,this._endCallback),e.removeEventListener(re.MOUSE_DRAG,this._dragCallback),e.removeEventListener(re.MOUSE_CLICK,this._endCallback),e.removeEventListener(re.TOUCH_TAP,this._endCallback),e.removeEventListener(re.TOUCH_END,this._endCallback),e.removeEventListener(re.TOUCH_DRAG,this._dragCallback)},this._activateDraw=e=>{Je.isInteractingWithTool=!0,e.addEventListener(re.MOUSE_UP,this._endCallback),e.addEventListener(re.MOUSE_DRAG,this._dragCallback),e.addEventListener(re.MOUSE_MOVE,this._dragCallback),e.addEventListener(re.MOUSE_CLICK,this._endCallback),e.addEventListener(re.TOUCH_TAP,this._endCallback),e.addEventListener(re.TOUCH_END,this._endCallback),e.addEventListener(re.TOUCH_DRAG,this._dragCallback)},this._deactivateDraw=e=>{Je.isInteractingWithTool=!1,e.removeEventListener(re.MOUSE_UP,this._endCallback),e.removeEventListener(re.MOUSE_DRAG,this._dragCallback),e.removeEventListener(re.MOUSE_MOVE,this._dragCallback),e.removeEventListener(re.MOUSE_CLICK,this._endCallback),e.removeEventListener(re.TOUCH_TAP,this._endCallback),e.removeEventListener(re.TOUCH_END,this._endCallback),e.removeEventListener(re.TOUCH_DRAG,this._dragCallback)},this.renderAnnotation=(e,t)=>{let n=!1;const{viewport:i}=e,{element:o}=i;let a=sp(this.getToolName(),o);if(!a?.length)return n;if(a=this.filterInteractableAnnotationsForElement(o,a),!a?.length)return n;const s=this.getTargetId(i),r=i.getRenderingEngine(),l={toolGroupId:this.toolGroupId,toolName:this.getToolName(),viewportId:e.viewport.id};for(let o=0;o<a.length;o++){const d=a[o],{annotationUID:c,data:h}=d,{points:g,activeHandleIndex:u}=h.handles;l.annotationUID=c;const m=this.getStyle("lineWidth",l,d),v=this.getStyle("lineDash",l,d),p=this.getStyle("color",l,d),f=g.map((e=>i.worldToCanvas(e)));let E;if(h.cachedStats[s]&&null!=h.cachedStats[s].angle?d.invalidated&&this._throttledCalculateCachedStats(d,r,e):(h.cachedStats[s]={angle:null},this._calculateCachedStats(d,r,e)),we(d)||this.editData||null===u||(E=[f[u]]),!i.getRenderingEngine())return console.warn("Rendering Engine has been destroyed"),n;if(E){$o(t,c,"0",f,{color:p,lineDash:v,lineWidth:m})}let w="1";if(Ko(t,c,w,f[0],f[1],{color:p,width:m,lineDash:v}),n=!0,3!==f.length)return n;if(w="2",Ko(t,c,w,f[1],f[2],{color:p,width:m,lineDash:v}),!h.cachedStats[s]?.angle)continue;const I=this.getLinkedTextBoxStyle(l,d);if(!I.visibility){h.handles.textBox={hasMoved:!1,worldPosition:[0,0,0],worldBoundingBox:{topLeft:[0,0,0],topRight:[0,0,0],bottomLeft:[0,0,0],bottomRight:[0,0,0]}};continue}const C=this.configuration.getTextLines(h,s);if(!h.handles.textBox.hasMoved){const e=f[1];h.handles.textBox.worldPosition=i.canvasToWorld(e)}const _=i.worldToCanvas(h.handles.textBox.worldPosition),T=Jo(t,c,"1",C,_,f,{},I),{x:b,y:D,width:S,height:M}=T;h.handles.textBox.worldBoundingBox={topLeft:i.canvasToWorld([b,D]),topRight:i.canvasToWorld([b+S,D]),bottomLeft:i.canvasToWorld([b,D+M]),bottomRight:i.canvasToWorld([b+S,D+M])}}return n},this._throttledCalculateCachedStats=qa(this._calculateCachedStats,100,{trailing:!0})}handleSelectedCallback(e,t,n){const i=e.detail,{element:o}=i,{data:a}=t;t.highlighted=!0;let s,r=!1;n.worldPosition?r=!0:s=a.handles.points.findIndex((e=>e===n));const l=Cl(o,this.getToolName());this.editData={annotation:t,viewportIdsToRender:l,handleIndex:s,movingTextBox:r},this._activateModify(o),Rr(o);const d=(0,ne.getEnabledElement)(o),{renderingEngine:c}=d;cs(c,l),e.preventDefault()}_calculateCachedStats(e,t,n){const i=e.data,{viewportId:o,renderingEngineId:a}=n;if(3!==i.handles.points.length)return;const s=i.handles.points[0],r=i.handles.points[1],l=i.handles.points[2],{cachedStats:d}=i,c=Object.keys(d);for(let e=0;e<c.length;e++){const t=c[e],n=Zr([s,r],[r,l]);d[t]={angle:isNaN(n)?"Incomplete Angle":n}}e.invalidated=!1;const h=re.ANNOTATION_MODIFIED,g={annotation:e,viewportId:o,renderingEngineId:a};return(0,ne.triggerEvent)(ne.eventTarget,h,g),d}}function gg(e,t){const n=e.cachedStats[t],{angle:i}=n;if(void 0===i)return;return[`${ws(i)} ${String.fromCharCode(176)}`]}hg.toolName="Angle";const ug=hg,mg=(...e)=>{const t=2===e[0].length?[0,0]:[0,0,0],n=e.length;for(const i of e)t[0]+=i[0]/n,t[1]+=i[1]/n,3===t.length&&(t[2]+=i[2]/n);return t},vg=mg;class pg extends Ca{constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"],configuration:{shadow:!0,preventHandleOutsideImage:!1,getTextLines:fg}}){super(e,t),this.addNewAnnotation=e=>{if(this.angleStartedNotYetCompleted)return;this.angleStartedNotYetCompleted=!0;const t=e.detail,{currentPoints:n,element:i}=t,o=n.world,a=(0,ne.getEnabledElement)(i),{viewport:s,renderingEngine:r}=a;Rr(i),this.isDrawing=!0;const l=s.getCamera(),{viewPlaneNormal:d,viewUp:c}=l,h=this.getReferencedImageId(s,o,d,c),g=s.getFrameOfReferenceUID(),u={highlighted:!0,invalidated:!0,metadata:{toolName:this.getToolName(),viewPlaneNormal:[...d],viewUp:[...c],FrameOfReferenceUID:g,referencedImageId:h},data:{handles:{points:[[...o],[...o]],activeHandleIndex:null,textBox:{hasMoved:!1,worldPosition:[0,0,0],worldBoundingBox:{topLeft:[0,0,0],topRight:[0,0,0],bottomLeft:[0,0,0],bottomRight:[0,0,0]}}},label:"",cachedStats:{}}};rp(u,i);const m=Cl(i,this.getToolName());return this.editData={annotation:u,viewportIdsToRender:m,handleIndex:1,movingTextBox:!1,newAnnotation:!0,hasMoved:!1},this._activateDraw(i),e.preventDefault(),cs(r,m),u},this.isPointNearTool=(e,t,n,i)=>{const o=(0,ne.getEnabledElement)(e),{viewport:a}=o,{data:s}=t,{distanceToPoint:r,distanceToPoint2:l}=this.distanceToLines({viewport:a,points:s.handles.points,canvasCoords:n,proximity:i});return r<=i||l<=i},this.toolSelectedCallback=(e,t,n,i,o=6)=>{const a=e.detail,{element:s}=a;t.highlighted=!0;const r=Cl(s,this.getToolName()),l=(0,ne.getEnabledElement)(s),{renderingEngine:d,viewport:c}=l,{isNearFirstLine:h,isNearSecondLine:g}=this.distanceToLines({viewport:c,points:t.data.handles.points,canvasCoords:i,proximity:o});this.editData={annotation:t,viewportIdsToRender:r,movingTextBox:!1,isNearFirstLine:h,isNearSecondLine:g},this._activateModify(s),Rr(s),cs(d,r),e.preventDefault()},this._mouseUpCallback=e=>{const t=e.detail,{element:n}=t,{annotation:i,viewportIdsToRender:o,newAnnotation:a,hasMoved:s}=this.editData,{data:r}=i;if(a&&!s)return;if(this.angleStartedNotYetCompleted&&r.handles.points.length<4)return xr(n),void(this.editData.handleIndex=r.handles.points.length);this.angleStartedNotYetCompleted=!1,r.handles.activeHandleIndex=null,this._deactivateModify(n),this._deactivateDraw(n),xr(n);const l=(0,ne.getEnabledElement)(n),{renderingEngine:d}=l;if(this.isHandleOutsideImage&&this.configuration.preventHandleOutsideImage&&dp(i.annotationUID),cs(d,o),a){const e=re.ANNOTATION_COMPLETED,t={annotation:i};(0,ne.triggerEvent)(ne.eventTarget,e,t)}this.editData=null,this.isDrawing=!1},this._mouseDownCallback=e=>{const{annotation:t,handleIndex:n}=this.editData,i=e.detail,{element:o,currentPoints:a}=i,s=a.world,{data:r}=t;return 1===n?(r.handles.points[1]=s,void(this.editData.hasMoved=r.handles.points[1][0]!==r.handles.points[0][0]||r.handles.points[1][1]!==r.handles.points[0][0])):3===n?(r.handles.points[3]=s,this.editData.hasMoved=r.handles.points[3][0]!==r.handles.points[2][0]||r.handles.points[3][1]!==r.handles.points[2][0],void(this.angleStartedNotYetCompleted=!1)):(this.editData.hasMoved=!1,Rr(o),r.handles.points[2]=r.handles.points[3]=s,void(this.editData.handleIndex=r.handles.points.length-1))},this._mouseDragCallback=e=>{this.isDrawing=!0;const t=e.detail,{element:n}=t,{annotation:i,viewportIdsToRender:o,handleIndex:a,movingTextBox:s,isNearFirstLine:r,isNearSecondLine:l}=this.editData,{data:d}=i;if(s){const{deltaPoints:e}=t,n=e.world,{textBox:i}=d.handles,{worldPosition:o}=i;o[0]+=n[0],o[1]+=n[1],o[2]+=n[2],i.hasMoved=!0}else if(void 0===a&&(r||l)){const{deltaPoints:e}=t,n=e.world,o=d.handles.points;if(r){[o[0],o[1]].forEach((e=>{e[0]+=n[0],e[1]+=n[1],e[2]+=n[2]}))}else if(l){[o[2],o[3]].forEach((e=>{e[0]+=n[0],e[1]+=n[1],e[2]+=n[2]}))}i.invalidated=!0}else{const{currentPoints:e}=t,n=e.world;d.handles.points[a]=[...n],i.invalidated=!0}this.editData.hasMoved=!0;const c=(0,ne.getEnabledElement)(n),{renderingEngine:h}=c;cs(h,o)},this.cancel=e=>{if(!this.isDrawing)return;this.isDrawing=!1,this._deactivateDraw(e),this._deactivateModify(e),xr(e);const{annotation:t,viewportIdsToRender:n,newAnnotation:i}=this.editData,{data:o}=t;o.handles.points.length<4&&dp(t.annotationUID),t.highlighted=!1,o.handles.activeHandleIndex=null;const a=(0,ne.getEnabledElement)(e),{renderingEngine:s}=a;if(cs(s,n),i){const e=re.ANNOTATION_COMPLETED,n={annotation:t};(0,ne.triggerEvent)(ne.eventTarget,e,n)}return this.editData=null,this.angleStartedNotYetCompleted=!1,t.annotationUID},this._activateModify=e=>{Je.isInteractingWithTool=!0,e.addEventListener(re.MOUSE_UP,this._mouseUpCallback),e.addEventListener(re.MOUSE_DRAG,this._mouseDragCallback),e.addEventListener(re.MOUSE_CLICK,this._mouseUpCallback)},this._deactivateModify=e=>{Je.isInteractingWithTool=!1,e.removeEventListener(re.MOUSE_UP,this._mouseUpCallback),e.removeEventListener(re.MOUSE_DRAG,this._mouseDragCallback),e.removeEventListener(re.MOUSE_CLICK,this._mouseUpCallback)},this._activateDraw=e=>{Je.isInteractingWithTool=!0,e.addEventListener(re.MOUSE_UP,this._mouseUpCallback),e.addEventListener(re.MOUSE_DRAG,this._mouseDragCallback),e.addEventListener(re.MOUSE_MOVE,this._mouseDragCallback),e.addEventListener(re.MOUSE_CLICK,this._mouseUpCallback),e.addEventListener(re.MOUSE_DOWN,this._mouseDownCallback)},this._deactivateDraw=e=>{Je.isInteractingWithTool=!1,e.removeEventListener(re.MOUSE_UP,this._mouseUpCallback),e.removeEventListener(re.MOUSE_DRAG,this._mouseDragCallback),e.removeEventListener(re.MOUSE_MOVE,this._mouseDragCallback),e.removeEventListener(re.MOUSE_CLICK,this._mouseUpCallback),e.removeEventListener(re.MOUSE_DOWN,this._mouseDownCallback)},this.renderAnnotation=(e,t)=>{let n=!1;const{viewport:i}=e,{element:o}=i;let a=sp(this.getToolName(),o);if(!a?.length)return n;if(a=this.filterInteractableAnnotationsForElement(o,a),!a?.length)return n;const s=this.getTargetId(i),r=i.getRenderingEngine(),l={toolGroupId:this.toolGroupId,toolName:this.getToolName(),viewportId:e.viewport.id};for(let o=0;o<a.length;o++){const d=a[o],{annotationUID:c,data:h}=d,{points:g,activeHandleIndex:u}=h.handles;l.annotationUID=c;const m=this.getStyle("lineWidth",l,d),v=this.getStyle("lineDash",l,d),p=this.getStyle("color",l,d),f=g.map((e=>i.worldToCanvas(e)));let E;if(h.cachedStats[s]&&null!=h.cachedStats[s].angle?d.invalidated&&this._throttledCalculateCachedStats(d,r,e):(h.cachedStats[s]={angle:null,arc1Angle:null,arc2Angle:null,points:{world:{arc1Start:null,arc1End:null,arc2Start:null,arc2End:null,arc1Angle:null,arc2Angle:null},canvas:{arc1Start:null,arc1End:null,arc2Start:null,arc2End:null,arc1Angle:null,arc2Angle:null}}},this._calculateCachedStats(d,r,e)),we(d)||this.editData||null===u||(E=[f[u]]),!i.getRenderingEngine())return console.warn("Rendering Engine has been destroyed"),n;if(E){$o(t,c,"0",f,{color:p,lineDash:v,lineWidth:m})}const w=[f[0],f[1]],I=[f[2],f[3]];let C="line1";if(Ko(t,c,C,w[0],w[1],{color:p,width:m,lineDash:v}),n=!0,f.length<4)return n;C="line2",Ko(t,c,C,I[0],I[1],{color:p,width:m,lineDash:v}),C="linkLine";Ko(t,c,C,vg(w[0],w[1]),vg(I[0],I[1]),{color:p,lineWidth:"1",lineDash:"1,4"});const{arc1Start:_,arc1End:T,arc2End:b,arc2Start:D}=h.cachedStats[s].points.canvas,{arc1Angle:S,arc2Angle:M}=h.cachedStats[s];if(C="arc1",Ko(t,c,C,_,T,{color:p,lineWidth:"1"}),C="arc2",Ko(t,c,C,D,b,{color:p,lineWidth:"1"}),!h.cachedStats[s]?.angle)continue;const y=this.getLinkedTextBoxStyle(l,d);if(!y.visibility){h.handles.textBox={hasMoved:!1,worldPosition:[0,0,0],worldBoundingBox:{topLeft:[0,0,0],topRight:[0,0,0],bottomLeft:[0,0,0],bottomRight:[0,0,0]}};continue}const O=this.configuration.getTextLines(h,s);if(!h.handles.textBox.hasMoved){const e=Vd(f);h.handles.textBox.worldPosition=i.canvasToWorld(e)}const x=i.worldToCanvas(h.handles.textBox.worldPosition),R=Jo(t,c,"cobbAngleText",O,x,f,{},y),{x:P,y:N,width:L,height:A}=R;h.handles.textBox.worldBoundingBox={topLeft:i.canvasToWorld([P,N]),topRight:i.canvasToWorld([P+L,N]),bottomLeft:i.canvasToWorld([P,N+A]),bottomRight:i.canvasToWorld([P+L,N+A])};const k="arcAngle1",U=[`${S.toFixed(2)} ${String.fromCharCode(176)}`],V=vg(_,T);Yo(t,c,k,U,V,{...y,padding:3});const W="arcAngle2",H=[`${M.toFixed(2)} ${String.fromCharCode(176)}`],B=vg(D,b);Yo(t,c,W,H,B,{...y,padding:3})}return n},this.distanceToLines=({viewport:e,points:t,canvasCoords:n,proximity:i})=>{const[o,a,s,r]=t,l=e.worldToCanvas(o),d=e.worldToCanvas(a),c=e.worldToCanvas(s),h=e.worldToCanvas(r),g={start:{x:l[0],y:l[1]},end:{x:d[0],y:d[1]}},u={start:{x:c[0],y:c[1]},end:{x:h[0],y:h[1]}},m=Jl([g.start.x,g.start.y],[g.end.x,g.end.y],[n[0],n[1]]),v=Jl([u.start.x,u.start.y],[u.end.x,u.end.y],[n[0],n[1]]);let p=!1,f=!1;return m<=i?p=!0:v<=i&&(f=!0),{distanceToPoint:m,distanceToPoint2:v,isNearFirstLine:p,isNearSecondLine:f}},this.getArcsStartEndPoints=({firstLine:e,secondLine:t,mid1:n,mid2:i})=>{const o=[n,i],a=Zr(e,o),s=Zr(t,o),r=a>90?1:0,l=s>90?0:1,d=vg(o[0],o[1]),c=Math.sqrt((o[1][0]-o[0][0])**2+(o[1][1]-o[0][1])**2),h=.1,g=vg(e[0],e[1]),u=vg(t[0],t[1]),m=[e[r][0]-g[0],e[r][1]-g[1]],v=Math.sqrt(m[0]**2+m[1]**2),p=[m[0]/v,m[1]/v],f=[g[0]+p[0]*c*h,g[1]+p[1]*c*h],E=[d[0]-n[0],d[1]-n[1]],w=Math.sqrt(E[0]**2+E[1]**2),I=[E[0]/w,E[1]/w],C=[n[0]+I[0]*c*h,n[1]+I[1]*c*h],_=[t[l][0]-u[0],t[l][1]-u[1]],T=Math.sqrt(_[0]**2+_[1]**2),b=[_[0]/T,_[1]/T],D=[u[0]+b[0]*c*h,u[1]+b[1]*c*h],S=[d[0]-i[0],d[1]-i[1]],M=Math.sqrt(S[0]**2+S[1]**2),y=[S[0]/M,S[1]/M];return{arc1Start:f,arc1End:C,arc2Start:D,arc2End:[i[0]+y[0]*c*h,i[1]+y[1]*c*h],arc1Angle:a>90?180-a:a,arc2Angle:s>90?180-s:s}},this._throttledCalculateCachedStats=qa(this._calculateCachedStats,25,{trailing:!0})}handleSelectedCallback(e,t,n,i="mouse"){const o=e.detail,{element:a}=o,{data:s}=t;t.highlighted=!0;let r,l=!1;n.worldPosition?l=!0:r=s.handles.points.findIndex((e=>e===n));const d=Cl(a,this.getToolName());this.editData={annotation:t,viewportIdsToRender:d,handleIndex:r,movingTextBox:l},this._activateModify(a),Rr(a);const c=(0,ne.getEnabledElement)(a),{renderingEngine:h}=c;cs(h,d),e.preventDefault()}_calculateCachedStats(e,t,n){const i=e.data,{viewportId:o,renderingEngineId:a}=n;if(4!==i.handles.points.length)return;const s=[null,null],r=[null,null];let l=Number.MAX_VALUE;for(let e=0;e<2;e+=1)for(let t=2;t<4;t+=1){const n=Oo.R3.distance(i.handles.points[e],i.handles.points[t]);n<l&&(l=n,s[1]=i.handles.points[e],s[0]=i.handles.points[(e+1)%2],r[0]=i.handles.points[t],r[1]=i.handles.points[2+(t-1)%2])}const{viewport:d}=n,c=i.handles.points.map((e=>d.worldToCanvas(e))),h=[c[0],c[1]],g=[c[2],c[3]],u=vg(h[0],h[1]),m=vg(g[0],g[1]),{arc1Start:v,arc1End:p,arc2End:f,arc2Start:E,arc1Angle:w,arc2Angle:I}=this.getArcsStartEndPoints({firstLine:h,secondLine:g,mid1:u,mid2:m}),{cachedStats:C}=i,_=Object.keys(C);for(let e=0;e<_.length;e++){C[_[e]]={angle:Zr(s,r),arc1Angle:w,arc2Angle:I,points:{canvas:{arc1Start:v,arc1End:p,arc2End:f,arc2Start:E},world:{arc1Start:d.canvasToWorld(v),arc1End:d.canvasToWorld(p),arc2End:d.canvasToWorld(f),arc2Start:d.canvasToWorld(E)}}}}e.invalidated=!1;const T=re.ANNOTATION_MODIFIED,b={annotation:e,viewportId:o,renderingEngineId:a};return(0,ne.triggerEvent)(ne.eventTarget,T,b),C}}function fg(e,t){const n=e.cachedStats[t],{angle:i}=n;if(void 0===i)return;return[`${i.toFixed(2)} ${String.fromCharCode(176)}`]}pg.toolName="CobbAngle";const Eg=pg,{transformWorldToIndex:wg}=ne.utilities;class Ig extends Ca{constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"],configuration:{shadow:!0,preventHandleOutsideImage:!1,getTextLines:Cg,displayBothAxesDistances:!1}}){super(e,t),this.addNewAnnotation=e=>{if(this.startedDrawing)return;this.startedDrawing=!0;const t=e.detail,{currentPoints:n,element:i}=t,o=n.world,a=(0,ne.getEnabledElement)(i),{viewport:s,renderingEngine:r}=a;if(!(s instanceof ne.StackViewport))throw new Error("UltrasoundDirectionalTool can only be used on a StackViewport");Rr(i),this.isDrawing=!0;const l=s.getCamera(),{viewPlaneNormal:d,viewUp:c}=l,h=this.getReferencedImageId(s,o,d,c),g=s.getFrameOfReferenceUID(),u={highlighted:!0,invalidated:!0,metadata:{toolName:this.getToolName(),viewPlaneNormal:[...d],viewUp:[...c],FrameOfReferenceUID:g,referencedImageId:h},data:{handles:{points:[[...o],[...o]],activeHandleIndex:null,textBox:{hasMoved:!1,worldPosition:[0,0,0],worldBoundingBox:{topLeft:[0,0,0],topRight:[0,0,0],bottomLeft:[0,0,0],bottomRight:[0,0,0]}}},label:"",cachedStats:{}}};rp(u,i);const m=Cl(i,this.getToolName());return this.editData={annotation:u,viewportIdsToRender:m,handleIndex:1,movingTextBox:!1,newAnnotation:!0,hasMoved:!1},this._activateDraw(i),e.preventDefault(),cs(r,m),u},this.isPointNearTool=(e,t,n,i)=>!1,this._endCallback=e=>{const t=e.detail,{element:n}=t,{annotation:i,viewportIdsToRender:o,newAnnotation:a,hasMoved:s}=this.editData,{data:r}=i;if(a&&!s)return;if(this.startedDrawing&&1===r.handles.points.length)return void(this.editData.handleIndex=1);this.startedDrawing=!1,r.handles.activeHandleIndex=null,this._deactivateModify(n),this._deactivateDraw(n),xr(n);const l=(0,ne.getEnabledElement)(n),{renderingEngine:d}=l;if(this.isHandleOutsideImage&&this.configuration.preventHandleOutsideImage&&dp(i.annotationUID),cs(d,o),a){const e=re.ANNOTATION_COMPLETED,t={annotation:i};(0,ne.triggerEvent)(ne.eventTarget,e,t)}this.editData=null,this.isDrawing=!1},this._dragCallback=e=>{this.isDrawing=!0;const t=e.detail,{element:n}=t,{annotation:i,viewportIdsToRender:o,handleIndex:a,movingTextBox:s}=this.editData,{data:r}=i;if(s){const{deltaPoints:e}=t,n=e.world,{textBox:i}=r.handles,{worldPosition:o}=i;o[0]+=n[0],o[1]+=n[1],o[2]+=n[2],i.hasMoved=!0}else if(void 0===a){const{deltaPoints:e}=t,n=e.world;r.handles.points.forEach((e=>{e[0]+=n[0],e[1]+=n[1],e[2]+=n[2]})),i.invalidated=!0}else{const{currentPoints:e}=t,n=e.world;r.handles.points[a]=[...n],i.invalidated=!0}this.editData.hasMoved=!0;const l=(0,ne.getEnabledElement)(n),{renderingEngine:d}=l;cs(d,o)},this.cancel=e=>{if(this.isDrawing){this.isDrawing=!1,this._deactivateDraw(e),this._deactivateModify(e),xr(e);const{annotation:t,viewportIdsToRender:n,newAnnotation:i}=this.editData,{data:o}=t;t.highlighted=!1,o.handles.activeHandleIndex=null;const a=(0,ne.getEnabledElement)(e),{renderingEngine:s}=a;if(cs(s,n),i){const e=re.ANNOTATION_COMPLETED,n={annotation:t};(0,ne.triggerEvent)(ne.eventTarget,e,n)}return this.editData=null,this.startedDrawing=!1,t.annotationUID}},this._activateModify=e=>{Je.isInteractingWithTool=!0,e.addEventListener(re.MOUSE_UP,this._endCallback),e.addEventListener(re.MOUSE_DRAG,this._dragCallback),e.addEventListener(re.MOUSE_CLICK,this._endCallback),e.addEventListener(re.TOUCH_TAP,this._endCallback),e.addEventListener(re.TOUCH_END,this._endCallback),e.addEventListener(re.TOUCH_DRAG,this._dragCallback)},this._deactivateModify=e=>{Je.isInteractingWithTool=!1,e.removeEventListener(re.MOUSE_UP,this._endCallback),e.removeEventListener(re.MOUSE_DRAG,this._dragCallback),e.removeEventListener(re.MOUSE_CLICK,this._endCallback),e.removeEventListener(re.TOUCH_TAP,this._endCallback),e.removeEventListener(re.TOUCH_END,this._endCallback),e.removeEventListener(re.TOUCH_DRAG,this._dragCallback)},this._activateDraw=e=>{Je.isInteractingWithTool=!0,e.addEventListener(re.MOUSE_UP,this._endCallback),e.addEventListener(re.MOUSE_DRAG,this._dragCallback),e.addEventListener(re.MOUSE_MOVE,this._dragCallback),e.addEventListener(re.MOUSE_CLICK,this._endCallback),e.addEventListener(re.TOUCH_TAP,this._endCallback),e.addEventListener(re.TOUCH_END,this._endCallback),e.addEventListener(re.TOUCH_DRAG,this._dragCallback)},this._deactivateDraw=e=>{Je.isInteractingWithTool=!1,e.removeEventListener(re.MOUSE_UP,this._endCallback),e.removeEventListener(re.MOUSE_DRAG,this._dragCallback),e.removeEventListener(re.MOUSE_MOVE,this._dragCallback),e.removeEventListener(re.MOUSE_CLICK,this._endCallback),e.removeEventListener(re.TOUCH_TAP,this._endCallback),e.removeEventListener(re.TOUCH_END,this._endCallback),e.removeEventListener(re.TOUCH_DRAG,this._dragCallback)},this.renderAnnotation=(e,t)=>{let n=!1;const{viewport:i}=e,{element:o}=i;let a=sp(this.getToolName(),o);if(!a?.length)return n;if(a=this.filterInteractableAnnotationsForElement(o,a),!a?.length)return n;const s=this.getTargetId(i),r=i.getRenderingEngine(),l={toolGroupId:this.toolGroupId,toolName:this.getToolName(),viewportId:e.viewport.id};for(let o=0;o<a.length;o++){const d=a[o],{annotationUID:c,data:h}=d,{points:g}=h.handles;l.annotationUID=c;const u=this.getStyle("color",l,d),m=g.map((e=>i.worldToCanvas(e)));if(h.cachedStats[s]&&null!=h.cachedStats[s].xValues?d.invalidated&&this._throttledCalculateCachedStats(d,r,e):(h.cachedStats[s]={xValues:[0,0],yValues:[0,0],isHorizontal:!1,units:[""],isUnitless:!1},this._calculateCachedStats(d,r,e)),!i.getRenderingEngine())return console.warn("Rendering Engine has been destroyed"),n;let v="0";if(Go(t,c,v,m[0],{color:u},0),n=!0,2!==m.length)return n;v="1",Go(t,c,v,m[1],{color:u},1);if(h.cachedStats[s].isUnitless){const e=`${c}-line-1`;Ko(t,c,"1",m[0],m[1],{color:u,width:1,shadow:this.configuration.shadow},e)}else{const e=m[0],n=m[1],i=n[1]-e[1],o=n[0]-e[0];let a=[0,0];a=h.cachedStats[s].isHorizontal?[e[0]+o,e[1]]:[e[0],e[1]+i];let r=`${c}-line-1`,l="1";Ko(t,c,l,m[0],a,{color:u,width:1,shadow:this.configuration.shadow},r),r=`${c}-line-2`,l="2",Ko(t,c,l,m[1],a,{color:u,width:1,lineDash:[1,1],shadow:this.configuration.shadow},r)}const p=this.getLinkedTextBoxStyle(l,d);if(!p.visibility){h.handles.textBox={hasMoved:!1,worldPosition:[0,0,0],worldBoundingBox:{topLeft:[0,0,0],topRight:[0,0,0],bottomLeft:[0,0,0],bottomRight:[0,0,0]}};continue}const f=this.configuration.getTextLines(h,s,this.configuration);if(!h.handles.textBox.hasMoved){const e=m[1];h.handles.textBox.worldPosition=i.canvasToWorld(e)}const E=i.worldToCanvas(h.handles.textBox.worldPosition),w=Jo(t,c,"1",f,E,m,{},p),{x:I,y:C,width:_,height:T}=w;h.handles.textBox.worldBoundingBox={topLeft:i.canvasToWorld([I,C]),topRight:i.canvasToWorld([I+_,C]),bottomLeft:i.canvasToWorld([I,C+T]),bottomRight:i.canvasToWorld([I+_,C+T])}}return n},this._throttledCalculateCachedStats=qa(this._calculateCachedStats,100,{trailing:!0})}toolSelectedCallback(e,t,n,i){}handleSelectedCallback(e,t,n){const i=e.detail,{element:o}=i,{data:a}=t;t.highlighted=!0;const s=Cl(o,this.getToolName());let r,l=!1;n.worldPosition?l=!0:r=a.handles.points.findIndex((e=>e===n)),this.editData={handleIndex:r,annotation:t,viewportIdsToRender:s},this._activateModify(o),Rr(o);const d=(0,ne.getEnabledElement)(o),{renderingEngine:c}=d;cs(c,s),e.preventDefault()}_calculateCachedStats(e,t,n){const i=e.data,{viewportId:o,renderingEngineId:a}=n;if(2!==i.handles.points.length)return;const{cachedStats:s}=i,r=Object.keys(s);for(let e=0;e<r.length;e++){const o=r[e],a=this.getTargetIdImage(o,t);if(!a)continue;const{imageData:l}=a,d=i.handles.points[0],c=i.handles.points[1],h=wg(l,d),g=wg(l,c),{values:u,units:m}=ls(a,[h]),{values:v,units:p}=ls(a,[g]);let f,E,w,I,C=!1;if(m[0]!==p[0]||m[1]!==p[1]||"raw"===m[0]&&"raw"===p[0]){const e=Ll(d,c);f=[e,0],E=[e,0],w=["px"],C=!0}else{const e=n.viewport.worldToCanvas(d),t=n.viewport.worldToCanvas(c),i=t[1]-e[1],o=t[0]-e[0];I=Math.abs(o)>Math.abs(i),f=[u[0],v[0]],E=[u[1],v[1]],w=[m[0],m[1]]}s[o]={xValues:f,yValues:E,isHorizontal:I,units:w,isUnitless:C}}e.invalidated=!1;const l=re.ANNOTATION_MODIFIED,d={annotation:e,viewportId:o,renderingEngineId:a};return(0,ne.triggerEvent)(ne.eventTarget,l,d),s}}function Cg(e,t,n){const i=e.cachedStats[t],{xValues:o,yValues:a,units:s,isUnitless:r,isHorizontal:l}=i;if(r)return[`${ws(o[0])} px`];if(n.displayBothAxesDistances){const e=Math.abs(o[1]-o[0]),t=Math.abs(a[1]-a[0]);return[`${ws(e)} ${s[0]}`,`${ws(t)} ${s[1]}`]}if(l){const e=Math.abs(o[1]-o[0]);return[`${ws(e)} ${s[0]}`]}{const e=Math.abs(a[1]-a[0]);return[`${ws(e)} ${s[1]}`]}}Ig.toolName="UltrasoundDirectionalTool";const _g=Ig;class Tg extends Ca{constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"],configuration:{getTextCallback:bg,changeTextCallback:Dg,canvasPosition:[10,10],canvasSize:10}}){super(e,t),this.addNewAnnotation=e=>{const t=e.detail,{currentPoints:n,element:i}=t,o=n.world,a=(0,ne.getEnabledElement)(i),{viewport:s,renderingEngine:r}=a,l=s.getCamera(),{viewPlaneNormal:d,viewUp:c}=l,h=this.getReferencedImageId(s,o,d,c),g=s.getFrameOfReferenceUID(),u={annotationUID:null,highlighted:!0,invalidated:!0,metadata:{toolName:this.getToolName(),viewPlaneNormal:[...d],viewUp:[...c],FrameOfReferenceUID:g,referencedImageId:h},data:{text:"",handles:{points:new Array,textBox:{hasMoved:!1,worldPosition:[0,0,0],worldBoundingBox:{topLeft:[0,0,0],topRight:[0,0,0],bottomLeft:[0,0,0],bottomRight:[0,0,0]}}},label:""}};rp(u,i);const m=Cl(i,this.getToolName());return e.preventDefault(),cs(r,m),this.configuration.getTextCallback((e=>{if(!e)return dp(u.annotationUID),cs(r,m),void(this.isDrawing=!1);u.data.text=e;const t=re.ANNOTATION_COMPLETED,n={annotation:u};(0,ne.triggerEvent)(ne.eventTarget,t,n),cs(r,m)})),u},this.isPointNearTool=(e,t,n,i)=>{const o=(0,ne.getEnabledElement)(e),{viewport:a}=o,{data:s}=t,{canvasPosition:r,canvasSize:l}=this.configuration;return!!r?.length&&(Math.abs(n[0]-r[0]+l/2)<=l/2&&Math.abs(n[1]-r[1]+l/2)<=l/2)},this.toolSelectedCallback=(e,t)=>{t.highlighted=!0,e.preventDefault()},this._endCallback=e=>{const t=e.detail,{element:n}=t;this._deactivateModify(n),xr(n)},this.doubleClickCallback=e=>{const t=e.detail,{element:n}=t;let i=sp(this.getToolName(),n);if(i=this.filterInteractableAnnotationsForElement(n,i),!i?.length)return;const o=i.find((e=>this.isPointNearTool(n,e,t.currentPoints.canvas,6)));if(!o)return;const a=o;this.configuration.changeTextCallback(o,e.detail,this._doneChangingTextCallback.bind(this,n,a)),this.isDrawing=!1,e.stopImmediatePropagation(),e.preventDefault()},this._activateModify=e=>{Je.isInteractingWithTool=!0,e.addEventListener(re.MOUSE_UP,this._endCallback),e.addEventListener(re.MOUSE_CLICK,this._endCallback),e.addEventListener(re.TOUCH_TAP,this._endCallback),e.addEventListener(re.TOUCH_END,this._endCallback)},this._deactivateModify=e=>{Je.isInteractingWithTool=!1,e.removeEventListener(re.MOUSE_UP,this._endCallback),e.removeEventListener(re.MOUSE_CLICK,this._endCallback),e.removeEventListener(re.TOUCH_TAP,this._endCallback),e.removeEventListener(re.TOUCH_END,this._endCallback)},this.renderAnnotation=(e,t)=>{let n=!1;const{viewport:i}=e,{element:o}=i;let a=sp(this.getToolName(),o);if(!a?.length)return n;if(a=this.filterInteractableAnnotationsForElement(o,a),!a?.length)return n;const s={toolGroupId:this.toolGroupId,toolName:this.getToolName(),viewportId:e.viewport.id};for(let e=0;e<a.length;e++){const o=a[e],{annotationUID:r}=o;s.annotationUID=r;const l=this.getStyle("color",s,o),{canvasPosition:d,canvasSize:c}=this.configuration;if(d?.length){ea(t,r,"1",d.map((e=>e+c)),d,{color:l,width:1})}if(n=!0,!i.getRenderingEngine())return console.warn("Rendering Engine has been destroyed"),n}return n}}cancel(){}handleSelectedCallback(e,t,n){}_doneChangingTextCallback(e,t,n){t.data.text=n;const{renderingEngine:i,viewportId:o,renderingEngineId:a}=(0,ne.getEnabledElement)(e),s=Cl(e,this.getToolName());cs(i,s);const r=re.ANNOTATION_MODIFIED;(0,ne.triggerEvent)(ne.eventTarget,r,{annotation:t,viewportId:o,renderingEngineId:a})}_isInsideVolume(e,t,n){return ne.utilities.indexWithinDimensions(e,n)&&ne.utilities.indexWithinDimensions(t,n)}}function bg(e){return e(prompt("Enter your annotation:"))}function Dg(e,t,n){return n(prompt("Enter your annotation:"))}Tg.toolName="KeyImage";const Sg=Tg,{transformWorldToIndex:Mg}=ne.utilities;function yg(e,t,n=!0){const{points:i,segmentsLocked:o,segmentIndex:a,segmentationId:s}=t,r=Ls({operationData:t,viewport:e.viewport});if(!r)return void console.warn("No data found for fillRectangle");const{segmentationImageData:l,segmentationScalarData:d}=r;let c=i.map((e=>Mg(l,e)));c=c.map((e=>e.map((e=>Math.round(e)))));const h=ps(c,l.getDimensions());us(l,(()=>!0),(({value:e,index:t})=>{o.includes(e)||(d[t]=a)}),h),Jn(s)}function Og(e,t){yg(e,t,!0)}function xg(e,t,n=!0){Og(e,Object.assign({},t,{segmentIndex:0}))}function Rg(e,t){xg(e,t,!0)}class Pg extends yo{constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"],configuration:{strategies:{FILL_INSIDE:Og,ERASE_INSIDE:Rg},defaultStrategy:"FILL_INSIDE",activeStrategy:"FILL_INSIDE"}}){super(e,t),this.preMouseDownCallback=e=>{if(!0===this.isDrawing)return;const t=e.detail,{currentPoints:n,element:i}=t,o=n.world,a=(0,ne.getEnabledElement)(i),{viewport:s,renderingEngine:r}=a;this.isDrawing=!0;const l=s.getCamera(),{viewPlaneNormal:d,viewUp:c}=l,h=this.toolGroupId,g=go(h);if(!g)throw new Error("No active segmentation detected, create one before using scissors tool");const{segmentationRepresentationUID:u,segmentationId:m,type:v}=g,p=So(m),f=po(m),E=wo(h,u,p),{representationData:w}=ti(m),I=w[de.Labelmap],C={highlighted:!0,invalidated:!0,metadata:{viewPlaneNormal:[...d],viewUp:[...c],FrameOfReferenceUID:s.getFrameOfReferenceUID(),referencedImageId:"",toolName:this.getToolName(),segmentColor:E},data:{handles:{points:[[...o],[...o],[...o],[...o]],activeHandleIndex:null}}},_=Cl(i,this.getToolName());if(this.editData={annotation:C,segmentIndex:p,segmentationId:m,segmentsLocked:f,segmentColor:E,viewportIdsToRender:_,handleIndex:3,movingTextBox:!1,newAnnotation:!0,hasMoved:!1,segmentationRepresentationUID:u},Ti(I)){const{volumeId:e}=I,t=ne.cache.getVolume(e);this.editData={...this.editData,volumeId:e,referencedVolumeId:t.referencedVolumeId}}else{const{imageIdReferenceMap:e}=I;this.editData={...this.editData,imageIdReferenceMap:e}}return this._activateDraw(i),Rr(i),e.preventDefault(),cs(r,_),!0},this._dragCallback=e=>{this.isDrawing=!0;const t=e.detail,{element:n}=t,{annotation:i,viewportIdsToRender:o,handleIndex:a}=this.editData,{data:s}=i,{currentPoints:r}=t,l=(0,ne.getEnabledElement)(n),{worldToCanvas:d,canvasToWorld:c}=l.viewport,h=r.world,{points:g}=s.handles;let u,m,v,p,f,E,w,I;switch(g[a]=[...h],a){case 0:case 3:u=d(g[0]),p=d(g[3]),m=[p[0],u[1]],v=[u[0],p[1]],E=c(m),w=c(v),g[1]=E,g[2]=w;break;case 1:case 2:m=d(g[1]),v=d(g[2]),u=[v[0],m[1]],p=[m[0],v[1]],f=c(u),I=c(p),g[0]=f,g[3]=I}i.invalidated=!0,this.editData.hasMoved=!0;const{renderingEngine:C}=l;cs(C,o)},this._endCallback=e=>{const t=e.detail,{element:n}=t,{annotation:i,newAnnotation:o,hasMoved:a}=this.editData,{data:s}=i;if(o&&!a)return;s.handles.activeHandleIndex=null,this._deactivateDraw(n),xr(n);const r=(0,ne.getEnabledElement)(n),l={...this.editData,points:s.handles.points};this.editData=null,this.isDrawing=!1,this.applyActiveStrategy(r,l)},this._activateDraw=e=>{e.addEventListener(re.MOUSE_UP,this._endCallback),e.addEventListener(re.MOUSE_DRAG,this._dragCallback),e.addEventListener(re.MOUSE_MOVE,this._dragCallback),e.addEventListener(re.MOUSE_CLICK,this._endCallback),e.addEventListener(re.TOUCH_END,this._endCallback),e.addEventListener(re.TOUCH_DRAG,this._dragCallback),e.addEventListener(re.TOUCH_TAP,this._endCallback)},this._deactivateDraw=e=>{e.removeEventListener(re.MOUSE_UP,this._endCallback),e.removeEventListener(re.MOUSE_DRAG,this._dragCallback),e.removeEventListener(re.MOUSE_MOVE,this._dragCallback),e.removeEventListener(re.MOUSE_CLICK,this._endCallback),e.removeEventListener(re.TOUCH_TAP,this._endCallback),e.removeEventListener(re.TOUCH_END,this._endCallback),e.removeEventListener(re.TOUCH_DRAG,this._dragCallback)},this.renderAnnotation=(e,t)=>{let n=!1;if(!this.editData)return n;const{viewport:i}=e,{annotation:o}=this.editData,a=o.metadata,s=o.annotationUID,r=o.data,{points:l}=r.handles,d=l.map((e=>i.worldToCanvas(e))),c=`rgb(${a.segmentColor.slice(0,3)})`;if(!i.getRenderingEngine())return console.warn("Rendering Engine has been destroyed"),n;return Qo(t,s,"0",d[0],d[3],{color:c}),n=!0,n}}}Pg.toolName="RectangleScissor";const Ng=Pg;class Lg extends yo{constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"],configuration:{strategies:{FILL_INSIDE:zs,ERASE_INSIDE:tr},defaultStrategy:"FILL_INSIDE",activeStrategy:"FILL_INSIDE"}}){super(e,t),this.preMouseDownCallback=e=>{if(!0===this.isDrawing)return;const t=e.detail,{currentPoints:n,element:i}=t,o=n.world,a=n.canvas,s=(0,ne.getEnabledElement)(i),{viewport:r,renderingEngine:l}=s;this.isDrawing=!0;const d=r.getCamera(),{viewPlaneNormal:c,viewUp:h}=d,g=this.toolGroupId,u=go(g);if(!u)throw new Error("No active segmentation detected, create one before using scissors tool");const{segmentationRepresentationUID:m,segmentationId:v,type:p}=u,f=So(v),E=po(v),w=wo(g,m,f),{representationData:I}=ti(v),C=I[p];if(!C)throw new Error("No labelmap data found for the active segmentation, create one before using scissors tool");const _={invalidated:!0,highlighted:!0,metadata:{viewPlaneNormal:[...c],viewUp:[...h],FrameOfReferenceUID:r.getFrameOfReferenceUID(),referencedImageId:"",toolName:this.getToolName(),segmentColor:w},data:{handles:{points:[[...o],[...o],[...o],[...o]],activeHandleIndex:null},isDrawing:!0,cachedStats:{}}},T=[r.id];if(this.editData={annotation:_,centerCanvas:a,segmentIndex:f,segmentationId:v,segmentsLocked:E,segmentColor:w,viewportIdsToRender:T,handleIndex:3,movingTextBox:!1,newAnnotation:!0,hasMoved:!1,segmentationRepresentationUID:m},Ti(C)){const{volumeId:e}=C,t=ne.cache.getVolume(e);this.editData={...this.editData,volumeId:e,referencedVolumeId:t.referencedVolumeId}}else{const{imageIdReferenceMap:e}=C;this.editData={...this.editData,imageIdReferenceMap:e}}return this._activateDraw(i),Rr(i),e.preventDefault(),cs(l,T),!0},this._dragCallback=e=>{this.isDrawing=!0;const t=e.detail,{element:n}=t,{currentPoints:i}=t,o=i.canvas,a=(0,ne.getEnabledElement)(n),{renderingEngine:s,viewport:r}=a,{canvasToWorld:l}=r,{annotation:d,viewportIdsToRender:c,centerCanvas:h}=this.editData,{data:g}=d,u=Math.abs(o[0]-h[0]),m=Math.abs(o[1]-h[1]),v=Math.sqrt(u*u+m*m),p=[h[0],h[1]+v],f=[h[0],h[1]-v],E=[h[0]-v,h[1]],w=[h[0]+v,h[1]];g.handles.points=[l(p),l(f),l(E),l(w)],d.invalidated=!0,this.editData.hasMoved=!0,cs(s,c)},this._endCallback=e=>{const t=e.detail,{element:n}=t,{annotation:i,newAnnotation:o,hasMoved:a}=this.editData,{data:s}=i,{viewPlaneNormal:r,viewUp:l}=i.metadata;if(o&&!a)return;s.handles.activeHandleIndex=null,this._deactivateDraw(n),xr(n);const d=(0,ne.getEnabledElement)(n),c={...this.editData,points:s.handles.points,viewPlaneNormal:r,viewUp:l,strategySpecificConfiguration:{}};this.editData=null,this.isDrawing=!1,this.applyActiveStrategy(d,c)},this._activateDraw=e=>{e.addEventListener(re.MOUSE_UP,this._endCallback),e.addEventListener(re.MOUSE_DRAG,this._dragCallback),e.addEventListener(re.MOUSE_MOVE,this._dragCallback),e.addEventListener(re.MOUSE_CLICK,this._endCallback),e.addEventListener(re.TOUCH_TAP,this._endCallback),e.addEventListener(re.TOUCH_DRAG,this._dragCallback),e.addEventListener(re.TOUCH_END,this._endCallback)},this._deactivateDraw=e=>{e.removeEventListener(re.MOUSE_UP,this._endCallback),e.removeEventListener(re.MOUSE_DRAG,this._dragCallback),e.removeEventListener(re.MOUSE_MOVE,this._dragCallback),e.removeEventListener(re.MOUSE_CLICK,this._endCallback),e.removeEventListener(re.TOUCH_END,this._endCallback),e.removeEventListener(re.TOUCH_DRAG,this._dragCallback),e.removeEventListener(re.TOUCH_TAP,this._endCallback)},this.renderAnnotation=(e,t)=>{let n=!1;if(!this.editData)return n;const{viewport:i}=e,{viewportIdsToRender:o}=this.editData;if(!o.includes(i.id))return n;const{annotation:a}=this.editData,s=a.metadata,r=a.annotationUID,l=a.data,{points:d}=l.handles,c=d.map((e=>i.worldToCanvas(e))),h=c[0],g=c[1],u=[Math.floor((h[0]+g[0])/2),Math.floor((h[1]+g[1])/2)],m=Math.abs(h[1]-Math.floor((h[1]+g[1])/2)),v=`rgb(${s.segmentColor.slice(0,3)})`;if(!i.getRenderingEngine())return console.warn("Rendering Engine has been destroyed"),n;return Ho(t,r,"0",u,m,{color:v}),n=!0,n}}}Lg.toolName="CircleScissor";const Ag=Lg;class kg extends yo{constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"],configuration:{strategies:{FILL_INSIDE:Js,ERASE_INSIDE:er},defaultStrategy:"FILL_INSIDE",activeStrategy:"FILL_INSIDE"}}){super(e,t),this.preMouseDownCallback=e=>{if(!0===this.isDrawing)return;const t=e.detail,{currentPoints:n,element:i}=t,o=n.world,a=n.canvas,s=(0,ne.getEnabledElement)(i),{viewport:r,renderingEngine:l}=s;this.isDrawing=!0;const d=r.getCamera(),{viewPlaneNormal:c,viewUp:h}=d,g=this.toolGroupId,u=go(g);if(!u)throw new Error("No active segmentation detected, create one before using scissors tool");const{segmentationRepresentationUID:m,segmentationId:v}=u,p=So(v),f=po(v),E=wo(g,m,p);this.isDrawing=!0;const w={metadata:{viewPlaneNormal:[...c],viewUp:[...h],FrameOfReferenceUID:r.getFrameOfReferenceUID(),referencedImageId:"",toolName:this.getToolName(),segmentColor:E},data:{invalidated:!0,handles:{points:[[...o],[...o],[...o],[...o]],activeHandleIndex:null},cachedStats:{},highlighted:!0}},I=[r.id];this.editData={annotation:w,centerCanvas:a,segmentationRepresentationUID:m,segmentIndex:p,segmentationId:v,segmentsLocked:f,segmentColor:E,toolGroupId:g,viewportIdsToRender:I,handleIndex:3,movingTextBox:!1,newAnnotation:!0,hasMoved:!1};const{representationData:C}=ti(v),_=C[de.Labelmap];if(Ti(_)){const{volumeId:e}=_,t=ne.cache.getVolume(e);this.editData={...this.editData,volumeId:e,referencedVolumeId:t.referencedVolumeId}}else{const{imageIdReferenceMap:e}=_;this.editData={...this.editData,imageIdReferenceMap:e}}return this._activateDraw(i),Rr(i),e.preventDefault(),cs(l,I),!0},this._dragCallback=e=>{this.isDrawing=!0;const t=e.detail,{element:n}=t,{currentPoints:i}=t,o=i.canvas,a=(0,ne.getEnabledElement)(n),{renderingEngine:s,viewport:r}=a,{canvasToWorld:l}=r,{annotation:d,viewportIdsToRender:c,centerCanvas:h}=this.editData,{data:g}=d,u=Math.abs(o[0]-h[0]),m=Math.abs(o[1]-h[1]),v=Math.sqrt(u*u+m*m),p=[h[0],h[1]+v],f=[h[0],h[1]-v],E=[h[0]-v,h[1]],w=[h[0]+v,h[1]];g.handles.points=[l(p),l(f),l(E),l(w)],d.invalidated=!0,this.editData.hasMoved=!0,cs(s,c)},this._endCallback=e=>{const t=e.detail,{element:n}=t,{annotation:i,newAnnotation:o,hasMoved:a,segmentIndex:s,segmentationRepresentationUID:r,segmentsLocked:l}=this.editData,{data:d}=i,{viewPlaneNormal:c,viewUp:h}=i.metadata;if(o&&!a)return;i.highlighted=!1,d.handles.activeHandleIndex=null,this._deactivateDraw(n),xr(n);const g=(0,ne.getEnabledElement)(n),u={...this.editData,points:d.handles.points,segmentIndex:s,segmentationRepresentationUID:r,segmentsLocked:l,viewPlaneNormal:c,viewUp:h};this.editData=null,this.isDrawing=!1,this.applyActiveStrategy(g,u)},this._activateDraw=e=>{e.addEventListener(re.MOUSE_UP,this._endCallback),e.addEventListener(re.MOUSE_DRAG,this._dragCallback),e.addEventListener(re.MOUSE_MOVE,this._dragCallback),e.addEventListener(re.MOUSE_CLICK,this._endCallback),e.addEventListener(re.TOUCH_END,this._endCallback),e.addEventListener(re.TOUCH_TAP,this._endCallback),e.addEventListener(re.TOUCH_DRAG,this._dragCallback)},this._deactivateDraw=e=>{e.removeEventListener(re.MOUSE_UP,this._endCallback),e.removeEventListener(re.MOUSE_DRAG,this._dragCallback),e.removeEventListener(re.MOUSE_MOVE,this._dragCallback),e.removeEventListener(re.MOUSE_CLICK,this._endCallback),e.removeEventListener(re.TOUCH_END,this._endCallback),e.removeEventListener(re.TOUCH_DRAG,this._dragCallback),e.removeEventListener(re.TOUCH_TAP,this._endCallback)},this.renderAnnotation=(e,t)=>{let n=!1;if(!this.editData)return n;const{viewport:i}=e,{viewportIdsToRender:o}=this.editData;if(!o.includes(i.id))return n;const{annotation:a}=this.editData,s=a.metadata,r=a.annotationUID,l=a.data,{points:d}=l.handles,c=d.map((e=>i.worldToCanvas(e))),h=c[0],g=c[1],u=[Math.floor((h[0]+g[0])/2),Math.floor((h[1]+g[1])/2)],m=Math.abs(h[1]-Math.floor((h[1]+g[1])/2)),v=`rgb(${s.segmentColor.slice(0,3)})`;if(!i.getRenderingEngine())return console.warn("Rendering Engine has been destroyed"),n;return Ho(t,r,"0",u,m,{color:v}),n=!0,n}}}kg.toolName="SphereScissor";const Ug=kg;class Vg extends ac{constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"],configuration:{shadow:!0,preventHandleOutsideImage:!1}}){super(e,t),this.addNewAnnotation=e=>{const t=e.detail,{currentPoints:n,element:i}=t,o=n.world,a=(0,ne.getEnabledElement)(i),{viewport:s,renderingEngine:r}=a;this.isDrawing=!0;const l=s.getCamera(),{viewPlaneNormal:d,viewUp:c}=l,h=this.getTargetId(s);let g,u;if(s instanceof ne.StackViewport)g=h.split("imageId:")[1];else{u=h.split("volumeId:")[1];const e=ne.cache.getVolume(u);g=ne.utilities.getClosestImageId(e,o,d)}const m=s.getFrameOfReferenceUID(),v={highlighted:!0,invalidated:!0,metadata:{viewPlaneNormal:[...d],enabledElement:a,viewUp:[...c],FrameOfReferenceUID:m,referencedImageId:g,toolName:this.getToolName(),volumeId:u},data:{label:"",handles:{textBox:{hasMoved:!1,worldPosition:null,worldBoundingBox:null},points:[[...o],[...o],[...o],[...o]],activeHandleIndex:null},segmentationId:null}};rp(v,i);const p=Cl(i,this.getToolName());return this.editData={annotation:v,viewportIdsToRender:p,handleIndex:3,newAnnotation:!0,hasMoved:!1},this._activateDraw(i),Rr(i),e.preventDefault(),cs(r,p),v},this.renderAnnotation=(e,t)=>{let n=!1;const{viewport:i,renderingEngineId:o}=e,{element:a}=i;let s=sp(this.getToolName(),a);if(!s?.length)return n;if(s=this.filterInteractableAnnotationsForElement(a,s),!s?.length)return n;const r={toolGroupId:this.toolGroupId,toolName:this.getToolName(),viewportId:e.viewport.id};for(let e=0;e<s.length;e++){const a=s[e],{annotationUID:l,data:d}=a,{points:c,activeHandleIndex:h}=d.handles,g=c.map((e=>i.worldToCanvas(e)));r.annotationUID=l;const u=this.getStyle("lineWidth",r,a),m=this.getStyle("lineDash",r,a),v=this.getStyle("color",r,a);if(!i.getRenderingEngine())return console.warn("Rendering Engine has been destroyed"),n;const p=re.ANNOTATION_MODIFIED,f={annotation:a,viewportId:i.id,renderingEngineId:o};let E;if((0,ne.triggerEvent)(ne.eventTarget,p,f),!He(l))continue;if(we(a)||this.editData||null===h||(E=[g[h]]),E){$o(t,l,"0",E,{color:v})}Qo(t,l,"0",g[0],g[3],{color:v,lineDash:m,lineWidth:u}),n=!0}return n}}}Vg.toolName="RectangleROIThreshold";const Wg=Vg,{transformWorldToIndex:Hg}=ne.utilities;class Bg extends ac{constructor(e={},t={configuration:{numSlicesToPropagate:10}}){super(e,t),this.addNewAnnotation=e=>{const t=e.detail,{currentPoints:n,element:i}=t,o=n.world,a=(0,ne.getEnabledElement)(i),{viewport:s,renderingEngine:r}=a;this.isDrawing=!0;const l=s.getCamera(),{viewPlaneNormal:d,viewUp:c}=l;let h,g,u;if(s instanceof ne.StackViewport)throw new Error("Stack Viewport Not implemented");u=this.getTargetId(s).split("volumeId:")[1],g=ne.cache.getVolume(u),h=ne.utilities.getClosestImageId(g,o,d);if(!h)throw new Error("This tool does not work on non-acquisition planes");const m=s.getCurrentImageIdIndex(),v=ne.utilities.getSpacingInNormalDirection(g,d),p=this._getEndSliceIndex(g,o,v,d),f=s.getFrameOfReferenceUID(),E={highlighted:!0,invalidated:!0,metadata:{viewPlaneNormal:[...d],enabledElement:a,viewUp:[...c],FrameOfReferenceUID:f,referencedImageId:h,toolName:this.getToolName(),volumeId:u,spacingInNormal:v},data:{label:"",startSlice:m,endSlice:p,cachedStats:{projectionPoints:[],projectionPointsImageIds:[h]},handles:{textBox:{hasMoved:!1,worldPosition:null,worldBoundingBox:null},points:[[...o],[...o],[...o],[...o]],activeHandleIndex:null},labelmapUID:null}};this._computeProjectionPoints(E,g),rp(E,i);const w=Cl(i,this.getToolName());return this.editData={annotation:E,viewportIdsToRender:w,handleIndex:3,newAnnotation:!0,hasMoved:!1},this._activateDraw(i),Rr(i),e.preventDefault(),cs(r,w),E},this.renderAnnotation=(e,t)=>{let n=!1;const{viewport:i}=e,o=sp(this.getToolName(),i.element);if(!o?.length)return n;const a=i.getCurrentImageIdIndex(),s={toolGroupId:this.toolGroupId,toolName:this.getToolName(),viewportId:e.viewport.id};for(let r=0;r<o.length;r++){const l=o[r],{annotationUID:d,data:c}=l,{startSlice:h,endSlice:g}=c,{points:u,activeHandleIndex:m}=c.handles,v=u.map((e=>i.worldToCanvas(e)));s.annotationUID=d;const p=this.getStyle("lineWidth",s,l),f=this.getStyle("lineDash",s,l),E=this.getStyle("color",s,l);if(a<Math.min(h,g)||a>Math.max(h,g))continue;l.invalidated&&this._throttledCalculateCachedStats(l,e);let w,I=!1;if(a!==h&&a!==g||(I=!0),!i.getRenderingEngine())return console.warn("Rendering Engine has been destroyed"),n;if(!He(d))continue;if(we(l)||this.editData||null===m||!I||(w=[v[m]]),w){$o(t,d,"0",w,{color:E})}let C=f;I||(C=2);Qo(t,d,"0",v[0],v[3],{color:E,lineDash:C,lineWidth:p}),n=!0}return n},this._throttledCalculateCachedStats=qa(this._calculateCachedStatsTool,100,{trailing:!0})}_computeProjectionPoints(e,t){const{data:n,metadata:i}=e,{viewPlaneNormal:o,spacingInNormal:a}=i,{imageData:s}=t,{startSlice:r,endSlice:l}=n,{points:d}=n.handles,c=Hg(s,d[0]);if(c[2]!==r)throw new Error("Start slice does not match");const h=Oo.R3.fromValues(c[0],c[1],l),g=Oo.R3.create();s.indexToWorldVec3(c,g);const u=Oo.R3.create();s.indexToWorldVec3(h,u);const m=Oo.R3.distance(g,u),v=[];for(let e=0;e<m;e+=a)v.push(d.map((t=>{const n=Oo.R3.create();return Oo.R3.scaleAndAdd(n,t,o,e),Array.from(n)})));n.cachedStats.projectionPoints=v;const p=[];for(const e of v){const n=ne.utilities.getClosestImageId(t,e[0],o);p.push(n)}n.cachedStats.projectionPointsImageIds=p}_calculateCachedStatsTool(e,t){const n=e.data,{viewportId:i,renderingEngineId:o,viewport:a}=t,{cachedStats:s}=n,r=this.getTargetId(a),l=ne.cache.getVolume(r.split("volumeId:")[1]);this._computeProjectionPoints(e,l),e.invalidated=!1;const d=re.ANNOTATION_MODIFIED,c={annotation:e,viewportId:i,renderingEngineId:o};return(0,ne.triggerEvent)(ne.eventTarget,d,c),s}_getEndSliceIndex(e,t,n,i){const o=this.configuration.numSlicesToPropagate,a=Oo.R3.create();Oo.R3.scaleAndAdd(a,t,i,o*n);const s=n/2,{imageIds:r}=e;let l;for(let e=0;e<r.length;e++){const t=r[e],{imagePositionPatient:n}=ne.metaData.get("imagePlaneModule",t),o=Oo.R3.create();Oo.R3.sub(o,a,n);const d=Oo.R3.dot(o,i);Math.abs(d)<s&&(l=e)}return l}}Bg.toolName="RectangleROIStartEndThreshold";const Fg=Bg,{transformWorldToIndex:Gg,isEqual:$g}=ne.utilities;class Kg extends yo{constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"]}){super(e,t),this.preMouseDownCallback=e=>{const t=e.detail,{currentPoints:n,element:i}=t,o=n.world,a=(0,ne.getEnabledElement)(i),{viewport:s}=a,r=s.getCamera(),{viewPlaneNormal:l}=r,d=go(this.toolGroupId);if(!d)throw new Error("No active segmentation detected, create one before using scissors tool");const{segmentationId:c,type:h}=d,g=So(c),u=po(c),{representationData:m}=ti(c),v=m[de.Labelmap];let p,f,E,w;if(Ti(v)){const{volumeId:e}=m[h],t=ne.cache.getVolume(e);({dimensions:p,direction:f}=t),E=t.getScalarData(),w=Gg(t.imageData,o)}else{const{imageIdReferenceMap:e}=v,t=a.viewport.getCurrentImageId(),n=e.get(t);if(!n)throw new Error("No active segmentation imageId detected, create one before using scissors tool");const i=ne.cache.getImage(n);E=i.getPixelData();const{imageData:r}=s.getImageData();p=r.getDimensions(),f=r.getDirection(),w=Gg(r,o)}const I=this.getFixedDimension(l,f);if(void 0===I)return void console.warn("Oblique paint fill not yet supported");const{floodFillGetter:C,getLabelValue:_,getScalarDataPositionFromPlane:T,inPlaneSeedPoint:b,fixedDimensionValue:D}=this.generateHelpers(E,p,w,I);if(w[0]<0||w[0]>=p[0]||w[1]<0||w[1]>=p[1]||w[2]<0||w[2]>=p[2])return;const S=_(w[0],w[1],w[2]);if(u.includes(S))return;const M=ys(C,b),{flooded:y}=M;y.forEach((e=>{const t=T(e[0],e[1]);E[t]=g}));return Jn(c,this.getFramesModified(I,D,M)),!0},this.getFramesModified=(e,t,n)=>{const{boundaries:i}=n;if(2===e)return[t];let o=1/0,a=-1/0;for(let e=0;e<i.length;e++){const t=i[e][1];t<o&&(o=t),t>a&&(a=t)}const s=[];for(let e=o;e<=a;e++)s.push(e);return s},this.generateHelpers=(e,t,n,i=2)=>{let o,a;switch(i){case 0:o=n[0],a=[n[1],n[2]];break;case 1:o=n[1],a=[n[0],n[2]];break;case 2:o=n[2],a=[n[0],n[1]];break;default:throw new Error(`Invalid fixedDimension: ${i}`)}const s=(e,n,i)=>i*t[1]*t[0]+n*t[0]+e,r=(t,n,i)=>e[s(t,n,i)],l=this.generateFloodFillGetter(t,i,o,r);return{getScalarDataPositionFromPlane:this.generateGetScalarDataPositionFromPlane(s,i,o),getLabelValue:r,floodFillGetter:l,inPlaneSeedPoint:a,fixedDimensionValue:o}},this.generateFloodFillGetter=(e,t,n,i)=>{let o;switch(t){case 0:o=(t,o)=>{if(!(t>=e[1]||t<0||o>=e[2]||o<0))return i(n,t,o)};break;case 1:o=(t,o)=>{if(!(t>=e[0]||t<0||o>=e[2]||o<0))return i(t,n,o)};break;case 2:o=(t,o)=>{if(!(t>=e[0]||t<0||o>=e[1]||o<0))return i(t,o,n)};break;default:throw new Error(`Invalid fixedDimension: ${t}`)}return o},this.generateGetScalarDataPositionFromPlane=(e,t,n)=>{let i;switch(t){case 0:i=(t,i)=>e(n,t,i);break;case 1:i=(t,i)=>e(t,n,i);break;case 2:i=(t,i)=>e(t,i,n);break;default:throw new Error(`Invalid fixedDimension: ${t}`)}return i}}getFixedDimension(e,t){const n=t.slice(0,3),i=t.slice(3,6),o=t.slice(6,9),a=[Math.abs(e[0]),Math.abs(e[1]),Math.abs(e[2])],s=[Math.abs(n[0]),Math.abs(n[1]),Math.abs(n[2])];if($g(a,s))return 0;const r=[Math.abs(i[0]),Math.abs(i[1]),Math.abs(i[2])];if($g(a,r))return 1;const l=[Math.abs(o[0]),Math.abs(o[1]),Math.abs(o[2])];return $g(a,l)?2:void 0}}Kg.toolName="PaintFill";const qg=Kg;var zg,jg=n(80545),Yg=n(52031),Zg=n(59123),Xg=n(78150);const Jg={ANNOTATED_CUBE:1,AXES:2,CUSTOM:3};class Qg extends yo{constructor(e={},t={configuration:{orientationWidget:{enabled:!0,viewportCorner:jg.ZP.Corners.BOTTOM_RIGHT,viewportSize:.15,minPixelSize:100,maxPixelSize:300},overlayMarkerType:Qg.OVERLAY_MARKER_TYPES.ANNOTATED_CUBE,overlayConfiguration:{[Qg.OVERLAY_MARKER_TYPES.ANNOTATED_CUBE]:{faceProperties:{xPlus:{text:"R",faceColor:"#ffff00",faceRotation:90},xMinus:{text:"L",faceColor:"#ffff00",faceRotation:270},yPlus:{text:"P",faceColor:"#00ffff",fontColor:"white",faceRotation:180},yMinus:{text:"A",faceColor:"#00ffff",fontColor:"white"},zPlus:{text:"S"},zMinus:{text:"I"}},defaultStyle:{fontStyle:"bold",fontFamily:"Arial",fontColor:"black",fontSizeScale:e=>e/2,faceColor:"#0000ff",edgeThickness:.1,edgeColor:"black",resolution:400}},[Qg.OVERLAY_MARKER_TYPES.AXES]:{},[Qg.OVERLAY_MARKER_TYPES.CUSTOM]:{polyDataURL:"https://raw.githubusercontent.com/Slicer/Slicer/80ad0a04dacf134754459557bf2638c63f3d1d1b/Base/Logic/Resources/OrientationMarkers/Human.vtp"}}}}){super(e,t),this.configuration_invalidated=!0,this.onSetToolEnabled=()=>{this.initViewports(),this.configuration_invalidated=!0},this.onSetToolActive=()=>{this.initViewports()},this.onSetToolDisabled=()=>{this.cleanUpData()},this.orientationMarkers={},this.configuration_invalidated=!0}cleanUpData(){(0,ne.getRenderingEngines)()[0].getViewports().forEach((e=>{const t=this.orientationMarkers[e.id];if(!t)return;const{actor:n,orientationWidget:i}=t;i?.setEnabled(!1),i?.delete(),n?.delete();e.getRenderingEngine().offscreenMultiRenderWindow.getRenderWindow().render(),e.getRenderingEngine().render(),delete this.orientationMarkers[e.id]}))}initViewports(){const e=(0,ne.getRenderingEngines)()[0];if(!e)return;let t=e.getViewports();t=El(t,this.getToolName()),t.forEach((e=>this.addAxisActorInViewport(e)))}async addAxisActorInViewport(e){const t=e.id,n=this.configuration.overlayMarkerType,i=this.configuration.overlayConfiguration[n];if(this.orientationMarkers[t]){const{actor:n,orientationWidget:i}=this.orientationMarkers[t];e.getRenderer().removeActor(n),i.setEnabled(!1)}let o;1===n?o=this.createAnnotationCube(i):2===n?o=Zg.ZP.newInstance():3===n&&(o=await this.createCustomActor());const a=e.getRenderer(),s=e.getRenderingEngine().offscreenMultiRenderWindow.getRenderWindow(),{enabled:r,viewportCorner:l,viewportSize:d,minPixelSize:c,maxPixelSize:h}=this.configuration.orientationWidget,g=jg.ZP.newInstance({actor:o,interactor:s.getInteractor(),parentRenderer:a});g.setEnabled(r),g.setViewportCorner(l),g.setViewportSize(d),g.setMinPixelSize(c),g.setMaxPixelSize(h),g.updateMarkerOrientation(),this.orientationMarkers[t]={orientationWidget:g,actor:o},s.render(),e.getRenderingEngine().render(),this.configuration_invalidated=!1}async createCustomActor(){const e=this.configuration.overlayConfiguration[Jg.CUSTOM].polyDataURL,t=await fetch(e),n=await t.arrayBuffer(),i=Xg.ZP.newInstance();i.parseAsArrayBuffer(n),i.update();const o=Wi.ZP.newInstance();o.shallowCopy(i.getOutputData()),o.getPointData().setActiveScalars("Color");const a=ki.ZP.newInstance();a.setInputData(o),a.setColorModeToDirectScalars();const s=Ai.ZP.newInstance();return s.setMapper(a),s.rotateZ(180),s}createAnnotationCube(e){const t=Yg.ZP.newInstance();return t.setDefaultStyle({...e.defaultStyle}),t.setXPlusFaceProperty({...e.faceProperties.xPlus}),t.setXMinusFaceProperty({...e.faceProperties.xMinus}),t.setYPlusFaceProperty({...e.faceProperties.yPlus}),t.setYMinusFaceProperty({...e.faceProperties.yMinus}),t.setZPlusFaceProperty({...e.faceProperties.zPlus}),t.setZMinusFaceProperty({...e.faceProperties.zMinus}),t}async createAnnotatedCubeActor(){const e=Yg.ZP.newInstance(),{faceProperties:t,defaultStyle:n}=this.configuration.annotatedCube;return e.setDefaultStyle(n),Object.keys(t).forEach((n=>{const i=`set${n.charAt(0).toUpperCase()+n.slice(1)}FaceProperty`;e[i](t[n])})),e}}(zg=Qg).CUBE=1,zg.AXIS=2,zg.VTPFILE=3,zg.OVERLAY_MARKER_TYPES=Jg,Qg.toolName="OrientationMarker";const eu=Qg;const tu=function(e,t,n={}){const i=[];return e.forEach((e=>{const{data:o}=e,{points:a}=o.handles,{imageData:s,dimensions:r}=t;let l=a;if(o.cachedStats?.projectionPoints){const{projectionPoints:e}=o.cachedStats;l=[].concat(...e)}const d=l.map((e=>ne.utilities.transformWorldToIndex(s,e)));let c=ps(d,r);n.numSlicesToProject&&!o.cachedStats?.projectionPoints&&(c=vs(c,n.numSlicesToProject)),i.push(c)})),1===i.length?i[0]:i.reduce(((e,t)=>({iMin:Math.min(e.iMin,t.iMin),jMin:Math.min(e.jMin,t.jMin),kMin:Math.min(e.kMin,t.kMin),iMax:Math.max(e.iMax,t.iMax),jMax:Math.max(e.jMax,t.jMax),kMax:Math.max(e.kMax,t.kMax)})),{iMin:1/0,jMin:1/0,kMin:1/0,iMax:-1/0,jMax:-1/0,kMax:-1/0})};const nu=function(e,t,n,i){const o=e.map((e=>cp(e)));let a;!function(e){const t=[Wg.toolName,Fg.toolName];for(const n of e){const e=n.metadata.toolName;if(!t.includes(e))throw new Error("rectangleROIThresholdVolumeByRange only supports RectangleROIThreshold and RectangleROIStartEndThreshold annotations")}}(o);for(let e=0;e<n.length;e++){n[e].volume.getScalarData().length!==t.getScalarData().length&&0!==e||(a=tu(o,n[e].volume,i))}return Wr(t,n,{...i,boundsIJK:a})};const iu=function(e,t=1,n="mergedLabelmap"){e.forEach((({direction:t,dimensions:n,origin:i,spacing:o})=>{if(!(ne.utilities.isEqual(n,e[0].dimensions)&&ne.utilities.isEqual(t,e[0].direction)&&ne.utilities.isEqual(o,e[0].spacing)&&ne.utilities.isEqual(i,e[0].origin)))throw new Error("labelmaps must have the same size and shape")}));const i=e[0],o=new(0,i.getScalarData().constructor)(i.getScalarData().length);e.forEach((e=>{const n=e.getScalarData();for(let e=0;e<n.length;e++)n[e]===t&&(o[e]=t)}));const a={scalarData:o,metadata:i.metadata,spacing:i.spacing,origin:i.origin,direction:i.direction,dimensions:i.dimensions};return ne.volumeLoader.createLocalVolume(a,n,!0)};function ou(e,t){if(e===de.Labelmap)return function(e){return e&&"boolean"==typeof e.renderOutline&&"number"==typeof e.outlineWidthActive&&"number"==typeof e.outlineWidthInactive&&"boolean"==typeof e.renderFill&&"boolean"==typeof e.renderFillInactive&&"number"==typeof e.fillAlpha&&"number"==typeof e.fillAlphaInactive&&"number"==typeof e.outlineOpacity&&"number"==typeof e.outlineOpacityInactive}(t);throw new Error(`Unknown representation type: ${e}`)}function au(e){const{type:t}=e;if(t===de.Labelmap)return Gn();throw new Error(`Unknown representation type: ${t}`)}async function su(e){const{viewportId:t,renderingEngineId:n,options:i}=e;let{segmentationId:o}=e;const a=(0,ne.getEnabledElementByIds)(t,n);if(!a)throw new Error("element disabled");const{viewport:s}=a;if(!(s instanceof ne.VolumeViewport))throw new Error("Segmentation only supports VolumeViewport");const{uid:r}=s.getDefaultActor();if(void 0===o&&(o=`${r}-based-segmentation-${i?.volumeId??ne.utilities.uuidv4().slice(0,8)}`),i){const e=(0,ue._cloneDeep)(i);await ne.volumeLoader.createLocalVolume(e,o)}else{const{uid:e}=s.getDefaultActor();await ne.volumeLoader.createAndCacheDerivedVolume(e,{volumeId:o})}return o}function ru(e,t,n){const i=Jv(e);if(void 0===i)return;Ar(e,n).forEach((e=>{e.configuration.brushSize=t,e.invalidateBrushCursor()}));const o=i.getViewportsInfo(),a=Object.keys(o).map((e=>o[e]));if(!a.length)return;const{renderingEngineId:s}=a[0],r=i.getViewportIds(),l=(0,ne.getRenderingEngine)(s);cs(l,r)}function lu(e,t){const n=Jv(e);if(void 0===n)return;const i=n._toolInstances;if(!Object.keys(i).length)return;const o=Ar(e,t)[0];return o?o.configuration.brushSize:void 0}function du(e,t,n={isDynamic:!1}){const i=Jv(e);if(void 0===i)return;const o=Ar(e),a={...n,...void 0!==t&&{threshold:t}};o.forEach((e=>{e.configuration.strategySpecificConfiguration.THRESHOLD={...e.configuration.strategySpecificConfiguration.THRESHOLD,...a}}));const s=i.getViewportsInfo();if(!s.length)return;const{renderingEngineId:r}=s[0],l=i.getViewportIds(),d=(0,ne.getRenderingEngine)(r);cs(d,l)}function cu(e){const t=Jv(e);if(void 0===t)return;const n=t._toolInstances;if(!Object.keys(n).length)return;const i=Ar(e)[0];return i?i.configuration.strategySpecificConfiguration.THRESHOLD.threshold:void 0}const hu=function(e,t,n,i){const o=e.getScalarData(),{baseVolumeIdx:a,volumeInfoList:s}=Vr(e,n);return s.forEach((e=>{const{volumeSize:n}=e;n===o.length?function(e,t,n){const{referenceValues:i,lower:o,upper:a}=n;for(let n=0;n<e.length;n++)if(e[n]===t){const s=i[n];e[n]=s>=o&&s<=a?t:0}}(o,t,e):function(e,t,n,i,o,a){const{imageData:s,lower:r,upper:l,dimensions:d}=n;let c,h,g;for(let n=0;n<e.length;n++)if(e[n]===t){const u=Ur(s,d,i[o].spacing,i[o].imageData.getPoint(n)),m=({value:e})=>{c+=1,e>=g.lower&&e<=g.upper&&(h+=1)};c=0,h=0,g={lower:r,upper:l};let v=!1;us(s,(()=>!0),m,u),v=0===a?h>0:h===c,e[n]=v?t:0}}(o,t,e,s,a,i)})),Jn(e.volumeId),e};function gu(e){let t="";const n=e[0]<0?"R":"L",i=e[1]<0?"A":"P",o=e[2]<0?"F":"H",a=[Math.abs(e[0]),Math.abs(e[1]),Math.abs(e[2])],s=1e-4;for(let e=0;e<3;e++)if(a[0]>s&&a[0]>a[1]&&a[0]>a[2])t+=n,a[0]=0;else if(a[1]>s&&a[1]>a[0]&&a[1]>a[2])t+=i,a[1]=0;else if(a[2]>s&&a[2]>a[0]&&a[2]>a[1])t+=o,a[2]=0;else if(a[0]>s&&a[1]>s&&a[0]===a[1])t+=n+i,a[0]=0,a[1]=0;else if(a[0]>s&&a[2]>s&&a[0]===a[2])t+=n+o,a[0]=0,a[2]=0;else{if(!(a[1]>s&&a[2]>s&&a[1]===a[2]))break;t+=i+o,a[1]=0,a[2]=0}return t}function uu(e){let t=e.replace("H","f");return t=t.replace("F","h"),t=t.replace("R","l"),t=t.replace("L","r"),t=t.replace("A","p"),t=t.replace("P","a"),t=t.toUpperCase(),t}var mu;!function(e){e.CLIP_STOPPED="CORNERSTONE_CINE_TOOL_STOPPED",e.CLIP_STARTED="CORNERSTONE_CINE_TOOL_STARTED"}(mu||(mu={}));const vu=mu,pu={};function fu(e,t){const n=(0,ne.getEnabledElement)(e),{viewportId:i}=n;pu[i]=t}function Eu(e){const t=(0,ne.getEnabledElement)(e),{viewportId:n}=t;return pu[n]}const{ViewportStatus:wu}=ne.Enums,{triggerEvent:Iu}=ne.utilities,Cu=!0,_u=!0,Tu=new Map;function bu(e,t){let n,i;if(void 0===e)throw new Error("playClip: element must not be undefined");const o=(0,ne.getEnabledElement)(e);if(!o)throw new Error("playClip: element must be a valid Cornerstone enabled element");t.dynamicCineEnabled=t.dynamicCineEnabled??!0;const{viewport:a}=o,s=yu(a),r=function(e,t){if(e instanceof ne.StackViewport)return function(e,t){const n=e.getImageIds();return{get numScrollSteps(){return n.length},get currentStepIndex(){return e.getTargetImageIdIndex()},get frameTimeVectorEnabled(){return!0},waitForRenderedCount:0,scroll(n){this.waitForRenderedCount<=t&&e.viewportStatus!==wu.RENDERED?this.waitForRenderedCount++:(this.waitForRenderedCount=0,hs(e,{delta:n,debounceLoading:Cu}))}}}(e,t.waitForRendered??30);if(e instanceof ne.VolumeViewport){const n=yu(e);return t.dynamicCineEnabled&&n?.isDynamicVolume()?function(e){return{get numScrollSteps(){return e.numTimePoints},get currentStepIndex(){return e.timePointIndex},get frameTimeVectorEnabled(){return!1},scroll(t){e.timePointIndex+=t}}}(n):function(e,t){const{volumeId:n}=t,i={viewPlaneNormal:Oo.R3.create(),scrollInfo:null},o=()=>{const t=e.getCamera();if(!i.scrollInfo||!Oo.R3.equals(t.viewPlaneNormal,i.viewPlaneNormal)){const o=ne.utilities.getVolumeViewportScrollInfo(e,n);i.viewPlaneNormal=t.viewPlaneNormal,i.scrollInfo=o}return i.scrollInfo};return{get numScrollSteps(){return o().numScrollSteps},get currentStepIndex(){return o().currentStepIndex},get frameTimeVectorEnabled(){const n=e.getCamera(),i=t.direction.slice(6,9).map((e=>-e)),o=Oo.R3.dot(i,n.viewPlaneNormal);return Oo.DV.equals(o,1)},scroll(t){o().currentStepIndex+=t,hs(e,{delta:t})}}}(e,n)}throw new Error("Unknown viewport type")}(a,t);let l=Eu(e);const d=t.dynamicCineEnabled&&s?.isDynamicVolume();if(d&&Mu(e),l?Su(e,d):(l={intervalId:void 0,framesPerSecond:30,lastFrameTimeStamp:void 0,ignoreFrameTimeVector:!1,usingFrameTimeVector:!1,frameTimeVector:t.frameTimeVector??void 0,speed:t.frameTimeVectorSpeedMultiplier??1,reverse:t.reverse??!1,loop:t.loop??!0},fu(e,l)),l.dynamicCineEnabled=t.dynamicCineEnabled,(t.framesPerSecond<0||t.framesPerSecond>0)&&(l.framesPerSecond=Number(t.framesPerSecond),l.reverse=l.framesPerSecond<0,l.ignoreFrameTimeVector=!0),!0!==l.ignoreFrameTimeVector&&l.frameTimeVector&&l.frameTimeVector.length===r.numScrollSteps&&r.frameTimeVectorEnabled){const{timeouts:e,isTimeVarying:t}=function(e,t){let n,i,o,a=0;const s=e.length,r=[];let l=!1;("number"!=typeof t||t<=0)&&(t=1);for(n=1;n<s;n++)o=Number(e[n])/t|0,r.push(o),1===n?i=o:o!==i&&(l=!0),a+=o;r.length>0&&(o=l?a/r.length|0:r[0],r.push(o));return{timeouts:r,isTimeVarying:l}}(l.frameTimeVector,l.speed);n=e,i=t}const c=()=>{const{numScrollSteps:t,currentStepIndex:n}=r;let i=n+(l.reverse?-1:1);if(!_u&&(i<0||i>=t)){Su(e,d);const t={element:e};return void Iu(e,vu.CLIP_STOPPED,t)}i>=t?i=0:i<0&&(i=t-1);const o=i-n;o&&r.scroll(o)};d&&Tu.set(s.volumeId,e),n&&n.length>0&&i?(l.usingFrameTimeVector=!0,l.intervalId=window.setTimeout((function e(){l.intervalId=window.setTimeout(e,n[r.currentStepIndex]),c()}),0)):(l.usingFrameTimeVector=!1,l.intervalId=window.setInterval(c,1e3/Math.abs(l.framesPerSecond)));const h={element:e};Iu(e,vu.CLIP_STARTED,h)}function Du(e){Su(e,!0)}function Su(e,t){const n=(0,ne.getEnabledElement)(e);if(!n)return;const{viewport:i}=n,o=Eu(i.element);o&&function(e){const t=e.intervalId;void 0!==t&&(e.intervalId=void 0,e.usingFrameTimeVector?clearTimeout(t):clearInterval(t))}(o),t&&i instanceof ne.BaseVolumeViewport&&Mu(e)}function Mu(e){const{viewport:t}=(0,ne.getEnabledElement)(e),n=yu(t);if(n?.isDynamicVolume()){const t=Tu.get(n.volumeId);Tu.delete(n.volumeId),t&&t!==e&&Du(t)}}function yu(e){const t=function(e){return e.getActors().map((e=>ne.cache.getVolume(e.uid))).filter((e=>!!e))}(e);return t.find((e=>e.isDynamicVolume()))??t[0]}function Ou(e,t,n){if(function(e,t,n){if(!t?.data?.polyline||n<=0)return!0;if(!e.viewport)return!0;const{renderingEngineId:i,viewportId:o,FrameOfReferenceUID:a}=e,s=Mv(o,i);if(t.metadata.FrameOfReferenceUID!==a)return!0;if(!s)return!0;const r=s.getToolInstance(t.metadata.toolName);return!(r instanceof Qh)||r.isDrawing||r.isEditingOpen||r.isEditingClosed}(e,t,n))return!1;const{viewport:i}=e,o=t.data.polyline.map(i.worldToCanvas),a=Rc(o,0,o.length,n);return a!==o&&(t.data.polyline=a.map(i.canvasToWorld),!0)}const xu={interpolateAnnotation:Ou},Ru={};function Pu(e,t){const n=(0,ne.getEnabledElement)(e),{viewportId:i}=n;Ru[i]=t}function Nu(e){const t=(0,ne.getEnabledElement)(e),{viewportId:n}=t;return Ru[n]}const Lu=ne.Enums.RequestType.Prefetch,Au=0;function ku(e,t){e=Math.round(e)||0;const n=[];let i=(t=Math.round(t)||0)-e+1;if(i<=0)return n;for(;i--;)n[i]=t--;return n}function Uu(e){const t=(0,ne.getEnabledElement)(e);if(!t)return null;const{viewport:n}=t;if(!(n instanceof ne.StackViewport))throw new Error("stackPrefetch: element must be a StackViewport, VolumeViewport stackPrefetch not yet implemented");return{currentImageIdIndex:n.getCurrentImageIdIndex(),imageIds:n.getImageIds()}}function Vu(e){return function(t){const n=t.detail;let i;try{i=Uu(e)}catch(e){return}if(!i||!i.imageIds||0===i.imageIds.length)return;const o=i.imageIds.indexOf(n.imageId);if(o<0)return;const a=Nu(e);a&&a.data&&a.data.length&&a.indicesToRequest.push(o)}}const Wu=e=>{const t=new Set(e.imageIds);return e=>e.type!==Lu||!t.has(e.additionalDetails.imageId)};let Hu,Bu={maxImagesToPrefetch:1/0,preserveExistingPool:!0};const Fu=10;function Gu(e){const t=Nu(e);if(!t)return;const n=t||{},i=Uu(e);if(!i?.imageIds?.length)return void console.warn("CornerstoneTools.stackPrefetch: No images in stack.");const{currentImageIdIndex:o}=i;if(n.enabled&&=n.indicesToRequest?.length,!1===n.enabled)return;function a(e){const t=n.indicesToRequest.indexOf(e);t>-1&&n.indicesToRequest.splice(t,1)}t.indicesToRequest.sort(((e,t)=>e-t));if(n.indicesToRequest.slice().forEach((function(e){const t=i.imageIds[e];if(!t)return;(Math.abs(o-e)<6?ne.cache.getImageLoadObject(t):ne.cache.isLoaded(t))&&a(e)})),!n.indicesToRequest.length)return;Bu.preserveExistingPool||ne.imageLoadPoolManager.clearRequestStack(Lu);const s=function(e,t){let n=0,i=e.length-1;return e.forEach(((e,o)=>{e<t?n=Math.max(o,n):e>t&&(i=Math.min(o,i))})),{low:n,high:i}}(n.indicesToRequest,i.currentImageIdIndex);let r,l;let d=s.low,c=s.high;const h=[];for(;d>=0||c<n.indicesToRequest.length;){const e=i.currentImageIdIndex,t=!(e-n.indicesToRequest[d]>Bu.maxImagesToPrefetch)&&d>=0,o=!(n.indicesToRequest[c]-e>Bu.maxImagesToPrefetch)&&c<n.indicesToRequest.length;if(!o&&!t)break;t&&(l=n.indicesToRequest[d--],r=i.imageIds[l],h.push(r)),o&&(l=n.indicesToRequest[c++],r=i.imageIds[l],h.push(r))}const g=(e,t)=>ne.imageLoader.loadAndCacheImage(e,t),{useNorm16Texture:u}=(0,ne.getConfiguration)().rendering;h.forEach((e=>{const t={targetBuffer:{type:u?void 0:"Float32Array"},preScale:{enabled:!0},requestType:Lu};ne.imageLoadPoolManager.addRequest(g.bind(null,e,t),Lu,{imageId:e},Au)}))}function $u(e){clearTimeout(Hu),Hu=setTimeout((function(){const t=e.target;try{Gu(t)}catch(e){return}}),Fu)}const Ku={enable:function(e){const t=Uu(e);if(!t||!t.imageIds||0===t.imageIds.length)return void console.warn("CornerstoneTools.stackPrefetch: No images in stack.");const n={indicesToRequest:ku(0,t.imageIds.length-1),enabled:!0,direction:1},i=n.indicesToRequest.indexOf(t.currentImageIdIndex);n.indicesToRequest.splice(i,1),Pu(e,n),Gu(e),e.removeEventListener(ne.Enums.Events.STACK_NEW_IMAGE,$u),e.addEventListener(ne.Enums.Events.STACK_NEW_IMAGE,$u);const o=Vu(e);ne.eventTarget.removeEventListener(ne.Enums.Events.IMAGE_CACHE_IMAGE_REMOVED,o),ne.eventTarget.addEventListener(ne.Enums.Events.IMAGE_CACHE_IMAGE_REMOVED,o)},disable:function(e){clearTimeout(Hu),e.removeEventListener(ne.Enums.Events.STACK_NEW_IMAGE,$u);const t=Vu(e);ne.eventTarget.removeEventListener(ne.Enums.Events.IMAGE_CACHE_IMAGE_REMOVED,t);const n=Nu(e);n&&n.indicesToRequest.length&&(n.enabled=!1,ne.imageLoadPoolManager.clearRequestStack(Lu))},getConfiguration:function(){return Bu},setConfiguration:function(e){Bu=e}};let qu,zu={maxImagesToPrefetch:1/0,minBefore:2,maxAfter:2,directionExtraImages:10,preserveExistingPool:!1};const ju=5;function Yu(e){const t=Uu(e);if(!t?.imageIds?.length)return void console.warn("CornerstoneTools.stackPrefetch: No images in stack.");const n=Nu(e);if(!n)return;const i=n||{};if(i.enabled&&=i.indicesToRequest?.length,!1===i.enabled)return;function o(e){const t=i.indicesToRequest.indexOf(e);t>-1&&i.indicesToRequest.splice(t,1)}const a=i.indicesToRequest.slice(),{currentImageIdIndex:s}=t;if(a.forEach((e=>{const n=t.imageIds[e];if(!n)return;(Math.abs(s-e)<6?ne.cache.getImageLoadObject(n):ne.cache.isLoaded(n))&&o(e)})),!i.indicesToRequest.length)return;zu.preserveExistingPool||ne.imageLoadPoolManager.filterRequests(Wu(t));const r=(n,a)=>ne.imageLoader.loadAndCacheImage(n,a).then((()=>function(n){o(t.imageIds.indexOf(n));const a=ne.cache.getCachedImageBasedOnImageURI(n),{stats:s}=i,r=a?.image?.decodeTimeInMS||0;if(r){s.imageIds.set(n,r),s.decodeTimeInMS+=r;const e=a?.image?.loadTimeInMS||0;s.loadTimeInMS+=e}if(!i.indicesToRequest.length&&a?.sizeInBytes){const{sizeInBytes:t}=a,n=ne.cache.getMaxCacheSize()/4/t;if(i.cacheFill){if(s.imageIds.size){s.fillTime=Date.now()-s.start;const{size:e}=s.imageIds;s.fillSize=e,console.log("Done cache fill",s.fillTime,"ms",e,"items","average total time",ws(s.fillTime/e),"ms","average load",ws(s.loadTimeInMS/e),"ms","average decode",ws(s.decodeTimeInMS/e),"ms")}}else s.initialTime=Date.now()-s.start,s.initialSize=s.imageIds.size,Xu(e,n),Yu(e)}}(n))),{useNorm16Texture:l}=(0,ne.getConfiguration)().rendering;a.forEach((e=>{const n=t.imageIds[e],i={targetBuffer:{type:l?void 0:"Float32Array"},preScale:{enabled:!0},requestType:Lu};ne.imageLoadPoolManager.addRequest(r.bind(null,n,i),Lu,{imageId:n},Au)}))}function Zu(e){clearTimeout(qu),qu=setTimeout((function(){const t=e.target;try{Xu(t),Yu(t)}catch(e){return}}),ju)}const Xu=(e,t)=>{const n=Uu(e);if(!n||!n.imageIds||0===n.imageIds.length)return void console.warn("CornerstoneTools.stackPrefetch: No images in stack.");const{currentImageIdIndex:i}=n;let{maxAfter:o=2,minBefore:a=2}=zu;const{directionExtraImages:s=10}=zu,r=Nu(e)||{indicesToRequest:[],currentImageIdIndex:i,stackCount:0,enabled:!0,direction:1,stats:{start:Date.now(),imageIds:new Map,decodeTimeInMS:0,loadTimeInMS:0,totalBytes:0}},l=i-r.currentImageIdIndex;if(r.direction=l<0?-1:1,r.currentImageIdIndex=i,r.enabled=!0,r.stackCount<100&&(r.stackCount+=s),Math.abs(l)>o||!l)if(r.stackCount=0,t){const e=i/n.imageIds.length;a=Math.ceil(t*e),o=Math.ceil(t*(1-e)),r.cacheFill=!0}else r.cacheFill=!1;else l<0?(a+=r.stackCount,o=0):(o+=r.stackCount,a=0);const d=Math.max(0,i-a),c=Math.min(n.imageIds.length-1,i+o),h=[];for(let e=i+1;e<=c;e++)h.push(e);for(let e=i-1;e>=d;e--)h.push(e);r.indicesToRequest=h,Pu(e,r)};const Ju={enable:e=>{const t=Uu(e);if(!t||!t.imageIds||0===t.imageIds.length)return void console.warn("CornerstoneTools.stackPrefetch: No images in stack.");Xu(e),Yu(e),e.removeEventListener(ne.Enums.Events.STACK_NEW_IMAGE,Zu),e.addEventListener(ne.Enums.Events.STACK_NEW_IMAGE,Zu);const n=Vu(e);ne.eventTarget.removeEventListener(ne.Enums.Events.IMAGE_CACHE_IMAGE_REMOVED,n),ne.eventTarget.addEventListener(ne.Enums.Events.IMAGE_CACHE_IMAGE_REMOVED,n)},disable:function(e){clearTimeout(qu),e.removeEventListener(ne.Enums.Events.STACK_NEW_IMAGE,Zu);const t=Vu(e);ne.eventTarget.removeEventListener(ne.Enums.Events.IMAGE_CACHE_IMAGE_REMOVED,t);const n=Nu(e);n&&n.data.length&&(n.enabled=!1)},getConfiguration:function(){return zu},setConfiguration:function(e){zu=e}};const Qu=function(e,t){const n=t.frameNumbers||[...Array(e.numTimePoints).keys()];if(!t.maskVolumeId&&!t.imageCoordinate)throw new Error("You should provide either maskVolumeId or imageCoordinate");if(t.maskVolumeId&&t.imageCoordinate)throw new Error("You can only use one of maskVolumeId or imageCoordinate");if(t.maskVolumeId){const i=ne.cache.getVolume(t.maskVolumeId),[o,a]=function(e,t,n){const{imageData:i}=n,o=n.getScalarData(),a=o.length,s=[];s.length=a;const r=[],l=n.dimensions;let d=0;for(let e=0,t=o.length;e<t;e++)0!==o[e]&&(r.push([e%l[0],Math.floor(e/l[0]%l[1]),Math.floor(e/(l[0]*l[1]))]),s[d++]=e);s.length=d;const c=t.getScalarDataArrays(),h=[],g=c[0].length===a&&JSON.stringify(t.spacing)===JSON.stringify(n.spacing);if(g){for(let t=0;t<s.length;t++){const n=[];e.forEach((e=>{const i=c[e];n.push(i[s[t]])})),h.push(n)}return[h,r]}const u=({pointLPS:n,value:i,pointIJK:o})=>{if(0===i)return;const a=Ur(t.imageData,t.dimensions,t.spacing,n);let s=0;const l=new Map;e.forEach((e=>l.set(e,0)));const d=({index:t})=>{for(let n=0;n<e.length;n++){const i=c[n][t],o=e[n];l.set(o,l.get(o)+i)}s++};us(t.imageData,(()=>!0),d,a);const g=[];l.forEach((e=>{g.push(e/s)})),r.push(o),h.push(g)};return us(i,(()=>!0),u),[h,r]}(n,e,i);return[o,a]}if(t.imageCoordinate){const i=function(e,t,n){const{dimensions:i,imageData:o}=n,a=o.worldToIndex(t);if(a[0]=Math.floor(a[0]),a[1]=Math.floor(a[1]),a[2]=Math.floor(a[2]),!ne.utilities.indexWithinDimensions(a,i))throw new Error("outside bounds");const s=i[0],r=i[0]*i[1],l=n.getScalarDataArrays(),d=[];return e.forEach((e=>{const t=l[e],n=a[2]*r+a[1]*s+a[0];d.push(t[n])})),d}(n,t.imageCoordinate,e);return i}};const em=function(e,t,n){const i=n||[...Array(e.numTimePoints).keys()],o=i.length;if(i.length<=1)throw new Error("Please provide two or more time points");const a=e.getScalarDataArrays(),s=a[0].length,r=new Float32Array(s);if(t===ne.Enums.DynamicOperatorType.SUM){for(let e=0;e<o;e++){const t=a[i[e]];for(let e=0;e<s;e++)r[e]+=t[e]}return r}if(t===ne.Enums.DynamicOperatorType.SUBTRACT){if(i.length>2)throw new Error("Please provide only 2 time points for subtraction.");for(let e=0;e<s;e++)r[e]+=a[i[0]][e]-a[i[1]][e];return r}if(t===ne.Enums.DynamicOperatorType.AVERAGE){for(let e=0;e<o;e++){const t=a[i[e]];for(let e=0;e<s;e++)r[e]+=t[e]}for(let e=0;e<s;e++)r[e]=r[e]/o;return r}};function tm(e,t){if(t<e.length/3)return[e[3*t],e[3*t+1],e[3*t+2]]}function nm(e){const t=e.getLines().getData();let n=0;const i=new Map;for(;n<t.length;){const e=t[n++],o=[];for(let i=0;i<e;i++)o.push(t[n+i]);i.set(o[0],o),n+=e}const o=[],a=e=>{for(const[t,n]of e.entries())if(void 0!==n)return t;return-1};let s=a(i);for(;-1!==s;){const e=[s];for(;i.has(s);){const t=i.get(s)[1];i.has(t)&&e.push(t),i.delete(s),s=t}o.push(e),s=a(i)}return o.length?o:void 0}function im(e){const t=nm(e);if(!t)return;const n=e.getPoints().getData();return t.map((e=>e.map((e=>tm(n,e)))))}var om;!function(e){e.Top="top",e.Left="left",e.Bottom="bottom",e.Right="right"}(om||(om={}));const am=e=>e&&e.upper>e.lower,sm=e=>!!e&&e.width>0&&e.height>0,rm=(e,t)=>!!e&&!!t&&e.lower===t.lower&&e.upper===t.upper,lm=(e,t)=>!!e&&!!t&&e.width===t.width&&e.height===t.height,{clamp:dm}=ne.utilities;class cm{constructor(e){cm.validateProps(e);const{colormap:t,size:n={width:20,height:100},imageRange:i={lower:0,upper:1},voiRange:o={lower:0,upper:1},container:a,showFullPixelValueRange:s=!1}=e;this._colormap=t,this._imageRange=i,this._voiRange=o,this._showFullImageRange=s,this._canvas=this._createRootElement(n),a&&this.appendTo(a)}get colormap(){return this._colormap}set colormap(e){this._colormap=e,this.render()}get size(){const{width:e,height:t}=this._canvas;return{width:e,height:t}}set size(e){const{_canvas:t}=this;sm(e)&&!lm(t,e)&&(this._setCanvasSize(t,e),this.render())}get imageRange(){return{...this._imageRange}}set imageRange(e){am(e)&&!rm(e,this._imageRange)&&(this._imageRange=e,this.render())}get voiRange(){return{...this._voiRange}}set voiRange(e){am(e)&&!rm(e,this._voiRange)&&(this._voiRange=e,this.render())}get showFullImageRange(){return this._showFullImageRange}set showFullImageRange(e){e!==this._showFullImageRange&&(this._showFullImageRange=e,this.render())}appendTo(e){e.appendChild(this._canvas),this.render()}dispose(){const{_canvas:e}=this,{parentElement:t}=e;t?.removeChild(e)}static validateProps(e){const{size:t,imageRange:n,voiRange:i}=e;if(t&&!sm(t))throw new Error('Invalid "size"');if(n&&!am(n))throw new Error('Invalid "imageRange"');if(i&&!am(i))throw new Error('Invalid "voiRange"')}_setCanvasSize(e,t){const{width:n,height:i}=t;e.width=n,e.height=i,Object.assign(e.style,{width:`${n}px`,height:`${i}px`})}_createRootElement(e){const t=document.createElement("canvas");return Object.assign(t.style,{position:"absolute",top:"0",left:"0",pointerEvents:"none",boxSizing:"border-box"}),this._setCanvasSize(t,e),t}render(){if(!this._canvas.isConnected)return;const{_colormap:e}=this,{RGBPoints:t}=e,n=t.length/4,i=e=>{const i=4*e;if(!(e<0||e>=n))return{index:e,position:t[i],color:[t[i+1],t[i+2],t[i+3]]}},{width:o,height:a}=this._canvas,s=this._canvas.getContext("2d"),r=o>a,l=r?o:a,{_voiRange:d}=this,c=this._showFullImageRange?this._imageRange:{...d},{windowWidth:h}=ne.utilities.windowLevel.toWindowLevel(d.lower,d.upper);let g,u=i(0);const m=(c.upper-c.lower)/(l-1);let v=c.lower;for(let e=0;e<l;e++){const t=(v-d.lower)/h;if(u)for(let e=u.index;e<n&&!(t<=u.position);e++)g=u,u=i(e+1);let l;if(g)if(u){const e=(t-g.position)/(u.position-g.position);p=g.color,f=u.color,E=e,l=[p[0]*(1-E)+f[0]*E,p[1]*(1-E)+f[1]*E,p[2]*(1-E)+f[2]*E]}else l=[...g.color];else l=[...u.color];const c=l.map((e=>dm(Math.round(255*e),0,255)));s.fillStyle=`rgb(${c[0]}, ${c[1]}, ${c[2]})`,r?s.fillRect(e,0,1,a):s.fillRect(0,a-e-1,o,1),v+=m}var p,f,E}}const hm={FONT:"10px Arial",COLOR:"white",TICK_SIZE:5,TICK_WIDTH:1,TICK_LABEL_MARGIN:3,MAX_NUM_TICKS:8,TICKS_STEPS:[1,2.5,5,10]};class gm{constructor(e){gm.validateProps(e);const{top:t=0,left:n=0,size:i={width:20,height:100},imageRange:o={lower:0,upper:1},voiRange:a={lower:0,upper:1},ticks:s,container:r,showFullPixelValueRange:l=!1}=e,{style:d,position:c}=s??{};this._imageRange=o,this._voiRange=a,this._font=d?.font??hm.FONT,this._color=d?.color??hm.COLOR,this._tickSize=d?.tickSize??hm.TICK_SIZE,this._tickWidth=d?.tickWidth??hm.TICK_WIDTH,this._labelMargin=d?.labelMargin??hm.TICK_LABEL_MARGIN,this._maxNumTicks=d?.maxNumTicks??hm.MAX_NUM_TICKS,this._rangeTextPosition=c??om.Right,this._showFullPixelValueRange=l,this._canvas=this._createCanvasElement(i,t,n),r&&this.appendTo(r)}get size(){const{width:e,height:t}=this._canvas;return{width:e,height:t}}set size(e){const{_canvas:t}=this;sm(e)&&!lm(t,e)&&(this._setCanvasSize(t,e),this.render())}get top(){return Number.parseInt(this._canvas.style.top)}set top(e){const{_canvas:t}=this;e!==this.top&&(t.style.top=`${e}px`,this.render())}get left(){return Number.parseInt(this._canvas.style.left)}set left(e){const{_canvas:t}=this;e!==this.left&&(t.style.left=`${e}px`,this.render())}get imageRange(){return{...this._imageRange}}set imageRange(e){am(e)&&!rm(e,this._imageRange)&&(this._imageRange=e,this.render())}get voiRange(){return{...this._voiRange}}set voiRange(e){am(e)&&!rm(e,this._voiRange)&&(this._voiRange=e,this.render())}get tickSize(){return this._tickSize}set tickSize(e){e!==this._tickSize&&(this._tickSize=e,this.render())}get tickWidth(){return this._tickWidth}set tickWidth(e){e!==this._tickWidth&&(this._tickWidth=e,this.render())}get color(){return this._color}set color(e){e!==this._color&&(this._color=e,this.render())}get showFullPixelValueRange(){return this._showFullPixelValueRange}set showFullPixelValueRange(e){e!==this._showFullPixelValueRange&&(this._showFullPixelValueRange=e,this.render())}get visible(){return"block"===this._canvas.style.display}set visible(e){e!==this.visible&&(this._canvas.style.display=e?"block":"none",e&&this.render())}appendTo(e){e.appendChild(this._canvas),this.render()}static validateProps(e){const{size:t,imageRange:n,voiRange:i}=e;if(t&&!sm(t))throw new Error('Invalid "size"');if(n&&!am(n))throw new Error('Invalid "imageRange"');if(i&&!am(i))throw new Error('Invalid "voiRange"')}_setCanvasSize(e,t){const{width:n,height:i}=t;e.width=n,e.height=i,Object.assign(e.style,{width:`${n}px`,height:`${i}px`})}_createCanvasElement(e,t,n){const i=document.createElement("canvas");return Object.assign(i.style,{display:"none",position:"absolute",boxSizing:"border-box",top:`${t}px`,left:`${n}px`}),this._setCanvasSize(i,e),i}_getTicks(e){const{lower:t,upper:n}=e,i=(n-t)/(this._maxNumTicks-1),o=Math.pow(10,-Math.floor(Math.log10(Math.abs(i)))),a=i*o,s=hm.TICKS_STEPS.find((e=>e>=a))/o,r=Math.ceil(n/s)*s,l=Math.floor(t/s)*s,d=Math.round((r-l)/s)+1,c=[];for(let e=0;e<d;e++)c.push(l+e*s);return{scaleMin:l,scaleMax:r,step:s,ticks:c}}_getLeftTickInfo({position:e,labelMeasure:t}){const{width:n}=this._canvas;return{labelPoint:[n-this.tickSize-t.width-this._labelMargin,e],tickPoints:{start:[n-this._tickSize,e],end:[n,e]}}}_getRightTickInfo({position:e}){return{labelPoint:[this._tickSize+this._labelMargin,e],tickPoints:{start:[0,e],end:[this._tickSize,e]}}}_getTopTickInfo({position:e,labelMeasure:t}){throw new Error("Not implemented")}_getBottomTickInfo({position:e,labelMeasure:t}){throw new Error("Not implemented")}render(){const{_canvas:e}=this;if(!e.isConnected||!this.visible)return;const{width:t,height:n}=e,i=t>=n,o=i?t:n,a=e.getContext("2d"),{_voiRange:s}=this,r=this._showFullPixelValueRange?this._imageRange:{...s},l=r.upper-r.lower,{ticks:d}=this._getTicks(r);a.clearRect(0,0,t,n),a.font=this._font,a.textBaseline="middle",a.fillStyle=this._color,a.strokeStyle=this._color,a.lineWidth=this.tickWidth,d.forEach((e=>{let t=Math.round(o*((e-r.lower)/l));if(i||(t=n-t),t<0||t>o)return;const s=e.toString(),d=a.measureText(s);let c;c=i?this._rangeTextPosition===om.Top?this._getTopTickInfo({position:t,labelMeasure:d}):this._getBottomTickInfo({position:t,labelMeasure:d}):this._rangeTextPosition===om.Left?this._getLeftTickInfo({position:t,labelMeasure:d}):this._getRightTickInfo({position:t});const{labelPoint:h,tickPoints:g}=c,{start:u,end:m}=g;return a.beginPath(),a.moveTo(u[0],u[1]),a.lineTo(m[0],m[1]),a.fillText(s,h[0],h[1]),a.stroke(),t}))}}class um{constructor({id:e,container:t}){this._containerResizeCallback=e=>{let t,n;const{contentRect:i,contentBoxSize:o}=e[0];i?(t=i.width,n=i.height):o?.length&&(t=o[0].inlineSize,n=o[0].blockSize),this._containerSize={width:t,height:n},this.onContainerResize()},this._id=e,this._containerSize={width:0,height:0},this._rootElement=this.createRootElement(e),this._containerResizeObserver=new ResizeObserver(this._containerResizeCallback),t&&this.appendTo(t)}get id(){return this._id}get rootElement(){return this._rootElement}appendTo(e){const{_rootElement:t,_containerResizeObserver:n}=this,{parentElement:i}=t;e&&e!==i&&(i&&n.unobserve(i),e.appendChild(t),n.observe(e))}destroy(){const{_rootElement:e,_containerResizeObserver:t}=this,{parentElement:n}=e;n?.removeChild(e),t.disconnect()}get containerSize(){return{...this._containerSize}}createRootElement(e){const t=document.createElement("div");return t.id=e,t.classList.add("widget"),Object.assign(t.style,{width:"100%",height:"100%"}),t}onContainerResize(){}}const mm={MULTIPLIER:1,RANGE_TEXT_POSITION:om.Right,TICKS_BAR_SIZE:50};class vm extends um{constructor(e){super(e),this._isMouseOver=!1,this._isInteracting=!1,this._mouseOverCallback=e=>{this._isMouseOver=!0,this.showTicks(),e.stopPropagation()},this._mouseOutCallback=e=>{this._isMouseOver=!1,this.hideTicks(),e.stopPropagation()},this._mouseDownCallback=e=>{this._isInteracting=!0,this.showTicks(),this._addVOIEventListeners(e),e.stopPropagation()},this._mouseDragCallback=(e,t)=>{const n=this.getVOIMultipliers(),i=this._getPointsFromMouseEvent(e),{points:o,voiRange:a}=t,s=Oo.K4.sub(Oo.K4.create(),i.local,o.local),r=s[0]*n[0],l=s[1]*n[1];if(!r&&!l)return;const{lower:d,upper:c}=a;let{windowWidth:h,windowCenter:g}=ne.utilities.windowLevel.toWindowLevel(d,c);h=Math.max(h+r,1),g+=l;const u=ne.utilities.windowLevel.toLowHighRange(h,g);this.voiRange=u,e.stopPropagation(),e.preventDefault()},this._mouseUpCallback=e=>{this._isInteracting=!1,this.hideTicks(),this._removeVOIEventListeners(),e.stopPropagation()},this._eventListenersManager=new ne.utilities.eventListener.MultiTargetEventListenerManager,this._colormaps=vm.getColormapsMap(e),this._activeColormapName=vm.getInitialColormapName(e),this._canvas=this._createCanvas(e),this._ticksBar=this._createTicksBar(e),this._rangeTextPosition=e.ticks?.position??mm.RANGE_TEXT_POSITION,this._canvas.appendTo(this.rootElement),this._ticksBar.appendTo(this.rootElement),this._addRootElementEventListeners()}get activeColormapName(){return this._activeColormapName}set activeColormapName(e){if(e===this._activeColormapName)return;const t=this._colormaps.get(e);t?(this._activeColormapName=e,this._canvas.colormap=t):console.warn(`Invalid colormap name (${e})`)}get imageRange(){return this._canvas.imageRange}set imageRange(e){this._canvas.imageRange=e,this._ticksBar.imageRange=e}get voiRange(){return this._canvas.voiRange}set voiRange(e){const{voiRange:t}=this._canvas;am(e)&&!rm(e,t)&&(this._canvas.voiRange=e,this._ticksBar.voiRange=e,this.onVoiChange(e))}get showFullImageRange(){return this._canvas.showFullImageRange}set showFullImageRange(e){this._canvas.showFullImageRange=e,this._ticksBar.showFullPixelValueRange=e}destroy(){super.destroy(),this._eventListenersManager.reset()}createRootElement(){const e=document.createElement("div");return Object.assign(e.style,{position:"relative",fontSize:"0",width:"100%",height:"100%"}),e}onContainerResize(){super.onContainerResize(),this.updateTicksBar(),this._canvas.size=this.containerSize}getVOIMultipliers(){return[mm.MULTIPLIER,mm.MULTIPLIER]}onVoiChange(e){}showTicks(){this.updateTicksBar(),this._ticksBar.visible=!0}hideTicks(){this._isInteracting||this._isMouseOver||(this._ticksBar.visible=!1)}static getColormapsMap(e){const{colormaps:t}=e;return t.reduce(((e,t)=>e.set(t.Name,t)),new Map)}static getInitialColormapName(e){const{activeColormapName:t,colormaps:n}=e;return!!t&&n.some((e=>e.Name===t))?t:n[0].Name}_createCanvas(e){const{imageRange:t,voiRange:n,showFullPixelValueRange:i}=e,o=this._colormaps.get(this._activeColormapName);return new cm({colormap:o,imageRange:t,voiRange:n,showFullPixelValueRange:i})}_createTicksBar(e){const t=e.ticks;return new gm({imageRange:e.imageRange,voiRange:e.voiRange,ticks:t,showFullPixelValueRange:e.showFullPixelValueRange})}_getPointsFromMouseEvent(e){const{rootElement:t}=this,n=[e.clientX,e.clientY],i=[e.pageX,e.pageY],o=t.getBoundingClientRect();return{client:n,page:i,local:[i[0]-o.left-window.pageXOffset,i[1]-o.top-window.pageYOffset]}}updateTicksBar(){const{width:e,height:t}=this.containerSize;if(0===e&&0===t)return;const{_ticksBar:n,_rangeTextPosition:i}=this,o=e>=t,a=o?e:mm.TICKS_BAR_SIZE,s=o?mm.TICKS_BAR_SIZE:t;if(!function(e,t,n){return(e>=t?[om.Top,om.Bottom]:[om.Left,om.Right]).includes(n)}(e,t,i))throw new Error("Invalid rangeTextPosition value for the current colobar orientation");let r,l;n.size={width:a,height:s},o?(l=0,r=i===om.Top?-s:t):(r=0,l=i===om.Left?-a:e),n.top=r,n.left=l}_addRootElementEventListeners(){const{_eventListenersManager:e}=this,{rootElement:t}=this;e.addEventListener(t,"mouseover",this._mouseOverCallback),e.addEventListener(t,"mouseout",this._mouseOutCallback),e.addEventListener(t,"mousedown",this._mouseDownCallback)}_addVOIEventListeners(e){const{_eventListenersManager:t}=this,n={points:this._getPointsFromMouseEvent(e),voiRange:{...this._canvas.voiRange}};this._removeVOIEventListeners(),t.addEventListener(document,"voi.mouseup",this._mouseUpCallback),t.addEventListener(document,"voi.mousemove",(e=>this._mouseDragCallback(e,n)))}_removeVOIEventListeners(){const{_eventListenersManager:e}=this;e.removeEventListener(document,"voi.mouseup"),e.removeEventListener(document,"voi.mousemove")}}const{Events:pm}=ne.Enums,fm={lower:-1e3,upper:1e3};class Em extends vm{constructor(e){const{element:t,volumeId:n}=e,i=Em._getImageRange(t,n),o=Em._getVOIRange(t,n);super({...e,imageRange:i,voiRange:o}),this.autoHideTicks=()=>{if(this._hideTicksTimeoutId)return;const e=this._hideTicksTime-Date.now();e<=0?this.hideTicks():this._hideTicksTimeoutId=window.setTimeout((()=>{this._hideTicksTimeoutId=0,this.autoHideTicks()}),e)},this._stackNewImageCallback=()=>{this.imageRange=Em._getImageRange(this._element)},this._imageVolumeModifiedCallback=e=>{const{volumeId:t}=e.detail.imageVolume;if(t!==this._volumeId)return;const{_element:n}=this;this.imageRange=Em._getImageRange(n,t)},this._viewportVOIModifiedCallback=e=>{const{viewportId:t,volumeId:n,range:i}=e.detail,{viewport:o}=this.enabledElement;t===o.id&&n===this._volumeId&&(this.voiRange=i,this.showAndAutoHideTicks())},this._element=t,this._volumeId=n,this._addCornerstoneEventListener()}get element(){return this._element}get enabledElement(){return(0,ne.getEnabledElement)(this._element)}getVOIMultipliers(){const{viewport:e}=this.enabledElement;return function(e,t,n){if("PT"===ne.utilities.getViewportModality(e,t)){const{clientWidth:i,clientHeight:o}=e.element,a=5/Math.max(i,o),s=jd(e,t),{fixedPTWindowWidth:r=!0}=n??{},l=r?0:a;return s?[l,a]:[l,4]}return[4,4]}(e,this._volumeId)}onVoiChange(e){super.onVoiChange(e);const{viewport:t}=this.enabledElement;if(t instanceof ne.StackViewport)t.setProperties({voiRange:e}),t.render();else if(t instanceof ne.VolumeViewport){const{_volumeId:n}=this,i=ne.utilities.getViewportsWithVolumeId(n,t.renderingEngineId);t.setProperties({voiRange:e},n),i.forEach((e=>e.render()))}}static _getImageRange(e,t){const n=(0,ne.getEnabledElement)(e),{viewport:i}=n,o=t?i.getActor(t):i.getDefaultActor();if(!o)return fm;const a=o.actor.getMapper().getInputData().getPointData().getScalars().getRange();return 0===a[0]&&0===a[1]?fm:{lower:a[0],upper:a[1]}}static _getVOIRange(e,t){const n=(0,ne.getEnabledElement)(e),{viewport:i}=n,o=t?i.getActor(t):i.getDefaultActor();if(!o||!ne.utilities.isImageActor(o))return fm;const a=o.actor.getProperty().getRGBTransferFunction(0).getRange();return 0===a[0]&&0===a[1]?fm:{lower:a[0],upper:a[1]}}showAndAutoHideTicks(e=1e3){this._hideTicksTime=Date.now()+e,this.showTicks(),this.autoHideTicks()}_addCornerstoneEventListener(){const{_element:e}=this;ne.eventTarget.addEventListener(pm.IMAGE_VOLUME_MODIFIED,this._imageVolumeModifiedCallback),e.addEventListener(pm.STACK_NEW_IMAGE,this._stackNewImageCallback),e.addEventListener(pm.VOI_MODIFIED,this._viewportVOIModifiedCallback)}}const wm=function(e){if(!e.detail.removed.length)return;(0,ne.getRenderingEngines)().forEach((e=>{const t=e.getViewports().map((e=>e.id));cs(e,t)}))};const Im=function(e){const{viewportId:t,renderingEngineId:n}=e.detail,i=(0,ne.getRenderingEngine)(n);cs(i,[t])},Cm=function(e){ra(e.detail.element)},_m={enable:function(e){e.addEventListener(ne.Enums.Events.IMAGE_RENDERED,Cm)},disable:function(e){e.removeEventListener(ne.Enums.Events.IMAGE_RENDERED,Cm)}},{Active:Tm}=ie;function bm(e,t,n){if(Je.isInteractingWithTool)return!1;const{renderingEngineId:i,viewportId:o}=n.detail,a=Mv(o,i);if(!a)return!1;let s;const r=Object.keys(a.toolOptions);for(let e=0;e<r.length;e++){const n=r[e],i=a.toolOptions[n],o=a.getToolInstance(n);if(i.mode===Tm&&"function"==typeof o[t]){s=a.getToolInstance(n);break}}s&&s[t](n)}const Dm=bm.bind(null,"Mouse","mouseClickCallback"),Sm=bm.bind(null,"Mouse","doubleClickCallback");function Mm(e,t,n,i="mouse"){const o="touch"===i?36:6,a=[];return t.forEach((({tool:t,annotations:i})=>{for(const s of i){if(s.isLocked||!s.isVisible)continue;const i=t.getHandleNearImagePoint(e,s,n,o);if(i){a.push({tool:t,annotation:s,handle:i});break}}})),a}function ym(e,t){const n=[];for(let i=0;i<t.length;i++){const o=t[i];if(!o){console.warn("undefined tool in filterToolsWithAnnotationsForElement");continue}let a=sp(o.constructor.toolName,e);a?.length&&("function"==typeof o.filterInteractableAnnotationsForElement&&(a=o.filterInteractableAnnotationsForElement(e,a)),a.length>0&&n.push({tool:o,annotations:a}))}return n}function Om(e,t,n,i="mouse"){const o="touch"===i?36:6,a=[];return t.forEach((({tool:t,annotations:s})=>{for(const r of s){if(r.isLocked||!r.isVisible)continue;if(t.isPointNearTool(e,r,n,o,i)){a.push({tool:t,annotation:r});break}}})),a}const xm=e=>e.shiftKey?e.ctrlKey?ee.ShiftCtrl:e.altKey?ee.ShiftAlt:e.metaKey?ee.ShiftMeta:ee.Shift:e.ctrlKey?e.altKey?ee.CtrlAlt:e.metaKey?ee.CtrlMeta:ee.Ctrl:e.altKey?e.metaKey&&ee.AltMeta||ee.Alt:e.metaKey?ee.Meta:void 0,{Active:Rm}=ie;function Pm(e){const{renderingEngineId:t,viewportId:n}=e.detail,i=e.detail.event,o=xm(i)||Un.getModifierKey(),a=Mv(n,t);if(!a)return null;const s=Object.keys(a.toolOptions),r=a.getDefaultMousePrimary();for(let e=0;e<s.length;e++){const t=s[e],n=a.toolOptions[t],l=n.bindings.length&&n.bindings.some((e=>e.mouseButton===(i?i.buttons:r)&&e.modifierKey===o));if(n.mode===Rm&&l)return a.getToolInstance(t)}}function Nm(e,t,n){const{renderingEngineId:i,viewportId:o}=e.detail,a=Mv(o,i);if(!a)return[];const s=[],r=Object.keys(a.toolOptions);for(let e=0;e<r.length;e++){const i=r[e],o=a.toolOptions[i],l=null!=n&&o.bindings.length&&o.bindings.some((e=>e.mouseButton===n));if(t.includes(o.mode)&&(!n||l)){const e=a.getToolInstance(i);s.push(e)}}return s}const{Active:Lm,Passive:Am}=ie;function km(e){if(Je.isInteractingWithTool)return!1;const t=e.detail,{element:n}=t,i=(0,ne.getEnabledElement)(n),{canvas:o}=t.currentPoints;if(!i)return!1;const a=function(e,t){const n=new Map,{renderingEngineId:i,viewportId:o}=e.detail,a=Mv(o,i);if(!a)return n;const s=Object.keys(a.toolOptions),r=a.getDefaultMousePrimary(),l=e.detail.event,d=l?.buttons??r,c=xm(l)||Un.getModifierKey();for(let e=0;e<s.length;e++){const i=s[e],o=a.getToolInstance(i),r=o.configuration?.actions??{},l=Object.values(r);if(!l?.length||!t.includes(o.mode))continue;const h=l.find((e=>e.bindings.length&&e.bindings.some((e=>e.mouseButton===d&&e.modifierKey===c))));h&&n.set(o,h)}return n}(e,[Lm,Am]),s=Om(n,ym(n,Array.from(a.keys())),o);if(s.length>0){const{tool:t,annotation:n}=s[0],i=a.get(t);return("string"==typeof i.method?t[i.method]:i.method).call(t,e,n),!0}return!1}const{Active:Um,Passive:Vm}=ie;function Wm(e){if(Je.isInteractingWithTool)return;const t=Pm(e);if(t&&"function"==typeof t.preMouseDownCallback){if(t.preMouseDownCallback(e))return}const n=1===e.detail.event.buttons,i=[...Nm(e,[Um],e.detail.event.buttons)||[],...(n?Nm(e,[Vm]):void 0)||[]];if(km(e))return;const o=e.detail,{element:a}=o,s=ym(a,i),r=o.currentPoints.canvas,l=Mm(a,s,r,"mouse"),d=!!e.detail.event.shiftKey;if(l.length>0){const{tool:t,annotation:n,handle:i}=Hm(l);return Bm(n.annotationUID,d),void t.handleSelectedCallback(e,n,i,"Mouse")}const c=Om(a,s,r,"mouse");if(c.length>0){const{tool:t,annotation:n}=Hm(c);return Bm(n.annotationUID,d),void t.toolSelectedCallback(e,n,"Mouse",r)}if(t&&"function"==typeof t.postMouseDownCallback){if(t.postMouseDownCallback(e))return}}function Hm(e){return e.length>1&&e.find((e=>!we(e.annotation)&&He(e.annotation.annotationUID)))||e[0]}function Bm(e,t=!1){if(t)if(Pe(e))ye(e,!1);else{ye(e,!0,!0)}else{ye(e,!0,!1)}}function Fm(e){if(Je.isInteractingWithTool)return;const t=Pm(e);if(t&&!Je.isMultiPartToolActive&&t.addNewAnnotation){ye(t.addNewAnnotation(e,"mouse").annotationUID)}}function Gm(e){if(Je.isInteractingWithTool)return;const t=Pm(e);!t||"function"!=typeof t.mouseDragCallback||t.mouseDragCallback(e)}const{Active:$m,Passive:Km}=ie;function qm(e){if(Je.isInteractingWithTool||Je.isMultiPartToolActive)return;const t=Nm(e,[$m,Km]),n=e.detail,{element:i}=n,o=ym(i,t),a=t.filter((e=>!o.some((t=>t.tool.getToolName()===e.getToolName()))));let s=!1;for(const{tool:t,annotations:n}of o)"function"==typeof t.mouseMoveCallback&&(s=t.mouseMoveCallback(e,n)||s);a.forEach((t=>{"function"==typeof t.mouseMoveCallback&&t.mouseMoveCallback(e)})),!0===s&&ra(i)}const zm=bm.bind(null,"Mouse","mouseUpCallback"),jm=bm.bind(null,"MouseWheel","mouseWheelCallback"),Ym={enable:function(e){e.addEventListener(re.MOUSE_CLICK,Dm),e.addEventListener(re.MOUSE_DOWN,Wm),e.addEventListener(re.MOUSE_DOWN_ACTIVATE,Fm),e.addEventListener(re.MOUSE_DOUBLE_CLICK,Sm),e.addEventListener(re.MOUSE_DRAG,Gm),e.addEventListener(re.MOUSE_MOVE,qm),e.addEventListener(re.MOUSE_UP,zm),e.addEventListener(re.MOUSE_WHEEL,jm)},disable:function(e){e.removeEventListener(re.MOUSE_CLICK,Dm),e.removeEventListener(re.MOUSE_DOWN,Wm),e.removeEventListener(re.MOUSE_DOWN_ACTIVATE,Fm),e.removeEventListener(re.MOUSE_DOUBLE_CLICK,Sm),e.removeEventListener(re.MOUSE_DRAG,Gm),e.removeEventListener(re.MOUSE_MOVE,qm),e.removeEventListener(re.MOUSE_UP,zm),e.removeEventListener(re.MOUSE_WHEEL,jm)}},{Active:Zm}=ie;function Xm(e){const{renderingEngineId:t,viewportId:n}=e.detail,i=ut.mouseButton,o=Un.getModifierKey(),a=Mv(n,t);if(!a)return null;const s=Object.keys(a.toolOptions),r=a.getDefaultMousePrimary();for(let e=0;e<s.length;e++){const t=s[e],n=a.toolOptions[t];if(n.mode!==Zm)continue;if(n.bindings.length&&n.bindings.some((e=>e.mouseButton===(i??r)&&e.modifierKey===o)))return a.getToolInstance(t)}}function Jm(e){const t=Xm(e);if(t){const{renderingEngineId:n,viewportId:i}=e.detail,o=Mv(i,n),a=t.getToolName();Object.keys(o.toolOptions).includes(a)&&o.setViewportsCursorByToolName(a)}const n=function(e,t){const n=new Map,{renderingEngineId:i,viewportId:o}=e.detail,a=Mv(o,i);if(!a)return n;const s=Object.keys(a.toolOptions),r=e.detail.key;for(let e=0;e<s.length;e++){const i=s[e],o=a.getToolInstance(i),l=o.configuration?.actions;if(!l)continue;const d=Object.values(l);if(!d?.length||!t.includes(o.mode))continue;const c=d.find((e=>e.bindings.some((e=>e.key===r))));c&&n.set(o,c)}return n}(e,[ie.Active]);if(n?.size){const{element:t}=e.detail;for(const[e,i]of[...n.entries()])e[i.method](t)}}function Qm(e){const t=Xm(e);if(!t)return;const{renderingEngineId:n,viewportId:i}=e.detail,o=Mv(i,n);Ln();const a=t.getToolName();Object.keys(o.toolOptions).includes(a)&&o.setViewportsCursorByToolName(a)}const ev={enable:function(e){e.addEventListener(re.KEY_DOWN,Jm),e.addEventListener(re.KEY_UP,Qm)},disable:function(e){e.removeEventListener(re.KEY_DOWN,Jm),e.removeEventListener(re.KEY_UP,Qm)}},{Active:tv,Passive:nv,Enabled:iv}=ie,ov=function(e){Nm(e,[tv,nv,iv]).forEach((t=>{t.onCameraModified&&t.onCameraModified(e)}))},av={enable:function(e){e.addEventListener(ne.Enums.Events.CAMERA_MODIFIED,ov)},disable:function(e){e.removeEventListener(ne.Enums.Events.CAMERA_MODIFIED,ov)}},{Active:sv,Passive:rv,Enabled:lv}=ie,dv=function(e){Nm(e,[sv,rv,lv]).forEach((t=>{t.onImageSpacingCalibrated&&t.onImageSpacingCalibrated(e)}))},cv={enable:function(e){e.addEventListener(ne.Enums.Events.IMAGE_SPACING_CALIBRATED,dv)},disable:function(e){e.removeEventListener(ne.Enums.Events.IMAGE_SPACING_CALIBRATED,dv)}},{Active:hv}=ie;function gv(e){const{renderingEngineId:t,viewportId:n}=e.detail,i=e.detail.event,o=Mv(n,t);if(!o)return null;const a=Object.keys(o.toolOptions),s=Object.keys(i.touches).length,r=xm(i)||Un.getModifierKey(),l=o.getDefaultMousePrimary();for(let e=0;e<a.length;e++){const t=a[e],n=o.toolOptions[t],i=n.bindings.length&&n.bindings.some((e=>(e.numTouchPoints===s||1===s&&e.mouseButton===l)&&e.modifierKey===r));if(n.mode===hv&&i)return o.getToolInstance(t)}}function uv(e,t,n){const{renderingEngineId:i,viewportId:o}=e.detail,a=Mv(o,i);if(!a)return[];const s=[],r=Object.keys(a.toolOptions);for(let e=0;e<r.length;e++){const i=r[e],o=a.toolOptions[i],l=null!=n&&o.bindings.length&&o.bindings.some((e=>e.numTouchPoints===n));if(t.includes(o.mode)&&(!n||l)){const e=a.getToolInstance(i);s.push(e)}}return s}const{Active:mv,Passive:vv}=ie;function pv(e){if(Je.isInteractingWithTool)return;const t=gv(e);if(t&&"function"==typeof t.preTouchStartCallback){if(t.preTouchStartCallback(e))return}const n=1===Object.keys(e.detail.event.touches).length,i=[...uv(e,[mv],Object.keys(e.detail.event.touches).length)||[],...(n?uv(e,[vv]):void 0)||[],t],o=e.detail,{element:a}=o,s=ym(a,i),r=o.currentPoints.canvas,l=Mm(a,s,r,"touch");if(l.length>0){const{tool:t,annotation:n,handle:i}=fv(l);return Ev(n.annotationUID,false),void t.handleSelectedCallback(e,n,i,"Touch")}const d=Om(a,s,r,"touch");if(d.length>0){const{tool:t,annotation:n}=fv(d);return Ev(n.annotationUID,false),void t.toolSelectedCallback(e,n,"Touch")}if(t&&"function"==typeof t.postTouchStartCallback){if(t.postTouchStartCallback(e))return}}function fv(e){return e.length>1&&e.find((e=>!we(e.annotation)&&He(e.annotation.annotationUID)))||e[0]}function Ev(e,t=!1){if(t)if(Pe(e))ye(e,!1);else{ye(e,!0,!0)}else{ye(e,!0,!1)}}function wv(e){if(Je.isInteractingWithTool)return;const t=gv(e);if(t&&!Je.isMultiPartToolActive&&t.addNewAnnotation){ye(t.addNewAnnotation(e,"touch").annotationUID)}}function Iv(e){if(Je.isInteractingWithTool)return;const t=gv(e);!t||"function"!=typeof t.touchDragCallback||t.touchDragCallback(e)}const Cv=bm.bind(null,"Touch","touchEndCallback"),_v=bm.bind(null,"Touch","touchTapCallback"),Tv=bm.bind(null,"Touch","touchPressCallback"),bv={enable:function(e){e.addEventListener(re.TOUCH_START,pv),e.addEventListener(re.TOUCH_START_ACTIVATE,wv),e.addEventListener(re.TOUCH_DRAG,Iv),e.addEventListener(re.TOUCH_END,Cv),e.addEventListener(re.TOUCH_TAP,_v),e.addEventListener(re.TOUCH_PRESS,Tv)},disable:function(e){e.removeEventListener(re.TOUCH_START,pv),e.removeEventListener(re.TOUCH_START_ACTIVATE,wv),e.removeEventListener(re.TOUCH_DRAG,Iv),e.removeEventListener(re.TOUCH_END,Cv),e.removeEventListener(re.TOUCH_PRESS,Tv)}};function Dv(e){const{element:t,viewportId:n}=e.detail,i=function(e){const t="http://www.w3.org/2000/svg",n=document.createElementNS(t,"svg"),i=`svg-layer-${e}`;n.classList.add("svg-layer"),n.setAttribute("id",i),n.setAttribute("xmlns","http://www.w3.org/2000/svg"),n.style.width="100%",n.style.height="100%",n.style.pointerEvents="none",n.style.position="absolute";const o=document.createElementNS(t,"defs"),a=document.createElementNS(t,"filter"),s=document.createElementNS(t,"feOffset"),r=document.createElementNS(t,"feColorMatrix"),l=document.createElementNS(t,"feBlend");return a.setAttribute("id",`shadow-${i}`),a.setAttribute("filterUnits","userSpaceOnUse"),s.setAttribute("result","offOut"),s.setAttribute("in","SourceGraphic"),s.setAttribute("dx","0.5"),s.setAttribute("dy","0.5"),r.setAttribute("result","matrixOut"),r.setAttribute("in","offOut"),r.setAttribute("in2","matrix"),r.setAttribute("values","0.2 0 0 0 0 0 0.2 0 0 0 0 0 0.2 0 0 0 0 0 1 0"),l.setAttribute("in","SourceGraphic"),l.setAttribute("in2","matrixOut"),l.setAttribute("mode","normal"),a.appendChild(s),a.appendChild(r),a.appendChild(l),o.appendChild(a),n.appendChild(o),n}(n);var o;!function(e){const{viewportUid:t,renderingEngineUid:n}=e.dataset,i=`${t}:${n}`;Je.svgNodeCache[i]={}}(t),o=i,t.querySelector("div.viewport-element").appendChild(o),sa.addViewportElement(n,t),xt.enable(t),yn.enable(t),_n.enable(t),Un.enable(t),Ha.enable(t),_m.enable(t),av.enable(t),cv.enable(t),Ym.enable(t),ev.enable(t),bv.enable(t),Je.enabledElements.push(t)}const Sv=function(e,t){const n=[];if(!t&&!e)throw new Error("At least one of renderingEngineId or viewportId should be given");for(let i=0;i<Je.synchronizers.length;i++){const o=Je.synchronizers[i],a=!o.isDisabled(),s=o.hasSourceViewport(t,e),r=o.hasTargetViewport(t,e);a&&(s||r)&&n.push(o)}return n};const Mv=function(e,t){const n=Je.toolGroups.filter((n=>n.viewportsInfo.some((n=>n.renderingEngineId===t&&(!n.viewportId||n.viewportId===e)))));if(n.length){if(n.length>1)throw new Error(`Multiple tool groups found for renderingEngineId: ${t} and viewportId: ${e}. You should only\n      have one tool group per viewport in a renderingEngine.`);return n[0]}},yv="viewport-element";const Ov=e=>{const t=(0,ne.getEnabledElement)(e);Sv(t.viewportId,t.renderingEngineId).forEach((e=>{e.remove(t)}))},xv=e=>{const{renderingEngineId:t,viewportId:n}=(0,ne.getEnabledElement)(e),i=Mv(n,t);i&&i.removeViewports(t,n)};const Rv=function(e){const t=Je.enabledElements.findIndex((t=>t===e));t>-1&&Je.enabledElements.splice(t,1)},Pv=function(e){const{element:t,viewportId:n}=e.detail;!function(e){const{viewportUid:t,renderingEngineUid:n}=e.dataset,i=`${t}:${n}`;delete Je.svgNodeCache[i]}(t),function(e){const t=e.querySelector(`div.${yv}`),n=t.querySelector("svg");n&&t.removeChild(n)}(t),sa.removeViewportElement(n,t),xt.disable(t),yn.disable(t),_n.disable(t),Un.disable(t),Ha.disable(t),_m.disable(t),av.disable(t),cv.disable(t),Ym.disable(t),ev.disable(t),bv.disable(t),Ov(t),xv(t),Rv(t)};function Nv(e){const t=ym(e,na(e,[ie.Active,ie.Passive]));for(const{tool:n}of t){const t=n.cancel(e);if(t)return t}}function Lv(e,t){return e.findIndex((e=>t.renderingEngineId===e.renderingEngineId&&t.viewportId===e.viewportId))}function Av(e,t){return e.some((e=>e.renderingEngineId===t.renderingEngineId&&e.viewportId===t.viewportId))}const kv=class{constructor(e,t,n,i){this._viewportOptions={},this._onEvent=e=>{if(!0===this._ignoreFiredEvents)return;if(!this._targetViewports.length)return;const t=(0,ne.getEnabledElement)(e.currentTarget);if(!t)return;const{renderingEngineId:n,viewportId:i}=t;this._sourceViewports.find((e=>e.viewportId===i))&&this.fireEvent({renderingEngineId:n,viewportId:i},e)},this._enabled=!0,this._eventName=t,this._eventHandler=n,this._ignoreFiredEvents=!1,this._sourceViewports=[],this._targetViewports=[],this._options=i||{},this._auxiliaryEventNames=this._options.auxiliaryEventNames||[],this.id=e}isDisabled(){return!this._enabled||!this._hasSourceElements()}setOptions(e,t={}){this._viewportOptions[e]=t}getOptions(e){return this._viewportOptions[e]}add(e){this.addTarget(e),this.addSource(e)}addSource(e){if(Av(this._sourceViewports,e))return;const{renderingEngineId:t,viewportId:n}=e,i=(0,ne.getRenderingEngine)(t).getViewport(n);if(!i)return void console.warn(`Synchronizer.addSource: No viewport for ${t} ${n}`);const o=i.element;o.addEventListener(this._eventName,this._onEvent.bind(this)),this._auxiliaryEventNames.length&&this._auxiliaryEventNames.forEach((e=>{o.addEventListener(e,this._onEvent.bind(this))})),this._updateDisableHandlers(),this._sourceViewports.push(e)}addTarget(e){Av(this._targetViewports,e)||(this._targetViewports.push(e),this._updateDisableHandlers())}getSourceViewports(){return this._sourceViewports}getTargetViewports(){return this._targetViewports}destroy(){this._sourceViewports.forEach((e=>this.removeSource(e))),this._targetViewports.forEach((e=>this.removeTarget(e)))}remove(e){this.removeTarget(e),this.removeSource(e)}removeSource(e){const t=Lv(this._sourceViewports,e);if(-1===t)return;const n=function(e){const t=(0,ne.getRenderingEngine)(e.renderingEngineId);if(!t)throw new Error(`No RenderingEngine for Id: ${e.renderingEngineId}`);return t.getViewport(e.viewportId).element}(e);this._sourceViewports.splice(t,1),n.removeEventListener(this._eventName,this._eventHandler),this._auxiliaryEventNames&&this._auxiliaryEventNames.forEach((e=>{n.removeEventListener(e,this._eventHandler)})),this._updateDisableHandlers()}removeTarget(e){const t=Lv(this._targetViewports,e);-1!==t&&(this._targetViewports.splice(t,1),this._updateDisableHandlers())}hasSourceViewport(e,t){return Av(this._sourceViewports,{renderingEngineId:e,viewportId:t})}hasTargetViewport(e,t){return Av(this._targetViewports,{renderingEngineId:e,viewportId:t})}fireEvent(e,t){if(this.isDisabled()||this._ignoreFiredEvents)return;this._ignoreFiredEvents=!0;const n=[];try{for(let i=0;i<this._targetViewports.length;i++){const o=this._targetViewports[i];if(e.viewportId===o.viewportId)continue;const a=this._eventHandler(this,e,o,t,this._options);a instanceof Promise&&n.push(a)}}catch(e){console.warn(`Synchronizer, for: ${this._eventName}`,e)}finally{n.length?Promise.allSettled(n).then((()=>{this._ignoreFiredEvents=!1})):this._ignoreFiredEvents=!1}}_hasSourceElements(){return 0!==this._sourceViewports.length}_updateDisableHandlers(){const e=function(e,t){const n=[],i=e.concat(t);for(let e=0;e<i.length;e++){const t=i[e];n.some((e=>t.renderingEngineId===e.renderingEngineId&&t.viewportId===e.viewportId))||n.push(t)}return n}(this._sourceViewports,this._targetViewports),t=this.remove,n=e=>{t(e.detail.element)};e.forEach((function(e){const t=(0,ne.getRenderingEngine)(e.renderingEngineId).getViewport(e.viewportId);if(!t)return;const{element:i}=t;i.removeEventListener(ne.Enums.Events.ELEMENT_DISABLED,n),i.addEventListener(ne.Enums.Events.ELEMENT_DISABLED,n)}))}};const Uv=function(e,t,n,i){if(Je.synchronizers.some((t=>t.id===e)))throw new Error(`Synchronizer with id '${e}' already exists.`);const o=new kv(e,t,n,i);return Je.synchronizers.push(o),o};const Vv=function(){for(;Je.synchronizers.length>0;){Je.synchronizers.pop().destroy()}};const Wv=function(e){return Je.synchronizers.find((t=>t.id===e))};const Hv=function(){return Je.synchronizers};const Bv=function(e){const t=Je.synchronizers.findIndex((t=>t.id===e));if(t>-1){Je.synchronizers[t].destroy(),Je.synchronizers.splice(t,1)}};var Fv=n(20346),Gv=n.n(Fv);const{Active:$v,Passive:Kv,Enabled:qv,Disabled:zv}=ie;class jv{constructor(e){this.viewportsInfo=[],this.toolOptions={},this.restoreToolOptions={},this._toolInstances={},this.id=e}getViewportIds(){return this.viewportsInfo.map((({viewportId:e})=>e))}getViewportsInfo(){return this.viewportsInfo.slice()}getToolInstance(e){const t=this._toolInstances[e];if(t)return t;console.warn(`'${e}' is not registered with this toolGroup (${this.id}).`)}addTool(e,t={}){const n=Je.tools[e],i=void 0!==e&&""!==e,o=this.toolOptions[e];if(!i)return void console.warn("Tool with configuration did not produce a toolName: ",t);if(!n)return void console.warn(`'${e}' is not registered with the library. You need to use cornerstoneTools.addTool to register it.`);if(o)return void console.warn(`'${e}' is already registered for ToolGroup ${this.id}.`);const{toolClass:a}=n,s=new a({name:e,toolGroupId:this.id,configuration:t});this._toolInstances[e]=s}addToolInstance(e,t,n={}){let i=Je.tools[e]?.toolClass;if(!i){const n=Je.tools[t].toolClass;class o extends n{}o.toolName=e,i=o,Je.tools[e]={toolClass:o}}this.addTool(i.toolName,n)}addViewport(e,t){const n=(0,ne.getRenderingEngines)();if(!t&&n.length>1)throw new Error("You must specify a renderingEngineId when there are multiple rendering engines.");const i=t||n[0].id;this.viewportsInfo.some((({viewportId:t})=>t===e))||this.viewportsInfo.push({viewportId:e,renderingEngineId:i});const o=this.getActivePrimaryMouseButtonTool();ne.Settings.getRuntimeSettings().get("useCursors")&&this.setViewportsCursorByToolName(o)}removeViewports(e,t){const n=[];if(this.viewportsInfo.forEach(((i,o)=>{let a=!1;i.renderingEngineId===e&&(a=!0,t&&i.viewportId!==t&&(a=!1)),a&&n.push(o)})),n.length)for(let e=n.length-1;e>=0;e--)this.viewportsInfo.splice(n[e],1)}setActiveStrategy(e,t){const n=this._toolInstances[e];void 0!==n?n.setActiveStrategy(t):console.warn(`Tool ${e} not added to toolGroup, can't set tool configuration.`)}setToolMode(e,t,n={}){e?t!==ie.Active?t!==ie.Passive?t!==ie.Enabled?t!==ie.Disabled?console.warn("setToolMode: mode must be defined"):this.setToolDisabled(e):this.setToolEnabled(e):this.setToolPassive(e):this.setToolActive(e,n||this.restoreToolOptions[e]):console.warn("setToolMode: toolName must be defined")}setToolActive(e,t={}){const n=this._toolInstances[e];if(void 0===n)return void console.warn(`Tool ${e} not added to toolGroup, can't set tool mode.`);if(!n)return void console.warn(`'${e}' instance ${n} is not registered with this toolGroup, can't set tool mode.`);const i={bindings:[...this.toolOptions[e]?this.toolOptions[e].bindings:[],...t.bindings?t.bindings:[]].reduce(((e,t)=>{const n=void 0!==t.numTouchPoints,i=void 0!==t.mouseButton;return e.some((e=>function(e,t){if(e.mouseButton!==t.mouseButton)return!1;return e.modifierKey===t.modifierKey}(e,t)))||!n&&!i||e.push(t),e}),[]),mode:$v};this.toolOptions[e]=i,this._toolInstances[e].mode=$v;const o=ne.Settings.getRuntimeSettings().get("useCursors");if(this._hasMousePrimaryButtonBinding(t)&&o)this.setViewportsCursorByToolName(e);else{if(!this.getActivePrimaryMouseButtonTool()&&o){const e=or.getDefinedCursor("default");this._setCursorForViewports(e)}}"function"==typeof n.onSetToolActive&&n.onSetToolActive(),this._renderViewports();const a={toolGroupId:this.id,toolName:e,toolBindingsOptions:t};(0,ne.triggerEvent)(ne.eventTarget,re.TOOL_ACTIVATED,a),this._triggerToolModeChangedEvent(e,$v,t)}setToolPassive(e){const t=this._toolInstances[e];if(void 0===t)return void console.warn(`Tool ${e} not added to toolGroup, can't set tool mode.`);const n=this.getToolOptions(e),i=Object.assign({bindings:n?n.bindings:[]},n,{mode:Kv}),o=this.getDefaultMousePrimary();i.bindings=i.bindings.filter((e=>e.mouseButton!==o||e.modifierKey));let a=Kv;0!==i.bindings.length&&(a=$v,i.mode=a),this.toolOptions[e]=i,t.mode=a,"function"==typeof t.onSetToolPassive&&t.onSetToolPassive(),this._renderViewports(),this._triggerToolModeChangedEvent(e,Kv)}setToolEnabled(e){const t=this._toolInstances[e];if(void 0===t)return void console.warn(`Tool ${e} not added to toolGroup, can't set tool mode.`);const n={bindings:[],mode:qv};this.toolOptions[e]=n,t.mode=qv,"function"==typeof t.onSetToolEnabled&&t.onSetToolEnabled(),this._renderViewports(),this._triggerToolModeChangedEvent(e,qv)}setToolDisabled(e){const t=this._toolInstances[e];if(void 0===t)return void console.warn(`Tool ${e} not added to toolGroup, can't set tool mode.`);const n={bindings:[],mode:zv};this.restoreToolOptions[e]=this.toolOptions[e],this.toolOptions[e]=n,t.mode=zv,"function"==typeof t.onSetToolDisabled&&t.onSetToolDisabled(),this._renderViewports(),this._triggerToolModeChangedEvent(e,zv)}getToolOptions(e){const t=this.toolOptions[e];if(void 0!==t)return t}getActivePrimaryMouseButtonTool(){return Object.keys(this.toolOptions).find((e=>{const t=this.toolOptions[e];return t.mode===$v&&this._hasMousePrimaryButtonBinding(t)}))}setViewportsCursorByToolName(e,t){const n=this._getCursor(e,t);this._setCursorForViewports(n)}_getCursor(e,t){let n,i;return t&&(n=`${e}.${t}`,i=Cr.getDefinedCursor(n,!0),i)?i:(n=`${e}`,i=Cr.getDefinedCursor(n,!0),i||(n=e,i=Cr.getDefinedCursor(n,!0),i||or.getDefinedCursor("default")))}_setCursorForViewports(e){this.viewportsInfo.forEach((({renderingEngineId:t,viewportId:n})=>{const i=(0,ne.getEnabledElementByIds)(n,t);if(!i)return;const{viewport:o}=i;yr(o.element,e)}))}setToolConfiguration(e,t,n){if(void 0===this._toolInstances[e])return console.warn(`Tool ${e} not present, can't set tool configuration.`),!1;let i;return i=n?t:Object.assign(this._toolInstances[e].configuration,t),this._toolInstances[e].configuration=i,this._renderViewports(),!0}getDefaultMousePrimary(){return Q.Primary}getToolConfiguration(e,t){if(void 0===this._toolInstances[e])return void console.warn(`Tool ${e} not present, can't set tool configuration.`);const n=Gv()(this._toolInstances[e].configuration,t)||this._toolInstances[e].configuration;return me()(n)}clone(e,t=null){let n=Jv(e);return n?(console.warn(`ToolGroup ${e} already exists`),n):(n=Yv(e),t=t??(()=>!0),Object.keys(this._toolInstances).filter(t).forEach((e=>{const t=this._toolInstances[e],i=this.toolOptions[e],o=t.mode;n.addTool(e),n.setToolMode(e,o,{bindings:i.bindings??[]})})),n)}_hasMousePrimaryButtonBinding(e){const t=this.getDefaultMousePrimary();return e?.bindings?.some((e=>e.mouseButton===t&&void 0===e.modifierKey))}_renderViewports(){this.viewportsInfo.forEach((({renderingEngineId:e,viewportId:t})=>{(0,ne.getRenderingEngine)(e).renderViewport(t)}))}_triggerToolModeChangedEvent(e,t,n){const i={toolGroupId:this.id,toolName:e,mode:t,toolBindingsOptions:n};(0,ne.triggerEvent)(ne.eventTarget,re.TOOL_MODE_CHANGED,i)}}const Yv=function(e){if(Je.toolGroups.some((t=>t.id===e)))return void console.warn(`'${e}' already exists.`);const t=new jv(e);return Je.toolGroups.push(t),t};const Zv=function(e){const t=Je.toolGroups.findIndex((t=>t.id===e));t>-1&&(Ra.removeToolGroup(e),ji(e),Je.toolGroups.splice(t,1))};const Xv=function(){const e=[...Je.toolGroups];for(const t of e)Zv(t.id);Je.toolGroups=[]};const Jv=function(e){return Je.toolGroups.find((t=>t.id===e))};const Qv=function(){return Je.toolGroups},ep=[ie.Active,ie.Passive,ie.Enabled];const tp=function(e){return Je.toolGroups.filter((({toolOptions:t})=>{const n=Object.keys(t);for(let i=0;i<n.length;i++)if(e===n[i]&&t[e]&&ep.includes(t[e].mode))return!0;return!1}))};let np=je;function ip(){return np}function op(e){np=e}function ap(){np=je}function sp(e,t){const n=ip(),i=n.getGroupKey(t);return n.getAnnotations(i,e)}function rp(e,t){e.annotationUID||(e.annotationUID=ne.utilities.uuidv4());const n=ip(),i=n.getGroupKey(t);return n.addAnnotation(e,i),t instanceof HTMLDivElement?function(e,t){const n=(0,ne.getEnabledElement)(t),{renderingEngine:i,viewportId:o}=n,a=re.ANNOTATION_ADDED,s={annotation:e,viewportId:o,renderingEngineId:i.id};(0,ne.triggerEvent)(ne.eventTarget,a,s)}(e,t):function(e){const{toolName:t}=e.metadata,n=tp(t);if(!n.length)return;const i=[];if(n.forEach((t=>{t.viewportsInfo.forEach((t=>{const{renderingEngineId:n,viewportId:o}=t,{FrameOfReferenceUID:a}=(0,ne.getEnabledElementByIds)(o,n);e.metadata.FrameOfReferenceUID===a&&i.push(t)}))})),!i.length)return;const o=re.ANNOTATION_ADDED;i.forEach((({renderingEngineId:t,viewportId:n})=>{const i={annotation:e,viewportId:n,renderingEngineId:t};(0,ne.triggerEvent)(ne.eventTarget,o,i)}))}(e),e.annotationUID}function lp(e,t){const n=ip(),i=n.getGroupKey(t);return n.getNumberOfAnnotations(i,e)}function dp(e){const t=ip(),n=t.getAnnotation(e);if(!n)return;t.removeAnnotation(e);const i=re.ANNOTATION_REMOVED,o={annotation:n,annotationManagerUID:t.uid};(0,ne.triggerEvent)(ne.eventTarget,i,o)}function cp(e){return ip().getAnnotation(e)}function hp(){ip().removeAllAnnotations()}let gp=!1;function up(e={}){gp||(!function(){vp();const e=ne.Enums.Events.ELEMENT_ENABLED,t=ne.Enums.Events.ELEMENT_DISABLED;ne.eventTarget.addEventListener(e,Dv),ne.eventTarget.addEventListener(t,Pv)}(),pp(),ne.eventTarget.addEventListener(re.ANNOTATION_MODIFIED,Im),ne.eventTarget.addEventListener(re.ANNOTATION_SELECTION_CHANGE,wm),ne.eventTarget.addEventListener(re.ANNOTATION_SELECTION_CHANGE,wm),ne.eventTarget.addEventListener(re.SEGMENTATION_MODIFIED,Ua),ne.eventTarget.addEventListener(re.SEGMENTATION_DATA_MODIFIED,Aa),ne.eventTarget.addEventListener(re.SEGMENTATION_REPRESENTATION_MODIFIED,La),ne.eventTarget.addEventListener(re.SEGMENTATION_REPRESENTATION_REMOVED,ka),gp=!0)}function mp(){vp(),pp(),Xv(),Qe();const e=ip(),t=ei();e.restoreAnnotations({}),t.resetState(),gp=!1}function vp(){const e=ne.Enums.Events.ELEMENT_ENABLED,t=ne.Enums.Events.ELEMENT_DISABLED;ne.eventTarget.removeEventListener(e,Dv),ne.eventTarget.removeEventListener(t,Pv)}function pp(){ne.eventTarget.removeEventListener(re.ANNOTATION_MODIFIED,Im),ne.eventTarget.removeEventListener(re.ANNOTATION_SELECTION_CHANGE,wm),ne.eventTarget.removeEventListener(re.ANNOTATION_SELECTION_CHANGE,wm),ne.eventTarget.removeEventListener(re.SEGMENTATION_MODIFIED,Ua),ne.eventTarget.removeEventListener(re.SEGMENTATION_DATA_MODIFIED,Aa),ne.eventTarget.removeEventListener(re.SEGMENTATION_REPRESENTATION_MODIFIED,La),ne.eventTarget.removeEventListener(re.SEGMENTATION_REPRESENTATION_REMOVED,ka)}function fp(e,t,n,i){const{camera:o}=i.detail,a=(0,ne.getRenderingEngine)(n.renderingEngineId);if(!a)throw new Error(`No RenderingEngine for Id: ${n.renderingEngineId}`);const s=a.getViewport(n.viewportId);s.setCamera(o),s.render()}const{CAMERA_MODIFIED:Ep}=ne.Enums.Events;function wp(e){return Uv(e,Ep,fp)}function Ip(e,t,n,i,o){const a=i.detail,{volumeId:s,range:r,invertStateChanged:l,invert:d}=a,c=(0,ne.getRenderingEngine)(n.renderingEngineId);if(!c)throw new Error(`Rendering Engine does not exist: ${n.renderingEngineId}`);const h=c.getViewport(n.viewportId),g={voiRange:r};if(o?.syncInvertState&&l&&(g.invert=d),h instanceof ne.BaseVolumeViewport)h.setProperties(g,s);else{if(!(h instanceof ne.StackViewport))throw new Error("Viewport type not supported.");h.setProperties(g)}h.render()}function Cp(e,t={syncInvertState:!0}){return Uv(e,ne.Enums.Events.VOI_MODIFIED,Ip,t)}function _p(e,t,n){const i=(0,ne.getRenderingEngine)(n.renderingEngineId);if(!i)throw new Error(`No RenderingEngine for Id: ${n.renderingEngineId}`);const o=e.getOptions(n.viewportId),a=i.getViewport(n.viewportId),s=i.getViewport(t.viewportId);if(!1!==o?.syncZoom){const e=s.getZoom();a.setZoom(e)}if(!1!==o?.syncPan){const e=s.getPan();a.setPan(e)}a.render()}const{CAMERA_MODIFIED:Tp}=ne.Enums.Events;function bp(e){return Uv(e,Tp,_p)}const Dp=(e,t)=>ne.utilities.spatialRegistrationMetadataProvider.get("spatialRegistrationModule",e,t);async function Sp(e,t,n){const i=(0,ne.getRenderingEngine)(n.renderingEngineId);if(!i)throw new Error(`No RenderingEngine for Id: ${n.renderingEngineId}`);const o=i.getViewport(t.viewportId),a=e.getOptions(n.viewportId);if(a?.disabled)return;const s=i.getViewport(n.viewportId),r=o.getCurrentImageId(),l=ne.metaData.get("imagePlaneModule",r).imagePositionPatient,d=s.getImageIds();if(!function(e,t){const{viewPlaneNormal:n}=e.getCamera(),{viewPlaneNormal:i}=t.getCamera(),o=Oo.R3.dot(n,i);return Math.abs(o)>.9}(o,s))return;let c=Dp(n.viewportId,t.viewportId);if(!c){if(o.getFrameOfReferenceUID()===s.getFrameOfReferenceUID()&&!1!==a?.useInitialPosition?c=Oo._E.identity(Oo._E.create()):(ne.utilities.calculateViewportsSpatialRegistration(o,s),c=Dp(n.viewportId,t.viewportId)),!c)return}const h=Oo.R3.transformMat4(Oo.R3.create(),l,c),g=(u=h,d.reduce(((e,t,n)=>{const{imagePositionPatient:i}=ne.metaData.get("imagePlaneModule",t),o=Oo.R3.distance(i,u);return o<e.distance?{distance:o,index:n}:e}),{distance:1/0,index:-1}));var u;let m=g.index;s instanceof ne.VolumeViewport&&(m=d.length-g.index-1),-1!==g.index&&s.getCurrentImageIdIndex()!==g.index&&await gs(s.element,{imageIndex:m})}const{STACK_NEW_IMAGE:Mp,VOLUME_NEW_IMAGE:yp}=ne.Enums.Events;function Op(e){return Uv(e,Mp,Sp,{auxiliaryEventNames:[yp]})}const xp=Op;class Rp extends Ca{constructor(e={}){super(e,{supportedInteractionTypes:["Mouse","Touch"],configuration:{shadow:!0,preventHandleOutsideImage:!1}}),this.addNewAnnotation=e=>{const t=e.detail,{currentPoints:n,element:i}=t,o=n.world,a=(0,ne.getEnabledElement)(i),{viewport:s,renderingEngine:r}=a;this.isDrawing=!0;const l=s.getCamera(),{viewPlaneNormal:d,viewUp:c}=l,h=this.getReferencedImageId(s,o,d,c),g={metadata:{viewPlaneNormal:[0,0,1],viewUp:[0,1,0],FrameOfReferenceUID:s.getFrameOfReferenceUID(),referencedImageId:h,toolName:this.getToolName()},data:{invalidated:!0,handles:{points:[[...o],[...o],[...o],[...o]],activeHandleIndex:null},cachedStats:{},active:!0}};rp(g,i);const u=Cl(i,this.getToolName(),!1);return this.editData={annotation:g,viewportUIDsToRender:u,handleIndex:3,newAnnotation:!0,hasMoved:!1},this._activateDraw(i),Rr(i),e.preventDefault(),cs(r,u),g},this.getHandleNearImagePoint=(e,t,n,i)=>{const o=(0,ne.getEnabledElement)(e),{viewport:a}=o,{data:s}=t,{points:r}=s.handles;for(let e=0;e<r.length;e++){const t=r[e],o=a.worldToCanvas(t);if(!0===Oo.K4.distance(n,o)<i)return s.handles.activeHandleIndex=e,t}s.handles.activeHandleIndex=null},this.isPointNearTool=(e,t,n,i)=>{const o=(0,ne.getEnabledElement)(e),{viewport:a}=o,{data:s}=t,{points:r}=s.handles,l=a.worldToCanvas(r[0]),d=a.worldToCanvas(r[3]),c=this._getRectangleImageCoordinates([l,d]),h=[n[0],n[1]],{left:g,top:u,width:m,height:v}=c;if(Yl([g,u,m,v],h)<=i)return!0},this.toolSelectedCallback=(e,t,n="mouse")=>{const i=e.detail,{element:o}=i,{data:a}=t;a.active=!0;const s=Cl(o,this.getToolName(),!1);this.editData={annotation:t,viewportUIDsToRender:s},this._activateModify(o),Rr(o);const r=(0,ne.getEnabledElement)(o),{renderingEngine:l}=r;cs(l,s),e.preventDefault()},this.handleSelectedCallback=(e,t,n,i="mouse")=>{const o=e.detail,{element:a}=o,{data:s}=t;s.active=!0;let r,l=!1;n.worldPosition?l=!0:r=s.handles.points.findIndex((e=>e===n));const d=Cl(a,this.getToolName(),!1);this.editData={annotation:t,viewportUIDsToRender:d,handleIndex:r},this._activateModify(a),Rr(a);const c=(0,ne.getEnabledElement)(a),{renderingEngine:h}=c;cs(h,d),e.preventDefault()},this._mouseUpCallback=e=>{const t=e.detail,{element:n}=t,{annotation:i,viewportUIDsToRender:o,newAnnotation:a,hasMoved:s}=this.editData,{data:r}=i;if(a&&!s)return;r.active=!1,r.handles.activeHandleIndex=null,this._deactivateModify(n),this._deactivateDraw(n),xr(n);const l=(0,ne.getEnabledElement)(n),{renderingEngine:d}=l;this.editData=null,this.isDrawing=!1,this.isHandleOutsideImage&&this.configuration.preventHandleOutsideImage&&dp(i.annotationUID),cs(d,o)},this._mouseDragCallback=e=>{this.isDrawing=!0;const t=e.detail,{element:n}=t,{annotation:i,viewportUIDsToRender:o,handleIndex:a}=this.editData,{data:s}=i;if(void 0===a){const{deltaPoints:e}=t,n=e.world,{points:i}=s.handles;i.forEach((e=>{e[0]+=n[0],e[1]+=n[1],e[2]+=n[2]})),s.invalidated=!0}else{const{currentPoints:e}=t,i=(0,ne.getEnabledElement)(n),{worldToCanvas:o,canvasToWorld:r}=i.viewport,l=e.world,{points:d}=s.handles;let c,h,g,u,m,v,p,f;switch(d[a]=[...l],a){case 0:case 3:c=o(d[0]),u=o(d[3]),h=[u[0],c[1]],g=[c[0],u[1]],v=r(h),p=r(g),d[1]=v,d[2]=p;break;case 1:case 2:h=o(d[1]),g=o(d[2]),c=[g[0],h[1]],u=[h[0],g[1]],m=r(c),f=r(u),d[0]=m,d[3]=f}s.invalidated=!0}this.editData.hasMoved=!0;const r=(0,ne.getEnabledElement)(n),{renderingEngine:l}=r;cs(l,o)},this._activateDraw=e=>{Je.isInteractingWithTool=!0,e.addEventListener(re.MOUSE_UP,this._mouseUpCallback),e.addEventListener(re.MOUSE_DRAG,this._mouseDragCallback),e.addEventListener(re.MOUSE_MOVE,this._mouseDragCallback),e.addEventListener(re.MOUSE_CLICK,this._mouseUpCallback),e.addEventListener(re.TOUCH_END,this._mouseUpCallback),e.addEventListener(re.TOUCH_DRAG,this._mouseDragCallback)},this._deactivateDraw=e=>{Je.isInteractingWithTool=!1,e.removeEventListener(re.MOUSE_UP,this._mouseUpCallback),e.removeEventListener(re.MOUSE_DRAG,this._mouseDragCallback),e.removeEventListener(re.MOUSE_MOVE,this._mouseDragCallback),e.removeEventListener(re.MOUSE_CLICK,this._mouseUpCallback),e.removeEventListener(re.TOUCH_END,this._mouseUpCallback),e.removeEventListener(re.TOUCH_DRAG,this._mouseDragCallback)},this._activateModify=e=>{Je.isInteractingWithTool=!0,e.addEventListener(re.MOUSE_UP,this._mouseUpCallback),e.addEventListener(re.MOUSE_DRAG,this._mouseDragCallback),e.addEventListener(re.MOUSE_CLICK,this._mouseUpCallback),e.addEventListener(re.TOUCH_END,this._mouseUpCallback),e.addEventListener(re.TOUCH_DRAG,this._mouseDragCallback)},this._deactivateModify=e=>{Je.isInteractingWithTool=!1,e.removeEventListener(re.MOUSE_UP,this._mouseUpCallback),e.removeEventListener(re.MOUSE_DRAG,this._mouseDragCallback),e.removeEventListener(re.MOUSE_CLICK,this._mouseUpCallback),e.removeEventListener(re.TOUCH_END,this._mouseUpCallback),e.removeEventListener(re.TOUCH_DRAG,this._mouseDragCallback)},this.renderAnnotation=(e,t)=>{const{viewport:n}=e,{element:i}=n;let o=sp(this.getToolName(),i);if(!o?.length)return false;if(o=this.filterInteractableAnnotationsForElement(i,o),!o?.length)return false;this.getTargetId(n),n.getRenderingEngine();const a={toolGroupId:this.toolGroupId,toolName:this.getToolName(),viewportId:e.viewport.id};for(let e=0;e<o.length;e++){const i=o[e],{annotationUID:s}=i,r=(i.metadata,i.data),{points:l,activeHandleIndex:d}=r.handles,c=l.map((e=>n.worldToCanvas(e))),h=this.getStyle("lineWidth",a,i),g=this.getStyle("lineDash",a,i),u=this.getStyle("color",a,i);if(!n.getRenderingEngine())return void console.warn("Rendering Engine has been destroyed");let m;if(this.editData||null===d||(m=[c[d]]),m){$o(t,s,"0",m,{color:u})}ta(t,s,"0",c[0],c[3],{color:"black",lineDash:g,lineWidth:h})}},this._getRectangleImageCoordinates=e=>{const[t,n]=e;return{left:Math.min(t[0],n[0]),top:Math.min(t[1],n[1]),width:Math.abs(t[0]-n[0]),height:Math.abs(t[1]-n[1])}},this._calculateCachedStats=(e,t,n,i,o)=>{const{data:a}=e,{viewportUID:s,renderingEngineUID:r,sceneUID:l}=o,d=a.handles.points[0],c=a.handles.points[3],{cachedStats:h}=a,g=Object.keys(h);for(let e=0;e<g.length;e++){const o=g[e],{imageVolume:a}=this._getImageVolumeFromTargetUID(o,i),{dimensions:s,scalarData:r,vtkImageData:l,metadata:u}=a,m=Oo.R3.fromValues(0,0,0),v=Oo.R3.fromValues(0,0,0);if(l.worldToIndexVec3(d,m),m[0]=Math.floor(m[0]),m[1]=Math.floor(m[1]),m[2]=Math.floor(m[2]),l.worldToIndexVec3(c,v),v[0]=Math.floor(v[0]),v[1]=Math.floor(v[1]),v[2]=Math.floor(v[2]),this._isInsideVolume(m,v,s)){this.isHandleOutsideImage=!1;const e=Math.min(m[0],v[0]),i=Math.max(m[0],v[0]),a=Math.min(m[1],v[1]),l=Math.max(m[1],v[1]),g=Math.min(m[2],v[2]),p=Math.max(m[2],v[2]),{worldWidth:f,worldHeight:E}=sc(t,n,d,c),w=f*E;let I=0,C=0,_=0;const T=s[0],b=s[0]*s[1];for(let t=g;t<=p;t++)for(let n=a;n<=l;n++)for(let o=e;o<=i;o++){I++,C+=r[t*b+n*T+o]}C/=I;for(let t=g;t<=p;t++)for(let n=a;n<=l;n++)for(let o=e;o<=i;o++){const e=r[t*b+n*T+o]-C;_+=e*e}_/=I,_=Math.sqrt(_),h[o]={Modality:u.Modality,area:w,mean:C,stdDev:_}}else this.isHandleOutsideImage=!0,h[o]={Modality:u.Modality}}a.invalidated=!1;const u=re.ANNOTATION_MODIFIED,m={annotation:e,viewportUID:s,renderingEngineUID:r,sceneUID:l};return(0,ne.triggerEvent)(ne.eventTarget,u,m),h},this._isInsideVolume=(e,t,n)=>ne.utilities.indexWithinDimensions(e,n)&&ne.utilities.indexWithinDimensions(t,n),this._getTargetVolumeUID=e=>{if(this.configuration.volumeUID)return this.configuration.volumeUID;const t=e.getVolumeActors();return t||t.length?t[0].uid:void 0},this._throttledCalculateCachedStats=qa(this._calculateCachedStats,100,{trailing:!0})}cancel(e){if(!this.isDrawing)return;this.isDrawing=!1,this._deactivateDraw(e),this._deactivateModify(e),xr(e);const{annotation:t,viewportUIDsToRender:n}=this.editData,{data:i}=t;i.active=!1,i.handles.activeHandleIndex=null;const o=(0,ne.getEnabledElement)(e),{renderingEngine:a}=o;return cs(a,n),this.editData=null,t.metadata.annotationUID}_getImageVolumeFromTargetUID(e,t){let n;if(e.startsWith("stackTarget")){const i=e.indexOf(":"),o=e.substring(i+1);n=t.getViewport(o).getImageData()}else n=ne.cache.getVolume(e);return{imageVolume:n,viewport:undefined}}_getTargetStackUID(e){return`stackTarget:${e.uid}`}}Rp.toolName="VideoRedaction";const Pp=Rp}}]);
//# sourceMappingURL=135.bundle.316ca293555e7d1fc71f.js.map