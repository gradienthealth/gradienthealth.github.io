(self.webpackChunk=self.webpackChunk||[]).push([[172],{49531:(e,t,a)=>{"use strict";a.r(t),a.d(t,{default:()=>_e});var n=a(43001),s=a(3827),r=a.n(s),i=a(71771),o=a(11731);const{formatDate:c}=i.utils;function l(e){let{MeasurementService:t,DisplaySetService:a,UIDialogService:s,UINotificationService:r,getImageSrc:l,getStudiesForPatientByStudyInstanceUID:u,requestDisplaySetCreationForStudy:m,dataSource:h}=e;const{StudyInstanceUIDs:g}=(0,o.zG)(),[{activeViewportId:p,viewports:S,numCols:y,numRows:I},f]=(0,o.O_)(),[v,E]=(0,n.useState)("primary"),[D,b]=(0,n.useState)([...g]),[w,U]=(0,n.useState)([]),[M,R]=(0,n.useState)([]),[T,P]=(0,n.useState)({}),[N,x]=(0,n.useState)(null),C=S[p]?.displaySetInstanceUIDs,A=1===y&&1===I;(0,n.useEffect)((()=>{const e=t.EVENTS.MEASUREMENT_ADDED,a=t.EVENTS.RAW_MEASUREMENT_ADDED,n=[];return[e,a].forEach((e=>{n.push(t.subscribe(e,(e=>{let{source:t,measurement:a}=e;const{referenceSeriesUID:n,referenceStudyUID:s}=a})).unsubscribe)})),()=>{n.forEach((e=>{e()}))}}),[t,p]),(0,n.useEffect)((()=>{g.forEach((e=>async function(e){const t=(await u(e)||[]).map((e=>({AccessionNumber:e.accession,StudyDate:e.date,StudyDescription:e.description,NumInstances:e.instances,ModalitiesInStudy:e.modalities,PatientID:e.mrn,PatientName:e.patientName,StudyInstanceUID:e.studyInstanceUid,StudyTime:e.time}))).map((e=>({studyInstanceUid:e.StudyInstanceUID,date:c(e.StudyDate),description:e.StudyDescription,modalities:e.ModalitiesInStudy,numInstances:e.NumInstances})));U(t)}(e)))}),[g,u]),(0,n.useEffect)((()=>{a.activeDisplaySets.forEach((async e=>{const t={},n=a.getDisplaySetByUID(e.displaySetInstanceUID),s=h.getImageIdsForDisplaySet(n),r=s[Math.floor(s.length/2)];r&&(t[e.displaySetInstanceUID]=await l(r),P((e=>({...e,...t}))))}))}),[a,h,l]),(0,n.useEffect)((()=>{const e=d(a.activeDisplaySets,T,S,A,h,a,s,r);R(e)}),[a.activeDisplaySets,T,S,h]),(0,n.useEffect)((()=>{const e=a.subscribe(a.EVENTS.DISPLAY_SETS_ADDED,(e=>{const{displaySetsAdded:t,options:n}=e;t.forEach((async e=>{const t=e.displaySetInstanceUID,s={},r=a.getDisplaySetByUID(t);n.madeInClient&&x(t);const i=h.getImageIdsForDisplaySet(r),o=i[Math.floor(i.length/2)];o&&(s[t]=await l(o),P((e=>({...e,...s}))))}))})),t=a.subscribe(a.EVENTS.DISPLAY_SETS_CHANGED,(e=>{const t=d(e,T,S,A,h,a,s,r);R(t)}));return()=>{e.unsubscribe(),t.unsubscribe()}}),[a,h,l,T,S]);const O=function(e,t,a){const n=[],s=[],r=[];t.forEach((t=>{const o=a.filter((e=>e.StudyInstanceUID===t.studyInstanceUid)),c=(i.utils.sortBySeriesDate(o),Object.assign({},t,{displaySets:o}));e.includes(t.studyInstanceUid)?(n.push(c),r.push(c)):(s.push(c),r.push(c))}));const o=(e,t)=>{const a=Date.parse(e);return Date.parse(t)-a},c=[{name:"primary",label:"Primary",studies:n.sort(((e,t)=>o(e.date,t.date)))},{name:"recent",label:"Recent",studies:s.sort(((e,t)=>o(e.date,t.date)))},{name:"all",label:"All",studies:r.sort(((e,t)=>o(e.date,t.date)))}];return c}(g,w,M);return(0,n.useEffect)((()=>{if(N){const e=N,t=document.getElementById(`thumbnail-${e}`);t&&"function"==typeof t.scrollIntoView&&(t.scrollIntoView({behavior:"smooth"}),x(null))}}),[N,D,v]),(0,n.useEffect)((()=>{if(!N)return;const e=function(e,t){for(let a=0;a<t.length;a++){const{studies:n}=t[a];for(let s=0;s<n.length;s++){const{displaySets:r}=n[s];for(let i=0;i<r.length;i++){if(r[i].displaySetInstanceUID===e)return{tabName:t[a].name,StudyInstanceUID:n[s].studyInstanceUid}}}}}(N,O);if(!e)return void console.warn("jumpToThumbnail: displaySet thumbnail not found.");const{tabName:t,StudyInstanceUID:a}=e;E(t);if(!D.includes(a)){const e=[...D,a];b(e)}}),[D,N,O]),n.createElement(o.eX,{tabs:O,activeTabName:v,expandedStudyInstanceUIDs:D,onClickStudy:function(e){const t=D.includes(e),n=t?[...D.filter((t=>t!==e))]:[...D,e];if(b(n),!t){m(a,e,!0)}},onClickTab:e=>{E(e)},onClickThumbnail:()=>{},onDoubleClickThumbnail:e=>{f.setDisplaySetsForViewport({viewportId:p,displaySetInstanceUIDs:[e]})},activeDisplaySetInstanceUIDs:C})}l.propTypes={MeasurementService:r().shape({subscribe:r().func.isRequired,EVENTS:r().object.isRequired}).isRequired,DisplaySetService:r().shape({EVENTS:r().object.isRequired,activeDisplaySets:r().arrayOf(r().object).isRequired,getDisplaySetByUID:r().func.isRequired,subscribe:r().func.isRequired}).isRequired,dataSource:r().shape({getImageIdsForDisplaySet:r().func.isRequired}).isRequired,getImageSrc:r().func.isRequired,getStudiesForPatientByStudyInstanceUID:r().func.isRequired,requestDisplaySetCreationForStudy:r().func.isRequired};const u=l;function d(e,t,a,s,r,i,l,u){const d=[],h=[];return e.forEach((e=>{const g=t[e.displaySetInstanceUID],p=function(e){if(m.includes(e))return"thumbnailNoImage";return"thumbnailTracked"}(e.Modality),S=s?[]:a.reduce(((t,a,n)=>(a?.displaySetInstanceUIDs?.includes(e.displaySetInstanceUID)&&t.push(a.viewportLabel),t)),[]),y="thumbnailTracked"===p?d:h,{displaySetInstanceUID:I}=e,f={displaySetInstanceUID:I,description:e.SeriesDescription,seriesNumber:String(e.SeriesNumber),modality:e.Modality,seriesDate:c(e.SeriesDate),numInstances:e.numImageFrames,StudyInstanceUID:e.StudyInstanceUID,componentType:p,imageSrc:g,dragData:{type:"displayset",displaySetInstanceUID:I},viewportIdentificator:S};"thumbnailNoImage"===p&&(r.reject&&r.reject.series?(f.canReject=!0,f.onReject=()=>{l.create({id:"ds-reject-sr",centralize:!0,isDraggable:!1,showOverlay:!0,content:o.Vq,contentProps:{title:"Delete Report",body:()=>n.createElement("div",{className:"p-4 text-white bg-primary-dark"},n.createElement("p",null,"Are you sure you want to delete this report?"),n.createElement("p",null,"This action cannot be undone.")),actions:[{id:"cancel",text:"Cancel",type:"secondary"},{id:"yes",text:"Yes",type:"primary",classes:["reject-yes-button"]}],onClose:()=>l.dismiss({id:"ds-reject-sr"}),onShow:()=>{document.querySelector(".reject-yes-button").focus()},onSubmit:async t=>{let{action:a}=t;switch(a.id){case"yes":try{await r.reject.series(e.StudyInstanceUID,e.SeriesInstanceUID),i.deleteDisplaySet(I),l.dismiss({id:"ds-reject-sr"}),u.show({title:"Delete Report",message:"Report deleted successfully",type:"success"})}catch(e){l.dismiss({id:"ds-reject-sr"}),u.show({title:"Delete Report",message:"Failed to delete report",type:"error"})}break;case"cancel":l.dismiss({id:"ds-reject-sr"})}}}})}):f.canReject=!1),y.push(f)})),[...d,...h]}const m=["SR","SEG","RTSTRUCT","RTPLAN","RTDOSE"];const h=function(e,t){return new Promise(((a,n)=>{const s=document.createElement("canvas");e.utilities.loadImageToCanvas(s,t).then((e=>{a(s.toDataURL())})).catch(n)}))};const g=function(e,t,a,n){t.activeDisplaySets.some((e=>e.StudyInstanceUID===a))||e.retrieve.series.metadata({StudyInstanceUID:a,madeInClient:n})};function p(e){let{commandsManager:t,extensionManager:a,servicesManager:s}=e;const r=a.getActiveDataSource()[0],i=function(e){const t=e.getModuleEntry("@ohif/extension-default.utilityModule.common"),{getStudiesForPatientByStudyInstanceUID:a}=t.exports;return a}(a),o=i.bind(null,r),c=function(e){const t=e.getModuleEntry("@ohif/extension-cornerstone.utilityModule.common");try{const{cornerstone:e}=t.exports.getCornerstoneLibraries();return h.bind(null,e)}catch(e){throw new Error("Required command not found")}}(a),l=g.bind(null,r);return n.createElement(u,{MeasurementService:s.services.MeasurementService,DisplaySetService:s.services.DisplaySetService,UIDialogService:s.services.UIDialogService,UINotificationService:s.services.UINotificationService,dataSource:r,getImageSrc:c,getStudiesForPatientByStudyInstanceUID:o,requestDisplaySetCreationForStudy:l})}p.propTypes={commandsManager:r().object.isRequired,extensionManager:r().object.isRequired,servicesManager:r().object.isRequired};const S=p;const{downloadCSVReport:y}=i.utils,{formatDate:I}=i.utils,f={key:void 0,date:void 0,modality:void 0,description:void 0};function v(e){let{servicesManager:t,extensionManager:a}=e;const[s,r]=(0,o.O_)(),[c,l]=(0,n.useState)(Date.now().toString()),u=function(e,t){const[a,s]=(0,n.useState)(e);return(0,n.useEffect)((()=>{const a=setTimeout((()=>{s(e)}),t);return()=>{clearTimeout(a)}}),[e,t]),a}(c,200),{MeasurementService:d,UIDialogService:m,DisplaySetService:h}=t.services,[g,p]=(0,n.useState)(f),[S,y]=(0,n.useState)([]);(0,n.useEffect)((()=>{const e=d.getMeasurements().map((e=>function(e,t,a){const{referenceStudyUID:n,referenceSeriesUID:s,SOPInstanceUID:r}=e,o=(i.DicomMetadataStore.getInstance(n,s,r),a.getDisplaySetsForSeries(s));if(!o[0]||!o[0].images)throw new Error('The tracked measurements panel should only be tracking "stack" displaySets.');const{displayText:c}=e;return{uid:e.uid,label:e.label||"(empty)",measurementType:e.type,displayText:c||[],isActive:!1}}(e,d.VALUE_TYPES,h)));y(e)}),[d,u]),(0,n.useEffect)((()=>{p(f)}),[g.key]),(0,n.useEffect)((()=>{const e=d.EVENTS.MEASUREMENT_ADDED,t=d.EVENTS.RAW_MEASUREMENT_ADDED,a=d.EVENTS.MEASUREMENT_UPDATED,n=d.EVENTS.MEASUREMENT_REMOVED,s=d.EVENTS.MEASUREMENTS_CLEARED,r=[];return[e,t,a,n,s].forEach((e=>{r.push(d.subscribe(e,(()=>{l(Date.now().toString())})).unsubscribe)})),()=>{r.forEach((e=>{e()}))}}),[d]);const v=e=>{let{uid:t,isActive:a}=e;d.jumpToMeasurement(s.activeViewportId,t),E({uid:t,isActive:a})},E=e=>{let{uid:t,isActive:a}=e;if(!a){const e=[...S],a=e.find((e=>e.uid===t));e.forEach((e=>e.isActive=e.uid===t)),a.isActive=!0,y(e)}},D=e=>{let{uid:t}=e;d.remove(t)},b=S.filter((e=>e.measurementType!==d.VALUE_TYPES.POINT)),w=S.filter((e=>e.measurementType===d.VALUE_TYPES.POINT));return n.createElement(n.Fragment,null,n.createElement("div",{className:"overflow-x-hidden overflow-y-auto invisible-scrollbar","data-cy":"trackedMeasurements-panel"},g.key&&n.createElement(o.YL,{date:I(g.date),modality:g.modality,description:g.description}),n.createElement(o.wt,{title:"Measurements",amount:b.length,data:b,onClick:v,onEdit:e=>{let{uid:t,isActive:a}=e;const s=d.getMeasurement(t);v({uid:t,isActive:a});const r=e=>{let{action:a,value:n}=e;if("save"===a.id)d.update(t,{...s,...n},!0);m.dismiss({id:"enter-annotation"})};m.create({id:"enter-annotation",centralize:!0,isDraggable:!1,showOverlay:!0,content:o.Vq,contentProps:{title:"Enter your annotation",noCloseButton:!0,value:{label:s.label||""},body:e=>{let{value:t,setValue:a}=e;return n.createElement("div",{className:"p-4 bg-primary-dark"},n.createElement(o.II,{autoFocus:!0,className:"mt-2 bg-black border-primary-main",type:"text",containerClassName:"mr-2",value:t.label,onChange:e=>{e.persist(),a((t=>({...t,label:e.target.value})))},onKeyPress:e=>{"Enter"===e.key&&r({value:t,action:{id:"save"}})}}))},actions:[{id:"cancel",text:"Cancel",type:"primary"},{id:"save",text:"Save",type:"secondary"}],onSubmit:r}})},onDelete:D}),0!==w.length&&n.createElement(o.wt,{title:"Additional Findings",amount:w.length,data:w,onClick:v,onDelete:D})))}v.propTypes={servicesManager:r().shape({services:r().shape({MeasurementService:r().shape({getMeasurements:r().func.isRequired,VALUE_TYPES:r().object.isRequired}).isRequired}).isRequired}).isRequired};const E=v;var D=a(63403),b=a(14446),w=a(36605),U=a(47706);function M(e){let{formIndex:t,name:a,value:s,defaultValue:r,options:i,onChange:o}=e;const{labels:c,precision:l,max:u}=i,d=e=>{if(null==e)return null;const t=Object.keys(c).map(((e,t)=>({key:e,value:c[e].value}))).find((t=>t.value==e));return t?Number(t.key):null},[m,h]=n.useState(d(null!==s?s:r)),[g,p]=n.useState(-1);return n.createElement(b.ZP,{className:"p-2"},n.createElement("div",null,n.createElement(U.ZP,{sx:{fontSize:14},color:"text.secondary",gutterBottom:!0},a),n.createElement(U.ZP,{variant:"h6",component:"div"},null!==m||-1!==g?c[-1!==g?g:m].value:"?"),n.createElement(U.ZP,{variant:"body2"},null!==m||-1!==g?c[-1!==g?g:m].description:"Please Select")),n.createElement(D.ZP,{name:"hover-feedback",value:m,precision:l,max:u,onChange:(e,a)=>{o({formIndex:t,value:a?c[a].value:a}),h(a)},onChangeActive:(e,t)=>{p(t)},emptyIcon:n.createElement(w.Z,{style:{opacity:.55},fontSize:"inherit"})}))}var R=a(60792),T=a(65877),P=a(69985);function N(e){let{formIndex:t,name:a,value:s,defaultValue:r,options:i,onChange:o}=e;const{labels:c,cols:l}=i,[u,d]=n.useState(null!==s?s:r);return n.useEffect((()=>{d(null!==s?s:r)}),[s]),n.createElement(b.ZP,{className:"p-2"},n.createElement("div",null,n.createElement(U.ZP,{sx:{fontSize:14},color:"text.secondary",gutterBottom:!0},a),n.createElement(U.ZP,{variant:"body2",component:"div"},Boolean(c.find((e=>e.value==u)))?c.find((e=>e.value==u)).description:"?")),c.reduce(((e,t,a)=>{const n=Math.floor(a/(l||3));return e[n]=[].concat(e[n]||[],t),e}),[]).map(((e,a)=>n.createElement(R.Z,{row:!0,key:a,name:"grid-select-row",value:u,onChange:(e,a)=>{o({formIndex:t,value:a}),d(a)}},e.map(((e,t)=>n.createElement(T.ZP,{key:t,value:e.value,control:n.createElement(P.ZP,null),label:e.value})))))))}var x=a(47180),C=a(50417);function A(e){let t,{formIndex:a,name:s,value:r,defaultValue:i,options:o,onChange:c}=e;return null!==r?t=Boolean(r):(t=Boolean(i),c({formIndex:a,value:t})),n.createElement(b.ZP,{className:"p-2"},n.createElement(x.ZP,null,n.createElement(T.ZP,{control:n.createElement(C.ZP,{checked:t,onChange:e=>c({formIndex:a,value:e.target.checked})}),label:n.createElement(U.ZP,{variant:"body2",color:"textSecondary"},s)})))}var O=a(85985),V=a(8324),k=a.n(V);function q(e){let{formIndex:t,name:a,value:s,defaultValue:r,options:i,onChange:o}=e;const[c,l]=n.useState(null!==s?s:null!==r?r:""),{rows:u}=i,d=(0,n.useMemo)((()=>k()(((e,t)=>{o({formIndex:e,value:t})}),600)),[o]);return n.createElement(b.ZP,{className:"p-2"},n.createElement(O.ZP,{id:"outlined-multiline-flexible",inputProps:{style:{fontSize:"0.75em"}},label:a,multiline:!0,rows:u,value:c,fullWidth:!0,margin:"dense",size:"small",onChange:e=>{l(e.target.value),d(t,e.target.value)}}))}function L(e){let{formIndex:t,name:a,value:s,defaultValue:r,options:i}=e;return n.createElement(b.ZP,{sx:{display:"flex"},className:"p-2"},n.createElement(U.ZP,{sx:{fontSize:14,marginRight:1},color:"text.secondary",gutterBottom:!0},a,":"),n.createElement(U.ZP,{variant:"body2"},null!==s?s.toString():null!==r?r.toString():""))}var _=a(15471),$=a(98925);function F(e){let{value:t}=e;const a=e=>{const[t,a,n]=(s=Date.now()-e,r=864e5,i=36e5,o=Math.floor(s/r),c=Math.floor((s-o*r)/i),60===(l=Math.round((s-o*r-c*i)/6e4))&&(c++,l=0),24===c&&(o++,c=0),[o,c,l]);var s,r,i,o,c,l;return t>7?new Date(e).toLocaleDateString("en-us",{year:"numeric",month:"short",day:"numeric"}):t>2?`${t} days ago`:a>2?`${a} hours ago`:n>2?`${n} mins ago`:"just now"};try{t=JSON.parse(t)}catch(e){console.error(e,t),t=null}return t?n.createElement(b.ZP,null,n.createElement(_.ZP,{sx:{"& .MuiCardHeader-content":{overflow:"hidden"}},avatar:n.createElement($.ZP,{imgProps:{crossOrigin:"anonymous",referrerPolicy:"no-referrer"},src:t.picture}),title:t.email,subheader:`Updated ${a(t.lastUpdated)}`})):n.createElement(b.ZP,null,n.createElement(_.ZP,{sx:{"& .MuiCardHeader-content":{overflow:"hidden"}},avatar:n.createElement($.ZP,null),title:"----",subheader:"No last update"}))}const Z=function(e){let{formTemplate:t,formValue:a,setFormValue:s}=e;const r=e=>{let{formIndex:t,value:n}=e;const r=[...a];r[t]=n,s([...r])};if(t){const e=t.map(((e,t)=>{switch(e.type){case"checkbox":return n.createElement("div",{key:t,className:"p-2 bg-primary-dark"},n.createElement(A,{formIndex:t,name:e.name,options:e.template,defaultValue:e.defaultValue,value:a[t],onChange:r}));case"rating":return n.createElement("div",{key:t,className:"p-2 bg-primary-dark"},n.createElement(M,{formIndex:t,name:e.name,options:e.template,defaultValue:e.defaultValue,value:a[t],onChange:r}));case"grid":return n.createElement("div",{key:t,className:"p-2 bg-primary-dark"},n.createElement(N,{formIndex:t,name:e.name,options:e.template,defaultValue:e.defaultValue,value:a[t],onChange:r}));case"textarea":return n.createElement("div",{key:t,className:"p-2 bg-primary-dark"},n.createElement(q,{formIndex:t,name:e.name,options:e.template,defaultValue:e.defaultValue,value:a[t],onChange:r}));case"user_profile":return n.createElement("div",{key:t,className:"p-2 bg-primary-dark"},n.createElement(F,{value:a[t]}));default:return n.createElement("div",{key:t,className:"p-2 bg-primary-dark"},n.createElement(L,{formIndex:t,name:e.name,options:e.template,defaultValue:e.defaultValue,value:a[t]}))}}));return n.createElement("div",null,e)}return null};var j=a(3366),H=a(58041),G=a(46258),B=a(32122),z=a(55545);function W(e){let{servicesManager:t,extensionManager:a}=e;const{GoogleSheetsService:s}=t.services,[r,i]=(0,n.useState)(s.getFormTemplate()),[o,c]=(0,n.useState)(s.getFormValue()),[l,u]=(0,n.useState)(!1),[d,m]=(0,n.useState)(!0),[h,g]=(0,n.useState)(!Boolean(o&&r)),[p,S]=(0,n.useState)(!1),y=()=>s.getRow(1),I=()=>s.getRow(-1),f=(0,n.useMemo)((()=>k()(y,300)),[]),v=(0,n.useMemo)((()=>k()(I,300)),[]);return(0,n.useEffect)((()=>{const e=[];return e.push(s.subscribe(s.EVENTS.GOOGLE_SHEETS_CHANGE,(()=>{m(!0),c(s.getFormValue()),i(s.getFormTemplate()),g(!1)})).unsubscribe),e.push(s.subscribe(s.EVENTS.GOOGLE_SHEETS_ERROR,(()=>{u(!0)})).unsubscribe),()=>{e.forEach((e=>e()))}}),[s]),(0,n.useEffect)((()=>{d||(S(!0),s.writeFormToRow(o).then((e=>{S(!1)}))),m(!1)}),[o]),l?n.createElement(b.ZP,{sx:{display:"flex"},className:"p-2"},n.createElement(U.ZP,{sx:{fontSize:14,marginRight:1},color:"text.secondary",gutterBottom:!0},"There was an error connecting to Google Sheets.")):h?n.createElement(j.ZP,null):n.createElement(n.Fragment,null,n.createElement("div",{style:{color:"white",overflow:"auto"}},p?n.createElement(j.ZP,null):n.createElement("div",{style:{height:"4px"}}),n.createElement(Z,{formTemplate:r,formValue:o,setFormValue:c})),n.createElement("div",{className:"flex justify-center p-4"},n.createElement(b.ZP,null,n.createElement(z.ZP,{variant:"contained","aria-label":"outlined primary button group"},n.createElement(H.ZP,{loading:p,loadingPosition:"start",startIcon:n.createElement(B.Z,null),variant:"contained",color:"primary",onClick:v},"Prev"),n.createElement(H.ZP,{loading:p,loadingPosition:"end",endIcon:n.createElement(G.Z,null),variant:"contained",color:"primary",onClick:f},"Next")))))}W.propTypes={servicesManager:r().shape({services:r().shape({}).isRequired}).isRequired};const Y=W;var Q=a(73289);function J(e){let{servicesManager:t,extensionManager:a}=e;return n.createElement(n.Fragment,null,n.createElement("div",{style:{height:"150px",overflowY:"auto"}},n.createElement(E,{servicesManager:t,extensionManager:a})),n.createElement("div",{className:"m-2"},n.createElement(Q.ZP,{style:{background:"white"}})),n.createElement(Y,{servicesManager:t,extensionManager:a}))}J.propTypes={servicesManager:r().shape({services:r().shape({}).isRequired}).isRequired};const K=J;const X=function(e){let{commandsManager:t,extensionManager:a,servicesManager:n}=e;return[{name:"seriesList",iconName:"group-layers",iconLabel:"Studies",label:"Studies",component:S.bind(null,{commandsManager:t,extensionManager:a,servicesManager:n})},{name:"measurements",iconName:"list-bullets",iconLabel:"Measure",label:"Measurements",component:E.bind(null,{commandsManager:t,extensionManager:a,servicesManager:n})},{name:"form",iconName:"list-bullets",iconLabel:"Form",label:"Form",component:Y.bind(null,{commandsManager:t,extensionManager:a,servicesManager:n})},{name:"form-and-measurements",iconName:"list-bullets",iconLabel:"Form",label:"Form",component:K.bind(null,{commandsManager:t,extensionManager:a,servicesManager:n})}]};function ee(){return ee=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var a=arguments[t];for(var n in a)Object.prototype.hasOwnProperty.call(a,n)&&(e[n]=a[n])}return e},ee.apply(this,arguments)}const te=n.lazy((()=>Promise.all([a.e(816),a.e(515)]).then(a.bind(a,95515)))),ae=e=>n.createElement(n.Suspense,{fallback:n.createElement("div",null,"Loading...")},n.createElement(te,e));const ne=function(e){let{servicesManager:t,commandsManager:a,extensionManager:s}=e;return[{name:"cornerstone-gradient",component:e=>n.createElement(ae,ee({servicesManager:t,commandsManager:a,extensionManager:s,disableViewportOrientationMarkers:!0},e))}]},se={id:"breast",locked:!0,hasUpdatedPriorsInformation:!1,name:"Breast",createdDate:"2021-02-23T19:22:08.894Z",modifiedDate:"2021-02-23T19:22:08.894Z",availableTo:{},editableBy:{},protocolMatchingRules:[],displaySetSelectors:{LMLO:{seriesMatchingRules:[{weight:5,attribute:"ImageLaterality",constraint:{contains:{value:"L"}},required:!1},{weight:5,attribute:"ViewCodeSequence",constraint:{contains:{value:"R-10226"}},required:!1}]},LCC:{seriesMatchingRules:[{weight:5,attribute:"ImageLaterality",constraint:{contains:{value:"L"}},required:!1},{weight:5,attribute:"ViewCodeSequence",constraint:{contains:{value:"R-10242"}},required:!1}]},RMLO:{seriesMatchingRules:[{weight:5,attribute:"ImageLaterality",constraint:{contains:{value:"R"}},required:!1},{weight:5,attribute:"ViewCodeSequence",constraint:{contains:{value:"R-10226"}},required:!1}]},RCC:{seriesMatchingRules:[{weight:5,attribute:"ImageLaterality",constraint:{contains:{value:"R"}},required:!1},{weight:5,attribute:"ViewCodeSequence",constraint:{contains:{value:"R-10242"}},required:!1}]}},toolGroupIds:["default"],stages:[{id:"breast-staging",name:"Breast Staging",viewportStructure:{type:"grid",properties:{rows:1,columns:4}},viewports:[{viewportOptions:{toolGroupId:"default"},displaySets:[{id:"RMLO"}]},{viewportOptions:{toolGroupId:"default"},displaySets:[{id:"LMLO"}]},{viewportOptions:{toolGroupId:"default"},displaySets:[{id:"RCC"}]},{viewportOptions:{toolGroupId:"default"},displaySets:[{id:"LCC"}]}],createdDate:"2021-02-23T18:32:42.850Z"}],numberOfPriorsReferenced:-1};const re=function(){return[{name:se.id,protocol:se}]};var ie=a(67540),oe=a(95013);function ce(e){let{instance:t,frame:a,config:n,thumbnail:s=!1}=e;if(!t)return;if(t.url)return t.url;const r=s?"thumbnailRendering":"imageRendering";if(n[r]&&"wadouri"!==n[r])return function(e,t,a){const n=function(e,t,a){const n=function(e,t){const{StudyInstanceUID:a,SeriesInstanceUID:n,SOPInstanceUID:s}=e;return`${t.wadoRoot}/studies/${a}/series/${n}/instances/${s}`}(e,t);return`${n}/frames/${a=a||1}`}(e,t,a);if(n)return`wadors:${n}`}(t,n,a);{const e=function(e,t){const{StudyInstanceUID:a,SeriesInstanceUID:n,SOPInstanceUID:s}=t,r=[];r.push("requestType=WADO"),r.push(`studyUID=${a}`),r.push(`seriesUID=${n}`),r.push(`objectUID=${s}`),r.push("contentType=application/dicom"),r.push("transferSyntax=*");const i=r.join("&");return`${e.wadoUriRoot}?${i}`}(n,t);let s="dicomweb:"+e;return void 0!==a&&(s+="&frame="+a),s}}var le=a(44379),ue=a.n(le);const de=i.classes.MetadataProvider,{datasetToBlob:me}=ie.default.data,he={studyInstanceUid:"StudyInstanceUID",patientId:"PatientID"};let ge={urls:[],studyInstanceUIDMap:new Map};const pe=e=>ge.urls.find((t=>t.url===e)),Se=(e,t)=>{let a=t?e.replace("https://storage.googleapis.com",`https://storage.googleapis.com/${t}`):e;return a=a.includes(":zip//")?a.replace(/^dicomweb:/,"dicomzip:"):a,a},ye=(e,t,a)=>{let n=e.map((e=>(e.instances=ue().uniqBy(e.instances,(e=>e.url)),e)));ue().isEmpty(a)||(n=n.filter((e=>a.includes(e.SeriesInstanceUID))));const s=Object.values(n.reduce(((e,t)=>{const a=t.StudyInstanceUID;return e[a]||(e[a]=[]),e[a].push(t),e}),{})).map((e=>{const a=e.reduce(((e,t)=>e+(parseInt(t.NumInstances)||0)),0),n=e.map((e=>({SeriesInstanceUID:e.SeriesInstanceUID,Modality:e.Modality,SeriesDescription:e.SeriesDescription||"No description",StudyInstanceUID:e.StudyInstanceUID,SeriesNumber:e.SeriesNumber,SeriesTime:e.SeriesTime,NumInstances:isNaN(parseInt(e.NumInstances))?0:parseInt(e.NumInstances),instances:e.instances.map((e=>({metadata:e.metadata,url:Se(e.url,t)})))})));return{StudyInstanceUID:e[0].StudyInstanceUID,PatientName:e[0].PatientName,PatientSex:e[0].PatientSex,AccessionNumber:e[0].AccessionNumber,StudyDate:e[0].StudyDate,PatientID:e[0].PatientID,PatientWeight:e[0].PatientWeight,PatientAge:e[0].PatientAge,StudyDescription:e[0].StudyDescription||"No description",StudyTime:e[0].StudyTime,NumInstances:a,Modalities:`["${e[0].Modality}"]`,series:n}}));return{studies:s}},Ie=async e=>{let{bucketName:t,prefix:a,studyuids:n,headers:s}=e;const r=n.map((async e=>{const n=`https://storage.googleapis.com/storage/v1/b/${t}/o?prefix=${`${a}/${e}/`}&delimiter=/`,r=await fetch(n,{headers:s}),i=await r.json(),o=(i.items,(i.prefixes||[]).map((async e=>{const a=`https://storage.googleapis.com/storage/v1/b/${t}/o/${encodeURIComponent(`${e}metadata.json.gz`)}?alt=media`;return(await fetch(a,{headers:s})).json()})));return Promise.all(o)}));return await Promise.all(r)},fe=(e,t)=>{let a=[];return ge.urls.map((n=>{n.studies.map((n=>{n[e]===t&&a.push(n)}))})),a},ve=async(e,t)=>{const{StudyInstanceUID:a,SeriesInstanceUID:n,SOPInstanceUID:s,SeriesDescription:r}=e,i=new URLSearchParams(window.location.search),o=i.get("bucket")||"gradient-health-search-viewer-links",c=i.get("bucket-prefix")||"dicomweb",l=i.get("seg-bucket")||o,u=i.get("seg-prefix")||c,d=`${u}/studies/${a}/series/${n}/instances/${s}/${encodeURIComponent(r)}.dcm`,m=`https://storage.googleapis.com/upload/storage/v1/b/${l}/o?uploadType=media&name=${d}`,h=me(e);await fetch(m,{method:"POST",headers:{...t,"Content-Type":"application/dicom"},body:h}).then((e=>e.json())).then((s=>{if(s.error)throw new Error(`${s.error.code}: ${s.error.message}`);const r=`dicomweb:https://storage.googleapis.com/${l}/${s.name}`;e.url=r;const i={Modality:(o=e).Modality,SeriesInstanceUID:o.SeriesInstanceUID,SeriesDescription:o.SeriesDescription,SeriesNumber:Number(o.SeriesNumber),SeriesDate:o.SeriesDate,StudyInstanceUID:o.StudyInstanceUID,instances:[{metadata:{FrameOfReferenceUID:o.FrameOfReferenceUID,SOPInstanceUID:o.SOPInstanceUID,SOPClassUID:o.SOPClassUID,ReferencedSeriesSequence:o.ReferencedSeriesSequence,SharedFunctionalGroupsSequence:o.SharedFunctionalGroupsSequence},url:o.url}]};var o;const c=oe.ZP.gzip(JSON.stringify(i));return fetch(`https://storage.googleapis.com/upload/storage/v1/b/${l}/o?uploadType=media&name=${u}/${a}/${n}/metadata.json.gz&contentEncoding=gzip`,{method:"POST",headers:{...t,"Content-Type":"application/json"},body:c}).then((e=>e.json())).then((e=>{if(e.error)throw new Error(`${e.error.code}: ${e.error.message}`)})).catch((e=>{throw new Error(e.message||"Failed to store DicomSeg metadata")}))})).catch((e=>{throw new Error(e.message||"Failed to store DicomSeg file")}))};let Ee=null;function De(e,t){var{name:a,wadoRoot:n}=e;const s=e=>{Ee=e,Ee.name,Ee.wadoRoot};s(e);const r={updateConfig:e=>{s(e)},initialize:async e=>{let{params:a,query:n,url:s}=e;s||(s=n.get("url"));let r=pe(s);if(r)return r.studies.map((e=>e.StudyInstanceUID));const{UserAuthenticationService:i}=t.services,o=await Ie({bucketName:n.get("bucket")||"gradient-health-search-viewer-links",prefix:n.get("bucket-prefix")||"dicomweb",studyuids:n.getAll("StudyInstanceUID"),headers:i.getAuthorizationHeader()}),c=ye(ue().flatten(o),n.get("prefix"),n.getAll("SeriesInstanceUID"));let l,u;c.studies.forEach((e=>{l=e.StudyInstanceUID,e.series.forEach((e=>{u=e.SeriesInstanceUID,e.instances.forEach((e=>{const{url:t,metadata:a}=e;de.addImageIdToUIDs(t,{StudyInstanceUID:l,SeriesInstanceUID:u,SOPInstanceUID:a.SOPInstanceUID})}))}))})),ge.urls.push({url:s,studies:[...c.studies]}),ge.studyInstanceUIDMap.set(s,c.studies.map((e=>e.StudyInstanceUID)))},query:{studies:{mapParams:()=>{},search:async e=>{const[t,a]=Object.entries(e)[0],n=he[t];return fe(n,a).map((e=>({accession:e.AccessionNumber,date:e.StudyDate,description:e.StudyDescription,instances:e.NumInstances,modalities:e.Modalities,mrn:e.PatientID,patientName:e.PatientName,studyInstanceUid:e.StudyInstanceUID,NumInstances:e.NumInstances,time:e.StudyTime})))},processResults:()=>{console.debug(" DICOMJson QUERY processResults")}},series:{search:()=>{console.debug(" DICOMJson QUERY SERIES SEARCH")}},instances:{search:()=>{console.debug(" DICOMJson QUERY instances SEARCH")}}},retrieve:{directURL:e=>{console.debug("Not implemented",e)},series:{metadata:function(){let{StudyInstanceUID:e,madeInClient:t=!1,customSort:a}=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};if(!e)throw new Error("Unable to query for SeriesMetadata without StudyInstanceUID");const n=fe("StudyInstanceUID",e)[0];let s;s=a?a(n.series):n.series;const r=s.map((e=>{const t={StudyInstanceUID:n.StudyInstanceUID,...e};return delete t.instances,t}));i.DicomMetadataStore.addSeriesMetadata(r,t);const o=s.length;s.forEach(((a,s)=>{const r=a.instances.map((e=>{const t={...e.metadata,url:e.url,imageId:e.url,...a,...n};return delete t.instances,delete t.series,t}));var c;c=r,i.DicomMetadataStore.addInstances(c,t),s===o-1&&(i.DicomMetadataStore.getStudy(e,t).isLoaded=!0)}))}}},store:{dicom:async e=>{if("SEG"===e.Modality){const a=t.services.UserAuthenticationService.getAuthorizationHeader();try{await ve(e,a)}catch(e){throw e}}else console.debug(" DICOMJson store dicom")}},getImageIdsForDisplaySet(e){const t=e.images,a=[];return t?(e.images.forEach((e=>{const t=e.NumberOfFrames;if(t>1)for(let n=0;n<t;n++){const t=ce({instance:e,frame:n,config:Ee});a.push(t)}else{const t=ce({instance:e,config:Ee});a.push(t)}})),a):a},getImageIdsForInstance(e){let{instance:t,frame:a}=e;return ce({instance:t,frame:a})},getStudyInstanceUIDs:e=>{let{params:t,query:a}=e;const n=a.get("url");return ge.studyInstanceUIDMap.get(n)}};return i.Is.create(r)}const be=function(e){let{servicesManager:t}=e;return[{name:"bq",type:"jsonApi",createDataSource:e=>De(e,t)}]},we=JSON.parse('{"u2":"@gradienthealth/ohif-gradienthealth-extension"}').u2,Ue=["A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z"];let Me=[...Ue];Ue.forEach((e=>{Ue.forEach((t=>{Me.push(e+t)}))}));const Re=[...Me];const Te={GOOGLE_SHEETS_CHANGE:"event::gradienthealth::GoogleSheets:FormChange",GOOGLE_SHEETS_ERROR:"event::gradienthealth::GoogleSheets:Error",GOOGLE_SHEETS_DESTROY:"event::gradienthealth::GoogleSheets:Destroy"},Pe=e=>{switch(e){case"TRUE":return!0;case"FALSE":return!1;case"YES":return!0;case"NO":return!1;case"":case void 0:return null}return e};class Ne{constructor(e,t,a){this.serviceManager=e,this.listeners={},this.api_key="AIzaSyDu5Rt54oHX1w3O5kZTARz7DClaxNjTpEs",this.EVENTS=Te,this.sheetId=null,this.index=null,this.sheetName=null,this.formTemplate=null,this.formValue=null,this.settings=null,this.formHeader=null,this.rows=null,this.studyUIDToIndex={},this.extensionManager=a,this.DicomMetadataStore=i.DicomMetadataStore,Object.assign(this,i.KZ)}cacheNearbyStudyInstanceUIDs(e,t,a){const{CacheAPIService:n}=this.serviceManager.services,s=this.studyUIDToIndex[e],r=s-t<2?2:s-t,i=s+a,o=this.formHeader.findIndex((e=>"URL"==e));this.rows.slice(r,i).forEach((e=>{const t=e[o],a=new URLSearchParams("?"+t.split("?")[1]).get("StudyInstanceUIDs");n.cacheStudy(a)}))}setFormByStudyInstanceUID(e){const t=this.studyUIDToIndex[e];this.setFormByIndex(t),this.cacheNearbyStudyInstanceUIDs(e,2,32)}setFormByIndex(e){this.index=e;const t=this.rows[e-1];this.formValue=this.readFormValue(t),this._broadcastEvent(Te.GOOGLE_SHEETS_CHANGE)}async init(){try{const{UserAuthenticationService:e}=this.serviceManager.services;this.user=e.getUser();const t=new URLSearchParams(window.location.search);if(!t.get("sheetId"))return this._broadcastEvent(Te.GOOGLE_SHEETS_ERROR);if(!t.get("sheetName"))return this._broadcastEvent(Te.GOOGLE_SHEETS_ERROR);this.sheetId=t.get("sheetId"),this.sheetName=t.get("sheetName"),this.settings=await this.readRange(1,6,this.sheetId,"Settings"),this.formHeader=(await this.readRange(1,1)).values[0],this.rows=(await this.readRange(1,1e5)).values,this.formHeader=this.rows[0];const a=this.formHeader.findIndex((e=>"URL"==e));this.studyUIDToIndex=this.rows.slice(1).reduce(((e,t,n)=>{const s=t[a];return e[new URLSearchParams("?"+s.split("?")[1]).get("StudyInstanceUIDs")]=n+2,e}),{}),this.index=this.studyUIDToIndex[t.get("StudyInstanceUIDs")];const n=this.settings.values[0].map(((e,t)=>this.settings.values.map((e=>e[t])))),s=n[0];this.formTemplate=n.slice(1,-1).map((e=>e.reduce(((e,t,a)=>{switch(t=Pe(t),s[a]){case"template":try{t&&(e[s[a]]=JSON.parse(t))}catch(e){console.warn(t,e)}break;case"order":e[s[a]]=Number(t);break;default:e[s[a]]=t}return e}),{}))).filter((e=>e.show)).sort(((e,t)=>e.order-t.order)),this.setFormByStudyInstanceUID(t.get("StudyInstanceUIDs"))}catch(e){console.error(e),this._broadcastEvent(Te.GOOGLE_SHEETS_ERROR)}}readFormValue(e){return this.formTemplate.map((t=>{const a=this.formHeader.findIndex((e=>e==t.name));if(-1!==a)return Pe(e[a])}))}async readRange(e,t){const a=`https://sheets.googleapis.com/v4/spreadsheets/${arguments.length>2&&void 0!==arguments[2]?arguments[2]:this.sheetId}/values/${arguments.length>3&&void 0!==arguments[3]?arguments[3]:this.sheetName}!${`A${e}:ZZ${t}`}`,n=await fetch(a,{headers:{Authorization:"Bearer "+this.user.access_token}});return await n.json()}writeRange(e,t,a,n){return new Promise(((s,r)=>{let i=`https://sheets.googleapis.com/v4/spreadsheets/${e}/values/${t}!${a}?valueInputOption=USER_ENTERED`;var o=new XMLHttpRequest;o.open("PUT",i),o.setRequestHeader("Content-type","application/json"),o.setRequestHeader("Authorization","Bearer "+this.user.access_token),o.onload=()=>{200==o.status?s():r()},o.send(JSON.stringify({range:`${t}!${a}`,majorDimension:"ROWS",values:[n]}))}))}async writeFormToRow(e){const t=this.formHeader.map((t=>{const a=this.formTemplate.findIndex((e=>t==e.name));if(a>0)return e[a];if("Updated By"===t){const e=this.serviceManager.services.UserAuthenticationService.getUser();return JSON.stringify({email:e.profile.email,picture:e.profile.picture,lastUpdated:Date.now()})}return null}));return await this.writeRange(this.sheetId,this.sheetName,`A${this.index}:${Re[this.formHeader.length-1]}${this.index}`,t),t}getFormTemplate(){return this.formTemplate?this.formTemplate:null}getFormValue(){return this.formValue?this.formValue:null}async getRow(e){try{const{DisplaySetService:t,HangingProtocolService:a,CacheAPIService:n}=this.serviceManager.services,s=this.rows[this.index+e-1];s||(window.location.href=`https://docs.google.com/spreadsheets/d/${this.sheetId}`);const r=s[this.formHeader.findIndex((e=>"URL"==e))],o=new URLSearchParams("?"+r.split("?")[1]).get("StudyInstanceUIDs");o||(window.location.href=`https://docs.google.com/spreadsheets/d/${this.sheetId}`);const c=this.extensionManager.getActiveDataSource()[0];await c.retrieve.series.metadata({StudyInstanceUID:o});const l=[i.DicomMetadataStore.getStudy(o)];a.run({studies:l,activeStudy:l[0],displaySets:t.getActiveDisplaySets().filter((e=>e.StudyInstanceUID===o))},"breast");const u=new URLSearchParams(window.location.search);u.set("StudyInstanceUIDs",o);const d=window.location.href.split("?")[0]+"?"+u.toString();window.history.replaceState({},null,d),this.setFormByStudyInstanceUID(o),n.setViewedStudy(o)}catch(e){console.error(e)}}destroy(){this.sheetId=null,this.index=null,this.sheetName=null,this.formTemplate=null,this.formValue=null,this._broadcastEvent(Te.GOOGLE_SHEETS_ERROR)}}var xe=a(79917),Ce=a(22239);const Ae={CROP_DISPLAY_AREA_INIT:"event::gradienthealth::CropDisplayAreaService:init"};class Oe{constructor(e){this.serviceManager=void 0,this.listeners=void 0,this.EVENTS=void 0,this.serviceManager=e,this.listeners={},this.EVENTS=Ae,window.tf=Ce,Object.assign(this,i.KZ)}init(){xe.eventTarget.addEventListener(xe.EVENTS.STACK_VIEWPORT_NEW_STACK,(e=>{const{HangingProtocolService:t}=this.serviceManager.services;"breast"===t.protocol.id&&this.handleBreastDensityHP(e)}))}handleBreastDensityHP(e){const{HangingProtocolService:t,cornerstoneViewportService:a}=this.serviceManager.services,{element:n,viewportId:s}=e.detail,r=(0,xe.getEnabledElement)(n),i=r?.viewport;if(!i)return;const{voiRange:o,invert:c}=i.getProperties();let l;if(o?.lower&&!c&&(l=o?.lower),o?.upper&&c&&(l=o?.upper),!l)return;const u=a.getViewportInfo(s),d=Array.from(t.displaySetMatchDetails.values()).findIndex((e=>e.displaySetInstanceUID===u.viewportData.data.displaySetInstanceUID)),m=Array.from(t.displaySetMatchDetails.keys())[d];if(!m)return;const h=i.getImageData(),g=h?.scalarData,p=h?.dimensions;if(!g||!p)return;const{bboxWidth:S,bboxHeight:y,width:I,height:f}=Ce.tidy((()=>{const e=Ce.tensor2d(new Float32Array(g),[p[1],p[0]]).greater(l),t=e.any(0),a=e.any(1),n=t.argMax(),s=t.reverse().argMax().mul(-1).add(t.size),r=a.argMax(),i=a.reverse().argMax().mul(-1).add(a.size);return{bboxWidth:s.sub(n).dataSync()[0],bboxHeight:i.sub(r).dataSync()[0],width:t.size,height:a.size}})),v=(i.sWidth,i.sHeight,S/I);"LMLO"===m&&i.setDisplayArea({imageArea:[v,v],imageCanvasPoint:{canvasPoint:[0,.5],imagePoint:[0,.5]},storeAsInitialCamera:!0},!0),"RMLO"===m&&i.setDisplayArea({imageArea:[v,v],imageCanvasPoint:{canvasPoint:[1,.5],imagePoint:[1,.5]},storeAsInitialCamera:!0},!0),"LCC"===m&&i.setDisplayArea({imageArea:[v,v],imageCanvasPoint:{canvasPoint:[0,.5],imagePoint:[0,.5]},storeAsInitialCamera:!0},!0),"RCC"===m&&i.setDisplayArea({imageArea:[v,v],imageCanvasPoint:{canvasPoint:[1,.5],imagePoint:[1,.5]},storeAsInitialCamera:!0},!0)}destroy(){}}var Ve=a(41851);const{getOptions:ke}=Ve.internal,qe={};class Le{constructor(e,t,a){this.listeners=void 0,this.EVENTS=void 0,this.element=void 0,this.commandsManager=void 0,this.extensionManager=void 0,this.dataSource=void 0,this.options=void 0,this.storageUsage=void 0,this.storageQuota=void 0,this.listeners={},this.EVENTS=qe,this.commandsManager=t,this.extensionManager=a,this.storageUsage=null,this.storageQuota=null,Object.assign(this,i.KZ)}init(){const e=this.extensionManager.getActiveDataSource();this.dataSource=e[0],xe.eventTarget.addEventListener("CORNERSTONE_CACHE_QUOTA_EXCEEDED_ERROR",this.handleQuotaExceededWriteError.bind(this)),window?.navigator?.storage?.estimate&&window?.navigator?.storage?.estimate().then((e=>{console.log("Storage use: ",1e-9*e.usage," of ",1e-9*e.quota," GB"),this.storageUsage=e.usage,this.storageQuota=e.quota})),window?.navigator?.storage?.persisted&&window?.navigator?.storage?.persist&&window?.navigator?.storage?.persisted().then((e=>{e?console.log("Storage will not be cleared except by explicit user action"):window?.navigator?.storage?.persist().then((e=>{e?console.log("Storage will not be cleared except by explicit user action"):console.log("Storage may be cleared by the UA under storage pressure.")}))}))}async setViewedStudy(e){await this.dataSource.retrieve.series.metadata({StudyInstanceUID:e});const t=i.DicomMetadataStore.getStudy(e).series.flatMap((e=>e.instances.flatMap((e=>e.imageId)))).map((e=>e.split(":").slice(1).join(":"))),a=ke().cache.getScope;ue().uniq(t.map((e=>a({url:e})))).forEach((async e=>{const t=await caches.open(e);(await t.keys()).forEach((async e=>{const a=await t.match(e.url,{ignoreVary:!0,ignoreMethod:!0,ignoreSearch:!0});if(!a)return;const n=new Request(e.url,{headers:{"dicom-last-put-date":(new Date).toUTCString(),"dicom-last-viewed-date":(new Date).toUTCString(),"dicom-content-length":e.headers.get("dicom-content-length")}});a&&t.put(n,a)}))}))}async cacheStudy(e){await this.dataSource.retrieve.series.metadata({StudyInstanceUID:e});const t=i.DicomMetadataStore.getStudy(e).series.flatMap((e=>e.instances.flatMap((e=>e.imageId))));this.cacheImageIds(t)}async cacheSeries(e,t){await this.dataSource.retrieve.series.metadata({StudyInstanceUID:e});const a=i.DicomMetadataStore.getStudy(e).series.filter((e=>e.SeriesInstanceUID===t)).flatMap((e=>e.instances.flatMap((e=>e.imageId))));this.cacheImageIds(a)}cacheImageIds(e){function t(e,t){return xe.imageLoader.loadAndCacheImage(e,t).then((()=>{}),(e=>{console.error(e)}))}const a=xe.Enums.RequestType.Prefetch,n={preScale:{enabled:!0},useRGBA:!0};e.forEach((e=>{const s={imageId:e};xe.imageLoadPoolManager.addRequest(t.bind(this,e,n),a,s,0)}))}async cacheMissingStudyImageIds(e){const t=(await window.caches.keys()).map((e=>e.split("studies/")[1].split("/")[0]));e.filter((e=>-1===t.indexOf(e))).forEach((e=>{this.cacheStudy(e)}))}async handleQuotaExceededWriteError(e){(await window.caches.keys()).forEach((async e=>{try{const t=await caches.open(e),a=await t.keys(),n=a[0].headers.get("dicom-last-viewed-date"),s=a[0].headers.get("dicom-last-put-date"),r=s?new Date(s):new Date,i=new Date;("undefined"!==n||i-r>7*864e5)&&window.caches.delete(e)}catch(e){console.error(e)}}))}destroy(){xe.eventTarget.removeEventListener("CORNERSTONE_CACHE_QUOTA_EXCEEDED_ERROR",this.handleQuotaExceededWriteError)}}const _e={id:we,getDataSourcesModule:e=>{let{servicesManager:t}=e;return be({servicesManager:t})},getHangingProtocolModule:re,getPanelModule:X,getViewportModule:ne,preRegistration(e){let{servicesManager:t,commandsManager:a,extensionManager:n}=e;var s;t.registerService(function(e,t,a){return{name:"GoogleSheetsService",create:n=>{let{configuration:s={}}=n;return new Ne(e,t,a)}}}(t,a,n)),t.registerService((s=t,{name:"CropDisplayAreaService",create:e=>{let{configuration:t={}}=e;return new Oe(s)}})),t.registerService(function(e,t,a){return{name:"CacheAPIService",create:n=>{let{configuration:s={}}=n;return new Le(e,t,a)}}}(t,a,n));const{HangingProtocolService:r}=t.services;r.addCustomAttribute("ViewCodeSequence","ViewCodeSequence",(e=>(e.ViewCodeSequence??((e.images||e.others||[])[0]||{}).ViewCodeSequence)[0].CodeValue))}}},88658:()=>{},7189:()=>{},89891:()=>{},56064:()=>{},88218:()=>{}}]);
//# sourceMappingURL=172.bundle.26abed0055d00eff7d85.js.map