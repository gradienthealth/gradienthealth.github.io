(globalThis.webpackChunk=globalThis.webpackChunk||[]).push([[8],{44239:(e,t,a)=>{"use strict";a.r(t),a.d(t,{default:()=>ut});var s={};a.r(s),a.d(s,{createGetImageSrcFromImageIdFn:()=>y,createRequestDisplaySetcreationFn:()=>f,getStudyForPatientUtility:()=>I});var n=a(43001),i=a(3827),r=a.n(i),o=a(71771),c=a(95303),l=a(62474);const{formatDate:u}=o.utils;function d({MeasurementService:e,DisplaySetService:t,UIDialogService:a,UINotificationService:s,getImageSrc:i,getStudiesForPatientByMRN:r,requestDisplaySetCreationForStudy:d,dataSource:m}){const{StudyInstanceUIDs:S}=(0,c.zG)(),[{activeViewportId:p,viewports:h,numCols:y,numRows:I},f]=(0,c.O_)(),E=(0,l.s0)(),[v,D]=(0,n.useState)("primary"),[b,w]=(0,n.useState)([...S]),[U,M]=(0,n.useState)([]),[R,T]=(0,n.useState)([]),[N,P]=(0,n.useState)({}),[x,A]=(0,n.useState)(null),C=h.get(p)?.displaySetInstanceUIDs,O=1===y&&1===I;(0,n.useEffect)((()=>{const t=e.EVENTS.MEASUREMENT_ADDED,a=e.EVENTS.RAW_MEASUREMENT_ADDED,s=[];return[t,a].forEach((t=>{s.push(e.subscribe(t,(({source:e,measurement:t})=>{const{referenceSeriesUID:a,referenceStudyUID:s}=t})).unsubscribe)})),()=>{s.forEach((e=>{e()}))}}),[e,p]),(0,n.useEffect)((()=>{S.forEach((e=>async function(e){const t=await m.query.studies.search({studyInstanceUid:e});if(!t?.length)throw E("/notfoundstudy","_self"),new Error("Invalid study URL");let a=t;try{a=await r(t)}catch(e){console.warn(e)}const s=a.map((e=>({AccessionNumber:e.accession,StudyDate:e.date,StudyDescription:e.description,NumInstances:e.instances,ModalitiesInStudy:e.modalities,PatientID:e.mrn,PatientName:e.patientName,StudyInstanceUID:e.studyInstanceUid,StudyTime:e.time}))).map((e=>({studyInstanceUid:e.StudyInstanceUID,date:u(e.StudyDate),description:e.StudyDescription,modalities:e.ModalitiesInStudy,numInstances:e.NumInstances})));M((e=>{const t=[...e];for(const a of s)e.find((e=>e.studyInstanceUid===a.studyInstanceUid))||t.push(a);return t}))}(e)))}),[S,m,r,E]),(0,n.useEffect)((()=>{t.activeDisplaySets.forEach((async e=>{const a={},s=t.getDisplaySetByUID(e.displaySetInstanceUID),n=m.getImageIdsForDisplaySet(s),r=n[Math.floor(n.length/2)];r&&(a[e.displaySetInstanceUID]=await i(r),P((e=>({...e,...a}))))}))}),[t,m,i]),(0,n.useEffect)((()=>{const e=g(t.activeDisplaySets,N,h,O,m,t,a,s);T(e)}),[t.activeDisplaySets,N,h,m]),(0,n.useEffect)((()=>{const e=t.subscribe(t.EVENTS.DISPLAY_SETS_ADDED,(e=>{const{displaySetsAdded:a,options:s}=e;a.forEach((async e=>{const a=e.displaySetInstanceUID,n={},r=t.getDisplaySetByUID(a);s.madeInClient&&A(a);const o=m.getImageIdsForDisplaySet(r),c=o[Math.floor(o.length/2)];c&&(n[a]=await i(c),P((e=>({...e,...n}))))}))})),n=t.subscribe(t.EVENTS.DISPLAY_SETS_CHANGED,(e=>{const n=g(e,N,h,O,m,t,a,s);T(n)}));return()=>{e.unsubscribe(),n.unsubscribe()}}),[t,m,i,N,h]);const V=function(e,t,a){const s=[],n=[],i=[];t.forEach((t=>{const r=a.filter((e=>e.StudyInstanceUID===t.studyInstanceUid)),c=(o.utils.sortBySeriesDate(r),Object.assign({},t,{displaySets:r}));e.includes(t.studyInstanceUid)?(s.push(c),i.push(c)):(n.push(c),i.push(c))}));const r=(e,t)=>{const a=Date.parse(e);return Date.parse(t)-a},c=[{name:"primary",label:"Primary",studies:s.sort(((e,t)=>r(e.date,t.date)))},{name:"recent",label:"Recent",studies:n.sort(((e,t)=>r(e.date,t.date)))},{name:"all",label:"All",studies:i.sort(((e,t)=>r(e.date,t.date)))}];return c}(S,U,R);return(0,n.useEffect)((()=>{if(x){const e=x,t=document.getElementById(`thumbnail-${e}`);t&&"function"==typeof t.scrollIntoView&&(t.scrollIntoView({behavior:"smooth"}),A(null))}}),[x,b,v]),(0,n.useEffect)((()=>{if(!x)return;const e=function(e,t){for(let a=0;a<t.length;a++){const{studies:s}=t[a];for(let n=0;n<s.length;n++){const{displaySets:i}=s[n];for(let r=0;r<i.length;r++){if(i[r].displaySetInstanceUID===e)return{tabName:t[a].name,StudyInstanceUID:s[n].studyInstanceUid}}}}}(x,V);if(!e)return void console.warn("jumpToThumbnail: displaySet thumbnail not found.");const{tabName:t,StudyInstanceUID:a}=e;D(t);if(!b.includes(a)){const e=[...b,a];w(e)}}),[b,x,V]),n.createElement(c.eX,{tabs:V,activeTabName:v,expandedStudyInstanceUIDs:b,onClickStudy:function(e){const a=b.includes(e),s=a?[...b.filter((t=>t!==e))]:[...b,e];if(w(s),!a){d(t,e,!0)}},onClickTab:e=>{D(e)},onClickThumbnail:()=>{},onDoubleClickThumbnail:e=>{f.setDisplaySetsForViewport({viewportId:p,displaySetInstanceUIDs:[e]})},activeDisplaySetInstanceUIDs:C})}d.propTypes={MeasurementService:r().shape({subscribe:r().func.isRequired,EVENTS:r().object.isRequired}).isRequired,DisplaySetService:r().shape({EVENTS:r().object.isRequired,activeDisplaySets:r().arrayOf(r().object).isRequired,getDisplaySetByUID:r().func.isRequired,subscribe:r().func.isRequired}).isRequired,dataSource:r().shape({getImageIdsForDisplaySet:r().func.isRequired}).isRequired,getImageSrc:r().func.isRequired,getStudiesForPatientByMRN:r().func.isRequired,requestDisplaySetCreationForStudy:r().func.isRequired};const m=d;function g(e,t,a,s,i,r,o,l){const d=[],m=[];return e.forEach((e=>{const g=t[e.displaySetInstanceUID],p=function(e){if(S.includes(e))return"thumbnailNoImage";return"thumbnailTracked"}(e.Modality),h=s?[]:Object.values(a).reduce(((t,a,s)=>(a?.displaySetInstanceUIDs?.includes(e.displaySetInstanceUID)&&t.push(a.viewportLabel),t)),[]),y="thumbnailTracked"===p?d:m,{displaySetInstanceUID:I}=e,f={displaySetInstanceUID:I,description:e.SeriesDescription,seriesNumber:String(e.SeriesNumber),modality:e.Modality,seriesDate:u(e.SeriesDate),numInstances:e.numImageFrames,StudyInstanceUID:e.StudyInstanceUID,componentType:p,imageSrc:g,dragData:{type:"displayset",displaySetInstanceUID:I},viewportIdentificator:h};"thumbnailNoImage"===p&&(i.reject&&i.reject.series?(f.canReject=!0,f.onReject=()=>{o.create({id:"ds-reject-sr",centralize:!0,isDraggable:!1,showOverlay:!0,content:c.Vq,contentProps:{title:"Delete Report",body:()=>n.createElement("div",{className:"p-4 text-white bg-primary-dark"},n.createElement("p",null,"Are you sure you want to delete this report?"),n.createElement("p",null,"This action cannot be undone.")),actions:[{id:"cancel",text:"Cancel",type:"secondary"},{id:"yes",text:"Yes",type:"primary",classes:["reject-yes-button"]}],onClose:()=>o.dismiss({id:"ds-reject-sr"}),onShow:()=>{document.querySelector(".reject-yes-button").focus()},onSubmit:async({action:t})=>{switch(t.id){case"yes":try{await i.reject.series(e.StudyInstanceUID,e.SeriesInstanceUID),r.deleteDisplaySet(I),o.dismiss({id:"ds-reject-sr"}),l.show({title:"Delete Report",message:"Report deleted successfully",type:"success"})}catch(e){o.dismiss({id:"ds-reject-sr"}),l.show({title:"Delete Report",message:"Failed to delete report",type:"error"})}break;case"cancel":o.dismiss({id:"ds-reject-sr"})}}}})}):f.canReject=!1),y.push(f)})),[...d,...m]}const S=["SR","SEG","RTSTRUCT","RTPLAN","RTDOSE"];const p=function(e,t){return new Promise(((a,s)=>{const n=document.createElement("canvas");e.utilities.loadImageToCanvas({canvas:n,imageId:t}).then((()=>{a(n.toDataURL())})).catch(s)}))};const h=function(e,t,a,s){t.activeDisplaySets.some((e=>e.StudyInstanceUID===a))||e.retrieve.series.metadata({StudyInstanceUID:a,madeInClient:s})};function y(e){const t=e.getModuleEntry("@ohif/extension-cornerstone.utilityModule.common");try{const{cornerstone:e}=t.exports.getCornerstoneLibraries();return p.bind(null,e)}catch(e){throw new Error("Required command not found")}}function I(e,t){const a=e.getModuleEntry("@ohif/extension-default.utilityModule.common"),{getStudiesForPatientByMRN:s}=a.exports;return s.bind(null,t)}function f(e){return h.bind(null,e)}const{createGetImageSrcFromImageIdFn:E,createRequestDisplaySetcreationFn:v,getStudyForPatientUtility:D}=s;function b({commandsManager:e,extensionManager:t,servicesManager:a}){const s=t.getActiveDataSource()[0],i=D(t,s),r=E(t),o=v(s);return n.createElement(m,{MeasurementService:a.services.MeasurementService,DisplaySetService:a.services.DisplaySetService,UIDialogService:a.services.UIDialogService,UINotificationService:a.services.UINotificationService,dataSource:s,getImageSrc:r,getStudiesForPatientByMRN:i,requestDisplaySetCreationForStudy:o})}b.propTypes={commandsManager:r().object.isRequired,extensionManager:r().object.isRequired,servicesManager:r().object.isRequired};const w=b;const{downloadCSVReport:U}=o.utils,{formatDate:M}=o.utils,R={key:void 0,date:void 0,modality:void 0,description:void 0};function T({servicesManager:e,extensionManager:t}){const[a,s]=(0,c.O_)(),[i,r]=(0,n.useState)(Date.now().toString()),l=function(e,t){const[a,s]=(0,n.useState)(e);return(0,n.useEffect)((()=>{const a=setTimeout((()=>{s(e)}),t);return()=>{clearTimeout(a)}}),[e,t]),a}(i,200),{MeasurementService:u,UIDialogService:d,DisplaySetService:m}=e.services,[g,S]=(0,n.useState)(R),[p,h]=(0,n.useState)([]);(0,n.useEffect)((()=>{const e=u.getMeasurements().map((e=>function(e,t,a){const{referenceStudyUID:s,referenceSeriesUID:n,SOPInstanceUID:i}=e,r=(o.DicomMetadataStore.getInstance(s,n,i),a.getDisplaySetsForSeries(n));if(!r[0]||!r[0].images)throw new Error('The tracked measurements panel should only be tracking "stack" displaySets.');const{displayText:c}=e;return{uid:e.uid,label:e.label||"(empty)",measurementType:e.type,displayText:c||[],isActive:!1}}(e,u.VALUE_TYPES,m)));h(e)}),[u,l]),(0,n.useEffect)((()=>{S(R)}),[g.key]),(0,n.useEffect)((()=>{const e=u.EVENTS.MEASUREMENT_ADDED,t=u.EVENTS.RAW_MEASUREMENT_ADDED,a=u.EVENTS.MEASUREMENT_UPDATED,s=u.EVENTS.MEASUREMENT_REMOVED,n=u.EVENTS.MEASUREMENTS_CLEARED,i=[];return[e,t,a,s,n].forEach((e=>{i.push(u.subscribe(e,(()=>{r(Date.now().toString())})).unsubscribe)})),()=>{i.forEach((e=>{e()}))}}),[u]);const y=({uid:e,isActive:t})=>{u.jumpToMeasurement(a.activeViewportId,e),I({uid:e,isActive:t})},I=({uid:e,isActive:t})=>{if(!t){const t=[...p],a=t.find((t=>t.uid===e));t.forEach((t=>t.isActive=t.uid===e)),a.isActive=!0,h(t)}},f=({uid:e})=>{u.remove(e)},E=p.filter((e=>e.measurementType!==u.VALUE_TYPES.POINT)),v=p.filter((e=>e.measurementType===u.VALUE_TYPES.POINT));return n.createElement(n.Fragment,null,n.createElement("div",{className:"overflow-x-hidden overflow-y-auto invisible-scrollbar","data-cy":"trackedMeasurements-panel"},g.key&&n.createElement(c.YL,{date:M(g.date),modality:g.modality,description:g.description}),n.createElement(c.wt,{title:"Measurements",amount:E.length,data:E,onClick:y,onEdit:({uid:e,isActive:t})=>{const a=u.getMeasurement(e);y({uid:e,isActive:t});const s=({action:t,value:s})=>{if("save"===t.id)u.update(e,{...a,...s},!0);d.dismiss({id:"enter-annotation"})};d.create({id:"enter-annotation",centralize:!0,isDraggable:!1,showOverlay:!0,content:c.Vq,contentProps:{title:"Enter your annotation",noCloseButton:!0,value:{label:a.label||""},body:({value:e,setValue:t})=>n.createElement("div",{className:"p-4 bg-primary-dark"},n.createElement(c.II,{autoFocus:!0,className:"mt-2 bg-black border-primary-main",type:"text",containerClassName:"mr-2",value:e.label,onChange:e=>{e.persist(),t((t=>({...t,label:e.target.value})))},onKeyPress:t=>{"Enter"===t.key&&s({value:e,action:{id:"save"}})}})),actions:[{id:"cancel",text:"Cancel",type:"primary"},{id:"save",text:"Save",type:"secondary"}],onSubmit:s}})},onDelete:f}),0!==v.length&&n.createElement(c.wt,{title:"Additional Findings",amount:v.length,data:v,onClick:y,onDelete:f})))}T.propTypes={servicesManager:r().shape({services:r().shape({MeasurementService:r().shape({getMeasurements:r().func.isRequired,VALUE_TYPES:r().object.isRequired}).isRequired}).isRequired}).isRequired};const N=T;var P=a(63403),x=a(14446),A=a(36605),C=a(47706);function O({formIndex:e,name:t,value:a,defaultValue:s,options:i,onChange:r}){const{labels:o,precision:c,max:l}=i,u=e=>{if(null==e)return null;const t=Object.keys(o).map(((e,t)=>({key:e,value:o[e].value}))).find((t=>t.value==e));return t?Number(t.key):null},[d,m]=n.useState(u(null!==a?a:s)),[g,S]=n.useState(-1);return n.createElement(x.ZP,{className:"p-2"},n.createElement("div",null,n.createElement(C.ZP,{sx:{fontSize:14},color:"text.secondary",gutterBottom:!0},t),n.createElement(C.ZP,{variant:"h6",component:"div"},null!==d||-1!==g?o[-1!==g?g:d].value:"?"),n.createElement(C.ZP,{variant:"body2"},null!==d||-1!==g?o[-1!==g?g:d].description:"Please Select")),n.createElement(P.ZP,{name:"hover-feedback",value:d,precision:c,max:l,onChange:(t,a)=>{r({formIndex:e,value:a?o[a].value:a}),m(a)},onChangeActive:(e,t)=>{S(t)},emptyIcon:n.createElement(A.Z,{style:{opacity:.55},fontSize:"inherit"})}))}var V=a(60792),_=a(65877),F=a(69985);function q({formIndex:e,name:t,value:a,defaultValue:s,options:i,onChange:r}){const{labels:o,cols:c}=i,[l,u]=n.useState(null!==a?a:s);return n.useEffect((()=>{u(null!==a?a:s)}),[a]),n.createElement(x.ZP,{className:"p-2"},n.createElement("div",null,n.createElement(C.ZP,{sx:{fontSize:14},color:"text.secondary",gutterBottom:!0},t),n.createElement(C.ZP,{variant:"body2",component:"div"},Boolean(o.find((e=>e.value==l)))?o.find((e=>e.value==l)).description:"?")),o.reduce(((e,t,a)=>{const s=Math.floor(a/(c||3));return e[s]=[].concat(e[s]||[],t),e}),[]).map(((t,a)=>n.createElement(V.Z,{row:!0,key:a,name:"grid-select-row",value:l,onChange:(t,a)=>{r({formIndex:e,value:a}),u(a)}},t.map(((e,t)=>n.createElement(_.ZP,{key:t,value:e.value,control:n.createElement(F.ZP,null),label:e.value})))))))}var L=a(47180),k=a(50417);function G({formIndex:e,name:t,value:a,defaultValue:s,options:i,onChange:r}){let o;return null!==a?o=Boolean(a):(o=Boolean(s),r({formIndex:e,value:o})),n.createElement(x.ZP,{className:"p-2"},n.createElement(L.ZP,null,n.createElement(_.ZP,{control:n.createElement(k.ZP,{checked:o,onChange:t=>r({formIndex:e,value:t.target.checked})}),label:n.createElement(C.ZP,{variant:"body2",color:"textSecondary"},t)})))}var H=a(85985),j=a(8324),$=a.n(j);function B({formIndex:e,name:t,value:a,defaultValue:s,options:i,onChange:r}){const[o,c]=(0,n.useState)(a??s??""),{rows:l}=i,u=(0,n.useMemo)((()=>$()(((e,t)=>{r({formIndex:e,value:t})}),600)),[r]);(0,n.useEffect)((()=>{c(a??s??"")}),[a,s]);return n.createElement(x.ZP,{className:"p-2"},n.createElement(H.ZP,{id:"outlined-multiline-flexible",inputProps:{style:{fontSize:"0.75em"}},label:t,multiline:!0,rows:l,value:o,fullWidth:!0,margin:"dense",size:"small",onChange:t=>{c(t.target.value),u(e,t.target.value)}}))}function Z({formIndex:e,name:t,value:a,defaultValue:s,options:i}){return n.createElement(x.ZP,{sx:{display:"flex"},className:"p-2"},n.createElement(C.ZP,{sx:{fontSize:14,marginRight:1},color:"text.secondary",gutterBottom:!0},t,":"),n.createElement(C.ZP,{variant:"body2",className:"overflow-auto invisible-scrollbar"},null!==a?a.toString():null!==s?s.toString():""))}var z=a(15471),W=a(98925);function Y({value:e}){const t=e=>{const[t,a,s]=(n=Date.now()-e,i=864e5,r=36e5,o=Math.floor(n/i),c=Math.floor((n-o*i)/r),60===(l=Math.round((n-o*i-c*r)/6e4))&&(c++,l=0),24===c&&(o++,c=0),[o,c,l]);var n,i,r,o,c,l;return t>7?new Date(e).toLocaleDateString("en-us",{year:"numeric",month:"short",day:"numeric"}):t>2?`${t} days ago`:a>2?`${a} hours ago`:s>2?`${s} mins ago`:"just now"};try{e=JSON.parse(e)}catch(t){console.error(t,e),e=null}return e?n.createElement(x.ZP,null,n.createElement(z.ZP,{sx:{"& .MuiCardHeader-content":{overflow:"hidden"}},avatar:n.createElement(W.ZP,{imgProps:{crossOrigin:"anonymous",referrerPolicy:"no-referrer"},src:e.picture}),title:e.email,subheader:`Updated ${t(e.lastUpdated)}`})):n.createElement(x.ZP,null,n.createElement(z.ZP,{sx:{"& .MuiCardHeader-content":{overflow:"hidden"}},avatar:n.createElement(W.ZP,null),title:"----",subheader:"No last update"}))}const K=function({formTemplate:e,formValue:t,setFormValue:a}){const s=({formIndex:e,value:s})=>{const n=[...t];n[e]=s,a([...n])};if(e){const a=e.map(((e,a)=>{switch(e.type){case"checkbox":return n.createElement("div",{key:a,className:"p-2 bg-primary-dark"},n.createElement(G,{formIndex:a,name:e.name,options:e.template,defaultValue:e.defaultValue,value:t[a],onChange:s}));case"rating":return n.createElement("div",{key:a,className:"p-2 bg-primary-dark"},n.createElement(O,{formIndex:a,name:e.name,options:e.template,defaultValue:e.defaultValue,value:t[a],onChange:s}));case"grid":return n.createElement("div",{key:a,className:"p-2 bg-primary-dark"},n.createElement(q,{formIndex:a,name:e.name,options:e.template,defaultValue:e.defaultValue,value:t[a],onChange:s}));case"textarea":return n.createElement("div",{key:a,className:"p-2 bg-primary-dark"},n.createElement(B,{formIndex:a,name:e.name,options:e.template,defaultValue:e.defaultValue,value:t[a],onChange:s}));case"user_profile":return n.createElement("div",{key:a,className:"p-2 bg-primary-dark"},n.createElement(Y,{value:t[a]}));default:return n.createElement("div",{key:a,className:"p-2 bg-primary-dark"},n.createElement(Z,{formIndex:a,name:e.name,options:e.template,defaultValue:e.defaultValue,value:t[a]}))}}));return n.createElement("div",null,a)}return null};var Q=a(3366),J=a(58041),X=a(46258),ee=a(32122),te=a(55545);function ae({servicesManager:e,extensionManager:t}){const{GoogleSheetsService:a}=e.services,[s,i]=(0,n.useState)(a.getFormTemplate()),[r,o]=(0,n.useState)(a.getFormValue()),[c,l]=(0,n.useState)(!1),[u,d]=(0,n.useState)(!0),[m,g]=(0,n.useState)(!Boolean(r&&s)),[S,p]=(0,n.useState)(!1),h=()=>a.getRow(1),y=()=>a.getRow(-1),I=(0,n.useMemo)((()=>$()(h,300)),[]),f=(0,n.useMemo)((()=>$()(y,300)),[]);return(0,n.useEffect)((()=>{const e=[];return e.push(a.subscribe(a.EVENTS.GOOGLE_SHEETS_CHANGE,(()=>{d(!0),o(a.getFormValue()),i(a.getFormTemplate()),g(!1)})).unsubscribe),e.push(a.subscribe(a.EVENTS.GOOGLE_SHEETS_ERROR,(()=>{l(!0)})).unsubscribe),()=>{e.forEach((e=>e()))}}),[a]),(0,n.useEffect)((()=>{u||(p(!0),a.updateRow(r).then((e=>{p(!1)}))),d(!1)}),[r]),c?n.createElement(x.ZP,{sx:{display:"flex"},className:"p-2"},n.createElement(C.ZP,{sx:{fontSize:14,marginRight:1},color:"text.secondary",gutterBottom:!0},"There was an error connecting to Google Sheets.")):m?n.createElement(Q.ZP,null):n.createElement(n.Fragment,null,n.createElement("div",{style:{color:"white",overflow:"auto"}},S?n.createElement(Q.ZP,null):n.createElement("div",{style:{height:"4px"}}),n.createElement(K,{formTemplate:s,formValue:r,setFormValue:o})),n.createElement("div",{className:"flex justify-center p-4"},n.createElement(x.ZP,null,n.createElement(te.ZP,{variant:"contained","aria-label":"outlined primary button group"},n.createElement(J.ZP,{loading:S,loadingPosition:"start",startIcon:n.createElement(ee.Z,null),variant:"contained",color:"primary",onClick:f},"Prev"),n.createElement(J.ZP,{loading:S,loadingPosition:"end",endIcon:n.createElement(X.Z,null),variant:"contained",color:"primary",onClick:I},"Next")))))}ae.propTypes={servicesManager:r().shape({services:r().shape({}).isRequired}).isRequired};const se=ae;var ne=a(73289);function ie({servicesManager:e,extensionManager:t}){return n.createElement(n.Fragment,null,n.createElement("div",{style:{height:"150px",overflowY:"auto"}},n.createElement(N,{servicesManager:e,extensionManager:t})),n.createElement("div",{className:"m-2"},n.createElement(ne.ZP,{style:{background:"white"}})),n.createElement(se,{servicesManager:e,extensionManager:t}))}ie.propTypes={servicesManager:r().shape({services:r().shape({}).isRequired}).isRequired};const re=ie,{sortStudyInstances:oe,formatDate:ce}=o.utils;function le({servicesManager:e,getImageSrc:t,getStudiesForPatientByMRN:a,requestDisplaySetCreationForStudy:s,dataSource:i}){const{hangingProtocolService:r,displaySetService:o,uiNotificationService:u,GoogleSheetsService:d}=e.services,m=(0,l.s0)(),{StudyInstanceUIDs:g}=(0,c.zG)(),[S,p]=(0,n.useState)([...g]),[{activeViewportId:h,viewports:y},I]=(0,c.O_)(),[f,E]=(0,n.useState)("primary"),[v,D]=(0,n.useState)([...S]),[b,w]=(0,n.useState)([]),[U,M]=(0,n.useState)([]),[R,T]=(0,n.useState)({});(0,n.useEffect)((()=>{p([...g]),D([...g])}),[g]),(0,n.useEffect)((()=>{S.forEach((e=>async function(e){const t=await i.query.studies.search({studyInstanceUid:e});if(!t?.length)throw m("/notfoundstudy","_self"),new Error("Invalid study URL");let s=t;try{s=await a(t)}catch(e){console.warn(e)}const n=s.map((e=>({AccessionNumber:e.accession,StudyDate:e.date,StudyDescription:e.description,NumInstances:e.instances,ModalitiesInStudy:e.modalities,PatientID:e.mrn,PatientName:e.patientName,StudyInstanceUID:e.studyInstanceUid,StudyTime:e.time}))).map((e=>({studyInstanceUid:e.StudyInstanceUID,date:ce(e.StudyDate),description:e.StudyDescription,modalities:e.ModalitiesInStudy,numInstances:e.NumInstances})));w((e=>{const t=[...e];for(const a of n)e.find((e=>e.studyInstanceUid===a.studyInstanceUid))||t.push(a);return t}))}(e)))}),[S,i,a,m]),(0,n.useEffect)((()=>{o.activeDisplaySets.forEach((async e=>{const a={},s=o.getDisplaySetByUID(e.displaySetInstanceUID),n=i.getImageIdsForDisplaySet(s),r=n[Math.floor(n.length/2)];r&&!s?.unsupported&&(a[e.displaySetInstanceUID]=await t(r),T((e=>({...e,...a}))))}))}),[S,i,o,t]),(0,n.useEffect)((()=>{const e=de(o.activeDisplaySets,R);oe(e),M(e)}),[S,R,o]),(0,n.useEffect)((()=>{const e=o.subscribe(o.EVENTS.DISPLAY_SETS_ADDED,(e=>{const{displaySetsAdded:a,options:s}=e;a.forEach((async e=>{const a={},s=o.getDisplaySetByUID(e.displaySetInstanceUID);if(s?.unsupported)return;const n=i.getImageIdsForDisplaySet(s),r=n[Math.floor(n.length/2)];r&&(a[e.displaySetInstanceUID]=await t(r,e.initialViewport),T((e=>({...e,...a}))))}))}));return()=>{e.unsubscribe()}}),[t,i,o]),(0,n.useEffect)((()=>{const e=o.subscribe(o.EVENTS.DISPLAY_SETS_CHANGED,(e=>{const t=de(e,R);M(t)})),t=o.subscribe(o.EVENTS.DISPLAY_SET_SERIES_METADATA_INVALIDATED,(()=>{const e=de(o.getActiveDisplaySets(),R);M(e)}));return()=>{e.unsubscribe(),t.unsubscribe()}}),[S,R,o]),(0,n.useEffect)((()=>{const{unsubscribe:e}=d.subscribe(d.EVENTS.GOOGLE_SHEETS_CHANGE,(()=>{const e=Object.entries(d.studyUIDToIndex).filter((([e,t])=>t===d.index))[0][0];S.includes(e)||(p([e]),D([e]))}));return()=>{e()}}));const N=function(e,t,a){const s=[],n=[],i=[];t.forEach((t=>{const r=a.filter((e=>e.StudyInstanceUID===t.studyInstanceUid)),o=Object.assign({},t,{displaySets:r});e.includes(t.studyInstanceUid)?s.push(o):(n.push(o),i.push(o))}));const r=[{name:"primary",label:"Primary",studies:s},{name:"recent",label:"Recent",studies:n},{name:"all",label:"All",studies:i}];return r}(S,b,U);const P=y.get(h)?.displaySetInstanceUIDs;return n.createElement(c.eX,{tabs:N,servicesManager:e,activeTabName:f,onDoubleClickThumbnail:e=>{let t=[];const a=h;try{t=r.getViewportsRequireUpdate(a,e)}catch(e){console.warn(e),u.show({title:"Thumbnail Double Click",message:"The selected display sets could not be added to the viewport.",type:"info",duration:3e3})}I.setDisplaySetsForViewports(t)},activeDisplaySetInstanceUIDs:P,expandedStudyInstanceUIDs:v,onClickStudy:function(e){const t=v.includes(e),a=t?[...v.filter((t=>t!==e))]:[...v,e];if(D(a),!t){s(o,e,!0)}},onClickTab:e=>{E(e)}})}le.propTypes={servicesManager:r().object.isRequired,dataSource:r().shape({getImageIdsForDisplaySet:r().func.isRequired}).isRequired,getImageSrc:r().func.isRequired,getStudiesForPatientByMRN:r().func.isRequired,requestDisplaySetCreationForStudy:r().func.isRequired};const ue=le;function de(e,t){const a=[],s=[];return e.filter((e=>!e.excludeFromThumbnailBrowser)).forEach((e=>{const n=t[e.displaySetInstanceUID],i=function(e){if(me.includes(e.Modality)||e?.unsupported)return"thumbnailNoImage";return"thumbnail"}(e);("thumbnail"===i?a:s).push({displaySetInstanceUID:e.displaySetInstanceUID,description:e.SeriesDescription||"",seriesNumber:e.SeriesNumber,modality:e.Modality,seriesDate:e.SeriesDate,seriesTime:e.SeriesTime,numInstances:e.numImageFrames,countIcon:e.countIcon,StudyInstanceUID:e.StudyInstanceUID,messages:e.messages,componentType:i,imageSrc:n,dragData:{type:"displayset",displaySetInstanceUID:e.displaySetInstanceUID},isHydratedForDerivedDisplaySet:e.isHydrated})})),[...a,...s]}const me=["SR","SEG","SM","RTSTRUCT","RTPLAN","RTDOSE"];const{createGetImageSrcFromImageIdFn:ge,createRequestDisplaySetcreationFn:Se,getStudyForPatientUtility:pe}=s;function he({commandsManager:e,extensionManager:t,servicesManager:a}){const s=t.getDataSources()[0],i=pe(t,s),r=(0,n.useCallback)(ge(t),[]),o=Se(s);return n.createElement(ue,{servicesManager:a,dataSource:s,getImageSrc:r,getStudiesForPatientByMRN:i,requestDisplaySetCreationForStudy:o})}he.propTypes={commandsManager:r().object.isRequired,extensionManager:r().object.isRequired,servicesManager:r().object.isRequired};const ye=he;const Ie=function({commandsManager:e,extensionManager:t,servicesManager:a}){return[{name:"seriesList",iconName:"group-layers",iconLabel:"Studies",label:"Studies",component:w.bind(null,{commandsManager:e,extensionManager:t,servicesManager:a})},{name:"measurements",iconName:"list-bullets",iconLabel:"Measure",label:"Measurements",component:N.bind(null,{commandsManager:e,extensionManager:t,servicesManager:a})},{name:"form",iconName:"list-bullets",iconLabel:"Form",label:"Form",component:se.bind(null,{commandsManager:e,extensionManager:t,servicesManager:a})},{name:"form-and-measurements",iconName:"list-bullets",iconLabel:"Form",label:"Form",component:re.bind(null,{commandsManager:e,extensionManager:t,servicesManager:a})},{name:"seriesList-without-tracking",iconName:"group-layers",iconLabel:"Studies",label:"Studies",component:ye.bind(null,{commandsManager:e,extensionManager:t,servicesManager:a})}]};function fe(){return fe=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var a=arguments[t];for(var s in a)Object.prototype.hasOwnProperty.call(a,s)&&(e[s]=a[s])}return e},fe.apply(this,arguments)}const Ee=n.lazy((()=>Promise.all([a.e(816),a.e(515)]).then(a.bind(a,95515)))),ve=e=>n.createElement(n.Suspense,{fallback:n.createElement("div",null,"Loading...")},n.createElement(Ee,e));const De=function({servicesManager:e,commandsManager:t,extensionManager:a}){return[{name:"cornerstone-gradient",component:s=>n.createElement(ve,fe({servicesManager:e,commandsManager:t,extensionManager:a,disableViewportOrientationMarkers:!0},s))}]},be={id:"breast",locked:!0,hasUpdatedPriorsInformation:!1,name:"Breast",createdDate:"2021-02-23T19:22:08.894Z",modifiedDate:"2021-02-23T19:22:08.894Z",availableTo:{},editableBy:{},protocolMatchingRules:[],displaySetSelectors:{LMLO:{seriesMatchingRules:[{weight:5,attribute:"ImageLaterality",constraint:{contains:{value:"L"}},required:!1},{weight:5,attribute:"ViewCodeSequence",constraint:{contains:{value:"R-10226"}},required:!1}]},LCC:{seriesMatchingRules:[{weight:5,attribute:"ImageLaterality",constraint:{contains:{value:"L"}},required:!1},{weight:5,attribute:"ViewCodeSequence",constraint:{contains:{value:"R-10242"}},required:!1}]},RMLO:{seriesMatchingRules:[{weight:5,attribute:"ImageLaterality",constraint:{contains:{value:"R"}},required:!1},{weight:5,attribute:"ViewCodeSequence",constraint:{contains:{value:"R-10226"}},required:!1}]},RCC:{seriesMatchingRules:[{weight:5,attribute:"ImageLaterality",constraint:{contains:{value:"R"}},required:!1},{weight:5,attribute:"ViewCodeSequence",constraint:{contains:{value:"R-10242"}},required:!1}]}},toolGroupIds:["default"],stages:[{id:"breast-staging",name:"Breast Staging",viewportStructure:{type:"grid",properties:{rows:1,columns:4}},viewports:[{viewportOptions:{toolGroupId:"default"},displaySets:[{id:"RMLO"}]},{viewportOptions:{toolGroupId:"default"},displaySets:[{id:"LMLO"}]},{viewportOptions:{toolGroupId:"default"},displaySets:[{id:"RCC"}]},{viewportOptions:{toolGroupId:"default"},displaySets:[{id:"LCC"}]}],createdDate:"2021-02-23T18:32:42.850Z"}],numberOfPriorsReferenced:-1};const we=function(){return[{name:be.id,protocol:be}]};var Ue=a(67540),Me=a(95013);function Re({instance:e,frame:t,config:a,thumbnail:s=!1}){if(!e)return;if(e.url)return e.url;const n=s?"thumbnailRendering":"imageRendering";if(a[n]&&"wadouri"!==a[n])return function(e,t,a){const s=function(e,t,a){const s=function(e,t){const{StudyInstanceUID:a,SeriesInstanceUID:s,SOPInstanceUID:n}=e;return`${t.wadoRoot}/studies/${a}/series/${s}/instances/${n}`}(e,t);return`${s}/frames/${a=a||1}`}(e,t,a);if(s)return`wadors:${s}`}(e,a,t);{const s=function(e,t){const{StudyInstanceUID:a,SeriesInstanceUID:s,SOPInstanceUID:n}=t,i=[];i.push("requestType=WADO"),i.push(`studyUID=${a}`),i.push(`seriesUID=${s}`),i.push(`objectUID=${n}`),i.push("contentType=application/dicom"),i.push("transferSyntax=*");const r=i.join("&");return`${e.wadoUriRoot}?${r}`}(a,e);let n="dicomweb:"+s;return void 0!==t&&(n+="&frame="+t),n}}var Te=a(44379),Ne=a.n(Te);const Pe=o.classes.MetadataProvider,{datasetToBlob:xe}=Ue.default.data,Ae={studyInstanceUid:"StudyInstanceUID",patientId:"PatientID"};let Ce={urls:[],studyInstanceUIDMap:new Map};const Oe=e=>Ce.urls.find((t=>t.url===e)),Ve=(e,t)=>{let a=t?e.replace("https://storage.googleapis.com",`https://storage.googleapis.com/${t}`):e;return a=a.includes(":zip//")?a.replace(/^dicomweb:/,"dicomzip:"):a,a},_e=(e,t,a)=>{let s=e.map((e=>(e.instances=Ne().uniqBy(e.instances,(e=>e.url)),e)));Ne().isEmpty(a)||(s=s.filter((e=>a.includes(e.SeriesInstanceUID))));const n=Object.values(s.reduce(((e,t)=>{const a=t.StudyInstanceUID;return e[a]||(e[a]=[]),e[a].push(t),e}),{})).map((e=>{const a=e.reduce(((e,t)=>e+(parseInt(t.NumInstances)||0)),0),s=e.map((e=>({SeriesInstanceUID:e.SeriesInstanceUID,Modality:e.Modality,SeriesDescription:e.SeriesDescription||"No description",StudyInstanceUID:e.StudyInstanceUID,SeriesNumber:e.SeriesNumber,SeriesTime:e.SeriesTime,NumInstances:isNaN(parseInt(e.NumInstances))?0:parseInt(e.NumInstances),instances:e.instances.map((e=>({metadata:e.metadata,url:Ve(e.url,t)})))})));return{StudyInstanceUID:e[0].StudyInstanceUID,PatientName:e[0].PatientName,PatientSex:e[0].PatientSex,AccessionNumber:e[0].AccessionNumber,StudyDate:e[0].StudyDate,PatientID:e[0].PatientID,PatientWeight:e[0].PatientWeight,PatientAge:e[0].PatientAge,StudyDescription:e[0].StudyDescription||"No description",StudyTime:e[0].StudyTime,NumInstances:a,Modalities:`["${e[0].Modality}"]`,series:s}}));return{studies:n}},Fe=async({bucketName:e,prefix:t,studyuids:a,headers:s})=>{const n=a.map((async a=>{const n=`https://storage.googleapis.com/storage/v1/b/${e}/o?prefix=${`${t}/studies/${a}/series/`}&delimiter=/`,i=await fetch(n,{headers:s}),r=await i.json(),o=(r.items,(r.prefixes||[]).map((async t=>{const a=`https://storage.googleapis.com/storage/v1/b/${e}/o/${encodeURIComponent(`${t}metadata`)}?alt=media`;return(await fetch(a,{headers:s})).json()})));return Promise.all(o)}));return await Promise.all(n)},qe=(e,t)=>{let a=[];return Ce.urls.map((s=>{s.studies.map((s=>{s[e]===t&&a.push(s)}))})),a},Le=async(e,t)=>{const{StudyInstanceUID:a,SeriesInstanceUID:s,SOPInstanceUID:n,SeriesDescription:i}=e,r=new URLSearchParams(window.location.search),o=r.getAll("bucket"),c=o[1]||o[0]||"gradient-health-search-viewer-links",l=r.get("bucket-prefix")||"dicomweb",u=r.get("seg-bucket")||c,d=r.get("seg-prefix")||l,m=`${d}/studies/${a}/series/${s}/instances/${n}/${encodeURIComponent(i)}.dcm`,g=`https://storage.googleapis.com/upload/storage/v1/b/${u}/o?uploadType=media&name=${m}`,S=xe(e);await fetch(g,{method:"POST",headers:{...t,"Content-Type":"application/dicom"},body:S}).then((e=>e.json())).then((n=>{if(n.error)throw new Error(`${n.error.code}: ${n.error.message}`);const i=`dicomweb:https://storage.googleapis.com/${u}/${n.name}`;e.url=i;const r={Modality:(o=e).Modality,SeriesInstanceUID:o.SeriesInstanceUID,SeriesDescription:o.SeriesDescription,SeriesNumber:Number(o.SeriesNumber),SeriesDate:o.SeriesDate,StudyInstanceUID:o.StudyInstanceUID,instances:[{metadata:{FrameOfReferenceUID:o.FrameOfReferenceUID,SOPInstanceUID:o.SOPInstanceUID,SOPClassUID:o.SOPClassUID,ReferencedSeriesSequence:o.ReferencedSeriesSequence,SharedFunctionalGroupsSequence:o.SharedFunctionalGroupsSequence},url:o.url}]};var o;const c=Me.ZP.gzip(JSON.stringify(r));return fetch(`https://storage.googleapis.com/upload/storage/v1/b/${u}/o?uploadType=media&name=${d}/studies/${a}/series/${s}/metadata&contentEncoding=gzip`,{method:"POST",headers:{...t,"Content-Type":"application/json"},body:c}).then((e=>e.json())).then((e=>{if(e.error)throw new Error(`${e.error.code}: ${e.error.message}`)})).catch((e=>{throw new Error(e.message||"Failed to store DicomSeg metadata")}))})).catch((e=>{throw new Error(e.message||"Failed to store DicomSeg file")}))};let ke=null;function Ge(e,t){var{name:a,wadoRoot:s}=e;const n=e=>{ke=e,ke.name,ke.wadoRoot};n(e);const i={updateConfig:e=>{n(e)},initialize:async({params:e,query:a,url:s})=>{s||(s=a.get("url")),s||(s=a.toString(),a.set("url",s));let n=Oe(s);if(n)return n.studies.map((e=>e.StudyInstanceUID));const i=a.getAll("bucket");0===i.length&&i.push("gradient-health-search-viewer-links");const{UserAuthenticationService:r}=t.services,o=[];for(let e=0;e<i.length;e++){const t=await Fe({bucketName:i[e],prefix:a.get("bucket-prefix")||"dicomweb",studyuids:a.getAll("StudyInstanceUID"),headers:r.getAuthorizationHeader()});o.push(...t)}const c=_e(Ne().flatten(o),a.get("prefix"),a.getAll("SeriesInstanceUID"));let l,u;c.studies.forEach((e=>{l=e.StudyInstanceUID,e.series.forEach((e=>{u=e.SeriesInstanceUID,e.instances.forEach((e=>{const{url:t,metadata:a}=e;Pe.addImageIdToUIDs(t,{StudyInstanceUID:l,SeriesInstanceUID:u,SOPInstanceUID:a.SOPInstanceUID})}))}))})),Ce.urls.push({url:s,studies:[...c.studies]}),Ce.studyInstanceUIDMap.set(s,c.studies.map((e=>e.StudyInstanceUID)))},query:{studies:{mapParams:()=>{},search:async e=>{const[t,a]=Object.entries(e)[0],s=Ae[t];return qe(s,a).map((e=>({accession:e.AccessionNumber,date:e.StudyDate,description:e.StudyDescription,instances:e.NumInstances,modalities:e.Modalities,mrn:e.PatientID,patientName:e.PatientName,studyInstanceUid:e.StudyInstanceUID,NumInstances:e.NumInstances,time:e.StudyTime})))},processResults:()=>{console.debug(" DICOMJson QUERY processResults")}},series:{search:()=>{console.debug(" DICOMJson QUERY SERIES SEARCH")}},instances:{search:()=>{console.debug(" DICOMJson QUERY instances SEARCH")}}},retrieve:{directURL:e=>{console.debug("Not implemented",e)},series:{metadata:async({StudyInstanceUID:e,buckets:t=[],madeInClient:a=!1,customSort:s}={})=>{if(!e)throw new Error("Unable to query for SeriesMetadata without StudyInstanceUID");let n,r=qe("StudyInstanceUID",e)[0];if(!r){const a=new URLSearchParams(window.location.search);a.set("StudyInstanceUID",e),a.delete("bucket"),t.forEach((e=>{a.append("bucket",e)})),await i.initialize({query:a}),r=qe("StudyInstanceUID",e)[0]}n=s?s(r.series):r.series;const c=n.map((e=>{const t={StudyInstanceUID:r.StudyInstanceUID,...e};return delete t.instances,t}));o.DicomMetadataStore.addSeriesMetadata(c,a);const l=n.length;n.forEach(((t,s)=>{const n=t.instances.map((e=>{const a={...e.metadata,url:e.url,imageId:e.url,...t,...r};return delete a.instances,delete a.series,a}));var i;i=n,o.DicomMetadataStore.addInstances(i,a),s===l-1&&(o.DicomMetadataStore.getStudy(e,a).isLoaded=!0)}))}}},store:{dicom:async e=>{if("SEG"===e.Modality){const a=t.services.UserAuthenticationService.getAuthorizationHeader();try{await Le(e,a)}catch(e){throw e}}else console.debug(" DICOMJson store dicom")}},getImageIdsForDisplaySet(e){const t=e.images,a=[];return t?(e.images.forEach((e=>{const t=e.NumberOfFrames;if(t>1)for(let s=0;s<t;s++){const t=Re({instance:e,frame:s,config:ke});a.push(t)}else{const t=Re({instance:e,config:ke});a.push(t)}})),a):a},getImageIdsForInstance:({instance:e,frame:t})=>Re({instance:e,frame:t}),getStudyInstanceUIDs:({params:e,query:t})=>{const a=t.get("url");return Ce.studyInstanceUIDMap.get(a)}};return o.Is.create(i)}const He=function({servicesManager:e}){return[{name:"bq",type:"jsonApi",createDataSource:t=>Ge(t,e)}]},je=JSON.parse('{"u2":"@gradienthealth/ohif-gradienthealth-extension"}').u2;var $e=a(56388),Be=a(80135);const Ze=["A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z"];let ze=[...Ze];Ze.forEach((e=>{Ze.forEach((t=>{ze.push(e+t)}))}));const We=[...ze];const Ye={GOOGLE_SHEETS_CHANGE:"event::gradienthealth::GoogleSheets:FormChange",GOOGLE_SHEETS_ERROR:"event::gradienthealth::GoogleSheets:Error",GOOGLE_SHEETS_DESTROY:"event::gradienthealth::GoogleSheets:Destroy"},Ke=e=>{switch(e){case"TRUE":return!0;case"FALSE":return!1;case"YES":return!0;case"NO":return!1;case"":case void 0:return null}return e};class Qe{constructor(e,t,a){this.serviceManager=e,this.listeners={},this.api_key="AIzaSyDu5Rt54oHX1w3O5kZTARz7DClaxNjTpEs",this.EVENTS=Ye,this.sheetId=null,this.index=null,this.sheetName=null,this.formTemplate=null,this.formValue=null,this.settings=null,this.formHeader=null,this.rows=null,this.studyUIDToIndex={},this.extensionManager=a,this.DicomMetadataStore=o.DicomMetadataStore,Object.assign(this,o.KZ)}cacheNearbyStudyInstanceUIDs(e,t,a){const{CacheAPIService:s}=this.serviceManager.services,n=this.studyUIDToIndex[e],i=n-t<2?2:n-t,r=n+a,o=this.formHeader.findIndex((e=>"URL"==e));this.rows.slice(i-1,r).forEach((e=>{const t=e[o],a=new URLSearchParams("?"+t.split("?")[1]),n=Je(a);s.cacheStudy(n,a.getAll("bucket"))}))}setFormByStudyInstanceUID(e){const t=this.studyUIDToIndex[e];this.setFormByIndex(t),this.cacheNearbyStudyInstanceUIDs(e,2,32)}setFormByIndex(e){this.index=e;const t=this.rows[e-1];this.formValue=this.readFormValue(t),this._broadcastEvent(Ye.GOOGLE_SHEETS_CHANGE)}async init(){try{const{UserAuthenticationService:e}=this.serviceManager.services;this.user=e.getUser();const t=new URLSearchParams(window.location.search);if(window.location.pathname.startsWith("/segmentation")&&$e.eventTarget.addEventListener($e.Enums.Events.STACK_VIEWPORT_NEW_STACK,(()=>function(e){const t=new URLSearchParams(window.location.search),a=Je(t),s=["1.2.840.10008.5.1.4.1.1.66.4"],{segmentationService:n,displaySetService:i,UserAuthenticationService:r,CacheAPIService:o,viewportGridService:c}=e.services,l=r.getAuthorizationHeader(),u=i.getDisplaySetsBy((e=>e.StudyInstanceUID===a&&s.includes(e.SOPClassUID))),d=i.getDisplaySetsBy((e=>e.StudyInstanceUID===a&&!s.includes(e.SOPClassUID))).flatMap((e=>e.images.flatMap((e=>e.imageId))));if(function(e,t){const{segmentationService:a}=t.services;return e.every((e=>a.getSegmentation(e.displaySetInstanceUID)))}(u,e)){const e=[];return void u.forEach((t=>{n.getToolGroupIdsWithSegmentation(t.displaySetInstanceUID).forEach((t=>{e.includes(t)||(Be.utilities.segmentation.triggerSegmentationRender(t),e.push(t))}))}))}const m=()=>d.every((e=>$e.cache.getImageLoadObject(e)));let g;const S=async()=>{if(m()){const e=u.map((async e=>(e.getReferenceDisplaySet(),e.load({headers:l}))));await Promise.all(e);const t=u.map((async e=>await n.addSegmentationRepresentationToToolGroup("default",e.displaySetInstanceUID,!0)));Promise.all(t).then((()=>{const{viewports:e,activeViewportId:t}=c.getState(),a=e.get(t),s=i.getDisplaySetsBy((e=>e.referencedDisplaySetInstanceUID===a.displaySetInstanceUIDs[0]));n.setActiveSegmentationForToolGroup(s[0].displaySetInstanceUID)})),g?.()}};m()?S():({unsubscribe:g}=o.subscribe(o.EVENTS.IMAGE_CACHE_PREFETCHED,S))}(this.serviceManager))),!t.get("sheetId"))return this._broadcastEvent(Ye.GOOGLE_SHEETS_ERROR);if(!t.get("sheetName"))return this._broadcastEvent(Ye.GOOGLE_SHEETS_ERROR);this.sheetId=t.get("sheetId"),this.sheetName=t.get("sheetName"),this.settings=await this.readRange(1,6,this.sheetId,"Settings"),this.formHeader=(await this.readRange(1,1)).values[0],this.rows=(await this.readRange(1,1e5)).values,this.formHeader=this.rows[0];const a=this.formHeader.findIndex((e=>"URL"==e));this.studyUIDToIndex=this.rows.slice(1).reduce(((e,t,s)=>{const n=t[a];return e[Je(new URLSearchParams("?"+n.split("?")[1]))]=s+2,e}),{}),this.index=this.studyUIDToIndex[Je(t)];const s=this.settings.values[0].map(((e,t)=>this.settings.values.map((e=>e[t])))),n=s[0];this.formTemplate=s.slice(1,-1).map((e=>e.reduce(((e,t,a)=>{switch(t=Ke(t),n[a]){case"template":try{t&&(e[n[a]]=JSON.parse(t))}catch(e){console.warn(t,e)}break;case"order":e[n[a]]=Number(t);break;default:e[n[a]]=t}return e}),{}))).filter((e=>e.show)).sort(((e,t)=>e.order-t.order)),this.setFormByStudyInstanceUID(Je(t))}catch(e){console.error(e),this._broadcastEvent(Ye.GOOGLE_SHEETS_ERROR)}}readFormValue(e){return this.formTemplate.map((t=>{const a=this.formHeader.findIndex((e=>e==t.name));if(-1!==a)return Ke(e[a])}))}async readRange(e,t,a=this.sheetId,s=this.sheetName){const n=`https://sheets.googleapis.com/v4/spreadsheets/${a}/values/${s}!${`A${e}:ZZ${t}`}`,i=await fetch(n,{headers:{Authorization:"Bearer "+this.user.access_token}});return await i.json()}writeRange(e,t,a,s){return new Promise(((n,i)=>{let r=`https://sheets.googleapis.com/v4/spreadsheets/${e}/values/${t}!${a}?valueInputOption=USER_ENTERED`;var o=new XMLHttpRequest;o.open("PUT",r),o.setRequestHeader("Content-type","application/json"),o.setRequestHeader("Authorization","Bearer "+this.user.access_token),o.onload=()=>{200==o.status?n():i()},o.send(JSON.stringify({range:`${t}!${a}`,majorDimension:"ROWS",values:[s]}))}))}async updateRow(e){const t=this.formHeader.map((t=>{const a=this.formTemplate.findIndex((e=>t==e.name));if(a>0)return e[a];if("Updated By"===t){const e=this.serviceManager.services.UserAuthenticationService.getUser();return JSON.stringify({email:e.profile.email,picture:e.profile.picture,lastUpdated:Date.now()})}return null})),a=this.rows[this.index-1].map(((e,a)=>null!==t[a]?t[a]:e));return this.rows[this.index-1]=a,this.formValue=e,await this.writeRange(this.sheetId,this.sheetName,`A${this.index}:${We[this.formHeader.length-1]}${this.index}`,t),t}getFormTemplate(){return this.formTemplate?this.formTemplate:null}getFormValue(){return this.formValue?this.formValue:null}async getRow(e){try{const{DisplaySetService:t,HangingProtocolService:a,CacheAPIService:s,SegmentationService:n}=this.serviceManager.services,i=this.rows[this.index+e-1];i||(window.location.href=`https://docs.google.com/spreadsheets/d/${this.sheetId}`);const r=i[this.formHeader.findIndex((e=>"URL"==e))],c=new URLSearchParams("?"+r.split("?")[1]),l=Je(c),u=c.getAll("bucket");l||(window.location.href=`https://docs.google.com/spreadsheets/d/${this.sheetId}`);const d=this.extensionManager.getActiveDataSource()[0];await d.retrieve.series.metadata({StudyInstanceUID:l,buckets:u});const m=[o.DicomMetadataStore.getStudy(l)],g=a.getActiveProtocol().protocol.id;a.reset(),a.run({studies:m,activeStudy:m[0],displaySets:t.getActiveDisplaySets().filter((e=>e.StudyInstanceUID===l))},g);n.getSegmentations().forEach((e=>n.remove(e.id)));const S=new URLSearchParams(window.location.search);S.get("StudyInstanceUIDs")?S.set("StudyInstanceUIDs",l):S.set("StudyInstanceUID",l),S.delete("bucket"),u.forEach((e=>{S.append("bucket",e)}));const p=window.location.href.split("?")[0]+"?"+S.toString();window.history.replaceState({},null,p),this.setFormByStudyInstanceUID(l),s.setViewedStudy(l)}catch(e){console.error(e)}}destroy(){this.sheetId=null,this.index=null,this.sheetName=null,this.formTemplate=null,this.formValue=null,this._broadcastEvent(Ye.GOOGLE_SHEETS_ERROR)}}function Je(e){return e.get("StudyInstanceUIDs")||e.get("StudyInstanceUID")}var Xe=a(22239);const et={CROP_DISPLAY_AREA_INIT:"event::gradienthealth::CropDisplayAreaService:init"};class tt{constructor(e){this.serviceManager=void 0,this.listeners=void 0,this.EVENTS=void 0,this.serviceManager=e,this.listeners={},this.EVENTS=et,window.tf=Xe,Object.assign(this,o.KZ)}init(){$e.eventTarget.addEventListener($e.EVENTS.STACK_VIEWPORT_NEW_STACK,(e=>{const{HangingProtocolService:t}=this.serviceManager.services;"breast"===t.protocol.id&&this.handleBreastDensityHP(e)}))}handleBreastDensityHP(e){const{HangingProtocolService:t,cornerstoneViewportService:a}=this.serviceManager.services,{element:s,viewportId:n}=e.detail,i=(0,$e.getEnabledElement)(s),r=i?.viewport;if(!r)return;const{voiRange:o,invert:c}=r.getProperties();let l;if(o?.lower&&!c&&(l=o?.lower),o?.upper&&c&&(l=o?.upper),!l)return;const u=a.getViewportInfo(n),d=Array.from(t.displaySetMatchDetails.values()).findIndex((e=>e.displaySetInstanceUID===u.viewportData.data.displaySetInstanceUID)),m=Array.from(t.displaySetMatchDetails.keys())[d];if(!m)return;const g=r.getImageData(),S=g?.scalarData,p=g?.dimensions;if(!S||!p)return;const{bboxWidth:h,bboxHeight:y,width:I,height:f}=Xe.tidy((()=>{const e=Xe.tensor2d(new Float32Array(S),[p[1],p[0]]).greater(l),t=e.any(0),a=e.any(1),s=t.argMax(),n=t.reverse().argMax().mul(-1).add(t.size),i=a.argMax(),r=a.reverse().argMax().mul(-1).add(a.size);return{bboxWidth:n.sub(s).dataSync()[0],bboxHeight:r.sub(i).dataSync()[0],width:t.size,height:a.size}})),E=(r.sWidth,r.sHeight,h/I);"LMLO"===m&&r.setDisplayArea({imageArea:[E,E],imageCanvasPoint:{canvasPoint:[0,.5],imagePoint:[0,.5]},storeAsInitialCamera:!0},!0),"RMLO"===m&&r.setDisplayArea({imageArea:[E,E],imageCanvasPoint:{canvasPoint:[1,.5],imagePoint:[1,.5]},storeAsInitialCamera:!0},!0),"LCC"===m&&r.setDisplayArea({imageArea:[E,E],imageCanvasPoint:{canvasPoint:[0,.5],imagePoint:[0,.5]},storeAsInitialCamera:!0},!0),"RCC"===m&&r.setDisplayArea({imageArea:[E,E],imageCanvasPoint:{canvasPoint:[1,.5],imagePoint:[1,.5]},storeAsInitialCamera:!0},!0)}destroy(){}async focusToSegment(e,t){const{segmentationService:a,viewportGridService:s,cornerstoneViewportService:n,displaySetService:i}=this.serviceManager.services,r=a.getSegmentation(e),o=i.getDisplaySetByUID(r.displaySetInstanceUID);if("SEG"!==o.Modality)return;const c=r?.representationData[r.type].imageIdReferenceMap;let l,u;if(t=t||r.activeSegmentIndex,c){const e=$e.cache.getImage(c.values().next().value),{rows:t,columns:a}=e;l=[a,t,c.size],u=e.getPixelData()}else{const t=$e.cache.getVolume(e);({dimensions:l}=t),u=t.scalarData}const d=Xe.tidy((()=>{let e;return e=c?Xe.tensor2d(new Float32Array(u),[l[1],l[0]]):Xe.tensor3d(new Float32Array(u),[l[2],l[0],l[1]]),e.equal(t)})),m=await Xe.whereAsync(d),{xMax:g,yMax:S,xMin:p,yMin:h}=Xe.tidy((()=>{const e=Xe.einsum("ij->ji",m);Xe.dispose(d),Xe.dispose(m);let t=0,a=l[0],s=0,n=l[1];return 0!==e.size&&(c?(t=e.gather(1).min().dataSync()[0],a=e.gather(1).max().dataSync()[0],s=e.gather(0).min().dataSync()[0],n=e.gather(0).max().dataSync()[0]):(t=e.gather(2).min().dataSync()[0],a=e.gather(2).max().dataSync()[0],s=e.gather(1).min().dataSync()[0],n=e.gather(1).max().dataSync()[0])),{xMax:a,yMax:n,xMin:t,yMin:s}})),y=o.referencedDisplaySetInstanceUID,{viewports:I,activeViewportId:f}=s.getState(),E=[];I.forEach((e=>{e.displaySetInstanceUIDs.includes(y)&&E.push(n.getCornerstoneViewport(e.viewportId))}));let v=g+1-p,D=S+1-h,b=l[0],w=l[1];const U=b/w,M=[(g+p)/(2*b),(S+h)/(2*w)],R={x:v/b,y:D/w};if(E.forEach((e=>{const t=e.sWidth/e.sHeight,a={...R};nt(a,U,t),at(e,a,M)})),!E.length){const e=n.getCornerstoneViewport(f);st(e,i,R,M,U)}}}const at=(e,t,a)=>{e.setDisplayArea({imageArea:[t.x,t.y],imageCanvasPoint:{imagePoint:a,canvasPoint:[.5,.5]}}),e.render()},st=(e,t,a,s,n)=>{const i=e.sWidth/e.sHeight,r=e.type===$e.Enums.ViewportType.STACK?$e.eventTarget:e.element,o=e.type===$e.Enums.ViewportType.STACK?$e.EVENTS.STACK_VIEWPORT_NEW_STACK:$e.EVENTS.VOLUME_VIEWPORT_NEW_VOLUME,c=l=>{const u=((e=[],t)=>{const a=t.getDisplaySetsBy((t=>t.images?.find((t=>e.includes(t.imageId)))))?.[0],s=a.SeriesInstanceUID;return t.getDisplaySetsBy((e=>e.referencedSeriesInstanceUID===s))})(l.detail.imageIds,t);let d=0;const m=()=>{++d===u.length&&(nt(a,n,i),at(e,a,s),$e.eventTarget.removeEventListener(Be.Enums.Events.SEGMENTATION_RENDERED,m))};$e.eventTarget.addEventListener(Be.Enums.Events.SEGMENTATION_RENDERED,m),r.removeEventListener(o,c)};r.addEventListener(o,c)},nt=(e,t,a)=>{if(t<a&&(e.x/=a/t),t>a&&(e.y/=t/a),e.x>.8||e.y>.8)return;e.x/=.8,e.y/=.8};var it=a(41851);const{getOptions:rt}=it.internal,ot={IMAGE_CACHE_PREFETCHED:"event::gradienthealth::image_cache_prefetched"};class ct{constructor(e,t,a){this.listeners=void 0,this.EVENTS=void 0,this.element=void 0,this.servicesManager=void 0,this.commandsManager=void 0,this.extensionManager=void 0,this.dataSource=void 0,this.options=void 0,this.storageUsage=void 0,this.storageQuota=void 0,this.imageIdToFileUriMap=void 0,this.listeners={},this.EVENTS=ot,this.commandsManager=t,this.extensionManager=a,this.servicesManager=e,this.storageUsage=null,this.storageQuota=null,this.imageIdToFileUriMap=new Map,Object.assign(this,o.KZ)}init(){const e=this.extensionManager.getActiveDataSource();this.dataSource=e[0],$e.eventTarget.addEventListener("CORNERSTONE_CACHE_QUOTA_EXCEEDED_ERROR",this.handleQuotaExceededWriteError.bind(this)),window?.navigator?.storage?.estimate&&window?.navigator?.storage?.estimate().then((e=>{console.log("Storage use: ",1e-9*e.usage," of ",1e-9*e.quota," GB"),this.storageUsage=e.usage,this.storageQuota=e.quota})),window?.navigator?.storage?.persisted&&window?.navigator?.storage?.persist&&window?.navigator?.storage?.persisted().then((e=>{e?console.log("Storage will not be cleared except by explicit user action"):window?.navigator?.storage?.persist().then((e=>{e?console.log("Storage will not be cleared except by explicit user action"):console.log("Storage may be cleared by the UA under storage pressure.")}))}))}async setViewedStudy(e){await this.dataSource.retrieve.series.metadata({StudyInstanceUID:e});const t=o.DicomMetadataStore.getStudy(e).series.flatMap((e=>e.instances.flatMap((e=>e.imageId)))).map((e=>e.split(":").slice(1).join(":"))),a=rt().cache.getScope;Ne().uniq(t.map((e=>a({url:e})))).forEach((async e=>{const t=await caches.open(e);(await t.keys()).forEach((async e=>{const a=await t.match(e.url,{ignoreVary:!0,ignoreMethod:!0,ignoreSearch:!0});if(!a)return;const s=new Request(e.url,{headers:{"dicom-last-put-date":(new Date).toUTCString(),"dicom-last-viewed-date":(new Date).toUTCString(),"dicom-content-length":e.headers.get("dicom-content-length")}});a&&t.put(s,a)}))}))}async cacheStudy(e,t=void 0){const a=["1.2.840.10008.5.1.4.1.1.66.4"];await this.dataSource.retrieve.series.metadata({StudyInstanceUID:e,buckets:t});const s=o.DicomMetadataStore.getStudy(e).series.filter((e=>!a.includes(e.instances[0].SOPClassUID))).flatMap((e=>e.instances.flatMap((e=>e.imageId))));this.cacheImageIds(s),this.cacheSegFiles(e)}async cacheSeries(e,t){await this.dataSource.retrieve.series.metadata({StudyInstanceUID:e});const a=o.DicomMetadataStore.getStudy(e).series.filter((e=>e.SeriesInstanceUID===t)).flatMap((e=>e.instances.flatMap((e=>e.imageId))));this.cacheImageIds(a)}cacheImageIds(e){function t(e,t){return $e.imageLoader.loadAndCacheImage(e,t).then((e=>{this._broadcastEvent(this.EVENTS.IMAGE_CACHE_PREFETCHED,{imageLoadObject:e})}),(e=>{console.error(e)}))}const a=$e.Enums.RequestType.Prefetch,s={preScale:{enabled:!0},useRGBA:!0};e.forEach((e=>{const n={imageId:e};$e.imageLoadPoolManager.addRequest(t.bind(this,e,s),a,n,0)}))}cacheSegFiles(e){const t=["1.2.840.10008.5.1.4.1.1.66.4"],{displaySetService:a,userAuthenticationService:s}=this.servicesManager.services,n=o.DicomMetadataStore.getStudy(e),i=s.getAuthorizationHeader();n.series.forEach((e=>{const{SOPClassUID:s,SeriesInstanceUID:n,url:r}=e.instances[0];if(t.includes(s)){const{scheme:e,url:t}=it.wadouri.parseImageId(r);if("dicomzip"===e)return it.wadouri.loadZipRequest(t,r);const s=a.getDisplaySetsForSeries(n)[0];if(this.imageIdToFileUriMap.get(r)===s.instance.imageId)return;fetch(t,{headers:i}).then((e=>e.arrayBuffer())).then((e=>it.wadouri.fileManager.add(new Blob([e])))).then((e=>{this.imageIdToFileUriMap.set(r,e),s.instance.imageId=e,s.instance.getImageId=()=>e}))}}))}updateCachedFile(e,t){const{url:a,imageId:s}=t.instances[0],n=it.wadouri.fileManager.add(e);if(t.instance.imageId=n,t.instance.getImageId=()=>n,this.imageIdToFileUriMap.set(a,n),s?.startsWith("dicomfile:")){const{url:e}=it.wadouri.parseImageId(s);it.wadouri.fileManager.remove(e)}}async cacheMissingStudyImageIds(e){const t=(await window.caches.keys()).map((e=>e.split("studies/")[1].split("/")[0]));e.filter((e=>-1===t.indexOf(e))).forEach((e=>{this.cacheStudy(e)}))}async handleQuotaExceededWriteError(e){(await window.caches.keys()).forEach((async e=>{try{const t=await caches.open(e),a=await t.keys(),s=a[0].headers.get("dicom-last-viewed-date"),n=a[0].headers.get("dicom-last-put-date"),i=n?new Date(n):new Date,r=new Date;("undefined"!==s||r-i>7*864e5)&&window.caches.delete(e)}catch(e){console.error(e)}}))}destroy(){$e.eventTarget.removeEventListener("CORNERSTONE_CACHE_QUOTA_EXCEEDED_ERROR",this.handleQuotaExceededWriteError)}}const lt=e=>{const{segmentationService:t,displaySetService:a}=e.services;t.subscribe(t.EVENTS.SEGMENTATION_ADDED,(({segmentation:e})=>{let s=a.getDisplaySetByUID(e.displaySetInstanceUID);if("SEG"===s.Modality)return;const n=t.getSegmentations(!1).length,i=n>0?" "+n:"",r=s.SeriesDescription+" - Vessel"+i;e.label=r,t.addOrUpdateSegmentation(e,!1,!0)}))},ut={id:je,onModeEnter({servicesManager:e}){lt(e)},getDataSourcesModule:({servicesManager:e})=>He({servicesManager:e}),getHangingProtocolModule:we,getPanelModule:Ie,getViewportModule:De,preRegistration({servicesManager:e,commandsManager:t,extensionManager:a}){var s;e.registerService(function(e,t,a){return{name:"GoogleSheetsService",create:({configuration:s={}})=>new Qe(e,t,a)}}(e,t,a)),e.registerService((s=e,{name:"CropDisplayAreaService",create:({configuration:e={}})=>new tt(s)})),e.registerService(function(e,t,a){return{name:"CacheAPIService",create:({configuration:s={}})=>new ct(e,t,a)}}(e,t,a));const{HangingProtocolService:n}=e.services;n.addCustomAttribute("ViewCodeSequence","ViewCodeSequence",(e=>(e.ViewCodeSequence??((e.images||e.others||[])[0]||{}).ViewCodeSequence)[0].CodeValue))}}},88658:()=>{},7189:()=>{},89891:()=>{},56064:()=>{},88218:()=>{}}]);
//# sourceMappingURL=8.bundle.c45e5ac6f18ca0d4407b.js.map