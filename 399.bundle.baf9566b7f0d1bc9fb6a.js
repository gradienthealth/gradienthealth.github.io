/*! For license information please see 399.bundle.baf9566b7f0d1bc9fb6a.js.LICENSE.txt */
(self.webpackChunk=self.webpackChunk||[]).push([[399,513],{48228:(e,t,n)=>{"use strict";n.r(t),n.d(t,{default:()=>O,hydrateSEGDisplaySet:()=>D.Z});const r=JSON.parse('{"u2":"@ohif/extension-cornerstone-dicom-seg"}').u2,i=`${r}.sopClassHandlerModule.dicom-seg`;var s=n(43001),o=n(78695),a=n(10740),c=n(6154),u=n(67540);const l=["1.2.840.10008.5.1.4.1.1.66.4"];let d={};function p(e,t,n){const r=e[0],{StudyInstanceUID:s,SeriesInstanceUID:p,SOPInstanceUID:g,SeriesDescription:f,SeriesNumber:m,SeriesDate:h,SOPClassUID:S,wadoRoot:y,wadoUri:v,wadoUriRoot:b}=r,I={Modality:"SEG",loading:!1,isReconstructable:!0,displaySetInstanceUID:o.utils.guid(),SeriesDescription:f,SeriesNumber:m,SeriesDate:h,SOPInstanceUID:g,SeriesInstanceUID:p,StudyInstanceUID:s,SOPClassHandlerId:i,SOPClassUID:S,referencedImages:null,referencedSeriesInstanceUID:null,referencedDisplaySetInstanceUID:null,isDerivedDisplaySet:!0,isLoaded:!1,isHydrated:!1,segments:{},sopClassUids:l,instance:r,instances:[r],wadoRoot:y,wadoUriRoot:b,wadoUri:v,isOverlayDisplaySet:!0},E=r.ReferencedSeriesSequence;if(!E)throw new Error("ReferencedSeriesSequence is missing for the SEG");const D=E[0];return I.referencedImages=r.ReferencedSeriesSequence.ReferencedInstanceSequence,I.referencedSeriesInstanceUID=D.SeriesInstanceUID,I.getReferenceDisplaySet=()=>{const{displaySetService:e}=t.services,n=e.getDisplaySetsForSeries(I.referencedSeriesInstanceUID);if(!n||0===n.length)throw new Error("Referenced DisplaySet is missing for the SEG");const r=n[0];I.referencedDisplaySetInstanceUID=r.displaySetInstanceUID,I.referencedVolumeURI=r.displaySetInstanceUID;const i=`cornerstoneStreamingImageVolume:${I.referencedVolumeURI}`;return I.referencedVolumeId=i,r},I.load=async e=>{let{headers:r}=e;return await function(e,t,n,r){const{SOPInstanceUID:i}=e,{segmentationService:s}=t.services;if((e.loading||e.isLoaded)&&d[i]&&function(e,t){return t.getSegmentation(e.displaySetInstanceUID)}(e,s))return d[i];return e.loading=!0,d[i]=new Promise((async(i,o)=>{e.segments&&0!==Object.keys(e.segments).length||await async function(e){let{extensionManager:t,servicesManager:n,segDisplaySet:r,headers:i}=e;const s=t.getModuleEntry("@ohif/extension-cornerstone.utilityModule.common"),{segmentationService:o}=n.services,{dicomLoaderService:l}=s.exports,d=await l.findDicomDataPromise(r,null,i),p=a.cache.getVolume(r.referencedVolumeId);if(!p)throw new Error("Referenced Volume is missing for the SEG, and stack viewport SEG is not supported yet");const{imageIds:g}=p,f=.001,m=!0;a.eventTarget.addEventListener(c.Yb.Events.SEGMENTATION_LOAD_PROGRESS,(e=>{const{percentComplete:t}=e.detail;o._broadcastEvent(o.EVENTS.SEGMENT_LOADING_COMPLETE,{percentComplete:t})}));const h=await c.ok.Cornerstone3D.Segmentation.generateToolState(g,d,a.metaData,{skipOverlapping:m,tolerance:f,eventTarget:a.eventTarget,triggerEvent:a.triggerEvent});h.segMetadata.data.forEach(((e,t)=>{var n;t>0&&(e.rgba=(n=e.RecommendedDisplayCIELabValue,u.default.data.Colors.dicomlab2RGB(n).map((e=>Math.round(255*e)))))})),Object.assign(r,h)}({extensionManager:n,servicesManager:t,segDisplaySet:e,headers:r});const l=!0;s.createSegmentationForSEGDisplaySet(e,null,l).then((()=>{e.loading=!1,i()})).catch((t=>{e.loading=!1,o(t)}))})),d[i]}(I,t,n,r)},[I]}const g=function(e){let{servicesManager:t,extensionManager:n}=e;return[{name:"dicom-seg",sopClassUids:l,getDisplaySetsFromSeries:e=>p(e,t,n)}]};var f=n(3827),m=n.n(f),h=n(98466);const S=function(e,t,n){const r="enter-segment-label",i=t=>{let{action:i,value:s}=t;switch(i.id){case"save":n(s.label,i.id);break;case"cancel":n("",i.id)}e.dismiss({id:r})};e&&e.create({id:r,centralize:!0,isDraggable:!1,showOverlay:!0,content:h.Vq,contentProps:{title:"Segment",value:{label:t},noCloseButton:!0,onClose:()=>e.dismiss({id:r}),actions:[{id:"cancel",text:"Cancel",type:h.LZ.U.secondary},{id:"save",text:"Confirm",type:h.LZ.U.primary}],onSubmit:i,body:e=>{let{value:t,setValue:n}=e;return s.createElement(h.II,{label:"Enter the segment label",labelClassName:"text-white text-[14px] leading-[1.2]",autoFocus:!0,className:"border-primary-main bg-black",type:"text",value:t.label,onChange:e=>{e.persist(),n((t=>({...t,label:e.target.value})))},onKeyPress:e=>{"Enter"===e.key&&i({value:t,action:{id:"save"}})}})}}})};var y=n(62657),v=n(69190);function b(e){let{servicesManager:t,commandsManager:n}=e;const{segmentationService:r,uiDialogService:i}=t.services,[o]=(0,y.M)(),a=o?.disableEditing,{t:c}=(0,v.$G)("PanelSegmentation"),[u,l]=(0,s.useState)(null),[d,p]=(0,s.useState)(r.getConfiguration()),[g,f]=(0,s.useState)((()=>r.getSegmentations())),[m,b]=(0,s.useState)({}),I=(0,s.useCallback)((e=>{b((t=>({...t,[e]:!t[e]})))}),[b]);(0,s.useEffect)((()=>{const e=g[g.length-1]?.id;e&&b((t=>({...t,[e]:!1})))}),[g,b]),(0,s.useEffect)((()=>{const e=r.EVENTS.SEGMENTATION_ADDED,t=r.EVENTS.SEGMENTATION_UPDATED,n=r.EVENTS.SEGMENTATION_REMOVED,i=[];return[e,t,n].forEach((e=>{const{unsubscribe:t}=r.subscribe(e,(()=>{const e=r.getSegmentations();f(e),p(r.getConfiguration())}));i.push(t)})),()=>{i.forEach((e=>{e()}))}}),[]);const E=e=>r.getToolGroupIdsWithSegmentation(e),D=(0,s.useCallback)(((e,t,n)=>{r.setConfiguration({segmentationId:e,[t]:n})}),[r]);return s.createElement("div",{className:"mt-1 flex min-h-0 flex-auto flex-col justify-between"},g?.length?s.createElement(h.cX,{title:c("Segmentations"),showAddSegmentation:!1,segmentations:g,isMinimized:m,activeSegmentationId:u||"",onSegmentationClick:e=>{r.setActiveSegmentationForToolGroup(e)},onSegmentationDelete:e=>{r.remove(e)},onSegmentationEdit:e=>{const t=r.getSegmentation(e),{label:n}=t;S(i,n,((t,n)=>{""!==t&&r.addOrUpdateSegmentation({id:e,label:t},!1,!0)}))},onSegmentClick:(e,t)=>{r.setActiveSegmentForSegmentation(e,t);E(e).forEach((n=>{r.setActiveSegmentationForToolGroup(e,n),r.jumpToSegmentCenter(e,t,n)}))},onSegmentEdit:(e,t)=>{const n=r.getSegmentation(e).segments[t],{label:s}=n;S(i,s,((n,i)=>{""!==n&&r.setSegmentLabelForSegmentation(e,t,n)}))},disableEditing:a,onSegmentColorClick:(e,t)=>{},onSegmentDelete:(e,t)=>{console.warn("not implemented yet")},onToggleSegmentVisibility:(e,t)=>{const n=!r.getSegmentation(e).segments[t].isVisible;E(e).forEach((i=>{r.setSegmentVisibility(e,t,n,i)}))},onToggleSegmentationVisibility:e=>{r.toggleSegmentationVisibility(e)},onToggleMinimizeSegmentation:I,segmentationConfig:{initialConfig:d},setRenderOutline:e=>D(u,"renderOutline",e),setOutlineOpacityActive:e=>D(u,"outlineOpacity",e),setRenderFill:e=>D(u,"renderFill",e),setRenderInactiveSegmentations:e=>D(u,"renderInactiveSegmentations",e),setOutlineWidthActive:e=>D(u,"outlineWidthActive",e),setFillAlpha:e=>D(u,"fillAlpha",e),setFillAlphaInactive:e=>D(u,"fillAlphaInactive",e)}):null)}b.propTypes={commandsManager:m().shape({runCommand:m().func.isRequired}),servicesManager:m().shape({services:m().shape({segmentationService:m().shape({getSegmentation:m().func.isRequired,getSegmentations:m().func.isRequired,toggleSegmentationVisibility:m().func.isRequired,subscribe:m().func.isRequired,EVENTS:m().object.isRequired}).isRequired}).isRequired}).isRequired};const I={id:"@ohif/seg",name:"Segmentations",protocolMatchingRules:[],toolGroupIds:["default"],numberOfPriorsReferenced:0,defaultViewport:{viewportOptions:{viewportType:"stack",toolGroupId:"default",allowUnmatchedView:!0},displaySets:[{id:"segDisplaySetId",matchedDisplaySetsIndex:-1}]},displaySetSelectors:{segDisplaySetId:{seriesMatchingRules:[{attribute:"Modality",constraint:{equals:"SEG"}}]}},stages:[{name:"Segmentations",viewportStructure:{layoutType:"grid",properties:{rows:1,columns:1}},viewports:[{viewportOptions:{allowUnmatchedView:!0},displaySets:[{id:"segDisplaySetId"}]}]}]};const E=function(){return[{name:I.id,protocol:I}]};var D=n(28417);function w(){return w=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var r in n)Object.prototype.hasOwnProperty.call(n,r)&&(e[r]=n[r])}return e},w.apply(this,arguments)}const M=s.lazy((()=>n.e(451).then(n.bind(n,4451)))),j=e=>s.createElement(s.Suspense,{fallback:s.createElement("div",null,"Loading...")},s.createElement(M,e)),O={id:r,getPanelModule:e=>{let{servicesManager:t,commandsManager:n,extensionManager:r}=e;return[{name:"panelSegmentation",iconName:"tab-segmentation",iconLabel:"Segmentation",label:"Segmentation",component:()=>s.createElement(b,{commandsManager:n,servicesManager:t,extensionManager:r})}]},getViewportModule(e){let{servicesManager:t,extensionManager:n}=e;return[{name:"dicom-seg",component:e=>s.createElement(j,w({servicesManager:t,extensionManager:n,commandsManager},e))}]},getSopClassHandlerModule:g,getHangingProtocolModule:E}},28417:(e,t,n)=>{"use strict";n.d(t,{Z:()=>r});const r=async function(e){let{segDisplaySet:t,viewportId:n,servicesManager:r}=e;const{segmentationService:i,hangingProtocolService:s,viewportGridService:o}=r.services,a=t.referencedDisplaySetInstanceUID;let c=null;c=await i.createSegmentationForSEGDisplaySet(t,c,!1),i.hydrateSegmentation(t.displaySetInstanceUID);const{viewports:u}=o.getState(),l=s.getViewportsRequireUpdate(n,a);return u.forEach(((e,r)=>{if(n===r)return;i.shouldRenderSegmentation(e.displaySetInstanceUIDs,t.displaySetInstanceUID)&&l.push({viewportId:r,displaySetInstanceUIDs:e.displaySetInstanceUIDs,viewportOptions:{needsRerendering:!0,initialImageOptions:{preset:"middle"}}})})),o.setDisplaySetsForViewports(l),!0}},27318:e=>{"use strict";e.exports=function(e){for(var t=new Array(e),n=0;n<e;++n)t[n]=n;return t}},8516:e=>{e.exports=function(e){return null!=e&&null!=e.constructor&&"function"==typeof e.constructor.isBuffer&&e.constructor.isBuffer(e)}},87513:(e,t,n)=>{var r=n(27318),i=n(8516),s="undefined"!=typeof Float64Array;function o(e,t){return e[0]-t[0]}function a(){var e,t=this.stride,n=new Array(t.length);for(e=0;e<n.length;++e)n[e]=[Math.abs(t[e]),e];n.sort(o);var r=new Array(n.length);for(e=0;e<r.length;++e)r[e]=n[e][1];return r}function c(e,t){var n=["View",t,"d",e].join("");t<0&&(n="View_Nil"+e);var i="generic"===e;if(-1===t){var s="function "+n+"(a){this.data=a;};var proto="+n+".prototype;proto.dtype='"+e+"';proto.index=function(){return -1};proto.size=0;proto.dimension=-1;proto.shape=proto.stride=proto.order=[];proto.lo=proto.hi=proto.transpose=proto.step=function(){return new "+n+"(this.data);};proto.get=proto.set=function(){};proto.pick=function(){return null};return function construct_"+n+"(a){return new "+n+"(a);}";return new Function(s)()}if(0===t){s="function "+n+"(a,d) {this.data = a;this.offset = d};var proto="+n+".prototype;proto.dtype='"+e+"';proto.index=function(){return this.offset};proto.dimension=0;proto.size=1;proto.shape=proto.stride=proto.order=[];proto.lo=proto.hi=proto.transpose=proto.step=function "+n+"_copy() {return new "+n+"(this.data,this.offset)};proto.pick=function "+n+"_pick(){return TrivialArray(this.data);};proto.valueOf=proto.get=function "+n+"_get(){return "+(i?"this.data.get(this.offset)":"this.data[this.offset]")+"};proto.set=function "+n+"_set(v){return "+(i?"this.data.set(this.offset,v)":"this.data[this.offset]=v")+"};return function construct_"+n+"(a,b,c,d){return new "+n+"(a,d)}";return new Function("TrivialArray",s)(u[e][0])}s=["'use strict'"];var o=r(t),c=o.map((function(e){return"i"+e})),l="this.offset+"+o.map((function(e){return"this.stride["+e+"]*i"+e})).join("+"),d=o.map((function(e){return"b"+e})).join(","),p=o.map((function(e){return"c"+e})).join(",");s.push("function "+n+"(a,"+d+","+p+",d){this.data=a","this.shape=["+d+"]","this.stride=["+p+"]","this.offset=d|0}","var proto="+n+".prototype","proto.dtype='"+e+"'","proto.dimension="+t),s.push("Object.defineProperty(proto,'size',{get:function "+n+"_size(){return "+o.map((function(e){return"this.shape["+e+"]"})).join("*"),"}})"),1===t?s.push("proto.order=[0]"):(s.push("Object.defineProperty(proto,'order',{get:"),t<4?(s.push("function "+n+"_order(){"),2===t?s.push("return (Math.abs(this.stride[0])>Math.abs(this.stride[1]))?[1,0]:[0,1]}})"):3===t&&s.push("var s0=Math.abs(this.stride[0]),s1=Math.abs(this.stride[1]),s2=Math.abs(this.stride[2]);if(s0>s1){if(s1>s2){return [2,1,0];}else if(s0>s2){return [1,2,0];}else{return [1,0,2];}}else if(s0>s2){return [2,0,1];}else if(s2>s1){return [0,1,2];}else{return [0,2,1];}}})")):s.push("ORDER})")),s.push("proto.set=function "+n+"_set("+c.join(",")+",v){"),i?s.push("return this.data.set("+l+",v)}"):s.push("return this.data["+l+"]=v}"),s.push("proto.get=function "+n+"_get("+c.join(",")+"){"),i?s.push("return this.data.get("+l+")}"):s.push("return this.data["+l+"]}"),s.push("proto.index=function "+n+"_index(",c.join(),"){return "+l+"}"),s.push("proto.hi=function "+n+"_hi("+c.join(",")+"){return new "+n+"(this.data,"+o.map((function(e){return["(typeof i",e,"!=='number'||i",e,"<0)?this.shape[",e,"]:i",e,"|0"].join("")})).join(",")+","+o.map((function(e){return"this.stride["+e+"]"})).join(",")+",this.offset)}");var g=o.map((function(e){return"a"+e+"=this.shape["+e+"]"})),f=o.map((function(e){return"c"+e+"=this.stride["+e+"]"}));s.push("proto.lo=function "+n+"_lo("+c.join(",")+"){var b=this.offset,d=0,"+g.join(",")+","+f.join(","));for(var m=0;m<t;++m)s.push("if(typeof i"+m+"==='number'&&i"+m+">=0){d=i"+m+"|0;b+=c"+m+"*d;a"+m+"-=d}");s.push("return new "+n+"(this.data,"+o.map((function(e){return"a"+e})).join(",")+","+o.map((function(e){return"c"+e})).join(",")+",b)}"),s.push("proto.step=function "+n+"_step("+c.join(",")+"){var "+o.map((function(e){return"a"+e+"=this.shape["+e+"]"})).join(",")+","+o.map((function(e){return"b"+e+"=this.stride["+e+"]"})).join(",")+",c=this.offset,d=0,ceil=Math.ceil");for(m=0;m<t;++m)s.push("if(typeof i"+m+"==='number'){d=i"+m+"|0;if(d<0){c+=b"+m+"*(a"+m+"-1);a"+m+"=ceil(-a"+m+"/d)}else{a"+m+"=ceil(a"+m+"/d)}b"+m+"*=d}");s.push("return new "+n+"(this.data,"+o.map((function(e){return"a"+e})).join(",")+","+o.map((function(e){return"b"+e})).join(",")+",c)}");var h=new Array(t),S=new Array(t);for(m=0;m<t;++m)h[m]="a[i"+m+"]",S[m]="b[i"+m+"]";s.push("proto.transpose=function "+n+"_transpose("+c+"){"+c.map((function(e,t){return e+"=("+e+"===undefined?"+t+":"+e+"|0)"})).join(";"),"var a=this.shape,b=this.stride;return new "+n+"(this.data,"+h.join(",")+","+S.join(",")+",this.offset)}"),s.push("proto.pick=function "+n+"_pick("+c+"){var a=[],b=[],c=this.offset");for(m=0;m<t;++m)s.push("if(typeof i"+m+"==='number'&&i"+m+">=0){c=(c+this.stride["+m+"]*i"+m+")|0}else{a.push(this.shape["+m+"]);b.push(this.stride["+m+"])}");return s.push("var ctor=CTOR_LIST[a.length+1];return ctor(this.data,a,b,c)}"),s.push("return function construct_"+n+"(data,shape,stride,offset){return new "+n+"(data,"+o.map((function(e){return"shape["+e+"]"})).join(",")+","+o.map((function(e){return"stride["+e+"]"})).join(",")+",offset)}"),new Function("CTOR_LIST","ORDER",s.join("\n"))(u[e],a)}var u={float32:[],float64:[],int8:[],int16:[],int32:[],uint8:[],uint16:[],uint32:[],array:[],uint8_clamped:[],bigint64:[],biguint64:[],buffer:[],generic:[]};e.exports=function(e,t,n,r){if(void 0===e)return(0,u.array[0])([]);"number"==typeof e&&(e=[e]),void 0===t&&(t=[e.length]);var o=t.length;if(void 0===n){n=new Array(o);for(var a=o-1,l=1;a>=0;--a)n[a]=l,l*=t[a]}if(void 0===r){r=0;for(a=0;a<o;++a)n[a]<0&&(r-=(t[a]-1)*n[a])}for(var d=function(e){if(i(e))return"buffer";if(s)switch(Object.prototype.toString.call(e)){case"[object Float64Array]":return"float64";case"[object Float32Array]":return"float32";case"[object Int8Array]":return"int8";case"[object Int16Array]":return"int16";case"[object Int32Array]":return"int32";case"[object Uint8Array]":return"uint8";case"[object Uint16Array]":return"uint16";case"[object Uint32Array]":return"uint32";case"[object Uint8ClampedArray]":return"uint8_clamped";case"[object BigInt64Array]":return"bigint64";case"[object BigUint64Array]":return"biguint64"}return Array.isArray(e)?"array":"generic"}(e),p=u[d];p.length<=o+1;)p.push(c(d,p.length-1));return(0,p[o+1])(e,t,n,r)}},78753:()=>{}}]);
//# sourceMappingURL=399.bundle.baf9566b7f0d1bc9fb6a.js.map