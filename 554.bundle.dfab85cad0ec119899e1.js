(globalThis.webpackChunk=globalThis.webpackChunk||[]).push([[554],{1333:(e,t,a)=>{"use strict";a.r(t),a.d(t,{default:()=>rt});var s={};a.r(s),a.d(s,{createGetImageSrcFromImageIdFn:()=>y,createRequestDisplaySetcreationFn:()=>f,getStudyForPatientUtility:()=>I});var n=a(43001),r=a(3827),i=a.n(r),o=a(71771),c=a(95303),u=a(62474);const{formatDate:l}=o.utils;function d({MeasurementService:e,DisplaySetService:t,UIDialogService:a,UINotificationService:s,getImageSrc:r,getStudiesForPatientByMRN:i,requestDisplaySetCreationForStudy:d,dataSource:m}){const{StudyInstanceUIDs:g}=(0,c.zG)(),[{activeViewportId:p,viewports:h,numCols:y,numRows:I},f]=(0,c.O_)(),E=(0,u.s0)(),[v,D]=(0,n.useState)("primary"),[b,w]=(0,n.useState)([...g]),[U,M]=(0,n.useState)([]),[R,T]=(0,n.useState)([]),[P,N]=(0,n.useState)({}),[C,A]=(0,n.useState)(null),x=h.get(p)?.displaySetInstanceUIDs,O=1===y&&1===I;(0,n.useEffect)((()=>{const t=e.EVENTS.MEASUREMENT_ADDED,a=e.EVENTS.RAW_MEASUREMENT_ADDED,s=[];return[t,a].forEach((t=>{s.push(e.subscribe(t,(({source:e,measurement:t})=>{const{referenceSeriesUID:a,referenceStudyUID:s}=t})).unsubscribe)})),()=>{s.forEach((e=>{e()}))}}),[e,p]),(0,n.useEffect)((()=>{g.forEach((e=>async function(e){const t=await m.query.studies.search({studyInstanceUid:e});if(!t?.length)throw E("/notfoundstudy","_self"),new Error("Invalid study URL");let a=t;try{a=await i(t)}catch(e){console.warn(e)}const s=a.map((e=>({AccessionNumber:e.accession,StudyDate:e.date,StudyDescription:e.description,NumInstances:e.instances,ModalitiesInStudy:e.modalities,PatientID:e.mrn,PatientName:e.patientName,StudyInstanceUID:e.studyInstanceUid,StudyTime:e.time}))).map((e=>({studyInstanceUid:e.StudyInstanceUID,date:l(e.StudyDate),description:e.StudyDescription,modalities:e.ModalitiesInStudy,numInstances:e.NumInstances})));M((e=>{const t=[...e];for(const a of s)e.find((e=>e.studyInstanceUid===a.studyInstanceUid))||t.push(a);return t}))}(e)))}),[g,m,i,E]),(0,n.useEffect)((()=>{t.activeDisplaySets.forEach((async e=>{const a={},s=t.getDisplaySetByUID(e.displaySetInstanceUID),n=m.getImageIdsForDisplaySet(s),i=n[Math.floor(n.length/2)];i&&(a[e.displaySetInstanceUID]=await r(i),N((e=>({...e,...a}))))}))}),[t,m,r]),(0,n.useEffect)((()=>{const e=S(t.activeDisplaySets,P,h,O,m,t,a,s);T(e)}),[t.activeDisplaySets,P,h,m]),(0,n.useEffect)((()=>{const e=t.subscribe(t.EVENTS.DISPLAY_SETS_ADDED,(e=>{const{displaySetsAdded:a,options:s}=e;a.forEach((async e=>{const a=e.displaySetInstanceUID,n={},i=t.getDisplaySetByUID(a);s.madeInClient&&A(a);const o=m.getImageIdsForDisplaySet(i),c=o[Math.floor(o.length/2)];c&&(n[a]=await r(c),N((e=>({...e,...n}))))}))})),n=t.subscribe(t.EVENTS.DISPLAY_SETS_CHANGED,(e=>{const n=S(e,P,h,O,m,t,a,s);T(n)}));return()=>{e.unsubscribe(),n.unsubscribe()}}),[t,m,r,P,h]);const V=function(e,t,a){const s=[],n=[],r=[];t.forEach((t=>{const i=a.filter((e=>e.StudyInstanceUID===t.studyInstanceUid)),c=(o.utils.sortBySeriesDate(i),Object.assign({},t,{displaySets:i}));e.includes(t.studyInstanceUid)?(s.push(c),r.push(c)):(n.push(c),r.push(c))}));const i=(e,t)=>{const a=Date.parse(e);return Date.parse(t)-a},c=[{name:"primary",label:"Primary",studies:s.sort(((e,t)=>i(e.date,t.date)))},{name:"recent",label:"Recent",studies:n.sort(((e,t)=>i(e.date,t.date)))},{name:"all",label:"All",studies:r.sort(((e,t)=>i(e.date,t.date)))}];return c}(g,U,R);return(0,n.useEffect)((()=>{if(C){const e=C,t=document.getElementById(`thumbnail-${e}`);t&&"function"==typeof t.scrollIntoView&&(t.scrollIntoView({behavior:"smooth"}),A(null))}}),[C,b,v]),(0,n.useEffect)((()=>{if(!C)return;const e=function(e,t){for(let a=0;a<t.length;a++){const{studies:s}=t[a];for(let n=0;n<s.length;n++){const{displaySets:r}=s[n];for(let i=0;i<r.length;i++){if(r[i].displaySetInstanceUID===e)return{tabName:t[a].name,StudyInstanceUID:s[n].studyInstanceUid}}}}}(C,V);if(!e)return void console.warn("jumpToThumbnail: displaySet thumbnail not found.");const{tabName:t,StudyInstanceUID:a}=e;D(t);if(!b.includes(a)){const e=[...b,a];w(e)}}),[b,C,V]),n.createElement(c.eX,{tabs:V,activeTabName:v,expandedStudyInstanceUIDs:b,onClickStudy:function(e){const a=b.includes(e),s=a?[...b.filter((t=>t!==e))]:[...b,e];if(w(s),!a){d(t,e,!0)}},onClickTab:e=>{D(e)},onClickThumbnail:()=>{},onDoubleClickThumbnail:e=>{f.setDisplaySetsForViewport({viewportId:p,displaySetInstanceUIDs:[e]})},activeDisplaySetInstanceUIDs:x})}d.propTypes={MeasurementService:i().shape({subscribe:i().func.isRequired,EVENTS:i().object.isRequired}).isRequired,DisplaySetService:i().shape({EVENTS:i().object.isRequired,activeDisplaySets:i().arrayOf(i().object).isRequired,getDisplaySetByUID:i().func.isRequired,subscribe:i().func.isRequired}).isRequired,dataSource:i().shape({getImageIdsForDisplaySet:i().func.isRequired}).isRequired,getImageSrc:i().func.isRequired,getStudiesForPatientByMRN:i().func.isRequired,requestDisplaySetCreationForStudy:i().func.isRequired};const m=d;function S(e,t,a,s,r,i,o,u){const d=[],m=[];return e.forEach((e=>{const S=t[e.displaySetInstanceUID],p=function(e){if(g.includes(e))return"thumbnailNoImage";return"thumbnailTracked"}(e.Modality),h=s?[]:Object.values(a).reduce(((t,a,s)=>(a?.displaySetInstanceUIDs?.includes(e.displaySetInstanceUID)&&t.push(a.viewportLabel),t)),[]),y="thumbnailTracked"===p?d:m,{displaySetInstanceUID:I}=e,f={displaySetInstanceUID:I,description:e.SeriesDescription,seriesNumber:String(e.SeriesNumber),modality:e.Modality,seriesDate:l(e.SeriesDate),numInstances:e.numImageFrames,StudyInstanceUID:e.StudyInstanceUID,componentType:p,imageSrc:S,dragData:{type:"displayset",displaySetInstanceUID:I},viewportIdentificator:h};"thumbnailNoImage"===p&&(r.reject&&r.reject.series?(f.canReject=!0,f.onReject=()=>{o.create({id:"ds-reject-sr",centralize:!0,isDraggable:!1,showOverlay:!0,content:c.Vq,contentProps:{title:"Delete Report",body:()=>n.createElement("div",{className:"p-4 text-white bg-primary-dark"},n.createElement("p",null,"Are you sure you want to delete this report?"),n.createElement("p",null,"This action cannot be undone.")),actions:[{id:"cancel",text:"Cancel",type:"secondary"},{id:"yes",text:"Yes",type:"primary",classes:["reject-yes-button"]}],onClose:()=>o.dismiss({id:"ds-reject-sr"}),onShow:()=>{document.querySelector(".reject-yes-button").focus()},onSubmit:async({action:t})=>{switch(t.id){case"yes":try{await r.reject.series(e.StudyInstanceUID,e.SeriesInstanceUID),i.deleteDisplaySet(I),o.dismiss({id:"ds-reject-sr"}),u.show({title:"Delete Report",message:"Report deleted successfully",type:"success"})}catch(e){o.dismiss({id:"ds-reject-sr"}),u.show({title:"Delete Report",message:"Failed to delete report",type:"error"})}break;case"cancel":o.dismiss({id:"ds-reject-sr"})}}}})}):f.canReject=!1),y.push(f)})),[...d,...m]}const g=["SR","SEG","RTSTRUCT","RTPLAN","RTDOSE"];const p=function(e,t){return new Promise(((a,s)=>{const n=document.createElement("canvas");e.utilities.loadImageToCanvas({canvas:n,imageId:t}).then((()=>{a(n.toDataURL())})).catch(s)}))};const h=function(e,t,a,s){t.activeDisplaySets.some((e=>e.StudyInstanceUID===a))||e.retrieve.series.metadata({StudyInstanceUID:a,madeInClient:s})};function y(e){const t=e.getModuleEntry("@ohif/extension-cornerstone.utilityModule.common");try{const{cornerstone:e}=t.exports.getCornerstoneLibraries();return p.bind(null,e)}catch(e){throw new Error("Required command not found")}}function I(e,t){const a=e.getModuleEntry("@ohif/extension-default.utilityModule.common"),{getStudiesForPatientByMRN:s}=a.exports;return s.bind(null,t)}function f(e){return h.bind(null,e)}const{createGetImageSrcFromImageIdFn:E,createRequestDisplaySetcreationFn:v,getStudyForPatientUtility:D}=s;function b({commandsManager:e,extensionManager:t,servicesManager:a}){const s=t.getActiveDataSource()[0],r=D(t,s),i=E(t),o=v(s);return n.createElement(m,{MeasurementService:a.services.MeasurementService,DisplaySetService:a.services.DisplaySetService,UIDialogService:a.services.UIDialogService,UINotificationService:a.services.UINotificationService,dataSource:s,getImageSrc:i,getStudiesForPatientByMRN:r,requestDisplaySetCreationForStudy:o})}b.propTypes={commandsManager:i().object.isRequired,extensionManager:i().object.isRequired,servicesManager:i().object.isRequired};const w=b;const{downloadCSVReport:U}=o.utils,{formatDate:M}=o.utils,R={key:void 0,date:void 0,modality:void 0,description:void 0};function T({servicesManager:e,extensionManager:t}){const[a,s]=(0,c.O_)(),[r,i]=(0,n.useState)(Date.now().toString()),u=function(e,t){const[a,s]=(0,n.useState)(e);return(0,n.useEffect)((()=>{const a=setTimeout((()=>{s(e)}),t);return()=>{clearTimeout(a)}}),[e,t]),a}(r,200),{MeasurementService:l,UIDialogService:d,DisplaySetService:m}=e.services,[S,g]=(0,n.useState)(R),[p,h]=(0,n.useState)([]);(0,n.useEffect)((()=>{const e=l.getMeasurements().map((e=>function(e,t,a){const{referenceStudyUID:s,referenceSeriesUID:n,SOPInstanceUID:r}=e,i=(o.DicomMetadataStore.getInstance(s,n,r),a.getDisplaySetsForSeries(n));if(!i[0]||!i[0].images)throw new Error('The tracked measurements panel should only be tracking "stack" displaySets.');const{displayText:c}=e;return{uid:e.uid,label:e.label||"(empty)",measurementType:e.type,displayText:c||[],isActive:!1}}(e,l.VALUE_TYPES,m)));h(e)}),[l,u]),(0,n.useEffect)((()=>{g(R)}),[S.key]),(0,n.useEffect)((()=>{const e=l.EVENTS.MEASUREMENT_ADDED,t=l.EVENTS.RAW_MEASUREMENT_ADDED,a=l.EVENTS.MEASUREMENT_UPDATED,s=l.EVENTS.MEASUREMENT_REMOVED,n=l.EVENTS.MEASUREMENTS_CLEARED,r=[];return[e,t,a,s,n].forEach((e=>{r.push(l.subscribe(e,(()=>{i(Date.now().toString())})).unsubscribe)})),()=>{r.forEach((e=>{e()}))}}),[l]);const y=({uid:e,isActive:t})=>{l.jumpToMeasurement(a.activeViewportId,e),I({uid:e,isActive:t})},I=({uid:e,isActive:t})=>{if(!t){const t=[...p],a=t.find((t=>t.uid===e));t.forEach((t=>t.isActive=t.uid===e)),a.isActive=!0,h(t)}},f=({uid:e})=>{l.remove(e)},E=p.filter((e=>e.measurementType!==l.VALUE_TYPES.POINT)),v=p.filter((e=>e.measurementType===l.VALUE_TYPES.POINT));return n.createElement(n.Fragment,null,n.createElement("div",{className:"overflow-x-hidden overflow-y-auto invisible-scrollbar","data-cy":"trackedMeasurements-panel"},S.key&&n.createElement(c.YL,{date:M(S.date),modality:S.modality,description:S.description}),n.createElement(c.wt,{title:"Measurements",amount:E.length,data:E,onClick:y,onEdit:({uid:e,isActive:t})=>{const a=l.getMeasurement(e);y({uid:e,isActive:t});const s=({action:t,value:s})=>{if("save"===t.id)l.update(e,{...a,...s},!0);d.dismiss({id:"enter-annotation"})};d.create({id:"enter-annotation",centralize:!0,isDraggable:!1,showOverlay:!0,content:c.Vq,contentProps:{title:"Enter your annotation",noCloseButton:!0,value:{label:a.label||""},body:({value:e,setValue:t})=>n.createElement("div",{className:"p-4 bg-primary-dark"},n.createElement(c.II,{autoFocus:!0,className:"mt-2 bg-black border-primary-main",type:"text",containerClassName:"mr-2",value:e.label,onChange:e=>{e.persist(),t((t=>({...t,label:e.target.value})))},onKeyPress:t=>{"Enter"===t.key&&s({value:e,action:{id:"save"}})}})),actions:[{id:"cancel",text:"Cancel",type:"primary"},{id:"save",text:"Save",type:"secondary"}],onSubmit:s}})},onDelete:f}),0!==v.length&&n.createElement(c.wt,{title:"Additional Findings",amount:v.length,data:v,onClick:y,onDelete:f})))}T.propTypes={servicesManager:i().shape({services:i().shape({MeasurementService:i().shape({getMeasurements:i().func.isRequired,VALUE_TYPES:i().object.isRequired}).isRequired}).isRequired}).isRequired};const P=T;var N=a(63403),C=a(14446),A=a(36605),x=a(47706);function O({formIndex:e,name:t,value:a,defaultValue:s,options:r,onChange:i}){const{labels:o,precision:c,max:u}=r,l=e=>{if(null==e)return null;const t=Object.keys(o).map(((e,t)=>({key:e,value:o[e].value}))).find((t=>t.value==e));return t?Number(t.key):null},[d,m]=n.useState(l(null!==a?a:s)),[S,g]=n.useState(-1);return n.createElement(C.ZP,{className:"p-2"},n.createElement("div",null,n.createElement(x.ZP,{sx:{fontSize:14},color:"text.secondary",gutterBottom:!0},t),n.createElement(x.ZP,{variant:"h6",component:"div"},null!==d||-1!==S?o[-1!==S?S:d].value:"?"),n.createElement(x.ZP,{variant:"body2"},null!==d||-1!==S?o[-1!==S?S:d].description:"Please Select")),n.createElement(N.ZP,{name:"hover-feedback",value:d,precision:c,max:u,onChange:(t,a)=>{i({formIndex:e,value:a?o[a].value:a}),m(a)},onChangeActive:(e,t)=>{g(t)},emptyIcon:n.createElement(A.Z,{style:{opacity:.55},fontSize:"inherit"})}))}var V=a(60792),_=a(65877),q=a(69985);function F({formIndex:e,name:t,value:a,defaultValue:s,options:r,onChange:i}){const{labels:o,cols:c}=r,[u,l]=n.useState(null!==a?a:s);return n.useEffect((()=>{l(null!==a?a:s)}),[a]),n.createElement(C.ZP,{className:"p-2"},n.createElement("div",null,n.createElement(x.ZP,{sx:{fontSize:14},color:"text.secondary",gutterBottom:!0},t),n.createElement(x.ZP,{variant:"body2",component:"div"},Boolean(o.find((e=>e.value==u)))?o.find((e=>e.value==u)).description:"?")),o.reduce(((e,t,a)=>{const s=Math.floor(a/(c||3));return e[s]=[].concat(e[s]||[],t),e}),[]).map(((t,a)=>n.createElement(V.Z,{row:!0,key:a,name:"grid-select-row",value:u,onChange:(t,a)=>{i({formIndex:e,value:a}),l(a)}},t.map(((e,t)=>n.createElement(_.ZP,{key:t,value:e.value,control:n.createElement(q.ZP,null),label:e.value})))))))}var k=a(47180),L=a(50417);function H({formIndex:e,name:t,value:a,defaultValue:s,options:r,onChange:i}){let o;return null!==a?o=Boolean(a):(o=Boolean(s),i({formIndex:e,value:o})),n.createElement(C.ZP,{className:"p-2"},n.createElement(k.ZP,null,n.createElement(_.ZP,{control:n.createElement(L.ZP,{checked:o,onChange:t=>i({formIndex:e,value:t.target.checked})}),label:n.createElement(x.ZP,{variant:"body2",color:"textSecondary"},t)})))}var $=a(85985),G=a(8324),j=a.n(G);function Z({formIndex:e,name:t,value:a,defaultValue:s,options:r,onChange:i}){const[o,c]=(0,n.useState)(a??s??""),{rows:u}=r,l=(0,n.useMemo)((()=>j()(((e,t)=>{i({formIndex:e,value:t})}),600)),[i]);(0,n.useEffect)((()=>{c(a??s??"")}),[a,s]);return n.createElement(C.ZP,{className:"p-2"},n.createElement($.ZP,{id:"outlined-multiline-flexible",inputProps:{style:{fontSize:"0.75em"}},label:t,multiline:!0,rows:u,value:o,fullWidth:!0,margin:"dense",size:"small",onChange:t=>{c(t.target.value),l(e,t.target.value)}}))}function B({formIndex:e,name:t,value:a,defaultValue:s,options:r}){return n.createElement(C.ZP,{sx:{display:"flex"},className:"p-2"},n.createElement(x.ZP,{sx:{fontSize:14,marginRight:1},color:"text.secondary",gutterBottom:!0},t,":"),n.createElement(x.ZP,{variant:"body2",className:"overflow-auto invisible-scrollbar"},null!==a?a.toString():null!==s?s.toString():""))}var z=a(15471),W=a(98925);function Y({value:e}){const t=e=>{const[t,a,s]=(n=Date.now()-e,r=864e5,i=36e5,o=Math.floor(n/r),c=Math.floor((n-o*r)/i),60===(u=Math.round((n-o*r-c*i)/6e4))&&(c++,u=0),24===c&&(o++,c=0),[o,c,u]);var n,r,i,o,c,u;return t>7?new Date(e).toLocaleDateString("en-us",{year:"numeric",month:"short",day:"numeric"}):t>2?`${t} days ago`:a>2?`${a} hours ago`:s>2?`${s} mins ago`:"just now"};try{e=JSON.parse(e)}catch(t){console.error(t,e),e=null}return e?n.createElement(C.ZP,null,n.createElement(z.ZP,{sx:{"& .MuiCardHeader-content":{overflow:"hidden"}},avatar:n.createElement(W.ZP,{imgProps:{crossOrigin:"anonymous",referrerPolicy:"no-referrer"},src:e.picture}),title:e.email,subheader:`Updated ${t(e.lastUpdated)}`})):n.createElement(C.ZP,null,n.createElement(z.ZP,{sx:{"& .MuiCardHeader-content":{overflow:"hidden"}},avatar:n.createElement(W.ZP,null),title:"----",subheader:"No last update"}))}const Q=function({formTemplate:e,formValue:t,setFormValue:a}){const s=({formIndex:e,value:s})=>{const n=[...t];n[e]=s,a([...n])};if(e){const a=e.map(((e,a)=>{switch(e.type){case"checkbox":return n.createElement("div",{key:a,className:"p-2 bg-primary-dark"},n.createElement(H,{formIndex:a,name:e.name,options:e.template,defaultValue:e.defaultValue,value:t[a],onChange:s}));case"rating":return n.createElement("div",{key:a,className:"p-2 bg-primary-dark"},n.createElement(O,{formIndex:a,name:e.name,options:e.template,defaultValue:e.defaultValue,value:t[a],onChange:s}));case"grid":return n.createElement("div",{key:a,className:"p-2 bg-primary-dark"},n.createElement(F,{formIndex:a,name:e.name,options:e.template,defaultValue:e.defaultValue,value:t[a],onChange:s}));case"textarea":return n.createElement("div",{key:a,className:"p-2 bg-primary-dark"},n.createElement(Z,{formIndex:a,name:e.name,options:e.template,defaultValue:e.defaultValue,value:t[a],onChange:s}));case"user_profile":return n.createElement("div",{key:a,className:"p-2 bg-primary-dark"},n.createElement(Y,{value:t[a]}));default:return n.createElement("div",{key:a,className:"p-2 bg-primary-dark"},n.createElement(B,{formIndex:a,name:e.name,options:e.template,defaultValue:e.defaultValue,value:t[a]}))}}));return n.createElement("div",null,a)}return null};var J=a(3366),K=a(58041),X=a(46258),ee=a(32122),te=a(55545);function ae({servicesManager:e,extensionManager:t}){const{GoogleSheetsService:a}=e.services,[s,r]=(0,n.useState)(a.getFormTemplate()),[i,o]=(0,n.useState)(a.getFormValue()),[c,u]=(0,n.useState)(!1),[l,d]=(0,n.useState)(!0),[m,S]=(0,n.useState)(!Boolean(i&&s)),[g,p]=(0,n.useState)(!1),h=()=>a.getRow(1),y=()=>a.getRow(-1),I=(0,n.useMemo)((()=>j()(h,300)),[]),f=(0,n.useMemo)((()=>j()(y,300)),[]);return(0,n.useEffect)((()=>{const e=[];return e.push(a.subscribe(a.EVENTS.GOOGLE_SHEETS_CHANGE,(()=>{d(!0),o(a.getFormValue()),r(a.getFormTemplate()),S(!1)})).unsubscribe),e.push(a.subscribe(a.EVENTS.GOOGLE_SHEETS_ERROR,(()=>{u(!0)})).unsubscribe),()=>{e.forEach((e=>e()))}}),[a]),(0,n.useEffect)((()=>{l||(p(!0),a.writeFormToRow(i).then((e=>{p(!1)}))),d(!1)}),[i]),c?n.createElement(C.ZP,{sx:{display:"flex"},className:"p-2"},n.createElement(x.ZP,{sx:{fontSize:14,marginRight:1},color:"text.secondary",gutterBottom:!0},"There was an error connecting to Google Sheets.")):m?n.createElement(J.ZP,null):n.createElement(n.Fragment,null,n.createElement("div",{style:{color:"white",overflow:"auto"}},g?n.createElement(J.ZP,null):n.createElement("div",{style:{height:"4px"}}),n.createElement(Q,{formTemplate:s,formValue:i,setFormValue:o})),n.createElement("div",{className:"flex justify-center p-4"},n.createElement(C.ZP,null,n.createElement(te.ZP,{variant:"contained","aria-label":"outlined primary button group"},n.createElement(K.ZP,{loading:g,loadingPosition:"start",startIcon:n.createElement(ee.Z,null),variant:"contained",color:"primary",onClick:f},"Prev"),n.createElement(K.ZP,{loading:g,loadingPosition:"end",endIcon:n.createElement(X.Z,null),variant:"contained",color:"primary",onClick:I},"Next")))))}ae.propTypes={servicesManager:i().shape({services:i().shape({}).isRequired}).isRequired};const se=ae;var ne=a(73289);function re({servicesManager:e,extensionManager:t}){return n.createElement(n.Fragment,null,n.createElement("div",{style:{height:"150px",overflowY:"auto"}},n.createElement(P,{servicesManager:e,extensionManager:t})),n.createElement("div",{className:"m-2"},n.createElement(ne.ZP,{style:{background:"white"}})),n.createElement(se,{servicesManager:e,extensionManager:t}))}re.propTypes={servicesManager:i().shape({services:i().shape({}).isRequired}).isRequired};const ie=re,{sortStudyInstances:oe,formatDate:ce}=o.utils;function ue({servicesManager:e,getImageSrc:t,getStudiesForPatientByMRN:a,requestDisplaySetCreationForStudy:s,dataSource:r}){const{hangingProtocolService:i,displaySetService:o,uiNotificationService:l,GoogleSheetsService:d}=e.services,m=(0,u.s0)(),{StudyInstanceUIDs:S}=(0,c.zG)(),[g,p]=(0,n.useState)([...S]),[{activeViewportId:h,viewports:y},I]=(0,c.O_)(),[f,E]=(0,n.useState)("primary"),[v,D]=(0,n.useState)([...g]),[b,w]=(0,n.useState)([]),[U,M]=(0,n.useState)([]),[R,T]=(0,n.useState)({});(0,n.useEffect)((()=>{p([...S]),D([...S])}),[S]),(0,n.useEffect)((()=>{g.forEach((e=>async function(e){const t=await r.query.studies.search({studyInstanceUid:e});if(!t?.length)throw m("/notfoundstudy","_self"),new Error("Invalid study URL");let s=t;try{s=await a(t)}catch(e){console.warn(e)}const n=s.map((e=>({AccessionNumber:e.accession,StudyDate:e.date,StudyDescription:e.description,NumInstances:e.instances,ModalitiesInStudy:e.modalities,PatientID:e.mrn,PatientName:e.patientName,StudyInstanceUID:e.studyInstanceUid,StudyTime:e.time}))).map((e=>({studyInstanceUid:e.StudyInstanceUID,date:ce(e.StudyDate),description:e.StudyDescription,modalities:e.ModalitiesInStudy,numInstances:e.NumInstances})));w((e=>{const t=[...e];for(const a of n)e.find((e=>e.studyInstanceUid===a.studyInstanceUid))||t.push(a);return t}))}(e)))}),[g,r,a,m]),(0,n.useEffect)((()=>{o.activeDisplaySets.forEach((async e=>{const a={},s=o.getDisplaySetByUID(e.displaySetInstanceUID),n=r.getImageIdsForDisplaySet(s),i=n[Math.floor(n.length/2)];i&&!s?.unsupported&&(a[e.displaySetInstanceUID]=await t(i),T((e=>({...e,...a}))))}))}),[g,r,o,t]),(0,n.useEffect)((()=>{const e=de(o.activeDisplaySets,R);oe(e),M(e)}),[g,R,o]),(0,n.useEffect)((()=>{const e=o.subscribe(o.EVENTS.DISPLAY_SETS_ADDED,(e=>{const{displaySetsAdded:a,options:s}=e;a.forEach((async e=>{const a={},s=o.getDisplaySetByUID(e.displaySetInstanceUID);if(s?.unsupported)return;const n=r.getImageIdsForDisplaySet(s),i=n[Math.floor(n.length/2)];i&&(a[e.displaySetInstanceUID]=await t(i,e.initialViewport),T((e=>({...e,...a}))))}))}));return()=>{e.unsubscribe()}}),[t,r,o]),(0,n.useEffect)((()=>{const e=o.subscribe(o.EVENTS.DISPLAY_SETS_CHANGED,(e=>{const t=de(e,R);M(t)})),t=o.subscribe(o.EVENTS.DISPLAY_SET_SERIES_METADATA_INVALIDATED,(()=>{const e=de(o.getActiveDisplaySets(),R);M(e)}));return()=>{e.unsubscribe(),t.unsubscribe()}}),[g,R,o]),(0,n.useEffect)((()=>{const{unsubscribe:e}=d.subscribe(d.EVENTS.GOOGLE_SHEETS_CHANGE,(()=>{const e=Object.entries(d.studyUIDToIndex).filter((([e,t])=>t===d.index))[0][0];g.includes(e)||(p([e]),D([e]))}));return()=>{e()}}));const P=function(e,t,a){const s=[],n=[],r=[];t.forEach((t=>{const i=a.filter((e=>e.StudyInstanceUID===t.studyInstanceUid)),o=Object.assign({},t,{displaySets:i});e.includes(t.studyInstanceUid)?s.push(o):(n.push(o),r.push(o))}));const i=[{name:"primary",label:"Primary",studies:s},{name:"recent",label:"Recent",studies:n},{name:"all",label:"All",studies:r}];return i}(g,b,U);const N=y.get(h)?.displaySetInstanceUIDs;return n.createElement(c.eX,{tabs:P,servicesManager:e,activeTabName:f,onDoubleClickThumbnail:e=>{let t=[];const a=h;try{t=i.getViewportsRequireUpdate(a,e)}catch(e){console.warn(e),l.show({title:"Thumbnail Double Click",message:"The selected display sets could not be added to the viewport.",type:"info",duration:3e3})}I.setDisplaySetsForViewports(t)},activeDisplaySetInstanceUIDs:N,expandedStudyInstanceUIDs:v,onClickStudy:function(e){const t=v.includes(e),a=t?[...v.filter((t=>t!==e))]:[...v,e];if(D(a),!t){s(o,e,!0)}},onClickTab:e=>{E(e)}})}ue.propTypes={servicesManager:i().object.isRequired,dataSource:i().shape({getImageIdsForDisplaySet:i().func.isRequired}).isRequired,getImageSrc:i().func.isRequired,getStudiesForPatientByMRN:i().func.isRequired,requestDisplaySetCreationForStudy:i().func.isRequired};const le=ue;function de(e,t){const a=[],s=[];return e.filter((e=>!e.excludeFromThumbnailBrowser)).forEach((e=>{const n=t[e.displaySetInstanceUID],r=function(e){if(me.includes(e.Modality)||e?.unsupported)return"thumbnailNoImage";return"thumbnail"}(e);("thumbnail"===r?a:s).push({displaySetInstanceUID:e.displaySetInstanceUID,description:e.SeriesDescription||"",seriesNumber:e.SeriesNumber,modality:e.Modality,seriesDate:e.SeriesDate,seriesTime:e.SeriesTime,numInstances:e.numImageFrames,countIcon:e.countIcon,StudyInstanceUID:e.StudyInstanceUID,messages:e.messages,componentType:r,imageSrc:n,dragData:{type:"displayset",displaySetInstanceUID:e.displaySetInstanceUID},isHydratedForDerivedDisplaySet:e.isHydrated})})),[...a,...s]}const me=["SR","SEG","SM","RTSTRUCT","RTPLAN","RTDOSE"];const{createGetImageSrcFromImageIdFn:Se,createRequestDisplaySetcreationFn:ge,getStudyForPatientUtility:pe}=s;function he({commandsManager:e,extensionManager:t,servicesManager:a}){const s=t.getDataSources()[0],r=pe(t,s),i=(0,n.useCallback)(Se(t),[]),o=ge(s);return n.createElement(le,{servicesManager:a,dataSource:s,getImageSrc:i,getStudiesForPatientByMRN:r,requestDisplaySetCreationForStudy:o})}he.propTypes={commandsManager:i().object.isRequired,extensionManager:i().object.isRequired,servicesManager:i().object.isRequired};const ye=he;const Ie=function({commandsManager:e,extensionManager:t,servicesManager:a}){return[{name:"seriesList",iconName:"group-layers",iconLabel:"Studies",label:"Studies",component:w.bind(null,{commandsManager:e,extensionManager:t,servicesManager:a})},{name:"measurements",iconName:"list-bullets",iconLabel:"Measure",label:"Measurements",component:P.bind(null,{commandsManager:e,extensionManager:t,servicesManager:a})},{name:"form",iconName:"list-bullets",iconLabel:"Form",label:"Form",component:se.bind(null,{commandsManager:e,extensionManager:t,servicesManager:a})},{name:"form-and-measurements",iconName:"list-bullets",iconLabel:"Form",label:"Form",component:ie.bind(null,{commandsManager:e,extensionManager:t,servicesManager:a})},{name:"seriesList-without-tracking",iconName:"group-layers",iconLabel:"Studies",label:"Studies",component:ye.bind(null,{commandsManager:e,extensionManager:t,servicesManager:a})}]};function fe(){return fe=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var a=arguments[t];for(var s in a)Object.prototype.hasOwnProperty.call(a,s)&&(e[s]=a[s])}return e},fe.apply(this,arguments)}const Ee=n.lazy((()=>Promise.all([a.e(816),a.e(515)]).then(a.bind(a,95515)))),ve=e=>n.createElement(n.Suspense,{fallback:n.createElement("div",null,"Loading...")},n.createElement(Ee,e));const De=function({servicesManager:e,commandsManager:t,extensionManager:a}){return[{name:"cornerstone-gradient",component:s=>n.createElement(ve,fe({servicesManager:e,commandsManager:t,extensionManager:a,disableViewportOrientationMarkers:!0},s))}]},be={id:"breast",locked:!0,hasUpdatedPriorsInformation:!1,name:"Breast",createdDate:"2021-02-23T19:22:08.894Z",modifiedDate:"2021-02-23T19:22:08.894Z",availableTo:{},editableBy:{},protocolMatchingRules:[],displaySetSelectors:{LMLO:{seriesMatchingRules:[{weight:5,attribute:"ImageLaterality",constraint:{contains:{value:"L"}},required:!1},{weight:5,attribute:"ViewCodeSequence",constraint:{contains:{value:"R-10226"}},required:!1}]},LCC:{seriesMatchingRules:[{weight:5,attribute:"ImageLaterality",constraint:{contains:{value:"L"}},required:!1},{weight:5,attribute:"ViewCodeSequence",constraint:{contains:{value:"R-10242"}},required:!1}]},RMLO:{seriesMatchingRules:[{weight:5,attribute:"ImageLaterality",constraint:{contains:{value:"R"}},required:!1},{weight:5,attribute:"ViewCodeSequence",constraint:{contains:{value:"R-10226"}},required:!1}]},RCC:{seriesMatchingRules:[{weight:5,attribute:"ImageLaterality",constraint:{contains:{value:"R"}},required:!1},{weight:5,attribute:"ViewCodeSequence",constraint:{contains:{value:"R-10242"}},required:!1}]}},toolGroupIds:["default"],stages:[{id:"breast-staging",name:"Breast Staging",viewportStructure:{type:"grid",properties:{rows:1,columns:4}},viewports:[{viewportOptions:{toolGroupId:"default"},displaySets:[{id:"RMLO"}]},{viewportOptions:{toolGroupId:"default"},displaySets:[{id:"LMLO"}]},{viewportOptions:{toolGroupId:"default"},displaySets:[{id:"RCC"}]},{viewportOptions:{toolGroupId:"default"},displaySets:[{id:"LCC"}]}],createdDate:"2021-02-23T18:32:42.850Z"}],numberOfPriorsReferenced:-1};const we=function(){return[{name:be.id,protocol:be}]};var Ue=a(67540),Me=a(95013);function Re({instance:e,frame:t,config:a,thumbnail:s=!1}){if(!e)return;if(e.url)return e.url;const n=s?"thumbnailRendering":"imageRendering";if(a[n]&&"wadouri"!==a[n])return function(e,t,a){const s=function(e,t,a){const s=function(e,t){const{StudyInstanceUID:a,SeriesInstanceUID:s,SOPInstanceUID:n}=e;return`${t.wadoRoot}/studies/${a}/series/${s}/instances/${n}`}(e,t);return`${s}/frames/${a=a||1}`}(e,t,a);if(s)return`wadors:${s}`}(e,a,t);{const s=function(e,t){const{StudyInstanceUID:a,SeriesInstanceUID:s,SOPInstanceUID:n}=t,r=[];r.push("requestType=WADO"),r.push(`studyUID=${a}`),r.push(`seriesUID=${s}`),r.push(`objectUID=${n}`),r.push("contentType=application/dicom"),r.push("transferSyntax=*");const i=r.join("&");return`${e.wadoUriRoot}?${i}`}(a,e);let n="dicomweb:"+s;return void 0!==t&&(n+="&frame="+t),n}}var Te=a(44379),Pe=a.n(Te);const Ne=o.classes.MetadataProvider,{datasetToBlob:Ce}=Ue.default.data,Ae={studyInstanceUid:"StudyInstanceUID",patientId:"PatientID"};let xe={urls:[],studyInstanceUIDMap:new Map};const Oe=e=>xe.urls.find((t=>t.url===e)),Ve=(e,t)=>{let a=t?e.replace("https://storage.googleapis.com",`https://storage.googleapis.com/${t}`):e;return a=a.includes(":zip//")?a.replace(/^dicomweb:/,"dicomzip:"):a,a},_e=(e,t,a)=>{let s=e.map((e=>(e.instances=Pe().uniqBy(e.instances,(e=>e.url)),e)));Pe().isEmpty(a)||(s=s.filter((e=>a.includes(e.SeriesInstanceUID))));const n=Object.values(s.reduce(((e,t)=>{const a=t.StudyInstanceUID;return e[a]||(e[a]=[]),e[a].push(t),e}),{})).map((e=>{const a=e.reduce(((e,t)=>e+(parseInt(t.NumInstances)||0)),0),s=e.map((e=>({SeriesInstanceUID:e.SeriesInstanceUID,Modality:e.Modality,SeriesDescription:e.SeriesDescription||"No description",StudyInstanceUID:e.StudyInstanceUID,SeriesNumber:e.SeriesNumber,SeriesTime:e.SeriesTime,NumInstances:isNaN(parseInt(e.NumInstances))?0:parseInt(e.NumInstances),instances:e.instances.map((e=>({metadata:e.metadata,url:Ve(e.url,t)})))})));return{StudyInstanceUID:e[0].StudyInstanceUID,PatientName:e[0].PatientName,PatientSex:e[0].PatientSex,AccessionNumber:e[0].AccessionNumber,StudyDate:e[0].StudyDate,PatientID:e[0].PatientID,PatientWeight:e[0].PatientWeight,PatientAge:e[0].PatientAge,StudyDescription:e[0].StudyDescription||"No description",StudyTime:e[0].StudyTime,NumInstances:a,Modalities:`["${e[0].Modality}"]`,series:s}}));return{studies:n}},qe=async({bucketName:e,prefix:t,studyuids:a,headers:s})=>{const n=a.map((async a=>{const n=`https://storage.googleapis.com/storage/v1/b/${e}/o?prefix=${`${t}/studies/${a}/series/`}&delimiter=/`,r=await fetch(n,{headers:s}),i=await r.json(),o=(i.items,(i.prefixes||[]).map((async t=>{const a=`https://storage.googleapis.com/storage/v1/b/${e}/o/${encodeURIComponent(`${t}metadata`)}?alt=media`;return(await fetch(a,{headers:s})).json()})));return Promise.all(o)}));return await Promise.all(n)},Fe=(e,t)=>{let a=[];return xe.urls.map((s=>{s.studies.map((s=>{s[e]===t&&a.push(s)}))})),a},ke=async(e,t)=>{const{StudyInstanceUID:a,SeriesInstanceUID:s,SOPInstanceUID:n,SeriesDescription:r}=e,i=new URLSearchParams(window.location.search),o=i.getAll("bucket"),c=o[1]||o[0]||"gradient-health-search-viewer-links",u=i.get("bucket-prefix")||"dicomweb",l=i.get("seg-bucket")||c,d=i.get("seg-prefix")||u,m=`${d}/studies/${a}/series/${s}/instances/${n}/${encodeURIComponent(r)}.dcm`,S=`https://storage.googleapis.com/upload/storage/v1/b/${l}/o?uploadType=media&name=${m}`,g=Ce(e);await fetch(S,{method:"POST",headers:{...t,"Content-Type":"application/dicom"},body:g}).then((e=>e.json())).then((n=>{if(n.error)throw new Error(`${n.error.code}: ${n.error.message}`);const r=`dicomweb:https://storage.googleapis.com/${l}/${n.name}`;e.url=r;const i={Modality:(o=e).Modality,SeriesInstanceUID:o.SeriesInstanceUID,SeriesDescription:o.SeriesDescription,SeriesNumber:Number(o.SeriesNumber),SeriesDate:o.SeriesDate,StudyInstanceUID:o.StudyInstanceUID,instances:[{metadata:{FrameOfReferenceUID:o.FrameOfReferenceUID,SOPInstanceUID:o.SOPInstanceUID,SOPClassUID:o.SOPClassUID,ReferencedSeriesSequence:o.ReferencedSeriesSequence,SharedFunctionalGroupsSequence:o.SharedFunctionalGroupsSequence},url:o.url}]};var o;const c=Me.ZP.gzip(JSON.stringify(i));return fetch(`https://storage.googleapis.com/upload/storage/v1/b/${l}/o?uploadType=media&name=${d}/studies/${a}/series/${s}/metadata&contentEncoding=gzip`,{method:"POST",headers:{...t,"Content-Type":"application/json"},body:c}).then((e=>e.json())).then((e=>{if(e.error)throw new Error(`${e.error.code}: ${e.error.message}`)})).catch((e=>{throw new Error(e.message||"Failed to store DicomSeg metadata")}))})).catch((e=>{throw new Error(e.message||"Failed to store DicomSeg file")}))};let Le=null;function He(e,t){var{name:a,wadoRoot:s}=e;const n=e=>{Le=e,Le.name,Le.wadoRoot};n(e);const r={updateConfig:e=>{n(e)},initialize:async({params:e,query:a,url:s})=>{s||(s=a.get("url")),s||(s=a.toString(),a.set("url",s));let n=Oe(s);if(n)return n.studies.map((e=>e.StudyInstanceUID));const r=a.getAll("bucket");0===r.length&&r.push("gradient-health-search-viewer-links");const{UserAuthenticationService:i}=t.services,o=[];for(let e=0;e<r.length;e++){const t=await qe({bucketName:r[e],prefix:a.get("bucket-prefix")||"dicomweb",studyuids:a.getAll("StudyInstanceUID"),headers:i.getAuthorizationHeader()});o.push(...t)}const c=_e(Pe().flatten(o),a.get("prefix"),a.getAll("SeriesInstanceUID"));let u,l;c.studies.forEach((e=>{u=e.StudyInstanceUID,e.series.forEach((e=>{l=e.SeriesInstanceUID,e.instances.forEach((e=>{const{url:t,metadata:a}=e;Ne.addImageIdToUIDs(t,{StudyInstanceUID:u,SeriesInstanceUID:l,SOPInstanceUID:a.SOPInstanceUID})}))}))})),xe.urls.push({url:s,studies:[...c.studies]}),xe.studyInstanceUIDMap.set(s,c.studies.map((e=>e.StudyInstanceUID)))},query:{studies:{mapParams:()=>{},search:async e=>{const[t,a]=Object.entries(e)[0],s=Ae[t];return Fe(s,a).map((e=>({accession:e.AccessionNumber,date:e.StudyDate,description:e.StudyDescription,instances:e.NumInstances,modalities:e.Modalities,mrn:e.PatientID,patientName:e.PatientName,studyInstanceUid:e.StudyInstanceUID,NumInstances:e.NumInstances,time:e.StudyTime})))},processResults:()=>{console.debug(" DICOMJson QUERY processResults")}},series:{search:()=>{console.debug(" DICOMJson QUERY SERIES SEARCH")}},instances:{search:()=>{console.debug(" DICOMJson QUERY instances SEARCH")}}},retrieve:{directURL:e=>{console.debug("Not implemented",e)},series:{metadata:async({StudyInstanceUID:e,buckets:t=[],madeInClient:a=!1,customSort:s}={})=>{if(!e)throw new Error("Unable to query for SeriesMetadata without StudyInstanceUID");let n,i=Fe("StudyInstanceUID",e)[0];if(!i){const a=new URLSearchParams(window.location.search);a.set("StudyInstanceUID",e),a.delete("bucket"),t.forEach((e=>{a.append("bucket",e)})),await r.initialize({query:a}),i=Fe("StudyInstanceUID",e)[0]}n=s?s(i.series):i.series;const c=n.map((e=>{const t={StudyInstanceUID:i.StudyInstanceUID,...e};return delete t.instances,t}));o.DicomMetadataStore.addSeriesMetadata(c,a);const u=n.length;n.forEach(((t,s)=>{const n=t.instances.map((e=>{const a={...e.metadata,url:e.url,imageId:e.url,...t,...i};return delete a.instances,delete a.series,a}));var r;r=n,o.DicomMetadataStore.addInstances(r,a),s===u-1&&(o.DicomMetadataStore.getStudy(e,a).isLoaded=!0)}))}}},store:{dicom:async e=>{if("SEG"===e.Modality){const a=t.services.UserAuthenticationService.getAuthorizationHeader();try{await ke(e,a)}catch(e){throw e}}else console.debug(" DICOMJson store dicom")}},getImageIdsForDisplaySet(e){const t=e.images,a=[];return t?(e.images.forEach((e=>{const t=e.NumberOfFrames;if(t>1)for(let s=0;s<t;s++){const t=Re({instance:e,frame:s,config:Le});a.push(t)}else{const t=Re({instance:e,config:Le});a.push(t)}})),a):a},getImageIdsForInstance:({instance:e,frame:t})=>Re({instance:e,frame:t}),getStudyInstanceUIDs:({params:e,query:t})=>{const a=t.get("url");return xe.studyInstanceUIDMap.get(a)}};return o.Is.create(r)}const $e=function({servicesManager:e}){return[{name:"bq",type:"jsonApi",createDataSource:t=>He(t,e)}]},Ge=JSON.parse('{"u2":"@gradienthealth/ohif-gradienthealth-extension"}').u2;var je=a(56388);const Ze=["A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z"];let Be=[...Ze];Ze.forEach((e=>{Ze.forEach((t=>{Be.push(e+t)}))}));const ze=[...Be];const We={GOOGLE_SHEETS_CHANGE:"event::gradienthealth::GoogleSheets:FormChange",GOOGLE_SHEETS_ERROR:"event::gradienthealth::GoogleSheets:Error",GOOGLE_SHEETS_DESTROY:"event::gradienthealth::GoogleSheets:Destroy"},Ye=e=>{switch(e){case"TRUE":return!0;case"FALSE":return!1;case"YES":return!0;case"NO":return!1;case"":case void 0:return null}return e};class Qe{constructor(e,t,a){this.serviceManager=e,this.listeners={},this.api_key="AIzaSyDu5Rt54oHX1w3O5kZTARz7DClaxNjTpEs",this.EVENTS=We,this.sheetId=null,this.index=null,this.sheetName=null,this.formTemplate=null,this.formValue=null,this.settings=null,this.formHeader=null,this.rows=null,this.studyUIDToIndex={},this.extensionManager=a,this.DicomMetadataStore=o.DicomMetadataStore,Object.assign(this,o.KZ)}cacheNearbyStudyInstanceUIDs(e,t,a){const{CacheAPIService:s}=this.serviceManager.services,n=this.studyUIDToIndex[e],r=n-t<2?2:n-t,i=n+a,o=this.formHeader.findIndex((e=>"URL"==e));this.rows.slice(r-1,i).forEach((e=>{const t=e[o],a=new URLSearchParams("?"+t.split("?")[1]),n=Je(a);s.cacheStudy(n,a.getAll("bucket"))}))}setFormByStudyInstanceUID(e){const t=this.studyUIDToIndex[e];this.setFormByIndex(t),this.cacheNearbyStudyInstanceUIDs(e,2,32),function(e,t){if(!window.location.search.includes("/segmentation"))return;const a=["1.2.840.10008.5.1.4.1.1.66.4"],{segmentationService:s,displaySetService:n,UserAuthenticationService:r,CacheAPIService:i}=t.services,o=r.getAuthorizationHeader(),c=n.getDisplaySetsBy((t=>t.StudyInstanceUID===e&&a.includes(t.SOPClassUID))),u=n.getDisplaySetsBy((t=>t.StudyInstanceUID===e&&!a.includes(t.SOPClassUID))).flatMap((e=>e.images.flatMap((e=>e.imageId)))),l=()=>u.every((e=>je.cache.getImageLoadObject(e))),d=()=>{let e;const t=()=>{l()&&(c.forEach((async e=>{e.getReferenceDisplaySet(),await e.load({headers:o}),s.addSegmentationRepresentationToToolGroup("default",e.displaySetInstanceUID,!0)})),e?.())};l()?t():({unsubscribe:e}=i.subscribe(i.EVENTS.IMAGE_CACHE_PREFETCHED,t)),je.eventTarget.removeEventListener(je.Enums.Events.STACK_VIEWPORT_NEW_STACK,d)};je.eventTarget.addEventListener(je.Enums.Events.STACK_VIEWPORT_NEW_STACK,d)}(e,this.serviceManager)}setFormByIndex(e){this.index=e;const t=this.rows[e-1];this.formValue=this.readFormValue(t),this._broadcastEvent(We.GOOGLE_SHEETS_CHANGE)}async init(){try{const{UserAuthenticationService:e}=this.serviceManager.services;this.user=e.getUser();const t=new URLSearchParams(window.location.search);if(!t.get("sheetId"))return this._broadcastEvent(We.GOOGLE_SHEETS_ERROR);if(!t.get("sheetName"))return this._broadcastEvent(We.GOOGLE_SHEETS_ERROR);this.sheetId=t.get("sheetId"),this.sheetName=t.get("sheetName"),this.settings=await this.readRange(1,6,this.sheetId,"Settings"),this.formHeader=(await this.readRange(1,1)).values[0],this.rows=(await this.readRange(1,1e5)).values,this.formHeader=this.rows[0];const a=this.formHeader.findIndex((e=>"URL"==e));this.studyUIDToIndex=this.rows.slice(1).reduce(((e,t,s)=>{const n=t[a];return e[Je(new URLSearchParams("?"+n.split("?")[1]))]=s+2,e}),{}),this.index=this.studyUIDToIndex[Je(t)];const s=this.settings.values[0].map(((e,t)=>this.settings.values.map((e=>e[t])))),n=s[0];this.formTemplate=s.slice(1,-1).map((e=>e.reduce(((e,t,a)=>{switch(t=Ye(t),n[a]){case"template":try{t&&(e[n[a]]=JSON.parse(t))}catch(e){console.warn(t,e)}break;case"order":e[n[a]]=Number(t);break;default:e[n[a]]=t}return e}),{}))).filter((e=>e.show)).sort(((e,t)=>e.order-t.order)),this.setFormByStudyInstanceUID(Je(t))}catch(e){console.error(e),this._broadcastEvent(We.GOOGLE_SHEETS_ERROR)}}readFormValue(e){return this.formTemplate.map((t=>{const a=this.formHeader.findIndex((e=>e==t.name));if(-1!==a)return Ye(e[a])}))}async readRange(e,t,a=this.sheetId,s=this.sheetName){const n=`https://sheets.googleapis.com/v4/spreadsheets/${a}/values/${s}!${`A${e}:ZZ${t}`}`,r=await fetch(n,{headers:{Authorization:"Bearer "+this.user.access_token}});return await r.json()}writeRange(e,t,a,s){return new Promise(((n,r)=>{let i=`https://sheets.googleapis.com/v4/spreadsheets/${e}/values/${t}!${a}?valueInputOption=USER_ENTERED`;var o=new XMLHttpRequest;o.open("PUT",i),o.setRequestHeader("Content-type","application/json"),o.setRequestHeader("Authorization","Bearer "+this.user.access_token),o.onload=()=>{200==o.status?n():r()},o.send(JSON.stringify({range:`${t}!${a}`,majorDimension:"ROWS",values:[s]}))}))}async writeFormToRow(e){const t=this.formHeader.map((t=>{const a=this.formTemplate.findIndex((e=>t==e.name));if(a>0)return e[a];if("Updated By"===t){const e=this.serviceManager.services.UserAuthenticationService.getUser();return JSON.stringify({email:e.profile.email,picture:e.profile.picture,lastUpdated:Date.now()})}return null}));return await this.writeRange(this.sheetId,this.sheetName,`A${this.index}:${ze[this.formHeader.length-1]}${this.index}`,t),t}getFormTemplate(){return this.formTemplate?this.formTemplate:null}getFormValue(){return this.formValue?this.formValue:null}async getRow(e){try{const{DisplaySetService:t,HangingProtocolService:a,CacheAPIService:s,SegmentationService:n}=this.serviceManager.services,r=this.rows[this.index+e-1];r||(window.location.href=`https://docs.google.com/spreadsheets/d/${this.sheetId}`);const i=r[this.formHeader.findIndex((e=>"URL"==e))],c=new URLSearchParams("?"+i.split("?")[1]),u=Je(c),l=c.getAll("bucket");u||(window.location.href=`https://docs.google.com/spreadsheets/d/${this.sheetId}`);const d=this.extensionManager.getActiveDataSource()[0];await d.retrieve.series.metadata({StudyInstanceUID:u,buckets:l});const m=[o.DicomMetadataStore.getStudy(u)],S=a.getActiveProtocol().protocol.id;a.reset(),a.run({studies:m,activeStudy:m[0],displaySets:t.getActiveDisplaySets().filter((e=>e.StudyInstanceUID===u))},S);n.getSegmentations().forEach((e=>n.remove(e.id)));const g=new URLSearchParams(window.location.search);g.get("StudyInstanceUIDs")?g.set("StudyInstanceUIDs",u):g.set("StudyInstanceUID",u),g.delete("bucket"),l.forEach((e=>{g.append("bucket",e)}));const p=window.location.href.split("?")[0]+"?"+g.toString();window.history.replaceState({},null,p),this.setFormByStudyInstanceUID(u),s.setViewedStudy(u)}catch(e){console.error(e)}}destroy(){this.sheetId=null,this.index=null,this.sheetName=null,this.formTemplate=null,this.formValue=null,this._broadcastEvent(We.GOOGLE_SHEETS_ERROR)}}function Je(e){return e.get("StudyInstanceUIDs")||e.get("StudyInstanceUID")}var Ke=a(22239);const Xe={CROP_DISPLAY_AREA_INIT:"event::gradienthealth::CropDisplayAreaService:init"};class et{constructor(e){this.serviceManager=void 0,this.listeners=void 0,this.EVENTS=void 0,this.serviceManager=e,this.listeners={},this.EVENTS=Xe,window.tf=Ke,Object.assign(this,o.KZ)}init(){je.eventTarget.addEventListener(je.EVENTS.STACK_VIEWPORT_NEW_STACK,(e=>{const{HangingProtocolService:t}=this.serviceManager.services;"breast"===t.protocol.id&&this.handleBreastDensityHP(e)}))}handleBreastDensityHP(e){const{HangingProtocolService:t,cornerstoneViewportService:a}=this.serviceManager.services,{element:s,viewportId:n}=e.detail,r=(0,je.getEnabledElement)(s),i=r?.viewport;if(!i)return;const{voiRange:o,invert:c}=i.getProperties();let u;if(o?.lower&&!c&&(u=o?.lower),o?.upper&&c&&(u=o?.upper),!u)return;const l=a.getViewportInfo(n),d=Array.from(t.displaySetMatchDetails.values()).findIndex((e=>e.displaySetInstanceUID===l.viewportData.data.displaySetInstanceUID)),m=Array.from(t.displaySetMatchDetails.keys())[d];if(!m)return;const S=i.getImageData(),g=S?.scalarData,p=S?.dimensions;if(!g||!p)return;const{bboxWidth:h,bboxHeight:y,width:I,height:f}=Ke.tidy((()=>{const e=Ke.tensor2d(new Float32Array(g),[p[1],p[0]]).greater(u),t=e.any(0),a=e.any(1),s=t.argMax(),n=t.reverse().argMax().mul(-1).add(t.size),r=a.argMax(),i=a.reverse().argMax().mul(-1).add(a.size);return{bboxWidth:n.sub(s).dataSync()[0],bboxHeight:i.sub(r).dataSync()[0],width:t.size,height:a.size}})),E=(i.sWidth,i.sHeight,h/I);"LMLO"===m&&i.setDisplayArea({imageArea:[E,E],imageCanvasPoint:{canvasPoint:[0,.5],imagePoint:[0,.5]},storeAsInitialCamera:!0},!0),"RMLO"===m&&i.setDisplayArea({imageArea:[E,E],imageCanvasPoint:{canvasPoint:[1,.5],imagePoint:[1,.5]},storeAsInitialCamera:!0},!0),"LCC"===m&&i.setDisplayArea({imageArea:[E,E],imageCanvasPoint:{canvasPoint:[0,.5],imagePoint:[0,.5]},storeAsInitialCamera:!0},!0),"RCC"===m&&i.setDisplayArea({imageArea:[E,E],imageCanvasPoint:{canvasPoint:[1,.5],imagePoint:[1,.5]},storeAsInitialCamera:!0},!0)}destroy(){}}var tt=a(41851);const{getOptions:at}=tt.internal,st={IMAGE_CACHE_PREFETCHED:"event::gradienthealth::image_cache_prefetched"};class nt{constructor(e,t,a){this.listeners=void 0,this.EVENTS=void 0,this.element=void 0,this.servicesManager=void 0,this.commandsManager=void 0,this.extensionManager=void 0,this.dataSource=void 0,this.options=void 0,this.storageUsage=void 0,this.storageQuota=void 0,this.imageIdToFileUriMap=void 0,this.listeners={},this.EVENTS=st,this.commandsManager=t,this.extensionManager=a,this.servicesManager=e,this.storageUsage=null,this.storageQuota=null,this.imageIdToFileUriMap=new Map,Object.assign(this,o.KZ)}init(){const e=this.extensionManager.getActiveDataSource();this.dataSource=e[0],je.eventTarget.addEventListener("CORNERSTONE_CACHE_QUOTA_EXCEEDED_ERROR",this.handleQuotaExceededWriteError.bind(this)),window?.navigator?.storage?.estimate&&window?.navigator?.storage?.estimate().then((e=>{console.log("Storage use: ",1e-9*e.usage," of ",1e-9*e.quota," GB"),this.storageUsage=e.usage,this.storageQuota=e.quota})),window?.navigator?.storage?.persisted&&window?.navigator?.storage?.persist&&window?.navigator?.storage?.persisted().then((e=>{e?console.log("Storage will not be cleared except by explicit user action"):window?.navigator?.storage?.persist().then((e=>{e?console.log("Storage will not be cleared except by explicit user action"):console.log("Storage may be cleared by the UA under storage pressure.")}))}))}async setViewedStudy(e){await this.dataSource.retrieve.series.metadata({StudyInstanceUID:e});const t=o.DicomMetadataStore.getStudy(e).series.flatMap((e=>e.instances.flatMap((e=>e.imageId)))).map((e=>e.split(":").slice(1).join(":"))),a=at().cache.getScope;Pe().uniq(t.map((e=>a({url:e})))).forEach((async e=>{const t=await caches.open(e);(await t.keys()).forEach((async e=>{const a=await t.match(e.url,{ignoreVary:!0,ignoreMethod:!0,ignoreSearch:!0});if(!a)return;const s=new Request(e.url,{headers:{"dicom-last-put-date":(new Date).toUTCString(),"dicom-last-viewed-date":(new Date).toUTCString(),"dicom-content-length":e.headers.get("dicom-content-length")}});a&&t.put(s,a)}))}))}async cacheStudy(e,t=void 0){const a=["1.2.840.10008.5.1.4.1.1.66.4"];await this.dataSource.retrieve.series.metadata({StudyInstanceUID:e,buckets:t});const s=o.DicomMetadataStore.getStudy(e).series.filter((e=>!a.includes(e.instances[0].SOPClassUID))).flatMap((e=>e.instances.flatMap((e=>e.imageId))));this.cacheImageIds(s),this.cacheSegFiles(e)}async cacheSeries(e,t){await this.dataSource.retrieve.series.metadata({StudyInstanceUID:e});const a=o.DicomMetadataStore.getStudy(e).series.filter((e=>e.SeriesInstanceUID===t)).flatMap((e=>e.instances.flatMap((e=>e.imageId))));this.cacheImageIds(a)}cacheImageIds(e){function t(e,t){return je.imageLoader.loadAndCacheImage(e,t).then((e=>{this._broadcastEvent(this.EVENTS.IMAGE_CACHE_PREFETCHED,{imageLoadObject:e})}),(e=>{console.error(e)}))}const a=je.Enums.RequestType.Prefetch,s={preScale:{enabled:!0},useRGBA:!0};e.forEach((e=>{const n={imageId:e};je.imageLoadPoolManager.addRequest(t.bind(this,e,s),a,n,0)}))}cacheSegFiles(e){const t=["1.2.840.10008.5.1.4.1.1.66.4"],{displaySetService:a,userAuthenticationService:s}=this.servicesManager.services,n=o.DicomMetadataStore.getStudy(e),r=s.getAuthorizationHeader();n.series.forEach((e=>{const{SOPClassUID:s,SeriesInstanceUID:n,url:i}=e.instances[0];if(t.includes(s)){const{scheme:e,url:t}=tt.wadouri.parseImageId(i);if("dicomzip"===e)return tt.wadouri.loadZipRequest(t,i);const s=a.getDisplaySetsForSeries(n)[0];if(this.imageIdToFileUriMap.get(i)===s.instance.imageId)return;fetch(t,{headers:r}).then((e=>e.arrayBuffer())).then((e=>tt.wadouri.fileManager.add(new Blob([e])))).then((e=>{this.imageIdToFileUriMap.set(i,e),s.instance.imageId=e,s.instance.getImageId=()=>e}))}}))}async cacheMissingStudyImageIds(e){const t=(await window.caches.keys()).map((e=>e.split("studies/")[1].split("/")[0]));e.filter((e=>-1===t.indexOf(e))).forEach((e=>{this.cacheStudy(e)}))}async handleQuotaExceededWriteError(e){(await window.caches.keys()).forEach((async e=>{try{const t=await caches.open(e),a=await t.keys(),s=a[0].headers.get("dicom-last-viewed-date"),n=a[0].headers.get("dicom-last-put-date"),r=n?new Date(n):new Date,i=new Date;("undefined"!==s||i-r>7*864e5)&&window.caches.delete(e)}catch(e){console.error(e)}}))}destroy(){je.eventTarget.removeEventListener("CORNERSTONE_CACHE_QUOTA_EXCEEDED_ERROR",this.handleQuotaExceededWriteError)}}const rt={id:Ge,getDataSourcesModule:({servicesManager:e})=>$e({servicesManager:e}),getHangingProtocolModule:we,getPanelModule:Ie,getViewportModule:De,preRegistration({servicesManager:e,commandsManager:t,extensionManager:a}){var s;e.registerService(function(e,t,a){return{name:"GoogleSheetsService",create:({configuration:s={}})=>new Qe(e,t,a)}}(e,t,a)),e.registerService((s=e,{name:"CropDisplayAreaService",create:({configuration:e={}})=>new et(s)})),e.registerService(function(e,t,a){return{name:"CacheAPIService",create:({configuration:s={}})=>new nt(e,t,a)}}(e,t,a));const{HangingProtocolService:n}=e.services;n.addCustomAttribute("ViewCodeSequence","ViewCodeSequence",(e=>(e.ViewCodeSequence??((e.images||e.others||[])[0]||{}).ViewCodeSequence)[0].CodeValue))}}},88658:()=>{},7189:()=>{},89891:()=>{},56064:()=>{},88218:()=>{}}]);
//# sourceMappingURL=554.bundle.dfab85cad0ec119899e1.js.map