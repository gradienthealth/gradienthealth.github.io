"use strict";(globalThis.webpackChunk=globalThis.webpackChunk||[]).push([[603,579],{20305:(e,t,n)=>{n.r(t),n.d(t,{default:()=>Y});const a=JSON.parse('{"u2":"@ohif/extension-cornerstone-dicom-seg"}').u2,o=`${a}.sopClassHandlerModule.dicom-seg`;var i=n(43001),r=n(71771),s=n(56388),c=n(80135),l=n(6154),d=n(67540);const g=["1.2.840.10008.5.1.4.1.1.66.4"];let S={};function m(e,t,n){const a=e[0],{StudyInstanceUID:i,SeriesInstanceUID:m,SOPInstanceUID:u,SeriesDescription:p,SeriesNumber:v,SeriesDate:E,SOPClassUID:h,wadoRoot:I,wadoUri:y,wadoUriRoot:R}=a,T={Modality:"SEG",loading:!1,isReconstructable:!0,displaySetInstanceUID:r.utils.guid(),SeriesDescription:p,SeriesNumber:v,SeriesDate:E,SOPInstanceUID:u,SeriesInstanceUID:m,StudyInstanceUID:i,SOPClassHandlerId:o,SOPClassUID:h,referencedImages:null,referencedSeriesInstanceUID:null,referencedDisplaySetInstanceUID:null,isDerivedDisplaySet:!0,isLoaded:!1,isHydrated:!1,segments:{},sopClassUids:g,instance:a,instances:[a],wadoRoot:I,wadoUriRoot:R,wadoUri:y,isOverlayDisplaySet:!0},b=a.ReferencedSeriesSequence;if(!b)return void console.error("ReferencedSeriesSequence is missing for the SEG");const C=b[0]||b;return T.referencedImages=a.ReferencedSeriesSequence.ReferencedInstanceSequence,T.referencedSeriesInstanceUID=C.SeriesInstanceUID,T.getReferenceDisplaySet=()=>{const{displaySetService:e}=t.services,n=e.getDisplaySetsForSeries(T.referencedSeriesInstanceUID);if(!n||0===n.length)throw new Error("Referenced DisplaySet is missing for the SEG");const a=n[0];T.referencedDisplaySetInstanceUID=a.displaySetInstanceUID,T.referencedVolumeURI=a.displaySetInstanceUID;const o=`cornerstoneStreamingImageVolume:${T.referencedVolumeURI}`;return T.referencedVolumeId=o,a},T.load=async({headers:e})=>await function(e,t,n,a){const{SOPInstanceUID:o}=e,{segmentationService:i}=t.services;if((e.loading||e.isLoaded)&&S[o]&&function(e,t){return t.getSegmentation(e.displaySetInstanceUID)}(e,i))return S[o];return e.loading=!0,S[o]=new Promise((async(o,r)=>{e.segments&&0!==Object.keys(e.segments).length||await async function({extensionManager:e,servicesManager:t,segDisplaySet:n,headers:a}){const o=e.getModuleEntry("@ohif/extension-cornerstone.utilityModule.common"),{segmentationService:i,uiNotificationService:r,displaySetService:g}=t.services,{dicomLoaderService:S}=o.exports,m=await S.findDicomDataPromise(n,null,a),u=g.getDisplaySetByUID(n.referencedDisplaySetInstanceUID);let p;if(u.isReconstructable){const e=s.cache.getVolume(n.referencedVolumeId);p=e.imageIds||e._imageIds}else p=u.instances.map((e=>e.imageId));const v=.001,E=!0;s.eventTarget.addEventListener(l.Y.Events.SEGMENTATION_LOAD_PROGRESS,(e=>{const{percentComplete:t}=e.detail;i._broadcastEvent(i.EVENTS.SEGMENT_LOADING_COMPLETE,{percentComplete:t})}));const h=await l.adaptersSEG.Cornerstone3D.Segmentation.generateToolState(p,m,s.metaData,{skipOverlapping:E,tolerance:v,eventTarget:s.eventTarget,triggerEvent:s.triggerEvent});let I=!0;h.segMetadata.data.forEach(((e,t)=>{var n;t>0&&(e.rgba=e.RecommendedDisplayCIELabValue,e.rgba?e.rgba=(n=e.rgba,d.default.data.Colors.dicomlab2RGB(n).map((e=>Math.round(255*e)))):(I=!1,e.rgba=c.CONSTANTS.COLOR_LUT[t%c.CONSTANTS.COLOR_LUT.length]))})),Object.assign(n,h)}({extensionManager:n,servicesManager:t,segDisplaySet:e,headers:a});const g=!0;i.createSegmentationForSEGDisplaySet(e,null,g).then((()=>{e.loading=!1,o()})).catch((t=>{e.loading=!1,r(t)}))})),S[o]}(T,t,n,e),[T]}const u=function({servicesManager:e,extensionManager:t}){return[{name:"dicom-seg",sopClassUids:g,getDisplaySetsFromSeries:n=>m(n,e,t)}]},p={id:"@ohif/seg",name:"Segmentations",protocolMatchingRules:[],toolGroupIds:["default"],numberOfPriorsReferenced:0,defaultViewport:{viewportOptions:{viewportType:"stack",toolGroupId:"default",allowUnmatchedView:!0},displaySets:[{id:"segDisplaySetId",matchedDisplaySetsIndex:-1}]},displaySetSelectors:{segDisplaySetId:{seriesMatchingRules:[{attribute:"Modality",constraint:{equals:"SEG"}}]}},stages:[{name:"Segmentations",viewportStructure:{layoutType:"grid",properties:{rows:1,columns:1}},viewports:[{viewportOptions:{allowUnmatchedView:!0},displaySets:[{id:"segDisplaySetId"}]}]}]};const v=function(){return[{name:p.id,protocol:p}]};var E=n(62657),h=n(78738),I=n(3827),y=n.n(I),R=n(95303);const T=function(e,t,n){const a="enter-segment-label",o=({action:t,value:o})=>{switch(t.id){case"save":n(o.label,t.id);break;case"cancel":n("",t.id)}e.dismiss({id:a})};e&&e.create({id:a,centralize:!0,isDraggable:!1,showOverlay:!0,content:R.Vq,contentProps:{title:"Segment",value:{label:t},noCloseButton:!0,onClose:()=>e.dismiss({id:a}),actions:[{id:"cancel",text:"Cancel",type:R.LZ.dt.secondary},{id:"save",text:"Confirm",type:R.LZ.dt.primary}],onSubmit:o,body:({value:e,setValue:t})=>i.createElement(R.II,{label:"Enter the segment label",labelClassName:"text-white text-[14px] leading-[1.2]",autoFocus:!0,className:"border-primary-main bg-black",type:"text",value:e.label,onChange:e=>{e.persist(),t((t=>({...t,label:e.target.value})))},onKeyPress:t=>{"Enter"===t.key&&o({value:e,action:{id:"save"}})}})}})};var b=n(22831);const C=function(e,t,n){const a="pick-color",o=({action:t,value:o})=>{switch(t.id){case"save":n(o.rgbaColor,t.id);break;case"cancel":n("",t.id)}e.dismiss({id:a})};e&&e.create({id:a,centralize:!0,isDraggable:!1,showOverlay:!0,content:R.Vq,contentProps:{title:"Segment Color",value:{rgbaColor:t},noCloseButton:!0,onClose:()=>e.dismiss({id:a}),actions:[{id:"cancel",text:"Cancel",type:"primary"},{id:"save",text:"Save",type:"secondary"}],onSubmit:o,body:({value:e,setValue:t})=>i.createElement(b.AI,{color:e.rgbaColor,onChange:e=>{t({rgbaColor:e.rgb})},presetColors:[],width:300})}})};var D=n(69190);function f({servicesManager:e,commandsManager:t,extensionManager:n,configuration:a}){const{segmentationService:o,viewportGridService:r,uiDialogService:s,displaySetService:c,userAuthenticationService:l}=e.services,{t:d}=(0,D.$G)("PanelSegmentation"),[g,S]=(0,i.useState)(null),[m,u]=(0,i.useState)(o.getConfiguration()),[p,v]=(0,i.useState)((()=>o.getSegmentations()));(0,i.useEffect)((()=>{const e=o.EVENTS.SEGMENTATION_ADDED,t=o.EVENTS.SEGMENTATION_UPDATED,n=o.EVENTS.SEGMENTATION_REMOVED,a=[];return[e,t,n].forEach((e=>{const{unsubscribe:t}=o.subscribe(e,(()=>{const e=o.getSegmentations();v(e),u(o.getConfiguration())}));a.push(t)})),()=>{a.forEach((e=>{e()}))}}),[]);const E=e=>{I(e);const t=p.find((t=>t.id===e))?.isActive;t||o.setActiveSegmentationForToolGroup(e)},I=e=>{const t=c.getDisplaySetByUID(e);if(!t)return;const n=t.referencedDisplaySetInstanceUID,{viewports:a,activeViewportId:o}=r.getState();let i=!1;a.forEach((e=>{e.displaySetInstanceUIDs.includes(n)&&(i=!0)})),i||(r.setDisplaySetsForViewport({viewportId:o,displaySetInstanceUIDs:[n,e]}),t.load({headers:l.getAuthorizationHeader()}))},y=e=>o.getToolGroupIdsWithSegmentation(e),b=(0,i.useCallback)(((e,t,n)=>{o.setConfiguration({segmentationId:e,[t]:n})}),[o]);return i.createElement(i.Fragment,null,i.createElement("div",{className:"ohif-scrollbar flex min-h-0 flex-auto select-none flex-col justify-between overflow-auto"},i.createElement(R.cX,{title:d("Segmentations"),segmentations:p,disableEditing:a.disableEditing,activeSegmentationId:g||"",onSegmentationAdd:async()=>{t.runCommand("createEmptySegmentationForViewport")},onSegmentationClick:e=>{I(e),o.setActiveSegmentationForToolGroup(e)},onSegmentationDelete:e=>{E(e),o.remove(e)},onSegmentationDownload:e=>{E(e),t.runCommand("downloadSegmentation",{segmentationId:e})},onSegmentationDownloadRTSS:e=>{E(e),t.runCommand("downloadRTSS",{segmentationId:e})},storeSegmentation:async a=>{E(a);const i=n.getActiveDataSource(),s=await(0,h.createReportAsync)({servicesManager:e,getReport:()=>t.runCommand("storeSegmentation",{segmentationId:a,dataSource:i[0]}),reportType:"Segmentation"});s&&(o.remove(a),r.setDisplaySetsForViewport({viewportId:r.getActiveViewportId(),displaySetInstanceUIDs:s}))},onSegmentationEdit:e=>{E(e);const t=o.getSegmentation(e),{label:n}=t;T(s,n,((t,n)=>{""!==t&&o.addOrUpdateSegmentation({id:e,label:t},!1,!0)}))},onSegmentClick:(e,t)=>{I(e),o.setActiveSegment(e,t);y(e).forEach((n=>{o.setActiveSegmentationForToolGroup(e,n),o.jumpToSegmentCenter(e,t,n)}))},onSegmentEdit:(e,t)=>{E(e);const n=o.getSegmentation(e).segments[t],{label:a}=n;T(s,a,((n,a)=>{""!==n&&o.setSegmentLabel(e,t,n)}))},onSegmentAdd:e=>{E(e),o.addSegment(e)},onSegmentColorClick:(e,t)=>{E(e);const n=o.getSegmentation(e).segments[t],{color:a,opacity:i}=n,r={r:a[0],g:a[1],b:a[2],a:i/255};C(s,r,((n,a)=>{"cancel"!==a&&o.setSegmentRGBAColor(e,t,[n.r,n.g,n.b,255*n.a])}))},onSegmentDelete:(e,t)=>{E(e),o.removeSegment(e,t)},onToggleSegmentVisibility:(e,t)=>{E(e);const n=!o.getSegmentation(e).segments[t].isVisible;y(e).forEach((a=>{o.setSegmentVisibility(e,t,n,a)}))},onToggleSegmentLock:(e,t)=>{E(e),o.toggleSegmentLocked(e,t)},onToggleSegmentationVisibility:e=>{E(e),o.toggleSegmentationVisibility(e)},showDeleteSegment:!0,segmentationConfig:{initialConfig:m},setRenderOutline:e=>b(g,"renderOutline",e),setOutlineOpacityActive:e=>b(g,"outlineOpacity",e),setRenderFill:e=>b(g,"renderFill",e),setRenderInactiveSegmentations:e=>b(g,"renderInactiveSegmentations",e),setOutlineWidthActive:e=>b(g,"outlineWidthActive",e),setFillAlpha:e=>b(g,"fillAlpha",e),setFillAlphaInactive:e=>b(g,"fillAlphaInactive",e)})))}f.propTypes={commandsManager:y().shape({runCommand:y().func.isRequired}),servicesManager:y().shape({services:y().shape({segmentationService:y().shape({getSegmentation:y().func.isRequired,getSegmentations:y().func.isRequired,toggleSegmentationVisibility:y().func.isRequired,subscribe:y().func.isRequired,EVENTS:y().object.isRequired}).isRequired}).isRequired}).isRequired};const{segmentation:w}=c.utilities,O={CIRCULAR_BRUSH:"CircularBrush",SPHERE_BRUSH:"SphereBrush",CIRCULAR_ERASER:"CircularEraser",SPHERE_ERASER:"SphereEraser",CIRCLE_SHAPE:"CircleScissor",RECTANGLE_SHAPE:"RectangleScissor",SPHERE_SHAPE:"SphereScissor",THRESHOLD_CIRCULAR_BRUSH:"ThresholdCircularBrush",THRESHOLD_SPHERE_BRUSH:"ThresholdSphereBrush"},U={SET_TOOL_CONFIG:"SET_TOOL_CONFIG",SET_ACTIVE_TOOL:"SET_ACTIVE_TOOL"},A={Brush:{brushSize:15,mode:"CircularBrush"},Eraser:{brushSize:15,mode:"CircularEraser"},Shapes:{brushSize:15,mode:"CircleScissor"},ThresholdBrush:{brushSize:15,thresholdRange:[-500,500]},activeTool:null};function M(e,t){switch(t.type){case U.SET_TOOL_CONFIG:const{tool:n,config:a}=t.payload;return{...e,[n]:{...e[n],...a}};case U.SET_ACTIVE_TOOL:return{...e,activeTool:t.payload};default:return e}}function _(e){let t=[];switch(e){case"Brush":t=["CircularBrush","SphereBrush"];break;case"Eraser":t=["CircularEraser","SphereEraser"];break;case"ThresholdBrush":t=["ThresholdCircularBrush","ThresholdSphereBrush"]}return t}const L=function({servicesManager:e,extensionManager:t}){const{toolbarService:n,segmentationService:a,toolGroupService:o}=e.services,[r]=(0,R.O_)(),{viewports:s,activeViewportId:c}=r,[l,d]=(0,i.useState)(!1),[g,S]=(0,i.useReducer)(M,A),m=(0,i.useCallback)((()=>{if(!s?.size||void 0===c)return;const e=s.get(c);e&&S({type:U.SET_ACTIVE_TOOL,payload:o.getActiveToolForViewport(e.viewportId)})}),[c,s,o,S]),u=(0,i.useCallback)((e=>{n.recordInteraction({interactionType:"tool",commands:[{commandName:"setToolActive",commandOptions:{toolName:e}}]}),S({type:U.SET_ACTIVE_TOOL,payload:e})}),[n,S]);(0,i.useEffect)((()=>{const e=[a.EVENTS.SEGMENTATION_ADDED,a.EVENTS.SEGMENTATION_UPDATED,a.EVENTS.SEGMENTATION_REMOVED],t=[];return e.forEach((e=>{const{unsubscribe:n}=a.subscribe(e,(()=>{const e=a.getSegmentations(),t=e?.find((e=>e.isActive));d(t?.segmentCount>0)}));t.push(n)})),m(),()=>{t.forEach((e=>e()))}}),[c,s,a,m]),(0,i.useEffect)((()=>{const{unsubscribe:e}=n.subscribe(n.EVENTS.TOOL_BAR_STATE_MODIFIED,(()=>{m()}));return()=>{e()}}),[n,m]),(0,i.useEffect)((()=>{Object.values(O).includes(g.activeTool)&&(l||u("WindowLevel"))}),[l,g.activeTool,u]);const p=(0,i.useCallback)(((e,t)=>{o.getToolGroupIds()?.forEach((n=>{w.setBrushSizeForToolGroup(n,t,e)}))}),[o]),v=(0,i.useCallback)(((e,t)=>{const n=Number(e);_(t).forEach((e=>{p(e,n)})),S({type:U.SET_TOOL_CONFIG,payload:{tool:t,config:{brushSize:n}}})}),[o,S]),E=(0,i.useCallback)((e=>{if(e[0]===g.ThresholdBrush.thresholdRange[0]&&e[1]===g.ThresholdBrush.thresholdRange[1])return;_("ThresholdBrush").forEach((t=>{o.getToolGroupIds()?.forEach((n=>{o.getToolGroup(n).setToolConfiguration(t,{strategySpecificConfiguration:{THRESHOLD_INSIDE_CIRCLE:{threshold:e}}})}))})),S({type:U.SET_TOOL_CONFIG,payload:{tool:"ThresholdBrush",config:{thresholdRange:e}}})}),[o,S,g.ThresholdBrush.thresholdRange]);return i.createElement(R.bY,{title:"Segmentation Tools",items:[{name:"Brush",icon:"icon-tool-brush",disabled:!l,active:g.activeTool===O.CIRCULAR_BRUSH||g.activeTool===O.SPHERE_BRUSH,onClick:()=>u(O.CIRCULAR_BRUSH),options:[{name:"Radius (mm)",id:"brush-radius",type:"range",min:.5,max:99.5,value:g.Brush.brushSize,step:.5,onChange:e=>v(e,"Brush")},{name:"Mode",type:"radio",id:"brush-mode",value:g.Brush.mode,values:[{value:O.CIRCULAR_BRUSH,label:"Circle"},{value:O.SPHERE_BRUSH,label:"Sphere"}],onChange:e=>u(e)}]},{name:"Eraser",icon:"icon-tool-eraser",disabled:!l,active:g.activeTool===O.CIRCULAR_ERASER||g.activeTool===O.SPHERE_ERASER,onClick:()=>u(O.CIRCULAR_ERASER),options:[{name:"Radius (mm)",type:"range",id:"eraser-radius",min:.5,max:99.5,value:g.Eraser.brushSize,step:.5,onChange:e=>v(e,"Eraser")},{name:"Mode",type:"radio",id:"eraser-mode",value:g.Eraser.mode,values:[{value:O.CIRCULAR_ERASER,label:"Circle"},{value:O.SPHERE_ERASER,label:"Sphere"}],onChange:e=>u(e)}]},{name:"Shapes",icon:"icon-tool-shape",disabled:!l,active:g.activeTool===O.CIRCLE_SHAPE||g.activeTool===O.RECTANGLE_SHAPE||g.activeTool===O.SPHERE_SHAPE,onClick:()=>u(O.CIRCLE_SHAPE),options:[{name:"Mode",type:"radio",value:g.Shapes.mode,id:"shape-mode",values:[{value:O.CIRCLE_SHAPE,label:"Circle"},{value:O.RECTANGLE_SHAPE,label:"Rectangle"},{value:O.SPHERE_SHAPE,label:"Sphere"}],onChange:e=>u(e)}]},{name:"Threshold Tool",icon:"icon-tool-threshold",disabled:!l,active:g.activeTool===O.THRESHOLD_CIRCULAR_BRUSH||g.activeTool===O.THRESHOLD_SPHERE_BRUSH,onClick:()=>u(O.THRESHOLD_CIRCULAR_BRUSH),options:[{name:"Radius (mm)",id:"threshold-radius",type:"range",min:.5,max:99.5,value:g.ThresholdBrush.brushSize,step:.5,onChange:e=>v(e,"ThresholdBrush")},{name:"Mode",type:"radio",id:"threshold-mode",value:g.activeTool,values:[{value:O.THRESHOLD_CIRCULAR_BRUSH,label:"Circle"},{value:O.THRESHOLD_SPHERE_BRUSH,label:"Sphere"}],onChange:e=>u(e)},{type:"custom",id:"segmentation-threshold-range",children:()=>i.createElement("div",null,i.createElement("div",{className:"bg-secondary-light h-[1px]"}),i.createElement("div",{className:"mt-1 text-[13px] text-white"},"Threshold"),i.createElement(R.R0,{values:g.ThresholdBrush.thresholdRange,onChange:E,minValue:-1e3,maxValue:1e3,step:1,showLabel:!0,allowNumberEdit:!0,showAdjustmentArrows:!1}))}]}]})},V=({commandsManager:e,servicesManager:t,extensionManager:n,configuration:a})=>{const{customizationService:o}=t.services;return[{name:"panelSegmentation",iconName:"tab-segmentation",iconLabel:"Segmentation",label:"Segmentation",component:a=>{const[r]=(0,E.M)(),s=o.get("segmentation.disableEditing");return i.createElement(f,{commandsManager:e,servicesManager:t,extensionManager:n,configuration:{...a,disableEditing:r.disableEditing||s?.value}})}},{name:"panelSegmentationWithTools",iconName:"tab-segmentation",iconLabel:"Segmentation",label:"Segmentation",component:a=>{const[o]=(0,E.M)();return i.createElement(i.Fragment,null,i.createElement(L,{commandsManager:e,servicesManager:t,extensionManager:n,configuration:{...a}}),i.createElement(f,{commandsManager:e,servicesManager:t,extensionManager:n,configuration:{...a}}))}}]};var N=n(96538),H=n(54131),F=n(96372);async function G({viewportId:e,loadFn:t,servicesManager:n,referencedDisplaySetInstanceUID:a}){const{cornerstoneViewportService:o,segmentationService:i,viewportGridService:r,displaySetService:c}=n.services,l=P({viewportId:e,viewportGridService:r}),d=l.viewportOptions.viewportId,g=B({servicesManager:n,viewportId:e,referencedDisplaySetInstanceUID:a=a||l?.displaySetInstanceUIDs[0]}),S=async()=>{const e=await t();i.hydrateSegmentation(e)},m=Array.from(s.cache._volumeCache.keys()).some((e=>e.includes(a))),u=c.getDisplaySetByUID(a);return g.forEach((async e=>{e.viewportOptions={...e.viewportOptions,viewportType:u.isReconstructable?"volume":"stack",needsRerendering:!0};const t=e.viewportId,n=o.getCornerstoneViewport(t),i=n.getCamera();if(m&&t===d)return void await S();const r=u.isReconstructable?s.Enums.Events.VOLUME_VIEWPORT_NEW_VOLUME:s.Enums.Events.STACK_VIEWPORT_NEW_STACK,c=u.isReconstructable?n.element:s.eventTarget,l=async e=>{const n=e.detail.volumeActors?.find((e=>e.uid.includes(a)));o.getCornerstoneViewport(t).setCamera(i),c.removeEventListener(r,l),u.isReconstructable&&!n||t===d&&await S()};c.addEventListener(r,l)})),r.setDisplaySetsForViewports(g),!0}const P=({viewportId:e,viewportGridService:t})=>{const{viewports:n,activeViewportId:a}=t.getState(),o=e||a;return n.get(o)};function B({viewportId:e,servicesManager:t,referencedDisplaySetInstanceUID:n}){const{hangingProtocolService:a,displaySetService:o,segmentationService:i,viewportGridService:r}=t.services,{viewports:s}=r.getState(),c=P({viewportId:e,viewportGridService:r}).viewportOptions.viewportId,l=s.get(c).displaySetInstanceUIDs,d=n||l[0],g=o.getDisplaySetByUID(d).instances[0].FrameOfReferenceUID,S=a.getViewportsRequireUpdate(c,d);return s.forEach(((e,t)=>{if(c===t||S.find((e=>e.viewportId===t)))return;i.shouldRenderSegmentation(e.displaySetInstanceUIDs,g)&&S.push({viewportId:t,displaySetInstanceUIDs:e.displaySetInstanceUIDs,viewportOptions:{viewportType:e.viewportType,needsRerendering:!0}})})),S}const x=e=>{const t=[],n=[],a=new Set;Array.from(e.entries()).forEach(((e,o)=>{n.push(s.cache.getImage(e[0]));const i=s.cache.getImage(e[1]),{rows:r,columns:c}=i,l=i.getPixelData(),d=[];for(let e=0;e<l.length;e++){const t=l[e];d.includes(t)||0===t||d.push(t)}d.length&&(t[o]={segmentsOnLabelmap:d,pixelData:l,rows:r,columns:c},d.forEach((e=>{a.add(e)})))}));const o={segmentsOnLabelmap:Array.from(a),labelmaps2D:t};return{referencedImages:n,labelmapObj:o}},{datasetToBlob:k}=d.default.data,{Cornerstone3D:{Segmentation:{generateLabelMaps2DFrom3D:q,generateSegmentation:z}}}=l.adaptersSEG,{Cornerstone3D:{RTSS:{generateRTSSFromSegmentations:j}}}=l.adaptersRT,{downloadDICOMData:W}=l.helpers,K=({servicesManager:e,extensionManager:t})=>{const{uiNotificationService:n,segmentationService:a,uiDialogService:o,displaySetService:i,viewportGridService:l}=e.services,g={getUpdatedViewportsForSegmentation:B,createEmptySegmentationForViewport:async({viewportId:t})=>{const n=P({viewportId:t,viewportGridService:l}),o=n.displaySetInstanceUIDs[0];G({viewportId:t,servicesManager:e,loadFn:async()=>{const e=a.getSegmentations(),t=await a.createSegmentationForDisplaySet(o,{label:`Segmentation ${e.length+1}`}),i=n.viewportOptions.toolGroupId;return await a.addSegmentationRepresentationToToolGroup(i,t),a.addSegment(t,{toolGroupId:i,segmentIndex:1,properties:{label:"Segment 1"}}),t}})},loadSegmentationsForViewport:async({segmentations:t,viewportId:n})=>{G({viewportId:n,servicesManager:e,loadFn:async()=>{const e=P({viewportId:n,viewportGridService:l}),o=e.displaySetInstanceUIDs[0],i=t[0],r=i.id,s=i.label,c=i.segments;if(delete i.segments,await a.createSegmentationForDisplaySet(o,{segmentationId:r,label:s}),i.scalarData){a.getLabelmapVolume(r).scalarData.set(i.scalarData)}a.addOrUpdateSegmentation(i);const d=e.viewportOptions.toolGroupId;return await a.addSegmentationRepresentationToToolGroup(d,r),c.forEach((e=>{null!==e&&a.addSegment(r,{segmentIndex:e.segmentIndex,toolGroupId:d,properties:{color:e.color,label:e.label,opacity:e.opacity,isLocked:e.isLocked,visibility:e.isVisible,active:i.activeSegmentIndex===e.segmentIndex}})})),i.centroidsIJK&&a.setCentroids(i.id,i.centroidsIJK),r}})},loadSegmentationDisplaySetsForViewport:async({viewportId:t,displaySets:n})=>{const o=n[0];G({viewportId:t,servicesManager:e,referencedDisplaySetInstanceUID:o.referencedDisplaySetInstanceUID,loadFn:async()=>{const e=o,t="SEG"===e.Modality?"createSegmentationForSEGDisplaySet":"createSegmentationForRTDisplaySet",n=a[t].bind(a);return await n(e,null,!1)}})},generateSegmentation:({segmentationId:e,options:t={}})=>{const n=c.segmentation.state.getSegmentation(e),o=n.representationData.LABELMAP;let i,r;if(n.representationData.LABELMAP.referencedVolumeId){const{referencedVolumeId:t}=o,n=s.cache.getVolume(e);i=s.cache.getVolume(t).getCornerstoneImages(),r=q(n)}else{const{imageIdReferenceMap:e}=o;({referencedImages:i,labelmapObj:r}=x(e))}r.metadata=[];const l=a.getSegmentation(e);r.segmentsOnLabelmap.forEach((e=>{const t=l?.segments[e],{label:n,color:a}=t,o=d.default.data.Colors.rgb2DICOMLAB(a.slice(0,3).map((e=>e/255))).map((e=>Math.round(e))),i={SegmentNumber:e.toString(),SegmentLabel:n,SegmentAlgorithmType:"MANUAL",SegmentAlgorithmName:"OHIF Brush",RecommendedDisplayCIELabValue:o,SegmentedPropertyCategoryCodeSequence:{CodeValue:"T-D0050",CodingSchemeDesignator:"SRT",CodeMeaning:"Tissue"},SegmentedPropertyTypeCodeSequence:{CodeValue:"T-D0050",CodingSchemeDesignator:"SRT",CodeMeaning:"Tissue"}};r.metadata[e]=i}));return z(i,r,s.metaData,t)},downloadSegmentation:({segmentationId:e})=>{const t=a.getSegmentation(e),n=g.generateSegmentation({segmentationId:e});W(n.dataset,`${t.label}`)},storeSegmentation:async({segmentationId:e,dataSource:n})=>{const r=a.getSegmentation(e);if(!r)throw new Error("No segmentation found");const{label:s,displaySetInstanceUID:c}=r,l=i.getDisplaySetByUID(c),d=l&&"SEG"===l.Modality;let S={};if(!d&&(S=await(0,h.createReportDialogPrompt)(o,{extensionManager:t}),1!==S.action&&S.value))return;const m=S.value||s||"Research Derived Series",u=g.generateSegmentation({segmentationId:e,options:{SeriesDescription:m,...d&&{SeriesInstanceUID:l.SeriesInstanceUID,SOPInstanceUID:l.instances[0].SOPInstanceUID}}});if(!u||!u.dataset)throw new Error("Error during segmentation generation");const{dataset:p}=u;return await n.store.dicom(p),p.wadoRoot=n.getConfig().wadoRoot,p},downloadRTSS:({segmentationId:e})=>{const t=a.getSegmentation(e),n={vtkImageMarchingSquares:N.ZP,vtkDataArray:H.ZP,vtkImageData:F.ZP},o=j(t,r.classes.MetadataProvider,r.DicomMetadataStore,s.cache,c.Enums,n);try{const e=k(o),t=URL.createObjectURL(e);window.location.assign(t)}catch(e){console.warn(e)}}},S={getUpdatedViewportsForSegmentation:{commandFn:g.getUpdatedViewportsForSegmentation},loadSegmentationDisplaySetsForViewport:{commandFn:g.loadSegmentationDisplaySetsForViewport},loadSegmentationsForViewport:{commandFn:g.loadSegmentationsForViewport},createEmptySegmentationForViewport:{commandFn:g.createEmptySegmentationForViewport},generateSegmentation:{commandFn:g.generateSegmentation},downloadSegmentation:{commandFn:g.downloadSegmentation},storeSegmentation:{commandFn:g.storeSegmentation},downloadRTSS:{commandFn:g.downloadRTSS}};return{actions:g,definitions:S}};function Z(){return Z=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var a in n)Object.prototype.hasOwnProperty.call(n,a)&&(e[a]=n[a])}return e},Z.apply(this,arguments)}const $=i.lazy((()=>n.e(451).then(n.bind(n,4451)))),J=e=>i.createElement(i.Suspense,{fallback:i.createElement("div",null,"Loading...")},i.createElement($,e)),Y={id:a,preRegistration:function({configuration:e={}}){(0,c.addTool)(c.BrushTool)},getPanelModule:V,getCommandsModule:K,getViewportModule:({servicesManager:e,extensionManager:t})=>[{name:"dicom-seg",component:n=>i.createElement(J,Z({servicesManager:e,extensionManager:t,commandsManager},n))}],getSopClassHandlerModule:u,getHangingProtocolModule:v}}}]);
//# sourceMappingURL=603.bundle.fac7ec7fa8275b77f2ec.js.map