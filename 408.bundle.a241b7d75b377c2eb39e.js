"use strict";(globalThis.webpackChunk=globalThis.webpackChunk||[]).push([[408],{56018:(e,t,n)=>{n.r(t),n.d(t,{ImageOverlayViewerTool:()=>H,Types:()=>a,default:()=>_n,getActiveViewportEnabledElement:()=>L,measurementMappingUtils:()=>o,toolNames:()=>Z});var o={};n.r(o),n.d(o,{getDisplayUnit:()=>ne,getFirstAnnotationSelected:()=>te,getHandlesFromPoints:()=>Q,getSOPInstanceAttributes:()=>K.Z,isAnnotationSelected:()=>X,setAnnotationSelected:()=>ee});var a={};n.r(a);var r=n(43001),i=n(56388),s=n(80135),l=n(71771),c=n(45451);const{createUint8SharedArray:d,createFloat32SharedArray:m}=i.utilities;const u=e=>{const t=function(e){const t=(0,i.getRenderingEngines)(),n=[];for(let o=0;o<t.length;o++){const a=t[o],r=i.utilities.getViewportsWithVolumeId(e,a.id);r.length&&n.push({renderingEngine:a,viewportIds:r.map((e=>e.id))})}return n}(e);t&&t.length&&t.forEach((({renderingEngine:e,viewportIds:t})=>{e.hasBeenDestroyed||e.renderViewports(t)}))};function g(e,t){const n=e.length,{rescaleSlope:o,rescaleIntercept:a,suvbw:r}=t;if("PT"===t.modality&&"number"==typeof r)for(let t=0;t<n;t++)e[t]=r*(e[t]*o+a);else for(let t=0;t<n;t++)e[t]=e[t]*o+a;return e}const p=i.Enums.RequestType.Prefetch,{getMinMax:h,ProgressiveIterator:I}=i.utilities,{ImageQualityStatus:S}=i.Enums,{imageRetrieveMetadataProvider:f}=i.utilities;class v extends i.ImageVolume{constructor(e,t){super(e),this.framesLoaded=0,this.framesProcessed=0,this.framesUpdated=0,this.cornerstoneImageMetaData=null,this.autoRenderOnLoad=!0,this.cachedFrames=[],this.reRenderTarget=0,this.reRenderFraction=2,this.imagesLoader=this,this.cancelLoading=()=>{const{loadStatus:e}=this;if(!e||!e.loading)return;e.loading=!1,e.cancelled=!0,this.clearLoadCallbacks();i.imageLoadPoolManager.filterRequests((({additionalDetails:e})=>e.volumeId!==this.volumeId))},this.load=e=>{const{imageIds:t,loadStatus:n,numFrames:o}=this,{transferSyntaxUID:a}=i.metaData.get("transferSyntax",t[0])||{},r=i.metaData.get(f.IMAGE_RETRIEVE_CONFIGURATION,this.volumeId,a,"volume");if(this.imagesLoader=r?(r.create||i.ProgressiveRetrieveImages.createProgressive)(r):this,!0===n.loading)return;const{loaded:s}=this.loadStatus,l=t.length;s?e&&e({success:!0,framesLoaded:l,framesProcessed:l,numFrames:o,totalNumFrames:l}):(e&&this.loadStatus.callbacks.push(e),this._prefetchImageIds())},this.imageIds=t.imageIds,this.loadStatus=t.loadStatus,this.numFrames=this._getNumFrames(),this._createCornerstoneImageMetaData()}_getNumFrames(){const{imageIds:e,scalarData:t}=this,n=this.isDynamicVolume()?t.length:1;return e.length/n}_getScalarDataLength(){const{scalarData:e}=this;return this.isDynamicVolume()?e[0].length:e.length}_createCornerstoneImageMetaData(){const{numFrames:e}=this;if(0===e)return;const t=this.sizeInBytes/e,n=this._getScalarDataLength()/this.numVoxels,o=this.dimensions[0]*this.dimensions[1]*n,{PhotometricInterpretation:a,voiLut:r,VOILUTFunction:i}=this.metadata;let s=[],l=[];r&&r.length&&(s=r.map((e=>e.windowCenter)),l=r.map((e=>e.windowWidth)));const c=n>1;this.cornerstoneImageMetaData={bytesPerImage:t,numComponents:n,pixelsPerImage:o,windowCenter:s,windowWidth:l,color:c,rgba:!1,spacing:this.spacing,dimensions:this.dimensions,photometricInterpretation:a,voiLUTFunction:i,invert:"MONOCHROME1"===a}}_imageIdIndexToFrameIndex(e){return e%this.numFrames}getScalarDataArrays(){return this.isDynamicVolume()?this.scalarData:[this.scalarData]}_getScalarDataByImageIdIndex(e){if(e<0||e>=this.imageIds.length)throw new Error("imageIdIndex out of range");return this.getScalarDataArrays()[Math.floor(e/this.numFrames)]}invalidateVolume(e){const{imageData:t,vtkOpenGLTexture:n}=this,{numFrames:o}=this;for(let e=0;e<o;e++)n.setUpdatedFrame(e);t.modified(),e&&u(this.volumeId)}clearLoadCallbacks(){this.loadStatus.callbacks=[]}callLoadStatusCallback(e){const{framesUpdated:t,framesProcessed:n,totalNumFrames:o}=e,{volumeId:a,reRenderFraction:r,loadStatus:s,metadata:l}=this,{FrameOfReferenceUID:c}=l;if(this.autoRenderOnLoad&&(t>this.reRenderTarget||n===o)&&(this.reRenderTarget+=r,u(a)),n===o){s.callbacks.forEach((t=>t(e)));const t={FrameOfReferenceUID:c,volumeId:a};(0,i.triggerEvent)(i.eventTarget,i.Enums.Events.IMAGE_VOLUME_LOADING_COMPLETED,t)}}updateTextureAndTriggerEvents(e,t,n=S.FULL_RESOLUTION){const o=this._imageIdIndexToFrameIndex(e),{cachedFrames:a,numFrames:r,totalNumFrames:s}=this,{FrameOfReferenceUID:l}=this.metadata;if(a[o]>n)return;if(a[o]===S.FULL_RESOLUTION)return;const c=n===S.FULL_RESOLUTION;a[e]=n,this.framesUpdated++,c&&(this.framesLoaded++,this.framesProcessed++),this.vtkOpenGLTexture.setUpdatedFrame(o),this.imageData.modified();const d={FrameOfReferenceUID:l,imageVolume:this};(0,i.triggerEvent)(i.eventTarget,i.Enums.Events.IMAGE_VOLUME_MODIFIED,d),c&&this.framesProcessed===this.totalNumFrames&&(this.loadStatus.loaded=!0,this.loadStatus.loading=!1),this.callLoadStatusCallback({success:!0,imageIdIndex:e,imageId:t,framesLoaded:this.framesLoaded,framesProcessed:this.framesProcessed,framesUpdated:this.framesUpdated,numFrames:r,totalNumFrames:s,complete:c,imageQualityStatus:n}),this.loadStatus.loaded&&(this.loadStatus.callbacks=[])}successCallback(e,t){const n=this.getImageIdIndex(e),o=this.getLoaderImageOptions(e),a=this._getScalarDataByImageIdIndex(n);!function(e,t,n){if(!(e.buffer instanceof ArrayBuffer))return;const o=n.targetBuffer.offset,a=n.targetBuffer.length,r=t.pixelData?t.pixelData:t.getPixelData();try{if(e instanceof Float32Array){const t=4,n=new Float32Array(r);if(n.length!==a)throw"Error pixelData length does not match frame length";e.set(n,o/t)}if(e instanceof Int16Array){const t=2,n=new Int16Array(r);if(n.length!==a)throw"Error pixelData length does not match frame length";e.set(n,o/t)}if(e instanceof Uint16Array){const t=2,n=new Uint16Array(r);if(n.length!==a)throw"Error pixelData length does not match frame length";e.set(n,o/t)}if(e instanceof Uint8Array){const t=1,n=new Uint8Array(r);if(n.length!==a)throw"Error pixelData length does not match frame length";e.set(n,o/t)}}catch(e){console.error(e)}}(a,t,o);const{scalingParameters:r}=t.preScale||{},{imageQualityStatus:s}=t,l=this._imageIdIndexToFrameIndex(n),c=i.cache.getCachedImageBasedOnImageURI(e),d=i.cache.getVolumeContainingImageId(e);if(this.loadStatus.cancelled)return void console.warn("volume load cancelled, returning for imageIdIndex: ",n);if(!(c||d&&d.volume!==this))return this.updateTextureAndTriggerEvents(n,e,s);const m=!!c,u=c||d.volume;this.handleImageComingFromCache(u,m,r,a,l,a.buffer,n,e)}errorCallback(e,t,n){if(!t)return;const{totalNumFrames:o,numFrames:a}=this,r=this.getImageIdIndex(e);this.framesProcessed++,this.framesProcessed===o&&(this.loadStatus.loaded=!0,this.loadStatus.loading=!1),this.callLoadStatusCallback({success:!1,imageId:e,imageIdIndex:r,error:n,framesLoaded:this.framesLoaded,framesProcessed:this.framesProcessed,framesUpdated:this.framesUpdated,numFrames:a,totalNumFrames:o}),this.loadStatus.loaded&&(this.loadStatus.callbacks=[]);const s={error:n,imageIdIndex:r,imageId:e};(0,i.triggerEvent)(i.eventTarget,i.Enums.Events.IMAGE_LOAD_ERROR,s)}getLoaderImageOptions(e){const{transferSyntaxUID:t}=i.metaData.get("transferSyntax",e)||{},n=i.metaData.get("imagePlaneModule",e)||{},{rows:o,columns:a}=n,r=this.getImageIdIndex(e),s=this._getScalarDataByImageIdIndex(r);if(!s)return null;const l=s.buffer,{type:c,length:d,lengthInBytes:m}=function(e,t){let n,o;if(e instanceof Uint8Array)n="Uint8Array",o=1;else if(e instanceof Float32Array)n="Float32Array",o=4;else if(e instanceof Uint16Array)n="Uint16Array",o=2;else{if(!(e instanceof Int16Array))throw new Error("Unsupported array type");n="Int16Array",o=2}const a=e.length/t,r=a*o;return{type:n,byteSize:o,length:a,lengthInBytes:r}}(s,this.numFrames),u=i.metaData.get("modalityLutModule",e)||{},g=i.metaData.get("generalSeriesModule",e)||{},p={rescaleSlope:u.rescaleSlope,rescaleIntercept:u.rescaleIntercept,modality:g.modality};if("PT"===p.modality){const t=i.metaData.get("scalingModule",e);t&&(this._addScalingToVolume(t),p.suvbw=t.suvbw)}const h="number"==typeof p.rescaleSlope&&"number"==typeof p.rescaleIntercept;this.isPreScaled=h;const I=this._imageIdIndexToFrameIndex(r);return{targetBuffer:{arrayBuffer:l instanceof ArrayBuffer?void 0:l,offset:I*m,length:d,type:c,rows:o,columns:a},skipCreateImage:!0,preScale:{enabled:!0,scalingParameters:p},transferPixelData:!0,transferSyntaxUID:t,loader:i.imageLoader.loadImage,additionalDetails:{imageId:e,imageIdIndex:r,volumeId:this.volumeId}}}callLoadImage(e,t,n){const{cachedFrames:o}=this;if(o[t]===S.FULL_RESOLUTION)return;return I.as(i.imageLoader.loadImage(e,n)).forEach((t=>{this.successCallback(e,t)}),this.errorCallback.bind(this,t,e))}getImageIdsRequests(e,t){this.totalNumFrames=this.imageIds.length;this.autoRenderOnLoad&&(this.reRenderFraction=.02*this.totalNumFrames,this.reRenderTarget=this.reRenderFraction);return e.map((e=>{const n=this.getImageIdIndex(e),o=p,a=t,r=this.getLoaderImageOptions(e);return{callLoadImage:this.callLoadImage.bind(this),imageId:e,imageIdIndex:n,options:r,priority:a,requestType:o,additionalDetails:{volumeId:this.volumeId}}}))}handleImageComingFromCache(e,t,n,o,a,r,i,s){(t?e.imageLoadObject:e.convertToCornerstoneImage(s,i)).promise.then((e=>{const t=this._scaleIfNecessary(e,n),{pixelsPerImage:l,bytesPerImage:c}=this.cornerstoneImageMetaData,d=o.constructor;let m=c*a;const u=c/l;o.BYTES_PER_ELEMENT!==u&&(m*=o.BYTES_PER_ELEMENT/u);new d(r,m,l).set(t),this.updateTextureAndTriggerEvents(i,s,e.imageQualityStatus)})).catch((e=>{this.errorCallback(s,!0,e)}))}getImageLoadRequests(e){throw new Error("Abstract method")}getImageIdsToLoad(){throw new Error("Abstract method")}loadImages(e,t){this.loadStatus.loading=!0;return this.getImageLoadRequests(5).reverse().forEach((e=>{if(!e)return;const{callLoadImage:t,imageId:n,imageIdIndex:o,options:a,priority:r,requestType:s,additionalDetails:l}=e;i.imageLoadPoolManager.addRequest(t.bind(this,n,o,a),s,l,r)})),Promise.resolve(!0)}_prefetchImageIds(){this.loadStatus.loading=!0;const e=[...this.getImageIdsToLoad()];e.reverse(),this.totalNumFrames=this.imageIds.length;return this.autoRenderOnLoad&&(this.reRenderFraction=.02*this.totalNumFrames,this.reRenderTarget=this.reRenderFraction),this.imagesLoader.loadImages(e,this).catch((e=>{console.debug("progressive loading failed to complete",e)}))}_scaleIfNecessary(e,t){const n=e.preScale?.scaled,o=!t||!t.rescaleIntercept||!t.rescaleSlope;if(!n&&o)return e.getPixelData().slice(0);if(!n&&t&&void 0!==t.rescaleIntercept&&void 0!==t.rescaleSlope){return g(e.getPixelData().slice(0),t)}const{rescaleSlope:a,rescaleIntercept:r,suvbw:i}=t,{rescaleSlope:s,rescaleIntercept:l,suvbw:c}=e.preScale.scalingParameters;if(a===s&&r===l&&i===c)return e.getPixelData();const d=i/c,m=a/s,u=r-l*m;return g(e.getPixelData().slice(0),{...t,rescaleSlope:m,rescaleIntercept:u,suvbw:d})}_addScalingToVolume(e){if(this.scaling)return;const{suvbw:t,suvlbm:n,suvbsa:o}=e,a={};n&&(a.suvbwToSuvlbm=n/t),o&&(a.suvbwToSuvbsa=o/t),t&&(a.suvbw=t),this.scaling={PT:a}}_removeFromCache(){i.cache.removeVolumeLoadObject(this.volumeId)}getCornerstoneImage(e,t){const{imageIds:n}=this,o=this._imageIdIndexToFrameIndex(t),{bytesPerImage:a,pixelsPerImage:r,windowCenter:s,windowWidth:l,numComponents:c,color:d,dimensions:m,spacing:u,invert:g,voiLUTFunction:p,photometricInterpretation:I}=this.cornerstoneImageMetaData,S=this._getScalarDataByImageIdIndex(t),f=S.buffer,v=S.constructor,y=a/r;let w=a*o;S.BYTES_PER_ELEMENT!==y&&(w*=S.BYTES_PER_ELEMENT/y);const E=new v(r),T=new v(f,w,r);E.set(T);const D=n[t],b=i.metaData.get("modalityLutModule",D)||{},O=h(E);return{imageId:e,intercept:b.rescaleIntercept?b.rescaleIntercept:0,windowCenter:s,windowWidth:l,voiLUTFunction:p,color:d,rgba:!1,numComps:c,rows:m[1],columns:m[0],sizeInBytes:E.byteLength,getPixelData:()=>E,minPixelValue:O.min,maxPixelValue:O.max,slope:b.rescaleSlope?b.rescaleSlope:1,getCanvas:void 0,height:m[0],width:m[1],columnPixelSpacing:u[0],rowPixelSpacing:u[1],invert:g,photometricInterpretation:I}}convertToCornerstoneImage(e,t){return this.getCornerstoneImageLoadObject(e,t)}getCornerstoneImageLoadObject(e,t){const n=this.getCornerstoneImage(e,t);return{promise:Promise.resolve(n)}}getCornerstoneImages(){const{imageIds:e}=this;return e.map(((e,t)=>this.getCornerstoneImage(e,t)))}_convertToImages(){const e=this.sizeInBytes,t=this.imageIds.length,{bytesPerImage:n}=this.cornerstoneImageMetaData;let o=i.cache.decacheIfNecessaryUntilBytesAvailable(e,this.imageIds);for(let e=0;e<t;e++){const t=this.imageIds[e];o-=n;const a=this.convertToCornerstoneImage(t,e);if(i.cache.getImageLoadObject(t)||i.cache.putImageLoadObject(t,a).catch((e=>{console.error(e)})),o<=n)break}this._removeFromCache()}decache(e=!1){e?this._removeFromCache():this._convertToImages()}}class y extends v{constructor(e,t){super(e,t),this.getImageIdsToLoad=()=>{const{imageIds:e}=this;return this.numFrames=e.length,e}}getScalarData(){return this.scalarData}getImageLoadRequests(e){const{imageIds:t}=this;return this.getImageIdsRequests(t,e)}}const{createUint8SharedArray:w,createFloat32SharedArray:E,createUint16SharedArray:T,createInt16SharedArray:D}=i.utilities;const b=function(e,t){if(!t||!t.imageIds||!t.imageIds.length)throw new Error("ImageIds must be provided to create a streaming image volume");const{useNorm16Texture:n,preferSizeOverAccuracy:o}=(0,i.getConfiguration)().rendering,a=n||o,r=async function(){if("wadouri"===t.imageIds[0].split(":")[0]){const[n,o]=[Math.floor(t.imageIds.length/2),t.imageIds.length-1],a=[0,n,o];await Promise.all(a.map((n=>new Promise(((o,a)=>{const r=t.imageIds[n];i.imageLoadPoolManager.addRequest((async()=>{i.imageLoader.loadImage(r).then((()=>{console.log(`Prefetched imageId: ${r}`),o(!0)})).catch((e=>{a(e)}))}),i.Enums.RequestType.Prefetch,{volumeId:e},1)}))))).catch(console.error)}const{imageIds:n,progressiveRendering:o}=t,r=i.utilities.makeVolumeMetadata(n),s=n[Math.floor(n.length/2)],l=i.utilities.getScalingParameters(s),d=l.rescaleIntercept<0||l.rescaleSlope<0,m=l.rescaleIntercept%1!=0||l.rescaleSlope%1!=0,{BitsAllocated:u,PixelRepresentation:g,PhotometricInterpretation:p,ImageOrientationPatient:h,PixelSpacing:I,Columns:S,Rows:f}=r,v=c.R3.fromValues(h[0],h[1],h[2]),b=c.R3.fromValues(h[3],h[4],h[5]),O=c.R3.create();c.R3.cross(O,v,b);const{zSpacing:A,origin:N,sortedImageIds:C}=i.utilities.sortImageIdsAndGetSpacing(n,O),M=n.length,U=[I[1],I[0],A],R=[S,f,M],_=[...v,...b,...O],V=1===g,P="RGB"===p?3:1,x=(0,i.getShouldUseSharedArrayBuffer)(),L=R[0]*R[1]*R[2],F=e=>{if(!i.cache.isCacheable(e))throw new Error(i.Enums.Events.CACHE_SIZE_EXCEEDED);i.cache.decacheIfNecessaryUntilBytesAvailable(e)};let G,k;switch(u){case 8:if(V)throw new Error("8 Bit signed images are not yet supported by this plugin.");k=L*P,F(k),G=x?w(L*P):new Uint8Array(L*P);break;case 16:if(!a||m){k=4*L,G=x?E(L):new Float32Array(L);break}if(k=2*L,V||d){F(k),G=x?D(L):new Int16Array(L);break}if(!V&&!d){F(k),G=x?T(L):new Uint16Array(L);break}k=4*L,F(k),G=x?E(L):new Float32Array(L);break;case 24:k=L*P,F(k),G=x?w(L*P):new Uint8Array(L*P)}return new y({volumeId:e,metadata:r,dimensions:R,spacing:U,origin:N,direction:_,scalarData:G,sizeInBytes:k},{imageIds:C,loadStatus:{loaded:!1,loading:!1,cancelled:!1,cachedFrames:[],callbacks:[]}})}();return{promise:r,decache:()=>{r.then((e=>{e.destroy(),e=null}))},cancel:()=>{r.then((e=>{e.cancelLoading()}))}}};var O;!function(e){e.DYNAMIC_VOLUME_TIME_POINT_INDEX_CHANGED="DYNAMIC_VOLUME_TIME_POINT_INDEX_CHANGED"}(O||(O={}));var A=n(41851),N=n.n(A),C=n(56660),M=n.n(C);const{registerVolumeLoader:U}=i.volumeLoader;let R=!1;function _(e,t,n){N().external.cornerstone=i,N().external.dicomParser=M(),U("cornerstoneStreamingImageVolume",b),N().configure({decodeConfig:{convertFloatPixelDataToInt:!1,use16BitDataType:Boolean(t.useNorm16Texture)||Boolean(t.preferSizeOverAccuracy)},beforeSend:function(t){const o=n.getActiveDataSource()?.[0].getConfig()??{},a=e.getAuthorizationHeader(),r={Accept:l.utils.generateAcceptHeader(o.acceptHeader,o.requestTransferSyntaxUID,o.omitQuotationForMultipartRequest)};return a&&Object.assign(r,a),r},errorInterceptor:e=>{l.Po.getHTTPErrorHandler(e)}}),function(e){const t={maxWebWorkers:Math.min(Math.max(navigator.hardwareConcurrency-1,1),e.maxNumberOfWebWorkers),startWebWorkersOnDemand:!0,taskConfiguration:{decodeTask:{initializeCodecsOnStartup:!1,usePDFJS:!1,strict:!1}}};R||(N().webWorkerManager.initialize(t),R=!0)}(t)}var V=n(95303);const P=function(e,t,n,o=!0,a={}){const i="dialog-enter-annotation",s=t?o?t.text:t.label:"",{dialogTitle:l="Annotation",inputLabel:c="Enter your annotation",validateFunc:d=(e=>!0)}=a,m=({action:t,value:o})=>{switch(t.id){case"save":if("function"==typeof d&&!d(o.label))return;n(o.label,t.id);break;case"cancel":n("",t.id)}e.dismiss({id:i})};e&&e.create({id:i,centralize:!0,isDraggable:!1,showOverlay:!0,content:V.Vq,contentProps:{title:l,value:{label:s},noCloseButton:!0,onClose:()=>e.dismiss({id:i}),actions:[{id:"cancel",text:"Cancel",type:V.LZ.dt.secondary},{id:"save",text:"Save",type:V.LZ.dt.primary}],onSubmit:m,body:({value:e,setValue:t})=>r.createElement(V.II,{autoFocus:!0,className:"border-primary-main bg-black",type:"text",id:"annotation",label:c,labelClassName:"text-white text-[14px] leading-[1.2]",value:e.label,onChange:e=>{e.persist(),t((t=>({...t,label:e.target.value})))},onKeyPress:t=>{"Enter"===t.key&&m({value:e,action:{id:"save"}})}})}})};var x=n(73704);function L(e){const{activeViewportId:t}=e.getState(),{element:n}=(0,x.K8)(t)||{};return(0,i.getEnabledElement)(n)}const{calibrateImageSpacing:F}=s.utilities;class G extends s.LengthTool{constructor(...e){super(...e),this._renderingViewport=void 0,this._lengthToolRenderAnnotation=this.renderAnnotation,this.renderAnnotation=(e,t)=>{const{viewport:n}=e;return this._renderingViewport=n,this._lengthToolRenderAnnotation(e,t)}}_getTextLines(e,t){const[n,o]=e.handles.points.map((e=>this._renderingViewport.worldToCanvas(e)));return[`${Math.round(100*function(e,t){const n=e[0]-t[0],o=e[1]-t[1];return Math.sqrt(n*n+o*o)}(n,o))/100}px`]}}G.toolName="CalibrationLine";const k=G;function B(e,t){const{uiDialogService:n,viewportGridService:o}=e.services,a=t.detail,{annotation:{metadata:r,data:i}}=a,{referencedImageId:s}=r,l=L(o),{viewport:c}=l,d=Math.round(100*function(e,t){const n=e[0]-t[0],o=e[1]-t[1],a=e[2]-t[2];return Math.sqrt(n*n+o*o+a*a)}(i.handles.points[0],i.handles.points[1]))/100;return new Promise(((e,t)=>{n?P(n,{text:"",label:`${d}`},((n,o)=>{"save"===o?((e=>{const t=e/d;F(s,c.getRenderingEngine(),{type:"User",scale:1/t})})(Number.parseFloat(n)),e(!0)):t("cancel")}),!1,{dialogTitle:"Calibration",inputLabel:"Actual Physical distance (mm)",validateFunc:e=>{try{const t=Number.parseFloat(e);return!isNaN(t)&&0!==t}catch{return!1}}}):t("UIDialogService is not initiated")}))}var $=n(3225);const z=new Map,j={add:(e,t)=>{z.get(e)!==t&&z.set(e,t)},get:(e,t)=>{if(!Array.isArray(t)&&"overlayPlaneModule"===e)return z.get(t)}};i.metaData.addProvider(j.get,1e4);const q=j;class W extends s.AnnotationDisplayTool{constructor(e={},t={supportedInteractionTypes:[],configuration:{fillColor:[255,127,127,255]}}){super(e,t),this.onSetToolDisabled=()=>{},this.renderAnnotation=(e,t)=>{const{viewport:n}=e,o=this.getReferencedImageId(n);if(!o)return;const a=i.metaData.get("overlayPlaneModule",o),r=a?.overlays;return r?.length?(r.forEach((e=>{e.x||=0,e.y||=0})),W.addOverlayPlaneModule(o,a),this._getCachedStat(o,a,this.configuration.fillColor).then((n=>{n.overlays.forEach((n=>{this._renderOverlay(e,t,n)}))})),!0):void 0}}getReferencedImageId(e){if(e instanceof i.VolumeViewport)return;return this.getTargetId(e).split("imageId:")[1]}_renderOverlay(e,t,n){const{viewport:o}=e,a=this.getReferencedImageId(o);if(!a)return;const{_id:r,columns:l,rows:c,x:d,y:m}=n,u=i.utilities.imageToWorldCoords(a,[d-1,m-1]),g=o.worldToCanvas(u),p=i.utilities.imageToWorldCoords(a,[l,c]),h=o.worldToCanvas(p),I=`image-overlay-${r}`,S=t.getSvgNode(I),f={"data-id":I,width:h[0]-g[0],height:h[1]-g[1],x:g[0],y:g[1],href:n.dataUrl};if(isNaN(f.x)||isNaN(f.y)||isNaN(f.width)||isNaN(f.height))return console.warn("Invalid rendering attribute for image overlay",f["data-id"]),!1;if(S)s.drawing.setAttributesIfNecessary(f,S),t.setNodeTouched(I);else{const e=document.createElementNS("http://www.w3.org/2000/svg","image");s.drawing.setNewAttributesIfValid(f,e),t.appendNode(e,I)}return!0}async _getCachedStat(e,t,n){if(0===t.overlays.filter((e=>e.pixelData&&!e.dataUrl)).length)return t;const o=await Promise.all(t.overlays.filter((e=>e.pixelData)).map((async(e,t)=>{let o=null;if(e.pixelData.Value)o=e.pixelData.Value;else if(e.pixelData instanceof Array)o=e.pixelData[0];else if(e.pixelData.retrieveBulkData)o=await e.pixelData.retrieveBulkData();else if(e.pixelData.InlineBinary){const t=(0,$.Mi)(e.pixelData.InlineBinary);o=await t.arrayBuffer()}if(!o)return;const a=this._renderOverlayToDataUrl({width:e.columns,height:e.rows},e.color||n,o);return{...e,_id:(0,$.M8)(),dataUrl:a,color:n}})));return t.overlays=o,t}_isSameColor(e,t){return e&&t&&e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2]&&e[3]===t[3]}_renderOverlayToDataUrl({width:e,height:t},n,o){const a=new DataView(o),r=e*t,i=document.createElement("canvas");i.width=e,i.height=t;const s=i.getContext("2d");s.clearRect(0,0,e,t),s.globalCompositeOperation="copy";const l=s.getImageData(0,0,e,t),c=l.data;for(let e=0,t=0,o=0;e<r;e++)a.getUint8(o)&1<<t&&(c[4*e]=n[0],c[4*e+1]=n[1],c[4*e+2]=n[2],c[4*e+3]=n[3]),t>=7?(t=0,o++):t++;return s.putImageData(l,0,0),i.toDataURL()}}W.toolName="ImageOverlayViewer",W.addOverlayPlaneModule=q.add;const H=W;const Z={Pan:s.PanTool.toolName,ArrowAnnotate:s.ArrowAnnotateTool.toolName,WindowLevel:s.WindowLevelTool.toolName,StackScroll:s.StackScrollTool.toolName,StackScrollMouseWheel:s.StackScrollMouseWheelTool.toolName,Zoom:s.ZoomTool.toolName,VolumeRotateMouseWheel:s.VolumeRotateMouseWheelTool.toolName,MipJumpToClick:s.MIPJumpToClickTool.toolName,Length:s.LengthTool.toolName,DragProbe:s.DragProbeTool.toolName,Probe:s.ProbeTool.toolName,RectangleROI:s.RectangleROITool.toolName,EllipticalROI:s.EllipticalROITool.toolName,CircleROI:s.CircleROITool.toolName,Bidirectional:s.BidirectionalTool.toolName,Angle:s.AngleTool.toolName,CobbAngle:s.CobbAngleTool.toolName,PlanarFreehandROI:s.PlanarFreehandROITool.toolName,Magnify:s.MagnifyTool.toolName,Crosshairs:s.CrosshairsTool.toolName,SegmentationDisplay:s.SegmentationDisplayTool.toolName,ReferenceLines:s.ReferenceLinesTool.toolName,CalibrationLine:k.toolName,TrackballRotateTool:s.TrackballRotateTool.toolName,CircleScissors:s.CircleScissorsTool.toolName,RectangleScissors:s.RectangleScissorsTool.toolName,SphereScissors:s.SphereScissorsTool.toolName,ImageOverlayViewer:H.toolName},Y=["Length","EllipticalROI","CircleROI","Bidirectional","ArrowAnnotate","Angle","CobbAngle","Probe","RectangleROI","PlanarFreehandROI"];var K=n(87172);const J={toAnnotation:e=>{},toMeasurement:(e,t,n,o)=>{const{annotation:a,viewportId:r}=e,{metadata:i,data:s,annotationUID:c}=a;if(!i||!s)return console.warn("Length tool: Missing metadata or data"),null;const{toolName:d,referencedImageId:m,FrameOfReferenceUID:u}=i;if(!Y.includes(d))throw new Error("Tool not supported");const{SOPInstanceUID:g,SeriesInstanceUID:p,StudyInstanceUID:h}=(0,K.Z)(m,n,r);let I;I=g?t.getDisplaySetForSOPInstanceUID(g,p):t.getDisplaySetsForSeries(p);const{points:S,textBox:f}=s.handles,v=function(e,t){const{metadata:n,data:o}=e,{cachedStats:a}=o,{referencedImageId:r}=n;if(!Object.keys(a).length)return[];const i=[];return Object.keys(a).forEach((e=>{const n=a[e];if(!r)throw new Error("Non-acquisition plane measurement mapping not supported");const{SOPInstanceUID:o,SeriesInstanceUID:s,frameNumber:l}=(0,K.Z)(r),c=t.getDisplaySetForSOPInstanceUID(o,s,l),{SeriesNumber:d}=c,{length:m,unit:u="mm"}=n;i.push({SeriesInstanceUID:s,SOPInstanceUID:o,SeriesNumber:d,frameNumber:l,unit:u,length:m})})),i}(a,t),y=function(e,t){if(!e||!e.length)return"";const n=[],{length:o,SeriesNumber:a,SOPInstanceUID:r,frameNumber:i,unit:s}=e[0],c=t.images.find((e=>e.SOPInstanceUID===r));let d;c&&(d=c.InstanceNumber);const m=d?` I: ${d}`:"",u=t.isMultiFrame?` F: ${i}`:"";if(null==o)return n;const g=l.utils.roundNumber(o,2);return n.push(`${g} ${s} (S: ${a}${m}${u})`),n}(v,I);return{uid:c,SOPInstanceUID:g,FrameOfReferenceUID:u,points:S,textBox:f,metadata:i,referenceSeriesUID:p,referenceStudyUID:h,frameNumber:v[0]?.frameNumber||1,toolName:i.toolName,displaySetInstanceUID:I.displaySetInstanceUID,label:s.label,displayText:y,data:s.cachedStats,type:o(d),getReport:()=>function(e,t,n){const o=[],a=[];o.push("AnnotationType"),a.push("Cornerstone:Length"),e.forEach((e=>{const{length:t,unit:n}=e;o.push("Length"),a.push(t),o.push("Unit"),a.push(n)})),n&&(o.push("FrameOfReferenceUID"),a.push(n));t&&(o.push("points"),a.push(t.map((e=>e.join(" "))).join(";")));return{columns:o,values:a}}(v,S,u)}}};function Q(e){if(e.longAxis&&e.shortAxis){const t={};return t.start=e.longAxis[0],t.end=e.longAxis[1],t.perpendicularStart=e.longAxis[0],t.perpendicularEnd=e.longAxis[1],t}return e.map(((e,t)=>t%10==0?{start:e}:{end:e})).reduce(((e,t)=>Object.assign(e,{...t})),{})}function X(e){return s.annotation.selection.isAnnotationSelected(e)}function ee(e,t){X(e)!==t&&s.annotation.selection.setAnnotationSelected(e,t)}function te(e){const[t]=s.annotation.selection.getAnnotationsSelected()||[];if(t)return s.annotation.state.getAnnotation(t)}const ne=e=>null==e?"":e;const oe={toAnnotation:e=>{},toMeasurement:(e,t,n,o)=>{const{annotation:a,viewportId:r}=e,{metadata:i,data:s,annotationUID:c}=a;if(!i||!s)return console.warn("Length tool: Missing metadata or data"),null;const{toolName:d,referencedImageId:m,FrameOfReferenceUID:u}=i;if(!Y.includes(d))throw new Error("Tool not supported");const{SOPInstanceUID:g,SeriesInstanceUID:p,StudyInstanceUID:h}=(0,K.Z)(m,n,r);let I;I=g?t.getDisplaySetForSOPInstanceUID(g,p):t.getDisplaySetsForSeries(p);const{points:S,textBox:f}=s.handles,v=function(e,t){const{metadata:n,data:o}=e,{cachedStats:a}=o,{referencedImageId:r,referencedSeriesInstanceUID:i}=n;if(!Object.keys(a).length)return[];const s=[];return Object.keys(a).forEach((e=>{const n=a[e];if(!r)throw new Error("Non-acquisition plane measurement mapping not supported");const{SOPInstanceUID:o,SeriesInstanceUID:i,frameNumber:l}=(0,K.Z)(r),c=t.getDisplaySetForSOPInstanceUID(o,i,l),{SeriesNumber:d}=c,{length:m,width:u,unit:g}=n;s.push({SeriesInstanceUID:i,SOPInstanceUID:o,SeriesNumber:d,frameNumber:l,unit:g,length:m,width:u})})),s}(a,t),y=function(e,t){if(!e||!e.length)return"";const n=[],{length:o,width:a,unit:r,SeriesNumber:i,SOPInstanceUID:s,frameNumber:c}=e[0],d=l.utils.roundNumber(o,2),m=l.utils.roundNumber(a,2),u=t.images.find((e=>e.SOPInstanceUID===s));let g;u&&(g=u.InstanceNumber);const p=g?` I: ${g}`:"",h=t.isMultiFrame?` F: ${c}`:"";return n.push(`L: ${d} ${ne(r)} (S: ${i}${p}${h})`),n.push(`W: ${m} ${ne(r)}`),n}(v,I);return{uid:c,SOPInstanceUID:g,FrameOfReferenceUID:u,points:S,textBox:f,metadata:i,referenceSeriesUID:p,referenceStudyUID:h,frameNumber:v[0]?.frameNumber||1,toolName:i.toolName,displaySetInstanceUID:I.displaySetInstanceUID,label:s.label,displayText:y,data:s.cachedStats,type:o(d),getReport:()=>function(e,t,n){const o=[],a=[];o.push("AnnotationType"),a.push("Cornerstone:Bidirectional"),e.forEach((e=>{const{length:t,width:n,unit:r}=e;o.push("Length","Width","Unit"),a.push(t,n,r)})),n&&(o.push("FrameOfReferenceUID"),a.push(n));t&&(o.push("points"),a.push(t.map((e=>e.join(" "))).join(";")));return{columns:o,values:a}}(v,S,u)}}};const ae={toAnnotation:e=>{},toMeasurement:(e,t,n,o)=>{const{annotation:a,viewportId:r}=e,{metadata:i,data:s,annotationUID:c}=a;if(!i||!s)return console.warn("Length tool: Missing metadata or data"),null;const{toolName:d,referencedImageId:m,FrameOfReferenceUID:u}=i;if(!Y.includes(d))throw new Error("Tool not supported");const{SOPInstanceUID:g,SeriesInstanceUID:p,StudyInstanceUID:h}=(0,K.Z)(m,n,r);let I;I=g?t.getDisplaySetForSOPInstanceUID(g,p):t.getDisplaySetsForSeries(p);const{points:S,textBox:f}=s.handles,v=function(e,t){const{metadata:n,data:o}=e,{cachedStats:a}=o,{referencedImageId:r}=n;if(!Object.keys(a).length)return[];const i=[];return Object.keys(a).forEach((e=>{const n=a[e];if(!r)throw new Error("Non-acquisition plane measurement mapping not supported");const{SOPInstanceUID:o,SeriesInstanceUID:s,frameNumber:l}=(0,K.Z)(r),c=t.getDisplaySetForSOPInstanceUID(o,s,l),{SeriesNumber:d}=c,{mean:m,stdDev:u,max:g,area:p,Modality:h,areaUnit:I,modalityUnit:S}=n;i.push({SeriesInstanceUID:s,SOPInstanceUID:o,SeriesNumber:d,frameNumber:l,Modality:h,unit:S,areaUnit:I,mean:m,stdDev:u,max:g,area:p})})),i}(a,t),y=function(e,t){if(!e||!e.length)return"";const n=[],{area:o,SOPInstanceUID:a,frameNumber:r,areaUnit:i}=e[0],s=t.images.find((e=>e.SOPInstanceUID===a));let c;s&&(c=s.InstanceNumber);const d=c?` I: ${c}`:"",m=t.isMultiFrame?` F: ${r}`:"",u=l.utils.roundNumber(o,2);return n.push(`${u} ${ne(i)}`),e.forEach((e=>{const{unit:t,max:o,SeriesNumber:a}=e;let r="";if(o){r=`Max: ${l.utils.roundNumber(o,2)} <small>${ne(t)}</small> `}const i=`${r}(S:${a}${d}${m})`;n.includes(i)||n.push(i)})),n}(v,I);return{uid:c,SOPInstanceUID:g,FrameOfReferenceUID:u,points:S,textBox:f,metadata:i,referenceSeriesUID:p,referenceStudyUID:h,frameNumber:v[0]?.frameNumber||1,toolName:i.toolName,displaySetInstanceUID:I.displaySetInstanceUID,label:s.label,displayText:y,data:s.cachedStats,type:o(d),getReport:()=>function(e,t,n){const o=[],a=[];o.push("AnnotationType"),a.push("Cornerstone:EllipticalROI"),e.forEach((e=>{const{mean:t,stdDev:n,max:r,area:i,unit:s,areaUnit:l}=e;t&&s&&r&&i&&(o.push(`max (${s})`,`mean (${s})`,`std (${s})`,"Area","Unit"),a.push(r,t,n,i,l))})),n&&(o.push("FrameOfReferenceUID"),a.push(n));t&&(o.push("points"),a.push(t.map((e=>e.join(" "))).join(";")));return{columns:o,values:a}}(v,S,u)}}},re={toAnnotation:e=>{},toMeasurement:(e,t,n,o)=>{const{annotation:a,viewportId:r}=e,{metadata:i,data:s,annotationUID:c}=a;if(!i||!s)return console.warn("Length tool: Missing metadata or data"),null;const{toolName:d,referencedImageId:m,FrameOfReferenceUID:u}=i;if(!Y.includes(d))throw new Error("Tool not supported");const{SOPInstanceUID:g,SeriesInstanceUID:p,StudyInstanceUID:h}=(0,K.Z)(m,n,r);let I;I=g?t.getDisplaySetForSOPInstanceUID(g,p):t.getDisplaySetsForSeries(p);const{points:S,textBox:f}=s.handles,v=function(e,t){const{metadata:n,data:o}=e,{cachedStats:a}=o,{referencedImageId:r}=n;if(!Object.keys(a).length)return[];const i=[];return Object.keys(a).forEach((e=>{const n=a[e];if(!r)throw new Error("Non-acquisition plane measurement mapping not supported");const{SOPInstanceUID:o,SeriesInstanceUID:s,frameNumber:l}=(0,K.Z)(r),c=t.getDisplaySetForSOPInstanceUID(o,s,l),{SeriesNumber:d}=c,{mean:m,stdDev:u,max:g,area:p,Modality:h,areaUnit:I,modalityUnit:S}=n;i.push({SeriesInstanceUID:s,SOPInstanceUID:o,SeriesNumber:d,frameNumber:l,Modality:h,unit:S,mean:m,stdDev:u,max:g,area:p,areaUnit:I})})),i}(a,t),y=function(e,t){if(!e||!e.length)return"";const n=[],{area:o,SOPInstanceUID:a,frameNumber:r,areaUnit:i}=e[0],s=t.images.find((e=>e.SOPInstanceUID===a));let c;s&&(c=s.InstanceNumber);const d=c?` I: ${c}`:"",m=t.isMultiFrame?` F: ${r}`:"",u=l.utils.roundNumber(o||0,2);return n.push(`${u} ${ne(i)}`),e.forEach((e=>{const{unit:t,max:o,SeriesNumber:a}=e;let r="";if(o){r=`Max: ${l.utils.roundNumber(o,2)} <small>${ne(t)}</small> `}const i=`${r}(S:${a}${d}${m})`;n.includes(i)||n.push(i)})),n}(v,I);return{uid:c,SOPInstanceUID:g,FrameOfReferenceUID:u,points:S,textBox:f,metadata:i,referenceSeriesUID:p,referenceStudyUID:h,frameNumber:v[0]?.frameNumber||1,toolName:i.toolName,displaySetInstanceUID:I.displaySetInstanceUID,label:s.label,displayText:y,data:s.cachedStats,type:o(d),getReport:()=>function(e,t,n){const o=[],a=[];o.push("AnnotationType"),a.push("Cornerstone:CircleROI"),e.forEach((e=>{const{mean:t,stdDev:n,max:r,area:i,unit:s,areaUnit:l}=e;t&&s&&r&&i&&(o.push(`max (${s})`,`mean (${s})`,`std (${s})`,"Area","Unit"),a.push(r,t,n,i,l))})),n&&(o.push("FrameOfReferenceUID"),a.push(n));t&&(o.push("points"),a.push(t.map((e=>e.join(" "))).join(";")));return{columns:o,values:a}}(v,S,u)}}};const ie=re;const se={toAnnotation:e=>{},toMeasurement:(e,t,n,o)=>{const{annotation:a,viewportId:r}=e,{metadata:i,data:s,annotationUID:l}=a;if(!i||!s)return console.warn("Length tool: Missing metadata or data"),null;const{toolName:c,referencedImageId:d,FrameOfReferenceUID:m}=i;if(!Y.includes(c))throw new Error("Tool not supported");const{SOPInstanceUID:u,SeriesInstanceUID:g,StudyInstanceUID:p}=(0,K.Z)(d,n,r);let h;h=u?t.getDisplaySetForSOPInstanceUID(u,g):t.getDisplaySetsForSeries(g);const{points:I,textBox:S}=s.handles,f=function(e,t){const{metadata:n,data:o}=e,{text:a}=o,{referencedImageId:r}=n,i=[],{SOPInstanceUID:s,SeriesInstanceUID:l,frameNumber:c}=(0,K.Z)(r),d=t.getDisplaySetForSOPInstanceUID(s,l,c),{SeriesNumber:m}=d;return i.push({SeriesInstanceUID:l,SOPInstanceUID:s,SeriesNumber:m,frameNumber:c,text:a}),i}(a,t),v=function(e,t){if(!e)return"";const n=[],{SeriesNumber:o,SOPInstanceUID:a,frameNumber:r}=e[0],i=t.images.find((e=>e.SOPInstanceUID===a));let s;i&&(s=i.InstanceNumber);const l=s?` I: ${s}`:"",c=t.isMultiFrame?` F: ${r}`:"";return n.push(`(S: ${o}${l}${c})`),n}(f,h);return{uid:l,SOPInstanceUID:u,FrameOfReferenceUID:m,points:I,textBox:S,metadata:i,referenceSeriesUID:g,referenceStudyUID:p,frameNumber:f[0]?.frameNumber||1,toolName:i.toolName,displaySetInstanceUID:h.displaySetInstanceUID,label:s.text,displayText:v,data:s.cachedStats,type:o(c),getReport:()=>{throw new Error("Not implemented")}}}},le={toAnnotation:e=>{},toMeasurement:(e,t,n,o)=>{const{annotation:a,viewportId:r}=e,{metadata:i,data:s,annotationUID:c}=a;if(!i||!s)return console.warn("Cobb Angle tool: Missing metadata or data"),null;const{toolName:d,referencedImageId:m,FrameOfReferenceUID:u}=i;if(!Y.includes(d))throw new Error("Tool not supported");const{SOPInstanceUID:g,SeriesInstanceUID:p,StudyInstanceUID:h}=(0,K.Z)(m,n,r);let I;I=g?t.getDisplaySetForSOPInstanceUID(g,p):t.getDisplaySetsForSeries(p);const{points:S,textBox:f}=s.handles,v=function(e,t){const{metadata:n,data:o}=e,{cachedStats:a}=o,{referencedImageId:r}=n;if(!Object.keys(a).length)return;const i=[];return Object.keys(a).forEach((e=>{const n=a[e];if(!r)throw new Error("Non-acquisition plane measurement mapping not supported");const{SOPInstanceUID:o,SeriesInstanceUID:s,frameNumber:l}=(0,K.Z)(r),c=t.getDisplaySetForSOPInstanceUID(o,s,l),{SeriesNumber:d}=c,{angle:m}=n,u="°";i.push({SeriesInstanceUID:s,SOPInstanceUID:o,SeriesNumber:d,frameNumber:l,unit:u,angle:m})})),i}(a,t),y=function(e,t){if(!e||!e.length)return"";const n=[],{angle:o,unit:a,SeriesNumber:r,SOPInstanceUID:i,frameNumber:s}=e[0],c=t.images.find((e=>e.SOPInstanceUID===i));let d;c&&(d=c.InstanceNumber);const m=d?` I: ${d}`:"",u=t.isMultiFrame?` F: ${s}`:"";if(void 0===o)return n;const g=l.utils.roundNumber(o,2);return n.push(`${g} ${ne(a)} (S: ${r}${m}${u})`),n}(v,I);return{uid:c,SOPInstanceUID:g,FrameOfReferenceUID:u,points:S,textBox:f,metadata:i,referenceSeriesUID:p,referenceStudyUID:h,frameNumber:v?.[0]?.frameNumber||1,toolName:i.toolName,displaySetInstanceUID:I.displaySetInstanceUID,label:s.label,displayText:y,data:s.cachedStats,type:o(d),getReport:()=>function(e,t,n){const o=[],a=[];o.push("AnnotationType"),a.push("Cornerstone:CobbAngle"),e.forEach((e=>{const{angle:t,unit:n}=e;o.push(`Angle (${n})`),a.push(t)})),n&&(o.push("FrameOfReferenceUID"),a.push(n));t&&(o.push("points"),a.push(t.map((e=>e.join(" "))).join(";")));return{columns:o,values:a}}(v,S,u)}}};const ce=le,de={toAnnotation:e=>{},toMeasurement:(e,t,n,o)=>{const{annotation:a,viewportId:r}=e,{metadata:i,data:s,annotationUID:c}=a;if(!i||!s)return console.warn("Length tool: Missing metadata or data"),null;const{toolName:d,referencedImageId:m,FrameOfReferenceUID:u}=i;if(!Y.includes(d))throw new Error("Tool not supported");const{SOPInstanceUID:g,SeriesInstanceUID:p,StudyInstanceUID:h}=(0,K.Z)(m,n,r);let I;I=g?t.getDisplaySetForSOPInstanceUID(g,p):t.getDisplaySetsForSeries(p);const{points:S,textBox:f}=s.handles,v=function(e,t){const{metadata:n,data:o}=e,{cachedStats:a}=o,{referencedImageId:r}=n;if(!Object.keys(a).length)return;const i=[];return Object.keys(a).forEach((e=>{const n=a[e];if(!r)throw new Error("Non-acquisition plane measurement mapping not supported");const{SOPInstanceUID:o,SeriesInstanceUID:s,frameNumber:l}=(0,K.Z)(r),c=t.getDisplaySetForSOPInstanceUID(o,s,l),{SeriesNumber:d}=c,{angle:m}=n,u="°";i.push({SeriesInstanceUID:s,SOPInstanceUID:o,SeriesNumber:d,frameNumber:l,unit:u,angle:m})})),i}(a,t),y=function(e,t){if(!e||!e.length)return"";const n=[],{angle:o,unit:a,SeriesNumber:r,SOPInstanceUID:i,frameNumber:s}=e[0],c=t.images.find((e=>e.SOPInstanceUID===i));let d;c&&(d=c.InstanceNumber);const m=d?` I: ${d}`:"",u=t.isMultiFrame?` F: ${s}`:"";if(void 0===o)return n;const g=l.utils.roundNumber(o,2);return n.push(`${g} ${ne(a)} (S: ${r}${m}${u})`),n}(v,I);return{uid:c,SOPInstanceUID:g,FrameOfReferenceUID:u,points:S,textBox:f,metadata:i,referenceSeriesUID:p,referenceStudyUID:h,frameNumber:v?.[0]?.frameNumber||1,toolName:i.toolName,displaySetInstanceUID:I.displaySetInstanceUID,label:s.label,displayText:y,data:s.cachedStats,type:o(d),getReport:()=>function(e,t,n){const o=[],a=[];o.push("AnnotationType"),a.push("Cornerstone:Angle"),e.forEach((e=>{const{angle:t,unit:n}=e;o.push(`Angle (${n})`),a.push(t)})),n&&(o.push("FrameOfReferenceUID"),a.push(n));t&&(o.push("points"),a.push(t.map((e=>e.join(" "))).join(";")));return{columns:o,values:a}}(v,S,u)}}};const me=de,ue={toAnnotation:e=>{},toMeasurement:(e,t,n,o)=>{const{annotation:a,viewportId:r}=e,{metadata:i,data:s,annotationUID:l}=a;if(!i||!s)return console.warn("PlanarFreehandROI tool: Missing metadata or data"),null;const{toolName:c,referencedImageId:d,FrameOfReferenceUID:m}=i;if(!Y.includes(c))throw new Error("Tool not supported");const{SOPInstanceUID:u,SeriesInstanceUID:g,StudyInstanceUID:p}=(0,K.Z)(d,n,r);let h;h=u?t.getDisplaySetForSOPInstanceUID(u,g):t.getDisplaySetsForSeries(g);const{points:I,textBox:S}=s.handles;!function(e,t){const{metadata:n,data:o}=e,{label:a}=o,{referencedImageId:r}=n,i=[],{SOPInstanceUID:s,SeriesInstanceUID:l}=(0,K.Z)(r)||{};if(!s||!l)return i;const c=t.getDisplaySetForSOPInstanceUID(s,l),{SeriesNumber:d,SeriesInstanceUID:m}=c;i.push({SeriesInstanceUID:m,SeriesNumber:d,label:a,data:o})}(a,t);return{uid:l,SOPInstanceUID:u,FrameOfReferenceUID:m,points:I,textBox:S,metadata:i,referenceSeriesUID:g,referenceStudyUID:p,toolName:i.toolName,displaySetInstanceUID:h.displaySetInstanceUID,label:s.label,displayText:"",data:{...s,...s.cachedStats},type:o(c),getReport:()=>({columns:[],values:[]})}}};const ge=ue,pe={toAnnotation:e=>{},toMeasurement:(e,t,n,o)=>{const{annotation:a,viewportId:r}=e,{metadata:i,data:s,annotationUID:c}=a;if(!i||!s)return console.warn("Rectangle ROI tool: Missing metadata or data"),null;const{toolName:d,referencedImageId:m,FrameOfReferenceUID:u}=i;if(!Y.includes(d))throw new Error("Tool not supported");const{SOPInstanceUID:g,SeriesInstanceUID:p,StudyInstanceUID:h}=(0,K.Z)(m,n,r);let I;I=g?t.getDisplaySetForSOPInstanceUID(g,p):t.getDisplaySetsForSeries(p);const{points:S,textBox:f}=s.handles,v=function(e,t){const{metadata:n,data:o}=e,{cachedStats:a}=o,{referencedImageId:r}=n;if(!Object.keys(a).length)return[];const i=[];return Object.keys(a).forEach((e=>{const n=a[e];if(!r)throw new Error("Non-acquisition plane measurement mapping not supported");const{SOPInstanceUID:o,SeriesInstanceUID:s,frameNumber:l}=(0,K.Z)(r),c=t.getDisplaySetForSOPInstanceUID(o,s,l),{SeriesNumber:d}=c,{mean:m,stdDev:u,max:g,area:p,Modality:h,modalityUnit:I,areaUnit:S}=n;i.push({SeriesInstanceUID:s,SOPInstanceUID:o,SeriesNumber:d,frameNumber:l,Modality:h,unit:I,mean:m,stdDev:u,max:g,area:p,areaUnit:S})})),i}(a,t),y=function(e,t){if(!e||!e.length)return"";const n=[],{area:o,SOPInstanceUID:a,frameNumber:r,areaUnit:i}=e[0],s=t.images.find((e=>e.SOPInstanceUID===a));let c;s&&(c=s.InstanceNumber);const d=c?` I: ${c}`:"",m=t.isMultiFrame?` F: ${r}`:"",u=l.utils.roundNumber(o||0,2);return n.push(`${u} ${ne(i)}`),e.forEach((e=>{const{unit:t,max:o,SeriesNumber:a}=e;let r="";if(o){r=`Max: ${l.utils.roundNumber(o,2)} <small>${ne(t)}</small> `}const i=`${r}(S:${a}${d}${m})`;n.includes(i)||n.push(i)})),n}(v,I);return{uid:c,SOPInstanceUID:g,FrameOfReferenceUID:u,points:S,textBox:f,metadata:i,referenceSeriesUID:p,referenceStudyUID:h,frameNumber:v[0]?.frameNumber||1,toolName:i.toolName,displaySetInstanceUID:I.displaySetInstanceUID,label:s.label,displayText:y,data:s.cachedStats,type:o(d),getReport:()=>function(e,t,n){const o=[],a=[];o.push("AnnotationType"),a.push("Cornerstone:RectangleROI"),e.forEach((e=>{const{mean:t,stdDev:n,max:r,area:i,unit:s,areaUnit:l}=e;t&&s&&r&&i&&(o.push("Maximum","Mean","Std Dev","Pixel Unit","Area","Unit"),a.push(r,t,n,s,i,l))})),n&&(o.push("FrameOfReferenceUID"),a.push(n));t&&(o.push("points"),a.push(t.map((e=>e.join(" "))).join(";")));return{columns:o,values:a}}(v,S,u)}}};const he=pe,Ie=(e,t,n)=>{const o=e=>{const{POLYLINE:t,ELLIPSE:n,CIRCLE:o,RECTANGLE:a,BIDIRECTIONAL:r,POINT:i,ANGLE:s}=l.MeasurementService.VALUE_TYPES;return{Length:t,EllipticalROI:n,CircleROI:o,RectangleROI:a,PlanarFreehandROI:t,Bidirectional:r,ArrowAnnotate:i,CobbAngle:s,Angle:s}[e]};return{Length:{toAnnotation:J.toAnnotation,toMeasurement:e=>J.toMeasurement(e,t,n,o),matchingCriteria:[{valueType:l.MeasurementService.VALUE_TYPES.POLYLINE,points:2}]},Bidirectional:{toAnnotation:oe.toAnnotation,toMeasurement:e=>oe.toMeasurement(e,t,n,o),matchingCriteria:[{valueType:l.MeasurementService.VALUE_TYPES.POLYLINE,points:2},{valueType:l.MeasurementService.VALUE_TYPES.POLYLINE,points:2}]},EllipticalROI:{toAnnotation:ae.toAnnotation,toMeasurement:e=>ae.toMeasurement(e,t,n,o),matchingCriteria:[{valueType:l.MeasurementService.VALUE_TYPES.ELLIPSE}]},CircleROI:{toAnnotation:ie.toAnnotation,toMeasurement:e=>ie.toMeasurement(e,t,n,o),matchingCriteria:[{valueType:l.MeasurementService.VALUE_TYPES.CIRCLE}]},RectangleROI:{toAnnotation:he.toAnnotation,toMeasurement:e=>he.toMeasurement(e,t,n,o),matchingCriteria:[{valueType:l.MeasurementService.VALUE_TYPES.POLYLINE}]},PlanarFreehandROI:{toAnnotation:ge.toAnnotation,toMeasurement:e=>ge.toMeasurement(e,t,n,o),matchingCriteria:[{valueType:l.MeasurementService.VALUE_TYPES.POLYLINE}]},ArrowAnnotate:{toAnnotation:se.toAnnotation,toMeasurement:e=>se.toMeasurement(e,t,n,o),matchingCriteria:[{valueType:l.MeasurementService.VALUE_TYPES.POINT,points:1}]},CobbAngle:{toAnnotation:ce.toAnnotation,toMeasurement:e=>ce.toMeasurement(e,t,n,o),matchingCriteria:[{valueType:l.MeasurementService.VALUE_TYPES.ANGLE}]},Angle:{toAnnotation:me.toAnnotation,toMeasurement:e=>me.toMeasurement(e,t,n,o),matchingCriteria:[{valueType:l.MeasurementService.VALUE_TYPES.ANGLE}]}}},{removeAnnotation:Se}=s.annotation.state,fe=s.Enums.Events,ve="Cornerstone3DTools",ye=e=>{const{measurementService:t,displaySetService:n,cornerstoneViewportService:o}=e.services,a=((e,t,n)=>{const{Length:o,Bidirectional:a,EllipticalROI:r,CircleROI:i,ArrowAnnotate:s,Angle:l,CobbAngle:c,RectangleROI:d,PlanarFreehandROI:m}=Ie(e,t,n),u=e.createSource(ve,"0.1");return e.addMapping(u,"Length",o.matchingCriteria,o.toAnnotation,o.toMeasurement),e.addMapping(u,"Bidirectional",a.matchingCriteria,a.toAnnotation,a.toMeasurement),e.addMapping(u,"EllipticalROI",r.matchingCriteria,r.toAnnotation,r.toMeasurement),e.addMapping(u,"CircleROI",i.matchingCriteria,i.toAnnotation,i.toMeasurement),e.addMapping(u,"ArrowAnnotate",s.matchingCriteria,s.toAnnotation,s.toMeasurement),e.addMapping(u,"CobbAngle",c.matchingCriteria,c.toAnnotation,c.toMeasurement),e.addMapping(u,"Angle",l.matchingCriteria,l.toAnnotation,l.toMeasurement),e.addMapping(u,"RectangleROI",d.matchingCriteria,d.toAnnotation,d.toMeasurement),e.addMapping(u,"PlanarFreehandROI",m.matchingCriteria,m.toAnnotation,m.toMeasurement),e.addMapping(u,"CalibrationLine",o.matchingCriteria,o.toAnnotation,o.toMeasurement),u})(t,n,o);we(t,o,a);const{annotationToMeasurement:r,remove:s}=a;function l(t){try{const n=t.detail,{annotation:{metadata:a,annotationUID:i}}=n,{toolName:s}=a;t.type===m&&s===Z.CalibrationLine?B(e,t).then((()=>{console.log("calibration applied")}),(()=>!0)).finally((()=>{Se(i),c(t),o.resize()})):(n.uid=i,r(s,n))}catch(e){console.warn("Failed to update measurement:",e)}}function c(e){try{try{const n=e.detail,{annotation:{annotationUID:o}}=n;t.getMeasurement(o)&&(console.log("~~ removeEvt",e),s(o,n))}catch(e){console.warn("Failed to update measurement:",e)}}catch(e){console.warn("Failed to remove measurement:",e)}}const d=fe.ANNOTATION_ADDED,m=fe.ANNOTATION_COMPLETED,u=fe.ANNOTATION_MODIFIED,g=fe.ANNOTATION_REMOVED,p=fe.ANNOTATION_SELECTION_CHANGE;return i.eventTarget.addEventListener(d,l),i.eventTarget.addEventListener(m,l),i.eventTarget.addEventListener(u,(function(e){try{const n=e.detail,{annotation:{metadata:o,annotationUID:a}}=n;if(!t.getMeasurement(a))return;const{toolName:i}=o;n.uid=a,r(i,n,!0)}catch(e){console.warn("Failed to update measurement:",e)}})),i.eventTarget.addEventListener(g,c),i.eventTarget.addEventListener(p,(function(e){try{const n=e.detail,{added:o,removed:a}=n;a&&a.forEach((e=>t.setMeasurementSelected(e,!1))),o&&o.forEach((e=>t.setMeasurementSelected(e,!0)))}catch(e){console.warn("Failed to select and unselect measurements:",e)}})),a},we=(e,t,n)=>{const{MEASUREMENT_REMOVED:o,MEASUREMENTS_CLEARED:a,MEASUREMENT_UPDATED:r,RAW_MEASUREMENT_ADDED:i}=e.EVENTS;e.getSource(ve,"0.1");e.subscribe(a,(({measurements:e})=>{if(Object.keys(e).length)for(const t of Object.values(e)){const{uid:e,source:n}=t;n.name===ve&&Se(e)}})),e.subscribe(r,(({source:e,measurement:t,notYetUpdatedAtSource:n})=>{if(e.name!==ve)return;if(!1===n)return;const{uid:o,label:a}=t,r=s.annotation.state.getAnnotation(o),{data:i,metadata:l}=r;i&&(i.label!==a&&(i.label=a),"ArrowAnnotate"===l.toolName&&(i.text=a))})),e.subscribe(i,(({source:e,measurement:t,data:n,dataSource:o})=>{if(e.name!==ve)return;const{referenceSeriesUID:a,referenceStudyUID:r,SOPInstanceUID:i}=t,c=l.DicomMetadataStore.getInstance(r,a,i);let d,m=1;t?.metadata?.referencedImageId?(d=t.metadata.referencedImageId,m=(0,K.Z)(t.metadata.referencedImageId).frameNumber):d=o.getImageIdsForInstance({instance:c});s.annotation.state.getAnnotationManager().addAnnotation({annotationUID:t.uid,highlighted:!1,isLocked:!1,invalidated:!1,metadata:{toolName:t.toolName,FrameOfReferenceUID:t.FrameOfReferenceUID,referencedImageId:d},data:{text:n.annotation.data.text,handles:{...n.annotation.data.handles},cachedStats:{...n.annotation.data.cachedStats},label:n.annotation.data.label,frameNumber:m}})})),e.subscribe(o,(({source:e,measurement:n})=>{if(e?.name&&e.name!==ve)return;Se(n);t.getRenderingEngine().render()}))};const Ee=function(e){e.setServiceImplementation({playClip:(e,t)=>s.utilities.cine.playClip(e,t),stopClip:e=>s.utilities.cine.stopClip(e)})};var Te=n(44379);const De=new Map,be=new Map;function Oe({data:{viewportId:e,volumeInputArray:t},displaySetsMatchDetails:n,viewportMatchDetails:o}){be.set(e,t);for(const e of t){const{volumeId:t}=e,n=i.cache.getVolume(t);if(!n)return;if(!De.has(t)){const{metadata:e}=n;De.set(t,e.SeriesInstanceUID)}}if(o.size!==be.size)return;for(const[e,t]of n.entries()){const{SeriesInstanceUID:e}=t;if(!Array.from(De.values()).includes(e))return}const a=Array.from(De.keys()).slice().map((e=>i.cache.getVolume(e))),r=[];a.forEach((e=>{const t=e.getImageLoadRequests();if(!t.length||!t[0]||!t[0].imageId)return;const n=function(e){const t=e.length-1,n=Math.floor(e.length/2);let o=n,a=n;const r=[{imageId:e[n],imageIdIndex:n}],i={currentPositionDownToMinimum:!1,currentPositionUpToMaximum:!1};for(0===n?i.currentPositionDownToMinimum=!0:n===t&&(i.currentPositionUpToMaximum=!0);!i.currentPositionDownToMinimum||!i.currentPositionUpToMaximum;)i.currentPositionDownToMinimum||(o--,r.push({imageId:e[o],imageIdIndex:o}),0===o&&(i.currentPositionDownToMinimum=!0)),i.currentPositionUpToMaximum||(a++,r.push({imageId:e[a],imageIdIndex:a}),a===t&&(i.currentPositionUpToMaximum=!0));return r}(t.map((e=>e.imageId))).map((({imageId:e})=>t.find((t=>t.imageId===e))));r.push(n)}));const s=(0,Te.compact)((0,Te.flatten)((0,Te.zip)(...r))),l=[];s.forEach((e=>{const{imageId:t}=e;r.forEach((e=>{const n=e.find((e=>e.imageId===t));n&&l.push(n)}))}));const c=i.Enums.RequestType.Prefetch;l.forEach((({callLoadImage:e,additionalDetails:t,imageId:n,imageIdIndex:o,options:a})=>{const r=e.bind(null,n,o,a);i.imageLoadPoolManager.addRequest(r,c,t,0)})),De.clear();const d=new Map(be);return be.clear(),d}const Ae=new Map,Ne=new Map;function Ce({data:{viewportId:e,volumeInputArray:t},displaySetsMatchDetails:n}){Ne.set(e,t);for(const e of t){const{volumeId:t}=e,n=i.cache.getVolume(t);if(!n)return void console.log("interleaveNthLoader::No volume, can't load it");if(!Ae.has(t)){const{metadata:e}=n;Ae.set(t,e.SeriesInstanceUID)}}const o=function(e){if(!e||!e.length)return[];if(1===e.length)return e[0];console.time("interleave");const t=[...e],n=[];for(let e=0;t.length>0;e++)for(const o of t)e>=o.length?t.splice(t.indexOf(o),1):n.push(o[e]);return console.timeEnd("interleave"),n}(Array.from(Ae.keys()).slice().map((e=>i.cache.getVolume(e))).map((e=>e.getImageLoadRequests())).filter((e=>e?.[0]?.imageId)).map((e=>function(e){const t=[[],[],[],[],[]],n=e.length/2-3,o=n+6;for(let a=0;a<e.length;a++)a<2||a>e.length-4||a>n&&a<o?t[0].push(e[a]):a%7==2?t[1].push(e[a]):a%7==5?t[2].push(e[a]):t[a%2+3].push(e[a]);return[...t[0],...t[1],...t[2],...t[3],...t[4]]}(e)))),a=i.Enums.RequestType.Prefetch;o.forEach((({callLoadImage:e,additionalDetails:t,imageId:n,imageIdIndex:o,options:r})=>{const s=e.bind(null,n,o,r);i.imageLoadPoolManager.addRequest(s,a,t,0)})),Ae.clear();const r=new Map(Ne);return Ne.clear(),r}const Me=new Map,Ue=new Map;function Re({data:{viewportId:e,volumeInputArray:t},displaySetsMatchDetails:n,viewportMatchDetails:o}){Ue.set(e,t);for(const e of t){const{volumeId:t}=e,n=i.cache.getVolume(t);if(!n)return;if(!Me.has(t)){const{metadata:e}=n;Me.set(t,e.SeriesInstanceUID)}}if(o.size!==Ue.size)return;for(const[e,t]of n.entries()){const{SeriesInstanceUID:e}=t;if(!Array.from(Me.values()).includes(e))return}const a=Array.from(Me.keys()).slice().map((e=>i.cache.getVolume(e))),r=[];a.forEach((e=>{const t=e.getImageLoadRequests();t.length&&t[0]&&t[0].imageId&&r.push(t.reverse())}));const s=(0,Te.compact)((0,Te.flatten)((0,Te.zip)(...r))),l=[];s.forEach((e=>{const{imageId:t}=e;r.forEach((e=>{const n=e.find((e=>e.imageId===t));n&&l.push(n)}))}));const c=i.Enums.RequestType.Prefetch;l.forEach((({callLoadImage:e,additionalDetails:t,imageId:n,imageIdIndex:o,options:a})=>{const r=e.bind(null,n,o,a);i.imageLoadPoolManager.addRequest(r,c,t,0)})),Me.clear();const d=new Map(Ue);return Ue.clear(),d}const _e=(e,t)=>{if(!t?.detail)return;const{element:n,currentPoints:o}=t.detail;return e.runCommand("getNearbyAnnotation",{element:n,canvasCoordinates:o?.canvas},"CORNERSTONE")},Ve=s.Enums.Events,Pe={button1:{commands:[{commandName:"closeContextMenu"}]},button3:{commands:[{commandName:"showCornerstoneContextMenu",commandOptions:{requireNearbyToolData:!0,menuId:"measurementsContextMenu"}}]}};const xe=function({cornerstoneViewportService:e,customizationService:t,commandsManager:n}){const o=e=>{const o=function(e){const t=e.detail.event.which,n=[];return e.detail.event.altKey&&n.push("alt"),e.detail.event.ctrlKey&&n.push("ctrl"),e.detail.event.shiftKey&&n.push("shift"),n.push("button"),n.push(t),n.join("")}(e);((e,o)=>{const a=(t.get("cornerstoneViewportClickCommands")||Pe)[e];if(!a)return;let r=null;a.commands.some((e=>e.commandOptions?.requireNearbyToolData))&&(r=_e(n,o));const i={nearbyToolData:r,event:o};n.run(a,i)})(o,e)};i.eventTarget.addEventListener(i.EVENTS.ELEMENT_ENABLED,function(t){const{viewportId:n,element:a}=t.detail;e.getViewportInfo(n)&&((0,x.Yc)(n,a),a.addEventListener(Ve.MOUSE_CLICK,o))}.bind(null)),i.eventTarget.addEventListener(i.EVENTS.ELEMENT_DISABLED,function(e){const{element:t}=e.detail;t.removeEventListener(Ve.MOUSE_CLICK,o)}.bind(null))},Le=s.Enums.Events,Fe={doubleClick:{commandName:"toggleOneUp",commandOptions:{}}};const Ge=function({customizationService:e,commandsManager:t}){const n=n=>{if(_e(t,n))return;const o=function(e){const t=[];return e.detail.event.altKey&&t.push("alt"),e.detail.event.ctrlKey&&t.push("ctrl"),e.detail.event.shiftKey&&t.push("shift"),t.push("doubleClick"),t.join("")}(n),a=(e.get("cornerstoneViewportClickCommands")||Fe)[o];a&&t.run(a)};i.eventTarget.addEventListener(i.EVENTS.ELEMENT_ENABLED,function(e){const{element:t}=e.detail;t.addEventListener(Le.MOUSE_DOUBLE_CLICK,n)}.bind(null)),i.eventTarget.addEventListener(i.EVENTS.ELEMENT_DISABLED,function(e){const{element:t}=e.detail;t.removeEventListener(Le.MOUSE_DOUBLE_CLICK,n)}.bind(null))},{TimingEnum:ke}=l.Types,Be=[ke.DISPLAY_SETS_TO_ALL_IMAGES,ke.DISPLAY_SETS_TO_FIRST_IMAGE,ke.STUDY_TO_FIRST_IMAGE],$e={viewportsWaiting:0};function ze(e){"preRender"!==e.detail.viewportStatus&&(l.cM.timeEnd(ke.DISPLAY_SETS_TO_FIRST_IMAGE),l.cM.timeEnd(ke.STUDY_TO_FIRST_IMAGE),l.cM.timeEnd(ke.SCRIPT_TO_VIEW),$e.viewportsWaiting-=1,e.detail.element.removeEventListener(i.EVENTS.IMAGE_RENDERED,ze),$e.viewportsWaiting||l.cM.timeEnd(ke.DISPLAY_SETS_TO_ALL_IMAGES))}async function je({servicesManager:e,commandsManager:t,extensionManager:n,configuration:o,appConfig:a}){const r=a.useSharedArrayBuffer;let c=!1;"AUTO"===r?i.setUseSharedArrayBuffer(i.Enums.SharedArrayBufferModes.AUTO):"FALSE"===r||!1===r?(i.setUseSharedArrayBuffer(i.Enums.SharedArrayBufferModes.FALSE),c=!0):i.setUseSharedArrayBuffer(i.Enums.SharedArrayBufferModes.TRUE),await(0,i.init)({rendering:{preferSizeOverAccuracy:Boolean(a.preferSizeOverAccuracy),useNorm16Texture:Boolean(a.useNorm16Texture)}}),i.setUseCPURendering(Boolean(a.useCPURendering)),i.setConfiguration({...i.getConfiguration(),rendering:{...i.getConfiguration().rendering,strictZSpacingForVolumeViewport:a.strictZSpacingForVolumeViewport}});const{maxCacheSize:d}=a;d&&i.cache.setMaxCacheSize(d),function(e={}){s.CrosshairsTool.isAnnotation=!1,s.ReferenceLinesTool.isAnnotation=!1,(0,s.init)(e),(0,s.addTool)(s.PanTool),(0,s.addTool)(s.WindowLevelTool),(0,s.addTool)(s.StackScrollMouseWheelTool),(0,s.addTool)(s.StackScrollTool),(0,s.addTool)(s.ZoomTool),(0,s.addTool)(s.ProbeTool),(0,s.addTool)(s.VolumeRotateMouseWheelTool),(0,s.addTool)(s.MIPJumpToClickTool),(0,s.addTool)(s.LengthTool),(0,s.addTool)(s.RectangleROITool),(0,s.addTool)(s.EllipticalROITool),(0,s.addTool)(s.CircleROITool),(0,s.addTool)(s.BidirectionalTool),(0,s.addTool)(s.ArrowAnnotateTool),(0,s.addTool)(s.DragProbeTool),(0,s.addTool)(s.AngleTool),(0,s.addTool)(s.CobbAngleTool),(0,s.addTool)(s.PlanarFreehandROITool),(0,s.addTool)(s.MagnifyTool),(0,s.addTool)(s.CrosshairsTool),(0,s.addTool)(s.SegmentationDisplayTool),(0,s.addTool)(s.ReferenceLinesTool),(0,s.addTool)(k),(0,s.addTool)(s.TrackballRotateTool),(0,s.addTool)(s.CircleScissorsTool),(0,s.addTool)(s.RectangleScissorsTool),(0,s.addTool)(s.SphereScissorsTool),(0,s.addTool)(H);const t=s.annotation.config.style.getDefaultToolStyles();s.annotation.config.style.setDefaultToolStyles({global:{...t.global,textBoxFontSize:"15px",lineWidth:"1.5"}})}(),i.Settings.getRuntimeSettings().set("useCursors",Boolean(a.useCursors));const{userAuthenticationService:m,customizationService:u,uiModalService:g,uiNotificationService:p,cineService:h,cornerstoneViewportService:I,hangingProtocolService:S,toolGroupService:f,toolbarService:v,viewportGridService:y,stateSyncService:w}=e.services;window.services=e.services,window.extensionManager=n,window.commandsManager=t,!a.showWarningMessageForCrossOrigin||window.crossOriginIsolated||c||p.show({title:"Cross Origin Isolation",message:"Cross Origin Isolation is not enabled, read more about it here: https://docs.ohif.org/faq/",type:"warning"}),a.showCPUFallbackMessage&&i.getShouldUseCPURendering()&&function(e,t){const n=t=>{if(100===t)return e.show({content:qe,title:"OHIF Fell Back to CPU Rendering"}),!0},{unsubscribe:o}=t.subscribe(t.EVENTS.PROTOCOL_CHANGED,(()=>{n(100)&&o()}))}(g,S),w.register("lutPresentationStore",{clearOnModeExit:!0}),w.register("positionPresentationStore",{clearOnModeExit:!0}),w.register("toggleOneUpViewportGridStore",{clearOnModeExit:!0});const E=s.Enums.SegmentationRepresentations.Labelmap;s.segmentation.config.setGlobalRepresentationConfig(E,{fillAlpha:.3,fillAlphaInactive:.2,outlineOpacity:1,outlineOpacityInactive:.65});const T=l.default.classes.MetadataProvider;i.volumeLoader.registerVolumeLoader("cornerstoneStreamingImageVolume",b),S.registerImageLoadStrategy("interleaveCenter",Oe),S.registerImageLoadStrategy("interleaveTopToBottom",Re),S.registerImageLoadStrategy("nth",Ce),i.metaData.addProvider(i.utilities.calibratedPixelSpacingMetadataProvider.get.bind(i.utilities.calibratedPixelSpacingMetadataProvider)),i.metaData.addProvider(T.get.bind(T),9999),i.imageLoadPoolManager.maxNumRequests={interaction:a?.maxNumRequests?.interaction||100,thumbnail:a?.maxNumRequests?.thumbnail||75,prefetch:a?.maxNumRequests?.prefetch||10},_(m,a,n),this.measurementServiceSource=ye(e),Ee(h),S.subscribe(S.EVENTS.CUSTOM_IMAGE_LOAD_PERFORMED,(e=>{for(const t of e.entries()){const[e,n]=t,o=I.getCornerstoneViewport(e),a=I.getViewportInfo(e),{lutPresentationStore:r,positionPresentationStore:i}=w.getState(),{presentationIds:s}=a.getViewportOptions(),l={positionPresentation:i[s?.positionPresentationId],lutPresentation:r[s?.lutPresentationId]};I.setVolumesForViewport(o,n,l)}})),xe({cornerstoneViewportService:I,customizationService:u,commandsManager:t}),Ge({customizationService:u,commandsManager:t});const D=e=>{const{element:n}=e.detail;v.getActiveTools().forEach((o=>{const a=v.getNestedButton(o),r=a?.listeners?.[e.type];t.run(r,{element:n,evt:e})}))},O=({detail:e})=>{l.Po.getHTTPErrorHandler()(e.error)},A=e=>{const{element:t}=e.detail,{viewportId:n,renderingEngineId:o}=i.getEnabledElement(t),a=s.ToolGroupManager.getToolGroupForViewport(n,o);if(!a||!a._toolInstances?.Crosshairs)return;const r=a._toolInstances.Crosshairs.mode;r===s.Enums.ToolModes.Active?a.setToolActive("Crosshairs"):r===s.Enums.ToolModes.Passive?a.setToolPassive("Crosshairs"):r===s.Enums.ToolModes.Enabled&&a.setToolEnabled("Crosshairs")};i.eventTarget.addEventListener(i.EVENTS.STACK_VIEWPORT_NEW_STACK,(e=>{const{element:t}=e.detail;s.utilities.stackContextPrefetch.enable(t)})),i.eventTarget.addEventListener(i.EVENTS.IMAGE_LOAD_FAILED,O),i.eventTarget.addEventListener(i.EVENTS.IMAGE_LOAD_ERROR,O),i.eventTarget.addEventListener(i.EVENTS.ELEMENT_ENABLED,function(e){const{element:t}=e.detail;t.addEventListener(i.EVENTS.CAMERA_RESET,A),i.eventTarget.addEventListener(i.EVENTS.STACK_VIEWPORT_NEW_STACK,D),function({element:e}){Be.find((e=>l.cM.timingKeys[e]))&&($e.viewportsWaiting+=1,e.addEventListener(i.EVENTS.IMAGE_RENDERED,ze))}({element:t,eventTarget:i.eventTarget})}.bind(null)),i.eventTarget.addEventListener(i.EVENTS.ELEMENT_DISABLED,function(e){const{element:t}=e.detail;t.removeEventListener(i.EVENTS.CAMERA_RESET,A)}.bind(null)),y.subscribe(y.EVENTS.ACTIVE_VIEWPORT_ID_CHANGED,(e=>{const{viewportId:n}=e,o=f.getToolGroupForViewport(n);v.getActiveTools().forEach((a=>{if(!o?._toolInstances?.[a])return;if(!(o._toolInstances[a].mode===s.Enums.ToolModes.Enabled))return;const r=v.getNestedButton(a),i=r?.listeners?.[e.type];t.run(i,{viewportId:n,evt:e})}))}))}function qe(){return r.createElement("div",null,r.createElement("p",null,"Your computer does not have enough GPU power to support the default GPU rendering mode. OHIF has switched to CPU rendering mode. Please note that CPU rendering does not support all features such as Volume Rendering, Multiplanar Reconstruction, and Segmentation Overlays."))}window.cornerstone=i,window.cornerstoneTools=s;var We=n(74834),He=n(3827),Ze=n.n(He),Ye=n(44921),Ke=n.n(Ye);const Je={PROGRESS:"event:DicomFileUploader:progress"};let Qe=function(e){return e[e.NotStarted=0]="NotStarted",e[e.InProgress=1]="InProgress",e[e.Success=2]="Success",e[e.Failed=3]="Failed",e[e.Cancelled=4]="Cancelled",e}({});class Xe{constructor(e,t){this.message=void 0,this.status=void 0,this.message=t,this.status=e}}class et extends l.hC{constructor(e,t){super(Je),this._file=void 0,this._fileId=void 0,this._dataSource=void 0,this._loadPromise=void 0,this._abortController=new AbortController,this._status=Qe.NotStarted,this._percentComplete=0,this._file=e,this._fileId=N().wadouri.fileManager.add(e),this._dataSource=t}getFileId(){return this._fileId}getFileName(){return this._file.name}getFileSize(){return this._file.size}cancel(){this._abortController.abort()}getStatus(){return this._status}getPercentComplete(){return this._percentComplete}async load(){return this._loadPromise||(this._loadPromise=new Promise(((e,t)=>{const n={progress:e=>{e.lengthComputable&&(this._status=Qe.InProgress,this._percentComplete=Math.round(100*e.loaded/e.total),this._broadcastEvent(Je.PROGRESS,{fileId:this._fileId,percentComplete:this._percentComplete}))},timeout:()=>{this._reject(t,new Xe(Qe.Failed,"The request timed out."))},abort:()=>{this._reject(t,new Xe(Qe.Cancelled,"Cancelled"))},error:()=>{this._reject(t,new Xe(Qe.Failed,"The request failed."))}};N().wadouri.loadFileRequest(this._fileId).then((o=>{if(this._abortController.signal.aborted)return void this._reject(t,new Xe(Qe.Cancelled,"Cancelled"));if(!this._checkDicomFile(o))return void this._reject(t,new Xe(Qe.Failed,"Not a valid DICOM file."));const a=new XMLHttpRequest;return this._addRequestCallbacks(a,n),this._dataSource.store.dicom(o,a).then((()=>{this._status=Qe.Success,e()})).catch((e=>{this._reject(t,e)}))})).catch((e=>{this._reject(t,e)}))}))),this._loadPromise}_isRejected(){return this._status===Qe.Failed||this._status===Qe.Cancelled}_reject(e,t){if(!this._isRejected()){if(t instanceof Xe)return this._status=t.status,void e(t);this._status=Qe.Failed,t.message?e(new Xe(Qe.Failed,t.message)):e(new Xe(Qe.Failed,t))}}_addRequestCallbacks(e,t){const n=()=>e.abort();this._abortController.signal.addEventListener("abort",n);for(const[n,o]of Object.entries(t))e.upload.addEventListener(n,o);const o=()=>{this._abortController.signal.removeEventListener("abort",n);for(const[n,o]of Object.entries(t))e.upload.removeEventListener(n,o);e.removeEventListener("loadend",o)};e.addEventListener("loadend",o)}_checkDicomFile(e){if(e.length<=132)return!1;const t=new Uint8Array(e.slice(128,132));return Array.from("DICM").every(((e,n)=>e.charCodeAt(0)===t[n]))}}const tt=(0,r.memo)((({dicomFileUploader:e})=>{const[t,n]=(0,r.useState)(e.getPercentComplete()),[o,a]=(0,r.useState)(""),[i,s]=(0,r.useState)(e.getStatus()),l=(0,r.useCallback)((()=>i===Qe.Failed||i===Qe.Cancelled||i===Qe.Success),[i]);(0,r.useEffect)((()=>{const t=e.subscribe(Je.PROGRESS,(e=>{n(e.percentComplete)}));return e.load().catch((e=>{s(e.status),a(e.message??"")})).finally((()=>s(e.getStatus()))),()=>t.unsubscribe()}),[]);const c=(0,r.useCallback)((()=>{e.cancel()}),[]);return r.createElement("div",{className:"min-h-14 border-secondary-light flex w-full items-center overflow-hidden border-b p-2.5 text-lg"},r.createElement("div",{className:"self-top flex w-0 shrink grow flex-col gap-1"},r.createElement("div",{className:"flex gap-4"},r.createElement("div",{className:"flex w-6 shrink-0 items-center justify-center"},(()=>{switch(e.getStatus()){case Qe.Success:return r.createElement(V.JO,{name:"status-tracked",className:"text-primary-light"});case Qe.InProgress:return r.createElement(V.JO,{name:"icon-transferring"});case Qe.Failed:return r.createElement(V.JO,{name:"icon-alert-small"});case Qe.Cancelled:return r.createElement(V.JO,{name:"icon-alert-outline"});default:return r.createElement(r.Fragment,null)}})()),r.createElement("div",{className:"overflow-hidden text-ellipsis whitespace-nowrap"},e.getFileName())),o&&r.createElement("div",{className:"pl-10"},o)),r.createElement("div",{className:"flex w-24 items-center"},!l()&&r.createElement(r.Fragment,null,e.getStatus()===Qe.InProgress&&r.createElement("div",{className:"w-10 text-right"},t,"%"),r.createElement("div",{className:"ml-auto flex cursor-pointer"},r.createElement(V.JO,{className:"text-primary-active self-center",name:"close",onClick:c})))))}));tt.propTypes={dicomFileUploader:Ze().instanceOf(et).isRequired};const nt=tt,ot=1e3,at=6e4,rt=36e5,it=15e3,st="text-ellipsis whitespace-nowrap overflow-hidden";function lt({dicomFileUploaderArr:e,onComplete:t}){const[n]=(0,r.useState)(e.reduce(((e,t)=>e+t.getFileSize()),0)),o=(0,r.useRef)(0),a=(0,r.useRef)(0),[i,s]=(0,r.useState)(null),[l,c]=(0,r.useState)(0),[d,m]=(0,r.useState)(0),[u,g]=(0,r.useState)(0),[p,h]=(0,r.useState)(!1),I=(0,r.useRef)();(0,r.useEffect)((()=>{let e,t=0,r=Date.now();const i=()=>{const s=o.current-t,l=Date.now(),c=l-r;a.current=s/c,t=o.current,r=l,n-o.current>0&&(e=a.current>=75?setTimeout(i,it):setTimeout(i,3e4))};return e=setTimeout(i,it),()=>{clearTimeout(e)}}),[]),(0,r.useEffect)((()=>{let t=null;const r=e.map((e=>{let r=0;const i=i=>{const l=r;if(r=Math.round(i/100*e.getFileSize()),o.current=Math.min(n,o.current-l+r),c(o.current/n*100),0!==a.current){const e=n-o.current,r=Math.round(e/a.current);if(null===t)return t=r,void s(t);if(r<at){const e=Math.ceil(t/ot),n=Math.ceil(r/ot)-e;return void((n<0||n>2)&&(t=r,s(t)))}if(r<rt){const e=Math.ceil(t/at),n=Math.ceil(r/at)-e;return void((n<0||n>2)&&(t=r,s(t)))}t=r,s(t)}};return e.load().catch((e=>{e.status===Qe.Failed&&g((e=>e+1))})).finally((()=>{i(100),m((e=>e+1))})),e.subscribe(Je.PROGRESS,(e=>{i(e.percentComplete)}))}));return()=>{r.forEach((e=>e.unsubscribe()))}}),[]);const S=(0,r.useCallback)((async()=>{for(const t of e){new Promise(((e,n)=>{setTimeout((()=>{t.cancel(),e()}),0)}))}}),[]),f=(0,r.useCallback)((()=>{if(null==i)return"";if(i<at){const e=Math.ceil(i/ot);return`${e} ${1===e?"second":"seconds"}`}if(i<rt){const e=Math.ceil(i/at);return`${e} ${1===e?"minute":"minutes"}`}const e=Math.ceil(i/rt);return`${e} ${1===e?"hour":"hours"}`}),[i]),v=(0,r.useCallback)((()=>Math.min(100,Math.round(l))),[l]),y=(0,r.useCallback)((()=>v()<1&&(I?.current?.offsetWidth??0)*(l/100)<1),[v,l]),w=(0,r.useCallback)((()=>({width:`${2*e.length.toString().length+4}ch`})),[]),E=()=>r.createElement("div",{className:"ml-auto flex w-6 justify-center"},u>0&&r.createElement("div",{onClick:()=>h((e=>!e))},r.createElement(V.JO,{className:"cursor-pointer",name:"icon-status-alert"})));return r.createElement("div",{className:"flex grow flex-col"},r.createElement("div",{className:"bg-primary-dark flex h-14 items-center px-1 pb-4 text-lg"},d===e.length?r.createElement(r.Fragment,null,r.createElement("span",{className:st},`${e.length} ${e.length>1?"files":"file"} completed.`),r.createElement(V.zx,{disabled:!1,className:"ml-auto",onClick:t},"Close")):r.createElement(r.Fragment,null,r.createElement("span",{style:w(),className:Ke()(st,"text-end")},`${d} of ${e.length}`," "),r.createElement("span",{className:st}," files completed."," "),r.createElement("span",{className:st},i?`Less than ${f()} remaining. `:""),r.createElement("span",{className:Ke()(st,"text-primary-active hover:text-primary-light active:text-aqua-pale ml-auto cursor-pointer"),onClick:S},"Cancel All Uploads"))),r.createElement("div",{className:"flex grow flex-col overflow-hidden bg-black text-lg"},r.createElement("div",{className:"ohif-scrollbar border-secondary-light overflow-y-scroll border-b px-2"},r.createElement("div",{className:"min-h-14 flex w-full items-center p-2.5"},d===e.length?r.createElement(r.Fragment,null,r.createElement("div",{className:"text-primary-light text-xl"},u>0?`Completed with ${u} ${u>1?"errors":"error"}!`:"Completed!"),E()):r.createElement(r.Fragment,null,r.createElement("div",{ref:I,className:"flex-grow"},r.createElement(V.YE,{progress:y()?void 0:Math.min(100,l)})),r.createElement("div",{className:"ml-1 flex w-24 items-center"},r.createElement("div",{className:"w-10 text-right"},`${v()}%`),E())))),r.createElement("div",{className:"ohif-scrollbar h-1 grow overflow-y-scroll px-2"},e.filter((e=>!p||e.getStatus()===Qe.Failed)).map((e=>r.createElement(nt,{key:e.getFileId(),dicomFileUploader:e}))))))}lt.propTypes={dicomFileUploaderArr:Ze().arrayOf(Ze().instanceOf(et)).isRequired,onComplete:Ze().func.isRequired};const ct=lt;function dt(){return dt=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var o in n)Object.prototype.hasOwnProperty.call(n,o)&&(e[o]=n[o])}return e},dt.apply(this,arguments)}function mt({dataSource:e,onComplete:t,onStarted:n}){const o="min-h-[480px] flex flex-col bg-black select-none",[a,i]=(0,r.useState)([]),s=(0,r.useCallback)((async t=>{n(),i(t.map((t=>new et(t,e))))}),[]);return r.createElement(r.Fragment,null,a.length?r.createElement("div",{className:Ke()("h-[calc(100vh-300px)]",o)},r.createElement(ct,{dicomFileUploaderArr:Array.from(a),onComplete:t})):r.createElement("div",{className:Ke()("h-[480px]",o)},r.createElement(We.Z,{onDrop:e=>{s(e)},noClick:!0},(({getRootProps:e})=>r.createElement("div",dt({},e(),{className:"dicom-upload-drop-area-border-dash m-5 flex h-full flex-col items-center justify-center"}),r.createElement("div",{className:"flex gap-3"},r.createElement(We.Z,{onDrop:s,noDrag:!0},(({getRootProps:e,getInputProps:t})=>r.createElement("div",e(),r.createElement(V.zx,{disabled:!1,onClick:()=>{}},"Add files",r.createElement("input",t()))))),r.createElement(We.Z,{onDrop:s,noDrag:!0},(({getRootProps:e,getInputProps:t})=>r.createElement("div",e(),r.createElement(V.zx,{type:V.LZ.dt.secondary,disabled:!1,onClick:()=>{}},"Add folder",r.createElement("input",dt({},t(),{webkitdirectory:"true",mozdirectory:"true"}))))))),r.createElement("div",{className:"pt-5"},"or drag images or folders here"),r.createElement("div",{className:"text-aqua-pale pt-3 text-lg"},"(DICOM files supported)"))))))}mt.propTypes={dataSource:Ze().object.isRequired,onComplete:Ze().func.isRequired,onStarted:Ze().func.isRequired};const ut=mt,gt={active:[{toolName:Z.WindowLevel,bindings:[{mouseButton:s.Enums.MouseBindings.Primary}]},{toolName:Z.Pan,bindings:[{mouseButton:s.Enums.MouseBindings.Auxiliary}]},{toolName:Z.Zoom,bindings:[{mouseButton:s.Enums.MouseBindings.Secondary}]},{toolName:Z.StackScrollMouseWheel,bindings:[]}],enabled:[{toolName:Z.SegmentationDisplay}]};const pt=function(){return[{name:"cornerstoneDicomUploadComponent",value:{id:"dicomUploadComponent",component:ut}},{name:"default",value:[{id:"cornerstone.overlayViewportTools",tools:gt}]}]};var ht=n(76010);const It=512,St=1e4,ft="cornerstone-viewport-download-form",vt=({onClose:e,activeViewportId:t,cornerstoneViewportService:n})=>{const o=(0,x.K8)(t),a=o?.element,l=(0,i.getEnabledElement)(a),{viewportId:c,renderingEngineId:d}=l,m=s.ToolGroupManager.getToolGroupForViewport(c,d),u=Object.keys(m.toolOptions).reduce(((e,t)=>{const n=m.toolOptions[t],{mode:o,bindings:a}=n;return{...e,[t]:{mode:o,bindings:a}}}),{});(0,r.useEffect)((()=>()=>{Object.keys(u).forEach((e=>{const{mode:t,bindings:n}=u[e];m.setToolMode(e,t,{bindings:n})}))}),[]);return r.createElement(V.mQ,{onClose:e,minimumSize:100,maximumSize:St,defaultSize:It,canvasClass:"cornerstone-canvas",activeViewportElement:a,enableViewport:e=>{if(e){const{renderingEngine:t,viewport:n}=(0,i.getEnabledElement)(a),o={viewportId:ft,element:e,type:n.type,defaultOptions:{background:n.defaultOptions.background,orientation:n.defaultOptions.orientation}};t.enableElement(o)}},disableViewport:e=>{if(e){const{renderingEngine:t}=(0,i.getEnabledElement)(e);return new Promise((e=>{t.disableElement(ft)}))}},updateViewportPreview:(e,t,n)=>new Promise((t=>{const o=(0,i.getEnabledElement)(e),{viewport:a,renderingEngine:r}=o;r.resize(),a.render(),e.addEventListener(i.Enums.Events.IMAGE_RENDERED,(function o(a){const r=(0,i.getEnabledElement)(a.target),{viewport:s}=r,{element:l}=s,c=(0,i.getOrCreateCanvas)(l),d="image/"+n,m=c.toDataURL(d,1);let u=l.offsetHeight,g=l.offsetWidth;if(u>It||g>It){const e=It/Math.max(u,g);g*=e,u*=e}t({dataUrl:m,width:u,height:g}),e.removeEventListener(i.Enums.Events.IMAGE_RENDERED,o)}))})),loadImage:(e,t,o,a)=>new Promise((r=>{if(e&&t){const t=(0,i.getEnabledElement)(e);if(!t)return;const{viewport:s}=t,l=n.getRenderingEngine().getViewport(ft);if(l instanceof i.StackViewport){const e=s.getCurrentImageId(),t=s.getProperties();l.setStack([e]).then((()=>{try{l.setProperties(t);const e=Math.min(o||image.width,St),n=Math.min(a||image.height,St);r({width:e,height:n})}catch(e){console.warn("Unable to set properties",e)}}))}else if(l instanceof i.VolumeViewport){s.getActors().forEach((e=>{l.addActor(e)})),l.setCamera(s.getCamera()),l.render();const e=Math.min(o||image.width,St),t=Math.min(a||image.height,St);r({width:e,height:t})}}})),toggleAnnotations:(e,t,n)=>{const o=(0,i.getEnabledElement)(n),a=(0,i.getEnabledElement)(t),{viewportId:r,renderingEngineId:l}=o,{viewportId:c}=a;if(!o||!a)return;const d=s.ToolGroupManager.getToolGroupForViewport(r,l);d.addViewport(c,l),Object.keys(d._toolInstances).forEach((t=>{if(e&&"Crosshairs"!==t)try{d.setToolEnabled(t)}catch(e){console.log(e)}else d.setToolDisabled(t)}))},downloadBlob:(e,t)=>{const n=`${e}.${t}`,o=document.querySelector(`div[data-viewport-uid="${ft}"]`);(0,ht.Z)(o).then((e=>{const o=document.createElement("a");o.download=n,o.href=e.toDataURL(t,1),o.click()}))}})};vt.propTypes={onClose:Ze().func,activeViewportId:Ze().string.isRequired};const yt=vt,wt="stackImageSync";function Et({toggledState:e,servicesManager:t,viewports:n}){if(!e)return function(e,t){const{syncGroupService:n,viewportGridService:o,displaySetService:a,cornerstoneViewportService:r}=t.services,i=Tt(o,a);i.forEach((t=>{const{viewportId:o}=t.viewportOptions,a=r.getCornerstoneViewport(o);a&&n.removeViewportFromSyncGroup(a.id,a.getRenderingEngine().id,e)}))}(wt,t);const{syncGroupService:o,viewportGridService:a,displaySetService:r,cornerstoneViewportService:i}=t.services;(n||Tt(a,r)).forEach((e=>{const{viewportId:t}=e.viewportOptions,n=i.getCornerstoneViewport(t);n&&o.addViewportToSyncGroup(t,n.getRenderingEngine().id,{type:"stackimage",id:wt,source:!0,target:!0})}))}function Tt(e,t){let{viewports:n}=e.getState();return n=[...n.values()],n=n.filter((e=>e.displaySetInstanceUIDs&&e.displaySetInstanceUIDs.length)),n=n.filter((e=>{const{displaySetInstanceUIDs:n}=e;for(const e of n){const n=t.getDisplaySetByUID(e);return!(!n||!n.isReconstructable)}})),n}const Dt=function({servicesManager:e,commandsManager:t}){const{viewportGridService:n,toolGroupService:o,cineService:a,toolbarService:r,uiDialogService:l,cornerstoneViewportService:d,uiNotificationService:m,measurementService:u}=e.services,{measurementServiceSource:g}=this;function p(){return L(n)}const h={showCornerstoneContextMenu:e=>{const n=p()?.viewport?.element,o={...e,element:n},{useSelectedAnnotation:a,nearbyToolData:r,event:i}=o;if(a&&!r){const e=te();if(!(!o.allowedSelectedTools||o.allowedSelectedTools.includes(e?.metadata?.toolName)))return;o.nearbyToolData=e}o.defaultPointsPosition=[],o.selectorProps={toolName:o.nearbyToolData?.metadata?.toolName,value:o.nearbyToolData,uid:o.nearbyToolData?.annotationUID,nearbyToolData:o.nearbyToolData,event:i,...o.selectorProps},t.run(e,o)},getNearbyToolData:({nearbyToolData:e,element:t,canvasCoordinates:n})=>e??s.utilities.getAnnotationNearPoint(t,n),getNearbyAnnotation({element:e,canvasCoordinates:t}){const n=h.getNearbyToolData({nearbyToolData:null,element:e,canvasCoordinates:t});return n?.metadata?.toolName&&(t=>{const n=(0,i.getEnabledElement)(e);if(!n)return;const{renderingEngineId:o,viewportId:a}=n,r=s.ToolGroupManager.getToolGroupForViewport(a,o).getToolInstance(t);return r?.constructor?.isAnnotation??!0})(n.metadata.toolName)?n:null},deleteMeasurement:({uid:e})=>{e&&g.remove(e)},setMeasurementLabel:({uid:e})=>{const t=u.getMeasurement(e);P(l,t,((e,n)=>{if("cancel"===n)return;const o=Object.assign({},t,{label:e});u.update(o.uid,o,!0)}),!1)},updateMeasurement:e=>{const{code:t,uid:n,textLabel:o,label:a}=e,r={...u.getMeasurement(n)};if(void 0!==o&&(r.label=o),void 0!==t){const e=t.type||"finding";if(t.ref&&!t.CodeValue){const e=t.ref.indexOf(":");t.CodeValue=t.ref.substring(e+1),t.CodeMeaning=t.text||a,t.CodingSchemeDesignator=t.ref.substring(0,e)}r[e]=t,"finding"!==e&&(r.findingSites?(r.findingSites=r.findingSites.filter((t=>t.type!==e)),r.findingSites.push(t)):r.findingSites=[t])}u.update(r.uid,r,!0)},getActiveViewportEnabledElement:p,setViewportActive:({viewportId:e})=>{d.getViewportInfo(e)?n.setActiveViewportId(e):console.warn("No viewport found for viewportId:",e)},arrowTextCallback:({callback:e,data:t})=>{P(l,t,e)},cleanUpCrosshairs:()=>{const e=o.getToolGroup(null);e._toolInstances?.Crosshairs?.mode===s.Enums.ToolModes.Active&&h.toolbarServiceRecordInteraction({interactionType:"tool",commands:[{commandOptions:{toolName:"WindowLevel"},context:"CORNERSTONE"}]})},toggleCine:()=>{const{viewports:e}=n.getState(),{isCineEnabled:t}=a.getState();a.setIsCineEnabled(!t),r.setButton("Cine",{props:{isActive:!t}}),e.forEach(((e,t)=>a.setCine({id:t,isPlaying:!1})))},setWindowLevel({window:e,level:t,toolGroupId:n}){const a=Number(e),r=Number(t),{viewportId:s}=p(),l=o.getToolGroupForViewport(s);if(n&&n!==l)return;const c=d.getRenderingEngine().getViewport(s),{lower:m,upper:u}=i.utilities.windowLevel.toLowHighRange(a,r);c.setProperties({voiRange:{upper:u,lower:m}}),c.render()},toolbarServiceRecordInteraction:e=>{r.recordInteraction(e)},setToolbarToggled:e=>{r.setToggled(e.toolId,e.isActive??!0)},setToolActive:({toolName:e,toolGroupId:t=null,toggledState:a})=>{if("Crosshairs"===e){if(!o.getToolGroup(null)._toolInstances.Crosshairs)throw m.show({title:"Crosshairs",message:"You need to be in a MPR view to use Crosshairs. Click on MPR button in the toolbar to activate it.",type:"info",duration:3e3}),new Error("Crosshairs tool is not available in this viewport")}const{viewports:r}=n.getState();if(!r.size)return;const i=o.getToolGroup(t);if(!i)return;if(!i.getToolInstance(e))throw m.show({title:`${e} tool`,message:`The ${e} tool is not available in this viewport.`,type:"info",duration:3e3}),new Error(`ToolGroup ${i.id} does not have this tool.`);const l=i.getActivePrimaryMouseButtonTool();l&&("Crosshairs"===l?i.setToolDisabled(l):i.setToolPassive(l)),null==a?i.setToolActive(e,{bindings:[{mouseButton:s.Enums.MouseBindings.Primary}]}):a?i.setToolEnabled(e):i.setToolDisabled(e)},recordSetToolActive:({toolName:e})=>{r.recordInteraction({interactionType:"tool",commands:[{commandName:"setToolActive",commandOptions:{toolName:e}}]})},showDownloadViewportModal:()=>{const{activeViewportId:t}=n.getState();if(!d.getCornerstoneViewport(t))return void m.show({title:"Download Image",message:"Image cannot be downloaded",type:"error"});const{uiModalService:o}=e.services;o&&o.show({content:yt,title:"Download High Quality Image",contentProps:{activeViewportId:t,onClose:o.hide,cornerstoneViewportService:d}})},rotateViewport:({rotation:e})=>{const t=p();if(!t)return;const{viewport:n}=t;if(n instanceof i.BaseVolumeViewport){const t=n.getCamera(),o=e*Math.PI/180,a=c._E.identity(new Float32Array(16));c._E.rotate(a,a,o,t.viewPlaneNormal);const r=c.R3.transformMat4(c.R3.create(),t.viewUp,a);n.setCamera({viewUp:r}),n.render()}else if(void 0!==n.getRotation){const t=(n.getRotation()+e)%360;n.setProperties({rotation:t}),n.render()}},flipViewportHorizontal:()=>{const e=p();if(!e)return;const{viewport:t}=e;if(t instanceof i.StackViewport){const{flipHorizontal:e}=t.getCamera();t.setCamera({flipHorizontal:!e}),t.render()}},flipViewportVertical:()=>{const e=p();if(!e)return;const{viewport:t}=e;if(t instanceof i.StackViewport){const{flipVertical:e}=t.getCamera();t.setCamera({flipVertical:!e}),t.render()}},invertViewport:({element:e})=>{let t;if(t=void 0===e?p():e,!t)return;const{viewport:n}=t,{invert:o}=n.getProperties();n.setProperties({invert:!o}),n.render()},resetViewport:()=>{const e=p();if(!e)return;const{viewport:t}=e;t.resetProperties?.(),t.resetCamera(),t.render()},scaleViewport:({direction:e})=>{const t=p(),n=e>0?.9:1.1;if(!t)return;const{viewport:o}=t;if(o instanceof i.StackViewport)if(e){const{parallelScale:e}=o.getCamera();o.setCamera({parallelScale:e*n}),o.render()}else o.resetCamera(),o.render()},jumpToImage:({imageIndex:e,viewport:t})=>{let n;if(t)n=d.getCornerstoneViewport(t.id);else{const e=p();if(!e)return;n=e.viewport}let o=0;if(n instanceof i.StackViewport)o=n.getImageIds().length;else{if(!(n instanceof i.VolumeViewport))throw new Error("Unsupported viewport type");o=i.utilities.getImageSliceDataForVolumeViewport(n).numberOfSlices}const a=e<0?o+e:e;if(a>=o||a<0)throw new Error(`Can't jump to ${e}`);const r={imageIndex:a};s.utilities.jumpToSlice(n.element,r)},scroll:({direction:e})=>{const t=p();if(!t)return;const{viewport:n}=t,o={delta:e};s.utilities.scroll(n,o)},setViewportColormap:({viewportId:e,displaySetInstanceUID:t,colormap:n,immediate:o=!1})=>{const a=d.getCornerstoneViewport(e),r=a.getActors().find((e=>e.uid.includes(t))),{actor:i,uid:s}=r;a.setProperties({colormap:n,volumeActor:i},s),o&&a.render()},changeActiveViewport:({direction:e=1})=>{const{activeViewportId:t,viewports:o}=n.getState(),a=Array.from(o.keys()),r=(a.indexOf(t)+e+a.length)%a.length;n.setActiveViewportId(a[r])},toggleStackImageSync:({toggledState:t})=>{Et({servicesManager:e,toggledState:t})},setSourceViewportForReferenceLinesTool:({toggledState:e,viewportId:t})=>{if(!t){const{activeViewportId:e}=n.getState();t=e}o.getToolGroupForViewport(t).setToolConfiguration(s.ReferenceLinesTool.toolName,{sourceViewportId:t},!0)},storePresentation:({viewportId:e})=>{d.storePresentation({viewportId:e})},attachProtocolViewportDataListener:({protocol:e,stageIndex:n})=>{const o=d.EVENTS.VIEWPORT_DATA_CHANGED,a=e.callbacks.onViewportDataInitialized,r=e.stages?.[n]?.viewports.length??1;let i=0;const{unsubscribe:s}=d.subscribe(o,(e=>{i++,i===r&&(t.run(...a),s(o))}))}},I={showCornerstoneContextMenu:{commandFn:h.showCornerstoneContextMenu,storeContexts:[],options:{menuCustomizationId:"measurementsContextMenu",commands:[{commandName:"showContextMenu"}]}},getNearbyToolData:{commandFn:h.getNearbyToolData},getNearbyAnnotation:{commandFn:h.getNearbyAnnotation,storeContexts:[],options:{}},deleteMeasurement:{commandFn:h.deleteMeasurement},setMeasurementLabel:{commandFn:h.setMeasurementLabel},updateMeasurement:{commandFn:h.updateMeasurement},setWindowLevel:{commandFn:h.setWindowLevel},toolbarServiceRecordInteraction:{commandFn:h.toolbarServiceRecordInteraction},setToolActive:{commandFn:h.setToolActive},recordSetToolActive:{commandFn:h.recordSetToolActive},rotateViewportCW:{commandFn:h.rotateViewport,options:{rotation:90}},rotateViewportCCW:{commandFn:h.rotateViewport,options:{rotation:-90}},incrementActiveViewport:{commandFn:h.changeActiveViewport},decrementActiveViewport:{commandFn:h.changeActiveViewport,options:{direction:-1}},flipViewportHorizontal:{commandFn:h.flipViewportHorizontal},flipViewportVertical:{commandFn:h.flipViewportVertical},invertViewport:{commandFn:h.invertViewport},resetViewport:{commandFn:h.resetViewport},scaleUpViewport:{commandFn:h.scaleViewport,options:{direction:1}},scaleDownViewport:{commandFn:h.scaleViewport,options:{direction:-1}},fitViewportToWindow:{commandFn:h.scaleViewport,options:{direction:0}},nextImage:{commandFn:h.scroll,options:{direction:1}},previousImage:{commandFn:h.scroll,options:{direction:-1}},firstImage:{commandFn:h.jumpToImage,options:{imageIndex:0}},lastImage:{commandFn:h.jumpToImage,options:{imageIndex:-1}},jumpToImage:{commandFn:h.jumpToImage},showDownloadViewportModal:{commandFn:h.showDownloadViewportModal},toggleCine:{commandFn:h.toggleCine},arrowTextCallback:{commandFn:h.arrowTextCallback},setViewportActive:{commandFn:h.setViewportActive},setViewportColormap:{commandFn:h.setViewportColormap},toggleStackImageSync:{commandFn:h.toggleStackImageSync},setSourceViewportForReferenceLinesTool:{commandFn:h.setSourceViewportForReferenceLinesTool},storePresentation:{commandFn:h.storePresentation},setToolbarToggled:{commandFn:h.setToolbarToggled},cleanUpCrosshairs:{commandFn:h.cleanUpCrosshairs},attachProtocolViewportDataListener:{commandFn:h.attachProtocolViewportDataListener}};return{actions:h,definitions:I,defaultContext:"CORNERSTONE"}},bt={id:"fourUp",locked:!0,name:"fourUp",createdDate:"2023-03-15T10:29:44.894Z",modifiedDate:"2023-03-15T10:29:44.894Z",availableTo:{},editableBy:{},protocolMatchingRules:[],imageLoadStrategy:"interleaveCenter",displaySetSelectors:{mprDisplaySet:{seriesMatchingRules:[{weight:1,attribute:"isReconstructable",constraint:{equals:{value:!0}},required:!0}]}},stages:[{id:"fourUpStage",name:"fourUp",viewportStructure:{layoutType:"grid",properties:{rows:2,columns:2}},viewports:[{viewportOptions:{toolGroupId:"mpr",viewportType:"volume",orientation:"axial",initialImageOptions:{preset:"middle"},syncGroups:[{type:"voi",id:"mpr",source:!0,target:!0}]},displaySets:[{id:"mprDisplaySet"}]},{viewportOptions:{toolGroupId:"volume3d",viewportType:"volume3d",orientation:"coronal",customViewportProps:{hideOverlays:!0}},displaySets:[{id:"mprDisplaySet",options:{displayPreset:"CT-Bone"}}]},{viewportOptions:{toolGroupId:"mpr",viewportType:"volume",orientation:"coronal",initialImageOptions:{preset:"middle"},syncGroups:[{type:"voi",id:"mpr",source:!0,target:!0}]},displaySets:[{id:"mprDisplaySet"}]},{viewportOptions:{toolGroupId:"mpr",viewportType:"volume",orientation:"sagittal",initialImageOptions:{preset:"middle"},syncGroups:[{type:"voi",id:"mpr",source:!0,target:!0}]},displaySets:[{id:"mprDisplaySet"}]}]}]},Ot={id:"main3D",locked:!0,name:"main3D",createdDate:"2023-03-15T10:29:44.894Z",modifiedDate:"2023-03-15T10:29:44.894Z",availableTo:{},editableBy:{},protocolMatchingRules:[],imageLoadStrategy:"interleaveCenter",displaySetSelectors:{mprDisplaySet:{seriesMatchingRules:[{weight:1,attribute:"isReconstructable",constraint:{equals:{value:!0}},required:!0}]}},stages:[{id:"main3DStage",name:"main3D",viewportStructure:{layoutType:"grid",properties:{rows:2,columns:3,layoutOptions:[{x:0,y:0,width:1,height:.5},{x:0,y:.5,width:1/3,height:.5},{x:1/3,y:.5,width:1/3,height:.5},{x:2/3,y:.5,width:1/3,height:.5}]}},viewports:[{viewportOptions:{toolGroupId:"volume3d",viewportType:"volume3d",orientation:"coronal",customViewportProps:{hideOverlays:!0}},displaySets:[{id:"mprDisplaySet",options:{displayPreset:"CT-Bone"}}]},{viewportOptions:{toolGroupId:"mpr",viewportType:"volume",orientation:"axial",initialImageOptions:{preset:"middle"},syncGroups:[{type:"voi",id:"mpr",source:!0,target:!0}]},displaySets:[{id:"mprDisplaySet"}]},{viewportOptions:{toolGroupId:"mpr",viewportType:"volume",orientation:"coronal",initialImageOptions:{preset:"middle"},syncGroups:[{type:"voi",id:"mpr",source:!0,target:!0}]},displaySets:[{id:"mprDisplaySet"}]},{viewportOptions:{toolGroupId:"mpr",viewportType:"volume",orientation:"sagittal",initialImageOptions:{preset:"middle"},syncGroups:[{type:"voi",id:"mpr",source:!0,target:!0}]},displaySets:[{id:"mprDisplaySet"}]}]}]},At={id:"mpr",name:"Multi-Planar Reconstruction",locked:!0,createdDate:"2021-02-23",modifiedDate:"2023-08-15",availableTo:{},editableBy:{},numberOfPriorsReferenced:0,protocolMatchingRules:[],imageLoadStrategy:"nth",callbacks:{onLayoutChange:[{commandName:"toggleHangingProtocol",commandOptions:{protocolId:"mpr"},context:"DEFAULT"}],onProtocolExit:[{commandName:"cleanUpCrosshairs"}]},displaySetSelectors:{activeDisplaySet:{seriesMatchingRules:[{weight:1,attribute:"isReconstructable",constraint:{equals:{value:!0}},required:!0}]}},stages:[{name:"MPR 1x3",viewportStructure:{layoutType:"grid",properties:{rows:1,columns:3,layoutOptions:[{x:0,y:0,width:1/3,height:1},{x:1/3,y:0,width:1/3,height:1},{x:2/3,y:0,width:1/3,height:1}]}},viewports:[{viewportOptions:{viewportId:"mpr-axial",toolGroupId:"mpr",viewportType:"volume",orientation:"axial",initialImageOptions:{preset:"middle"},syncGroups:[{type:"voi",id:"mpr",source:!0,target:!0}]},displaySets:[{id:"activeDisplaySet"}]},{viewportOptions:{viewportId:"mpr-sagittal",toolGroupId:"mpr",viewportType:"volume",orientation:"sagittal",initialImageOptions:{preset:"middle"},syncGroups:[{type:"voi",id:"mpr",source:!0,target:!0}]},displaySets:[{id:"activeDisplaySet"}]},{viewportOptions:{viewportId:"mpr-coronal",toolGroupId:"mpr",viewportType:"volume",orientation:"coronal",initialImageOptions:{preset:"middle"},syncGroups:[{type:"voi",id:"mpr",source:!0,target:!0}]},displaySets:[{id:"activeDisplaySet"}]}]}]},Nt={id:"mprAnd3DVolumeViewport",locked:!0,name:"mpr",createdDate:"2023-03-15T10:29:44.894Z",modifiedDate:"2023-03-15T10:29:44.894Z",availableTo:{},editableBy:{},protocolMatchingRules:[],imageLoadStrategy:"interleaveCenter",displaySetSelectors:{mprDisplaySet:{seriesMatchingRules:[{weight:1,attribute:"isReconstructable",constraint:{equals:{value:!0}},required:!0},{attribute:"Modality",constraint:{equals:{value:"CT"}},required:!0}]}},stages:[{id:"mpr3Stage",name:"mpr",viewportStructure:{layoutType:"grid",properties:{rows:2,columns:2}},viewports:[{viewportOptions:{toolGroupId:"mpr",viewportType:"volume",orientation:"axial",initialImageOptions:{preset:"middle"},syncGroups:[{type:"voi",id:"mpr",source:!0,target:!0}]},displaySets:[{id:"mprDisplaySet"}]},{viewportOptions:{toolGroupId:"volume3d",viewportType:"volume3d",orientation:"coronal",customViewportProps:{hideOverlays:!0}},displaySets:[{id:"mprDisplaySet",options:{displayPreset:"CT-Bone"}}]},{viewportOptions:{toolGroupId:"mpr",viewportType:"volume",orientation:"coronal",initialImageOptions:{preset:"middle"},syncGroups:[{type:"voi",id:"mpr",source:!0,target:!0}]},displaySets:[{id:"mprDisplaySet"}]},{viewportOptions:{toolGroupId:"mpr",viewportType:"volume",orientation:"sagittal",initialImageOptions:{preset:"middle"},syncGroups:[{type:"voi",id:"mpr",source:!0,target:!0}]},displaySets:[{id:"mprDisplaySet"}]}]}]},Ct={id:"only3D",locked:!0,name:"only3D",createdDate:"2023-03-15T10:29:44.894Z",modifiedDate:"2023-03-15T10:29:44.894Z",availableTo:{},editableBy:{},protocolMatchingRules:[],imageLoadStrategy:"interleaveCenter",displaySetSelectors:{mprDisplaySet:{seriesMatchingRules:[{weight:1,attribute:"isReconstructable",constraint:{equals:{value:!0}},required:!0}]}},stages:[{id:"only3DStage",name:"only3D",viewportStructure:{layoutType:"grid",properties:{rows:1,columns:1}},viewports:[{viewportOptions:{toolGroupId:"volume3d",viewportType:"volume3d",orientation:"coronal",customViewportProps:{hideOverlays:!0}},displaySets:[{id:"mprDisplaySet",options:{displayPreset:"CT-Bone"}}]}]}]},Mt={id:"primary3D",locked:!0,name:"primary3D",createdDate:"2023-03-15T10:29:44.894Z",modifiedDate:"2023-03-15T10:29:44.894Z",availableTo:{},editableBy:{},protocolMatchingRules:[],imageLoadStrategy:"interleaveCenter",displaySetSelectors:{mprDisplaySet:{seriesMatchingRules:[{weight:1,attribute:"isReconstructable",constraint:{equals:{value:!0}},required:!0}]}},stages:[{id:"primary3DStage",name:"primary3D",viewportStructure:{layoutType:"grid",properties:{rows:3,columns:3,layoutOptions:[{x:0,y:0,width:2/3,height:1},{x:2/3,y:0,width:1/3,height:1/3},{x:2/3,y:1/3,width:1/3,height:1/3},{x:2/3,y:2/3,width:1/3,height:1/3}]}},viewports:[{viewportOptions:{toolGroupId:"volume3d",viewportType:"volume3d",orientation:"coronal",customViewportProps:{hideOverlays:!0}},displaySets:[{id:"mprDisplaySet",options:{displayPreset:"CT-Bone"}}]},{viewportOptions:{toolGroupId:"mpr",viewportType:"volume",orientation:"axial",initialImageOptions:{preset:"middle"},syncGroups:[{type:"voi",id:"mpr",source:!0,target:!0}]},displaySets:[{id:"mprDisplaySet"}]},{viewportOptions:{toolGroupId:"mpr",viewportType:"volume",orientation:"coronal",initialImageOptions:{preset:"middle"},syncGroups:[{type:"voi",id:"mpr",source:!0,target:!0}]},displaySets:[{id:"mprDisplaySet"}]},{viewportOptions:{toolGroupId:"mpr",viewportType:"volume",orientation:"sagittal",initialImageOptions:{preset:"middle"},syncGroups:[{type:"voi",id:"mpr",source:!0,target:!0}]},displaySets:[{id:"mprDisplaySet"}]}]}]},Ut={id:"primaryAxial",locked:!0,name:"primaryAxial",createdDate:"2023-03-15T10:29:44.894Z",modifiedDate:"2023-03-15T10:29:44.894Z",availableTo:{},editableBy:{},protocolMatchingRules:[],imageLoadStrategy:"interleaveCenter",displaySetSelectors:{mprDisplaySet:{seriesMatchingRules:[{weight:1,attribute:"isReconstructable",constraint:{equals:{value:!0}},required:!0}]}},stages:[{id:"primaryAxialStage",name:"primaryAxial",viewportStructure:{layoutType:"grid",properties:{rows:2,columns:3,layoutOptions:[{x:0,y:0,width:2/3,height:1},{x:2/3,y:0,width:1/3,height:.5},{x:2/3,y:.5,width:1/3,height:.5}]}},viewports:[{viewportOptions:{toolGroupId:"mpr",viewportType:"volume",orientation:"axial",initialImageOptions:{preset:"middle"},syncGroups:[{type:"voi",id:"mpr",source:!0,target:!0}]},displaySets:[{id:"mprDisplaySet"}]},{viewportOptions:{toolGroupId:"mpr",viewportType:"volume",orientation:"sagittal",initialImageOptions:{preset:"middle"},syncGroups:[{type:"voi",id:"mpr",source:!0,target:!0}]},displaySets:[{id:"mprDisplaySet"}]},{viewportOptions:{toolGroupId:"mpr",viewportType:"volume",orientation:"coronal",initialImageOptions:{preset:"middle"},syncGroups:[{type:"voi",id:"mpr",source:!0,target:!0}]},displaySets:[{id:"mprDisplaySet"}]}]}]};const Rt=function(){return[{name:At.id,protocol:At},{name:Nt.id,protocol:Nt},{name:bt.id,protocol:bt},{name:Ot.id,protocol:Ot},{name:Ut.id,protocol:Ut},{name:Ct.id,protocol:Ct},{name:Mt.id,protocol:Mt}]};var _t;const Vt={VIEWPORT_ADDED:"event::cornerstone::toolgroupservice:viewportadded",TOOLGROUP_CREATED:"event::cornerstone::toolgroupservice:toolgroupcreated"};class Pt{constructor(e){this.serviceManager=void 0,this.toolGroupIds=new Set,this.listeners=void 0,this.EVENTS=void 0;const{cornerstoneViewportService:t,viewportGridService:n}=e.services;this.cornerstoneViewportService=t,this.viewportGridService=n,this.listeners={},this.EVENTS=Vt,Object.assign(this,l.KZ)}onModeExit(){this.destroy()}getToolGroup(e){let t=e;if(!t){const e=L(this.viewportGridService);if(!e)return;const{renderingEngineId:n,viewportId:o}=e,a=s.ToolGroupManager.getToolGroupForViewport(o,n);if(!a)return void console.warn("No tool group found for viewportId:",o,"and renderingEngineId:",n);t=a.id}return s.ToolGroupManager.getToolGroup(t)}getToolGroupIds(){return Array.from(this.toolGroupIds)}getToolGroupForViewport(e){const t=this.cornerstoneViewportService.getRenderingEngine();return s.ToolGroupManager.getToolGroupForViewport(e,t.id)}getActiveToolForViewport(e){const t=this.getToolGroupForViewport(e);if(t)return t.getActivePrimaryMouseButtonTool()}destroy(){s.ToolGroupManager.destroy(),this.toolGroupIds=new Set}destroyToolGroup(e){s.ToolGroupManager.destroyToolGroup(e),this.toolGroupIds.delete(e)}removeViewportFromToolGroup(e,t,n){const o=s.ToolGroupManager.getToolGroupForViewport(e,t);if(!o)return;o.removeViewports(t,e);0===o.getViewportIds().length&&n&&s.ToolGroupManager.destroyToolGroup(o.id)}addViewportToToolGroup(e,t,n){if(n){let o=s.ToolGroupManager.getToolGroup(n);o||(o=this.createToolGroup(n)),o.addViewport(e,t)}else{s.ToolGroupManager.getAllToolGroups().forEach((n=>{n.addViewport(e,t)}))}this._broadcastEvent(Vt.VIEWPORT_ADDED,{viewportId:e,toolGroupId:n})}createToolGroup(e){if(this.getToolGroup(e))throw new Error(`ToolGroup ${e} already exists`);const t=s.ToolGroupManager.createToolGroup(e);return this.toolGroupIds.add(e),this._broadcastEvent(Vt.TOOLGROUP_CREATED,{toolGroupId:e}),t}addToolsToToolGroup(e,t,n={}){const o=s.ToolGroupManager.getToolGroup(e);this._addTools(o,t,n),this._setToolsMode(o,t)}createToolGroupAndAddTools(e,t){const n=this.createToolGroup(e);return this.addToolsToToolGroup(e,t),n}getToolConfiguration(e,t){const n=s.ToolGroupManager.getToolGroup(e);if(!n)return null;const o=n.getToolInstance(t);return o?o.configuration:null}setToolConfiguration(e,t,n){s.ToolGroupManager.getToolGroup(e).getToolInstance(t).configuration=n}_setToolsMode(e,t){const{active:n,passive:o,enabled:a,disabled:r}=t;n&&n.forEach((({toolName:t,bindings:n})=>{e.setToolActive(t,{bindings:n})})),o&&o.forEach((({toolName:t})=>{e.setToolPassive(t)})),a&&a.forEach((({toolName:t})=>{e.setToolEnabled(t)})),r&&r.forEach((({toolName:t})=>{e.setToolDisabled(t)}))}_addTools(e,t){const n=t=>{t.forEach((({toolName:t,parentTool:n,configuration:o})=>{n?e.addToolInstance(t,n,{...o}):e.addTool(t,{...o})}))};t.active&&n(t.active),t.passive&&n(t.passive),t.enabled&&n(t.enabled),t.disabled&&n(t.disabled)}}_t=Pt,Pt.REGISTRATION={name:"toolGroupService",altName:"ToolGroupService",create:({servicesManager:e})=>new _t(e)};const xt=Pt;var Lt;const Ft={TOOL_GROUP_CREATED:"event::cornerstone::syncgroupservice:toolgroupcreated"};class Gt{constructor(e){this.servicesManager=void 0,this.listeners={},this.EVENTS=void 0,this.synchronizerCreators={cameraposition:s.synchronizers.createCameraPositionSynchronizer,voi:s.synchronizers.createVOISynchronizer,zoompan:s.synchronizers.createZoomPanSynchronizer,stackimage:s.synchronizers.createStackImageSynchronizer},this.servicesManager=e,this.listeners={},this.EVENTS=Ft,Object.assign(this,l.KZ)}_createSynchronizer(e,t,n){const o=this.synchronizerCreators[e.toLowerCase()];if(o)return o(t,n);console.warn("Unknown synchronizer type",e,t)}addSynchronizerType(e,t){this.synchronizerCreators[e.toLowerCase()]=t}_getOrCreateSynchronizer(e,t,n){let o=s.SynchronizerManager.getSynchronizer(t);return o||(o=this._createSynchronizer(e,t,n)),o}addViewportToSyncGroup(e,t,n){if(!n)return;(Array.isArray(n)?n:[n]).forEach((n=>{const o=(e=>"string"==typeof e?{type:e}:e)(n),{type:a,target:r=!0,source:i=!0,options:s={},id:l=a}=o,c=this._getOrCreateSynchronizer(a,l,s);c.setOptions(e,s);const d={viewportId:e,renderingEngineId:t};r&&i?c.add(d):i?c.addSource(d):r&&c.addTarget(d)}))}destroy(){s.SynchronizerManager.destroy()}removeViewportFromSyncGroup(e,t,n){const o=s.SynchronizerManager.getAllSynchronizers();(n?o.filter((e=>e.id===n)):o).forEach((n=>{if(!n)return;n.remove({viewportId:e,renderingEngineId:t});const o=n.getSourceViewports(),a=n.getTargetViewports();o.length||a.length||s.SynchronizerManager.destroySynchronizer(n.id)}))}}Lt=Gt,Gt.REGISTRATION={name:"syncGroupService",altName:"SyncGroupService",create:({servicesManager:e})=>new Lt(e)};const kt=Gt;var Bt=n(11677),$t=n.n(Bt),zt=n(10311),jt=n.n(zt);function qt(e,t){const n=1-t;return e<1/4?4*Math.pow(2*e,3)*n+t:e<.5?(1-Math.pow(-4*e+2,3)/2)*n+t:e<3/4?(1-Math.pow(4*e-2,3)/2)*n+t:-4*Math.pow(2*e-2,3)*n+t}var Wt,Ht=n(54131),Zt=n(96372);function Yt(e){const t=i.cache.getImage(e.values().next().value),n=i.metaData.get("imagePlaneModule",t.imageId),{imageOrientationPatient:o,pixelSpacing:a=[1,1],imagePositionPatient:r,columns:s,rows:l,sliceThickness:d=1}=n,m=Ht.ZP.newInstance({name:"Pixels",numberOfComponents:1,values:t.getPixelData()}),u=Zt.ZP.newInstance();let g=c.wO.fromValues(0,1,0,0,0,-1,-1,0,0),p=[0,0,0];if(o?.length){const e=c.R3.fromValues(o[0],o[1],o[2]),t=c.R3.fromValues(o[3],o[4],o[5]),n=c.R3.create();c.R3.cross(n,e,t),g=[...Array.from(e),...Array.from(t),...Array.from(n)],u.setDirection(g)}r?.length&&(p=[...r],u.setOrigin(r));const h=[a[1],a[0],d],I=[s,l,1];return u.setDirection(g),u.setOrigin(p),u.setDimensions(I),u.setSpacing(h),u.getPointData().setScalars(m),{dimensions:I,direction:g,spacing:h,origin:p,getScalarData:()=>t.getPixelData(),imageData:u,metadata:n}}const{COLOR_LUT:Kt}=s.CONSTANTS,Jt=s.Enums.SegmentationRepresentations.Labelmap,Qt=s.Enums.SegmentationRepresentations.Contour,Xt={SEGMENTATION_UPDATED:"event::segmentation_updated",SEGMENTATION_DATA_MODIFIED:"event::segmentation_data_modified",SEGMENTATION_ADDED:"event::segmentation_added",SEGMENTATION_REMOVED:"event::segmentation_removed",SEGMENTATION_CONFIGURATION_CHANGED:"event::segmentation_configuration_changed",SEGMENT_LOADING_COMPLETE:"event::segment_loading_complete",SEGMENTATION_LOADING_COMPLETE:"event::segmentation_loading_complete"},en={opacity:255,isVisible:!0,isLocked:!1};class tn extends l.hC{constructor({servicesManager:e}){super(Xt),this.segmentations=void 0,this.servicesManager=void 0,this.highlightIntervalId=null,this.EVENTS=Xt,this.destroy=()=>{i.eventTarget.removeEventListener(s.Enums.Events.SEGMENTATION_MODIFIED,this._onSegmentationModifiedFromSource),i.eventTarget.removeEventListener(s.Enums.Events.SEGMENTATION_DATA_MODIFIED,this._onSegmentationDataModified),Object.keys(this.segmentations).forEach((e=>{this._removeSegmentationFromCornerstone(e)})),this.segmentations={},this.listeners={}},this.setSegmentRGBA=(e,t,n,o)=>{const a=this.getSegmentation(e);if(void 0===a)throw new Error(`no segmentation for segmentationId: ${e}`);this._setSegmentOpacity(e,t,n[3],o,true),this._setSegmentColor(e,t,[n[0],n[1],n[2]],o,true),this._broadcastEvent(this.EVENTS.SEGMENTATION_UPDATED,{segmentation:a})},this.calculateCentroids=(e,t)=>{const n=this.getSegmentation(e),o=this.getLabelmapVolume(e)||this.getLabelmapImageData(e),{dimensions:a,imageData:r}=o,i=o.getScalarData(),[s,l,c]=a,d=s*l,m=t?[t]:n.segments.filter((e=>e?.segmentIndex)).map((e=>e.segmentIndex)),u=new Set(m),g=new Map;for(const e of u)g.set(e,{x:0,y:0,z:0,count:0});let p=0;for(let e=0;e<c;e++)for(let t=0;t<d;t++){const n=i[p++];if(u.has(n)){const o=g.get(n);o.x+=t%s,o.y+=t/s|0,o.z+=e,o.count++}}const h=new Map;for(const[e,t]of g){const n=t.count,o={image:[t.x/n,t.y/n,t.z/n]};o.world=r.indexToWorld(o.image),h.set(e,o)}return this.setCentroids(e,h),h},this.setCentroids=(e,t)=>{const n=this.getSegmentation(e),o=(this.getLabelmapVolume(e)||this.getLabelmapImageData(e)).imageData;n.cachedStats?n.cachedStats.segmentCenter||(n.cachedStats.segmentCenter={}):n.cachedStats={segmentCenter:{}};for(const[e,a]of t){let t=a.world;t&&0!==t.length||(t=o.indexToWorld(a.image)),n.cachedStats.segmentCenter[e]={center:{image:a.image,world:t}}}this.addOrUpdateSegmentation(n,!0,!0)},this.createSegmentationForDisplaySet=async(e,t)=>{const{displaySetService:n}=this.servicesManager.services,o=n.getDisplaySetByUID(e),a=Jt,r=this._getVolumeIdForDisplaySet(o),s=t?.segmentationId??`${i.utilities.uuidv4()}`,l=new Map;if(o.isReconstructable)await i.volumeLoader.createAndCacheDerivedVolume(r,{volumeId:s,targetBuffer:{type:"Uint8Array",sharedArrayBuffer:window.SharedArrayBuffer}});else{const e=e=>`segimage:${s}:${e}`,t=o.instances.reduce(((e,t)=>[...e,t.imageId]),[]);i.imageLoader.createAndCacheDerivedImages(t,e),t.forEach((t=>l.set(t,e(t))))}const c={...this._getDefaultSegmentationScheme(),id:s,displaySetInstanceUID:e,label:t?.label,isActive:!0,type:a,FrameOfReferenceUID:t?.FrameOfReferenceUID||o.instances?.[0]?.FrameOfReferenceUID,representationData:{LABELMAP:o.isReconstructable?{volumeId:s,referencedVolumeId:r}:{imageIdReferenceMap:l}}};return this.addOrUpdateSegmentation(c),s},this.toggleSegmentationVisibility=e=>{this._toggleSegmentationVisibility(e,!1)},this.addSegmentationRepresentationToToolGroup=async(e,t,n=!1,o=s.Enums.SegmentationRepresentations.Labelmap,a=!1)=>{const r=this.getSegmentation(t);if(!r)throw new Error(`Segmentation with segmentationId ${t} not found.`);n&&(r.hydrated=!0);const{colorLUTIndex:i}=r,l=await s.segmentation.addSegmentationRepresentations(e,[{segmentationId:t,type:o}]);this._setActiveSegmentationForToolGroup(t,e,l[0]),s.segmentation.config.color.setColorLUT(e,l[0],i);for(const n of r.segments){if(null==n)continue;const{segmentIndex:o,color:a,isLocked:r,isVisible:i,opacity:s}=n,l=!0;void 0!==a&&this._setSegmentColor(t,o,a,e,l),void 0!==s&&this._setSegmentOpacity(t,o,s,e,l),void 0!==i&&this._setSegmentVisibility(t,o,i,e,l),r&&this._setSegmentLocked(t,o,r,l)}a||this._broadcastEvent(this.EVENTS.SEGMENTATION_UPDATED,{segmentation:r})},this.setSegmentRGBAColor=(e,t,n,o)=>{const a=this.getSegmentation(e);if(void 0===a)throw new Error(`no segmentation for segmentationId: ${e}`);this._setSegmentOpacity(e,t,n[3],o,!0),this._setSegmentColor(e,t,[n[0],n[1],n[2]],o,!0),this._broadcastEvent(this.EVENTS.SEGMENTATION_UPDATED,{segmentation:a})},this.getToolGroupIdsWithSegmentation=e=>s.segmentation.state.getToolGroupIdsWithSegmentation(e),this.hydrateSegmentation=(e,t=!1)=>{const n=this.getSegmentation(e);if(!n)throw new Error(`Segmentation with segmentationId ${e} not found.`);n.hydrated=!0,this._setDisplaySetIsHydrated(e,!0),t||this._broadcastEvent(this.EVENTS.SEGMENTATION_UPDATED,{segmentation:n})},this.getConfiguration=e=>{e=e??this._getApplicableToolGroupId();const t=this.getSegmentationRepresentationsForToolGroup(e),n=t?.[0]?.type||Jt,o=s.segmentation.config.getGlobalConfig(),{renderInactiveSegmentations:a}=o,r=o.representations[n],{renderOutline:i,outlineWidthActive:l,renderFill:c,fillAlpha:d,fillAlphaInactive:m,outlineOpacity:u,outlineOpacityInactive:g}=r;return{brushSize:1,brushThresholdGate:1,fillAlpha:d,fillAlphaInactive:m,outlineWidthActive:l,renderFill:c,renderInactiveSegmentations:a,renderOutline:i,outlineOpacity:u,outlineOpacityInactive:g}},this.setConfiguration=e=>{const{brushSize:t,brushThresholdGate:n,fillAlpha:o,fillAlphaInactive:a,outlineWidthActive:r,outlineOpacity:i,renderFill:l,renderInactiveSegmentations:c,renderOutline:d}=e,m=(e,t,n=null)=>{if(void 0!==t){const o=n?n(t):t;this._setSegmentationConfig(e,o)}};if(m("renderOutline",d),m("outlineWidthActive",r),m("outlineOpacity",i,(e=>e/100)),m("fillAlpha",o,(e=>e/100)),m("renderFill",l),m("fillAlphaInactive",a,(e=>e/100)),m("outlineOpacityInactive",a,(e=>Math.max(.75,e/100))),void 0!==c){const e=s.segmentation.config.getGlobalConfig();e.renderInactiveSegmentations=c,s.segmentation.config.setGlobalConfig(e)}this._broadcastEvent(this.EVENTS.SEGMENTATION_CONFIGURATION_CHANGED,this.getConfiguration())},this.getLabelmapVolume=e=>i.cache.getVolume(e),this.getLabelmapImageData=e=>{const t=this.getSegmentation(e);if(t?.representationData[Jt].imageIdReferenceMap?.size)return Yt(t?.representationData[Jt].imageIdReferenceMap)},this.getSegmentationRepresentationsForToolGroup=e=>s.segmentation.state.getSegmentationRepresentations(e),this._toggleSegmentationVisibility=(e,t=!1)=>{const n=this.segmentations[e];if(!n)throw new Error(`Segmentation with segmentationId ${e} not found.`);n.isVisible=!n.isVisible,this._updateCornerstoneSegmentationVisibility(e),!1===t&&this._broadcastEvent(this.EVENTS.SEGMENTATION_UPDATED,{segmentation:n})},this._setSegmentColor=(e,t,n,o,a=!1)=>{const r=this.getSegmentation(e);if(void 0===r)throw new Error(`no segmentation for segmentationId: ${e}`);const i=this._getSegmentInfo(r,t);if(void 0===i)throw new Error(`Segment ${t} not yet added to segmentation: ${e}`);o=o??this._getApplicableToolGroupId();const l=this._getSegmentationRepresentation(e,o);if(!l)throw new Error("Must add representation to toolgroup before setting segments");const{segmentationRepresentationUID:c}=l,d=s.segmentation.config.color.getColorForSegmentIndex(o,c,t);s.segmentation.config.color.setColorForSegmentIndex(o,c,t,[...n,d[3]]),i.color=n,!1===a&&this._broadcastEvent(this.EVENTS.SEGMENTATION_UPDATED,{segmentation:r})},this._setSegmentOpacity=(e,t,n,o,a=!1)=>{const r=this.getSegmentation(e);if(void 0===r)throw new Error(`no segmentation for segmentationId: ${e}`);const i=this._getSegmentInfo(r,t);if(void 0===i)throw new Error(`Segment ${t} not yet added to segmentation: ${e}`);o=o??this._getApplicableToolGroupId();const l=this._getSegmentationRepresentation(e,o);if(!l)throw new Error("Must add representation to toolgroup before setting segments");const{segmentationRepresentationUID:c}=l,d=s.segmentation.config.color.getColorForSegmentIndex(o,c,t);s.segmentation.config.color.setColorForSegmentIndex(o,c,t,[d[0],d[1],d[2],n]),i.opacity=n,!1===a&&this._broadcastEvent(this.EVENTS.SEGMENTATION_UPDATED,{segmentation:r})},this._setSegmentationConfig=(e,t)=>{const n=this.getSegmentations()[0].type,{cornerstoneViewportService:o}=this.servicesManager.services,a=s.segmentation.config.getGlobalConfig();a.representations[n][e]=t,s.segmentation.config.setGlobalConfig(a);const r=o.getRenderingEngine(),i=o.getViewportIds();r.renderViewports(i)},this._onSegmentationDataModified=e=>{const{segmentationId:t}=e.detail,n=this.getSegmentation(t);void 0!==n&&this._broadcastEvent(this.EVENTS.SEGMENTATION_DATA_MODIFIED,{segmentation:n})},this._onSegmentationModifiedFromSource=e=>{const{segmentationId:t}=e.detail,n=this.segmentations[t];if(void 0===n)return;const o=s.segmentation.state.getSegmentation(t);if(!o)return;const{activeSegmentIndex:a,cachedStats:r,segmentsLocked:i,label:l,type:c}=o;if(![Jt,Qt].includes(c))throw new Error(`Unsupported segmentation type: ${c}. Only ${Jt} and ${Qt} are supported.`);const d=o.representationData[c],m={...n,activeSegmentIndex:a,cachedStats:r,displayText:[],id:t,label:l,segmentsLocked:i,type:c,representationData:{[c]:{...d}}};try{this.addOrUpdateSegmentation(m)}catch(e){console.warn(`Failed to add/update segmentation ${t}`,e)}},this._updateCornerstoneSegmentationVisibility=e=>{s.segmentation.state.getToolGroupIdsWithSegmentation(e).forEach((t=>{const n=s.segmentation.state.getSegmentationRepresentations(t);if(0===n.length)return;const o=n.find((t=>t.segmentationId===e)),{segmentsHidden:a}=o,r=!(0===a.size);s.segmentation.config.visibility.setSegmentationVisibility(t,o.segmentationRepresentationUID,r);const{segmentation:i}=this._getSegmentationInfo(e,t);i.segments.filter(Boolean).forEach((e=>{e.isVisible=r}))}))},this._getApplicableToolGroupId=()=>{const{toolGroupService:e,viewportGridService:t,cornerstoneViewportService:n}=this.servicesManager.services,o=n.getViewportInfo(t.getActiveViewportId());if(!o){return e.getToolGroupIds()[0]}return o.getToolGroupId()},this.getNextColorLUTIndex=()=>{let e=0;for(;;){if(void 0===s.segmentation.state.getColorLUT(e))return e;e++}},this.arrayOfObjects=e=>Object.entries(e).map((e=>({[e[0]]:e[1]}))),this.segmentations={},this.servicesManager=e,this._initSegmentationService()}addSegment(e,t={}){if(0===t?.segmentIndex)throw new Error('Segment index 0 is reserved for "no label"');const n=t.toolGroupId??this._getApplicableToolGroupId(),{segmentationRepresentationUID:o,segmentation:a}=this._getSegmentationInfo(e,n);let r=t.segmentIndex;if(r||(r=0===a.segments.length?1:a.segments.length),this._getSegmentInfo(a,r))throw new Error(`Segment ${r} already exists`);const i=s.segmentation.config.color.getColorForSegmentIndex(n,o,r);a.segments[r]={label:t.properties?.label??`Segment ${r}`,segmentIndex:r,color:[i[0],i[1],i[2]],opacity:i[3],isVisible:!0,isLocked:!1},a.segmentCount++,this._setActiveSegment(e,r);const l=!0;if(void 0!==t.properties){const{color:o,opacity:a,isLocked:i,visibility:s,active:c}=t.properties;void 0!==o&&this._setSegmentColor(e,r,o,n,l),void 0!==a&&this._setSegmentOpacity(e,r,a,n,l),void 0!==s&&this._setSegmentVisibility(e,r,s,n,l),!0===c&&this._setActiveSegment(e,r,l),void 0!==i&&this._setSegmentLocked(e,r,i,l)}null===a.activeSegmentIndex&&this._setActiveSegment(e,r,l),this._broadcastEvent(this.EVENTS.SEGMENTATION_UPDATED,{segmentation:a})}removeSegment(e,t){const n=this.getSegmentation(e);if(void 0===n)throw new Error(`no segmentation for segmentationId: ${e}`);if(0===t)throw new Error('Segment index 0 is reserved for "no label"');if(!this._getSegmentInfo(n,t))return;n.segmentCount--,n.segments[t]=null;const o=this.getLabelmapVolume(e)||this.getLabelmapImageData(e),{dimensions:a}=o,r=o.getScalarData(),i=a[0]*a[1],l=a[2];let c=0;const d=new Set;for(let e=0;e<l;e++)for(let n=0;n<i;n++)r[c]===t&&(r[c]=0,d.add(e)),c++;const m=Array.from(d);if(s.segmentation.triggerSegmentationEvents.triggerSegmentationDataModified(e,m),n.activeSegmentIndex===t){const t=Object.keys(n.segments),o=t.length?Number(t[0]):1;this._setActiveSegment(e,o,!0)}this._broadcastEvent(this.EVENTS.SEGMENTATION_UPDATED,{segmentation:n})}setSegmentVisibility(e,t,n,o,a=!1){this._setSegmentVisibility(e,t,n,o,a)}setSegmentLocked(e,t,n){this._setSegmentLocked(e,t,n,!1)}toggleSegmentLocked(e,t){const n=this.getSegmentation(e),o=!this._getSegmentInfo(n,t).isLocked;this._setSegmentLocked(e,t,o)}setSegmentColor(e,t,n,o){this._setSegmentColor(e,t,n,o)}setSegmentOpacity(e,t,n,o){this._setSegmentOpacity(e,t,n,o)}setActiveSegmentationForToolGroup(e,t){t=t??this._getApplicableToolGroupId();this._setActiveSegmentationForToolGroup(e,t,!1)}setActiveSegment(e,t){this._setActiveSegment(e,t,!1)}getSegmentations(e=!0){const t=this._getSegmentations();return t&&t.filter((t=>!e||t.hydrated))}_getSegmentations(){const e=this.arrayOfObjects(this.segmentations);return e&&e.map((e=>this.segmentations[Object.keys(e)[0]]))}getActiveSegmentation(){return this.getSegmentations().find((e=>e.isActive))}getActiveSegment(){const e=this.getActiveSegmentation(),{activeSegmentIndex:t,segments:n}=e;if(null!==t)return n[t]}getSegmentation(e){return this.segmentations[e]}addOrUpdateSegmentation(e,t=!1,n=!1){const{id:o}=e;let a=this.segmentations[o];if(a)return Object.assign(a,e),this._updateCornerstoneSegmentations({segmentationId:o,notYetUpdatedAtSource:n}),t||this._broadcastEvent(this.EVENTS.SEGMENTATION_UPDATED,{segmentation:a}),o;const r=e.type,i=e.representationData[r];s.segmentation.addSegmentations([{segmentationId:o,representation:{type:r,data:{...i}}}]);let l=0;const c=this.generateNewColorLUT();return 0!==Object.keys(this.segmentations).length?(l=this.getNextColorLUTIndex(),s.segmentation.config.color.addColorLUT(c,l)):s.segmentation.state.getColorLUT(0)||s.segmentation.config.color.addColorLUT(c,0),this.segmentations[o]={...e,label:e.label||"",segments:e.segments||[null],activeSegmentIndex:e.activeSegmentIndex??null,segmentCount:e.segmentCount??0,isActive:!1,isVisible:!0,colorLUTIndex:l},a=this.segmentations[o],this._updateCornerstoneSegmentations({segmentationId:o,notYetUpdatedAtSource:!0}),t||this._broadcastEvent(this.EVENTS.SEGMENTATION_ADDED,{segmentation:a}),a.id}async createSegmentationForSEGDisplaySet(e,t,n=!1){const o=Jt;t=t??e.displaySetInstanceUID;const a={...this._getDefaultSegmentationScheme(),id:t,displaySetInstanceUID:e.displaySetInstanceUID,type:o,label:e.SeriesDescription,representationData:{[Jt]:{volumeId:t,referencedVolumeId:e.referencedVolumeId}}},r=this.getLabelmapVolume(t)||this.getLabelmapImageData(t),s=this.getSegmentation(t);if(r&&s)return this.addOrUpdateSegmentation(Object.assign(a,s),n);const{labelmapBufferArray:l,referencedVolumeId:c}=e;if(!l||!c)throw new Error("No labelmapBufferArray or referencedVolumeId found for the SEG displaySet");const d=this.servicesManager.services.displaySetService.getDisplaySetByUID(e.referencedDisplaySetInstanceUID);let m;if(d.isReconstructable){if(!i.cache.getVolume(c))throw new Error(`No volume found for referencedVolumeId: ${c}`);const e=await i.volumeLoader.createAndCacheDerivedVolume(c,{volumeId:t,targetBuffer:{type:"Uint8Array",sharedArrayBuffer:window.SharedArrayBuffer}});e.getScalarData().set(new Uint8Array(l[0])),m=e.imageData.indexToWorld}else{const e=e=>`segimage:${t}:${e}`,n=d.instances.reduce(((e,t)=>[...e,t.imageId]),[]),o=new Map,r=[];n.forEach((t=>{const n=e(t);o.set(t,n),r.push(n),i.cache.getImage(n)||i.imageLoader.createAndCacheDerivedImage(t,{imageId:n,targetBufferType:"Uint8Array"})})),a.representationData[Jt]={imageIdReferenceMap:o};const{rows:s,columns:c}=i.metaData.get("imagePlaneModule",r[0]),u=new Uint8Array(l[0]),g=s*c;for(let e=0;e<d.instances.length;e++){const t=new Uint8Array(u.slice(e*g,(e+1)*g).buffer);(await i.cache.getImageLoadObject(r[e]).promise).getPixelData().set(t)}const{imageData:p}=Yt(o);m=p.indexToWorld}const u=e.segMetadata.data;return a.segments=u.map(((t,n)=>{if(0===n)return;const{SegmentedPropertyCategoryCodeSequence:o,SegmentNumber:r,SegmentLabel:i,SegmentAlgorithmType:s,SegmentAlgorithmName:l,SegmentedPropertyTypeCodeSequence:c,rgba:d}=t,{x:u,y:g,z:p}=e.centroids.get(n),h=m([u,g,p]);return a.cachedStats={...a.cachedStats,segmentCenter:{...a.cachedStats.segmentCenter,[n]:{center:{image:[u,g,p],world:h},modifiedTime:e.SeriesDate}}},{label:i||`Segment ${r}`,segmentIndex:Number(r),category:o?o.CodeMeaning:"",type:c?c.CodeMeaning:"",algorithmType:s,algorithmName:l,color:d,opacity:255,isVisible:!0,isLocked:!1}})),a.segmentCount=u.length-1,e.isLoaded=!0,this._broadcastEvent(Xt.SEGMENTATION_LOADING_COMPLETE,{segmentationId:t,segDisplaySet:e}),this.addOrUpdateSegmentation(a,n)}async createSegmentationForRTDisplaySet(e,t,n=!1){const o=Qt;t=t??e.displaySetInstanceUID;const{structureSet:a}=e;if(!a)throw new Error("To create the contours from RT displaySet, the displaySet should be loaded first, you can perform rtDisplaySet.load() before calling this method.");const r=this._getDefaultSegmentationScheme(),s=e.displaySetInstanceUID,l=function(e,t){return e.ROIContours.map((({contourPoints:e,ROINumber:n,ROIName:o,colorArray:a})=>{const r=o||n;return{data:e.map((({points:e,...t})=>({...t,points:e.map((({x:e,y:t,z:n})=>[e,t,n]))}))),id:r,segmentIndex:n,color:a,geometryId:`${t}:${r}:segmentIndex-${n}`}}))}(a,s);l.sort(((e,t)=>e.segmentIndex-t.segmentIndex));const c=l.map((({geometryId:e})=>e)),d={...r,id:t,displaySetInstanceUID:s,type:o,label:e.SeriesDescription,representationData:{[Qt]:{geometryIds:c}}},m=this.getSegmentation(t);if(m)return this.addOrUpdateSegmentation(Object.assign(d,m),n);if(!a.ROIContours?.length)throw new Error("The structureSet does not contain any ROIContours. Please ensure the structureSet is loaded first.");const u={},g=async t=>{const{data:n,id:o,color:r,segmentIndex:s,geometryId:c}=t;try{const t=await i.geometryLoader.createAndCacheGeometry(c,{geometryData:{data:n,id:o,color:r,frameOfReferenceUID:a.frameOfReferenceUID,segmentIndex:s},type:i.Enums.GeometryType.CONTOUR}),m=t.data.getCentroid();u[s]={center:{world:m},modifiedTime:e.SeriesDate},d.segments[s]={label:o,segmentIndex:s,color:r,...en};const g=Object.keys(u).length,p=Math.round(g/l.length*100);this._broadcastEvent(Xt.SEGMENT_LOADING_COMPLETE,{percentComplete:p,numSegments:l.length})}catch(e){console.warn(e)}},p=[];for(let e=0;e<l.length;e++){const t=new Promise(((t,n)=>{setTimeout((()=>{g(l[e]).then((()=>{t()}))}),0)}));p.push(t)}return await Promise.all(p),d.segmentCount=l.length,e.isLoaded=!0,d.cachedStats={...d.cachedStats,segmentCenter:{...d.cachedStats.segmentCenter,...u}},this._broadcastEvent(Xt.SEGMENTATION_LOADING_COMPLETE,{segmentationId:t,rtDisplaySet:e}),this.addOrUpdateSegmentation(d,n)}jumpToSegmentCenter(e,t,n,o=.9,a=!0,r=750,l=!1,c="ease-in-out"){const{toolGroupService:d}=this.servicesManager.services,m=this._getSegmentCenter(e,t);if(!m?.world)return;const{world:u}=m;n=n||this._getToolGroupIdsWithSegmentation(e);const g=[];Array.isArray(n)?n.forEach((e=>{g.push(d.getToolGroup(e))})):g.push(d.getToolGroup(n)),g.forEach((n=>{const d=n.getViewportsInfo();for(const{viewportId:e,renderingEngineId:t}of d){const{viewport:n}=(0,i.getEnabledElementByIds)(e,t);s.utilities.viewport.jumpToWorld(n,u)}a&&this.highlightSegment(e,t,n.id,o,r,l,c)}))}highlightSegment(e,t,n,o=.9,a=750,r=!0,i="ease-in-out"){this.highlightIntervalId&&clearInterval(this.highlightIntervalId);const s=this.getSegmentation(e);n=n??this._getApplicableToolGroupId();const l=this._getSegmentationRepresentation(e,n),{type:c}=l,{segments:d}=s;(c===Jt?this._highlightLabelmap.bind(this):this._highlightContour.bind(this))(t,c===Jt?o:1-o,r,d,n,a,l)}_setDisplaySetIsHydrated(e,t){const{displaySetService:n}=this.servicesManager.services,o=n.getDisplaySetByUID(e);o&&(o.isHydrated=t,n.setDisplaySetMetadataInvalidated(e,!1))}_highlightLabelmap(e,t,n,o,a,r,i){const l={[e]:{LABELMAP:{fillAlpha:t}}};if(n)for(let t=0;t<o.length;t++)t!==e&&(l[t]={LABELMAP:{fillAlpha:0}});const{fillAlpha:c}=this.getConfiguration(a);let d=null;const m=t=>{null===d&&(d=t);const n=t-d,o=Math.min(n/r,1);s.segmentation.config.setSegmentSpecificConfig(a,i.segmentationRepresentationUID,{[e]:{LABELMAP:{fillAlpha:qt(o,c)}}}),o<1?requestAnimationFrame(m):s.segmentation.config.setSegmentSpecificConfig(a,i.segmentationRepresentationUID,{})};requestAnimationFrame(m)}_highlightContour(e,t,n,o,a,r,i){const l=performance.now(),c=t=>{const n=(t-l)/r;if(n>=1)return void s.segmentation.config.setSegmentSpecificConfig(a,i.segmentationRepresentationUID,{});const o=1-qt(n,d=.1)+d;var d;s.segmentation.config.setSegmentSpecificConfig(a,i.segmentationRepresentationUID,{[e]:{CONTOUR:{fillAlpha:o}}}),requestAnimationFrame(c)};requestAnimationFrame(c)}removeSegmentationRepresentationFromToolGroup(e,t){const n=t||[];if(!n.length){const t=s.segmentation.state.getSegmentationRepresentations(e);if(!t||!t.length)return;n.push(...t.map((e=>e.segmentationRepresentationUID)))}s.segmentation.removeSegmentationsFromToolGroup(e,n)}remove(e){const t=this.segmentations[e],n=t.isActive;if(!e||!t)return void console.warn("No segmentationId provided, or unable to find segmentation by id.");const{colorLUTIndex:o}=t;if(this._removeSegmentationFromCornerstone(e),s.segmentation.state.removeColorLUT(o),delete this.segmentations[e],n){const e=this._getSegmentations().filter((e=>e.hydrated));if(e.length){const{id:t}=e[0];this._setActiveSegmentationForToolGroup(t,this._getApplicableToolGroupId(),!1)}}this._setDisplaySetIsHydrated(e,!1),this._broadcastEvent(this.EVENTS.SEGMENTATION_REMOVED,{segmentationId:e})}setSegmentLabel(e,t,n){this._setSegmentLabel(e,t,n)}_setSegmentLabel(e,t,n,o=!1){const a=this.getSegmentation(e);if(void 0===a)throw new Error(`no segmentation for segmentationId: ${e}`);const r=a.segments[t];if(void 0===r)throw new Error(`Segment ${t} not yet added to segmentation: ${e}`);r.label=n,!1===o&&this._broadcastEvent(this.EVENTS.SEGMENTATION_UPDATED,{segmentation:a})}shouldRenderSegmentation(e,t){if(!e?.length)return!1;const{displaySetService:n}=this.servicesManager.services;let o=!1;for(const a of e){const e=n.getDisplaySetByUID(a);if(e.isReconstructable&&e?.images?.[0]?.FrameOfReferenceUID===t){o=!0;break}}return o}_getDefaultSegmentationScheme(){return{activeSegmentIndex:1,cachedStats:{},label:"",segmentsLocked:[],displayText:[],hydrated:!1,segmentCount:0,segments:[],isVisible:!0,isActive:!1,colorLUTIndex:0}}_setActiveSegmentationForToolGroup(e,t,n=!1){const o=this._getSegmentations(),a=this.getSegmentation(e);if(void 0===a)throw new Error(`no segmentation for segmentationId: ${e}`);o.forEach((t=>{t.isActive=t.id===e}));const r=this._getSegmentationRepresentation(e,t);s.segmentation.activeSegmentation.setActiveSegmentationRepresentation(t,r.segmentationRepresentationUID),!1===n&&this._broadcastEvent(this.EVENTS.SEGMENTATION_UPDATED,{segmentation:a})}_setActiveSegment(e,t,n=!1){const o=this.getSegmentation(e);if(void 0===o)throw new Error(`no segmentation for segmentationId: ${e}`);s.segmentation.segmentIndex.setActiveSegmentIndex(e,t),o.activeSegmentIndex=t,!1===n&&this._broadcastEvent(this.EVENTS.SEGMENTATION_UPDATED,{segmentation:o})}_getSegmentInfo(e,t){const n=e.segments;if(n)return n&&n.length>0?n[t]:void 0}_getVolumeIdForDisplaySet(e){return`${e.volumeLoaderSchema??"cornerstoneStreamingImageVolume"}:${e.displaySetInstanceUID}`}_getSegmentCenter(e,t){const n=this.getSegmentation(e);if(!n)return;const{cachedStats:o}=n;if(!o)return;const{segmentCenter:a}=o;if(!a)return;const{center:r}=a[t];return r}_setSegmentLocked(e,t,n,o=!1){const a=this.getSegmentation(e);if(void 0===a)throw new Error(`no segmentation for segmentationId: ${e}`);const r=this._getSegmentInfo(a,t);if(void 0===r)throw new Error(`Segment ${t} not yet added to segmentation: ${e}`);r.isLocked=n,s.segmentation.segmentLocking.setSegmentIndexLocked(e,t,n),!1===o&&this._broadcastEvent(this.EVENTS.SEGMENTATION_UPDATED,{segmentation:a})}_setSegmentVisibility(e,t,n,o,a=!1){o=o??this._getApplicableToolGroupId();const{segmentationRepresentationUID:r,segmentation:i}=this._getSegmentationInfo(e,o);if(void 0===i)throw new Error(`no segmentation for segmentationId: ${e}`);const l=this._getSegmentInfo(i,t);if(void 0===l)throw new Error(`Segment ${t} not yet added to segmentation: ${e}`);l.isVisible=n,s.segmentation.config.visibility.setSegmentVisibility(o,r,t,n),i.isVisible=i.segments.filter(Boolean).every((e=>e.isVisible)),!1===a&&this._broadcastEvent(this.EVENTS.SEGMENTATION_UPDATED,{segmentation:i})}_setSegmentLabel(e,t,n,o=!1){const a=this.getSegmentation(e);if(void 0===a)throw new Error(`no segmentation for segmentationId: ${e}`);const r=this._getSegmentInfo(a,t);if(void 0===r)throw new Error(`Segment ${t} not yet added to segmentation: ${e}`);r.label=n,!1===o&&this._broadcastEvent(this.EVENTS.SEGMENTATION_UPDATED,{segmentation:a})}_getSegmentationRepresentation(e,t){const n=this.getSegmentationRepresentationsForToolGroup(t);if(!n?.length)return;return n.find((t=>t.segmentationId===e))}_initSegmentationService(){i.eventTarget.addEventListener(s.Enums.Events.SEGMENTATION_MODIFIED,this._onSegmentationModifiedFromSource),i.eventTarget.addEventListener(s.Enums.Events.SEGMENTATION_DATA_MODIFIED,this._onSegmentationDataModified)}_getSegmentationInfo(e,t){const n=this.getSegmentation(e);if(void 0===n)throw new Error(`no segmentation for segmentationId: ${e}`);const o=this._getSegmentationRepresentation(e,t);if(!o)throw new Error("Must add representation to toolgroup before setting segments");const{segmentationRepresentationUID:a}=o;return{segmentationRepresentationUID:a,segmentation:n}}_removeSegmentationFromCornerstone(e){const t=s.segmentation.state;if(!t.getSegmentation(e))return;t.getToolGroupIdsWithSegmentation(e).forEach((n=>{const o=t.getSegmentationRepresentations(n),a=[];o.forEach((t=>{t.segmentationId===e&&a.push(t.segmentationRepresentationUID)})),s.segmentation.removeSegmentationsFromToolGroup(n,a,!0)})),t.removeSegmentation(e),i.cache.getVolumeLoadObject(e)&&i.cache.removeVolumeLoadObject(e);const n=this.getSegmentation(e),o=n.representationData[n.type].imageIdReferenceMap;o&&o.forEach((e=>i.cache.getVolumeLoadObject(e)&&i.cache.removeImageLoadObject(e)))}_updateCornerstoneSegmentations({segmentationId:e,notYetUpdatedAtSource:t}){if(!1===t)return;const n=s.segmentation.state.getSegmentation(e),o=this.segmentations[e],{label:a,cachedStats:r}=o;n.label!==a&&(n.label=a),jt()(n.cachedStats,r)||(n.cachedStats=r)}_getToolGroupIdsWithSegmentation(e){return s.segmentation.state.getToolGroupIdsWithSegmentation(e)}_getFrameOfReferenceUIDForSeg(e){const t=e.instance?.FrameOfReferenceUID;if(t)return t;const n=e.instance?.ReferencedFrameOfReferenceSequence;return n?n.FrameOfReferenceUID:void 0}generateNewColorLUT(){return $t()(Kt)}}Wt=tn,tn.REGISTRATION={name:"segmentationService",altName:"SegmentationService",create:({servicesManager:e})=>new Wt({servicesManager:e})};const nn=tn;function on(e){const t=e.toLowerCase();if("stack"===t)return i.Enums.ViewportType.STACK;if("volume"===t||"orthographic"===t)return i.Enums.ViewportType.ORTHOGRAPHIC;if("volume3d"===t)return i.Enums.ViewportType.VOLUME_3D;throw new Error(`Invalid viewport type: ${e}. Valid types are: stack, volume`)}var an;const rn="cornerstoneStreamingImageVolume";class sn{constructor(e){this.stackImageIds=new Map,this.volumeImageIds=new Map,this.servicesManager=void 0,this.servicesManager=e}getCacheSize(){return i.cache.getCacheSize()}getCacheFreeSpace(){return i.cache.getBytesAvailable()}async createViewportData(e,t,n,o){let a=t.viewportType;e[0].isReconstructable&&this._shouldRenderSegmentation(e)&&(a="volume",t.viewportType=a);const r=on(a);let s;return r===i.Enums.ViewportType.STACK&&(s=await this._getStackViewportData(n,e,o,r)),r!==i.Enums.ViewportType.ORTHOGRAPHIC&&r!==i.Enums.ViewportType.VOLUME_3D||(s=await this._getVolumeViewportData(n,e,r)),s.viewportType=r,s}async invalidateViewportData(e,t,n,o){if(e.viewportType===i.Enums.ViewportType.STACK)return this._getCornerstoneStackImageIds(o.getDisplaySetByUID(t),n);const a=`${rn}:${t}`;i.cache.getVolume(a)&&(i.cache.removeVolumeLoadObject(a),this.volumeImageIds.delete(a));const r=e.data.map((({displaySetInstanceUID:e})=>o.getDisplaySetByUID(e)));return await this._getVolumeViewportData(n,r,e.viewportType)}async _getStackViewportData(e,t,n,o){const a=t[0];let r=this.stackImageIds.get(a.displaySetInstanceUID);r||(r=this._getCornerstoneStackImageIds(a,e),this.stackImageIds.set(a.displaySetInstanceUID,r));const{displaySetInstanceUID:i,StudyInstanceUID:s,isCompositeStack:l}=a,c={viewportType:o,data:{StudyInstanceUID:s,displaySetInstanceUID:i,isCompositeStack:l,imageIds:r}};if(t[1]?.load&&t[1].load instanceof Function){const{userAuthenticationService:e}=this.servicesManager.services,n=e.getAuthorizationHeader();await t[1].load({headers:n})}return"number"==typeof n&&(c.data.initialImageIndex=n),c}async _getVolumeViewportData(e,t,n){const o=[];for(const n of t){if(n.load&&n.load instanceof Function){const{userAuthenticationService:e}=this.servicesManager.services,t=e.getAuthorizationHeader();await n.load({headers:t}),o.push({studyInstanceUID:n.StudyInstanceUID,displaySetInstanceUID:n.displaySetInstanceUID});continue}const t=`${n.volumeLoaderSchema??rn}:${n.displaySetInstanceUID}`;let a=this.volumeImageIds.get(n.displaySetInstanceUID),r=i.cache.getVolume(t);a&&r||(a=this._getCornerstoneVolumeImageIds(n,e),r=await i.volumeLoader.createAndCacheVolume(t,{imageIds:a}),this.volumeImageIds.set(n.displaySetInstanceUID,a)),o.push({StudyInstanceUID:n.StudyInstanceUID,displaySetInstanceUID:n.displaySetInstanceUID,volume:r,volumeId:t,imageIds:a})}return{viewportType:n,data:o}}_shouldRenderSegmentation(e){const{segmentationService:t,displaySetService:n}=this.servicesManager.services,o=e.map((({displaySetInstanceUID:e})=>e)),a=t.getSegmentations();for(const e of a){const a=e.displaySetInstanceUID,r=n.getDisplaySetByUID(a),i=r.instances?.[0]||r.instance;if(t.shouldRenderSegmentation(o,i.FrameOfReferenceUID))return!0}}_getCornerstoneStackImageIds(e,t){return t.getImageIdsForDisplaySet(e)}_getCornerstoneVolumeImageIds(e,t){return this._getCornerstoneStackImageIds(e,t)}}an=sn,sn.REGISTRATION={name:"cornerstoneCacheService",altName:"CornerstoneCacheService",create:({servicesManager:e})=>new an(e)};const ln=sn,cn="OHIFCornerstoneRenderingEngine";const dn="stack",mn="default",un=(e,t,n)=>e.displaySetInstanceUID===t||!!(n&&e.isCompositeStack&&e.imageIds)&&!!e.imageIds.find((e=>e===n));const gn=class{constructor(e){this.viewportId="",this.element=void 0,this.viewportOptions=void 0,this.displaySetOptions=void 0,this.viewportData=void 0,this.renderingEngineId=void 0,this.destroy=()=>{this.element=null,this.viewportData=null,this.viewportOptions=null,this.displaySetOptions=null},this.viewportId=e,this.setPublicViewportOptions({}),this.setPublicDisplaySetOptions([{}])}contains(e,t){return!!this.viewportData?.data&&(this.viewportData.data.length?!!this.viewportData.data.find((n=>un(n,e,t))):un(this.viewportData.data,e,t))}setRenderingEngineId(e){this.renderingEngineId=e}getRenderingEngineId(){return this.renderingEngineId}setViewportId(e){this.viewportId=e}setElement(e){this.element=e}setViewportData(e){this.viewportData=e}getViewportData(){return this.viewportData}getElement(){return this.element}getViewportId(){return this.viewportId}setPublicDisplaySetOptions(e){const t=this.mapDisplaySetOptions(e);return this.setDisplaySetOptions(t),this.displaySetOptions}hasDisplaySet(e){let t=this.getViewportData();return t.viewportType===i.Enums.ViewportType.ORTHOGRAPHIC||t.viewportType===i.Enums.ViewportType.VOLUME_3D?t.data.some((({displaySetInstanceUID:t})=>t===e)):t.data.displaySetInstanceUID===e}setPublicViewportOptions(e){let t=e.viewportType;const{toolGroupId:n=mn,presentationIds:o}=e;let a;return t=on(t?e.viewportType:dn),e.viewportType?.toLowerCase()!==dn&&(a=function(e){if(e)switch(e.toLowerCase()){case"axial":return i.Enums.OrientationAxis.AXIAL;case"sagittal":return i.Enums.OrientationAxis.SAGITTAL;case"coronal":return i.Enums.OrientationAxis.CORONAL;default:return i.Enums.OrientationAxis.ACQUISITION}return i.Enums.OrientationAxis.ACQUISITION}(e.orientation)),n||(n=mn),this.setViewportOptions({...e,viewportId:this.viewportId,viewportType:t,orientation:a,toolGroupId:n,presentationIds:o}),this.viewportOptions}setViewportOptions(e){this.viewportOptions=e}getViewportOptions(){return this.viewportOptions}setDisplaySetOptions(e){this.displaySetOptions=e}getSyncGroups(){return this.viewportOptions.syncGroups||=[],this.viewportOptions.syncGroups}getDisplaySetOptions(){return this.displaySetOptions}getViewportType(){return this.viewportOptions.viewportType||i.Enums.ViewportType.STACK}getToolGroupId(){return this.viewportOptions.toolGroupId}getBackground(){return this.viewportOptions.background||[0,0,0]}getOrientation(){return this.viewportOptions.orientation}getDisplayArea(){return this.viewportOptions.displayArea}getInitialImageOptions(){return this.viewportOptions.initialImageOptions}mapDisplaySetOptions(e=[{}]){const t=[];return e.forEach((e=>{let n=e?.options||e;n||(n={blendMode:void 0,slabThickness:void 0,colormap:void 0,voi:{},voiInverted:!1});const o=function(e){if(!e)return i.Enums.BlendModes.COMPOSITE;if("mip"===e.toLowerCase())return i.Enums.BlendModes.MAXIMUM_INTENSITY_BLEND;throw new Error}(n.blendMode);t.push({voi:n.voi,voiInverted:n.voiInverted,colormap:n.colormap,slabThickness:n.slabThickness,blendMode:o,displayPreset:n.displayPreset})})),t}};var pn=function(e){return e.First="first",e.Last="last",e.Middle="middle",e}(pn||{});const hn=pn;var In;const Sn={VIEWPORT_DATA_CHANGED:"event::cornerstoneViewportService:viewportDataChanged"};class fn extends l.hC{constructor(e){super(Sn),this.renderingEngine=void 0,this.viewportsById=new Map,this.viewportGridResizeObserver=void 0,this.viewportsDisplaySets=new Map,this.enableResizeDetector=void 0,this.resizeRefreshRateMs=void 0,this.resizeRefreshMode=void 0,this.servicesManager=null,this.renderingEngine=null,this.viewportGridResizeObserver=null,this.servicesManager=e}enableViewport(e,t){const n=new gn(e);n.setElement(t),this.viewportsById.set(e,n)}getViewportIds(){return Array.from(this.viewportsById.keys())}getRenderingEngine(){const e=(0,i.getRenderingEngine)(cn);return e?(this.renderingEngine=e,this.renderingEngine):(e&&!e.hasBeenDestroyed||(this.renderingEngine=new i.RenderingEngine(cn)),this.renderingEngine)}resize(){this.renderingEngine.resize(!0,!0),this.renderingEngine.render()}destroy(){this._removeResizeObserver(),this.viewportGridResizeObserver=null;try{this.renderingEngine?.destroy?.()}catch(e){console.warn("Rendering engine not destroyed",e)}this.viewportsDisplaySets.clear(),this.renderingEngine=null,i.cache.purgeCache()}disableElement(e){this.renderingEngine?.disableElement(e),this.viewportsById.delete(e),this.viewportsDisplaySets.delete(e)}setPresentations(e,t){const n=t?.lutPresentation?.properties;n&&e.setProperties(n);const o=t?.positionPresentation?.camera;o&&e.setCamera(o)}getPresentation(e){const t=this.viewportsById.get(e);if(!t)return;const{viewportType:n,presentationIds:o}=t.getViewportOptions(),a=this.getCornerstoneViewport(e);if(!a)return;const r=a.getProperties();r.isComputedVOI&&(delete r.voiRange,delete r.VOILUTFunction);return{presentationIds:o,viewportType:n&&"stack"!==n?"volume":"stack",properties:r,initialImageIndex:a.getCurrentImageIdIndex(),camera:a.getCamera()}}storePresentation({viewportId:e}){const t=this.servicesManager.services.stateSyncService;let n;try{n=this.getPresentation(e)}catch(e){console.warn(e)}if(!n||!n.presentationIds)return;const{lutPresentationStore:o,positionPresentationStore:a}=t.getState(),{presentationIds:r}=n,{lutPresentationId:i,positionPresentationId:s}=r||{},l={};i&&(l.lutPresentationStore={...o,[i]:n}),s&&(l.positionPresentationStore={...a,[s]:n}),t.store(l)}setViewportData(e,t,n,o,a){const r=this.getRenderingEngine(),i=this.viewportsById.get(e);if(this.storePresentation({viewportId:i.getViewportId()}),!i)throw new Error("element is not enabled for the given viewportId");const s=i.setPublicDisplaySetOptions(o),l=i.setPublicViewportOptions(n),c=i.getElement(),d=i.getViewportType(),m=i.getBackground(),u=i.getOrientation(),g=i.getDisplayArea(),p={viewportId:e,element:c,type:d,defaultOptions:{background:m,orientation:u,displayArea:g}};i.setRenderingEngineId(r.id),r.enableElement(p),i.setViewportOptions(l),i.setDisplaySetOptions(s),i.setViewportData(t),i.setViewportId(e),this.viewportsById.set(e,i);const h=r.getViewport(e);this._setDisplaySets(h,t,i,a).then((()=>{this._broadcastEvent(this.EVENTS.VIEWPORT_DATA_CHANGED,{viewportData:t,viewportId:e})}))}getCornerstoneViewport(e){if(!this.getViewportInfo(e)||!this.renderingEngine||this.renderingEngine.hasBeenDestroyed)return null;return this.renderingEngine.getViewport(e)}getViewportInfo(e){return this.viewportsById.get(e)}async _setStackViewport(e,t,n,o){const a=n.getDisplaySetOptions(),{imageIds:r,initialImageIndex:s,displaySetInstanceUID:l}=t.data;this.viewportsDisplaySets.set(e.id,[l]);let c=o?.positionPresentation?.initialImageIndex??s;null==c&&(c=this._getInitialImageIndexForViewport(n,r)||0);const d={...o.lutPresentation?.properties};if(!o.lutPresentation?.properties){const{voi:e,voiInverted:t}=a[0];if(e&&(e.windowWidth||e.windowCenter)){const{lower:t,upper:n}=i.utilities.windowLevel.toLowHighRange(e.windowWidth,e.windowCenter);d.voiRange={lower:t,upper:n}}void 0!==t&&(d.invert=t)}const m=this.servicesManager.services.segmentationService.getSegmentations(!1),u=n.getToolGroupId();for(const e of m){if(!(this.servicesManager.services.segmentationService.getSegmentationRepresentationsForToolGroup(u)||[]).find((t=>t.segmentationId===e.id))){const t=this.servicesManager.services.displaySetService.getDisplaySetByUID(e.id);t&&this.servicesManager.services.segmentationService.addSegmentationRepresentationToToolGroup(u,e.id,t.isOverlayDisplaySet)}}return e.setStack(r,c).then((()=>{e.setProperties({...d});const t=o.positionPresentation?.camera;t&&e.setCamera(t)}))}_getInitialImageIndexForViewport(e,t){const n=e.getInitialImageOptions();if(!n)return;const{index:o,preset:a}=n,r=e.getViewportType();let s;if(r===i.Enums.ViewportType.STACK)s=t.length;else{if(r!==i.Enums.ViewportType.ORTHOGRAPHIC)return;{const t=this.getCornerstoneViewport(e.getViewportId()),n=i.utilities.getImageSliceDataForVolumeViewport(t);if(!n)return;({numberOfSlices:s}=n)}}return this._getInitialImageIndex(s,o,a)}_getInitialImageIndex(e,t,n){const o=e-1;return void 0!==t?s.utilities.clip(t,0,o):n===hn.First?0:n===hn.Last?o:n===hn.Middle?o%2==0?o/2:(o+1)/2:0}async _setVolumeViewport(e,t,n,o){const a=[],r=n.getDisplaySetOptions(),{hangingProtocolService:i}=this.servicesManager.services,s=[],l=[];for(const[e,n]of t.data.entries()){const{volume:t,imageIds:o,displaySetInstanceUID:i}=n;if(l.push(i),!t){console.log("Volume display set not found");continue}s.push(t);const c=r[e],{volumeId:d}=t;a.push({imageIds:o,volumeId:d,blendMode:c.blendMode,slabThickness:this._getSlabThickness(c,d)})}return this.viewportsDisplaySets.set(e.id,l),i.getShouldPerformCustomImageLoad()?i.runImageLoadStrategy({viewportId:e.id,volumeInputArray:a}):(s.forEach((e=>{e.loadStatus.loaded||e.loadStatus.loading||e.load()})),this.setVolumesForViewport(e,a,o))}async setVolumesForViewport(e,t,n){const{displaySetService:o,toolGroupService:a}=this.servicesManager.services,r=this.getViewportInfo(e.id),l=r.getDisplaySetOptions(),c=t.map(((e,t)=>{const{volumeId:n}=e,o=l[t],{voi:a,voiInverted:r,colormap:s,displayPreset:c}=o,d={};if(a&&(a.windowWidth||a.windowCenter)){const{lower:e,upper:t}=i.utilities.windowLevel.toLowHighRange(a.windowWidth,a.windowCenter);d.voiRange={lower:e,upper:t}}return void 0!==r&&(d.invert=r),void 0!==s&&(d.colormap=s),void 0!==c&&(d.preset=c),{properties:d,volumeId:n}}));await e.setVolumes(t),c.forEach((({properties:t,volumeId:n})=>{e.setProperties(t,n)})),this.setPresentations(e,n);const d=this.viewportsDisplaySets.get(e.id),m=d.map(o.getDisplaySetByUID).find((e=>e?.isOverlayDisplaySet));m?this.addOverlayRepresentationForDisplaySet(m,e):this._addSegmentationRepresentationToToolGroupIfNecessary(d,e);const u=a.getToolGroupForViewport(e.id);s.utilities.segmentation.triggerSegmentationRender(u.id);const g=this._getInitialImageIndexForViewport(r);void 0!==g&&s.utilities.jumpToSlice(e.element,{imageIndex:g}),e.render()}_addSegmentationRepresentationToToolGroupIfNecessary(e,t){const{segmentationService:n,toolGroupService:o}=this.servicesManager.services,a=o.getToolGroupForViewport(t.id),r=n.getSegmentations();for(const t of r){if((n.getSegmentationRepresentationsForToolGroup(a.id)||[]).find((e=>e.segmentationId===t.id)))continue;const{id:o}=t;let r=this._getFrameOfReferenceUID(o);if(!r){const{FrameOfReferenceUID:e}=t;e&&(r=e)}if(!r)return;let i=!1;for(const t of e){if(r===this._getFrameOfReferenceUID(t)){i=!0;break}}if(!i)return;n.addSegmentationRepresentationToToolGroup(a.id,t.id,!1,t.type)}}addOverlayRepresentationForDisplaySet(e,t){const{segmentationService:n,toolGroupService:o}=this.servicesManager.services,{referencedVolumeId:a}=e,r=e.displaySetInstanceUID,l=o.getToolGroupForViewport(t.id),c=a&&void 0!==i.cache.getVolume(a)?s.Enums.SegmentationRepresentations.Labelmap:s.Enums.SegmentationRepresentations.Contour;n.addSegmentationRepresentationToToolGroup(l.id,r,!1,c)}updateViewport(e,t,n=!1){const o=this.getViewportInfo(e),a=this.getCornerstoneViewport(e),r=a.getCamera();let s;(a instanceof i.VolumeViewport||a instanceof i.VolumeViewport3D)&&(s=this._setVolumeViewport(a,t,o).then((()=>{n&&(a.setCamera(r),a.render())}))),a instanceof i.StackViewport&&(s=this._setStackViewport(a,t,o)),s.then((()=>{this._broadcastEvent(this.EVENTS.VIEWPORT_DATA_CHANGED,{viewportData:t,viewportId:e})}))}_setDisplaySets(e,t,n,o={}){if(e instanceof i.StackViewport)return this._setStackViewport(e,t,n,o);if(e instanceof i.VolumeViewport||e instanceof i.VolumeViewport3D)return this._setVolumeViewport(e,t,n,o);throw new Error("Unknown viewport type")}_removeResizeObserver(){this.viewportGridResizeObserver&&this.viewportGridResizeObserver.disconnect()}_getSlabThickness(e,t){const{blendMode:n}=e;if(void 0!==n&&void 0!==e.slabThickness){if("number"==typeof e.slabThickness)return e.slabThickness;if("fullvolume"===e.slabThickness.toLowerCase()){const e=i.cache.getVolume(t),{dimensions:n}=e;return Math.sqrt(n[0]*n[0]+n[1]*n[1]+n[2]*n[2])}}}_getFrameOfReferenceUID(e){const{displaySetService:t}=this.servicesManager.services,n=t.getDisplaySetByUID(e);if(!n)return;if(n.frameOfReferenceUID)return n.frameOfReferenceUID;if("SEG"===n.Modality){const{instance:e}=n;return e.FrameOfReferenceUID}if("RTSTRUCT"===n.Modality){const{instance:e}=n;return e.ReferencedFrameOfReferenceSequence.FrameOfReferenceUID}const{images:o}=n;return o&&o.length?o[0].FrameOfReferenceUID:void 0}getViewportIdToJump(e,t,n){const o=this.getViewportInfo(e),{referencedImageId:a}=n;return o?.contains(t,a)?e:[...this.viewportsById.values()].find((e=>e.contains(t,a)))?.viewportId??null}}In=fn,fn.REGISTRATION={name:"cornerstoneViewportService",altName:"CornerstoneViewportService",create:({servicesManager:e})=>new In(e)};const vn=fn;var yn=n(97604);const wn=e=>{if(e)return"function"==typeof e.getImageId?e.getImageId():e.url},En=e=>(Array.isArray(e)?e:[e]).some((e=>!e)),Tn=e=>e&&e.images&&e.images[0],Dn=e=>wn(e),bn=(e,t=l.DICOMWeb.getAuthorizationHeader())=>fetch(e,t).then((e=>e.arrayBuffer())),On=e=>i.imageLoader.loadAndCacheImage(e).then((e=>e&&e.data&&e.data.byteArray.buffer)),An=(e,t,n,o,a=l.DICOMWeb.getAuthorizationHeader(),r=l.Po.getHTTPErrorHandler())=>{const i={url:e,headers:a,errorInterceptor:r};return new yn.api.DICOMwebClient(i).retrieveInstance({studyInstanceUID:t,seriesInstanceUID:n,sopInstanceUID:o})};const Nn=new class{getLocalData(e,t){const n=Tn(e),o=(e=>e&&e.instance)(e);if(!n&&!o||!o.imageId?.startsWith("dicomfile"))return;let a=Dn(n||o);return En(a)&&(a=((e,t)=>{const n=e.find((e=>e.displaySets.some((e=>e.displaySetInstanceUID===t)))),{series:o=[]}=n,{instances:a=[]}=o[0]||{},r=a[0];return wn(r)})(t,e.displaySetInstanceUID)),En(a)?void 0:N().wadouri.loadFileRequest(a)}getDataByImageType(e){const t=Tn(e);if(t){const e=Dn(t);let n=bn;const o=(e=>{const t=/^\w+\:/,n=t.exec(e);return 0===t.lastIndex&&n&&n[0]&&n[0].replace(":","")||""})(e);switch(o){case"dicomfile":n=On.bind(this,e);break;case"wadors":const a=t.getData().wadoRoot,r=t.getStudyInstanceUID(),i=t.getSeriesInstanceUID(),s=t.getSOPInstanceUID();if(En([a,r,i,s]))return;n=An.bind(this,a,r,i,s);break;case"wadouri":if(e=e.substring(e.indexOf(":")+1),En(e))return;n=bn.bind(this,e);break;default:throw new Error(`Unsupported image type: ${o} for imageId: ${e}`)}return n()}}getDataByDatasetType(e){const{StudyInstanceUID:t,SeriesInstanceUID:n,SOPInstanceUID:o,authorizationHeaders:a,wadoRoot:r,wadoUri:i,instance:s}=e;if(!En(r))return An(r,t,n,o,a);if(!En(i))return bn(i,{headers:a});if(!En(s?.url)){const e=s.url;if(e.startsWith("dicomzip")){const{url:t}=N().wadouri.parseImageId(e);return N().wadouri.loadZipRequest(t,e)}const t=e.startsWith("http")?e:e.substring(e.indexOf(":")+1);return bn(t,{headers:a})}}*getLoaderIterator(e,t,n){yield this.getLocalData(e,t),yield this.getDataByImageType(e),yield this.getDataByDatasetType(e)}findDicomDataPromise(e,t,n){e.authorizationHeaders=n;const o=this.getLoaderIterator(e,t);for(const e of o)if(e)return e;throw new Error("Invalid dicom data loader")}},Cn=JSON.parse('{"u2":"@ohif/extension-cornerstone"}').u2;function Mn(){return Mn=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var o in n)Object.prototype.hasOwnProperty.call(n,o)&&(e[o]=n[o])}return e},Mn.apply(this,arguments)}const Un=r.lazy((()=>Promise.all([n.e(23),n.e(181)]).then(n.bind(n,86181)))),Rn=e=>r.createElement(r.Suspense,{fallback:r.createElement("div",null,"Loading...")},r.createElement(Un,e)),_n={id:Cn,onModeExit:()=>{Object.values(i.Enums.RequestType).forEach((e=>{i.imageLoadPoolManager.clearRequestStack(e),i.imageRetrievalPoolManager.clearRequestStack(e)})),(0,x.mc)()},preRegistration:function(e){const{servicesManager:t}=e;return t.registerService(vn.REGISTRATION),t.registerService(xt.REGISTRATION),t.registerService(kt.REGISTRATION),t.registerService(nn.REGISTRATION),t.registerService(ln.REGISTRATION),je.call(this,e)},getHangingProtocolModule:Rt,getViewportModule:({servicesManager:e,commandsManager:t})=>[{name:"cornerstone",component:n=>{const{toolbarService:o}=e.services;return r.createElement(Rn,Mn({},n,{toolbarService:o,servicesManager:e,commandsManager:t}))}}],getCommandsModule:Dt,getCustomizationModule:pt,getUtilityModule:({servicesManager:e})=>[{name:"common",exports:{getCornerstoneLibraries:()=>({cornerstone:i,cornerstoneTools:s}),getEnabledElement:x.K8,dicomLoaderService:Nn}},{name:"core",exports:{Enums:i.Enums}},{name:"tools",exports:{toolNames:Z,Enums:s.Enums}}]}},73704:(e,t,n)=>{n.d(t,{K8:()=>r,Yc:()=>a,mc:()=>i});const o={DEFAULT_CONTEXT:"CORNERSTONE",enabledElements:{}},a=(e,t,n)=>{const a=n||o.DEFAULT_CONTEXT;o.enabledElements[e]={element:t,context:a}},r=e=>o.enabledElements[e],i=()=>{o.enabledElements={}}},87172:(e,t,n)=>{n.d(t,{Z:()=>a});var o=n(56388);function a(e){if(e)return function(e){const t=o.metaData.get("instance",e);return{SOPInstanceUID:t.SOPInstanceUID,SeriesInstanceUID:t.SeriesInstanceUID,StudyInstanceUID:t.StudyInstanceUID,frameNumber:t.frameNumber||1}}(e)}}}]);
//# sourceMappingURL=408.bundle.a241b7d75b377c2eb39e.js.map