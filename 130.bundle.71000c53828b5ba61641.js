"use strict";(globalThis.webpackChunk=globalThis.webpackChunk||[]).push([[130,579],{82328:(e,t,n)=>{n.r(t),n.d(t,{default:()=>ne});const a=JSON.parse('{"u2":"@ohif/extension-cornerstone-dicom-seg"}').u2,o=`${a}.sopClassHandlerModule.dicom-seg`;var r=n(43001),s=n(71771),i=n(56388),c=n(80135),l=n(6154),d=n(67540);const g=["1.2.840.10008.5.1.4.1.1.66.4"];let S={};function m(e,t,n){const a=e[0],{StudyInstanceUID:r,SeriesInstanceUID:m,SOPInstanceUID:u,SeriesDescription:p,SeriesNumber:E,SeriesDate:v,SOPClassUID:h,wadoRoot:I,wadoUri:y,wadoUriRoot:T}=a,R={Modality:"SEG",loading:!1,isReconstructable:!0,displaySetInstanceUID:s.utils.guid(),SeriesDescription:p,SeriesNumber:E,SeriesDate:v,SOPInstanceUID:u,SeriesInstanceUID:m,StudyInstanceUID:r,SOPClassHandlerId:o,SOPClassUID:h,referencedImages:null,referencedSeriesInstanceUID:null,referencedDisplaySetInstanceUID:null,isDerivedDisplaySet:!0,isLoaded:!1,isHydrated:!1,segments:{},sopClassUids:g,instance:a,instances:[a],wadoRoot:I,wadoUriRoot:T,wadoUri:y,isOverlayDisplaySet:!0},b=a.ReferencedSeriesSequence;if(!b)return void console.error("ReferencedSeriesSequence is missing for the SEG");const f=b[0]||b;return R.referencedImages=a.ReferencedSeriesSequence.ReferencedInstanceSequence,R.referencedSeriesInstanceUID=f.SeriesInstanceUID,R.getReferenceDisplaySet=()=>{const{displaySetService:e}=t.services,n=e.getDisplaySetsForSeries(R.referencedSeriesInstanceUID);if(!n||0===n.length)throw new Error("Referenced DisplaySet is missing for the SEG");const a=n[0];R.referencedDisplaySetInstanceUID=a.displaySetInstanceUID,R.referencedVolumeURI=a.displaySetInstanceUID;const o=`cornerstoneStreamingImageVolume:${R.referencedVolumeURI}`;return R.referencedVolumeId=o,a},R.load=async({headers:e})=>await function(e,t,n,a){const{SOPInstanceUID:o}=e,{segmentationService:r}=t.services;if((e.loading||e.isLoaded)&&S[o]&&function(e,t){return t.getSegmentation(e.displaySetInstanceUID)}(e,r))return S[o];return e.loading=!0,S[o]=new Promise((async(o,s)=>{e.segments&&0!==Object.keys(e.segments).length||await async function({extensionManager:e,servicesManager:t,segDisplaySet:n,headers:a}){const o=e.getModuleEntry("@ohif/extension-cornerstone.utilityModule.common"),{segmentationService:r,uiNotificationService:s,displaySetService:g}=t.services,{dicomLoaderService:S}=o.exports,m=await S.findDicomDataPromise(n,null,a),u=g.getDisplaySetByUID(n.referencedDisplaySetInstanceUID);let p;if(u.isReconstructable){const e=i.cache.getVolume(n.referencedVolumeId);p=e.imageIds||e._imageIds}else p=u.instances.map((e=>e.imageId));const E=.001,v=!0;i.eventTarget.addEventListener(l.Y.Events.SEGMENTATION_LOAD_PROGRESS,(e=>{const{percentComplete:t}=e.detail;r._broadcastEvent(r.EVENTS.SEGMENT_LOADING_COMPLETE,{percentComplete:t})}));const h=await l.adaptersSEG.Cornerstone3D.Segmentation.generateToolState(p,m,i.metaData,{skipOverlapping:v,tolerance:E,eventTarget:i.eventTarget,triggerEvent:i.triggerEvent});let I=!0;h.segMetadata.data.forEach(((e,t)=>{var n;t>0&&(e.rgba=e.RecommendedDisplayCIELabValue,e.rgba?e.rgba=(n=e.rgba,d.default.data.Colors.dicomlab2RGB(n).map((e=>Math.round(255*e)))):(I=!1,e.rgba=c.CONSTANTS.COLOR_LUT[t%c.CONSTANTS.COLOR_LUT.length]))})),Object.assign(n,h)}({extensionManager:n,servicesManager:t,segDisplaySet:e,headers:a});const g=!0;r.createSegmentationForSEGDisplaySet(e,null,g).then((()=>{e.loading=!1,o()})).catch((t=>{e.loading=!1,s(t)}))})),S[o]}(R,t,n,e),[R]}const u=function({servicesManager:e,extensionManager:t}){return[{name:"dicom-seg",sopClassUids:g,getDisplaySetsFromSeries:n=>m(n,e,t)}]},p={id:"@ohif/seg",name:"Segmentations",protocolMatchingRules:[],toolGroupIds:["default"],numberOfPriorsReferenced:0,defaultViewport:{viewportOptions:{viewportType:"stack",toolGroupId:"default",allowUnmatchedView:!0},displaySets:[{id:"segDisplaySetId",matchedDisplaySetsIndex:-1}]},displaySetSelectors:{segDisplaySetId:{seriesMatchingRules:[{attribute:"Modality",constraint:{equals:"SEG"}}]}},stages:[{name:"Segmentations",viewportStructure:{layoutType:"grid",properties:{rows:1,columns:1}},viewports:[{viewportOptions:{allowUnmatchedView:!0},displaySets:[{id:"segDisplaySetId"}]}]}]};const E=function(){return[{name:p.id,protocol:p}]};var v=n(62657),h=n(78738),I=n(3827),y=n.n(I),T=n(95303);const R=function(e,t,n){const a="enter-segment-label",o=({action:t,value:o})=>{switch(t.id){case"save":n(o.label,t.id);break;case"cancel":n("",t.id)}e.dismiss({id:a})};e&&e.create({id:a,centralize:!0,isDraggable:!1,showOverlay:!0,content:T.Vq,contentProps:{title:"Segment",value:{label:t},noCloseButton:!0,onClose:()=>e.dismiss({id:a}),actions:[{id:"cancel",text:"Cancel",type:T.LZ.dt.secondary},{id:"save",text:"Confirm",type:T.LZ.dt.primary}],onSubmit:o,body:({value:e,setValue:t})=>r.createElement(T.II,{label:"Enter the segment label",labelClassName:"text-white text-[14px] leading-[1.2]",autoFocus:!0,className:"border-primary-main bg-black",type:"text",value:e.label,onChange:e=>{e.persist(),t((t=>({...t,label:e.target.value})))},onKeyPress:t=>{"Enter"===t.key&&o({value:e,action:{id:"save"}})}})}})};var b=n(22831);const f=function(e,t,n){const a="pick-color",o=({action:t,value:o})=>{switch(t.id){case"save":n(o.rgbaColor,t.id);break;case"cancel":n("",t.id)}e.dismiss({id:a})};e&&e.create({id:a,centralize:!0,isDraggable:!1,showOverlay:!0,content:T.Vq,contentProps:{title:"Segment Color",value:{rgbaColor:t},noCloseButton:!0,onClose:()=>e.dismiss({id:a}),actions:[{id:"cancel",text:"Cancel",type:"primary"},{id:"save",text:"Save",type:"secondary"}],onSubmit:o,body:({value:e,setValue:t})=>r.createElement(b.AI,{color:e.rgbaColor,onChange:e=>{t({rgbaColor:e.rgb})},presetColors:[],width:300})}})};var D=n(69190);const C=e=>(e.label.includes("Vessel")?"Vessel":"Segment")+" "+(e.segments.filter((e=>e)).length+1),w=(e,t)=>({...e,...t.payload}),O="notifications-success",A="notifications-warning",U="notifications-error";function M({servicesManager:e,commandsManager:t,extensionManager:n,configuration:a}){const{segmentationService:o,viewportGridService:s,uiDialogService:i,displaySetService:c,userAuthenticationService:l,CropDisplayAreaService:d}=e.services,{t:g}=(0,D.$G)("PanelSegmentation"),[S,m]=(0,r.useState)(null),[u,p]=(0,r.useState)(o.getConfiguration()),[E,v]=(0,r.useState)((()=>o.getSegmentations())),[I,y]=(0,r.useReducer)(w,{});(0,r.useEffect)((()=>{const e=o.EVENTS.SEGMENTATION_ADDED,t=o.EVENTS.SEGMENTATION_UPDATED,n=o.EVENTS.SEGMENTATION_REMOVED,a=[];return[e,t,n].forEach((e=>{const{unsubscribe:t}=o.subscribe(e,(()=>{const e=o.getSegmentations();v(e),p(o.getConfiguration())}));a.push(t)})),()=>{a.forEach((e=>{e()}))}}),[]),(0,r.useEffect)((()=>{let a,r=[];const{unsubscribe:s}=o.subscribe(o.EVENTS.SEGMENTATION_DATA_MODIFIED,(({segmentation:o})=>{clearTimeout(a),y({payload:{[o.id]:A}}),r.find((e=>e.id===o.id))||r.push(o),a=setTimeout((()=>{const a=n.getActiveDataSource(),o=r.map((n=>(0,h.createReportAsync)({servicesManager:e,getReport:()=>t.runCommand("storeSegmentation",{segmentationId:n.id,dataSource:a[0]}),reportType:"Segmentation",showLoadingModal:!1,throwErrors:!0})));Promise.allSettled(o).then((e=>{const t=e.reduce(((e,t,n)=>(t.value&&(r[n].displaySetInstanceUID=t.value[0],c.getDisplaySetByUID(t.value[0])?.getReferenceDisplaySet()),{...e,[r[n].id]:"fulfilled"===t.status?O:U})),{});y({payload:t});const n=Object.keys(t).filter((e=>t[e]===O));r=r.filter((e=>!n.includes(e.id)))}))}),5e3)}));return()=>{s()}}),[]);const b=e=>{M(e);const t=E.find((t=>t.id===e))?.isActive;t||o.setActiveSegmentationForToolGroup(e)},M=e=>{const t=c.getDisplaySetByUID(e);if(!t)return;const n=t.referencedDisplaySetInstanceUID,{viewports:a,activeViewportId:o}=s.getState();let r=!1;a.forEach((e=>{e.displaySetInstanceUIDs.includes(n)&&(r=!0)})),r||s.setDisplaySetsForViewport({viewportId:o,displaySetInstanceUIDs:[n]})},_=e=>o.getToolGroupIdsWithSegmentation(e),L=(0,r.useCallback)(((e,t,n)=>{o.setConfiguration({segmentationId:e,[t]:n})}),[o]);return r.createElement(r.Fragment,null,r.createElement("div",{className:"ohif-scrollbar flex min-h-0 flex-auto select-none flex-col justify-between overflow-auto"},r.createElement(T.cX,{title:g("Segmentations"),segmentations:E,savedStatusStates:I,disableEditing:a.disableEditing,activeSegmentationId:S||"",onSegmentationAdd:async()=>{t.runCommand("createEmptySegmentationForViewport")},onSegmentationClick:e=>{M(e),o.setActiveSegmentationForToolGroup(e)},onSegmentationDelete:e=>{b(e),o.remove(e)},onSegmentationDownload:e=>{b(e),t.runCommand("downloadSegmentation",{segmentationId:e})},onSegmentationDownloadRTSS:e=>{b(e),t.runCommand("downloadRTSS",{segmentationId:e})},storeSegmentation:async a=>{b(a);const r=n.getActiveDataSource();let i;try{i=await(0,h.createReportAsync)({servicesManager:e,getReport:()=>t.runCommand("storeSegmentation",{segmentationId:a,dataSource:r[0]}),reportType:"Segmentation",throwErrors:!0}),y({payload:{[a]:O}})}catch(e){console.warn(e.message),y({payload:{[a]:U}})}i&&(o.remove(a),s.setDisplaySetsForViewport({viewportId:s.getActiveViewportId(),displaySetInstanceUIDs:i}))},onSegmentationEdit:e=>{b(e);const t=o.getSegmentation(e),{label:n}=t;R(i,n,((t,n)=>{""!==t&&o.addOrUpdateSegmentation({id:e,label:t},!1,!0)}))},onSegmentClick:(e,t)=>{M(e),o.setActiveSegment(e,t);_(e).forEach((n=>{o.setActiveSegmentationForToolGroup(e,n),o.jumpToSegmentCenter(e,t,n)}))},onSegmentEdit:(e,t)=>{b(e);const n=o.getSegmentation(e).segments[t],{label:a}=n;R(i,a,((n,a)=>{""!==n&&o.setSegmentLabel(e,t,n)}))},onSegmentAdd:e=>{b(e);const t=C(E.find((t=>t.id===e)));o.addSegment(e,{properties:{label:t}})},onSegmentColorClick:(e,t)=>{b(e);const n=o.getSegmentation(e).segments[t],{color:a,opacity:r}=n,s={r:a[0],g:a[1],b:a[2],a:r/255};f(i,s,((n,a)=>{"cancel"!==a&&o.setSegmentRGBAColor(e,t,[n.r,n.g,n.b,255*n.a])}))},onSegmentDelete:(e,t)=>{b(e),o.removeSegment(e,t)},onToggleSegmentVisibility:(e,t)=>{b(e);const n=!o.getSegmentation(e).segments[t].isVisible;_(e).forEach((a=>{o.setSegmentVisibility(e,t,n,a)}))},onToggleSegmentLock:(e,t)=>{b(e),o.toggleSegmentLocked(e,t)},onToggleSegmentationVisibility:e=>{b(e),o.toggleSegmentationVisibility(e)},showDeleteSegment:!0,segmentationConfig:{initialConfig:u},setRenderOutline:e=>L(S,"renderOutline",e),setOutlineOpacityActive:e=>L(S,"outlineOpacity",e),setRenderFill:e=>L(S,"renderFill",e),setRenderInactiveSegmentations:e=>L(S,"renderInactiveSegmentations",e),setOutlineWidthActive:e=>L(S,"outlineWidthActive",e),setFillAlpha:e=>L(S,"fillAlpha",e),setFillAlphaInactive:e=>L(S,"fillAlphaInactive",e),CropDisplayAreaService:d})))}M.propTypes={commandsManager:y().shape({runCommand:y().func.isRequired}),servicesManager:y().shape({services:y().shape({segmentationService:y().shape({getSegmentation:y().func.isRequired,getSegmentations:y().func.isRequired,toggleSegmentationVisibility:y().func.isRequired,subscribe:y().func.isRequired,EVENTS:y().object.isRequired}).isRequired}).isRequired}).isRequired};const{segmentation:_}=c.utilities,L={CIRCULAR_BRUSH:"CircularBrush",SPHERE_BRUSH:"SphereBrush",CIRCULAR_ERASER:"CircularEraser",SPHERE_ERASER:"SphereEraser",CIRCLE_SHAPE:"CircleScissor",RECTANGLE_SHAPE:"RectangleScissor",SPHERE_SHAPE:"SphereScissor",THRESHOLD_CIRCULAR_BRUSH:"ThresholdCircularBrush",THRESHOLD_SPHERE_BRUSH:"ThresholdSphereBrush"},V={SET_TOOL_CONFIG:"SET_TOOL_CONFIG",SET_ACTIVE_TOOL:"SET_ACTIVE_TOOL"},N={Brush:{brushSize:15,mode:"CircularBrush"},Eraser:{brushSize:15,mode:"CircularEraser"},Shapes:{brushSize:15,mode:"CircleScissor"},ThresholdBrush:{brushSize:15,thresholdRange:[-500,500]},activeTool:null};function P(e,t){switch(t.type){case V.SET_TOOL_CONFIG:const{tool:n,config:a}=t.payload;return{...e,[n]:{...e[n],...a}};case V.SET_ACTIVE_TOOL:return{...e,activeTool:t.payload};default:return e}}function B(e){let t=[];switch(e){case"Brush":t=["CircularBrush","SphereBrush"];break;case"Eraser":t=["CircularEraser","SphereEraser"];break;case"ThresholdBrush":t=["ThresholdCircularBrush","ThresholdSphereBrush"]}return t}const G=function({servicesManager:e,extensionManager:t}){const{toolbarService:n,segmentationService:a,toolGroupService:o}=e.services,[s]=(0,T.O_)(),{viewports:c,activeViewportId:l}=s,[d,g]=(0,r.useState)(!1),[S,m]=(0,r.useReducer)(P,N),u=(0,r.useCallback)((()=>{if(!c?.size||void 0===l)return;const e=c.get(l);e&&m({type:V.SET_ACTIVE_TOOL,payload:o.getActiveToolForViewport(e.viewportId)})}),[l,c,o,m]),p=(0,r.useCallback)((e=>{n.recordInteraction({interactionType:"tool",commands:[{commandName:"setToolActive",commandOptions:{toolName:e}}]}),m({type:V.SET_ACTIVE_TOOL,payload:e})}),[n,m]);(0,r.useEffect)((()=>{const e=new URLSearchParams(window.location.search).get("defaultBrushSize"),t=["Brush","Eraser"];i.eventTarget.addEventListener(i.EVENTS.ELEMENT_ENABLED,(n=>{const a=()=>{t.forEach((t=>{v(e,t)})),n.detail.element.removeEventListener(i.EVENTS.VOLUME_VIEWPORT_NEW_VOLUME,a),i.eventTarget.removeEventListener(i.EVENTS.STACK_VIEWPORT_NEW_STACK,a)};n.detail.element.addEventListener(i.EVENTS.VOLUME_VIEWPORT_NEW_VOLUME,a),i.eventTarget.addEventListener(i.EVENTS.STACK_VIEWPORT_NEW_STACK,a),i.eventTarget.removeEventListener(i.EVENTS.ELEMENT_ENABLED,a)}))}),[]),(0,r.useEffect)((()=>{const e=[a.EVENTS.SEGMENTATION_ADDED,a.EVENTS.SEGMENTATION_UPDATED,a.EVENTS.SEGMENTATION_REMOVED],t=[];return e.forEach((e=>{const{unsubscribe:n}=a.subscribe(e,(()=>{const e=a.getSegmentations(),t=e?.find((e=>e.isActive));g(t?.segmentCount>0)}));t.push(n)})),u(),()=>{t.forEach((e=>e()))}}),[l,c,a,u]),(0,r.useEffect)((()=>{const{unsubscribe:e}=n.subscribe(n.EVENTS.TOOL_BAR_STATE_MODIFIED,(()=>{u()}));return()=>{e()}}),[n,u]),(0,r.useEffect)((()=>{Object.values(L).includes(S.activeTool)&&(d||p("WindowLevel"))}),[d,S.activeTool,p]);const E=(0,r.useCallback)(((e,t)=>{o.getToolGroupIds()?.forEach((n=>{_.setBrushSizeForToolGroup(n,t,e)}))}),[o]),v=(0,r.useCallback)(((t,n)=>{const a=Number(t);B(n).forEach((t=>{const o="Brush"===n||"Eraser"===n?function(e,t){const{viewportGridService:n,cornerstoneViewportService:a}=t.services,{activeViewportId:o}=n.getState(),r=a.getCornerstoneViewport(o),{spacing:s}=r.getImageData();return Math.min(e*s[0],e*s[1],e*s[2])}(a,e):a;E(t,o)})),m({type:V.SET_TOOL_CONFIG,payload:{tool:n,config:{brushSize:a}}})}),[o,m]),h=(0,r.useCallback)((e=>{if(e[0]===S.ThresholdBrush.thresholdRange[0]&&e[1]===S.ThresholdBrush.thresholdRange[1])return;B("ThresholdBrush").forEach((t=>{o.getToolGroupIds()?.forEach((n=>{o.getToolGroup(n).setToolConfiguration(t,{strategySpecificConfiguration:{THRESHOLD_INSIDE_CIRCLE:{threshold:e}}})}))})),m({type:V.SET_TOOL_CONFIG,payload:{tool:"ThresholdBrush",config:{thresholdRange:e}}})}),[o,m,S.ThresholdBrush.thresholdRange]);return r.createElement(T.bY,{title:"Segmentation Tools",items:[{name:"Brush",icon:"icon-tool-brush",disabled:!d,active:S.activeTool===L.CIRCULAR_BRUSH||S.activeTool===L.SPHERE_BRUSH,onClick:()=>p(L.CIRCULAR_BRUSH),options:[{name:"Radius (px)",id:"brush-radius",type:"range",min:.5,max:1e4,value:S.Brush.brushSize,step:.5,onChange:e=>v(e,"Brush")},{name:"Mode",type:"radio",id:"brush-mode",value:S.Brush.mode,values:[{value:L.CIRCULAR_BRUSH,label:"Circle"},{value:L.SPHERE_BRUSH,label:"Sphere"}],onChange:e=>p(e)}]},{name:"Eraser",icon:"icon-tool-eraser",disabled:!d,active:S.activeTool===L.CIRCULAR_ERASER||S.activeTool===L.SPHERE_ERASER,onClick:()=>p(L.CIRCULAR_ERASER),options:[{name:"Radius (px)",type:"range",id:"eraser-radius",min:.5,max:1e4,value:S.Eraser.brushSize,step:.5,onChange:e=>v(e,"Eraser")},{name:"Mode",type:"radio",id:"eraser-mode",value:S.Eraser.mode,values:[{value:L.CIRCULAR_ERASER,label:"Circle"},{value:L.SPHERE_ERASER,label:"Sphere"}],onChange:e=>p(e)}]},{name:"Shapes",icon:"icon-tool-shape",disabled:!d,active:S.activeTool===L.CIRCLE_SHAPE||S.activeTool===L.RECTANGLE_SHAPE||S.activeTool===L.SPHERE_SHAPE,onClick:()=>p(L.CIRCLE_SHAPE),options:[{name:"Mode",type:"radio",value:S.Shapes.mode,id:"shape-mode",values:[{value:L.CIRCLE_SHAPE,label:"Circle"},{value:L.RECTANGLE_SHAPE,label:"Rectangle"},{value:L.SPHERE_SHAPE,label:"Sphere"}],onChange:e=>p(e)}]},{name:"Threshold Tool",icon:"icon-tool-threshold",disabled:!d,active:S.activeTool===L.THRESHOLD_CIRCULAR_BRUSH||S.activeTool===L.THRESHOLD_SPHERE_BRUSH,onClick:()=>p(L.THRESHOLD_CIRCULAR_BRUSH),options:[{name:"Radius (mm)",id:"threshold-radius",type:"range",min:.5,max:99.5,value:S.ThresholdBrush.brushSize,step:.5,onChange:e=>v(e,"ThresholdBrush")},{name:"Mode",type:"radio",id:"threshold-mode",value:S.activeTool,values:[{value:L.THRESHOLD_CIRCULAR_BRUSH,label:"Circle"},{value:L.THRESHOLD_SPHERE_BRUSH,label:"Sphere"}],onChange:e=>p(e)},{type:"custom",id:"segmentation-threshold-range",children:()=>r.createElement("div",null,r.createElement("div",{className:"bg-secondary-light h-[1px]"}),r.createElement("div",{className:"mt-1 text-[13px] text-white"},"Threshold"),r.createElement(T.R0,{values:S.ThresholdBrush.thresholdRange,onChange:h,minValue:-1e3,maxValue:1e3,step:1,showLabel:!0,allowNumberEdit:!0,showAdjustmentArrows:!1}))}]}]})},F=({commandsManager:e,servicesManager:t,extensionManager:n,configuration:a})=>{const{customizationService:o}=t.services;return[{name:"panelSegmentation",iconName:"tab-segmentation",iconLabel:"Segmentation",label:"Segmentation",component:a=>{const[s]=(0,v.M)(),i=o.get("segmentation.disableEditing");return r.createElement(M,{commandsManager:e,servicesManager:t,extensionManager:n,configuration:{...a,disableEditing:s.disableEditing||i?.value}})}},{name:"panelSegmentationWithTools",iconName:"tab-segmentation",iconLabel:"Segmentation",label:"Segmentation",component:a=>{const[o]=(0,v.M)();return r.createElement(r.Fragment,null,r.createElement(G,{commandsManager:e,servicesManager:t,extensionManager:n,configuration:{...a}}),r.createElement(M,{commandsManager:e,servicesManager:t,extensionManager:n,configuration:{...a}}))}}]};var H=n(96538),x=n(54131),k=n(96372);async function q({viewportId:e,loadFn:t,servicesManager:n,referencedDisplaySetInstanceUID:a}){const{cornerstoneViewportService:o,segmentationService:r,viewportGridService:s,displaySetService:c}=n.services,l=W({viewportId:e,viewportGridService:s}),d=l.viewportOptions.viewportId,g=z({servicesManager:n,viewportId:e,referencedDisplaySetInstanceUID:a=a||l?.displaySetInstanceUIDs[0]}),S=async()=>{const e=await t();r.hydrateSegmentation(e)},m=Array.from(i.cache._volumeCache.keys()).some((e=>e.includes(a))),u=c.getDisplaySetByUID(a);return g.forEach((async e=>{e.viewportOptions={...e.viewportOptions,viewportType:u.isReconstructable?"volume":"stack",needsRerendering:!0};const t=e.viewportId,n=o.getCornerstoneViewport(t),r=n.getCamera();if(m&&t===d)return void await S();const s=u.isReconstructable?i.Enums.Events.VOLUME_VIEWPORT_NEW_VOLUME:i.Enums.Events.STACK_VIEWPORT_NEW_STACK,c=u.isReconstructable?n.element:i.eventTarget,l=async e=>{const n=e.detail.volumeActors?.find((e=>e.uid.includes(a)));o.getCornerstoneViewport(t).setCamera(r),c.removeEventListener(s,l),u.isReconstructable&&!n||t===d&&await S()};c.addEventListener(s,l)})),s.setDisplaySetsForViewports(g),!0}const W=({viewportId:e,viewportGridService:t})=>{const{viewports:n,activeViewportId:a}=t.getState(),o=e||a;return n.get(o)};function z({viewportId:e,servicesManager:t,referencedDisplaySetInstanceUID:n}){const{hangingProtocolService:a,displaySetService:o,segmentationService:r,viewportGridService:s}=t.services,{viewports:i}=s.getState(),c=W({viewportId:e,viewportGridService:s}).viewportOptions.viewportId,l=i.get(c).displaySetInstanceUIDs,d=n||l[0],g=o.getDisplaySetByUID(d).instances[0].FrameOfReferenceUID,S=a.getViewportsRequireUpdate(c,d);return i.forEach(((e,t)=>{if(c===t||S.find((e=>e.viewportId===t)))return;r.shouldRenderSegmentation(e.displaySetInstanceUIDs,g)&&S.push({viewportId:t,displaySetInstanceUIDs:e.displaySetInstanceUIDs,viewportOptions:{viewportType:e.viewportType,needsRerendering:!0}})})),S}const j=e=>{const t=[],n=[],a=new Set;Array.from(e.entries()).forEach(((e,o)=>{n.push(i.cache.getImage(e[0]));const r=i.cache.getImage(e[1]),{rows:s,columns:c}=r,l=r.getPixelData(),d=[];for(let e=0;e<l.length;e++){const t=l[e];d.includes(t)||0===t||d.push(t)}d.length&&(t[o]={segmentsOnLabelmap:d,pixelData:l,rows:s,columns:c},d.forEach((e=>{a.add(e)})))}));const o={segmentsOnLabelmap:Array.from(a),labelmaps2D:t};return{referencedImages:n,labelmapObj:o}},{datasetToBlob:K}=d.default.data,{Cornerstone3D:{Segmentation:{generateLabelMaps2DFrom3D:Z,generateSegmentation:$}}}=l.adaptersSEG,{Cornerstone3D:{RTSS:{generateRTSSFromSegmentations:J}}}=l.adaptersRT,{downloadDICOMData:Y}=l.helpers,X=({servicesManager:e,extensionManager:t})=>{const{uiNotificationService:n,segmentationService:a,uiDialogService:o,displaySetService:r,viewportGridService:l}=e.services,g={getUpdatedViewportsForSegmentation:z,createEmptySegmentationForViewport:async({viewportId:t})=>{const n=W({viewportId:t,viewportGridService:l}),o=n.displaySetInstanceUIDs[0];q({viewportId:t,servicesManager:e,loadFn:async()=>{const e=a.getSegmentations(),t=await a.createSegmentationForDisplaySet(o,{label:`Segmentation ${e.length+1}`}),r=n.viewportOptions.toolGroupId;return await a.addSegmentationRepresentationToToolGroup(r,t),a.addSegment(t,{toolGroupId:r,segmentIndex:1,properties:{label:C(a.getSegmentation(t))}}),t}})},loadSegmentationsForViewport:async({segmentations:t,viewportId:n})=>{q({viewportId:n,servicesManager:e,loadFn:async()=>{const e=W({viewportId:n,viewportGridService:l}),o=e.displaySetInstanceUIDs[0],r=t[0],s=r.id,i=r.label,c=r.segments;if(delete r.segments,await a.createSegmentationForDisplaySet(o,{segmentationId:s,label:i}),r.scalarData){a.getLabelmapVolume(s).scalarData.set(r.scalarData)}a.addOrUpdateSegmentation(r);const d=e.viewportOptions.toolGroupId;return await a.addSegmentationRepresentationToToolGroup(d,s),c.forEach((e=>{null!==e&&a.addSegment(s,{segmentIndex:e.segmentIndex,toolGroupId:d,properties:{color:e.color,label:e.label,opacity:e.opacity,isLocked:e.isLocked,visibility:e.isVisible,active:r.activeSegmentIndex===e.segmentIndex}})})),r.centroidsIJK&&a.setCentroids(r.id,r.centroidsIJK),s}})},loadSegmentationDisplaySetsForViewport:async({viewportId:t,displaySets:n})=>{const o=n[0];q({viewportId:t,servicesManager:e,referencedDisplaySetInstanceUID:o.referencedDisplaySetInstanceUID,loadFn:async()=>{const e=o,t="SEG"===e.Modality?"createSegmentationForSEGDisplaySet":"createSegmentationForRTDisplaySet",n=a[t].bind(a);return await n(e,null,!1)}})},generateSegmentation:({segmentationId:e,options:t={}})=>{const n=c.segmentation.state.getSegmentation(e),o=n.representationData.LABELMAP;let r,s;if(n.representationData.LABELMAP.referencedVolumeId){const{referencedVolumeId:t}=o,n=i.cache.getVolume(e);r=i.cache.getVolume(t).getCornerstoneImages(),s=Z(n)}else{const{imageIdReferenceMap:e}=o;({referencedImages:r,labelmapObj:s}=j(e))}s.metadata=[];const l=a.getSegmentation(e);s.segmentsOnLabelmap.forEach((e=>{const t=l?.segments[e],{label:n,color:a}=t,o=d.default.data.Colors.rgb2DICOMLAB(a.slice(0,3).map((e=>e/255))).map((e=>Math.round(e))),r={SegmentNumber:e.toString(),SegmentLabel:n,SegmentAlgorithmType:"MANUAL",SegmentAlgorithmName:"OHIF Brush",RecommendedDisplayCIELabValue:o,SegmentedPropertyCategoryCodeSequence:{CodeValue:"T-D0050",CodingSchemeDesignator:"SRT",CodeMeaning:"Tissue"},SegmentedPropertyTypeCodeSequence:{CodeValue:"T-D0050",CodingSchemeDesignator:"SRT",CodeMeaning:"Tissue"}};s.metadata[e]=r}));return $(r,s,i.metaData,t)},downloadSegmentation:({segmentationId:e})=>{const t=a.getSegmentation(e),n=g.generateSegmentation({segmentationId:e});Y(n.dataset,`${t.label}`)},storeSegmentation:async({segmentationId:e,dataSource:n})=>{const s=a.getSegmentation(e);if(!s)throw new Error("No segmentation found");const{label:i,displaySetInstanceUID:c}=s,l=r.getDisplaySetByUID(c),d=l&&"SEG"===l.Modality;let S={};if(!d&&(S=await(0,h.createReportDialogPrompt)(o,{extensionManager:t}),1!==S.action&&!S.value))return;const m=S.value||i||"Research Derived Series";s.label=m;const u=g.generateSegmentation({segmentationId:e,options:{SeriesDescription:m,...d&&{SeriesInstanceUID:l.SeriesInstanceUID,SOPInstanceUID:l.instances[0].SOPInstanceUID}}});if(!u||!u.dataset)throw new Error("Error during segmentation generation");const{dataset:p}=u;return await n.store.dicom(p),p.wadoRoot=n.getConfig().wadoRoot,p},downloadRTSS:({segmentationId:e})=>{const t=a.getSegmentation(e),n={vtkImageMarchingSquares:H.ZP,vtkDataArray:x.ZP,vtkImageData:k.ZP},o=J(t,s.classes.MetadataProvider,s.DicomMetadataStore,i.cache,c.Enums,n);try{const e=K(o),t=URL.createObjectURL(e);window.location.assign(t)}catch(e){console.warn(e)}}},S={getUpdatedViewportsForSegmentation:{commandFn:g.getUpdatedViewportsForSegmentation},loadSegmentationDisplaySetsForViewport:{commandFn:g.loadSegmentationDisplaySetsForViewport},loadSegmentationsForViewport:{commandFn:g.loadSegmentationsForViewport},createEmptySegmentationForViewport:{commandFn:g.createEmptySegmentationForViewport},generateSegmentation:{commandFn:g.generateSegmentation},downloadSegmentation:{commandFn:g.downloadSegmentation},storeSegmentation:{commandFn:g.storeSegmentation},downloadRTSS:{commandFn:g.downloadRTSS}};return{actions:g,definitions:S}};function Q(){return Q=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var a in n)Object.prototype.hasOwnProperty.call(n,a)&&(e[a]=n[a])}return e},Q.apply(this,arguments)}const ee=r.lazy((()=>n.e(451).then(n.bind(n,4451)))),te=e=>r.createElement(r.Suspense,{fallback:r.createElement("div",null,"Loading...")},r.createElement(ee,e)),ne={id:a,preRegistration:function({configuration:e={}}){(0,c.addTool)(c.BrushTool)},getPanelModule:F,getCommandsModule:X,getViewportModule:({servicesManager:e,extensionManager:t})=>[{name:"dicom-seg",component:n=>r.createElement(te,Q({servicesManager:e,extensionManager:t,commandsManager},n))}],getSopClassHandlerModule:u,getHangingProtocolModule:E}}}]);
//# sourceMappingURL=130.bundle.71000c53828b5ba61641.js.map